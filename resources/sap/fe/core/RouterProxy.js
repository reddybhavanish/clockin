/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/ui/base/Object","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ui/core/routing/HashChanger","sap/ui/base/EventProvider","sap/fe/core/Synchronization"],function(L,B,A,H,E,S){"use strict";var e={EQUAL:0,COMPATIBLE:1,ANCESTOR:2,DIFFERENT:3};var a={LAYOUTPARAM:"layout",IAPPSTATEPARAM:"sap-iapp-state"};return B.extend("sap.fe.core.RouterProxy",{bIsRebuildHistoryRunning:false,bIsComputingTitleHierachy:false,oNavigationGuardState:null,bIsGuardCrossAllowed:false,sIAppStateKey:null,init:function(o,i){var f=sap.ushell.Container.getService("URLParsing").splitHash(window.location.hash).shellPart;this.initRaw(o.getRouter(),f);this._oRouteMatchSynchronization=new S();this._bActivateRouteMatchSynchro=false;history.replaceState(Object.assign({feLevel:0},history.state),null,window.location);this.fclEnabled=i;},initRaw:function(r,f){this._oRouter=r;this._oManagedHistory=[];this._sFlpAppName=f;var c=this._oRouter.getHashChanger().getHash();this._oManagedHistory.push(this._extractStateFromHash(c));this.sIAppStateKey=this._findAppStateInHash(c);},navToHash:function(h,p){var t=this;if(this._oRouteMatchSynchronization){return this._oRouteMatchSynchronization.waitFor().then(function(){t._oRouteMatchSynchronization=null;return t._internalNavToHash(h,p);});}else{if(this._bActivateRouteMatchSynchro){this._oRouteMatchSynchronization=new S();this._bActivateRouteMatchSynchro=false;}return t._internalNavToHash(h,p);}},_internalNavToHash:function(h,p){var t=this,l=sap.ui.getCore().getCurrentFocusedControlId(),s=l&&sap.ui.getCore().byId(l)?sap.ui.getCore().byId(l).getFocusInfo():null,b=window.location.hash;if(this.fclEnabled&&this.sIAppStateKey&&!this._findAppStateInHash(h)){h=this._setAppStateInHash(h,this.sIAppStateKey);}var n=this._extractStateFromHash(h);if(!this._checkNavigationGuard(n)){if(!this.oResourceBundle){this.oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");}if(!confirm(this.oResourceBundle.getText("SAPFE_EXIT_NOTSAVED_MESSAGE"))){return Promise.resolve();}this.bIsGuardCrossAllowed=true;}this._pushNewState(n,p);return this._rebuildBrowserHistory(h).then(function(){t.storeFocusForHash(l,s,b);});},restoreHistory:function(){var t=H.getInstance().getHash(),n=this._extractStateFromHash(t);this._pushNewState(n);this._rebuildBrowserHistory(t,true);},storeFocusForHash:function(l,s,b){var m=this._oManagedHistory;for(var i=0;i<m.length;i++){var h="#"+m[i].hash;if(b===h||h===b+"&/"){m[i].oLastFocusControl={controlId:l,focusInfo:s};break;}}},navTo:function(r,p){var h=this._oRouter.getURL(r,p);return this.navToHash(h);},exitFromApp:function(){return new Promise(function(r,b){var x=sap.ushell.Container.getService("CrossApplicationNavigation");x.backToPreviousApp();r();});},isCurrentStateImpactedBy:function(h){var s=this._extractStateFromHash(h);return this._compareCacheStates(s,this._oManagedHistory[this._oManagedHistory.length-1])!==e.DIFFERENT;},isNavigationFinalized:function(){return!this.bIsRebuildHistoryRunning;},setNavigationGuard:function(){var c=this._sFlpAppName+"&/"+this._oRouter.getHashChanger().getHash();var i=-1;this._oManagedHistory.forEach(function(h,_){if(h.hash===c){i=_;}});if(i!==-1){while(i>0&&this._compareStateKeys(this._oManagedHistory[i-1],this._oManagedHistory[i])){i--;}this.oNavigationGuardState=this._oManagedHistory[i];this.bIsGuardCrossAllowed=false;}else{throw new Error("current hash has no entry in Managed cache !!!");}},discardNavigationGuard:function(){this.oNavigationGuardState=null;},checkHashWithGuard:function(h){if(this.oNavigationGuardState===null){return true;}var n=this._extractStateFromHash(h);return this._checkNavigationGuard(n);},isGuardCrossAllowedByUser:function(){return this.bIsGuardCrossAllowed;},_checkNavigationGuard:function(s){if(this.oNavigationGuardState===null){return true;}var c=this._compareCacheStates(this.oNavigationGuardState,s);return c!==e.DIFFERENT;},activateRouteMatchSynchronization:function(){this._bActivateRouteMatchSynchro=true;},resolveRouteMatch:function(){if(this._oRouteMatchSynchronization){this._oRouteMatchSynchronization.resolve();}},_extractStateFromHash:function(h){var s={keys:[]};var b=h.split("?")[0];var t=b.split("/");t.forEach(function(T){var r=/[^\(\)]+\([^\(\)]+\)/;if(r.test(T)){T=T.substring(0,T.length-1);var n={keyID:T.split("(")[0]};var k=T.split("(")[1].split(",");if(k.length>1){k.forEach(function(v){var c=v.split("=");n[c[0]]=c[1];});}else{n["ID"]=T.split("(")[1];}s.keys.push(n);}});var l=h.match(new RegExp("\\?.*"+a.LAYOUTPARAM+"=([^&]*)"));s.sLayout=l&&l.length>1?l[1]:null;if(s.sLayout==="MidColumnFullScreen"){s.screenMode=1;}else if(s.sLayout==="EndColumnFullScreen"){s.screenMode=2;}else{s.screenMode=0;}s.hash=this._sFlpAppName+"&/"+h;return s;},_pushNewState:function(n,p){var c=this._extractStateFromHash(this._oRouter.getHashChanger().getHash()),l=this._oManagedHistory.length-1,t=this;while(l>=0&&this._compareCacheStates(this._oManagedHistory[l],c)!==e.EQUAL){this._oManagedHistory.pop();l--;}if(this._oManagedHistory.length===0){this._oManagedHistory.push(c);history.replaceState(Object.assign({feLevel:0},history.state),null,window.location);}var o;var b;while(this._oManagedHistory.length>0&&this._compareCacheStates(this._oManagedHistory[this._oManagedHistory.length-1],n)!==e.ANCESTOR&&!p){o=this._oManagedHistory[this._oManagedHistory.length-1].oLastFocusControl;b=this._oManagedHistory.pop();}this.sIAppStateKey=this._findAppStateInHash(n.hash);if(this.fclEnabled&&this.sIAppStateKey){this._oManagedHistory.forEach(function(m){m.hash=t._setAppStateInHash(m.hash,t.sIAppStateKey);});}else if(!this.fclEnabled&&b){var P=this._findAppStateInHash(b.hash);var C=this._compareCacheStates(b,n);if(!this.sIAppStateKey&&P&&(C===e.EQUAL||C===e.COMPATIBLE)){n.hash=t._setAppStateInHash(n.hash,P);}}n.oLastFocusControl=o;this._oManagedHistory.push(n);},_findAppStateInHash:function(h){var b=h.match(new RegExp("\\?.*"+a.IAPPSTATEPARAM+"=([^&]*)"));return b&&b.length>1?b[1]:null;},_setAppStateInHash:function(h,s){var n;if(h.indexOf(a.IAPPSTATEPARAM)>=0){n=h.replace(new RegExp(a.IAPPSTATEPARAM+"=[^&]*"),a.IAPPSTATEPARAM+"="+s);}else{if(h.replace(this._sFlpAppName,"").indexOf("?")<0){n=h+"?";}else{n=h+"&";}n+=a.IAPPSTATEPARAM+"="+s;}return n;},_disableEventOnHashChange:function(){this._oRouter.stop();},_enableEventOnHashChange:function(i){this._oRouter.initialize(i);},_rebuildBrowserHistory:function(n,r){var t=this;return new Promise(function(b,c){if(t.bIsRebuildHistoryRunning===true){L.warning("_rebuildBrowserHistory already running ... Add this call to the pool");if(!t.rebuildHistoryPool){t.rebuildHistoryPool=[];}t.rebuildHistoryPool.push(n);b();return;}t.bIsRebuildHistoryRunning=true;function d(){if(t._oManagedHistory[0].hash.indexOf("&/")===-1){t._oManagedHistory[0].hash+="&/";}var s=Object.assign({},history.state);s.sap=Object.assign({},history.state.sap);if(!s.sap.history){s.sap.history=[];}if(t._oManagedHistory.length===1){if(window.location.hash==="#"+t._oManagedHistory[0].hash){t._enableEventOnHashChange(!!r);}else{if(!r){t._enableEventOnHashChange(true);}window.location.replace("#"+t._oManagedHistory[0].hash);history.replaceState(Object.assign(s,{feLevel:0}),null,"#"+t._oManagedHistory[0].hash);if(r){setTimeout(function(){t._enableEventOnHashChange(true);},0);}}}else{history.replaceState(Object.assign(s,{feLevel:0}),null,"#"+t._oManagedHistory[0].hash);var i=1;while(i<t._oManagedHistory.length-1){s.sap.history=s.sap.history.concat();s.sap.history.push(t._oManagedHistory[i].hash);history.pushState(Object.assign(s,{feLevel:i}),null,"#"+t._oManagedHistory[i].hash);i++;}if(!r){t._enableEventOnHashChange(true);}window.location="#"+t._oManagedHistory[i].hash;s.sap.history=s.sap.history.concat();s.sap.history.push(t._oManagedHistory[i].hash);history.replaceState(Object.assign(s,{feLevel:t._oManagedHistory.length-1}),null,"#"+t._oManagedHistory[i].hash);if(r){setTimeout(function(){t._enableEventOnHashChange(true);},0);}}t.bIsRebuildHistoryRunning=false;if(t.rebuildHistoryPool&&t.rebuildHistoryPool.length>0){var l=t.rebuildHistoryPool[0];t.rebuildHistoryPool.shift();t._rebuildBrowserHistory(l);}b();}function f(){if(!history.state){b();}else if(history.state.feLevel===0){window.removeEventListener("popstate",f);setTimeout(function(){d();},0);}else{history.back();}}t._disableEventOnHashChange();if(!history.state||history.state.feLevel===undefined){window.addEventListener("popstate",f);history.back();}else if(history.state.feLevel!==0){window.addEventListener("popstate",f);history.go(-history.state.feLevel);}else{d();}});},navigateBack:function(p){if(p&&p.rebuildHistory===true&&history.state.sap&&history.state.sap.history&&history.state.sap.history.length>1){var n=history.state.sap.history[history.state.sap.history.length-2];n=n.replace(new RegExp(this._sFlpAppName+"(&/){0,1}"),"");this.navToHash(n);}else{window.history.back();}},_compareCacheStates:function(s,o){if(s.keys.length>o.keys.length){return e.DIFFERENT;}var b=true;var i;for(i=0;b&&i<s.keys.length;i++){if(s.keys[i].keyID!==o.keys[i].keyID||s.keys[i].ID!==o.keys[i].ID){b=false;}}if(!b){return e.DIFFERENT;}if(s.keys.length<o.keys.length||s.screenMode<o.screenMode){return e.ANCESTOR;}if(s.screenMode>o.screenMode){return e.DIFFERENT;}for(i=0;b&&i<s.keys.length;i++){if(s.keys[i].IsActiveEntity!==o.keys[i].IsActiveEntity){b=false;}}if(!b||s.sLayout!==o.sLayout){return e.COMPATIBLE;}else{return e.EQUAL;}},_compareStateKeys:function(s,o){if(s.keys.length!=o.keys.length){return false;}var b=true;var i;for(i=0;b&&i<s.keys.length;i++){if(s.keys[i].keyID!==o.keys[i].keyID||s.keys[i].ID!==o.keys[i].ID){b=false;}}return b;},checkIfBackIsOutOfGuard:function(p){var t=this,P;if(p===undefined){p=window.location.hash.substring(1);}if(t.oNavigationGuardState&&t._oManagedHistory){for(var i=t._oManagedHistory.length-1;i>0;i--){if(t._oManagedHistory[i].hash===p){P=t._oManagedHistory[i-1].hash;break;}}return!P||!t.checkHashWithGuard(P.split(this._sFlpAppName+"&/")[1]);}return false;}});});
