sap.ui.define(["sap/ui/base/Object","sap/fe/core/actions/draft","sap/fe/core/actions/sticky","sap/fe/core/actions/operations","sap/fe/core/model/DraftModel","sap/ui/model/json/JSONModel","sap/fe/core/actions/messageHandling","sap/m/Popover","sap/m/VBox","sap/m/CheckBox","sap/m/Text","sap/m/Button","sap/m/MessageToast","sap/m/Dialog","sap/ui/model/BindingMode","sap/base/Log","sap/ui/core/message/Message","sap/fe/core/CommonUtils","sap/fe/core/BusyLocker","sap/fe/core/helpers/SideEffectsUtil"],function(B,d,s,o,D,J,m,P,V,C,T,a,M,b,c,L,e,f,g,S){"use strict";var h={DRAFT:"Draft",STICKY:"Sticky",NON_DRAFT:"NonDraft"};function j(p){if(p&&p.getMetadata&&p.getMetadata().getName()==="sap.ui.base.Event"){p={};}return p||{};}return B.extend("sap.fe.core.TransactionHelper",{_bIsModified:false,_bCreateMode:false,_oAppComponent:null,_oResourceBundle:null,initialize:function(A){this._oAppComponent=A;},destroy:function(){this.getUIStateModel().destroy();B.prototype.destroy.apply(this,arguments);},getProgrammingModel:function(i){var t=this,k=i.getModel(),l=i.getModel().getMetaModel().getMetaPath(i.getPath()),E;if(!this.sProgrammingModel){return D.upgradeOnDemand(k).then(function(I){if(I){t.sProgrammingModel=h.DRAFT;}else if(k.getMetaModel().getObject(l+"@com.sap.vocabularies.Session.v1.StickySessionSupported")){t.sProgrammingModel=h.STICKY;}else{E=i.getModel().getMetaModel().getObject("/");for(var n in E){if(E[n].$kind==="EntitySet"){if(k.getMetaModel().getObject("/"+n+"@com.sap.vocabularies.Session.v1.StickySessionSupported")){t.sProgrammingModel=h.STICKY;return t.sProgrammingModel;}}}t.sProgrammingModel=h.NON_DRAFT;}return t.sProgrammingModel;});}else{return Promise.resolve(this.sProgrammingModel);}},getUIStateModel:function(){if(!this.uiModel){this.uiModel=new J({editMode:"Display",busy:false,busyLocal:{},draftStatus:"Clear"});this.uiModel.setDefaultBindingMode(c.OneWay);}return this.uiModel;},setUIStateModel:function(u){this.uiModel=u;},isBusy:function(i,l){var u=this.getUIStateModel();return g.isLocked(u,i==="Global"?undefined:l);},busyHandler:function(i,l,O){var k=O?"lock":"unlock";if(i==="Global"||i==="Local"){g[k](this.getUIStateModel(),i==="Global"?"/busy":"/busyLocal/"+l);}},busyOn:function(i,l){this.busyHandler(i,l,true);},busyOff:function(i,l){this.busyHandler(i,l,false);},createDocument:function(l,p,r){var n,t=this,k,q,u=l.getModel(),v=u.getMetaModel(),w=v.getMetaPath(l.getHeaderContext().getPath()),N=!l.isRelative()&&(v.getObject(w+"@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction")||v.getObject(w+"@com.sap.vocabularies.Common.v1.DraftRoot/NewAction")),x,y={"$$patchWithoutSideEffects":true},z=v.getObject(w+"/@com.sap.vocabularies.Common.v1.Messages/$Path");if(z){y["$select"]=z;}p=j(p);if(!l){return Promise.reject("Binding required for new document creation");}if(p.busyMode==="Local"){q=l.sId;}k=!p.refreshList;t.busyOn(p.busyMode,q);var R=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");if(N){x=this.onCallAction(N,{contexts:l.getHeaderContext(),showActionParameterDialog:true,label:R.getText("SAPFE_ACTION_CREATE"),bindingParameters:y,parentControl:p.parentControl,bIsCreateAction:true});}else{n=l.create(p.data,k,p.createAtEnd);x=n.created();var A=function(E){var F=E.getParameter("context"),G=sap.ui.getCore().getMessageManager(),H,I,K,O;if(F===n){l.detachCreateCompleted(A);if(!E.getParameter("success")){if(p.keepTransientContextOnFailed){H=n.getPath();I=G.getMessageModel().getData();O=false;for(var i=0;i<I.length;i++){if(I[0].target===H){O=true;break;}}if(!O){K=new e({message:f.getTranslatedText("TRANSIENT_CONTEXT_MESSAGE",r),description:f.getTranslatedText("TRANSIENT_CONTEXT_DESCRIPTION",r),target:H,persistent:false,type:"Error"});G.addMessages(K);n.created().then(function(){G.removeMessages(K);},function(){G.removeMessages(K);});}var Q=function(E){if(E.getParameter("context")===n){m.showUnboundMessages();if(E.getParameter("success")){l.detachCreateCompleted(Q);}}};l.attachCreateCompleted(Q);m.showUnboundMessages();}else{F.created().then(undefined,function(){L.trace("transient creation context deleted");});F.delete();var U=t._getRouting();U.navigateBackFromTransientState(t._getAppComponent(),{unLockObject:t.getUIStateModel()});}}}};l.attachCreateCompleted(A);}return x.then(function(i){if(!l.isRelative()){t._bCreateMode=true;}n=n||(i&&i.response);if(i&&i.bConsiderDocumentModified){t.handleDocumentModifications();}return m.showUnboundMessages().then(function(){return n;});}).catch(function(i){return m.showUnboundMessages().then(function(){return Promise.reject(i);});}).finally(function(){t.busyOff(p.busyMode,q);});},deleteDocument:function(v,p,l,r){var u=this.getUIStateModel(),R,i,k=[],n=false,q=false,t=false,w,x=this;var y=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");var z,A={title:y.getText("OBJECT_PAGE_DELETE")};g.lock(u);if(p){if(!p.numberOfSelectedContexts){p=j(p);if(p.title){if(p.description){z=[p.title,p.description];A.text=f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO",r,z,p.entitySetName);}else{A.text=f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",r,null,p.entitySetName);}}else{A.text=f.getTranslatedText("OBJECT_PAGE_CONFIRM_GENERIC_DELETE",r);}k=v;}else{A={title:y.getText("OBJECT_PAGE_DELETE")};if(p.numberOfSelectedContexts===1&&p.numberOfSelectedContexts===v.length){k=v;A.text=f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",r,null,p.entitySetName);}else if(p.numberOfSelectedContexts===1&&p.unSavedContexts.length===1){k=p.unSavedContexts;var E=k[0].getObject()["DraftAdministrativeData"]?k[0].getObject()["DraftAdministrativeData"]["LastChangedByUserDescription"]:"";z=[E];A.text=f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_CHANGES",r,z);}else if(p.numberOfSelectedContexts===p.unSavedContexts.length){k=p.unSavedContexts;A.text=f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_CHANGES_MULTIPLE_OBJECTS",r);}else if(p.numberOfSelectedContexts===v.concat(p.unSavedContexts.concat(p.lockedContexts)).length){k=v.concat(p.unSavedContexts);A.text=k.length===1?f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",r,null,p.entitySetName):f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL",r,null,p.entitySetName);}else{k=v.concat(p.unSavedContexts);t=true;A.text=k.length===1?f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL",r,null,p.entitySetName):f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",r,null,p.entitySetName);A.nonDeletableText=f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_NON_DELETABLE",r,[p.numberOfSelectedContexts-v.concat(p.unSavedContexts).length,p.numberOfSelectedContexts]);}if(p.lockedContexts.length>0){q=true;A.nonDeletableText=f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED",r,[p.lockedContexts.length,p.numberOfSelectedContexts]);}if(p.unSavedContexts.length>0&&p.unSavedContexts.length!==p.numberOfSelectedContexts){if((t||q)&&k.length===p.unSavedContexts.length){n=false;k=p.unSavedContexts;if(p.unSavedContexts.length===1){A.text=f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_SINGULAR",r);}else{A.text=f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_PLURAL",r);}}else{if(p.unSavedContexts.length===1){A.checkBoxText=f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_SINGULAR",r);}else{A.checkBoxText=f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_PLURAL",r);}n=true;}}if(t&&q){A.nonDeletableText=f.getTranslatedText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED_AND_NON_DELETABLE",r,[p.numberOfSelectedContexts-v.concat(p.unSavedContexts).length-p.lockedContexts.length,p.lockedContexts.length,p.numberOfSelectedContexts]);}}}var F=new V({items:[new T({text:A.nonDeletableText,visible:q||t}),new T({text:A.text}),new C({text:A.checkBoxText,selected:true,select:function(I){var K=I.getSource().getSelected();if(K){k=v.concat(p.unSavedContexts);w=true;}else{k=v;w=false;}},visible:n})]});var G=p.numberOfSelectedContexts?f.getTranslatedText("OBJECT_PAGE_DELETE_DIALOG",r,[p.numberOfSelectedContexts]):y.getText("OBJECT_PAGE_DELETE");var H=new b({title:G,state:"Warning",content:[F],beginButton:new a({text:y.getText("OBJECT_PAGE_DELETE"),type:"Emphasized",press:function(){g.lock(u);var I=Array.isArray(k)?k:[k];H.close();return Promise.all(I.map(function(K){K.delete().then(function(){if(l.getProperty("/$contexts/"+p.id+"/deleteEnabled")!=undefined){if(n===true&&w===false){l.setProperty("/$contexts/"+p.id+"/deleteEnabled",true);var N=Object.assign(l.getProperty("/$contexts/"+p.id),{});N.selectedContexts=N.selectedContexts.filter(function(O){return N.deletableContexts.indexOf(O)===-1;});N.deletableContexts=[];N.selectedContexts=[];N.numberOfSelectedContexts=N.selectedContexts.length;l.setProperty("/$contexts/"+p.id,N);}else{l.setProperty("/$contexts/"+p.id+"/deleteEnabled",false);l.setProperty("/$contexts/"+p.id+"/selectedContexts",[]);l.setProperty("/$contexts/"+p.id+"/numberOfSelectedContexts",0);}}if(I.length===1){M.show(f.getTranslatedText("OBJECT_PAGE_DELETE_TOAST_SINGULAR",r));}else{M.show(f.getTranslatedText("OBJECT_PAGE_DELETE_TOAST_PLURAL",r));}m.removeBoundTransitionMessages();x._bIsModified=true;return m.showUnboundMessages().then(i);}).catch(function(N){return m.showUnboundMessages().then(R);});})).finally(function(){g.unlock(u);});}}),endButton:new a({text:f.getTranslatedText("OBJECT_PAGE_CANCEL",r),press:function(){H.close();}}),afterClose:function(){H.destroy();}});H.addStyleClass("sapUiContentPadding");g.unlock(u);H.open();return new Promise(function(I,K){R=K;i=I;});},editDocument:function(i){this._bIsModified=false;var t=this;var u=this.getUIStateModel();if(!i){return Promise.reject(new Error("Binding context to active document is required"));}g.lock(u);return this.getProgrammingModel(i).then(function(p){switch(p){case h.DRAFT:t.activeContext=i;return d.createDraftFromActiveDocument(i,{bPreserveChanges:true});case h.NON_DRAFT:return i;case h.STICKY:return s.editDocumentInStickySession(i);}}).then(function(n){u.setProperty("/editMode","Editable");t._bCreateMode=false;return m.showUnboundMessages().then(function(){return n;});}).catch(function(k){return m.showUnboundMessages().then(function(){return Promise.reject(k);});}).finally(function(){g.unlock(u);});},updateDocument:function(){return Promise.resolve();},cancelDocument:function(i,p,r){var t=this,u=t.getUIStateModel(),k,l=sap.ui.getCore().getMessageManager();if(!i){return Promise.reject("No context exists. Pass a meaningful context");}else{l.removeMessages(l.getMessageModel().getData());}g.lock(u);p=j(p);var n=i,q=p.cancelButton,v=n.getModel(),w;return this.getProgrammingModel(i).then(function(x){k=x;if(x===h.DRAFT){var y=v.bindContext(n.getPath()+"/DraftAdministrativeData").getBoundContext();if(!t._bIsModified){return y.requestObject().then(function(z){t._bIsModified=!(z.CreationDateTime===z.LastChangeDateTime);});}}else if(x===h.NON_DRAFT){t._bIsModified=n.hasPendingChanges();}}).then(function(){return t._showDiscardPopover(q,t._bIsModified,r);}).then(function(){switch(k){case h.DRAFT:return n.requestObject("HasActiveEntity").then(function(H){if(!H){if(n&&n.hasPendingChanges()){n.getBinding().resetChanges();}n.delete();return false;}else{var A=t.activeContext||v.bindContext(n.getPath()+"/SiblingEntity").getBoundContext();return A.requestCanonicalPath().then(function(x){w=x;if(n&&n.hasPendingChanges()){n.getBinding().resetChanges();}n.delete();}).then(function(){if(A.getPath()!==w){A=v.bindContext(w).getBoundContext();}return A;});}});case h.STICKY:return s.discardDocument(i).then(function(i){if(i){if(i.hasPendingChanges()){i.getBinding().resetChanges();}if(!t._bCreateMode){i.refresh();return i;}}return false;});case h.NON_DRAFT:if(n===i&&t._bIsModified){i.getBinding().resetChanges();}break;}}).then(function(x){t._bIsModified=false;u.setProperty("/editMode","Display");m.removeBoundTransitionMessages();return m.showUnboundMessages().then(function(){return x;});}).catch(function(x){return m.showUnboundMessages().then(function(){return Promise.reject(x);});}).finally(function(){g.unlock(u);});},saveDocument:function(i,r){var u=this.getUIStateModel(),k,t=this;if(!i){return Promise.reject(new Error("Binding context to draft document is required"));}m.removeBoundTransitionMessages();g.lock(u);return this.getProgrammingModel(i).then(function(p){switch(p){case h.DRAFT:return d.activateDocument(i);case h.STICKY:return s.activateDocument(i);case h.NON_DRAFT:k=i.getModel();k.submitBatch(k.getUpdateGroupId());return i;}}).then(function(A){t._bIsModified=false;u.setProperty("/editMode","Display");M.show(f.getTranslatedText("OBJECT_SAVED",r));return m.showUnboundMessages().then(function(){return A;});}).catch(function(l){return m.showUnboundMessages().then(function(){return Promise.reject(l);});}).finally(function(){g.unlock(u);});},onCallAction:function(A,p){p=j(p);var u=this.getUIStateModel(),t=this,i,k,l,n,q=p.bindingParameters;if(!A){return Promise.reject("Provide name of action to be executed");}n=A.split("/")[1];A=n||A;i=n?undefined:p.contexts;if(i&&((Array.isArray(i)&&i.length)||!Array.isArray(i))){i=Array.isArray(i)?i[0]:i;k=i.getModel();}if(p.model){k=p.model;}if(!k){return Promise.reject("Pass a context for a bound action or pass the model for an unbound action");}var r=t._getBindingParameters(A,i)||{},v=t._getAppComponent(),w=false;if(i&&k){l=o.callBoundAction(A,p.contexts,k,{invocationGrouping:p.invocationGrouping,label:p.label,showActionParameterDialog:true,mBindingParameters:q,additionalSideEffect:r.aAdditionalPropertyPaths,onSubmitted:function(){w=true;g.lock(u);},parentControl:p.parentControl,ownerComponent:v,localUIModel:p.localUIModel,operationAvailableMap:p.operationAvailableMap,prefix:p.prefix,bIsCreateAction:p.bIsCreateAction});}else{l=o.callActionImport(A,k,{label:p.label,showActionParameterDialog:true,bindingParameters:q,entitySetName:p.entitySetName,onSubmitted:function(){w=true;g.lock(u);},parentControl:p.parentControl,localUIModel:p.localUIModel,operationAvailableMap:p.operationAvailableMap,prefix:p.prefix,ownerComponent:v});}return l.then(function(R){return m.showUnboundMessages().then(function(){return R;});}).catch(function(x){return m.showUnboundMessages().then(function(){return Promise.reject(x);});}).finally(function(){if(w){g.unlock(u);}});},_getBindingParameters:function(A,i){var k=i&&i.getModel().getMetaModel(),l=k&&k.getMetaContext(i.getPath()),n=l&&k.getObject(A+"@com.sap.vocabularies.Common.v1.SideEffects",l);if(!n){return{};}var t=n.TargetProperties||[],p=n.TargetEntities||[],E=l.getPath(),q=[];q=q.concat(t).concat(p);t.forEach(function(r){var u=k.getObject(E+"/"+r["$PropertyPath"]+"@com.sap.vocabularies.Common.v1.Text");if(u&&u["$Path"]){var v=r["$PropertyPath"],N=v.indexOf("/")>-1?v.replace(/[^\/]+$/,""):"";q.push({"$PropertyPath":N+u["$Path"]});}});q=S.replaceEmptyNavigationPaths(q);q=S.addTextProperties(q,k,E);return{aAdditionalPropertyPaths:q};},_showDiscardPopover:function(i,I,r){var t=this;t._bContinueDiscard=false;return new Promise(function(k,l){if(!i){l("Cancel button not found");}if(I){var O=function(){i.setEnabled(true);if(t._bContinueDiscard){k();}else{l("Discard operation was rejected. Document has not been discarded");}t._oPopover.detachAfterClose(O);};if(!t._oPopover){t._oPopover=new P({showHeader:false,placement:"Top",content:[new V({items:[new T({text:f.getTranslatedText("SAPFE_DRAFT_DISCARD_MESSAGE",r)}),new a({text:f.getTranslatedText("SAPFE_DRAFT_DISCARD_BUTTON",r),width:"100%",press:function(){t._bContinueDiscard=true;t._oPopover.close();}})]})],beforeOpen:function(){i.setEnabled(false);t._oPopover.setInitialFocus(t._oPopover);}});t._oPopover.addStyleClass("sapUiContentPadding");}t._oPopover.attachAfterClose(O);t._oPopover.openBy(i);}else{k();}});},handleDocumentModifications:function(){this._bIsModified=true;},_getAppComponent:function(){return this._oAppComponent;},_getRouting:function(){return this._getAppComponent()._oRouting;}});});
