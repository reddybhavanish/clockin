/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/mvc/ControllerExtension","sap/m/MessagePage","sap/m/Link","sap/m/MessageBox","sap/ui/core/routing/HashChanger","sap/base/Log","sap/fe/core/CommonUtils","sap/ui/base/BindingParser","sap/fe/core/BusyLocker","sap/fe/core/AppStateHandler","sap/fe/core/actions/messageHandling"],function(F,a,C,M,L,b,H,c,d,B,e,A,m){"use strict";var u,D,o,t,P,O=[],s,E,S=[],f,g,h,n=function(){c.debug("target binding of custom page or re-use component: "+s);};var k={CLEAN:0,PROCESSED:1,DIRTY:2};var l=C.extend("sap.fe.core.controllerextensions.Routing",{navigateToContext:function(i,p){p=p||{};var r=this._getOwnerComponent().getRootContainer(),v=this.getView().getViewData(),j,T,q=null,R,w,x=this._getOwnerComponent().getRouterProxy(),y=this;if(p.targetPath&&v.navigation){w=v.navigation[p.targetPath].detail;T=w.route;if(w.parameters){q=this.prepareParameters(w.parameters,T,i);}}if(i.isA("sap.ui.model.odata.v4.ODataListBinding")){if(p.asyncContext){x.activateRouteMatchSynchronization();p.asyncContext.then(function(i){y.navigateToContext(i,{noHistoryEntry:true,noHashChange:p.noHashChange,useCanonicalPath:p.useCanonicalPath,editable:p.editable,bPersistOPScroll:p.bPersistOPScroll,updateFCLLevel:p.updateFCLLevel});});o=p.asyncContext;}else if(p.deferredContext){D=true;}else{throw"navigation to a list binding is not yet supported";}}else{if(i.getBinding()&&i.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")){if(d.hasTransientContext(i.getBinding())){R=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");b.show(R.getText("NAVIGATION_DISABLED_MESSAGE"),{icon:b.Icon.WARNING,title:R.getText("NAVIGATION_DISABLED_TITLE"),actions:[b.Action.CLOSE],details:R.getText("TRANSIENT_CONTEXT_DESCRIPTION"),contentWidth:"100px"});return Promise.resolve();}}u=i;}t=p.editable;P=p.bPersistOPScroll;if(p.useCanonicalPath){j=i.getCanonicalPath();}else if(i.isA("sap.ui.model.odata.v4.ODataListBinding")&&i.isRelative()){j=i.getHeaderContext().getPath();}else{j=i.getPath();}if(p.updateFCLLevel===-1){var z=new RegExp("/[^/]*$");j=j.replace(z,"");u=null;if(j.length===0&&E){return x.exitFromApp();}}var G=H.getInstance().getHash();var I=this._getOwnerComponent();var J=I.getRootViewController();if(p.asyncContext||p.deferredContext){j+="(...)";}else if(S&&S.length&&g&&G.split("/").length===1&&G.indexOf("(...)")===-1&&j!==""&&!I.getRootViewController().isFclEnabled()){var K=(i&&i.getPath().substring(0,i.getPath().indexOf("(")))||G.substring(0,G.indexOf("("));var N="";while(K.indexOf("/")===0){K=K.substr(1);}if(v.viewLevel===0){N=this._createHash(S,K,i);}else if(v.viewLevel===1&&G!==""){if(p.useHash){N=G;}else if(i&&i.getPath().split("/").length<=2){N=this._createHash(S,K,i);}}if(N!==""){if(G===N||G.replace(/[&?]{1}sap-iapp-state=[A-Z0-9]+/,"")===N){this._bindTargetPage(r.getCurrentPage(),null,null,true);return Promise.resolve();}else if(N===undefined){if(p.useHash){this._bindTargetPage(r.getCurrentPage(),null,null,true);return Promise.resolve();}}else{j=N;}}}if(I.getRootViewController().isFclEnabled()){var Q=this.base.fcl.getFCLLevel();if(p.updateFCLLevel){Q+=p.updateFCLLevel;if(Q<0){Q=0;}}var U;if(p.sLayout){U=p.sLayout;}else{U=J.getFCLLayout(Q,j);}j+="?layout="+U;}while(j.indexOf("/")===0){j=j.substr(1);}if(p.noHashChange){if(I.getRootViewController().isFclEnabled()){if(j===this._getOwnerComponent().getRouter().getHashChanger().getHash()){var V;switch(this.base.fcl.getFCLLevel()){case 0:V=r.getCurrentBeginColumnPage();break;case 1:V=r.getCurrentMidColumnPage();break;default:V=r.getCurrentEndColumnPage();break;}this._bindTargetPage(V,null,null,true);return Promise.resolve();}}else{this._bindTargetPage(r.getCurrentPage(),null,null,true);return Promise.resolve();}}if(T&&q!==null){this._getOwnerComponent().getRouter().navTo(T,q);}else if(p.transient&&p.editable==true&&j.indexOf("(...)")===-1){if(j.indexOf("?")>-1){j+="&i-action=create";}else{j+="?i-action=create";}}return x.navToHash(j);},prepareParameters:function(p,T,i){var j;try{var q=i.getPath();var r=q.split("/");j=Object.keys(p).reduce(function(R,w){var x=p[w];var y=B.complexParser(x);var z=y.parts||[y];var G=z.map(function(I){var J=I.path.split("../");var K=r.slice(0,r.length-J.length+1);K.push(J[J.length-1]);return i.getObject(K.join("/"));});if(y.formatter){R[w]=y.formatter.apply(this,G);}else{R[w]=G.join("");}return R;},{});}catch(v){c.error("Could not parse the parameters for the navigation to route "+T);j=undefined;}return j;},navigateBackFromContext:function(i,p){p=p||{};p.updateFCLLevel=-1;return this.navigateToContext(i,p);},navigateForwardToContext:function(i,p){p=p||{};p.updateFCLLevel=1;return this.navigateToContext(i,p);},navigateToMessagePage:function(i,p){p=p||{};if(H.getInstance().getHash().indexOf("i-action=create")>-1){var j=d.getAppComponent(p.navContainer);var q=this.getEntitySet(j);var r=q+"(...)";var R=j.getRouterProxy();R.navToHash(r);return;}var v=p.navContainer||this._getOwnerComponent().getRootContainer();if(!this.oMessagePage){this.oMessagePage=new M({showHeader:false,icon:"sap-icon://message-error"});v.addPage(this.oMessagePage);}this.oMessagePage.setText(i);if(p.technicalMessage){this.oMessagePage.setCustomDescription(new L({text:p.description||p.technicalMessage,press:function(){b.show(p.technicalMessage,{icon:b.Icon.ERROR,title:p.title,actions:[b.Action.OK],defaultAction:b.Action.OK,details:p.technicalDetails||"",contentWidth:"60%"});}}));}else{this.oMessagePage.setDescription(p.description||"");}v.to(this.oMessagePage);},navigateBackFromTransientState:function(i,p){var j=H.getInstance().getHash();if(j.indexOf("(...)")!==-1){if(p&&p.unLockObject&&e.isLocked(p.unLockObject)){e.unlock(p.unLockObject);}var r=i.getRouterProxy();r.navigateBack({rebuildHistory:true});}},setUIStateDirty:function(){l.flagUIState=k.DIRTY;},setUIStateProcessed:function(){l.flagUIState=k.PROCESSED;},resetUIState:function(){l.flagUIState=k.CLEAN;},isUIStateDirty:function(){return l.flagUIState!==k.CLEAN;},cleanProcessedUIState:function(){if(l.flagUIState===k.PROCESSED){l.flagUIState=k.CLEAN;}},getFirstBeforeRouteMatchedCallEvent:function(){return h;},initializeRouting:function(i){var j=this;h=null;return new Promise(function(r,q){var R=i.getRouter(),v,w=j.getEntitySet(i),x,y=i.getComponentData(),z=y&&y.startupParameters,G=i.getModel(),I=z!==undefined&&Object.keys(z).length!==0;u=null;D=false;o=null;t=false;P=null;O=[];E=false;j.resetUIState();var J=[];if(G){J.push(G.getMetaModel().requestObject("/$EntityContainer/"+w+"/"));J.push(G.getMetaModel().requestObject("/$EntityContainer/"+w+"/@"));J.push(G.getMetaModel().requestObject("/$EntityContainer/"+w+"@"));}R.attachBeforeRouteMatched(function(p){var K=i.getRootControl();e.lock(K);if(!h&&p){h=Object.assign({},p);h.getParameters=p.getParameters;h.getParameter=p.getParameter;}});v=function(K){var N=K.getParameters().arguments,T="",Q,U;j.fireOnAfterNavigation();var V=i.getRootControl();if(e.isLocked(V)){e.unlock(V);}if(A.checkIfRouteChangedByIApp()){A.resetRouteChangedByIApp();return;}if(Object.keys(N).length>0){var W;if(K.getParameter("view").getComponentInstance&&K.getParameter("view").getComponentInstance()&&K.getParameter("view").getComponentInstance().getBindingContextPattern){W=K.getParameter("view").getComponentInstance().getBindingContextPattern();}T=W||K.getParameters().config.pattern;T=T.replace(":?query:","");for(var p in N){Q=N[p];if(Q==="..."){U=true;t=true;}T=T.replace("{"+p+"}",Q);}if(T&&T[0]!=="/"){T="/"+T;}}var X=K.getParameter("config").target;if(i.getRootViewController().isFclEnabled()&&typeof X==="object"&&X.length){i.getRootViewController().updateFCLLevels(X,K.getParameter("views"));X.forEach(function(Y,Z){var $=i.getRootViewController().getTargetAggregation()[Y];if($.pattern!==undefined){T=j.buildBindingContext($.pattern,N);}var _=K.getParameter("views")[Z];if(_!=null){j._bindTargetPage(_,T,U,false,true);}else{throw new Error("No Container found for target "+Y+"(Please check the Router configuration)");}});}else{var V=i.getRootContainer();j._bindTargetPage(V.getCurrentPage(),T,U,false);}j.cleanProcessedUIState();if(!history.state||history.state.feLevel===undefined){i.getRouterProxy().restoreHistory();}i.getRouterProxy().resolveRouteMatch();};R.attachRouteMatched(v);Promise.all(J).then(function(V){f=V[0];var p=V[1];g=V[2]["@com.sap.vocabularies.Common.v1.DraftRoot"]||V[2]["@com.sap.vocabularies.Common.v1.DraftNode"];var T=f["$Key"];S=p["@com.sap.vocabularies.Common.v1.SemanticKey"];if(I){if(z.preferredMode&&z.preferredMode[0]==="create"&&!H.getInstance().getHash()){if(w){x=w+"(...)";}else{c.error("Cannot handle this App");}H.getInstance().replaceHash(x);E=true;}else{var K;var N=i.getRootViewController();if(S&&S.length&&z[S[0].$PropertyPath]&&!(N&&N.isFclEnabled())){K=j._createHash(S,w,z);}else if(T&&z[T[0]]){K=j._createHash(T,w,z);}if(K){H.getInstance().replaceHash(K);}}}R.initialize();r();}).catch(function(p){c.error("Metadata not loaded: "+p);q();});});},_bindTargetPage:function(T,p,q,N,I){var r=T.getComponentInstance?T.getComponentInstance():T.getController(),v=(r.onBeforeBinding||n).bind(r),w=(r.onAfterBinding||n).bind(r),x,y,z,G,J,K=T.getModel().getMetaModel(),Q=T.getComponentInstance&&T.getComponentInstance().getEntitySet&&T.getComponentInstance().getEntitySet(),R=this,U;function V(){if(S&&S.length){var $=[];var _=[];var X=H.getInstance().getHash();X=X.split("?")[0];if(u){var a1;for(var i=0;i<S.length;i++){a1=u.getObject(S[i].$PropertyPath);if(a1){_.push(a1);}else{return undefined;}}}else{_=X.substring(X.indexOf("(")+1,X.length-1).split(",");}for(var j=0;j<S.length;j++){var b1=S[j].$PropertyPath;var c1;if(_.length===1){c1=_[0];}else{c1=_[j].split("=")[1];}if(c1.indexOf("'")===0&&c1.lastIndexOf("'")===c1.length-1){c1=c1.substr(1,c1.length-2);}$.push(new F(b1,a.EQ,c1));}if(g){var d1=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});$.push(d1);}var Y=new F($,true);return Y;}}function W(){if(!N){x=T.getBindingContext();y=x&&x.getPath();z=x&&x.getBinding();G=u&&u.getBinding();}if(N||y!==p||(u&&z!==G&&!I)){if(p||N){if(!u||u.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")){J=u&&u.getBinding();var i={$$patchWithoutSideEffects:true,$$groupId:"$auto.Heroes"};if(U){i.$select=U;}var j=T.getModel().bindContext(p,undefined,i);j.attachDataRequested(function(){e.lock(T);});j.attachDataReceived(function($){var _=$&&$.getParameter("error");e.unlock(T);if(_){sap.ui.getCore().getLibraryResourceBundle("sap.fe.core",true).then(function(a1){m.removeUnboundTransitionMessages();R.navigateToMessagePage(a1.getText("SAPFE_DATA_RECEIVED_ERROR"),{title:a1.getText("SAPFE_ERROR"),description:_,navContainer:T.getParent()});});}});u=j.getBoundContext();if(R.isUIStateDirty()){setTimeout(function(){R._refreshBindingContext(x,U);},0);}}x=u;v(x,{editable:t,listBinding:J,bPersistOPScroll:P});T.setBindingContext(x);w(x);u=null;}else if(p===""){v(null);w(null);}}else if(R.isUIStateDirty()){R._refreshBindingContext(x,U);}}s=T.getComponent?T.getComponent():T.getControllerName();if(Q){U=K.getProperty("/"+Q+"/@com.sap.vocabularies.Common.v1.Messages/$Path");}if(q){v(null,{editable:t});if(D||!o){if(r&&r.createDeferredContext){r.createDeferredContext(p);o=null;D=false;}}if(T.getBindingContext()&&T.getBindingContext().hasPendingChanges()){T.getBindingContext().getBinding().resetChanges();}T.setBindingContext(null);return false;}var X=H.getInstance().getHash();if(S&&S.length&&g&&X.split("/").length===1&&p!==""&&!I){if(!u){var Y=V();var Z=T.getModel().bindList("/"+X.substring(0,X.indexOf("(")),undefined,undefined,Y);Z.requestContexts().then(function(i){if(i&&i.length){p=i[0].getPath();}W();}).catch(function(i){var j=T.getParent();var $=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");this.navigateToMessagePage($.getText("SAPFE_DATA_RECEIVED_ERROR"),{title:$.getText("SAPFE_ERROR"),description:i.message,navContainer:j});}.bind(this));}else{p=u.getPath();W();}}else{W();}},buildBindingContext:function(p,i){if(p.length===0){return"";}var j=p;var q=p.indexOf("{");if(q!=-1){var r=p.indexOf("}");var v=p.substr(q+1,r-q-1);j=p.substr(0,q)+i[v];j+=this.buildBindingContext(p.substr(r+1),i);}return j;},_refreshBindingContext:function(j,p){var N=[],q=[],r=[];var v=function(w){var x,y=w.getPath();if(w.isA("sap.ui.model.odata.v4.ODataContextBinding")){x=w.getDependentBindings();if(x){for(var i=0;i<x.length;i++){v(x[i]);}}else{if(N.indexOf(y)===-1){N.push(y);}}}else if(w.isA("sap.ui.model.odata.v4.ODataListBinding")){if(N.indexOf(y)===-1){N.push(y);}}else if(w.isA("sap.ui.model.odata.v4.ODataPropertyBinding")){if(q.indexOf(y)===-1){q.push(y);}}};v(j.getBinding());for(var i=0;i<N.length;i++){r.push({$NavigationPropertyPath:N[i]});}for(var i=0;i<q.length;i++){r.push({$PropertyPath:q[i]});}if(p){r.push({$PropertyPath:p});}j.requestSideEffects(r);},attachOnAfterNavigation:function(i){O.push(i);},detachOnAfterNavigation:function(j){for(var i=0;i<O.length;i++){if(O[i]===j){O.splice(i,1);}}},fireOnAfterNavigation:function(){for(var i=0;i<O.length;i++){O[i]();}},getOutbounds:function(){if(!this.outbounds){if(!this.manifest){this.manifest=this._getOwnerComponent().getMetadata().getManifest();}this.outbounds=this.manifest["sap.app"]&&this.manifest["sap.app"].crossNavigation&&this.manifest["sap.app"].crossNavigation.outbounds;}return this.outbounds;},_getOwnerComponent:function(){return d.getAppComponent(this.base.getView());},getEntitySet:function(p){var q;var r=p.getManifest();var R=r["sap.ui5"].routing.routes;var T=r["sap.ui5"].routing.targets;var v;for(var i in R){v=R[i].pattern;if(v===""||":?query:"){q=T[R[i].target].options&&T[R[i].target].options.settings&&T[R[i].target].options.settings.entitySet;return q;}}if(!(p.getRootViewController()&&p.getRootViewController().isFclEnabled())){for(var j in R){v=R[j].pattern;if((v!==""||":?query:")&&T[R[j].target].options&&T[R[j].target].options.settings&&T[R[j].target].options.settings.entitySet===q&&T[R[j].target].name==="sap.fe.templates.ObjectPage"){return q;}}}if(q==undefined){if(R.length===1){q=R[0].pattern.split("(")[0];return q;}}},_createHash:function(K,j,p){var q=j+"(";var r,v;var w=this._getEntityType();if(K.length===1){r=K[0].$PropertyPath||K[0];v=p.isA&&p.isA("sap.ui.model.odata.v4.Context")?p.getObject(r):p[r][0];if(v!==undefined){q=w[r].$Type==="Edm.String"?q+"'"+v+"'":q+v;}else{q=undefined;}}else{for(var i=0;i<K.length;i++){r=K[i].$PropertyPath||K[i];v=p.getObject?p.getObject(r):p[r][0];if(v){q=w[r].$Type==="Edm.String"?q+r+"='"+v+"'":q+r+"="+v;if(i!==K.length-1){q=q+",";}}else{q=undefined;break;}}}if(q){q=q+")";return q;}return undefined;},_getEntityType:function(){return f||null;}});l.flagUIState=k.CLEAN;return l;});
