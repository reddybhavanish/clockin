sap.ui.define(["sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/model/base/ManagedObjectModel","sap/ui/core/cache/CacheManager","sap/ui/model/resource/ResourceModel","sap/ui/core/mvc/View","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/base/Log","sap/ui/core/routing/HashChanger","sap/fe/core/TemplateModel","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/DynamicAnnotationPathHelper"],function(S,a,b,M,C,R,V,c,J,L,H,T,d,D){"use strict";function e(n,i){this.name=n;this.currentPath=i||"";this.lastPath="";this.set=function(N){while(N.indexOf("../")===0){this.currentPath=this.currentPath.substr(0,this.currentPath.lastIndexOf(this.lastPath)-1);this.lastPath=this.currentPath.substr(this.currentPath.lastIndexOf("/")+1);N=N.substr(3);}if(N){this.lastPath=N;}this.currentPath+=N;L.info(this.name+" is now : "+this.currentPath);};this.get=function(){return this.currentPath;};this.delete=function(){this.currentPath="";L.info(this.name+" has been deleted");};}var f=S.extend("sap.fe.core.services.TemplatedViewService",{initPromise:null,init:function(){var t=this;var s=[];var o=this.getContext();var g=o.scopeObject;var A=c.getOwnerComponentFor(g);var m=A.getMetaModel();var h=A.getMetadata().getComponentName()+"::"+A.getLocalId(g.getId());var E=g.getEnhanceI18n()||[];if(E){for(var i=0;i<E.length;i++){E[i]=A.getManifestObject().resolveUri(E[i],"manifest");}}var j=A.getMetadata().getName()+"_"+h+"_"+sap.ui.getCore().getConfiguration().getLanguageTag();s.push(b.get("sap.fe.core.services.ResourceModelService").createInstance({scopeType:"component",scopeObject:g,settings:{bundles:["sap.fe.core","sap.fe.templates"],enhanceI18n:E,modelName:"sap.fe.i18n"}}).then(function(r){return r.getResourceModel();}));s.push(b.get("sap.fe.core.services.CacheHandlerService").createInstance({settings:{metaModel:m}}).then(function(k){return k.validateCacheKey(j);}));this.initPromise=Promise.all(s).then(function(k){var r=k[0];var l=k[1];return t.createView(r,h,l);}).then(function(k){var l=b.get("sap.fe.core.services.CacheHandlerService").getInstance(m);l.invalidateIfNeeded(k,j);});},createView:function(r,s,g){var t=this;var o=this.getContext(),m=o.settings,v=m.viewName,h=o.scopeObject,E=h.getProperty("entitySet"),A=c.getOwnerComponentFor(h),i=A.getMetaModel(),j=new J(sap.ui.Device).setDefaultBindingMode("OneWay"),k=new J(A.getManifest()),l=new J({currentPath:new e(),navigationPath:new e("NavigationPath")});this.oFactory=o.factory;return A.getService("routingService").then(function(n){var p=n.getTargetInformationFor(h);var q={navigation:h.getNavigation(),viewLevel:p.viewLevel,stableId:s};if(h.getViewData){Object.assign(q,h.getViewData());}var u=new J(q),P=new J(d.convertPage(v.split(".").pop(),i,q)),w=o.oTemplateModel,G=o.oConfigModel,x=G.getData();x[s]=P.getData();if(q&&q.controlConfiguration){Object.keys(q.controlConfiguration).forEach(function(B){if(B.indexOf("[")!==-1){var F=D.resolveDynamicExpression(B,i);q.controlConfiguration[F]=q.controlConfiguration[B];}});}var y={type:"XML",preprocessors:{xml:{bindingContexts:{entitySet:E?w.createBindingContext("/"+E,null,{$$configModelPath:"/"+s+"/"+E}):null,viewData:q?u.createBindingContext("/"):null},models:{entitySet:w,"sap.fe.i18n":r,"sap.ui.mdc.metaModel":i,"sap.fe.deviceModel":j,manifest:k,viewData:u,metaPath:l}}},id:s,viewName:m.viewName,viewData:q,cache:{keys:[g]},height:"100%"};function z(B){L.error(B);y.viewName=m.errorViewName||"sap.fe.core.services.view.TemplatingErrorPage";y.preprocessors.xml.models["error"]=new J(B);return h.runAsOwner(function(){return V.create(y);});}return h.runAsOwner(function(){return V.create(y).catch(z).then(function(B){t.oView=B;t.oView.setModel(new M(t.oView),"$view");h.setAggregation("rootControl",t.oView);return g;}).catch(L.error);});}).catch(function(n){throw new Error("Error while creating view : "+n);});},getView:function(){return this.oView;},exit:function(){this.oFactory.removeGlobalInstance();}});return a.extend("sap.fe.core.services.TemplatedViewServiceFactory",{_oInstanceRegistry:{},createInstance:function(s){var A=c.getOwnerComponentFor(s.scopeObject);if(!this._oInstanceRegistry[A]){var o=new J();this._oInstanceRegistry[A]={configModel:o,templateModel:new T(A.getMetaModel(),o)};}s.oTemplateModel=this._oInstanceRegistry[A].templateModel;s.oConfigModel=this._oInstanceRegistry[A].configModel;var t=new f(Object.assign({factory:this},s));return t.initPromise.then(function(){return t;});},removeGlobalInstance:function(){this._oInstanceRegistry={};}});},true);
