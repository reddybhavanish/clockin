/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/fe/macros/ResourceModel","sap/fe/macros/CommonHelper","sap/fe/core/CommonUtils","sap/ui/mdc/odata/v4/FieldBaseDelegate","sap/ui/model/odata/v4/AnnotationHelper","sap/ui/base/ManagedObject","sap/base/Log","sap/base/strings/formatMessage","sap/ui/model/json/JSONModel","sap/ui/mdc/condition/FilterOperatorUtil"],function(R,C,a,F,A,M,L,f,J,b){"use strict";var I="@Org.OData.Measures.V1.ISOCurrency",U="@Org.OData.Measures.V1.Unit",c={},d=", ";c[I]={ui5Type:"sap.ui.model.type.Currency",formatOptions:"parseAsString : true"};function _(i){var m=i.getModel(),o=i.getSetting("sap.fe.macros.Field"),s=o.sideEffects;if(s){return Promise.resolve(s);}s={};return m.requestObject("/$").then(function(E){var g=function(k){return E[k]["$kind"]==="EntityType";},h=function(k,S,l){var q=(S.indexOf("#")>-1&&S.substr(S.indexOf("#")))||"",n=l.SourceProperties||[],p=l.SourceEntities||[],P=[];n.forEach(function(r){var t=r["$PropertyPath"],N=t.indexOf("/")>0?"/"+k+"/"+t.substr(0,t.lastIndexOf("/")+1)+"@sapui.name":false,u=!N?Promise.resolve(k):m.requestObject(N);t=N?t.substr(t.lastIndexOf("/")+1):t;P.push(u.then(function(O){s[O]=s[O]||[[],{}];s[O][1][t]=s[O][1][t]||[];s[O][1][t].push(k+q+((n.length===1&&"$$ImmediateRequest")||""));}));});p.forEach(function(r){var N=r["$NavigationPropertyPath"],t;if(N===""){t=Promise.resolve(k);}else{t=m.requestObject("/"+k+"/"+N+"/@sapui.name");}P.push(t.then(function(O){s[O]=s[O]||[[],{}];s[O][0].push(k+q+"$$ImmediateRequest");}));});return Promise.all(P);},j=function(k){return m.requestObject("/"+k+"@").then(function(l){var S=Object.keys(l).filter(function(n){return n.indexOf("@com.sap.vocabularies.Common.v1.SideEffects")>-1;}).map(function(n){return h(k,n,l[n]);});return Promise.all(S);});};return Promise.all(Object.keys(E).filter(g).map(j)).then(function(){o.sideEffects=s;return s;});});}var e={getFieldDisplay:function(o,D,g,h,E,s,p,i,j){var k="",l="";if(j){return e.displayMode(o,i);}else{l=C.getEditMode(o,D,g,h,E,s,p,false,undefined,undefined);if(l==="Editable"){return"Value";}else{k=e.displayMode(o,i);if(M.bindingParser(l)){if(!l.startsWith("{=")){return"{= $"+l+" === 'Editable' ? 'Value' : '"+k+"' }";}return("{= ("+l.slice(2,l.length-1).trim()+") === 'Editable' ? 'Value' : '"+k+"' }");}if(k!=="Description"&&p==="VHTable"){k="Value";}return k;}}},displayMode:function(p,o){var t=p["@com.sap.vocabularies.Common.v1.Text"],T=t&&((p&&p["@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement"])||(o&&o["@com.sap.vocabularies.UI.v1.TextArrangement"]));if(T){if(T.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"){return"Description";}else if(T.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextLast"){return"ValueDescription";}return"DescriptionValue";}return t?"DescriptionValue":"Value";},isRequiredInFilter:function(p,D){var E,P,i=false,o,m=D.context.getModel(),s=D.context.getPath();E=C._getEntitySetPath(m,s);if(typeof p==="string"){P=p;}else{P=m.getObject(s+"@sapui.name");}o=m.getObject(E+"@Org.OData.Capabilities.V1.FilterRestrictions");if(o&&o.RequiredProperties){i=o.RequiredProperties.some(function(g){return g.$PropertyPath===P;});}return i;},maxConditions:function(p,D){var E,P,o,m=-1,g=D.context.getModel(),s=D.context.getPath();E=C._getEntitySetPath(g,s);if(typeof p==="string"){P=p;}else{P=g.getObject(s+"@sapui.name");}o=g.getObject(E+"@Org.OData.Capabilities.V1.FilterRestrictions");var h=g.getObject(E+"/"+P);if(!h){h=g.getObject(s);}if(h.$Type==="Edm.Boolean"){m=1;}else if(o&&o.FilterExpressionRestrictions&&o.FilterExpressionRestrictions.some(function(i){return(i.Property.$PropertyPath===P&&(i.AllowedExpressions==="SingleValue"||i.AllowedExpressions==="SingleRange"));})){m=1;}return m;},buildExpressionForCriticalityIcon:function(s){if(s){var E="{= (${"+s+"} === 'com.sap.vocabularies.UI.v1.CriticalityType/Negative') || (${"+s+"} === '1') || (${"+s+"} === 1) ? 'sap-icon://status-negative' : "+"(${"+s+"} === 'com.sap.vocabularies.UI.v1.CriticalityType/Critical') || (${"+s+"} === '2') || (${"+s+"} === 2) ? 'sap-icon://status-critical' : "+"(${"+s+"} === 'com.sap.vocabularies.UI.v1.CriticalityType/Positive') || (${"+s+"} === '3') || (${"+s+"} === 3) ? 'sap-icon://status-positive' : "+"'sap-icon://status-inactive' }";return E;}return undefined;},buildExpressionForCriticalityColor:function(D){var s=sap.ui.core.ValueState.None;var E;var o=D.Criticality;if(o){E="'{'= ({0} === ''com.sap.vocabularies.UI.v1.CriticalityType/Negative'') || ({0} === ''1'') || ({0} === 1) ? ''"+sap.ui.core.ValueState.Error+"'' : "+"({0} === ''com.sap.vocabularies.UI.v1.CriticalityType/Critical'') || ({0} === ''2'') || ({0} === 2) ? ''"+sap.ui.core.ValueState.Warning+"'' : "+"({0} === ''com.sap.vocabularies.UI.v1.CriticalityType/Positive'') || ({0} === ''3'') || ({0} === 3) ? ''"+sap.ui.core.ValueState.Success+"'' : "+"''"+sap.ui.core.ValueState.None+"'' '}'";if(o.$Path){var g="${"+o.$Path+"}";s=f(E,g);}else if(o.$EnumMember){var h="'"+o.$EnumMember+"'";s=f(E,h);}else{L.warning("Case not supported, returning the default sap.ui.core.ValueState.None");}}else{L.warning("Case not supported, returning the default sap.ui.core.ValueState.None");}return s;},buildExpressionForTextValue:function(p,D){var m=D.context.getModel(),P=D.context.getPath(),t=m.createBindingContext(P+"@com.sap.vocabularies.Common.v1.Text"),T=t.getProperty(),s=T?A.value(T,{context:t}):undefined,E="";p=A.getNavigationPath(p);if(p.indexOf("/")>-1&&s){E="{"+p.substr(0,p.indexOf("/")+1)+s.substr(1,s.length-2)+"}";}else{E=s;}if(E){E="{ path : '"+E.substr(1,E.length-2)+"', parameters: {'$$noPatch': true}}";}return E;},_buildExpressionForTextProperty:function(p,i){var m=i.context.getModel(),P=i.context.getPath(),g=P.split("/"),t=m.createBindingContext(P+"@com.sap.vocabularies.Common.v1.Text"),T=t.getProperty(),s=T?A.value(T,{context:t}):undefined,E="";if(s){E=s;s=s.substr(1,s.length-2);if(g.length>2){g.shift();g.shift();g.pop();E="{"+(g.length>0?g.join("/")+"/":"")+s+"}";}}if(E){E="{ path : '"+E.substr(1,E.length-2)+"', parameters: {'$$noPatch': true}}";}return E;},isNotAlwaysHidden:function(D,o){var g=o.context,i=false;if(D.Value&&D.Value.$Path){i=g.getObject("Value/$Path@com.sap.vocabularies.UI.v1.Hidden");}if(!i||i.$Path){i=g.getObject("@com.sap.vocabularies.UI.v1.Hidden");if(!i||i.$Path){i=false;}}return!i;},isSemanticKey:function(s,v){return((v&&s&&!s.every(function(k){return k["$PropertyPath"]!==v["$Path"];}))||false);},isLineItem:function(p,i){if(i.context.getPath().indexOf("@com.sap.vocabularies.UI.v1.LineItem")>-1){return true;}return false;},getRequiredForDataField:function(o,E){var s;if(E==="Display"||E==="ReadOnly"||E==="Disabled"){return false;}if(o&&E){if(E.indexOf("{")>-1){s="%"+E+" === 'Editable'";}if(o.indexOf("{")>-1){var g="%"+o+" === 7";return E==="Editable"?"{="+g+"}":"{= "+g+" && "+s+"}";}else{return E==="Editable"?o=="com.sap.vocabularies.Common.v1.FieldControlType/Mandatory":o=="com.sap.vocabularies.Common.v1.FieldControlType/Mandatory"&&"{= "+s+"}";}}return false;},isRequired:function(o,E){if(E==="Display"||E==="ReadOnly"||E==="Disabled"){return false;}if(o){if(M.bindingParser(o)){var s="{= %"+o+" === 7}";return s;}else{return o=="com.sap.vocabularies.Common.v1.FieldControlType/Mandatory";}}return false;},_getDraftAdministrativeDataType:function(m,E){return m.requestObject("/"+E+"/DraftAdministrativeData/");},getBindingForDraftAdminBlockInline:function(i,E){return e._getDraftAdministrativeDataType(i.getModel(),E).then(function(D){var B=[];if(D.InProcessByUserDescription){B.push("${DraftAdministrativeData/InProcessByUserDescription}");}B.push("${DraftAdministrativeData/InProcessByUser}");if(D.LastChangedByUserDescription){B.push("${DraftAdministrativeData/LastChangedByUserDescription}");}B.push("${DraftAdministrativeData/LastChangedByUser}");return"{= %{HasDraftEntity} ? ("+B.join(" || ")+") : '' }";});},getBindingForDraftAdminBlockInPopover:function(i,E){return e._getDraftAdministrativeDataType(i.getModel(),E).then(function(D){var B="{parts: [{path: 'HasDraftEntity', targetType: 'any'}, "+"{path: 'DraftAdministrativeData/InProcessByUser'}, "+"{path: 'DraftAdministrativeData/LastChangedByUser'} ";if(D.InProcessByUserDescription){B+=" ,{path: 'DraftAdministrativeData/InProcessByUserDescription'}";}if(D.LastChangedByUserDescription){B+=", {path: 'DraftAdministrativeData/LastChangedByUserDescription'}";}B+="], formatter: 'sap.fe.macros.field.FieldRuntime.formatDraftOwnerTextInPopover'}";return B;});},propertyName:function(p,i){var P;if(typeof p==="string"){P=p;}else if(p.$Path||p.$PropertyPath){var s=p.$Path?"/$Path":"/$PropertyPath";var g=i.context.getPath();P=i.context.getObject(g+s+"/$@sapui.name");}else{P=i.context.getObject("@sapui.name");}return P;},getConditionsBinding:function(g,p,E,s){var m=g.getInterface(0).getModel();if(!s){s=typeof p==="string"?p:e.propertyName(p,{context:m.createBindingContext(g.getInterface(0).getPath())});}if(s.indexOf("/")>-1){var t,S=s.split("/");for(var i=0;i<S.length-1;i++){var P=m.getObject("/"+E+"/"+S.slice(0,i+1).join("/"));if(P&&P.$kind==="NavigationProperty"&&P.$isCollection){S[i]=S[i]+"*";t=true;}}if(t){s=S.join("/");}}return"{$filters>/conditions/"+s+"}";},typeConstraints:function(p,P){var s="",m,t=p.$Type;s+=p.$Nullable!==undefined&&!p.$Nullable?"nullable: "+p.$Nullable:"";if(["Edm.Decimal","Edm.DateTimeOffset"].indexOf(t)>-1){s+=p.$Precision?(s?d:"")+"precision: "+p.$Precision:"";s+=p.$Scale?(s?d:"")+"scale: "+(p.$Scale==="variable"?"'"+p.$Scale+"'":p.$Scale):"";}else if(t==="Edm.String"){m=p.$MaxLength;if(m){s+=s?d:"";s+="maxLength: "+m;}if(P["@com.sap.vocabularies.Common.v1.IsUpperCase"]){}}return s;},value:function(p,i){var o=i.context,r=o.getObject("./$"),m=typeof p==="string"?p:p.$Name||o.getObject("./$@sapui.name"),P=o.getObject("@");return Promise.resolve().then(function(v){var s="",g="",h="",j,k,u;if(m&&P){k=P.hasOwnProperty(I)&&I;if(k){j=P[k];u=c[k];s="{"+"parts: ["+"'"+m+"','"+j.$Path+"'"+"], type: '"+u.ui5Type+"'";h+=u.formatOptions;}else{s="{path: '"+m+"'";s+=",type: '"+F.getDataTypeClass(null,r.$Type)+"'";}g+=(g?d:"")+e.typeConstraints(r,P);s+=g?",constraints: {"+g+"}":"";h+=["Edm.Date","Edm.DateTimeOffset"].indexOf(r.$Type)>-1?(h?d:"")+"style : 'medium'":"";s+=h?",formatOptions: {"+h+"}":"";s+="}";}else{s=A.value(p,{context:o});}return s;});},_context:function(p,i){return i;},constraints:function(p,i){return e.value(p,i).then(function(v){var m=v.match(/constraints:.*?({.*?})/),s=m&&m[1];if(v.indexOf("sap.ui.model.odata.type.DateTimeOffset")>-1){if(s){s=s.substr(0,m[1].indexOf("}"))+", V4: true}";}else{s="{V4: true}";}}return s||undefined;});},formatOptions:function(p,i){return e.value(p,i).then(function(v){var m=v.match(/formatOptions:.*?({.*?})/);return(m&&m[1])||undefined;});},getFieldGroupIds:function(o,p,E){if(!p){return undefined;}var i=o.getInterface(0);return _(i).then(function(s){var m=i.getModel(),P=p,n=P.indexOf("/")>0?"/"+E+"/"+P.substr(0,P.lastIndexOf("/")+1)+"@sapui.name":false,g=!n?Promise.resolve(E):m.requestObject(n),h,j;P=n?P.substr(P.lastIndexOf("/")+1):P;return g.then(function(O){h=(s[O]&&s[O][0].concat(s[O][1][P]||[]))||[];if(h.length){j=h.reduce(function(r,k){return(r&&r+","+k)||k;});}return j;});});},fieldControl:function(p,i){var m=i&&i.context.getModel();var P=i&&i.context.getPath();var o=m&&m.createBindingContext(P+"@com.sap.vocabularies.Common.v1.FieldControl");var g=o&&o.getProperty();if(g){if(g.hasOwnProperty("$EnumMember")){return g.$EnumMember;}else if(g.hasOwnProperty("$Path")){return A.value(g,{context:o});}}else{return undefined;}},getNavigationEntity:function(p,o){var g=(o&&o.context)||p,P=A.getNavigationPath(g.getPath())+"/",E=g.getObject(P),h=Object.keys(E),l=h.length,i=0;for(;i<l;i++){if(E[h[i]].$kind==="NavigationProperty"&&E[h[i]].$ReferentialConstraint&&E[h[i]].$ReferentialConstraint.hasOwnProperty(g.getObject().$Path)){return o?A.getNavigationBinding(h[i]):P+h[i];}}},valueHelpProperty:function(p){var s=p.getPath(),o=p.getObject()||{},P=o.$Path?s+"/$Path":s,g=P+"@",h=p.getObject(g),i;if(h){i=(h.hasOwnProperty(I)&&I)||(h.hasOwnProperty(U)&&U);if(i){P=P+i+"/$Path";}}return P;},getSemanticKeyTitle:function(p,P,D){var n=R.getText("field.NEW_OBJECT");var u=R.getText("field.UNNAMED_OBJECT");var N,s;var g=function(v){N="($"+v+" === '' || $"+v+" === undefined || $"+v+" === null ? '"+n+"': $"+v+")";s="($"+v+" === '' || $"+v+" === undefined || $"+v+" === null ? '"+u+"': $"+v+")";return("{= !%{IsActiveEntity} ? !%{HasActiveEntity} ? "+N+" : "+s+" : "+s+"}");};if(p){return g(p);}else if(P){return g(P);}else{D="{"+D+"}";return g(D);}},getTooltip:function(t,v,E){var T;if(E.indexOf("Rating")!==-1){T=R.getText("table.RATING_INDICATOR_TOOLTIP",[t,v]);}else if(E.indexOf("Progress")!==-1){T=R.getText("table.PROGRESS_INDICATOR_TOOLTIP",[t,v]);}return T;},buildExpressionForProgressIndicatorPercentValue:function(v,t,u){var p="0";var E;v=v.charAt(0)==="{"?"$"+v:v;t=t&&t.charAt(0)==="{"?"$"+t:t;var s="(({0} > 100) ? 100 : (({0} < 0) ? 0 : ({0} * 1)))";var g="(({1} > 0) ? (({0} > {1}) ? 100 : (({0} < 0) ? 0 : ({0} / {1} * 100))) : 0)";if(u){u="'"+u+"'";E="'{'= ({2} === ''%'') ? "+s+" : "+g+" '}'";p=f(E,[v,t,u]);}else{E="'{'= "+g+" '}'";p=f(E,[v,t]);}return p;},buildExpressionForProgressIndicatorDisplayValue:function(v,t,u){var D="";if(v){if(u){if(u==="%"){D=v+" %";}else if(t){D=R.getText("progressindicator.PROGRESS_INDICATOR_DISPLAY_VALUE_NO_UOM",[v,t])+" "+u;}else{D=v+" "+u;}}else if(t){D=R.getText("progressindicator.PROGRESS_INDICATOR_DISPLAY_VALUE_NO_UOM",[v,t]);}else{D=v;}}else{L.warning("Value property is mandatory, the default (empty string) will be returned");}return D;},getFieldEditModeInValueHelp:function(v,p){var P=(v&&v.Parameters)||[],E="Editable",o;if(P.length){for(var i in P){o=P[i];if(o.ValueListProperty===p){if(o.$Type.indexOf("Out")>48){return"Editable";}else if(o.$Type.indexOf("In")>48){E="ReadOnly";}}}}return E;},joinArray:function(s){return s.join(",");},getSemanticObjectsList:function(p){var g=p;var s=[];for(var k in g.getObject()){if(k.indexOf("com.sap.vocabularies.Common.v1.SemanticObject")>-1&&k.indexOf("com.sap.vocabularies.Common.v1.SemanticObjectMapping")===-1&&k.indexOf("com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions")===-1){var h=g.getObject()[k];if(s.indexOf(h)===-1){s.push(h);}}}var S=new J(s);S.$$valueAsPromise=true;return S.createBindingContext("/");},getSemanticObjectsQualifiers:function(p){var g=p;var q=[];var h=function(l){return q.find(function(o){return o.qualifier===l;});};for(var k in g.getObject()){if(k.indexOf("com.sap.vocabularies.Common.v1.SemanticObject#")>-1||k.indexOf("com.sap.vocabularies.Common.v1.SemanticObjectMapping#")>-1||k.indexOf("com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions#")>-1){var i=g.getObject()[k],j=k.split("#")[0],l=k.split("#")[1],m=h(l);if(!m){m={qualifier:l};m[j]=i;q.push(m);}else{m[j]=i;}}}q=q.filter(function(o){return!!o["@com.sap.vocabularies.Common.v1.SemanticObject"];});var Q=new J(q);Q.$$valueAsPromise=true;return Q.createBindingContext("/");},getSemanticObjectsWithAnnotations:function(p){var g=p;var s=[];var h=function(q){return s.find(function(o){return o.qualifier===q;});};for(var k in g.getObject()){if(k.indexOf("com.sap.vocabularies.Common.v1.SemanticObject")>-1||k.indexOf("com.sap.vocabularies.Common.v1.SemanticObjectMapping")>-1||k.indexOf("com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions")>-1){if(k.indexOf("#")>-1){var i=g.getObject()[k],j=k.split("#")[0],q=k.split("#")[1],l=h(q);if(!l){l={qualifier:q};l[j]=i;s.push(l);}else{l[j]=i;}}else{var i=g.getObject()[k],j,q;if(k.indexOf("com.sap.vocabularies.Common.v1.SemanticObjectMapping")>-1){j="@com.sap.vocabularies.Common.v1.SemanticObjectMapping";}else if(k.indexOf("com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions")>-1){j="@com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions";}else if(k.indexOf("com.sap.vocabularies.Common.v1.SemanticObject")>-1){j="@com.sap.vocabularies.Common.v1.SemanticObject";}var l=h("main");if(!l){l={qualifier:"main"};l[j]=i;s.push(l);}else{l[j]=i;}}}}s=s.filter(function(Q){return!!Q["@com.sap.vocabularies.Common.v1.SemanticObject"];});var S=new J(s);S.$$valueAsPromise=true;return S.createBindingContext("/");},computeLinkParameters:function(g,h,s,i,j,k){var l=[],m=[];if(i){i.forEach(function(n){if(n["@com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions"]){var u={semanticObject:n["@com.sap.vocabularies.Common.v1.SemanticObject"],actions:n["@com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions"]};m.push(u);}if(n["@com.sap.vocabularies.Common.v1.SemanticObjectMapping"]){var o=[];n["@com.sap.vocabularies.Common.v1.SemanticObjectMapping"].forEach(function(r){o.push({key:r.LocalProperty.$PropertyPath,value:r.SemanticObjectProperty});});var q={semanticObject:n["@com.sap.vocabularies.Common.v1.SemanticObject"],items:o};l.push(q);}});}var p={name:g,payload:{semanticObjects:s,entityType:h,semanticObjectUnavailableActions:m,semanticObjectMappings:l,dataField:j,contact:k}};return JSON.stringify(p);},getmyvaluePlease:function(t){var v=t;return v;},operators:function(p,i){var o=i.context,m=o.getModel(),P=o.getPath(),E=C._getEntitySetPath(m,P);return a.getOperatorsForProperty(p,E,m);},isFilterRestrictedToOnlySingleOrMultiValue:function(p,i){var o=i.context,m=o.getModel(),P=o.getPath(),E=C._getEntitySetPath(m,P),g=m.getObject(E+"@Org.OData.Capabilities.V1.FilterRestrictions");if(g&&g.FilterExpressionRestrictions){var r=g.FilterExpressionRestrictions.filter(function(h){return h.Property.$PropertyPath===p;});return r.some(function(h){return h.AllowedExpressions==="SingleValue"||h.AllowedExpressions==="MultiValue";});}return false;}};e.getConditionsBinding.requiresIContext=true;e.buildExpressionForTextValue.requiresIContext=true;e.getRequiredForDataField.requiresIContext=true;e.getBindingForDraftAdminBlockInline.requiresIContext=true;e.getBindingForDraftAdminBlockInPopover.requiresIContext=true;e.value.requiresIContext=true;e.getFieldGroupIds.requiresIContext=true;e.fieldControl.requiresIContext=true;return e;},true);
