/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/link/Panel","sap/ui/mdc/link/PanelItem","sap/ui/mdc/LinkDelegate","sap/ui/mdc/link/LinkItem","sap/ui/mdc/link/Factory","sap/ui/mdc/link/Log","sap/base/Log","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/core/Fragment","sap/fe/macros/field/FieldHelper","sap/base/util/isPlainObject","sap/ui/mdc/link/SemanticObjectMapping","sap/ui/mdc/link/SemanticObjectMappingItem","sap/ui/mdc/link/SemanticObjectUnavailableAction","sap/fe/core/CommonUtils","sap/fe/navigation/NavigationHelper","sap/base/util/merge","sap/fe/navigation/SelectionVariant","sap/fe/core/CommonUtils"],function(P,a,L,b,F,c,S,X,d,e,f,i,g,h,j,C,N,m,k,l){"use strict";var o=Object.assign({},L);o._getEntityType=function(p,M){if(M){return M.createBindingContext(p.entityType);}};o._getDataField=function(p,M){return M.createBindingContext(p.dataField);};o._getContact=function(p,M){return M.createBindingContext(p.contact);};o.fnTemplateFragment=function(s){var n=d.loadTemplate(s,"fragment");var p={};if(this.payLoad.entityType&&this._getEntityType(this.payLoad,this.oMetaModel)){p.bindingContexts={"entityType":this._getEntityType(this.payLoad,this.oMetaModel)};p.models={"entityType":this.oMetaModel};}else if(this.payLoad.dataField&&this._getDataField(this.payLoad,this.oMetaModel)){p.bindingContexts={"dataField":this._getDataField(this.payLoad,this.oMetaModel)};p.models={"dataField":this.oMetaModel};}else if(this.payLoad.contact&&this._getContact(this.payLoad,this.oMetaModel)){p.bindingContexts={"contact":this._getContact(this.payLoad,this.oMetaModel)};p.models={"contact":this.oMetaModel};}return Promise.resolve(X.process(n,{name:s},p)).then(function(n){return e.load({definition:n});});};o.fetchAdditionalContent=function(p,B){this.payLoad=p;if(B){this.oMetaModel=B.getModel().getMetaModel();return this.fnTemplateFragment("sap.fe.macros.field.QuickViewLinkDelegate").then(function(n){return[n];});}return Promise.resolve([]);};o.fetchLinkItems=function(p,B,I){if(B&&o._getSemanticObjects(p)){var n=B.getObject();var q=[];if(I){I.initialize(o._getSemanticObjects(p));q.forEach(function(r){I.addIntent(c.IntentType.API,{text:r.getText(),intent:r.getHref()});});}var s=o._calculateSemanticAttributes(n,p,I);return o._retrieveNavigationTargets("",s,p,I).then(function(r,O){return r;});}else{return Promise.resolve([]);}};o.modifyLinkItems=function(p,B,n){if(n.length!==0){var q=n[0].getParent();var v=sap.ui.fl.Utils.getViewForControl(q);var A=C.getAppComponent(v);var r=q.getBindingContext();var s;if(v.getAggregation("content")[0]&&v.getAggregation("content")[0].getBindingContext()){var t=N.removeSensitiveData(v.getAggregation("content")[0].getBindingContext());var M=m({},t,r.getObject());s=N.mixAttributesAndSelectionVariant(M,new k());}else{var u=v.getController();var w=u.filterBarConditions;s=o._getMergedContext(r,w);}return new Promise(function(x){A.getService("navigation").then(function(y){var U=F.getService("URLParsing");if(!U){S.error("QuickViewLinkDelegate: Service 'URLParsing' could not be obtained");return Promise.reject();}var z=y.saveAppStateWithImmediateReturn(s);var D=y.getUrlParametersFromSelectionVariant(s);var E,G;n.forEach(function(q){E=U.parseShellHash(q.getHref());G={target:{semanticObject:E.semanticObject,action:E.action},params:E.params["sap-intent-param"]!==undefined?Object.assign({"sap-intent-param":E.params["sap-intent-param"]},D):D,appStateKey:z};G.params=Object.assign(G.params,E.params);delete G.params["sap-xapp-state"];q.setHref("#"+U.constructShellHash(G));});x(n);});});}else{return Promise.resolve(n);}};o._getMergedContext=function(n,p){var q,s;q=l.addExternalStateFiltersToSelectionVariant(new k(),p);s=N.mixAttributesAndSelectionVariant(n.getObject(),q.toJSONString());return N.removeSensitiveData(n,s);};o._calculateSemanticAttributes=function(n,p,I){var s=o._getSemanticObjects(p);var q=o._convertSemanticObjectMapping(o._getSemanticObjectMappings(p));if(!s.length){s.push("");}var r={};s.forEach(function(t){if(I){I.addContextObject(t,n);}r[t]={};for(var A in n){var u=null,T=null;if(I){u=I.getSemanticObjectAttribute(t,A);if(!u){u=I.createAttributeStructure();I.addSemanticObjectAttribute(t,A,u);}}if(n[A]===undefined||n[A]===null){if(u){u.transformations.push({value:undefined,description:"\u2139 Undefined and null values have been removed in SimpleLinkDelegate."});}continue;}if(i(n[A])){if(u){u.transformations.push({value:undefined,description:"\u2139 Plain objects has been removed in SimpleLinkDelegate."});}continue;}var v=q&&q[t]&&q[t][A]?q[t][A]:A;if(u&&A!==v){T={value:undefined,description:"\u2139 The attribute "+A+" has been renamed to "+v+" in SimpleLinkDelegate.",reason:"\ud83d\udd34 A com.sap.vocabularies.Common.v1.SemanticObjectMapping annotation is defined for semantic object "+t+" with source attribute "+A+" and target attribute "+v+". You can modify the annotation if the mapping result is not what you expected."};}if(r[t][v]){S.error("SimpleLinkDelegate: The attribute "+A+" can not be renamed to the attribute "+v+" due to a clash situation. This can lead to wrong navigation later on.");}r[t][v]=n[A];if(u){if(T){u.transformations.push(T);var w=I.createAttributeStructure();w.transformations.push({value:n[A],description:"\u2139 The attribute "+v+" with the value "+n[A]+" has been added due to a mapping rule regarding the attribute "+A+" in SimpleLinkDelegate."});I.addSemanticObjectAttribute(t,v,w);}}}});return r;};o._retrieveNavigationTargets=function(A,s,p,I){if(!p.semanticObjects){return new Promise(function(n){n([]);});}var q=p.semanticObjects;var r=p.sourceControl;var t={ownNavigation:undefined,availableActions:[]};return sap.ui.getCore().loadLibrary("sap.ui.fl",{async:true}).then(function(){return new Promise(function(u){sap.ui.require(["sap/ui/fl/Utils"],function(U){var v=F.getService("CrossApplicationNavigation");var w=F.getService("URLParsing");if(!v||!w){S.error("SimpleLinkDelegate: Service 'CrossApplicationNavigation' or 'URLParsing' could not be obtained");return u(t.availableActions,t.ownNavigation);}var x=sap.ui.getCore().byId(r);var y=U.getAppComponentForControl(x);var z=q.map(function(n){return[{semanticObject:n,params:s?s[n]:undefined,appStateKey:A,ui5Component:y,sortResultsBy:"text"}];});return new Promise(function(){v.getLinks(z).then(function(B){if(!B||!B.length){return u(t.availableActions,t.ownNavigation);}var D=o._getSemanticObjectUnavailableActions(p);var E=o._convertSemanticObjectUnavailableAction(D);var G=v.hrefForExternal();if(G&&G.indexOf("?")!==-1){G=G.split("?")[0];}if(G){G+="?";}var H=function(K,M){return(!!E&&!!E[K]&&E[K].indexOf(M)>-1);};var J=function(K){var M=w.parseShellHash(K.intent);if(H(M.semanticObject,M.action)){return;}var O=v.hrefForExternal({target:{shellHash:K.intent}},y);if(K.intent&&K.intent.indexOf(G)===0){t.ownNavigation=new b({href:O,text:K.text});return;}var Q=new b({key:M.semanticObject&&M.action?M.semanticObject+"-"+M.action:undefined,text:K.text,description:undefined,href:O,icon:undefined,isSuperior:K.tags&&K.tags.indexOf("superiorAction")>-1});t.availableActions.push(Q);if(I){I.addSemanticObjectIntent(M.semanticObject,{intent:Q.getHref(),text:Q.getText()});}};for(var n=0;n<q.length;n++){B[n][0].forEach(J);}return u(t.availableActions,t.ownNavigation);},function(){S.error("SimpleLinkDelegate: '_retrieveNavigationTargets' failed executing getLinks method");return u(t.availableActions,t.ownNavigation);});});});});});};o._getSemanticObjects=function(p){return p.semanticObjects?p.semanticObjects:[];};o._getSemanticObjectUnavailableActions=function(p){var s=[];if(p.semanticObjectUnavailableActions){p.semanticObjectUnavailableActions.forEach(function(n){s.push(new j({semanticObject:n.semanticObject,actions:n.actions}));});}return s;};o._getSemanticObjectMappings=function(p){var s=[];var n=[];if(p.semanticObjectMappings){p.semanticObjectMappings.forEach(function(q){n=[];if(q.items){q.items.forEach(function(r){n.push(new h({key:r.key,value:r.value}));});}s.push(new g({semanticObject:q.semanticObject,items:n}));});}return s;};o._convertSemanticObjectMapping=function(s){if(!s.length){return undefined;}var n={};s.forEach(function(p){if(!p.getSemanticObject()){throw Error("SimpleLinkDelegate: 'semanticObject' property with value '"+p.getSemanticObject()+"' is not valid");}n[p.getSemanticObject()]=p.getItems().reduce(function(M,I){M[I.getKey()]=I.getValue();return M;},{});});return n;};o._convertSemanticObjectUnavailableAction=function(s){if(!s.length){return undefined;}var n={};s.forEach(function(p){if(!p.getSemanticObject()){throw Error("SimpleLinkDelegate: 'semanticObject' property with value '"+p.getSemanticObject()+"' is not valid");}n[p.getSemanticObject()]=p.getActions();});return n;};return o;},true);
