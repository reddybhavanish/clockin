/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/fe/core/controllerextensions/Routing","sap/fe/core/controllerextensions/FlexibleColumnLayout","sap/fe/core/controllerextensions/EditFlow","sap/fe/macros/field/FieldRuntime","sap/fe/macros/CommonHelper","sap/fe/core/AnnotationHelper","sap/fe/core/actions/messageHandling","sap/base/Log","sap/base/util/ObjectPath","sap/fe/navigation/SelectionVariant","sap/m/MessageBox","sap/fe/core/CommonUtils","sap/fe/navigation/NavigationHelper","sap/fe/navigation/library","sap/fe/core/FEHelper","sap/fe/core/AppStateHandler","sap/ui/mdc/p13n/StateUtil","sap/fe/macros/table/Utils","sap/fe/macros/ResourceModel","sap/fe/core/controllerextensions/RoutingListener","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/fe/macros/chart/ChartRuntime","sap/fe/templates/controls/Share/ShareUtils"],function(C,J,R,F,E,a,b,A,m,L,O,S,M,c,N,d,e,f,g,T,h,j,k,l,n,o){"use strict";return C.extend("sap.fe.templates.ListReport.ListReportController",{routing:R,routingListener:j,editFlow:E,fcl:F,messageHandling:m,onInit:function(){var t=this;this.getView().setModel(this.editFlow.getTransactionHelper().getUIStateModel(),"ui");this.getView().setModel(this.editFlow.getUIStateModel({sessionOn:false,appliedFilters:""}),"localUI");this.filterBarConditions={};var i=this._getChartControl();if(i){i.oChartPromise.then(function(p){t._chartInfo={bChartSelectionsChanged:false,aChartFilters:[]};var q=p.getBinding("data");var r=t._getFilterBarControl();if(q){q.filter(r.getFilters());q.attachDataReceived(t.handlers.fnOnChartDataReceived.bind(t));}p.attachSelectData(t.handlers.fnOnChartSelectionChanged.bind(t));p.attachDeselectData(t.handlers.fnOnChartSelectionChanged.bind(t));});}Promise.all([this._getFilterBarControl().waitForInitialization(),this._getTableControl().done()]).then(function(){f.init();f.applyAppState(t);});},onExit:function(){delete this.filterBarConditions;delete this._oListReportControl;},onAfterBinding:function(B,p){if(this.routing.isUIStateDirty()){var t=this.getTableBinding();var i=this.getView().getModel("localUI");if(t){t.refresh();if(i){i.setProperty("/$contexts",{});}}this.routing.setUIStateProcessed();}},onAfterRendering:function(i){var t=this;this.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(r){t.oResourceBundle=r;});},onPageReady:function(p){var i=p.lastFocusedControl;var v=this.getView();if(i&&i.controlId&&i.focusInfo){var q=v.byId(i.controlId);if(q){q.applyFocusInfo(i.focusInfo);}}},getPageTitleInformation:function(){var t=this;return new Promise(function(r,i){var p={title:"",subtitle:"",intent:"",icon:""};p.title=t.getView().getContent()[0].data().ListReportTitle;p.subtitle=t.getView().getContent()[0].data().ListReportSubtitle;r(p);});},_getFilterBarControl:function(){return this.getView().byId(this._getFilterBarControlId());},_getFilterBarControlId:function(){return this.getView().getContent()[0].data("filterBarId");},_getChartControlId:function(){return this.getView().getContent()[0].data("reportChartId");},_getChartControl:function(){return this.getView().byId(this._getChartControlId());},_getInnerChartControl:function(){return this._getChartControl().getAggregation("_chart");},_getTableControlId:function(){return this.getView().getContent()[0].data("reportTableId");},_getTableControl:function(){if(!this._oListReportControl){this._oListReportControl=this.getView().byId(this._getTableControlId());}return this._oListReportControl;},getTableBinding:function(){var t=this._getTableControl(),B=t&&t._getRowBinding();return B;},_getMergedContext:function(i,p){var q,s;q=c.addExternalStateFiltersToSelectionVariant(new S(),p);i=Array.isArray(i)&&i.length===1?i[0]:i;if(Array.isArray(i)){var r=i.map(function(t){return t.getObject();});s=N.mixAttributesAndSelectionVariant(r,q.toJSONString());i=i[0];}else{s=N.mixAttributesAndSelectionVariant(i.getObject(),q.toJSONString());}return N.removeSensitiveData(i,s);},setShareModel:function(){var G=O.get("sap.ushell.Container.getUser");var s={bookmarkTitle:document.title,bookmarkCustomUrl:function(){var H=hasher.getHash();return H?"#"+H:window.location.href;},isShareInJamActive:!!G&&G().isJamActive()};var t=this.getOwnerComponent().getModel("_templPriv");t.setProperty("/listReport/share",s);},_getChartSelections:function(i){var s=[];switch(i.getSelectionBehavior()){case"DATAPOINT":s=i.getSelectedDataPoints().dataPoints;break;case"CATEGORY":s=i.getSelectedCategories().categories;break;case"SERIES":s=i.getSelectedSeries().series;break;}return s;},handlers:{onShareListReportActionButtonPress:function(i,p){var q=p.getView().byId("fe::Share");if(q&&(q.getVisible()||(q.getEnabled&&q.getEnabled()))){o.onShareActionButtonPressImpl(q,p,null);}},onFiltersChanged:function(i){var p=i.getSource(),q=this.getView().getModel("localUI");var r=this._getChartControl();var t=this;if(r){r.setBlocked(true);}q.setProperty("/appliedFilters",p.getAssignedFiltersText());Promise.all([p.waitForInitialization(),this._getTableControl().done()]).then(function(){f.createAppState(t);});},onVariantSelected:function(i){f.createAppState(this);},onVariantSaved:function(i){var t=this;setTimeout(function(){f.createAppState(t);},500);},onSearch:function(i){var t=this;var p=this._getTableControl();var P=this.getView().getBindingContext();T.handleQuickFilterCounts(p,P);var q=i.getSource();g.retrieveExternalState(q).then(function(r){t.filterBarConditions=r.filter;var s=t._getChartControl();if(s){s.setBlocked(false);var B=s.getBinding("data");if(B){t._chartInfo.bChartSelectionsChanged=false;B.filter(q.getFilters());}}});},onFieldValueChange:function(i){this.editFlow.syncTask(i.getParameter("promise"));a.handleChange(i);},onDataFieldForIntentBasedNavigation:function(i,s,p,q,v,r,I){var t;if(I==="true"&&(r==="false"||r==="undefined")){sap.m.MessageBox.show(h.getText("navigation.CONTEXT_MESSAGE"),{title:h.getText("navigation.ERROR_TITLE")});}else{if(v){t=i._getMergedContext(v,i.filterBarConditions);if(q!="undefined"){t=e.setSemanticObjectMappings(t,q);}}c.navigateToExternalApp(i.getView(),t,s,p);}},onChevronPressNavigateOutBound:function(i,s,p){var q=i.routing.getOutbounds(),r,D=q[s];if(D){if(p){r=i._getMergedContext(p,i.filterBarConditions);}c.navigateToExternalApp(i.getView(),r,D.semanticObject,D.action,b.showNavigateErrorMessage);return Promise.resolve();}else{throw new Error("outbound target "+s+" not found in cross navigation definition of manifest");}},fnOnChartDataReceived:function(i){var t=this._getTableControl(),p=this._getInnerChartControl(),q=this._chartInfo.aChartFilters,r=this._chartInfo.bChartSelectionsChanged,s=this._getChartSelections(p).length>0,B=p.getBinding("data");if(B&&r&&!s){this._chartInfo.bChartSelectionsChanged=false;B.filter(q);if(t){t.rebindTable();t.getRowsBindingInfo().binding.filter(new k(q,true));}}},fnOnChartSelectionChanged:function(p){var q=p.getSource(),t=this._getTableControl(),r=this._getFilterBarControl(),v=q.getVisibleDimensions(),s,u=[],w=[],x=r.getFilters(),V=q._getVizFrame().vizSelection()||[];if(p.getParameter("data")){n.fnUpdateChart(p,q);this._chartInfo.bChartSelectionsChanged=true;}if(V.length>0){s=this._getChartSelections(q);for(var i in v){w=[];var P=v[i];for(var y in s){var z=s[y];var B=z.context;w.push(new k({path:P,operator:l.EQ,value1:B.getProperty(P)}));}if(w.length>0){u.push(new k(w,false));}}}if(x){u.push(new k(x,false));}if(t){this._chartInfo.aChartFilters=u;t.rebindTable();if(V.length>0){t.getRowsBindingInfo().binding.filter(new k(u,true));}}}}});});
