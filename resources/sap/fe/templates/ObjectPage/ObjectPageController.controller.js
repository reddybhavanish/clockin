/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/fe/core/controllerextensions/Routing","sap/fe/core/controllerextensions/RoutingListener","sap/fe/core/controllerextensions/FlexibleColumnLayout","sap/fe/core/controllerextensions/EditFlow","sap/ui/model/odata/v4/ODataListBinding","sap/fe/macros/field/FieldRuntime","sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/navigation/SelectionVariant","sap/fe/macros/CommonHelper","sap/fe/macros/table/Utils","sap/m/MessageBox","sap/fe/core/BusyLocker","sap/fe/navigation/NavigationHelper","sap/fe/core/actions/messageHandling","sap/fe/core/FEHelper","sap/ui/core/routing/HashChanger","sap/fe/macros/ResourceModel","sap/m/Link","sap/fe/macros/chart/ChartRuntime","sap/fe/core/AppStateHandler","sap/fe/templates/controls/Share/ShareUtils"],function(C,J,R,a,F,E,O,b,L,m,c,S,d,T,M,B,N,e,f,H,g,h,k,A,l){"use strict";var n;return C.extend("sap.fe.templates.ObjectPage.ObjectPageController",{routing:R,fcl:F,editFlow:E,routingListener:a,createExtensionAPI:function(){return{};},onInit:function(){var t=this,o=this.byId("fe::ObjectPage");this.getView().setModel(this.editFlow.getTransactionHelper().getUIStateModel(),"ui");this.getView().setModel(this.editFlow.getUIStateModel({sessionOn:false,batchGroups:t._getBatchGroupsForView()}),"localUI");var r=new J({visibility:false,items:null});this.getView().setModel(r,"relatedAppsModel");if(o.getEnableLazyLoading()){o.attachEvent("subSectionEnteredViewPort",this._handleSubSectionEnteredViewPort.bind(this));}},onExit:function(){this.getView().getModel("relatedAppsModel").destroy();},getTableBinding:function(t){return t&&t._getRowBinding();},onAfterRendering:function(o){c.updateDataFiledForIBNButtonsVisibility(this.getView().getModel("localUI"));var t=this;this.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(r){t.oResourceBundle=r;});},onBeforeBinding:function(o,p){var t=this,q=this._findTables(),r=this._findCharts(),s,u=this.byId("fe::ObjectPage"),v=p.listBinding,w=t.getView().getModel("localUI"),x=w.getProperty("/batchGroups");x.push("$auto");if(u.getBindingContext()&&u.getBindingContext().hasPendingChanges()&&!x.some(u.getBindingContext().getModel().hasPendingChanges.bind(u.getBindingContext().getModel()))){u.getBindingContext().getBinding().resetChanges();}for(var i=0;i<q.length;i++){s=q[i].getCreationRow();if(s){s.setBindingContext(null);}}var y=[];for(var j=0;j<r.length;j++){y.push(r[j].oChartPromise);}Promise.all(y).then(function(X){for(var j=0;j<r.length;j++){X[j].attachSelectData(k.fnUpdateChart.bind(k));X[j].attachDeselectData(k.fnUpdateChart.bind(k));}});var z=function(X){if(!p.bPersistOPScroll){u.setSelectedSection(null);u.detachModelContextChange(z);}};u.attachModelContextChange(z);if(v&&v.isA("sap.ui.model.odata.v4.ODataListBinding")){var P=t.byId("fe::Paginator");if(P){P.setListBinding(v);}}if(!p.editable){if(w.getProperty("/sessionOn")===true){w.setProperty("/sessionOn",false);}}if(u.getEnableLazyLoading()){var D=u.getSections(),U=u.getUseIconTabBar(),G=2;for(var I=0;I<D.length;I++){var K=D[I];var Q=K.getSubSections();for(var V=0;V<Q.length;V++,G--){if(G<1||(U&&I>0)){var W=Q[V];W.setBindingContext(null);}}}}},_handleSubSectionEnteredViewPort:function(o){var s=o.getParameter("subSection");s.setBindingContext(undefined);},onAfterBinding:function(o,p){var i=this.byId("fe::ObjectPage"),t=this,j=o.getModel(),q=this._findTables(),r;o=i.getBindingContext();r=this.editFlow.computeEditMode(o);if(o.getBinding().oCache){t._updateRelatedApps();}else{var u=function(){t._updateRelatedApps();o.getBinding().detachDataReceived(u);};o.getBinding().attachDataReceived(u);}function s(z,D){var G=z.getCreationRow(),I,K;if(G){r.then(function(){if(G.getVisible()){I=j.bindList(D.getPath(),D.getContext(),[],[],{$$updateGroupId:"doNotSubmit",$$groupId:"doNotSubmit"});I.refreshInternal=function(){};K=I.create();G.setBindingContext(K);K.created().catch(function(){L.trace("transient fast creation context deleted");});}});}}function v(z){var y=t.getTableBinding(z),D=function(){s(z,y);};if(y.oContext){D();}else{var G=function(){if(y.oContext){D();y.detachChange(G);}};y.attachChange(G);}}var w=this.editFlow.getTransactionHelper(),x=w.getUIStateModel();x.setProperty("/draftStatus","Clear");var y=(o.getBinding&&o.getBinding())||o;y.attachEvent("patchSent",this.editFlow.handlePatchSent,this);y.attachEvent("patchCompleted",this.editFlow.handlePatchCompleted,this);q.forEach(function(z){z.done().then(v);if(z.data("quickFilterKey")){T.handleQuickFilterCounts(z,o);}});i._triggerVisibleSubSectionsEvents();A.applyAppState(this);},onPageReady:function(p){var t=this;var i=this._findTables();var o=this.getView().getModel("localUI");i.forEach(function(y){if(y.data("creationMode")&&y.data("creationMode")==="CreationRow"&&y.getCreationRow().getApplyEnabled()===false){y.getCreationRow().setApplyEnabled(false);}var z=t.getView().getLocalId(y.getId());var D=(y&&y.getSelectedContexts())||[];if(D.length>0){y.clearSelection();if(o){o.setProperty("/$contexts/"+z,{});}}});var j=p.lastFocusedControl;if(j&&j.controlId&&j.focusInfo){var v=this.getView();var q=v.byId(j.controlId);if(q){q.applyFocusInfo(j.focusInfo);return;}}var r=this.byId("fe::ObjectPage");var s=r.getModel("ui").getProperty("/editMode")==="Display";var u;if(s){var w=r.getHeaderTitle().getActions();if(w.length){u=w.find(function(y){return y.mProperties["visible"];});if(u){u.focus();}}}else{var x=r._getFirstEditableInput();if(x){x.focus();}}},getPageTitleInformation:function(){var o=this.byId("fe::ObjectPage");var t={title:o.data("ObjectPageTitle")||"",subtitle:"",intent:"",icon:""};var i=o.getCustomData().find(function(j){return j.getKey()==="ObjectPageSubtitle";});if(i&&i.getBinding("value")!==undefined){if(i.getBinding("value").isA("sap.ui.model.odata.v4.ODataPropertyBinding")){return i.getBinding("value").requestValue().then(function(v){t.subtitle=v;return t;});}else if(i.getBinding("value").isA("sap.ui.model.resource.ResourcePropertyBinding")){t.subtitle=i.getBinding("value").getValue();return Promise.resolve(t);}}else{return Promise.resolve(t);}},executeHeaderShortcut:function(i){var s=this.getView().getId()+"--"+i,o=this.byId("fe::ObjectPage").getHeaderTitle().getActions().find(function(j){return j.getId()===s;});c.fireButtonPress(o);},executeFooterShortcut:function(i){var s=this.getView().getId()+"--"+i,o=this.byId("fe::ObjectPage").getFooter().getContent().find(function(j){return j.getMetadata().getName()==="sap.m.Button"&&j.getId()===s;});c.fireButtonPress(o);},executeTabShortCut:function(o){var i=this.byId("fe::ObjectPage"),s=i.indexOfSection(this.byId(i.getSelectedSection())),j=i.getSections(),p=j.length-1,q=o.oSource.getCommand(),r;if(s!==-1&&p>0){if(q==="NextTab"){if(s<=p-1){r=j[++s];}}else{if(s!==0){r=j[--s];}}if(r){i.setSelectedSection(r);r.focus();}}},getFooterVisiblity:function(o){n=o.getParameter("iMessageLength");var i=this.getView().getModel("localUI");n>0?i.setProperty("/showMessageFooter",true):i.setProperty("/showMessageFooter",false);},showMessagePopover:function(o){var i=o.oMessagePopover,I=i.getBinding("items");if(I.getLength()>0){i.openBy(o);}},editDocument:function(){var o=this.getView().getModel("ui");B.lock(o);return this.editFlow.editDocument.apply(this.editFlow,arguments).finally(function(){B.unlock(o);});},saveDocument:function(o){var t=this,i=this.getView().getModel("ui"),w=[];B.lock(i);this._findTables().forEach(function(j){var p=t.getTableBinding(j);var P={creationMode:j.data("creationMode"),creationRow:j.getCreationRow(),createAtEnd:j.data("createAtEnd")==="true"};var q=P.creationRow&&P.creationRow.getBindingContext()&&Object.keys(P.creationRow.getBindingContext().getObject()).length>1;if(q){w.push(t.editFlow.createDocument(p,P));}});return Promise.all(w).then(function(){return t.editFlow.saveDocument(o).then(function(){var j=t.getView().byId("fe::FooterBar::MessageButton");var D={onAfterRendering:function(p){t.showMessagePopover(j);j.removeEventDelegate(t._oDelegateOnAfter);delete t._oDelegateOnAfter;}};t._oDelegateOnAfter=D;j.addEventDelegate(D,t);}).catch(function(j){var p=t.getView().byId("fe::FooterBar::MessageButton");if(p){t.showMessagePopover(p);}}).finally(function(){B.unlock(i);});});},_updateRelatedApps:function(){var o=this.byId("fe::ObjectPage");if(c.resolveStringtoBoolean(o.data("showRelatedApps"))){c.updateRelatedAppsDetails(o);}},_findTables:function(){var o=this.byId("fe::ObjectPage"),t=[];function i(P,r){for(var u=0;u<P.length;u++){var v=P[u].getContent instanceof Function&&P[u].getContent(),V=v.getMetadata instanceof Function&&v.getMetadata().getName()==="sap.fe.templates.controls.ViewSwitchContainer"&&v.getItems().length&&v.getItems()[0],w=V&&V.getContent();if(w&&w.isA("sap.ui.mdc.Table")){t.push(w);if(w.getType().isA("sap.ui.mdc.table.GridTableType")&&!r.hasStyleClass("sapUxAPObjectPageSubSectionFitContainer")){r.addStyleClass("sapUxAPObjectPageSubSectionFitContainer");}}}}var s=o.getSections();for(var j=0;j<s.length;j++){var p=s[j].getSubSections();for(var q=0;q<p.length;q++){i(p[q].getBlocks(),p[q]);i(p[q].getMoreBlocks(),p[q]);}}return t;},_findCharts:function(){var o=this.byId("fe::ObjectPage"),i=[];function j(P,t){for(var u=0;u<P.length;u++){var v=P[u].getAggregation("items")&&P[u].getAggregation("items")[0],w=v&&v.getAggregation("content");if(w&&w.isA("sap.ui.mdc.Chart")){i.push(w);}}}var s=o.getSections();for(var p=0;p<s.length;p++){var q=s[p].getSubSections();for(var r=0;r<q.length;r++){j(q[r].getBlocks(),q[r]);j(q[r].getMoreBlocks(),q[r]);}}return i;},_mergePageAndLineContext:function(p,o){var i,s;o=Array.isArray(o)&&o.length===1?o[0]:o;if(o&&Array.isArray(o)){var j=N.mixAttributesAndSelectionVariant(p,new S());var q=o.map(function(r){return r.getObject();});s=N.mixAttributesAndSelectionVariant(q,j.toJSONString());o=o[0];}else{i=m({},p,o&&o.getObject());s=N.mixAttributesAndSelectionVariant(i,new S());}return o?N.removeSensitiveData(o,s):s;},_getBatchGroupsForView:function(){var t=this,v=t.getView().getViewData(),o=v.controlConfiguration,i=o&&Object.keys(o),j=["$auto.Heroes","$auto.Decoration","$auto.Workers"];if(i&&i.length>0){i.forEach(function(K){var p=o[K];if(p.requestGroupId==="LongRunners"){j.push("$auto.LongRunners");}});}return j;},setBreadcrumbLinks:function(s){var o=s.getBindingContext();var j=c.getAppComponent(this.getView());if(o){var p=o.getPath(),P=p.split("/"),q="";P.shift();P.splice(-1,1);P.forEach(function(r,i){q+="/"+r;var t=j.getRootViewController();var u=t.getTitleHierarchyCache();var v;if(!u[q]){v=t.addNewEntryInCacheTitle(q,j);}else{v=Promise.resolve(u[q]);}v.then(function(w){var x=s.getLinks()[i]?s.getLinks()[i]:new h();var y=r.replace(/ *\([^)]*\) */g,"");x.setText(w.subtitle||y);x.setHref(w.intent);if(!s.getLinks()[i]){s.addLink(x);}});});}},handlers:{onFieldValueChange:function(o){this.editFlow.syncTask(o.getParameter("promise"));b.handleChange(o);},onShareObjectPageActionButtonPress:function(o,i){var j=i.getView().byId("fe::Share");i.getPageTitleInformation().then(function(p){if(j&&(j.getVisible()||(j.getEnabled&&j.getEnabled()))){l.onShareActionButtonPressImpl(j,i,p);}});},onRelatedAppsItemPressed:function(o,j){var p=o.getSource(),q=j&&j.getView()&&j.getView().getBindingContext();j.editFlow.getProgrammingModel(q).then(function(r){var s=p.getCustomData(),t,u;for(var i=0;i<s.length;i++){var v=s[i].getKey();var w=s[i].getValue();if(v=="targetSemObject"){t=w;}else if(v=="targetAction"){u=w;}}var x={semanticObject:t,action:u};var P=N.removeSensitiveData(j.getView().getAggregation("content")[0].getBindingContext());var y=N.mixAttributesAndSelectionVariant(P,new S());c.navigateToExternalApp(j.getView(),y,x.semanticObject,x.action,null,c.isStickyEditMode(p,r));});},onCallActionFromFooter:function(v,s,p){var o=v.getController();var t=o;return o.editFlow.onCallAction(s,p).then(function(){var i=t.getView().byId("fe::FooterBar::MessageButton");if(i.isActive()){t.showMessagePopover(i);}else if(n){t._oDelegateOnAfter={onAfterRendering:function(j){t.showMessagePopover(i);i.removeEventDelegate(t._oDelegateOnAfter);delete t._oDelegateOnAfter;}};i.addEventDelegate(t._oDelegateOnAfter,t);}}).catch(function(i){var j=t.getView().byId("fe::FooterBar::MessageButton");if(j){t.showMessagePopover(j);}});},onDataFieldForIntentBasedNavigation:function(o,s,i,j,p,r,I){var q=o&&o.getView(),t=q&&q.getBindingContext();if(I==="true"&&(r==="false"||r==="undefined")){M.show(g.getText("navigation.CONTEXT_MESSAGE"),{title:g.getText("navigation.ERROR_TITLE")});}else{o.editFlow.getProgrammingModel(t).then(function(u){var v;var P={};if(r||p){if(o.getView().getAggregation("content")[0].getBindingContext()){P=N.removeSensitiveData(o.getView().getAggregation("content")[0].getBindingContext());}v=o._mergePageAndLineContext(P,p);if(j!="undefined"){v=f.setSemanticObjectMappings(v,j);}}c.navigateToExternalApp(o.getView(),v,s,i,null,c.isStickyEditMode(q,u));});}},onChevronPressNavigateOutBound:function(o,s,i){var j=o&&o.getView(),p=j&&j.getBindingContext();return o.editFlow.getProgrammingModel(p).then(function(q){var r=o.routing.getOutbounds(),t,D=r[s],P=N.removeSensitiveData(o.getView().getAggregation("content")[0].getBindingContext());if(D){if(i){t=o._mergePageAndLineContext(P,i);}c.navigateToExternalApp(o.getView(),t,D.semanticObject,D.action,d.showNavigateErrorMessage,c.isStickyEditMode(j,q));return Promise.resolve();}else{throw new Error("outbound target "+s+" not found in cross navigation definition of manifest");}});},onNavigateChange:function(o){A.createAppState(this,o);this.bSectionNavigated=true;},onVariantSelected:function(o){A.createAppState(this,o);},onVariantSaved:function(o){var t=this;var i=m({},o);setTimeout(function(){A.createAppState(t,i);},500);}}});});
