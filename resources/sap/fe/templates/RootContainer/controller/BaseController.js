sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/core/mvc/Controller","sap/ui/core/Component","sap/ui/core/routing/HashChanger","sap/fe/core/CommonUtils","sap/base/Log"],function(J,C,a,H,b,L){"use strict";return C.extend("sap.fe.templates.RootContainer.controller.BaseController",{onInit:function(){this.shellTitleHandler();},waitForRightMostViewReady:function(e){return new Promise(function(r,c){var d=e.getParameter("views");var v=d[d.length-1].getComponentInstance();var V=v.getRootControl();if(v.isPageReady()){r(V);}else{v.attachEventOnce("pageReady",function(){r(V);});}});},shellTitleHandler:function(){var t=this;var r=this.getView();var A=b.getAppComponent(r);var R=A.getRouter();var f=function(e){t.waitForRightMostViewReady(e).then(function(v){var A=b.getAppComponent(v);var o=A.getRouterProxy();var d={oView:v,oAppComponent:A};t.computeTitleHierarchy(d);var h=o._oManagedHistory;var c=window.location.hash;var l;for(var i=h.length-1;i>-1;i--){var s="#"+h[i].hash;if(c===s||s===c+"&/"){l=h[i].oLastFocusControl;break;}else{h[i].oLastFocusControl=undefined;}}if(v.getController().onPageReady){v.getParent().onPageReady({lastFocusedControl:l});}}).catch(function(){L.error("An error occurs while computing the title hierarchy and calling focus method");});};R.attachRouteMatched(f);},getTitleHierarchyCache:function(){if(!this.oTitleHierarchyCache){this.oTitleHierarchyCache={};}return this.oTitleHierarchyCache;},_computeTitleInfo:function(t,s,i){return{title:t,subtitle:s,intent:i,icon:""};},addNewEntryInCacheTitle:function(p,A){var t=this.getView().getModel("title");if(!t){var s=A.getMetadata().getManifestEntry("/sap.app/dataSources/mainService/uri");t=new sap.ui.model.odata.v4.ODataModel({serviceUrl:s,synchronizationMode:"None"});}var c=this;var e=p.replace(/ *\([^)]*\) */g,"");var T=A.getMetaModel().getProperty(e+"/@com.sap.vocabularies.UI.v1.HeaderInfo/Title/Value");var d=A.getMetaModel().getProperty(e+"/@com.sap.vocabularies.UI.v1.HeaderInfo/TypeName");var B=t.createBindingContext(p);var P=t.bindProperty(T["$Path"],B);A.getRootControl().setModel(t,"title");P.initialize();return new Promise(function(r,f){var g=H.getInstance().hrefForAppSpecificHash("");var i=g+p.slice(1);var h=function(E){var o=c.getTitleHierarchyCache();o[p]=c._computeTitleInfo(d,E.getSource().getValue(),i);r(o[p]);P.detachChange(h);};P.attachChange(h);});},computeTitleHierarchy:function(d){var t=this,v=d.oView,A=d.oAppComponent,c=v.getBindingContext(),o=v.getParent(),T=[],s=H.getInstance().hrefForAppSpecificHash(""),e=A.getMetadata().getManifestEntry("sap.app").title||"",f=A.getMetadata().getManifestEntry("sap.app").appSubTitle||"",g=s,p,n;if(this.bIsComputingTitleHierachy===true){L.warning("computeTitleHierarchy already running ... this call is canceled");return;}this.bIsComputingTitleHierachy=true;if(o&&o.getPageTitleInformation){if(c){n=c.getPath();var P=n.split("/"),h,l="",N=P.length;P.splice(-1,1);P.forEach(function(m,i){if(i===0){var r=A.getManifestEntry("/sap.ui5/routing/routes"),q=A.getManifestEntry("/sap.ui5/routing/targets");var u=function(w){if(typeof r[this.index].target==="string"){return w===r[this.index].target;}else if(typeof r[this.index].target==="object"){for(var k=0;k<r[this.index].target.length;k++){return w===r[this.index].target[k];}}};for(var j=0;j<r.length;j++){var R=A.getRouter().getRoute(r[j].name);if(R.match(P[i])){var w=Object.keys(q).find(u,{index:j});h=A.getRouter().getTarget(w)._oOptions.name;break;}}if(h==="sap.fe.templates.ListReport"){T.push(Promise.resolve(t._computeTitleInfo(e,f,g)));}}else if(i<N){l+="/"+m;if(!t.getTitleHierarchyCache()[l]){T.push(t.addNewEntryInCacheTitle(l,A));}else{T.push(Promise.resolve(t.getTitleHierarchyCache()[l]));}}});}p=o.getPageTitleInformation().then(function(i){i.intent=s+H.getInstance().getHash();if(c){t.getTitleHierarchyCache()[n]=i;}else{t.getTitleHierarchyCache()[g]=i;}return i;});T.push(p);}else{T.push(Promise.reject("Title information missing in HeaderInfo"));}Promise.all(T).then(function(i){A.getService("ShellUIService").then(function(S){var j=i[i.length-1].title;S.setHierarchy(i.reverse());S.setTitle(j);},function(E){L.warning("No ShellService available");});}).catch(function(E){L.error(E);}).finally(function(){t.bIsComputingTitleHierachy=false;});}});});
