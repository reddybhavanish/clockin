/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./library','sap/ui/core/Control','./FileViewerModuleLoader','sap/ui/model/resource/ResourceModel'],function(q,l,C,F,R){"use strict";var a=C.extend("sap.fileviewer.FileViewer",{PDFJS:F.PDFJS,DEFAULT_SCALE_DELTA:1.1,MIN_SCALE:0.25,MAX_SCALE:10.0,DEFAULT_SCALE_VALUE:'auto',metadata:{library:"sap.fileviewer",properties:{height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},source:{type:"sap.ui.core.URI"},data:{type:"string"}},aggregations:{"_layoutContainer":{type:"sap.m.FlexBox",multiple:false,visibility:"hidden"},"_toolbar":{type:"sap.m.OverflowToolbar",multiple:false,visibility:"hidden"},"_errorMessage":{type:"sap.m.Label",multiple:false,visibility:"hidden"}}},init:function(){var t=this;var i=new R({bundleName:"sap.fileviewer.resources.messagebundle"});t.setModel(i,"i18n");t._pdfLoadingTask=null;t._pdfDocument=null;t._pdfViewer=null;t._pdfHistory=null;t._pdfLinkService=null;t.addStyleClass("sapFileViewer-outermostContainer");t._previousPageButton=new sap.m.Button({text:"Previous Page",press:function(){var p=t._getPageNumber()-1;if(p>=1){t._setPageNumber(p);}},enabled:false});t._nextPageButton=new sap.m.Button({text:"Next Page",press:function(){var n=t._getPageNumber()+1;if(n<=t._getPagesCount()){t._setPageNumber(n);}},enabled:false});var b=[t._previousPageButton,t._nextPageButton];t.setAggregation("_toolbar",new sap.m.OverflowToolbar({content:b}));var e=i.getResourceBundle().getText("PDF_VIEWER_PLACEHOLDER_ERROR_TEXT");t.setAggregation("_errorMessage",new sap.m.Label({textAlign:"Center",text:e}).addStyleClass("sapFileViewer-pdfViewerErrorMessage"));},exit:function(){this._close();},renderer:function(r,c){c._renderer(r);},_renderer:function(r){var w=this.getWidth();if(w&&w!="100%"){r.addStyle("width",w);}var h=this.getHeight();if(h&&h!="100%"){r.addStyle("height",h);}r.write("<div");r.writeControlData(this);r.writeClasses();r.writeStyles();r.write(">");r.write('<div class="sapFileViewer-pdfViewerErrorContainer">');r.renderControl(this.getAggregation("_errorMessage"));r.write('</div>');r.write('<div class="sapFileViewer-pdfViewerContainer"><div class="sapFileViewer-pdfViewer"><div id="viewer" class="pdfViewer"></div></div></div>');r.write("</div>");},_setTitleUsingUrl:function pdfViewSetTitleUsingUrl(u){this.url=u;var t=this.PDFJS.getFilenameFromUrl(u)||u;try{t=decodeURIComponent(t);}catch(e){}this._setTitle(t);},_setTitleUsingMetadata:function(p){var t=this;p.getMetadata().then(function(d){var i=d.info,m=d.metadata;t.documentInfo=i;t.metadata=m;var b;if(m&&m.has('dc:title')){var c=m.get('dc:title');if(c!=='Untitled'){b=c;}}if(!b&&i&&i['Title']){b=i['Title'];}if(b){t._setTitle(b+' - '+document.title);}});},_setTitle:function pdfViewSetTitle(t){},_open:function(p){var t=this;q(t.getDomRef()).find(".sapFileViewer-pdfViewerErrorContainer").css("display","none");if(this._pdfLoadingTask){return this._close().then(function(){return this._open(p);}.bind(this));}var u=p.url;if(u){this._setTitleUsingUrl(u);}else if(p.data){u={data:p.data};}var b=t.PDFJS.getDocument(u);this._pdfLoadingTask=b;b.onProgress=function(c){};return b.promise.then(function(c){t._pdfDocument=c;t._pdfViewer.setDocument(c);t._pdfLinkService.setDocument(c);t._pdfHistory.initialize(c.fingerprint);t._setTitleUsingMetadata(c);},function(e){q(t.getDomRef()).find(".sapFileViewer-pdfViewerErrorContainer").css("display","block");});},_close:function(){if(!this._pdfLoadingTask){return Promise.resolve();}var p=this._pdfLoadingTask.destroy();this._pdfLoadingTask=null;if(this.pdfDocument){this._pdfDocument=null;this._pdfViewer.setDocument(null);this._pdfLinkService.setDocument(null,null);}q(this.getDomRef()).find(".sapFileViewer-pdfViewerErrorContainer").css("display","none");return p;},_getPagesCount:function(){return this._pdfDocument&&this.pdfDocument.numPages||0;},_setPageNumber:function(p){if(this._pdfViewer){this._pdfViewer.currentPageNumber=p;}},_getPageNumber:function(){return this._pdfViewer&&this._pdfViewer.currentPageNumber||0;},_initUI:function pdfViewInitUI(){var t=this;var b=new t.PDFJS.PDFLinkService();this._pdfLinkService=b;this._l10n=t.PDFJS.NullL10n;var c=q(this.getDomRef()).find(".sapFileViewer-pdfViewer").get(0);var p=new t.PDFJS.PDFViewer({container:c,linkService:b,l10n:this._l10n});this._pdfViewer=p;b.setViewer(p);this._pdfHistory=new t.PDFJS.PDFHistory({linkService:b});b.setHistory(this._pdfHistory);},onAfterRendering:function(){var t=this;t._initUI();var p;var s=this.getSource();if(s){p={url:s};}else{var d=this.getData();if(d){p={data:d};}}if(p){t._open(p);}}});return a;});
