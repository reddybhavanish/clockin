(function(){'use strict';var e;var P;if(typeof module==='undefined'){window.sap=window.sap||{};window.sap.es=window.sap.es||{};window.sap.es.pdf2text=window.sap.es.pdf2text||{};e=window.sap.es.pdf2text;P=window.Promise;}else{P=require('bluebird');var f=P.promisifyAll(require('fs'));var a=require('sap-pdfjs');e=module.exports;}var T=function(){this.init.apply(this,arguments);};T.prototype={init:function(){this.parts=[];},write:function(d){this.parts.push(d);},saveToFile:function(c){var t=f.createWriteStream(c);t.write(this.parts.join(''));return t.endAsync();},getData:function(){return this.parts.join('');}};var D=function(){this.init.apply(this,arguments);};D.prototype={init:function(){this.pages=[];},newPage:function(){var p={};this.pages.push(p);return p;},save:function(){}};var b=function(){this.init.apply(this,arguments);};b.prototype={init:function(o){if(!o.conversionOptions){o.conversionOptions=e.getDefaultConversionOptions();}if(!o.pdfDocument){throw'missing pdf document for TextConverter';}this.conversionOptions=o.conversionOptions;this.pdfDocument=o.pdfDocument;this.highlightIndex=0;this.highlights=[];this.totalLength=0;this.textStream={write:function(){}};this.documentStatistic=new D();},convertToText:function(t){var c=this;this.textStream=t;return this.writePage(1).then(function(){});},convertHighlights:function(h,t){var c=this;this.highlights=h;this.highlightIndex=0;if(t){this.textStream=t;}return this.writePage(1).then(function(){return c.highlights;});},writePage:function(p){var t=this;var c=this.documentStatistic.newPage();c.startIndex=this.totalLength;if(p>this.pdfDocument.numPages){return true;}return this.pdfDocument.getPage(p).then(function(c){this.viewPort=c.getViewport(1);var o={normalizeWhitespace:true};return c.getTextContent(o);}.bind(this)).then(function(d){t.processTextContent(p,d);return t.writePage(p+1);});},calculateArtificalWhitespace:function(p,i){if(!p||p.str.length===0||!i||i.str.length===0){return null;}switch(this.conversionOptions.artificalWhitespace){case'hard':return this.calculateHardWhitespace(p,i);case'smart':return this.calculateSmartWhitespace(p,i);default:return null;}},calculateHardWhitespace:function(p,i){if(this.isWhitespace(p.str[p.length-1])||this.isWhitespace(i.str[0])){return null;}return' ';},utilTransform:function(m,c){return[m[0]*c[0]+m[2]*c[1],m[1]*c[0]+m[3]*c[1],m[0]*c[2]+m[2]*c[3],m[1]*c[2]+m[3]*c[3],m[0]*c[4]+m[2]*c[5]+m[4],m[1]*c[4]+m[3]*c[5]+m[5]];},calcXY:function(i){var t=this.utilTransform(this.viewPort.transform,i.transform);var s=Math.sqrt(t[0]*t[0]+t[1]*t[1]);return{x:t[4],y:t[5],angle:Math.atan2(t[1],t[0])*180/Math.PI,ex:t[0]/s,ey:t[1]/s};},calculateSmartWhitespace:function(p,i){var c=this.calcXY(i);var d=this.calcXY(p);if(Math.abs(c.angle-d.angle)>5){if(this.isWhitespace(p.str[p.str.length-1])||this.isWhitespace(i.str[0])){return null;}return'\n';}var g=i.width/i.str.length;var h=p.width/p.str.length;var j=Math.min(g,h);var s=j*this.conversionOptions.spaceWidth;var k=i.height;if(Math.abs((d.x-c.x)*(c.ey)+(d.y-c.y)*(-c.ex))>=k){if(this.isNewLine(p.str[p.str.length-1])||this.isNewLine(i.str[0])){return null;}return'\n';}if((c.x-d.x)*c.ex+(c.y-d.y)*c.ey-p.width>=s){if(this.isWhitespace(p.str[p.str.length-1])||this.isWhitespace(i.str[0])){return null;}return' ';}return null;},isWhitespace:function(c){return/\s/g.test(c)},isNewLine:function(c){if(c==='\r'||c==='\n'){return true;}return false;},processSpecialChars:function(t){return t.replace(new RegExp(String.fromCharCode(173),'g'),'-');},processTextContent:function(p,t){var i,c;for(var j=0;j<t.items.length;++j){i=t.items[j];i.str=this.processSpecialChars(i.str);var w=this.calculateArtificalWhitespace(c,i);if(w){this.writeAndHighlight(p,undefined,w,j-1);}if(i.str.length>0&&i.str.charCodeAt(0)===0){this.writeAndHighlight(p,j,"");continue;}this.writeAndHighlight(p,j,i.str);c=i;}},writeAndHighlight:function(p,i,t,c){var d=this.totalLength;this.textStream.write(t);this.totalLength+=t.length;var g=this.totalLength-1;this.processHighlight(p,i,d,g,c);},processHighlight:function(p,i,c,d,g){if(this.highlightIndex>=this.highlights.length){return;}var h=this.highlights[this.highlightIndex];if(!h.pdfFrom&&h.from<=d){h.pdfFrom={page:p,item:i,prevItem:g,offset:h.from-c};}if(!h.pdfTo&&h.to<=d){h.pdfTo={page:p,item:i,prevItem:g,offset:h.to-c};this.highlightIndex++;this.processHighlight(p,i,c,d);}}};e.getDefaultConversionOptions=function(){return{artificalWhitespace:'smart',spaceWidth:0.01};};e.convert2Text=function(o){var h=require('../util/helper.js');var t=new T();return f.readFileAsync(o.pdfFilePath).then(function(p){return a.getDocument(new Uint8Array(p));}).then(function(p){var c=new b({pdfDocument:p,conversionOptions:o.conversionOptions});return c.convertToText(t);}).then(function(){return t.saveToFile(h.replaceFileExtension(o.pdfFilePath,'.txt'));}).then(function(){console.log('converted to text and saved to',h.replaceFileExtension(o.pdfFilePath,'.txt'));});};e.convert2TextBuffer=function(o){var t=new T();if(!P){P=window.Promise;}return P.resolve().then(function(){if(o.pdfDocument){return o.pdfDocument;}return a.getDocument(new Uint8Array(o.pdfBuffer));}).then(function(p){var c=new b({pdfDocument:p,conversionOptions:o.conversionOptions});return c.convertToText(t);}).then(function(){return t.getData();});};e.convertHighlights=function(o){var t;if(o.assembleText){t=new T();}var c=new b({pdfDocument:o.pdfDocument,conversionOptions:o.conversionOptions});return c.convertHighlights(o.highlights,t).then(function(h){var r={highlights:h};if(t){r.text=t.getData();}return r;});};})();
