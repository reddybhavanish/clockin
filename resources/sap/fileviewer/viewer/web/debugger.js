/* Copyright 2012 Mozilla Foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
'use strict';var FontInspector=(function FontInspectorClosure(){var f;var a=false;var b='data-font-name';function r(){var d=document.querySelectorAll('div['+b+']');for(var i=0,e=d.length;i<e;++i){var g=d[i];g.className='';}}function c(){var d=document.querySelectorAll('div['+b+']');for(var i=0,e=d.length;i<e;++i){var g=d[i];g.className='debuggerHideText';}}function s(d,e){var g=document.querySelectorAll('div['+b+'='+d+']');for(var i=0,h=g.length;i<h;++i){var j=g[i];j.className=e?'debuggerShowText':'debuggerHideText';}}function t(e){if(!e.target.dataset.fontName||e.target.tagName.toUpperCase()!=='DIV'){return;}var d=e.target.dataset.fontName;var g=document.getElementsByTagName('input');for(var i=0;i<g.length;++i){var h=g[i];if(h.dataset.fontName!==d){continue;}h.checked=!h.checked;s(d,h.checked);h.scrollIntoView();}}return{id:'FontInspector',name:'Font Inspector',panel:null,manager:null,init:function init(p){var d=this.panel;d.setAttribute('style','padding: 5px;');var e=document.createElement('button');e.addEventListener('click',c);e.textContent='Refresh';d.appendChild(e);f=document.createElement('div');d.appendChild(f);},cleanup:function cleanup(){f.textContent='';},enabled:false,get active(){return a;},set active(v){a=v;if(a){document.body.addEventListener('click',t,true);c();}else{document.body.removeEventListener('click',t,true);r();}},fontAdded:function fontAdded(d,u){function p(o,k){var m=document.createElement('table');for(var i=0;i<k.length;i++){var q=document.createElement('tr');var v=document.createElement('td');v.textContent=k[i];q.appendChild(v);var w=document.createElement('td');w.textContent=o[k[i]].toString();q.appendChild(w);m.appendChild(q);}return m;}var m=p(d,['name','type']);var e=d.loadedName;var g=document.createElement('div');var n=document.createElement('span');n.textContent=e;var h=document.createElement('a');if(u){u=/url\(['"]?([^\)"']+)/.exec(u);h.href=u[1];}else if(d.data){u=URL.createObjectURL(new Blob([d.data],{type:d.mimeType}));h.href=u;}h.textContent='Download';var l=document.createElement('a');l.href='';l.textContent='Log';l.addEventListener('click',function(i){i.preventDefault();console.log(d);});var j=document.createElement('input');j.setAttribute('type','checkbox');j.dataset.fontName=e;j.addEventListener('click',(function(j,e){return(function(){s(e,j.checked);});})(j,e));g.appendChild(j);g.appendChild(n);g.appendChild(document.createTextNode(' '));g.appendChild(h);g.appendChild(document.createTextNode(' '));g.appendChild(l);g.appendChild(m);f.appendChild(g);setTimeout(function(){if(this.active){c();}}.bind(this),2000);}};})();var opMap;var StepperManager=(function StepperManagerClosure(){var s=[];var a=null;var c=null;var d=null;var e=Object.create(null);return{id:'Stepper',name:'Stepper',panel:null,manager:null,init:function init(p){var b=this;this.panel.setAttribute('style','padding: 5px;');c=document.createElement('div');d=document.createElement('select');d.addEventListener('change',function(f){b.selectStepper(this.value);});c.appendChild(d);a=document.createElement('div');this.panel.appendChild(c);this.panel.appendChild(a);if(sessionStorage.getItem('pdfjsBreakPoints')){e=JSON.parse(sessionStorage.getItem('pdfjsBreakPoints'));}opMap=Object.create(null);for(var k in p.OPS){opMap[p.OPS[k]]=k;}},cleanup:function cleanup(){d.textContent='';a.textContent='';s=[];},enabled:false,active:false,create:function create(p){var f=document.createElement('div');f.id='stepper'+p;f.setAttribute('hidden',true);f.className='stepper';a.appendChild(f);var b=document.createElement('option');b.textContent='Page '+(p+1);b.value=p;d.appendChild(b);var i=e[p]||[];var g=new Stepper(f,p,i);s.push(g);if(s.length===1){this.selectStepper(p,false);}return g;},selectStepper:function selectStepper(p,b){var i;p=p|0;if(b){this.manager.selectPanel(this);}for(i=0;i<s.length;++i){var f=s[i];if(f.pageIndex===p){f.panel.removeAttribute('hidden');}else{f.panel.setAttribute('hidden',true);}}var o=d.options;for(i=0;i<o.length;++i){var g=o[i];g.selected=(g.value|0)===p;}},saveBreakPoints:function saveBreakPoints(p,b){e[p]=b;sessionStorage.setItem('pdfjsBreakPoints',JSON.stringify(e));}};})();var Stepper=(function StepperClosure(){function c(t,a){var d=document.createElement(t);if(a){d.textContent=a;}return d;}function s(a){if(typeof a==='string'){var M=75;return a.length<=M?a:a.substr(0,M)+'...';}if(typeof a!=='object'||a===null){return a;}if('length'in a){var b=[],i,d;var e=10;for(i=0,d=Math.min(e,a.length);i<d;i++){b.push(s(a[i]));}if(i<a.length){b.push('...');}return b;}var f={};for(var k in a){f[k]=s(a[k]);}return f;}function S(p,a,i){this.panel=p;this.breakPoint=0;this.nextBreakPoint=null;this.pageIndex=a;this.breakPoints=i;this.currentIdx=-1;this.operatorListIdx=0;}S.prototype={init:function init(o){var p=this.panel;var a=c('div','c=continue, s=step');var t=c('table');a.appendChild(t);t.cellSpacing=0;var h=c('tr');t.appendChild(h);h.appendChild(c('th','Break'));h.appendChild(c('th','Idx'));h.appendChild(c('th','fn'));h.appendChild(c('th','args'));p.appendChild(a);this.table=t;this.updateOperatorList(o);},updateOperatorList:function updateOperatorList(o){var a=this;function b(){var x=+this.dataset.idx;if(this.checked){a.breakPoints.push(x);}else{a.breakPoints.splice(a.breakPoints.indexOf(x),1);}StepperManager.saveBreakPoints(a.pageIndex,a.breakPoints);}var M=15000;if(this.operatorListIdx>M){return;}var d=document.createDocumentFragment();var e=Math.min(M,o.fnArray.length);for(var i=this.operatorListIdx;i<e;i++){var l=c('tr');l.className='line';l.dataset.idx=i;d.appendChild(l);var f=this.breakPoints.indexOf(i)!==-1;var g=o.argsArray[i]||[];var h=c('td');var k=c('input');k.type='checkbox';k.className='points';k.checked=f;k.dataset.idx=i;k.onclick=b;h.appendChild(k);l.appendChild(h);l.appendChild(c('td',i.toString()));var m=opMap[o.fnArray[i]];var n=g;if(m==='showText'){var p=g[0];var q=[];var r=[];for(var j=0;j<p.length;j++){var t=p[j];if(typeof t==='object'&&t!==null){r.push(t.fontChar);}else{if(r.length>0){q.push(r.join(''));r=[];}q.push(t);}}if(r.length>0){q.push(r.join(''));}n=[q];}l.appendChild(c('td',m));l.appendChild(c('td',JSON.stringify(s(n))));}if(e<o.fnArray.length){l=c('tr');var u=c('td','...');u.colspan=4;d.appendChild(u);}this.operatorListIdx=o.fnArray.length;this.table.appendChild(d);},getNextBreakPoint:function getNextBreakPoint(){this.breakPoints.sort(function(a,b){return a-b;});for(var i=0;i<this.breakPoints.length;i++){if(this.breakPoints[i]>this.currentIdx){return this.breakPoints[i];}}return null;},breakIt:function breakIt(i,a){StepperManager.selectStepper(this.pageIndex,true);var b=this;var d=document;b.currentIdx=i;var l=function(e){switch(e.keyCode){case 83:d.removeEventListener('keydown',l,false);b.nextBreakPoint=b.currentIdx+1;b.goTo(-1);a();break;case 67:d.removeEventListener('keydown',l,false);var f=b.getNextBreakPoint();b.nextBreakPoint=f;b.goTo(-1);a();break;}};d.addEventListener('keydown',l,false);b.goTo(i);},goTo:function goTo(i){var a=this.panel.getElementsByClassName('line');for(var x=0,b=a.length;x<b;++x){var r=a[x];if((r.dataset.idx|0)===i){r.style.backgroundColor='rgb(251,250,207)';r.scrollIntoView();}else{r.style.backgroundColor=null;}}}};return S;})();var Stats=(function Stats(){var s=[];function c(n){while(n.hasChildNodes()){n.removeChild(n.lastChild);}}function g(p){for(var i=0,a=s.length;i<a;++i){if(s[i].pageNumber===p){return i;}}return false;}return{id:'Stats',name:'Stats',panel:null,manager:null,init:function init(p){this.panel.setAttribute('style','padding: 5px;');p.PDFJS.enableStats=true;},enabled:false,active:false,add:function(p,d){if(!d){return;}var e=g(p);if(e!==false){var b=s[e];this.panel.removeChild(b.div);s.splice(e,1);}var w=document.createElement('div');w.className='stats';var t=document.createElement('div');t.className='title';t.textContent='Page: '+p;var f=document.createElement('div');f.textContent=d.toString();w.appendChild(t);w.appendChild(f);s.push({pageNumber:p,div:w});s.sort(function(a,b){return a.pageNumber-b.pageNumber;});c(this.panel);for(var i=0,h=s.length;i<h;++i){this.panel.appendChild(s[i].div);}},cleanup:function(){s=[];c(this.panel);}};})();var PDFBug=(function PDFBugClosure(){var p=300;var c=[];var d=null;return{tools:[FontInspector,StepperManager,Stats],enable:function(e){var f=false,t=this.tools;if(e.length===1&&e[0]==='all'){f=true;}for(var i=0;i<t.length;++i){var g=t[i];if(f||e.indexOf(g.id)!==-1){g.enabled=true;}}if(!f){t.sort(function(a,b){var h=e.indexOf(a.id);h=h<0?t.length:h;var j=e.indexOf(b.id);j=j<0?t.length:j;return h-j;});}},init:function init(a,b){var u=document.createElement('div');u.id='PDFBug';var e=document.createElement('div');e.setAttribute('class','controls');u.appendChild(e);var f=document.createElement('div');f.setAttribute('class','panels');u.appendChild(f);b.appendChild(u);b.style.right=p+'px';var t=this.tools;var s=this;for(var i=0;i<t.length;++i){var g=t[i];var h=document.createElement('div');var j=document.createElement('button');j.textContent=g.name;j.addEventListener('click',(function(k){return function(l){l.preventDefault();s.selectPanel(k);};})(i));e.appendChild(j);f.appendChild(h);g.panel=h;g.manager=this;if(g.enabled){g.init(a);}else{h.textContent=g.name+' is disabled. To enable add '+' "'+g.id+'" to the pdfBug parameter '+'and refresh (separate multiple by commas).';}c.push(j);}this.selectPanel(0);},cleanup:function cleanup(){for(var i=0,a=this.tools.length;i<a;i++){if(this.tools[i].enabled){this.tools[i].cleanup();}}},selectPanel:function selectPanel(i){if(typeof i!=='number'){i=this.tools.indexOf(i);}if(i===d){return;}d=i;var t=this.tools;for(var j=0;j<t.length;++j){if(j===i){c[j].setAttribute('class','active');t[j].active=true;t[j].panel.removeAttribute('hidden');}else{c[j].setAttribute('class','');t[j].active=false;t[j].panel.setAttribute('hidden','true');}}}};})();
