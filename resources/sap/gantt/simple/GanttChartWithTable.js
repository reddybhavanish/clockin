/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/gantt/library","jquery.sap.global","sap/ui/core/Control","sap/ui/model/ChangeReason","sap/base/util/values","sap/ui/layout/Splitter","sap/ui/layout/SplitterLayoutData","sap/ui/core/ResizeHandler","./InnerGanttChart","./GanttHeader","./GanttSyncedControl","../control/AssociateContainer","../axistime/ProportionZoomStrategy","./SelectionModel","./ExpandModel","./ShapeScheme","./GanttExtension","./GanttScrollExtension","./GanttZoomExtension","./GanttPointerExtension","./GanttDragDropExtension","./GanttPopoverExtension","./GanttConnectExtension","./GanttResizeExtension","./GanttUtils","./RenderUtils","../misc/Format","../misc/Utility","../config/TimeHorizon","./GanttChartWithTableRenderer"],function(l,q,C,c,v,S,d,R,I,G,e,A,P,f,E,g,h,j,k,m,n,o,p,r,s,t,F,U,T){"use strict";var u=l.simple.GanttChartWithTableDisplayType,V=l.simple.VisibleHorizonUpdateType;var w=Object.freeze({"totalHorizonUpdated":V.TotalHorizonUpdated,"mouseWheelZoom":V.MouseWheelZoom,"syncVisibleHorizon":V.SyncVisibleHorizon,"initialRender":V.InitialRender,"horizontalScroll":V.HorizontalScroll,"zoomLevelChanged":V.ZoomLevelChanged,"timePeriodZooming":V.TimePeriodZooming});var M=10;var x=60;function y(a,b){return a+b;}function z(a,b){return Math.abs(a-b)<M;}var B=C.extend("sap.gantt.simple.GanttChartWithTable",{metadata:{properties:{width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},shapeSelectionMode:{type:"sap.gantt.SelectionMode",defaultValue:l.SelectionMode.MultiWithKeyboard},shapeOverRelationship:{type:"boolean",defaultValue:true},shapeSelectionSettings:{type:"object",defaultValue:null},enableCursorLine:{type:"boolean",defaultValue:true},enableNowLine:{type:"boolean",defaultValue:true},nowLineInUTC:{type:"boolean",defaultValue:true},enableVerticalLine:{type:"boolean",defaultValue:true},enableAdhocLine:{type:"boolean",defaultValue:true},adhocLineLayer:{type:"string",defaultValue:l.AdhocLineLayer.Top},dragOrientation:{type:"sap.gantt.DragOrientation",defaultValue:l.DragOrientation.Free},ghostAlignment:{type:"string",defaultValue:l.dragdrop.GhostAlignment.None},showShapeTimeOnDrag:{type:"boolean",defaultValue:false},selectionPanelSize:{type:"sap.ui.core.CSSSize",defaultValue:"30%"},displayType:{type:"sap.gantt.simple.GanttChartWithTableDisplayType",defaultValue:u.Both},disableShapeDoubleClickEvent:{type:"boolean",defaultValue:false}},aggregations:{table:{type:"sap.ui.table.Table",multiple:false},adhocLines:{type:"sap.gantt.AdhocLine",multiple:true,singularName:"adhocLine",bindable:"bindable",visibility:"public"},svgDefs:{type:"sap.gantt.def.SvgDefs",multiple:false,singularName:"svgDef"},shapeSchemes:{type:"sap.gantt.simple.ShapeScheme",multiple:true,singularName:"shapeScheme"},calendarDef:{type:"sap.gantt.def.cal.CalendarDefs",multiple:false,bindable:"bindable"},axisTimeStrategy:{type:"sap.gantt.axistime.AxisTimeStrategyBase",multiple:false,bindable:"bindable"},locale:{type:"sap.gantt.config.Locale",multiple:false},_splitter:{type:"sap.ui.layout.Splitter",multiple:false,visibility:"hidden"},_header:{type:"sap.gantt.simple.GanttHeader",multiple:false,defaultValue:null,visibility:"hidden"},_innerGantt:{type:"sap.gantt.simple.InnerGanttChart",multiple:false,visibility:"hidden"}},events:{shapeSelectionChange:{parameters:{shapeUids:{type:"string[]"}}},shapeResize:{parameters:{shapeUid:{type:"string"},shape:{type:"sap.gantt.shape.BaseShape"},rowObject:{type:"object"},oldTime:{type:"string[]"},newTime:{type:"string[]"}}},shapeMouseEnter:{parameters:{shape:{type:"sap.gantt.shape.BaseShape"},pageX:{type:"int"},pageY:{type:"int"}}},shapeMouseLeave:{parameters:{shape:{type:"sap.gantt.shape.BaseShape"},originEvent:{type:"object"}}},shapePress:{parameters:{popoverOffsetX:{type:"int"},rowSettings:{type:"sap.gantt.simple.GanttRowSettings"},shape:{type:"sap.gantt.shape.BaseShape"}},allowPreventDefault:true},shapeDoubleClick:{parameters:{popoverOffsetX:{type:"int"},rowSettings:{type:"sap.gantt.simple.GanttRowSettings"},shape:{type:"sap.gantt.shape.BaseShape"}}},shapeContextMenu:{parameters:{pageX:{type:"int"},pageY:{type:"int"},popoverOffsetX:{type:"int"},rowSettings:{type:"sap.gantt.simple.GanttRowSettings"},shape:{type:"sap.gantt.shape.BaseShape"}}},dragStart:{parameters:{sourceGanttChart:{type:"sap.gantt.simple.GanttChartWithTable"},draggedShapeDates:{type:"object"},lastDraggedShapeUid:{type:"string"},cursorDateTime:{type:"object"}}},shapeDrop:{parameters:{sourceGanttChart:{type:"sap.gantt.simple.GanttChartWithTable"},targetGanttChart:{type:"sap.gantt.simple.GanttChartWithTable"},draggedShapeDates:{type:"object"},lastDraggedShapeUid:{type:"string"},targetRow:{type:"sap.ui.table.Row"},cursorDateTime:{type:"object"},newDateTime:{type:"object"},targetShape:{type:"sap.gantt.shape.BaseShape"}}},shapeConnect:{parameters:{fromShapeUid:{type:"string"},toShapeUid:{type:"string"},type:{type:"sap.gantt.simple.RelationshipType"}}},visibleHorizonUpdate:{parameters:{type:{type:"sap.gantt.simple.VisibleHorizonUpdateType"},lastVisibleHorizon:{type:"sap.gantt.config.TimeHorizon"},currentVisibleHorizon:{type:"sap.gantt.config.TimeHorizon"}}}}}});B.prototype.init=function(){this.iGanttRenderedWidth=-1;this._bExtensionsInitialized=false;this._oExpandModel=new E();this._oSplitter=new S();this.setAggregation("_splitter",this._oSplitter);this._oSyncedControl=new e();this.setAggregation("_innerGantt",new I());this.setAggregation("_header",new G());this._sPreviousDisplayType=this.getDisplayType();};B.prototype.getInnerGantt=function(){return this.getAggregation("_innerGantt");};B.prototype.onSplitterResize=function(a){var O=a.getParameter("oldSizes"),N=a.getParameter("newSizes"),b=O.length>0&&N.length>0&&O[0]!==N[0],D=this.getDisplayType(),i=N[0];if(b){if(D===u.Both){this._onResize();}var H=function(J){return this.getSelectionPanelSize().startsWith("0")||J[0]!==0;}.bind(this);if(z(O.reduce(y),N.reduce(y))&&O[0]!==N[0]&&H(O)){this.setProperty("selectionPanelSize",i+"px",true);this.fireEvent("_selectionPanelResize",{newWidth:i,displayType:D});}this._draw();}};B.prototype.setLayoutData=function(L){this.setAggregation("layoutData",L,true);this.fireEvent("_layoutDataChange");return this;};B.prototype.setDisplayType=function(D){this._sPreviousDisplayType=this.getDisplayType();if(this._sPreviousDisplayType===u.Both&&D!==u.Both){this._iLastTableAreaSize=this.getAggregation("_splitter").getCalculatedSizes()[0];}this.setProperty("displayType",D,false);if(D===u.Table){this.setProperty("selectionPanelSize","auto",true);}else{delete this._bPreventInitialRender;}this._setupDisplayType();return this;};B.prototype.setSelectionPanelSize=function(a){this.setProperty("selectionPanelSize",a,false);delete this._iLastTableAreaSize;this._setSplitterLayoutData(a,"auto");return this;};B.prototype.applySettings=function(a,b){a=a||{};this._applyMissingSettings(a);C.prototype.applySettings.call(this,a,b);this._initSelectionModel(this.getProperty("shapeSelectionMode"));};B.prototype._applyMissingSettings=function(a){if(!a.axisTimeStrategy){a.axisTimeStrategy=new P();}if(!a.locale){a.locale=l.config.DEFAULT_LOCALE_CET.clone();}if(!a.shapeSchemes){a.shapeSchemes=[new g({key:"default",primary:true})];}else{var H=a.shapeSchemes.some(function(b){return b.getPrimary();});if(!H){q.sap.log.warning("you need set a ShapeSheme with primary:true");}}};B.prototype.getPrimaryShapeScheme=function(){return this.getShapeSchemes().filter(function(a){return a.getPrimary();})[0];};B.prototype.getSyncedControl=function(){return this._oSyncedControl;};B.prototype.getTableRowHeights=function(){return this.getSyncedControl().getRowHeights();};B.prototype.setTable=function(a){this.setAggregation("table",a);a._bVariableRowHeightEnabled=true;var O=this._oSplitter.removeContentArea(0);this._oSplitter.insertContentArea(new A({content:a,enableRootDiv:true,layoutData:a.getLayoutData()?a.getLayoutData().clone():new d({size:this.getSelectionPanelSize()})}),0);if(O==null){this._oSyncedControl.syncWith(a);this._oSplitter.addContentArea(this._oSyncedControl);}else if(O&&O.getContent()!==a.getId()){this._oSyncedControl.syncWith(a);}a.detachEvent("_rowsUpdated",this._onTableRowsUpdated,this);a.attachEvent("_rowsUpdated",this._onTableRowsUpdated,this);};B.prototype.setEnableVariableRowHeight=function(b){if(this.getTable()){this.getTable()._bVariableRowHeightEnabled=b;}else{q.sap.log.warning("you need to set table aggregation first");}};B.prototype.setLargeDataScrolling=function(b){if(this.getTable()){this.getTable()._setLargeDataScrolling(b);}else{q.sap.log.warning("you need to set table aggregation first");}};B.prototype.getRenderedTimeRange=function(){return this.getAxisTime().getTimeRangeSlice(0,this.iGanttRenderedWidth);};B.prototype._initSelectionModel=function(a){if(this.oSelection){this.oSelection.detachSelectionChanged(this._onSelectionChanged,this);}this.oSelection=new f(a);this.oSelection.attachSelectionChanged(this._onSelectionChanged,this);return this;};B.prototype.setShapeSelectionMode=function(a){this.setProperty("shapeSelectionMode",a);if(this.oSelection){this.oSelection.setSelectionMode(a);}return this;};B.prototype.getSelectedShapeUid=function(){return this.oSelection.allUid();};B.prototype.selectShapes=function(a,b){if(!this.oSelection){return this;}if((!a||a.length===0)&&b){this.oSelection.clear(true);return this;}if(b){this.oSelection.clear(false);}this._updateShapes(a,true);return this;};B.prototype.deselectShapes=function(a){if(!this.oSelection||!a||a.length===0){return this;}this._updateShapes(a,false);return this;};B.prototype._updateShapes=function(a,b){var D={};var H=s.getShapesWithUid(this.getId(),a);for(var i=0;i<a.length;i++){D[a[i]]={selected:b,ctrl:false};if(H[i]){D.draggable=H[i].getDraggable();D.time=H[i].getTime();D.endTime=H[i].getEndTime();}}this.oSelection.updateShapes(D);};B.prototype._onSelectionChanged=function(a){var b=a.getParameter("shapeUid"),D=a.getParameter("deselectedUid"),i=a.getParameter("silent");this._updateShapeSelections(b,D);if(!i){this.fireShapeSelectionChange({shapeUids:b});}};B.prototype.handleShapePress=function(a){var b=a.shape,i=b.getShapeUid(),D=a.ctrlOrMeta;var N=!b.getSelected();this.oSelection.updateShape(i,{selected:N,ctrl:D,draggable:b.getDraggable(),time:b.getTime(),endTime:b.getEndTime()});};B.prototype._updateShapeSelections=function(a,D){var b=this.getShapeSelectionMode();if(b===l.SelectionMode.None){return;}t.updateShapeSelections(this,a,D);};B.prototype.getSelection=function(){return this.oSelection;};B.prototype.getExpandedBackgroundData=function(){if(this._oExpandModel.hasExpandedRows()){var a=this.getTable().getRows();var b=a.length;var D=this.getTable().getFirstVisibleRow();var H=[];for(var i=0;i<b;i++){if(a[i].getIndex()>=D){var J=a[i].getAggregation("_settings");H.push(J.getRowUid());}}return this._oExpandModel.collectExpandedBgData(H);}};B.prototype.setAxisTimeStrategy=function(a){a.attachEvent("_redrawRequest",this._onRedrawRequest,this);delete this._bPreventInitialRender;return this.setAggregation("axisTimeStrategy",a,false);};B.prototype._onTableRowsUpdated=function(a){if(!this.getVisible()){return;}var b=a.getParameter("reason"),i=this.getInnerGantt();var D=v(c).slice();var H=D.concat(["Render","FirstVisibleRowChange","Resize"]);if(H.indexOf(b)!==-1){this.getSyncedControl().setAllowContentScroll(false);i.invalidate();}else if(b==="VerticalScroll"){}else{i.getRenderer().renderImmediately(this);}};B.prototype.syncVisibleHorizon=function(a,i,K,b){var D=this.getAxisTimeStrategy();var H=D.getTotalHorizon();var J;var L=this.getVisibleWidth();if(i!==undefined){if(L===undefined){return;}if(K){var N=D.getVisibleHorizon();var O=F.abapTimestampToDate(N.getStartTime());J=U.calculateHorizonByWidth(a,i,L,O);}else{J=U.calculateHorizonByWidth(a,i,L);}}else{J=a;}if(H.getEndTime()<J.getEndTime()){var Q=F.abapTimestampToDate(J.getEndTime()).getTime()-F.abapTimestampToDate(J.getStartTime()).getTime();var W=F.abapTimestampToDate(H.getEndTime());var X=new Date();X.setTime(W.getTime()-Q);J=new T({startTime:X,endTime:W});}this._updateVisibleHorizon(J,b||"syncVisibleHorizon",L);};B.prototype._updateVisibleHorizon=function(a,b,i){var D=this.getAxisTimeStrategy();D.updateGanttVisibleWidth(i);if(a&&a.getStartTime()){D.setVisibleHorizonWithReason(a,b);}};B.prototype.syncMouseWheelZoom=function(a){this._getZoomExtension().performMouseWheelZooming(a.originEvent,true);};B.prototype.syncTimePeriodZoomOperation=function(a,b,O){this._getZoomExtension().syncTimePeriodZoomOperation(a,b,O);};B.prototype._onRedrawRequest=function(a){var b=a.getParameter("valueBeforeChange");var i=a.getParameter("reasonCode");if(b&&i!=="totalHorizonUpdated"&&i!=="initialRender"&&i!=="syncVisibleHorizon"){this._syncContainerGanttCharts(i,a.getParameter("originEvent"));}this.fireVisibleHorizonUpdate({type:w[i],lastVisibleHorizon:b,currentVisibleHorizon:this.getAxisTimeStrategy().getVisibleHorizon()});this.redraw(i);this._setupDisplayType();};B.prototype.redraw=function(a){this._draw(a);};B.prototype._draw=function(a){var i=this.getVisibleWidth();if(!i){return;}var b=this.getAxisTimeStrategy().syncContext(i);if(this.getAxisTimeStrategy().initialSettings!=null&&this.getAxisTimeStrategy().initialSettings.zoomLevel!=null&&this.getAxisTimeStrategy().initialSettings.zoomLevel!=0&&a=="initialRender"&&!this.getAxisTimeStrategy().isA("sap.gantt.axistime.FullScreenStrategy")&&!this.isPrint){var D=this.getAxisTimeStrategy();var H=D.initialSettings.zoomLevel;D.setProperty("zoomLevel",H,true);b.zoomLevel=H;var J=D.calVisibleHorizonByRate(D._aZoomRate[H]);D.updateInitialVisibleHorizon(J,H);}this.fireEvent("_zoomInfoUpdated",b);var K=this._getScrollExtension();if(b.axisTimeChanged){K.clearOffsetWidth();}K.needRerenderGantt(function(){this.getInnerGantt().getRenderer().renderImmediately(this);}.bind(this),a);};B.prototype._syncContainerGanttCharts=function(a,O){var b=this.getParent();if(b&&b.isA("sap.gantt.simple.GanttChartContainer")&&b.getGanttCharts().length>1){this.fireEvent("_initialRenderGanttChartsSync",{reasonCode:a,visibleHorizon:this.getAxisTimeStrategy().getVisibleHorizon(),visibleWidth:this.getVisibleWidth(),originEvent:O});}};B.prototype.onBeforeRendering=function(a){this._updateRowHeightInExpandModel(this.getTable());h.detachEvents(this);this._oSplitter.detachResize(this.onSplitterResize,this);if(this._sResizeHandlerId){R.deregister(this._sResizeHandlerId);}if(this.getDisplayType()!==u.Table){this.getInnerGantt().invalidate();}};B.prototype.onAfterRendering=function(a){this._attachExtensions();h.attachEvents(this);this._oSplitter.attachResize(this.onSplitterResize,this);this._sResizeHandlerId=R.register(this,this._onResize.bind(this));};B.prototype._onResize=function(){if(this.getDisplayType()!==u.Both){return;}var a=this.getAggregation("_splitter");if(a.getContentAreas()[0]&&a.getContentAreas()[0].getLayoutData()){var L=a.getContentAreas()[0],b=L.getLayoutData(),i=this.getDomRef().offsetWidth,N;if(i<x*2){N=i/2;}else{var D=L.getDomRef().offsetWidth;if(D>x){return;}N=Math.max(Math.min(D,i-x),x);}b.setSize(N+"px");}};B.prototype._setupDisplayType=function(){var D=this.getDisplayType();if(D===u.Table){this._setSplitterLayoutData("auto","0px");}else if(D===u.Chart){this._setSplitterLayoutData("0px","auto");}else if(D!==this._sPreviousDisplayType){this._setSplitterLayoutData(this._iLastTableAreaSize?this._iLastTableAreaSize+"px":this.getSelectionPanelSize(),"auto");}};B.prototype._setSplitterLayoutData=function(a,b){var i=this._oSplitter.getContentAreas();if(i.length>1){var D=i[0].getLayoutData(),H=i[1].getLayoutData(),J=this.getDisplayType()===u.Both;D.setSize(a).setResizable(J);H.setSize(b).setResizable(J);}};B.prototype._updateRowHeightInExpandModel=function(a){var i=a.getRowHeight();if(i===0){i=a._getDefaultRowHeight();}this._oExpandModel.setBaseRowHeight(i);};B.prototype.jumpToPosition=function(a){if(Object.prototype.toString.call(a)==="[object Date]"||typeof a==="string"){this._updateVisibleHorizon(new T({startTime:a}),"jumpToPosition",this.getVisibleWidth());}else if(Array.isArray(a)){this._updateVisibleHorizon(new T({startTime:a[0],endTime:a[1]}),"jumpToPosition",this.getVisibleWidth());}else if(a===undefined){this._updateVisibleHorizon(this.getAxisTimeStrategy().getTotalHorizon(),"jumpToPosition",this.getVisibleWidth());}};B.prototype.exit=function(){if(this._sResizeHandlerId){R.deregister(this._sResizeHandlerId);}this._detachExtensions();delete this._bPreventInitialRender;};B.prototype._attachExtensions=function(){if(this._bExtensionsInitialized){return;}h.enrich(this,j);h.enrich(this,k);h.enrich(this,m);h.enrich(this,n);h.enrich(this,o);h.enrich(this,p);h.enrich(this,r);this._bExtensionsInitialized=true;};B.prototype._detachExtensions=function(){h.cleanup(this);};B.prototype.getAxisTime=function(){var a=this.getAxisTimeStrategy().getAxisTime();if(!a){this.getAxisTimeStrategy().createAxisTime(this.getLocale());a=this.getAxisTimeStrategy().getAxisTime();}return a;};B.prototype.getContentWidth=function(){var a=this.getAxisTime(),b=a.getViewRange();return Math.abs(Math.ceil(b[1])-Math.ceil(b[0]));};B.prototype.getVisibleWidth=function(){return this._getScrollExtension?this._getScrollExtension().getVisibleWidth():undefined;};B.prototype.expand=function(a,b){this.toggleShapeScheme(true,a,b);};B.prototype.collapse=function(a,b){this.toggleShapeScheme(false,a,b);};B.prototype.toggleShapeScheme=function(b,a,i){var D=[];if(typeof i==="number"){D=[i];}else if(Array.isArray(i)){D=i;}if(D.length===0||!a){return;}var H=this.getShapeSchemes().filter(function(L){return L.getKey()===a;});if(H==null||H.length===0||H.length>1){return;}var J=this.getPrimaryShapeScheme();var K=this._oExpandModel.isTableRowHeightNeedChange(b,this.getTable(),D,J,H[0]);if(K){this.getTable().invalidate();}};B.prototype.isShapeVisible=function(a){if(a&&a.isVisible()){return true;}if(!a.getVisible()){return false;}var b=this.getRenderedTimeRange(),i=b[0],D=b[1];var H=a.getTime(),J=a.getEndTime();var K=function(L){return(L>=i&&L<=D);};if(a.getSelected()||!H||!J){return true;}else if(H&&J){return K(H)||K(J)||(H<=i&&J>=D);}else if(H&&!J){return K(H);}else if(!H&&J){return K(J);}};B.prototype.doBirdEye=function(i){var Z=this._getZoomExtension();Z.doBirdEye(i);};return B;},true);
