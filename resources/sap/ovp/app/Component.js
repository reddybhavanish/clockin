sap.ui.define(["sap/ui/core/UIComponent","sap/ovp/cards/rta/SettingsDialogConstants","sap/ui/core/routing/Router","sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/Log","sap/ui/model/json/JSONModel","sap/ovp/ui/DashboardLayoutUtil","sap/ui/core/mvc/ViewType","sap/ui/model/resource/ResourceModel","sap/ovp/app/resources","sap/ui/core/CustomData","sap/ushell/Config","sap/base/util/merge","sap/base/util/isEmptyObject","sap/ui/rta/RuntimeAuthoring"],function(U,S,R,q,O,L,J,D,V,a,b,C,c,m,d){"use strict";return U.extend("sap.ovp.app.Component",{metadata:{routing:{config:{routerClass:R},targets:{},routes:[]},properties:{"cardContainerFragment":{"type":"string","defaultValue":"sap.ovp.app.CardContainer"},"dashboardLayoutUtil":{"type":"sap.ovp.ui.DashboardLayoutUtil"},"designtimePath":{"type":"string","defaultValue":"sap/ovp/ui/OVPWrapper.designtime"}},version:"1.78.0",library:"sap.ovp.app",dependencies:{libs:["sap.ovp"],components:[]},config:{fullWidth:true,hideLightBackground:true}},_getOvpCardOriginalConfig:function(s){var o=this.getOvpConfig();return o.cards[s];},restore:function(){sap.ovp.cards.charts.VizAnnotationManager.formatChartAxes();},getOvpConfig:function(){var o;var e=[];var M=this.getMetadata();while(M&&M.getComponentName()!=="sap.ovp.app"){o=M.getManifestEntry("sap.ovp");if(o){e.unshift(o);}M=M.getParent();}e.unshift({});e.unshift(true);o=q.extend.apply(q,e);return o;},_removeExtraArrayElements:function(s,o){var e=s["staticContent"],f=o["staticContent"],g=s["tabs"],h=o["tabs"];if(e&&f){if(e.length>f.length){s["staticContent"].splice(f.length,e.length-f.length);}}if(g&&h){if(g.length>h.length){s["tabs"].splice(h.length,g.length-h.length);}}},_emptyAllArrayElements:function(s){var e=s["staticContent"],f=s["tabs"],i;if(e){for(i=0;i<e.length;i++){s["staticContent"][i]={};}}if(f){for(i=0;i<f.length;i++){s["tabs"][i]={};}}},_mergeObjects:function(o,e){for(var p in e){if(e.hasOwnProperty(p)){var v=e[p];if(typeof v=="object"&&o[p]){if(v.operation==="DELETE"){delete o[p];}else{this._mergeObjects(o[p],v);}}else{if(typeof v=="object"&&!o[p]&&v.operation==="DELETE"){continue;}o[p]=v;}}}return o;},_mergeLayerObject:function(o,l){if(!o[l+".settings"]){return o;}var s=q.extend(true,{},o["settings"]),e=q.extend(true,{},o[l+".settings"]);this._removeExtraArrayElements(s,e);this._emptyAllArrayElements(s);o["settings"]=this._mergeObjects(s,e);return o;},_mergeKeyUserChanges:function(o){if(!o.hasOwnProperty("customer.settings")&&!o.hasOwnProperty("customer_base.settings")&&!o.hasOwnProperty("vendor.settings")){return o;}o=this._mergeLayerObject(o,"vendor");o=this._mergeLayerObject(o,"customer_base");o=this._mergeLayerObject(o,"customer");return o;},_getFullyQualifiedNameForEntity:function(e,f){var n,r;if(!e){return"";}if(e.indexOf(".")>-1){return e;}var o=f&&f.getODataEntityContainer();n=o&&o.namespace;if(n&&!(e.indexOf(n)>-1)){r=n+"."+e;}else{r=e;}return r;},isDate:function(p){if(((p["type"]==="Edm.DateTime"&&p["sap:display-format"]==="Date")||(p["type"]==="Edm.String"&&p["com.sap.vocabularies.Common.v1.IsCalendarDate"]&&p["com.sap.vocabularies.Common.v1.IsCalendarDate"].Bool==="true"))&&p["sap:filter-restriction"]==="interval"){return true;}return false;},_getDatePropertiesFromEntitySet:function(f){var p=f.property,e=[];for(var k in p){var o={};if(this.isDate(p[k])){o.PropertyPath=p[k].name;}if(!d(o)){e.push(o);}}return e;},_getAllControlConfiguration:function(e,s,o){for(var i=0;i<e.length;i++){if(o[e[i].PropertyPath]){var I=false;for(var j=0;j<s.length;j++){if(s[j].PropertyPath===e[i].PropertyPath){I=true;}}if(!I){e[i].bNotPartOfSelectionField=true;s.push(e[i]);}}}return s;},_getSettingsForDateProperties:function(e,o){var f={};for(var k in e){if(o.fields&&o.fields[e[k].PropertyPath]){f[e[k].PropertyPath]=this.getConditionTypeForDateSetting(o.fields[e[k].PropertyPath]);}else{if(o.customDateRangeImplementation||o.selectedValues){f[e[k].PropertyPath]=this.getConditionTypeForDateSetting(o);}}}return f;},getConditionTypeForDateSetting:function(o){if(o.customDateRangeImplementation){return{customDateRangeImplementation:o.customDateRangeImplementation};}else if(o.selectedValues){return{selectedValues:o.selectedValues,exclude:(o.exclude!==undefined)?o.exclude:true};}return undefined;},createXMLView:function(o){if(this.getRouter()){this.getRouter().initialize();}var e=this.getMetadata().getManifestEntry("sap.app");var u=this.getMetadata().getManifestEntry("sap.ui");var i=O.get("icons.icon",u);var s=this.getMetadata().getComponentName();var f=s.replace(/\./g,"/");o.baseUrl=sap.ui.require.toUrl(f);if(o.smartVariantRequired===undefined||o.smartVariantRequired===null){o.smartVariantRequired=true;}if(o.enableLiveFilter===undefined||o.enableLiveFilter===null){o.enableLiveFilter=true;}if(o.showDateInRelativeFormat===undefined||o.showDateInRelativeFormat===null){o.showDateInRelativeFormat=true;}if((o.filterSettings&&o.filterSettings.dateSettings&&(o.filterSettings.dateSettings.useDateRange!==undefined))&&o.useDateRangeType!==undefined){throw new Error("Defining both useDateRange and useDateRangeType in the manifest is not allowed");}o.useDateRangeType=(o.filterSettings&&o.filterSettings.dateSettings&&(o.filterSettings.dateSettings.useDateRange!==undefined))?o.filterSettings.dateSettings.useDateRange:o.useDateRangeType;if(o.useDateRangeType===undefined||o.useDateRangeType===null){o.useDateRangeType=false;}if(o.bHeaderExpanded===undefined||o.bHeaderExpanded===null){o.bHeaderExpanded=false;}var F=this.getModel(o.globalFilterModel);var g=F&&F.getMetaModel();this.setModel(F);if(o.globalFilterEntitySet&&o.globalFilterEntitySet!==" "){var E=g&&g.getODataEntitySet(o.globalFilterEntitySet);o.globalFilterEntityType=E&&E.entityType;}if(o.globalFilterEntityType&&o.globalFilterEntityType!==" "&&o.globalFilterEntityType.length>0){o.globalFilterEntityType=this._getFullyQualifiedNameForEntity(o.globalFilterEntityType,g);o.globalFilterEntityTypeNQ=o.globalFilterEntityType.split(".").pop();}var h=new J(o);h.setProperty("/applicationId",O.get("id",e));h.setProperty("/title",O.get("title",e));h.setProperty("/description",O.get("description",e));if(o.globalFilterEntityType){var j=g.getODataEntityType(o.globalFilterEntityType),A=m([],j["com.sap.vocabularies.UI.v1.SelectionFields"]);if(o.filterSettings&&o.filterSettings.dateSettings){var k=this._getDatePropertiesFromEntitySet(j);var l=this._getSettingsForDateProperties(k,o.filterSettings.dateSettings);if(h.getProperty("/useDateRangeType")&&!d(l)){throw new Error("Setting 'useDateRange' property as True and maintaining property level configuration for date ranges in Date Settings are mutually exclusive, resulting in error. Change one of these settings in manifest.json as per your requirement.");}A=this._getAllControlConfiguration(k,A,l);h.setProperty("/datePropertiesSettings",l);}h.setProperty("/allControlConfiguration",A);}if(i){if(i.indexOf("sap-icon")<0&&i.charAt(0)!=='/'){i=o.baseUrl+"/"+i;}h.setProperty("/icon",i);}var n=o.cards;var p=[];var r;for(var t in n){if(n.hasOwnProperty(t)&&n[t]){r=this._mergeKeyUserChanges(n[t]);r.id=t;p.push(r);}}p.sort(function(y,z){if(y.id<z.id){return-1;}else if(y.id>z.id){return 1;}else{return 0;}});h.setProperty("/cards",p);if(this.inResizableTestMode()===true){o.containerLayout="resizable";}if(o.containerLayout&&o.containerLayout==="resizable"){h.setProperty("/cardContainerFragment","sap.ovp.app.DashboardCardContainer");h.setProperty("/dashboardLayout",o.resizableLayout);var v=new D(h);this.setDashboardLayoutUtil(v);}else{h.setProperty("/cardContainerFragment",this.getCardContainerFragment());}this.setModel(h,"ui");var w=this._getOvpLibResourceBundle();this.setModel(w,"ovplibResourceBundle");var j=g&&g.getODataEntityType(o.globalFilterEntityType,true);var x=sap.ui.view("mainView",{height:"100%",preprocessors:{xml:{bindingContexts:{ui:h.createBindingContext("/"),meta:g.createBindingContext(j)},models:{ui:h,meta:g}}},type:V.XML,viewName:"sap.ovp.app.Main",async:true,customData:[new C({key:"sap-ui-custom-settings",value:{"sap.ui.dt":{"designtime":"sap/ovp/ui/OVPWrapper.designtime"}}})]});return x;},_showErrorPage:function(){var v=sap.ui.view({height:"100%",type:V.XML,viewName:"sap.ovp.app.Error"});var o=this._getOvpLibResourceBundle();v.setModel(o,"ovplibResourceBundle");this.setAggregation("rootControl",v);this.oContainer.invalidate();},_formParamString:function(p){var k=Object.keys(p);var i;var P="?";for(i=0;i<k.length;i++){P=P+k[i]+"="+p[k[i]]+"&";}return P.slice(0,-1);},_checkForAuthorizationForLineItems:function(){return new Promise(function(r,e){var A=[],o=[];var f=this.getOvpConfig();var g=f["cards"];for(var s in g){if(g.hasOwnProperty(s)&&g[s]){var h=g[s];var k=h.settings;if(h.template==="sap.ovp.cards.linklist"&&k.listFlavor==="standard"&&k.staticContent){var l=k.staticContent;for(var i=0;i<l.length;i++){if(l[i].semanticObject||l[i].action){var I="#"+l[i].semanticObject+"-"+l[i].action;if(l[i].params){var p=this._formParamString(l[i].params);I=I+p;}if(o.indexOf(s)===-1){o.push(s);}if(A.indexOf(I)===-1){A.push(I);}}}}}}this._oCardsWithStaticContent=o;if(sap.ushell&&sap.ushell.Container){sap.ushell.Container.getService('CrossApplicationNavigation').isIntentSupported(A).done(function(n){var f=this.getOvpConfig();for(var t in n){if(n.hasOwnProperty(t)&&n[t].supported===false){for(var i=0;i<this._oCardsWithStaticContent.length;i++){var l=f["cards"][this._oCardsWithStaticContent[i]].settings.staticContent;for(var j=l.length-1;j>=0;j--){var I="#"+l[j].semanticObject+"-"+l[j].action;if(l[j].params){var p=this._formParamString(l[j].params);I=I+p;}if(t===I){l.splice(j,1);}}f["cards"][this._oCardsWithStaticContent[i]].settings.staticContent=l;}}}delete this._oCardsWithStaticContent;r(f);}.bind(this)).fail(function(E){L.error(E);e(E);});}else{r(f);}}.bind(this));},setContainer:function(){var o=this.getOvpConfig();var f=this.getModel(o.globalFilterModel);U.prototype.setContainer.apply(this,arguments);if(f&&!this.getAggregation("rootControl")){Promise.all([f.getMetaModel().loaded(),this._checkForAuthorizationForLineItems(o),b.pResourcePromise]).then(function(r){this.oOvpConfig=r[1];this.runAsOwner(function(){var v=this.createXMLView(this.oOvpConfig);v.loaded().then(function(){this.setAggregation("rootControl",v);this.oContainer.invalidate();}.bind(this));}.bind(this));}.bind(this));f.attachMetadataFailed(function(){this._showErrorPage();}.bind(this));}},_getOvpLibResourceBundle:function(){if(!this.ovplibResourceBundle){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");this.ovplibResourceBundle=r?new a({bundleUrl:r.oUrlInfo.url,bundle:r}):null;}return this.ovplibResourceBundle;},createMapForEntityContainer:function(e){var E={};var o=e.entitySet;for(var i=0;i<o.length;i++){E[o[i].name]=o[i].entityType;}return E;},inResizableTestMode:function(){return this._getQueryParamUpToTop('resizableTest')=='true';},_getQueryParamUpToTop:function(n){var w=window;var v=this.getQueryParam(w.location.search,n);if(v!=null){return v;}if(w==w.parent){return null;}w=w.parent;return null;},getQueryParam:function(e,n){var v=null;if(!e){return v;}if(e.indexOf('?')!=-1){e=e.substring(e.indexOf('?'));}if(e.length>1&&e.indexOf(n)!=-1){e=e.substring(1);var p=e.split('&');for(var i=0;i<p.length;i++){var f=p[i].split('=');if(f[0]==n){v=f[1];break;}}}return v;}});});
