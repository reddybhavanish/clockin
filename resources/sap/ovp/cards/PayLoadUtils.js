/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(['sap/ui/thirdparty/jquery',"sap/ovp/cards/CommonUtils",'sap/ovp/cards/rta/SettingsDialogConstants',"sap/ovp/app/OVPUtils"],function(q,C,S,O){"use strict";function g(i,j,k,L){return i+"_sap.ovp.cards."+j+"."+k+"."+L;}function c(V){return{"type":"XTIT","maxLength":40,"value":{"":V}};}function a(){return{"i18n":"../i18n/i18n.properties"};}function b(i,j,k){var L=i+"["+j+"]";if(k){L+="/"+k;}return L;}function s(j,M){var k=M._getCardsModel();for(var i=0;i<k.length;i++){if(k[i].id===j){return true;}}return false;}function d(i,j,k){var L={"propertyPath":i,"operation":j};if(k){L["propertyValue"]=k;}return L;}function f(j){delete j.id;delete j.dashboardLayout;delete j.settings.baseUrl;delete j.settings.cloneCard;delete j.settings.newCard;delete j["customer.settings"];delete j["customer_base.settings"];delete j["vendor.settings"];if(j.settings["staticContent"]){for(var i=0;i<j.settings["staticContent"].length;i++){delete j.settings["staticContent"][i].id;}}}function e(N,i,j,k){if(j){if(N===C._getLayerNamespace()+".settings"){j[k]={operation:"DELETE"};}}else{if(N===C._getLayerNamespace()+".settings"){P.aEntityPropertyChange.push(d(i,"UPSERT",{operation:"DELETE"}));}else{P.aEntityPropertyChange.push(d(i,"DELETE"));}}}function h(i){P.aEntityPropertyChange.push(d(C._getLayerNamespace()+".settings","UPSERT",i[C._getLayerNamespace()+".settings"]));}function l(i,j,k,V,L,M){var N;var Q=C._getLayer();if(!P.oText){P.oText={};}if(!Q||Q===O.Layers.customer){N=g(P.sApplicationId,P.sCardId,i,k);P.oText[N]=c(V);}else{var R=false;for(var T in L.ai18nProperties){if(L.ai18nProperties[T].value===V){N=L.ai18nProperties[T].key;R=true;break;}}if(!R){N=g(P.sApplicationId,P.sCardId,i,k);}P.oText[N]=c(V);}if(M){M[k]="{{"+N+"}}";}else{var U=j+"/"+k;P.aEntityPropertyChange.push(d(U,"UPSERT","{{"+N+"}}"));}}function m(N,j,T,k){var L=this._oCardManifestSettings,M=this._oOriginalCardManifestSettings;for(var i=0;i<T.length;i++){if((!M[T[i]]&&L[T[i]])||(M[T[i]]&&L[T[i]]&&(M[T[i]]!=L[T[i]]))){if(k){l(N,N,T[i],L[T[i]],L,j[N]);}else{l(N,N,T[i],L[T[i]],L);}var Q=C._getLayer();if(!Q||Q===O.Layers.customer){j.settings[T[i]]=L[T[i]];}else{var R=S.oI18nValueProperty;if(R[T[i]]){j.settings[T[i]]=this._oCardManifestSettings[R[T[i]]];}else{j.settings[T[i]]=L[T[i]];}}}else if(!L[T[i]]&&M[T[i]]){if(k){e(N,N+"/"+T[i],j[N],T[i]);}else{e(N,N+"/"+T[i]);}delete j.settings[T[i]];}}}function n(i,j,V,k){var L=i+"/"+j;if(k){k[j]=V;}else{P.aEntityPropertyChange.push(d(L,"UPSERT",V));}}function o(N,j,k,L){var M=this._oCardManifestSettings,Q=this._oOriginalCardManifestSettings;for(var i=0;i<k.length;i++){if((!Q[k[i]]&&M[k[i]])||(Q[k[i]]&&M[k[i]]&&(Q[k[i]]!=M[k[i]]))){if(L){n(N,k[i],M[k[i]],j[N]);}else{n(N,k[i],M[k[i]]);}j.settings[k[i]]=M[k[i]];}else if(!M[k[i]]&&Q[k[i]]){if(L){e(N,N+"/"+k[i],j[N],k[i]);}else{e(N,N+"/"+k[i]);}delete j.settings[k[i]];}}}function p(N,i){var j=S.cardSettings["settings"],T=S.cardSettings["text"];if(N===C._getLayerNamespace()+".settings"){if(i[C._getLayerNamespace()+".settings"]){m.bind(this)(N,i,T,false);o.bind(this)(N,i,j,false);}else{i[C._getLayerNamespace()+".settings"]={};m.bind(this)(N,i,T,true);o.bind(this)(N,i,j,true);h(i);}}else{m.bind(this)(N,i,T,false);o.bind(this)(N,i,j,false);}}function r(N,k,L,T,M,Q){var R=this._oCardManifestSettings;var U=R[M];for(var i=0;i<U.length;i++){for(var j=0;j<T.length;j++){if(U[i][T[j]]){var V=b(N+"/"+M,i),W=N+"."+M+"."+i;if(Q){l(W,V,T[j],U[i][T[j]],R,k[N][M][i]);}else{l(W,V,T[j],U[i][T[j]],R,L[i]);}}}}if(!Q){n(N,M,L);}}function t(j,T){var k=S.cardSettingsArrayLevel[T]["onlyTabLevelProps"],L=false;for(var i=0;k&&i<k.length;i++){if(k[i]===j){L=true;break;}}return L;}function u(N,j,T,k,L,M){var Q=this._oCardManifestSettings,i;for(i=0;i<T.length;i++){if(Q[T[i]]&&!t(T[i],L)){if(M){l(N,N,T[i],Q[T[i]],Q,j[N]);}else{l(N,N,T[i],Q[T[i]],Q);}j.settings[T[i]]=Q[T[i]];}}for(i=0;i<k.length;i++){if(Q[k[i]]&&!t(k[i],L)){if(M){n(N,k[i],Q[k[i]],j[N]);}else{n(N,k[i],Q[k[i]]);}j.settings[k[i]]=Q[k[i]];}}if(M){e(N,N+"/"+L,j[N],L);}else{e(N,N+"/"+L);}delete j.settings[L];}function v(N,j,k,T,L,M,Q){var i;for(i=0;i<T.length;i++){if(j[N][T[i]]){if(Q){e(N,N+"/"+T[i],j[N],T[i]);}else{e(N,N+"/"+T[i]);}delete j.settings[T[i]];}}for(i=0;i<L.length;i++){if(j[N][L[i]]){if(Q){e(N,N+"/"+L[i],j[N],L[i]);}else{e(N,N+"/"+L[i]);}delete j.settings[L[i]];}}r.bind(this)(N,j,k,T,M,Q);}function w(j,T){return q.map(q.extend(true,{},j),function(k){var L=S.cardSettingsArrayLevel[T]["text"],i,M=S.cardSettingsArrayLevel[T]["settings"],N={};for(i=0;i<L.length;i++){if(k[L[i]]){N[L[i]]=k[L[i]];}}for(i=0;i<M.length;i++){if(k[M[i]]||k[M[i]]===""){N[M[i]]=k[M[i]];}}return N;});}function x(j,k,T,L){var M=S.cardSettingsArrayLevel[T]["checkForRemoval"],i,N;for(i=0;i<M.length;i++){if(!k[0][M[i]]){N=j.indexOf(M[i]);if(L==="remove"){if(N>-1){j.splice(N,1);}}else if(L==="add"){if(N===-1){j.push(M[i]);}}}}return j;}function y(N,i,j,k,T,L){var M=S.cardSettingsArrayLevel[T]["text"],Q=S.cardSettingsArrayLevel[T]["settings"],R=w(j,T);if(j&&k){i.settings[T]=w(j,T);if(N===C._getLayerNamespace()+".settings"){i[N][T]=w(j,T);}r.bind(this)(N,i,R,M,T,L);}else if(!j&&k){u.bind(this)(N,i,M,Q,T,L);}else if(j&&!k){i.settings[T]=w(j,T);if(N===C._getLayerNamespace()+".settings"){i[N][T]=w(j,T);}Q=x(Q,R,T,"remove");v.bind(this)(N,i,R,M,Q,T,L);Q=x(Q,R,T,"add");}}function z(N,i,j){var k=this._oCardManifestSettings["staticContent"],L=this._oOriginalCardManifestSettings["staticContent"],T=this._oCardManifestSettings["tabs"],M=this._oOriginalCardManifestSettings["tabs"];if(k||L){y.bind(this)(N,i,k,L,"staticContent",j);}else if(T||M){y.bind(this)(N,i,T,M,"tabs",j);}}function A(N,i){var j=S.cardSettingsForComplex["settings"],T=S.cardSettingsForComplex["text"];if(N===C._getLayerNamespace()+".settings"){if(i[C._getLayerNamespace()+".settings"]){m.bind(this)(N,i,T,false);o.bind(this)(N,i,j,false);z.bind(this)(N,i,false);}else{i[C._getLayerNamespace()+".settings"]={};m.bind(this)(N,i,T,true);o.bind(this)(N,i,j,true);z.bind(this)(N,i,true);h(i);}}else{m.bind(this)(N,i,T,false);o.bind(this)(N,i,j,false);z.bind(this)(N,i,false);}}function B(N,i){var j=this._oCardManifestSettings["staticContent"],k=this._oOriginalCardManifestSettings["staticContent"],T=this._oCardManifestSettings["tabs"],L=this._oOriginalCardManifestSettings["tabs"];if(j||k||T||L){A.bind(this)(N,i);}else{p.bind(this)(N,i);}}function D(i){var k=S.AllCardSettingsForKPICard,j,L=this._oCardManifestSettings,M={"model":C._getLayerNamespace()+".kpi_card_model_"+i.getTrimmedDataURIName(L.selectedKPI.ODataURI),"template":"sap.ovp.cards.charts.analytical","settings":{}};for(j=0;j<k.length;j++){if(L[k[j]]){M.settings[k[j]]=L[k[j]];}}return M;}function E(){var k=this._oCardManifestSettings["staticContent"],T=S.cardSettingsArrayLevel["staticContent"]["text"],i,j,L=S.cardSettingsArrayLevel["staticContent"]["settings"],M=this._oCardManifestSettings,N=S.cardSettingsForStaticLinkListCard,Q={"template":"sap.ovp.cards.linklist","settings":{"staticContent":[]}};for(j=0;j<N.length;j++){if(M[N[j]]){Q.settings[N[j]]=M[N[j]];}}for(j=0;j<k.length;j++){Q.settings["staticContent"].push({});for(i=0;i<T.length;i++){if(k[j][T[i]]){Q.settings["staticContent"][j][T[i]]=k[j][T[i]];}}for(i=0;i<L.length;i++){if(k[j][L[i]]){Q.settings["staticContent"][j][L[i]]=k[j][L[i]];}}}return Q;}function F(i){var k=S.NewCardSettings,L;var M=this._oCardManifestSettings;k.forEach(function(X){if(X.template===this._oCardManifestSettings.template){L=X;}}.bind(this));var N={"model":this._oCardManifestSettings.model,"template":L.template,"settings":{}};if(!this._oCardManifestSettings["tabs"]){var Q=L.cardSettings;var R=S.oI18nValueProperty;for(var j=0;j<Q.length;j++){if(!i.bAddNewCardFlag){if(M[Q[j]]){N.settings[Q[j]]=M[Q[j]];}}else{if(M[Q[j]]){if(R[Q[j]]){N.settings[Q[j]]=this._oCardManifestSettings[R[Q[j]]];}else{N.settings[Q[j]]=M[Q[j]];}}}}}else{var T=L.text;for(var j=0;j<T.length;j++){if(M[T[j]]){N.settings[T[j]]=M[T[j]];}}var U=this._oCardManifestSettings["tabs"],V=w(U,"tabs"),W=this._oCardManifestSettings.defaultViewSelected;N.settings["tabs"]=V;N.settings.selectedKey=W;}return N;}function G(i,T){var j=[];if(T){for(var k in T){var L=T[k];j.push({"key":k,"value":L.value[""],"textType":L.type});}if(j.length){writeToI18n("/"+i+"/webapp/i18n",j);}}}function H(L,M,N,Q){var T,i,j,k,R,U=N.settings["staticContent"],V=N.settings["tabs"];var W=S.cardSettingsWithText;var X=S.oI18nKeyValueProperty;for(i=0;i<W.length;i++){var Y;if(typeof W[i]=="string"){if(N.settings[W[i]]){if(!T){T={};}if(Q){if(!Q.bAddNewCardFlag){Y=g(L,M,"settings",W[i]);}else{for(var Z in X){if(W[i]===Z){Y=this._oCardManifestSettings[X[Z]]?this._oCardManifestSettings[X[Z]]:g(L,M,"settings",W[i]);break;}}}}else{Y=g(L,M,"settings",W[i]);}T[Y]=c(N.settings[W[i]]);N.settings[W[i]]="{{"+Y+"}}";}}else if(typeof W[i]=="object"){if(W[i].hasOwnProperty("staticContent")){if(U){for(j=0;j<U.length;j++){for(k=0;k<W[i]["staticContent"].length;k++){R=W[i]["staticContent"][k];if(U[j][R]){if(!T){T={};}Y=g(L,M,"settings.staticContent."+j,R);T[Y]=c(U[j][R]);N.settings["staticContent"][j][R]="{{"+Y+"}}";}}}}}else if(W[i].hasOwnProperty("tabs")){if(V){for(j=0;j<V.length;j++){for(k=0;k<W[i]["tabs"].length;k++){R=W[i]["tabs"][k];if(V[j][R]){if(!T){T={};}Y=g(L,M,"settings.tabs."+j,R);T[Y]=c(V[j][R]);N.settings["tabs"][j][R]="{{"+Y+"}}";}}}}}}}return T;}function I(M,j,k){var L=false;for(var i=0;i<k.length;i++){if(k[i].id!==j&&k[i].model===M){L=true;break;}}return L;}function J(i,T,j,k,V){var L={};L['appDescriptorChange']={'parameters':i};if(T){L['appDescriptorChange']['texts']=T;}if(k){L['flexibilityChange']={"newAppDescriptor":j,"oldAppDescriptor":k};}else{L['flexibilityChange']=j;}if(V){L['viewSwitchChange']=V;}return L;}function K(j,k){var L={card:{}},M={},N=j.oMainComponent,Q=N._getApplicationId(),R,T={},U=C._getLayer();if(j.bAddNewCardFlag){R=F.bind(this)(j);}else if(j.bNewStaticLinkListCardFlag){R=E.bind(this)(j);}else if(j.bNewKPICardFlag){R=D.bind(this)(j);}var V=C._getLayerNamespace()+k,i=1;while(s(V+"_N"+i,N)){i++;}V=V+"_N"+i;f(R);M=q.extend(true,{},R);M.id=V;if(this._oCardManifestSettings.selectedKPI){M.settings.selectedKPI=q.extend(true,{},this._oCardManifestSettings.selectedKPI);}T.oFlexCardManifest=M;T.oText=H.bind(this)(Q,V,R,j);if(U===O.Layers.vendor){G(Q,q.extend(true,{},T.oText));T.oText=a();}L.card[V]=R;T.oParameters=L;return T;}var P={sApplicationId:"",sCardId:"",aEntityPropertyChange:[],oText:undefined,getPayLoadForEditCard:function(i){var j=i.oAppDescriptor.id,k={"cardId":j},T,L,M=q.extend(true,{},i.oAppDescriptor),N=q.extend(true,{},i.oAppDescriptor),Q,V,R=C._getLayer();Q=(j.lastIndexOf(C._getLayerNamespace()+".",0)===0)?"settings":C._getLayerNamespace()+".settings";P.sApplicationId=i.sApplicationId;P.sCardId=j;P.aEntityPropertyChange=[];P.oText=undefined;B.bind(this)(Q,M);T=q.extend(true,{},P.oText);if(R===O.Layers.vendor){G(P.sApplicationId,P.oText);T=a();}L=P.aEntityPropertyChange;if(L.length===1){k["entityPropertyChange"]=L[0];}else{k["entityPropertyChange"]=L;}if(this._oCardManifestSettings["tabs"]){var U=this._oCardManifestSettings.defaultViewSelected,W=this._oOriginalCardManifestSettings.selectedKey;W=(W&&W>0)?W:1;if(U&&U>0&&U!==W){V={cardId:j,selectedKey:U,oldKey:W};}M.settings.selectedKey=U;}return J(k,T,M,N,V);},getPayLoadForCloneCard:function(j){return new Promise(function(k,L){var M={card:{}},T,N={},Q=j.getComponentInstance().getComponentData(),R=Q.mainComponent,U=R._getApplicationId(),V=q.extend(true,{},R._getCardFromManifest(Q.cardId)),W=C._getLayer();var X=C._getLayerNamespace()+"."+V.id,i=1;while(s(X+"_C"+i,R)){i++;}X=X+"_C"+i;f(V);N=q.extend(true,{},V);N.id=X;N.settings.title=N.settings.title+" "+i;V.settings.title=V.settings.title+" "+i;if(V.settings.defaultSpan&&V.settings.defaultSpan.showOnlyHeader){V.settings.defaultSpan.rows=12;}T=H(U,X,V);if(W===O.Layers.vendor){G(U,q.extend(true,{},T));T=a();}M.card[X]=V;k(J(M,T,N));});},getPayLoadForNewStaticLinkListCard:function(i){var j=K.bind(this)(i,".newStaticLinkListCard");return J(j.oParameters,j.oText,j.oFlexCardManifest);},getPayLoadForNewKPICard:function(i){var j=K.bind(this)(i,".newKPICard"),k=i.oAppComponent,L=j.oFlexCardManifest,M=j.oParameters,N=L.model+"_ANNO",Q=i.getDataSources(N),R=true,T=0;if(Q[N]){if(Q[N].uri!==this._oCardManifestSettings.selectedKPI.ModelURI){while(Q[N+"_"+T]){T++;}N=N+"_"+T;}else{R=false;}}var U=k.getModel(L.model);if(!U){M["model"]={};M["model"][L.model]={dataSource:L.model,settings:{"defaultCountMode":sap.ui.model.odata.CountMode.None}};M["dataSource"]={};M["dataSource"][L.model]={uri:this._oCardManifestSettings.selectedKPI.ODataURI,type:"OData",settings:{annotations:[N],localUri:""}};if(R){M["dataSource"][N]={uri:this._oCardManifestSettings.selectedKPI.ModelURI,type:"ODataAnnotation",settings:{localUri:""}};L.settings["sAnnoKey"]=N;}}var V=J(M,j.oText,j.oFlexCardManifest);if(R&&U){V["addODataAnnotation"]={'parameters':{"dataSourceId":L.model,"annotations":[N],"dataSource":{}}};V["addODataAnnotation"].parameters.dataSource[N]={uri:this._oCardManifestSettings.selectedKPI.ModelURI,type:"ODataAnnotation",settings:{localUri:""}};V['flexibilityChange'].settings["sAnnoKey"]=N;}return V;},getPayLoadForNewCard:function(i){var j=K.bind(this)(i,".newCard"),k=j.oParameters;if(i.newDataSource){var L=i.oAppComponent,M=j.oFlexCardManifest,N=i.newDataSourceModel.serviceAnnotation,Q=i.getDataSources(N),R=true,T=0;if(Q[N]){if(Q[N].uri!==i.newDataSourceModel.serviceAnnotationURI){while(Q[N+"_"+T]){T++;}N=N+"_"+T;}else{R=false;}}var U=L.getModel(M.model);if(!U){k["model"]={};k["model"][M.model]={dataSource:M.model,settings:{"defaultCountMode":sap.ui.model.odata.CountMode.None}};k["dataSource"]={};k["dataSource"][M.model]={uri:i.newDataSourceModel.serviceURI,type:"OData",settings:{annotations:[N],localUri:""}};if(R){k["dataSource"][N]={uri:i.newDataSourceModel.serviceAnnotationURI,type:"ODataAnnotation",settings:{localUri:""}};}}}return J(j.oParameters,j.oText,j.oFlexCardManifest);},getPayLoadForRemoveCard:function(i){var j={},k={},L=i.getComponentInstance().getComponentData(),M=L.cardId;j["cardId"]=M;k.id=i.getId();var N=J(j,null,k),Q=L.mainComponent.getUIModel().getProperty("/cards");if(!I(L.modelName,M,Q)&&!!L.modelName){N["removeDataSourceChange"]=[];var R=L.appComponent.getMetadata(),T=R.getManifestEntry("sap.ui5").models[L.modelName].dataSource,U=R.getManifestEntry("sap.app").dataSources[T].settings.annotations;U.forEach(function(V){N["removeDataSourceChange"].push({'parameters':{"dataSourceId":V}});});}return N;}};return P;},true);
