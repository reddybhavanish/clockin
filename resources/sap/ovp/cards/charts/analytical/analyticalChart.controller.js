sap.ui.define(["sap/ovp/cards/generic/Card.controller","sap/ui/thirdparty/jquery","sap/base/Log","sap/ovp/cards/charts/VizAnnotationManager","sap/viz/ui5/data/FlattenedDataset","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/app/resources","sap/base/util/each"],function(C,q,L,V,F,O,a,e){"use strict";return C.extend("sap.ovp.cards.charts.analytical.analyticalChart",{onInit:function(){C.prototype.onInit.apply(this,arguments);V.formatChartAxes();},onBeforeRendering:function(){if(this.bCardProcessed){return;}V.validateCardConfiguration(this);var v=this.getView().byId("analyticalChart");var c=this.getOwnerComponent().getComponentData();if(v){v.setHeight("21rem");}if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"&&c&&c.appComponent){var d=c.appComponent.getDashboardLayoutUtil();var o=d.dashboardLayoutModel.getCardById(c.cardId);if(o.dashboardLayout.autoSpan&&v){v.setHeight("21rem");}}var b=this.getView().byId("vbLayout");var n;var i=false;var D=new F({data:{path:"/"}});this.isVizPropSet=i;this.oDataSet=D;this.vizFrame=v;this.vbLayout=b;if(!v){L.error(V.constants.ERROR_NO_CHART+": ("+this.getView().getId()+")");}else{this.vbLayout.setBusy(true);n=v.getModel('ovpCardProperties').getProperty("/navigation");if(n===undefined||n=="datapointNav"||n!="headerNav"){V.getSelectedDataPoint(v,this);}v.destroyDataset();var f=v.getParent().getBinding("data");this._handleKPIHeader();if(f&&f.getPath()){f.attachDataReceived(q.proxy(this.onDataReceived,this));f.attachDataRequested(q.proxy(this.onDataRequested,this));}else{var g=sap.ui.xmlfragment("sap.ovp.cards.charts.generic.noData");var h=this.getCardContentContainer();h.removeAllItems();h.addItem(g);}v.addEventDelegate({onmouseover:function(){var j=v._oOvpVizFrameTooltip;if(j){j._oPopup.close();}}});}this.bCardProcessed=true;},onAfterRendering:function(){C.prototype.onAfterRendering.apply(this,arguments);if(!O.checkIfAPIIsUsed(this)&&this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var c=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var s=this.oDashboardLayoutUtil.getCardDomId(this.cardId);var b=document.getElementById(s);var h=this.getHeaderHeight();if(!c.dashboardLayout.autoSpan){if(b){var o=b.getElementsByClassName('sapOvpWrapper')[0];if(o){o.style.height=c.dashboardLayout.rowSpan*this.oDashboardLayoutUtil.ROW_HEIGHT_PX+2-(h+2*this.oDashboardLayoutUtil.CARD_BORDER_PX)+"px";}}}if(c.dashboardLayout.showOnlyHeader){b.classList.add("sapOvpMinHeightContainer");}var v=this.getView().byId("analyticalChart");if(v){v.setHeight(this._calculateVizFrameHeight()+"px");}}},onDataReceived:function(E){var t=this;var b=this.getView().byId("analyticalChart");var c=this.getView().byId("bubbleText");var d=this.getView().byId("ovpCT");var f=a.getText("BUBBLESIZE");this.oDataSet.bindData("analyticalmodel>/","");b.setDataset(this.oDataSet);var h=b.getParent();if(!this.isVizPropSet){V.buildVizAttributes(b,h,d,this);this.isVizPropSet=true;if(c!=undefined){var g=b.getFeeds();e(g,function(i,v){if(g[i].getUid()=="bubbleWidth"){c.setText(f+" "+g[i].getValues());}});}V.hideDateTimeAxis(b);}if(this.getCardPropertiesModel()&&this.getCardPropertiesModel().getData()&&this.getCardPropertiesModel().getData().colorPalette&&(b.getVizType()==="stacked_column")){var j=b.getDataset().getDimensions(),k=b.getFeeds(),l,o;for(var m=0;m<k.length;m++){if(k[m].getUid()==="color"){l=k[m].getValues()[0];break;}}for(var n=0;n<j.length;n++){if(j[n].getName()===l){o=j[n];break;}}if(l&&o){var s={};s["bDescending"]=true;o.setSorter(s);}}var p=this.getView().byId("ovpUoMTitle");var r=E?E.getParameter('data'):null;V.setChartUoMTitle(b,r,p);if(this.bFlag==true){this.bFlag=false;this.vbLayout.setBusy(false);}else{setTimeout(function(){t.vbLayout.setBusy(false);},0);}V.checkNoData(E,this.getCardContentContainer(),b);},onDataRequested:function(){this.vbLayout.setBusy(true);},getCardItemsBinding:function(){var v=this.getView().byId("analyticalChart");if(v&&v.getDataset()&&v.getDataset().getBinding("data")&&this.vbLayout){this.vbLayout.setBusy(false);}if(v&&v.getParent()){return v.getParent().getBinding("data");}return null;},resizeCard:function(n){var c=this.getCardPropertiesModel();this.newCardLayout=n;c.setProperty("/cardLayout/rowSpan",n.rowSpan);c.setProperty("/cardLayout/colSpan",n.colSpan);var o=this.getCardPropertiesModel().getProperty("/cardLayout");var h=this.getHeaderHeight();q(this.getView().$()).find(".sapOvpWrapper").css({height:(n.rowSpan*o.iRowHeightPx+2)-(h+2*o.iCardBorderPx)+"px"});var b=this.getView().byId("analyticalChart");var d=this.getView().byId("bubbleText");var f=this.getView().byId("ovpCT");if(b){if(b.getVizType()==='timeseries_bubble'||b.getVizType()==='bubble'){if(o.colSpan>1){d.setVisible(false);}else{d.setVisible(true);}}b.setHeight(this._calculateVizFrameHeight()+"px");}var g=this.getView().byId('ovpCardContentContainer').getDomRef();if(g){if(!n.showOnlyHeader){g.classList.remove('sapOvpContentHidden');}else{g.classList.add('sapOvpContentHidden');}}var j=a.getText("BUBBLESIZE");this.oDataSet.bindData("analyticalmodel>/","");this.vizFrame.setDataset(this.oDataSet);var k=b.getParent();if(!this.isVizPropSet){V.buildVizAttributes(b,k,f,this);this.isVizPropSet=true;if(d!=undefined){var l=b.getFeeds();e(l,function(i,v){if(l[i].getUid()=="bubbleWidth"){d.setText(j+" "+l[i].getValues());}});}V.hideDateTimeAxis(b);}V.reprioritizeContent(this.newCardLayout,b);},_calculateVizFrameHeight:function(){var v;var c=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var b=this.getView().byId("analyticalChart");if(c){var g=this.getView().getController();var d=this.getItemHeight(g,'toolbar');var h=this.getHeaderHeight();var i=this.getView().byId("ovpCT")?24:0;var B=(b.getVizType()==='timeseries_bubble'||b.getVizType()==="bubble")&&c.dashboardLayout.colSpan===1?43:0;v=c.dashboardLayout.rowSpan*this.oDashboardLayoutUtil.ROW_HEIGHT_PX+2-(h+2*this.oDashboardLayoutUtil.CARD_BORDER_PX+d+i+B+30);}return v;},refreshCard:function(){this.getView().rerender();}});});
