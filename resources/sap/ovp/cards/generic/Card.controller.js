sap.ui.define(["sap/ui/core/mvc/Controller","sap/ovp/cards/ActionUtils","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/generic/app/navigation/service/PresentationVariant","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/ui/core/ResizeHandler","sap/ui/core/format/NumberFormat","sap/ovp/cards/AnnotationHelper","sap/ui/model/odata/AnnotationHelper","sap/m/MessageBox","sap/ui/generic/app/navigation/service/NavError","sap/ui/core/CustomData","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/MessageToast","sap/ui/core/TextDirection","sap/ui/generic/app/library","sap/ui/thirdparty/jquery","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/base/Log","sap/ui/events/KeyCodes","sap/base/util/isPlainObject"],function(C,A,S,P,a,O,R,N,b,c,M,d,e,F,J,D,B,f,T,G,q,g,h,L,K,k){"use strict";return C.extend("sap.ovp.cards.generic.Card",{initKeyboardNavigation:function(){var j=function(i){this.init(i);};j.prototype.layoutItemFocusHandler=function(){var l=q(document.activeElement);if(l){var m=l.find("[aria-label]");var i,s="";if(l.find('.valueStateText').length==1){var t=l.find('.valueStateText').find('.sapMObjectNumberText').text();var v=l.find('.valueStateText').find('.sapUiInvisibleText').text();l.find('.valueStateText').attr('aria-label',t+" "+v);l.find('.valueStateText').attr('aria-labelledby',"");}l.find("[role='listitem']").attr('aria-label',"");if(l.hasClass('sapOvpCardHeader')&&!l.hasClass('sapOvpStackCardContent')){var n="";var o=l.find('.cardHeaderType');if(o.length===0){var p=g.getText("CardHeaderType");n="cardHeaderType_"+new Date().getTime();var r='<div id="'+n+'" class="cardHeaderType" aria-label="'+p+'" hidden></div>';l.append(r);}else{n=o[0].id;}s+=n+" ";}for(i=0;i<m.length;i++){if(m[i].getAttribute("role")==="heading"){s+=m[i].id+" ";}}if(l.hasClass('sapOvpCardHeader')){var u=l.find('.cardHeaderText');if(u.length!==0){for(var i=0;i<u.length;i++){if(s.indexOf(u[i].id)===-1){s+=u[i].id+" ";}}}}if(s.length){l.attr("aria-labelledby",s);}if(l.prop('nodeName')==="LI"&&l.find('.linkListHasPopover').length!==0){if(l.find('#hasDetails').length===0){l.append("<div id='hasDetails' hidden>"+g.getText("HAS_DETAILS")+"</div>");l.attr('aria-describedby',"hasDetails");}}var w=l.attr("id");if((w&&w.indexOf("ovpTable")!=-1)&&l.find("[role='Link']")&&!l.hasClass('sapUiCompSmartLink')){var x=l.closest("td").attr("data-sap-ui-column"),y=l.closest("tbody").siblings().children().filter("tr").children();for(var i=0;i<y.length;i++){if(y[i].getAttribute("data-sap-ui")==x&&y[i].hasChildNodes("span")){var z=y[i].firstElementChild.getAttribute("id");l.attr("aria-labelledby",z);}}}}};j.prototype.init=function(i){this.cardLayout=i;this.keyCodes=K;this.jqElement=q(i.getView().$());this.jqElement=this.jqElement.parent().parent().parent();this.jqElement.on("focus.keyboardNavigation",this.layoutItemFocusHandler.bind(this));};this.keyboardNavigation=new j(this);},onInit:function(){this.oCardComponent=this.getOwnerComponent();this.oCardComponentData=this.oCardComponent&&this.oCardComponent.getComponentData();this.oMainComponent=this.oCardComponentData&&this.oCardComponentData.mainComponent;this.sCardId=this.oCardComponentData.cardId;var s=this.getView().mPreprocessors.xml[0].ovpCardProperties.oData.state;if(s!=="Error"){var H=this.getView().byId("ovpCardHeader");if(!!H){H.attachBrowserEvent("click",this.onHeaderClick.bind(this));H.addEventDelegate({onkeydown:function(E){if(!E.shiftKey&&E.keyCode==13){E.preventDefault();this.onHeaderClick(E);}else if(!E.shiftKey&&E.keyCode==32){E.preventDefault();}}.bind(this)});H.addEventDelegate({onkeyup:function(E){if(!E.shiftKey&&E.keyCode==32){E.preventDefault();this.onHeaderClick(E);}}.bind(this)});}}var n=this.getView().byId("kpiNumberValue");if(n){n.addEventDelegate({onAfterRendering:function(){var $=n.$();var i=$.find(".sapMNCValueScr");var j=$.find(".sapMNCScale");i.attr("aria-label",i.text());j.attr("aria-label",j.text());var l=this.getView().byId("ovpCardHeader").getDomRef();var o=this.getOwnerComponent().getComponentData();if(!!o&&!!o.appComponent){var m=o.appComponent;if(!!m.getModel("ui")){var u=m.getModel("ui");if(!!u.getProperty("/containerLayout")&&u.getProperty("/containerLayout")==="resizable"){var p=o.appComponent.getDashboardLayoutUtil();if(!!p){p.setKpiNumericContentWidth(l);}}}}}.bind(this)});}},exit:function(){if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);}},onAfterRendering:function(){var o=this.getCardPropertiesModel();this.enableClick=true;var s=o.getProperty("/contentFragment");var i=this.getOwnerComponent().getComponentData();this._handleCountHeader();this._handleKPIHeader();var j=o.getProperty("/selectedKey");if(j&&o.getProperty("/state")!=='Loading'){var l=this.getView().byId("ovp_card_dropdown");if(l){l.setSelectedKey(j);}}try{var i=this.getOwnerComponent().getComponentData();if(i&&i.appComponent){var m=i.appComponent;if(m.getModel('ui')){var u=m.getModel('ui');if(u.getProperty('/containerLayout')==='resizable'){var n=m.getDashboardLayoutUtil();if(n){this.oDashboardLayoutUtil=n;this.cardId=i.cardId;if(n.isCardAutoSpan(i.cardId)){this.resizeHandlerId=R.register(this.getView(),function(W){L.info('DashboardLayout autoSize:'+W.target.id+' -> '+W.size.height);n.setAutoCardSpanHeight(W);});}}}}}}catch(p){L.error("DashboardLayout autoSpan check failed.");}if(this.oDashboardLayoutUtil&&this.oDashboardLayoutUtil.isCardAutoSpan(this.cardId)){var $=q("#"+this.oDashboardLayoutUtil.getCardDomId(this.cardId));if(this.oView.$().outerHeight()>$.innerHeight()){this.oDashboardLayoutUtil.setAutoCardSpanHeight(null,this.cardId,this.oView.$().height());}}var I=0;if(i&&i.mainComponent){var r=i.mainComponent;if(r.bGlobalFilterLoaded){I=this.checkNavigation();}}else if(O.checkIfAPIIsUsed(this)){I=this.checkAPINavigation();}var t=this.getCardPropertiesModel();var v=t.getProperty("/state");if(v!=="Loading"&&v!=="Error"){var w=t.getProperty("/template");if(w==="sap.ovp.cards.stack"){if(!I){var x=this.getView().byId('ViewAll');if(x){x=x.getDomRef();q(x).remove();}}}}if(I){if(s?s!=="sap.ovp.cards.quickview.Quickview":true){if(s==="sap.ovp.cards.stack.Stack"){var y=this.getView().getDomRef();var z=q(y).find('.sapOvpCardContentRightHeader');if(z.length!==0){z.addClass('sapOvpCardNavigable');}}else{this.getView().addStyleClass("sapOvpCardNavigable");}}if(s&&s==="sap.ovp.cards.quickview.Quickview"){var H=this.byId("ovpCardHeader");if(H){H.addStyleClass("sapOvpCardNavigable");}}}else{if(s){this.getView().addStyleClass("ovpNonNavigableItem");var H=this.byId("ovpCardHeader");if(H){H.$().removeAttr('role');H.addStyleClass('ovpNonNavigableItem');}var E=this.checkLineItemNavigation();if(!E){switch(s){case"sap.ovp.cards.list.List":var Q=this.getView().byId("listItem");if(Q){Q.setType("Inactive");}break;case"sap.ovp.cards.table.Table":var Q=this.getView().byId("tableItem");if(Q){Q.setType("Inactive");}break;case"sap.ovp.cards.linklist.LinkList":if(!this.checkNavigationForLinkedList()){var Q=this.getView().byId("ovpCLI");if(Q){Q.setType("Inactive");}}break;}}}}var U=this.getView().byId("ovp_card_dropdown");var V=this.getView().byId("ovp_card_dropdown_label");if(U){U.addAriaLabelledBy(V.getId());}if(O.checkIfAPIIsUsed(this)){this.initKeyboardNavigation();}},checkNavigation:function(){var o=this.getCardPropertiesModel();if(this.checkHeaderNavForChart()){return 0;}var E=this.getEntityType();if(E){if(o){var i=o.getProperty("/identificationAnnotationPath");var s=i;var j=o.getProperty("/contentFragment");if(j&&(j==="sap.ovp.cards.stack.Stack"||j==="sap.ovp.cards.quickview.Quickview")){var l=(i)?i.split(","):[];if(l&&l.length>1){if(j==="sap.ovp.cards.stack.Stack"){s=l[0];}else{s=l[1];}}}var r=E[s];if(this.isNavigationInAnnotation(r)){return 1;}if(o&&o.getProperty("/template")==="sap.ovp.cards.charts.analytical"){var m=o.getProperty("/kpiAnnotationPath");if(E&&m){var n=E[m];if(n&&n.Detail){var p=n.Detail.SemanticObject&&n.Detail.SemanticObject.String;var t=n.Detail.Action&&n.Detail.Action.String;if(p&&t){return 1;}}}}}}else if(o&&o.getProperty("/template")==="sap.ovp.cards.linklist"&&o.getProperty("/staticContent")&&o.getProperty("/targetUri")){return 1;}return 0;},checkNavigationForLinkedList:function(){if(this.getEntityType()){var E=this.getEntityType();var l=E['com.sap.vocabularies.UI.v1.LineItem'];if(l&&(l[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||l[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl")){return true;}}return false;},checkLineItemNavigation:function(){if(this.getEntityType()){var E=this.getEntityType();var o=this.getCardPropertiesModel();if(o){var s=o.getProperty("/annotationPath");var r=E[s];return this.isNavigationInAnnotation(r);}}},isNavigationInAnnotation:function(r){if(r&&r.length){for(var i=0;i<r.length;i++){var I=r[i];if(I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){return 1;}}}return 0;},checkAPINavigation:function(){var o=this.getOwnerComponent().getComponentData(),i=o.fnCheckNavigation&&typeof o.fnCheckNavigation==="function",j=i?o.fnCheckNavigation:null;if(j){if(j()){return true;}}else{if(this.checkNavigation()){return true;}}return false;},onHeaderClick:function(E){var n=E.ctrlKey||E.metaKey?h.constants.explace:h.constants.inplace;if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onHeaderClicked();}}else{var o=this.getCardPropertiesModel();var t=o.getProperty("/template");var s=o.getProperty("/targetUri");if(t=="sap.ovp.cards.linklist"&&o.getProperty("/staticContent")!==undefined&&s){window.location.href=s;}else if(o.getProperty("/staticContent")!==undefined&&s===""){return;}else if(this.checkHeaderNavForChart()){return;}else{this.doNavigation(this.getView().getBindingContext(),null,n);}}},checkHeaderNavForChart:function(){var o=this.getCardPropertiesModel();var t=o.getProperty("/template");var n=o.getProperty("/navigation");if(n=="noHeaderNav"&&(t=="sap.ovp.cards.charts.analytical"||"sap.ovp.cards.charts.smart.chart")){return true;}else{return false;}},resizeCard:function(i){L.info(i);if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);this.resizeHandlerId=null;}},_handleCountHeader:function(){var i=this.getView().byId("ovpCountHeader");if(i){var I=this.getCardItemsBinding();if(I){if(I.getLength()>0){this.setHeaderCounter(I,i);}I.attachDataReceived(function(){this.setHeaderCounter(I,i);}.bind(this));I.attachChange(function(){this.setHeaderCounter(I,i);}.bind(this));}}},setHeaderCounter:function(i,j){var t=i.getLength();var l=i.getCurrentContexts().length;var o,m="";var n=N.getIntegerInstance({minFractionDigits:0,maxFractionDigits:1,decimalSeparator:".",style:"short"});l=parseFloat(l,10);var p=this.getOwnerComponent().getComponentData();if(p&&p.appComponent){var r=p.appComponent;if(r.getModel('ui')){var u=r.getModel('ui');if(u.getProperty('/containerLayout')!=='resizable'){if(t!==0){t=n.format(Number(t));}if(l!==0){l=n.format(Number(l));}}else{o=r.getDashboardLayoutUtil().dashboardLayoutModel.getCardById(p.cardId);}}}if(l===0){m="";}else if(o&&o.dashboardLayout.showOnlyHeader){m=g.getText("Count_Header_Total",[t]);}else if(t!=l){m=g.getText("Count_Header",[l,t]);}j.setText(m);var s=j.$();s.attr("aria-label",m);},_handleKPIHeader:function(){var i,s;if(this.getView()&&this.getView().getDomRef()){i=this.getView().getDomRef().getElementsByClassName("numericContentHbox");s=this.getView().getDomRef().getElementsByClassName("noDataSubtitle");}else{return;}if(i||s){var o=this.getKPIBinding();if(o){o.attachDataReceived(function(E){var U=E.getParameter("data")&&E.getParameter("data").results&&E.getParameter("data").results[0];var t=o.getLength();if(i[0]){i[0].style.visibility=null;if(t===0){i[0].style.visibility='hidden';}else{this._setSubTitleWithUnitOfMeasure(U);i[0].style.visibility='visible';}}if(s.length!==0){s[0].style.display="none";if(t===0){s[0].style.display="flex";}}}.bind(this));}}},getKPIBinding:function(){var n=this.byId("kpiHBoxNumeric"),o=n&&n.getBindingInfo("items")&&n.getBindingInfo("items").binding;return o;},_setSubTitleWithUnitOfMeasure:function(U){var o=this.getCardPropertiesModel();if(!!o){var i=o.getData();var s=this.getView().byId("SubTitle-Text");if(!!s){s.setText(i.subTitle);if(!!i&&!!i.entityType&&!!i.dataPointAnnotationPath){var E=o.getData().entityType;var j=i.dataPointAnnotationPath.split("/");var l=j.length===1?E[i.dataPointAnnotationPath]:E[j[0]][j[1]];var m;if(l&&l.Value&&l.Value.Path){m=l.Value.Path;}else if(l&&l.Description&&l.Description.Value&&l.Description.Value.Path){m=l.Description.Value.Path;}if(!!m){var p=a.getUnitColumn(m,E);var u;if(!!p&&!!U){u=U[p];}else{u=a.getUnitColumn(m,E,true);}var n=g.getText("SubTitle_IN");if(!!i.subTitle&&!!n&&!!u){s.setText(i.subTitle+" "+n+" "+u);var r=s.getAggregation("customData");if(r){var t;for(t in r){var v=r[t];if(v.getKey()==="aria-label"){v.setValue(i.subTitle+" "+n+" "+u);break;}}}}}}}}},getCardItemsBinding:function(){},onActionPress:function(E){var s=E.getSource(),o=this._getActionObject(s),i=s.getBindingContext();if(o.type.indexOf("DataFieldForAction")!==-1){this.doAction(i,o);}else{this.doNavigation(i,o);}},_getActionObject:function(s){var j=s.getCustomData();var o={};for(var i=0;i<j.length;i++){o[j[i].getKey()]=j[i].getValue();}return o;},doNavigation:function(o,n,s){if(!s){s=h.constants.inplace;}if(!this.enableClick){return;}this.enableClick=false;setTimeout(function(){this.enableClick=true;}.bind(this),1000);if(!this.oMainComponent){return;}if(!n){n=this.getEntityNavigationEntries(o)[0];}var i=q.extend(true,{},o);var j=q.extend(true,{},n);var l=this.oMainComponent.doCustomNavigation&&this.oMainComponent.doCustomNavigation(this.sCardId,i,j);var E=this.oMainComponent.templateBaseExtension&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation(this.sCardId,i,j);var m;if(l){m=l;}if(E){m=E;}if(m){var t=m.type;if(t&&typeof t==="string"&&t.length>0){t=t.split(".").pop().split("/").pop().toLowerCase();switch(t){case"datafieldwithurl":m.type="com.sap.vocabularies.UI.v1.DataFieldWithUrl";break;case"datafieldforintentbasednavigation":m.type="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation";break;}n=m;}}function p(s){if(!s){s=h.constants.inplace;}if(n){switch(n.type){case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":this.doNavigationWithUrl(o,n,s);break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":this.doIntentBasedNavigation(o,n,false,s);break;case"com.sap.vocabularies.UI.v1.KPIDetailType":this.doIntentBasedNavigation(o,n,false,s);break;}}}if(!this.oMainComponent.oAppStatePromise){p.call(this,s);}else{this.oMainComponent.oAppStatePromise.then(p.bind(this,s));}},doNavigationWithUrl:function(o,n,s){if(!s){s=h.constants.inplace;}if(!sap.ushell.Container){return;}var p=sap.ushell.Container.getService("URLParsing");if(!(p.isIntentUrl(n.url))){window.open(n.url);}else{var i=p.parseShellHash(n.url);var w=i.appSpecificRoute?true:false;this.doIntentBasedNavigation(o,i,w,s);}},fnHandleError:function(E){if(E instanceof d){if(E.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){M.show(g.getText("OVP_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:g.getText("OVP_GENERIC_ERROR_TITLE")});}else{M.show(E.getErrorCode(),{title:g.getText("OVP_GENERIC_ERROR_TITLE")});}}},doCrossApplicationNavigation:function(I,n){var s="#"+I.semanticObject+'-'+I.action;if(I.params){var o=this.oCardComponent&&this.oCardComponent.getComponentData();var l=o&&o.appComponent;if(l){var p=l._formParamString(I.params);s=s+p;}}var t=this;if(!sap.ushell.Container){return;}sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported([s]).done(function(r){if(r[s].supported===true){if(!!n.params){if(typeof n.params=='string'){try{n.params=JSON.parse(n.params);}catch(m){L.error("Could not parse the Navigation parameters");return;}}}var o=t.getOwnerComponent().getComponentData();var u=o?o.globalFilter:undefined;var U=u&&u.getUiState({allFilters:false});var v=U?JSON.stringify(U.getSelectionVariant()):"{}";u=q.parseJSON(v);var w=t._getFilterPreference();u=t._removeFilterFromGlobalFilters(w,u);if(!n.params){n.params={};}if(!!u&&!!u.SelectOptions){for(var i=0;i<u.SelectOptions.length;i++){var x=u.SelectOptions[i].Ranges;if(!!x){var y=[];for(var j=0;j<x.length;j++){if(x[j].Sign==="I"&&x[j].Option==="EQ"){y.push(x[j].Low);}}n.params[u.SelectOptions[i].PropertyName]=y;}}}sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(n);}else{var E=new d("NavigationHandler.isIntentSupported.notSupported");t.fnHandleError(E);}}).fail(function(){L.error("Could not get authorization from isIntentSupported");});},doIntentBasedNavigation:function(o,i,u,n){if(!n){n=h.constants.inplace;}if(sap.ushell&&!sap.ushell.Container){return;}var p,j,l,E=o?o.getObject():null;var m=this.getCardPropertiesModel(),s=m.getProperty("/customParams");if(o&&typeof o.getAllData==="function"&&s){l=o.getAllData();}else if(m.getProperty("/staticContent")){l={iStaticLinkListIndex:i.iStaticLinkListIndex,bStaticLinkListIndex:true};}if(E&&E.__metadata){delete E.__metadata;}var r=a.getNavigationHandler();if(r){if(i){p=this._getEntityNavigationParameters(E,l,o);j={target:{semanticObject:i.semanticObject,action:i.action},appSpecificRoute:i.appSpecificRoute,params:p.sNavSelectionVariant};var t={};if(p.sNavPresentationVariant){t.presentationVariant=p.sNavPresentationVariant;}if(u){if(i&&i.semanticObject&&i.action){var v=this.getCardPropertiesModel().getProperty("/staticParameters");j.params=(!!v)?v:{};this.doCrossApplicationNavigation(i,j);}}else{r.navigate(j.target.semanticObject,j.target.action,j.params,null,this.fnHandleError,t,n);}}}},doAction:function(o,i){this.actionData=A.getActionInfo(o,i,this.getEntityType());if(this.actionData.allParameters.length>0){this._loadParametersForm();}else{this._callFunction();}},getEntityNavigationEntries:function(o,s){var n=[];var E=this.getEntityType();var j=this.getCardPropertiesModel();var l=j.getProperty("/template");if(!E){return n;}if(!s&&!o){if(!this.oCardComponentData.settings.identificationAnnotationPath){var m=j.getProperty("/kpiAnnotationPath");if(m&&l==="sap.ovp.cards.charts.analytical"){s=m;var r=E[s];var p=r&&r.Detail;var t=p.SemanticObject&&p.SemanticObject.String;var u=p.Action&&p.Action.String;if(p.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){if(t&&u){n.push({type:p.RecordType,semanticObject:t,action:u,label:""});}else{L.error("Invalid Semantic object and action configured for annotation "+p.RecordType);}}}}}if(!s){var I=j.getProperty("/identificationAnnotationPath");var v=(I)?I.split(","):[];if(v&&v.length>1){s=v[0];}else{s=I;}}var w=E[s];if(Array.isArray(w)){w=b.sortCollectionByImportance(w);for(var i=0;i<w.length;i++){if(w[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){n.push({type:w[i].RecordType,semanticObject:w[i].SemanticObject.String,action:w[i].Action.String,label:w[i].Label?w[i].Label.String:null});}if(w[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"&&!w[i].Url.UrlRef){var x=this.getView().getModel();var y=x.oMetaModel;var z=y.createBindingContext(E.$path);var H=c.format(z,w[i].Url);var Q=new e({key:"url",value:H});if(o&&l==="sap.ovp.cards.charts.analytical"){x=o.getModel();}Q.setModel(x);Q.setBindingContext(o);var U=Q.getValue();n.push({type:w[i].RecordType,url:U,value:w[i].Value.String,label:w[i].Label?w[i].Label.String:null});}}}return n;},getModel:function(){return this.getView().getModel();},getMetaModel:function(){if(this.getModel()){return this.getModel().getMetaModel();}},getCardPropertiesModel:function(){if(!this.oCardPropertiesModel||q.isEmptyObject(this.oCardPropertiesModel)){this.oCardPropertiesModel=this.getView().getModel("ovpCardProperties");}return this.oCardPropertiesModel;},getEntitySet:function(){if(!this.entitySet){var E=this.getCardPropertiesModel().getProperty("/entitySet");this.entitySet=this.getMetaModel().getODataEntitySet(E);}return this.entitySet;},getEntityType:function(){if(!this.entityType){if(this.getMetaModel()&&this.getEntitySet()){this.entityType=this.getMetaModel().getODataEntityType(this.getEntitySet().entityType);}}return this.entityType;},getCardContentContainer:function(){if(!this.cardContentContainer){this.cardContentContainer=this.getView().byId("ovpCardContentContainer");}return this.cardContentContainer;},_processCustomParameters:function(o,s,j){var l=this.getCardPropertiesModel();if(!this.oMainComponent||!l){return;}var m;if(o&&o.bStaticLinkListIndex){var n=l.getProperty("/staticContent");m=n[o.iStaticLinkListIndex]["customParams"];o=null;}else{m=l.getProperty("/customParams");}if(!m||!this.oMainComponent.templateBaseExtension.provideCustomParameter||!this.oMainComponent.onCustomParams){return;}var p=this.oMainComponent.templateBaseExtension.provideCustomParameter(m)?this.oMainComponent.templateBaseExtension.provideCustomParameter(m):this.oMainComponent.onCustomParams(m);if(!p||!q.isFunction(p)){return;}var r=q.extend(true,{},o);var t=q.extend(true,{},s);var u=p(r,t);if(!u||(!Array.isArray(u)&&!k(u))){return;}var I=k(u);if(I&&q.isEmptyObject(u)){return;}var v=I&&(u.bIgnoreEmptyString||u.ignoreEmptyString);var w=I?(u.aSelectionVariant||u.selectionVariant):u;if(!Array.isArray(w)){return;}var i,x,y,z,V,E;x=w.length;for(i=0;i<x;i++){y=w[i];if(!y){continue;}z=y.path;V=y.value1;E=y.value2;if(!z||typeof z!=="string"||z===""){L.error("Custom Variant property path '"+z+"' should be valid string");continue;}if(!(V||V===0||(V===""&&v))){continue;}V=V.toString();E=E&&E.toString();if(V===""&&v){s.removeSelectOption(z);}if(o){delete o[z];}if(j){delete j[z];}s.addSelectOption(z,y.sign,y.operator,V,E);}if(v){this._removeEmptyStringsFromSelectionVariant(s);}return v;},_getEntityNavigationParameters:function(E,o,j){var l={};var s,p,m;var n=this.getOwnerComponent().getComponentData();var r=n?n.globalFilter:undefined;var t=this.getCardPropertiesModel();var u=t&&t.getProperty("/staticContent");if(!u){var v=b.getCardSelections(this.getCardPropertiesModel());var w=v.filters;var x=v.parameters;var y=this.getEntityType();w&&w.forEach(function(e1){e1.path=e1.path.replace("/",".");switch(e1.operator){case F.NE:e1.operator=F.EQ;e1.sign="E";break;case F.Contains:e1.operator="CP";var f1=e1.value1;e1.value1="*"+f1+"*";break;case F.EndsWith:e1.operator="CP";var f1=e1.value1;e1.value1="*"+f1;break;case F.StartsWith:e1.operator="CP";var f1=e1.value1;e1.value1=f1+"*";}});v.filters=w;if(j&&E&&E.hasOwnProperty("$isOthers")){var z=j.getOtherNavigationDimensions();for(var H in z){var I=z[H];for(var i=0;i<I.length;i++){v.filters.push({path:H,operator:"EQ",value1:I[i],sign:"E"});}}}x&&x.forEach(function(e1){e1.path=e1.path.replace("/",".");});v.parameters=x;var Q=b.getCardSorters(this.getCardPropertiesModel());if(E){var H;for(var i=0;y.property&&i<y.property.length;i++){H=y.property[i].name;var U=E[H];if(E.hasOwnProperty(H)){if(Array.isArray(E[H])&&E[H].length===1){l[H]=E[H][0];}else if(q.type(U)!=="object"){l[H]=U;}}}}var V=t&&t.getProperty("/kpiAnnotationPath");var W=t&&t.getProperty("/template");if(V&&W==="sap.ovp.cards.charts.analytical"){var X=y[V];var Y=X&&X.Detail;if(Y&&Y.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){l["kpiID"]=X.ID.String;}}p=Q&&new P(Q);s=this._buildSelectionVariant(r,v);m=t&&t.getProperty("/staticParameters");}else{var Z=r&&r.getUiState({allFilters:false});var $=Z?JSON.stringify(Z.getSelectionVariant()):"{}";s=new S($);var _=this._getFilterPreference();s=this._removeFilterFromGlobalFilters(_,s);if(u[o.iStaticLinkListIndex].params){m=u[o.iStaticLinkListIndex].params;}else if(u[o.iStaticLinkListIndex].staticParameters){m=u[o.iStaticLinkListIndex].staticParameters;}}var a1;if(o&&!o.bStaticLinkListIndex){a1=this._processCustomParameters(o,s,l);}else if(o&&o.bStaticLinkListIndex){a1=this._processCustomParameters(o,s);}else{a1=this._processCustomParameters(l,s);}var b1=a1?G.navigation.service.SuppressionBehavior.ignoreEmptyString:undefined;if(m){for(var H in m){if(!l.hasOwnProperty(H)){l[H]=m[H];}}}var c1=a.getNavigationHandler();var d1=c1&&c1.mixAttributesAndSelectionVariant(l,s.toJSONString(),b1);if(!u){this._removeSensitiveAttributesFromNavSelectionVariant(y,d1);}return{sNavSelectionVariant:d1?d1.toJSONString():null,sNavPresentationVariant:p?p.toJSONString():null};},_removeSensitiveAttributesFromNavSelectionVariant:function(E,n){for(var i=0;i<E.property.length;i++){if(E.property[i]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]&&E.property[i]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"].Bool){delete n._mSelectOptions[E.property[i].name];}}},_removeEmptyStringsFromSelectionVariant:function(s){var p=s.getParameterNames();for(var i=0;i<p.length;i++){if(s.getParameter(p[i])===""){s.removeParameter(p[i]);}}var l=s.getSelectOptionsPropertyNames();for(i=0;i<l.length;i++){var m=s.getSelectOption(l[i]);for(var j=0;j<m.length;j++){if(m[j].Low===""&&!m[j].High){m.splice(j,1);j--;}}if(m.length===0){s.removeSelectOption(l[i]);}}return s;},_checkIfCardFiltersAreValid:function(m,p){var i=true;if(m&&m.filterAll==="global"){i=false;}else if(m&&m.globalFilter){if(m.globalFilter.indexOf(p)>=0){i=false;}}return i;},_getFilterPreference:function(){var o=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;var m;if(o&&o.mainComponent){m=o.mainComponent._getFilterPreference(o.cardId);}return m;},_removeFilterFromGlobalFilters:function(m,s){var i=[];if(m&&m.filterAll==="card"){i=s.getSelectOptionsPropertyNames();}else if(m&&m.cardFilter){i=m.cardFilter;}i.forEach(function(p){if(p!=="$.basicSearch"){s.removeSelectOption(p);}});return s;},_buildSelectionVariant:function(o,l){var u=o&&o.getUiState({allFilters:false});var s=u?JSON.stringify(u.getSelectionVariant()):"{}";var m=new S(s);var n,v,V,p;var r=this._getFilterPreference();m=this._removeFilterFromGlobalFilters(r,m);var t=l.filters;var w=l.parameters;for(var i=0;i<t.length;i++){n=t[i];if(n.path&&n.operator&&typeof n.value1!=="undefined"){v=n.value1.toString();V=(typeof n.value2!=="undefined")?n.value2.toString():undefined;if(this._checkIfCardFiltersAreValid(r,n.path)){m.addSelectOption(n.path,n.sign,n.operator,v,V);}}}var x,y,z;for(var j=0;j<w.length;j++){p=w[j];if(!p.path||!p.value){continue;}x=p.path.split("/").pop();x=x.split(".").pop();if(x.indexOf("P_")===0){y=x;z=x.substr(2);}else{y="P_"+x;z=x;}if(m.getParameter(y)){continue;}if(m.getParameter(z)){continue;}m.addParameter(x,p.value);}return m;},_loadParametersForm:function(){var p=new J();p.setData(this.actionData.parameterData);var t=this;var o=new D('ovpCardActionDialog',{title:this.actionData.sFunctionLabel,afterClose:function(){o.destroy();}}).addStyleClass("sapUiNoContentPadding");var i=new B({text:this.actionData.sFunctionLabel,press:function(E){var n=A.getParameters(E.getSource().getModel(),t.actionData.oFunctionImport);o.close();t._callFunction(n,t.actionData.sFunctionLabel);}});var j=new B({text:"Cancel",press:function(){o.close();}});o.setBeginButton(i);o.setEndButton(j);var l=function(E){var n=A.mandatoryParamsMissing(E.getSource().getModel(),t.actionData.oFunctionImport);i.setEnabled(!n);};var m=A.buildParametersForm(this.actionData,l);o.addContent(m);o.setModel(p);o.open();},_callFunction:function(u,i){var p={batchGroupId:"Changes",changeSetId:"Changes",urlParameters:u,forceSubmit:true,context:this.actionData.oContext,functionImport:this.actionData.oFunctionImport};var t=this;var o=new Promise(function(r,j){var m=t.actionData.oContext.getModel();var s;s="/"+p.functionImport.name;m.callFunction(s,{method:p.functionImport.httpMethod,urlParameters:p.urlParameters,batchGroupId:p.batchGroupId,changeSetId:p.changeSetId,headers:p.headers,success:function(l,n){r(n);},error:function(l){l.actionText=i;j(l);}});});o.then(function(r){return f.show(g.getText("Toast_Action_Success"),{duration:1000});},function(E){var j=a.showODataErrorMessages(E);if(j===""&&E.actionText){j=g.getText("Toast_Action_Error")+' "'+E.actionText+'"'+".";}return M.error(j,{title:g.getText("OVP_GENERIC_ERROR_TITLE"),onClose:null,styleClass:"",initialFocus:null,textDirection:T.Inherit});});},setErrorState:function(){var o=this.getOwnerComponent();if(!o||!o.oContainer){return;}var i=o.oContainer;var j=this.getCardPropertiesModel();var l={name:"sap.ovp.cards.loading",componentData:{model:this.getView().getModel(),settings:{category:j.getProperty("/category"),title:j.getProperty("/title"),description:j.getProperty("/description"),entitySet:j.getProperty("/entitySet"),state:h.loadingState.ERROR,template:j.getProperty("/template")}}};var m=sap.ui.component(l);i.setComponent(m);setTimeout(function(){o.destroy();},0);},changeSelection:function(s,i,o){if(!i){var j=this.getView().byId("ovp_card_dropdown");s=parseInt(j.getSelectedKey(),10);}var t={};if(!i){t=this.getCardPropertiesModel().getProperty("/tabs")[s-1];}else{t=o.tabs[s-1];}var u={cardId:this.getOwnerComponent().getComponentData().cardId,selectedKey:s};for(var p in t){u[p]=t[p];}if(O.checkIfAPIIsUsed(this)){O.recreateCard(u,this.getOwnerComponent().getComponentData());}else{this.getOwnerComponent().getComponentData().mainComponent.recreateCard(u);this.getOwnerComponent().getComponentData().mainComponent.setOrderedCardsSelectedKey(this.getOwnerComponent().getComponentData().cardId,s);}},getItemHeight:function(o,s,i){if(!!o){var j=o.getView().byId(s);var H=0;if(!!j){if(i){if(j.getItems()[0]&&j.getItems()[0].getDomRef()){H=q(j.getItems()[0].getDomRef()).outerHeight(true);}}else{if(j.getDomRef()){H=q(j.getDomRef()).outerHeight(true);}}}return H;}},getHeaderHeight:function(){var H=this.getItemHeight(this,'ovpCardHeader'),o=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;if(o&&o.appComponent){var i=o.appComponent.getDashboardLayoutUtil(),j=i.getDashboardLayoutModel().getCardById(o.cardId);if(H!==0){j.dashboardLayout.headerHeight=H;}}return H;}});});
