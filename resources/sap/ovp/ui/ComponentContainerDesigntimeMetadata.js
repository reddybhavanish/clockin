/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ovp/cards/CommonUtils","sap/ovp/cards/SettingsUtils","sap/ui/dt/plugin/ElementMover","sap/ui/dt/OverlayRegistry",'sap/ui/dt/OverlayUtil','sap/ui/rta/plugin/Plugin','sap/ui/rta/util/BindingsExtractor','sap/ui/dt/MetadataPropagationUtil','sap/ui/rta/Utils',"sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/base/Log"],function(q,C,S,E,O,a,P,B,M,U,b,c,L){"use strict";var A=C.getApp();var i=false;var _=function(){var u="https://"+window.location.host+"/sap/opu/odata/SSB/SMART_BUSINESS_DESIGNTIME_SRV/KPIs";q.ajax({type:"GET",url:u,dataType:"json",async:false,headers:"",success:function(m,t,n){var D={'d':{'results':[]}};D.d.results=m.d.results.filter(function(K){return!!K.ModelURI;});i=(D.d.results.length>0);if(i){var p=new sap.ui.model.json.JSONModel();p.setData(D);A.getView().setModel(p,"JSONModelForSSB");}},error:function(m){L.error(m);}});};_();var e=new E(),d=function(m){m.setTargetZone(false);},f=function(m){m.setTargetZone(true);},g=function(t){var m=t.getAggregationOverlays();var p=m.filter(function(n){return n.isTargetZone();});if(p.length>0){return p[0];}else{return null;}},h=function(t){var m=e.getMovedOverlay();if(!m){return false;}var r=false;if(!(t.getElement()===m.getElement())){var T=g(t);if(T){r=true;}else if(a.isInTargetZoneAggregation(t)){r=true;}}if(r){m.setSelected(true);setTimeout(function(){m.focus();},0);}return r;},j=function(m,n){var p=m.getAggregationOverlays();p.forEach(function(r){n(r);});},k=function(m,n){var p=O.getOverlay(m),r=p.getParentElementOverlay(),t=a.findAllSiblingOverlaysInContainer(p,r);t.forEach(function(u){j(u,n);});};var l=E.prototype.checkTargetZone;E.prototype.checkTargetZone=function(m,n,p){var r=n?n:this.getMovedOverlay();var t=l.apply(this,arguments);if(!t){return Promise.resolve(false);}var u=r.getElement();var T=m.getParent();var v=r.getRelevantContainer();var w=T.getElement();var x=m.getDesignTimeMetadata();var y=M.getRelevantContainerForPropagation(x.getData(),u);y=y?y:w;if(!v||!y||!P.prototype.hasStableId(T)||v!==y){return Promise.resolve(false);}if(r.getParent().getElement()!==w){var z=B.getBindings(u,u.getModel());if(Object.keys(z).length>0&&u.getBindingContext()&&w.getBindingContext()){var D=U.getEntityTypeByPath(u.getModel(),u.getBindingContext().getPath());var F=U.getEntityTypeByPath(w.getModel(),w.getBindingContext().getPath());if(!(D===F)){return Promise.resolve(false);}}}return Promise.resolve(true);};E.prototype.deactivateAllTargetZones=function(m){k(m,d);};E.prototype.activateAllValidTargetZones=function(m){k(m,f);};var o={name:{singular:b.getText("Card"),plural:b.getText("Cards")},actions:{remove:{name:b.getText("OVP_KEYUSER_MENU_HIDE_CARD"),changeType:"hideCardContainer",changeOnRelevantContainer:true},reveal:{changeType:"unhideCardContainer",changeOnRelevantContainer:true,getLabel:function(m){var n=this._getCardId(m.getId()),p=this._getCardFromManifest(n);if(p){var r=p.settings;if(r.title){return r.title;}else if(r.category){return(r.category);}else if(r.subTitle){return r.subTitle;}return p.cardId;}else{L.error("Card id "+n+" is not present in the manifest");return"";}}.bind(A)}}};var s=C._getLayer();o.actions["settings"]=function(m){if(!m.getComponentInstance()){return{};}var n=m.getComponentInstance().getComponentData(),p=n.mainComponent,r=p._getCardFromManifest(n.cardId);if(!r||!C.checkIfCardTypeSupported(r.template)){return{};}var t={"EditCard":{icon:"sap-icon://edit",name:b.getText("OVP_KEYUSER_MENU_EDIT_CARD"),isEnabled:function(u){return true;},changeOnRelevantContainer:true,handler:S.fnEditCardHandler},"CloneCard":{icon:"sap-icon://value-help",name:b.getText("OVP_KEYUSER_MENU_CLONE_CARD"),isEnabled:function(u){return true;},handler:S.fnCloneCardHandler}};if(!s||s===c.Layers.customer){t["Cut"]={icon:"sap-icon://scissors",name:b.getText("OVP_KEYUSER_MENU_CUT_CARD"),isEnabled:function(u){return true;},changeOnRelevantContainer:true,handler:function(u,G){var v=O.getOverlay(u),w=e.getMovedOverlay();if(w){w.removeStyleClass("sapUiDtOverlayCutted");e.setMovedOverlay(null);e.deactivateAllTargetZones(u);}e.setMovedOverlay(v);v.addStyleClass("sapUiDtOverlayCutted");e.activateAllValidTargetZones(u);return Promise.resolve([]).then(function(){return[];});}};t["Paste"]={icon:"sap-icon://paste",name:b.getText("OVP_KEYUSER_MENU_PASTE_CARD"),isEnabled:function(u){var v=O.getOverlay(u),T=g(v);return!!((T)||(a.isInTargetZoneAggregation(v)));},changeOnRelevantContainer:true,handler:function(u,G){var v=O.getOverlay(u),w=e.getMovedOverlay();if(w){var x=w.getElement(),T=v.getElement(),y=a.getParentInformation(w),z=a.getParentInformation(v),D=u.getComponentInstance().getComponentData().mainComponent,F=D.getLayout(),H=D.getUIModel(),I={},J={},K=[];if(H.getProperty('/containerLayout')==='resizable'){var N=F.getDashboardLayoutModel(),Q=D._getCardId(x.getId()),R=D._getCardId(u.getId()),V=N.getCardById(Q),W=N.getCardById(R),X=N.getColCount(),Y='C'+X,Z=[];I.cardId=Q;I.dashboardLayout={};I.dashboardLayout[Y]={row:W.dashboardLayout.row,oldRow:V.dashboardLayout.row,column:W.dashboardLayout.column,oldColumn:V.dashboardLayout.column};if(W.dashboardLayout.column+V.dashboardLayout.colSpan>X+1){I.dashboardLayout[Y].colSpan=W.dashboardLayout.colSpan;I.dashboardLayout[Y].oldColSpan=V.dashboardLayout.colSpan;I.dashboardLayout[Y].rowSpan=V.dashboardLayout.rowSpan;I.dashboardLayout[Y].oldRowSpan=V.dashboardLayout.rowSpan;}K.push({selectorControl:u.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"dragOrResize",content:I}});K.push({selectorControl:u.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"dragAndDropUI",content:I}});N._arrangeCards(V,{row:W.dashboardLayout.row,column:W.dashboardLayout.column},'drag',Z);N._removeSpaceBeforeCard(Z);Z.forEach(function(a1){var b1={};b1.dashboardLayout={};b1.cardId=a1.content.cardId;b1.dashboardLayout[Y]=a1.content.dashboardLayout;K.push({selectorControl:u.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"dragOrResize",content:b1}});});}else{var $=z.parent.getContent().filter(function(r){return r.getVisible();});I={cardId:D._getCardId(x.getId()),position:$.indexOf(T),oldPosition:$.indexOf(x)};K.push({selectorControl:u.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"position",content:I}});J={cardId:D._getCardId(x.getId()),position:z.index,oldPosition:y.index};K.push({selectorControl:u.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"dragAndDropUI",content:J}});}}h(v);if(w){w.removeStyleClass("sapUiDtOverlayCutted");e.setMovedOverlay(null);e.deactivateAllTargetZones(u);return Promise.resolve(K).then(function(a1){return a1;});}}};t["AddStaticLinkListCard"]={icon:"sap-icon://form",name:b.getText("OVP_KEYUSER_MENU_CREATE_LINK_LIST_CARD"),isEnabled:function(u){return true;},handler:S.fnAddStaticLinkListCardHandler};if(i){t["AddKPICard"]={icon:"sap-icon://kpi-corporate-performance",name:b.getText("OVP_KEYUSER_MENU_ADD_KPI_CARD"),isEnabled:function(u){return true;},handler:S.fnAddKPICardHandler};}}else if(s&&(s===c.Layers.vendor||s===c.Layers.customer_base)){t["AddCard"]={icon:"sap-icon://add-activity",name:b.getText("OVP_KEYUSER_MENU_AddCard"),isEnabled:function(u){return true;},handler:S.fnAddNewCardHandler};}t["RemoveCard"]={icon:"sap-icon://delete",name:b.getText("OVP_KEYUSER_MENU_REMOVE_CARD"),isEnabled:function(u){var t=u.getComponentInstance().getComponentData().settings;return u.getId().indexOf(C._getLayerNamespace()+".")!==-1&&!t.cloneCard&&!t.newCard;},handler:S.fnRemoveCardHandler};return t;};return o;},true);
