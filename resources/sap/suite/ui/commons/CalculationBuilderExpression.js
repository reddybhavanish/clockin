sap.ui.define(["sap/ui/thirdparty/jquery","./library","./CalculationBuilderItem","sap/ui/core/Control","sap/ui/core/ValueState","sap/ui/core/Popup","sap/ui/core/TextAlign","sap/ui/core/delegate/ItemNavigation","sap/m/MessageBox","sap/m/OverflowToolbar","sap/m/OverflowToolbarToggleButton","sap/m/OverflowToolbarButton","sap/m/ToolbarSpacer","sap/m/Title","sap/m/ButtonType","sap/m/Button","sap/m/FlexBox","sap/m/HBox","sap/m/VBox","sap/m/FlexRendertype","sap/m/FlexAlignItems","sap/m/library","sap/m/SegmentedButton","sap/m/SegmentedButtonItem","sap/m/StepInput","sap/m/Input","sap/m/InputType","sap/m/Page","sap/m/List","sap/m/ListMode","sap/m/ListType","sap/m/StandardListItem","sap/m/NavContainer","sap/m/SearchField","sap/m/Label","sap/m/Panel","sap/m/ResponsivePopover","sap/m/PlacementType","sap/m/Toolbar","sap/m/MessageStrip","./CalculationBuilderValidationResult","sap/suite/ui/commons/ControlProxy","sap/ui/core/Icon","sap/ui/thirdparty/jqueryui/jquery-ui-core","sap/ui/thirdparty/jqueryui/jquery-ui-widget","sap/ui/thirdparty/jqueryui/jquery-ui-mouse","sap/ui/thirdparty/jqueryui/jquery-ui-draggable","sap/ui/thirdparty/jqueryui/jquery-ui-droppable","sap/ui/thirdparty/jqueryui/jquery-ui-selectable"],function(q,l,C,a,V,P,T,I,M,O,b,c,d,e,B,f,F,H,g,h,j,m,S,n,o,p,r,s,L,t,u,v,N,w,x,y,R,z,A,D,E,G,J){"use strict";var K=l.CalculationBuilderItemType,Q=l.CalculationBuilderOperatorType,U=l.CalculationBuilderComparisonOperatorType,W=l.CalculationBuilderLogicalOperatorType,X=l.CalculationBuilderLayoutType,Y=m.FlexDirection;var Z=Object.freeze({PAGE_MAIN:"-pagemain",PAGE_OPERATORS:"-pageoperators",PAGE_VARIABLE:"-pagevariable",PAGE_FUNCTIONS:"-pagefunctions",LABEL_LITERALS:"-literalInput-label",INPUT_LITERALS:"-literalInput-field"});var $=Object.freeze({OPERATORS_CATEGORY:"sap-icon://attachment-html",LITERALS_CATEGORY:"sap-icon://grid",VARIABLES_CATEGORY:"sap-icon://notes",FUNCTIONS_CATEGORY:"sap-icon://chalkboard",DELETE:"sap-icon://delete"});var _=Object.freeze({KEY_PREVIOUS:"previous",KEY_NEXT:"next",MOUSE:"mouse"});var a1="##DEFAULT##";var b1=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var c1=a.extend("sap.suite.ui.commons.CalculationBuilderExpression",{metadata:{library:"sap.suite.ui.commons",defaultAggregation:"items",aggregations:{items:{type:"sap.suite.ui.commons.CalculationBuilderItem",multiple:true,singularName:"item",bindable:"bindable"},variables:{type:"sap.suite.ui.commons.CalculationBuilderVariable",multiple:true,singularName:"Variable"},functions:{type:"sap.suite.ui.commons.CalculationBuilderFunction",multiple:true,singularName:"Function"},operators:{type:"sap.ui.core.Item",multiple:true,singularName:"operator"},groups:{type:"sap.suite.ui.commons.CalculationBuilderGroup",multiple:true,singularName:"Group"}},events:{change:{}}},renderer:function(k,d1){k.write("<div");k.writeControlData(d1);k.addClass("sapCalculationBuilderInner");k.writeClasses(d1);k.write(">");k.write(d1._renderDelimiter(0));d1.getItems().forEach(function(e1,i){e1._iIndex=i;e1._bReadOnly=d1._bReadOnly;k.renderControl(e1);k.write(d1._renderDelimiter(i+1));},this);if(!d1._bReadOnly){k.renderControl(d1._getNewItem());}k.write("<div class=\"sapCalculationBuilderSelected\"></div>");k.write("</div>");k.write("<div id=\""+d1.getId()+"-erroricon\"  class=\"sapCalculationBuilderExpressionErrorIcon\">");k.renderControl(d1._getErrorIcon());k.write("</div>");}});c1.prototype.init=function(){this._aErrors=[];this._bAreSelectedItemsDeleting=false;this._bDragging=false;this._bIsCalculationBuilderRendering=false;};c1.prototype._renderDelimiter=function(i){var k="";k+="<div class=\"sapCalculationBuilderDelimiter sapCalculationBuilderDroppable\" index=\""+i+"\">";k+="<div class=\"sapCalculationBuilderDroppableLine\"></div>";k+="<div class=\"sapCalculationBuilderDroppableCircle\"></div>";k+="<div class=\"sapCalculationBuilderDelimiterNewButton\">";k+="<span role=\"presentation\" aria-hidden=\"true\" data-sap-ui-icon-content=\"î€¸\""+"class=\"sapUiIcon sapUiIconMirrorInRTL sapCalculationBuilderDelimiterNewButtonIcon\" style=\"font-family:'SAP-icons'\"></span>";k+="</div>";k+="</div>";return k;};c1.prototype.onBeforeRendering=function(){this._reset();this._createPopup();this.getParent()._enableOrDisableExpandAllButton();this._aErrors=this._validateSyntax();this._fireAfterValidation();this._bIsCalculationBuilderRendering=true;this._bRendered=false;};c1.prototype.onAfterRendering=function(){this._bIsCalculationBuilderRendering=false;if(!this._bReadOnly){this._setupDroppable();this._setupSelectable();this._setupNewButtonEvents();}this._setupKeyboard();this._bRendered=true;var i=this.getParent();if(i._bRendered){i._setExpression(i._oInput._itemsToString({items:this.getItems(),errors:this._aErrors}));i._oInput._displayError(this._aErrors.length!==0);}};c1.prototype.onsapfocusleave=function(){if(!this._bAreSelectedItemsDeleting){this._deselect();}};c1.prototype.onsapenter=function(i){this._handleEnter(i);};c1.prototype.onsapspace=function(i){if(q(i.target).hasClass("sapCalculationBuilderItem")){this._handleSpace(i);}};c1.prototype.onsappreviousmodifiers=function(i){if(i.ctrlKey){this._handleCtrlPrevious(i);}};c1.prototype.onsapnextmodifiers=function(i){if(i.ctrlKey){this._handleCtrlNext(i);}};c1.prototype.onsapdelete=function(i){this._handleDelete(i);};c1.prototype.exit=function(){if(this._oPopover){this._oPopover.destroy();}if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();}if(this._oErrorIcon){this._oErrorIcon.destroy();this._oErrorIcon=null;}};c1.prototype._getErrorIcon=function(){if(!this._oErrorIcon){this._oErrorIcon=new J({src:"sap-icon://message-error",useIconTooltip:false,size:"20px"});}return this._oErrorIcon;};c1.prototype._createPopup=function(){var i={footerButtons:[]};this._createPopoverLayout(i);this._createPopoverFunctionsItems(i);this._createPopoverOperatorsItems(i);this._createPopoverNavContainer(i);this._createPopover(i);};c1.prototype._reset=function(){this.getItems().forEach(function(i){i._reset();});if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}};c1.prototype._createPopoverLayout=function(i){var k=function(g1){return new f({text:g1==="*"?"x":g1,press:this._updateOrCreateItem.bind(this,{type:K.Operator,key:g1})}).addStyleClass("sapUiTinyMarginEnd");}.bind(this);var d1=new H({renderType:h.Div,width:"100%"});d1.addStyleClass("sapCalculationBuilderItemPopupOperators");d1.addStyleClass("sapCalculationBuilderItemPopupOptionItem");Object.keys(Q).forEach(function(g1){if(this.getParent()._isTokenAllowed(g1)){var h1=k(Q[g1]);if(g1===Q[","]){this._attachAriaLabelToButton(h1,b1.getText("CALCULATION_BUILDER_COMMA_ARIA_LABEL"));}else if(g1===Q["-"]){this._attachAriaLabelToButton(h1,b1.getText("CALCULATION_BUILDER_MINUS_ARIA_LABEL"));}d1.addItem(h1);}}.bind(this));var e1=this._createPopoverLiteralLabelAndInput(i);var f1=new g({items:[d1,e1],alignItems:"Start"});f1.addStyleClass("sapCalculationBuilderItemPopupOperatorsAndInputWrapper");i.layout=f1.getItems().length>0?f1:null;};c1.prototype._createPopoverLiteralLabelAndInput=function(i){var k=new x({id:this.getId()+Z.LABEL_LITERALS,text:b1.getText("CALCULATION_BUILDER_LITERAL_INPUT_LABEL")});var d1;if(this.getParent().getAllowStringLiterals()){d1=new p({id:this.getId()+Z.INPUT_LITERALS,width:"100%",placeholder:b1.getText("CALCULATION_BUILDER_ADD_LITERAL_FIELD_PLACEHOLDER_ANY_STRING"),valueStateText:b1.getText("CALCULATION_BUILDER_ADD_LITERAL_FIELD_PLACEHOLDER_ERROR"),liveChange:function(g1){var h1=g1.getSource(),i1=g1.getParameter("value"),j1=i1.indexOf("\"")===-1;h1.setValueState(j1?V.None:V.Error);i.footerButtons.okButton.setEnabled(j1);},submit:function(g1){this._submitLiteralInput(d1);}.bind(this)});}else{d1=new o({width:"100%",placeholder:b1.getText("CALCULATION_BUILDER_ADD_LITERAL_FIELD_PLACEHOLDER"),textAlign:T.Right,valueStateText:b1.getText("CALCULATION_BUILDER_ADD_LITERAL_FIELD_ERROR_TEXT"),displayValuePrecision:3,change:function(){i.footerButtons.okButton.setEnabled(true);}});if(d1._getInput){var e1=d1._getInput();if(e1){e1.attachSubmit(function(g1){this._submitLiteralInput(d1);},this);}}}d1.addAriaLabelledBy(k);i.literalInput=d1;var f1=new g({renderType:h.Div,items:[k,d1],width:"100%"});f1.addStyleClass("sapCalculationBuilderItemPopupOptionItem");f1.addStyleClass("sapCalculationBuilderItemPopupLiteralLabelAndInput");return f1;};c1.prototype._createPopoverVariablesItems=function(i){if(!i){return[];}var k=[];i.forEach(function(e1){var f1=new v({title:e1._getLabel()});f1._calculationBuilderKey=e1.getKey();k.push(f1);},this);k=k.sort(function(o1,o2){return o1.getTitle().localeCompare(o2.getTitle());});var d1=new L({mode:t.SingleSelectMaster,selectionChange:function(e1){this._updateOrCreateItem({type:K.Variable,key:e1.getParameter("listItem")._calculationBuilderKey});}.bind(this),items:k});this._oSearchField=new w({placeholder:b1.getText("CALCULATION_BUILDER_SEARCH_VARIABLE"),liveChange:function(e1){var f1=e1.getSource().getValue();if(f1||f1===""){d1.removeAllItems();k.forEach(function(g1){if(g1.getTitle().toLowerCase().indexOf(f1.toLowerCase())!==-1){d1.addItem(g1);}});}}});this._aVariableLists.push(d1);return[this._oSearchField,d1];};c1.prototype._createPopoverFunctionsItems=function(i){var k=this,d1=this.getParent();var e1=function(f1){return new v({title:f1.title,description:f1.description,type:u.Active,customData:[{key:"functionKey",value:f1.key}],press:f1.press});};i.functionList=new L({mode:t.SingleSelectMaster,itemPress:function(){this.getSelectedItem().firePress();}});d1._getAllFunctions().forEach(function(f1){i.functionList.addItem(e1({key:f1.key,title:f1.title,description:f1.description,press:k._updateOrCreateItem.bind(k,{key:f1.key,type:f1.type,functionObject:f1.functionObject})}));});};c1.prototype._createPopoverOperatorsItems=function(i){var k=this.getParent();var d1=function(i1,j1){var k1=[];Object.keys(i1).forEach(function(l1){var m1,n1,o1=i1[l1];if(k._isTokenAllowed(l1)){if(typeof o1==="object"){n1=o1.getText();m1=o1.getKey();}else{m1=n1=o1;}var p1=new f({text:n1,press:this._updateOrCreateItem.bind(this,{type:j1,key:m1})}).addStyleClass("sapCalculationBuilderPopoverOperatorsButton").addStyleClass("sapUiTinyMarginEnd");if(l1===U["!="]){this._attachAriaLabelToButton(p1,b1.getText("CALCULATION_BUILDER_NOT_EQUAL_ARIA_LABEL"));}k1.push(p1);}}.bind(this));return k1;}.bind(this);var e1=function(i1,j1,k1){var l1=d1(j1,k1);if(l1.length>0){return new y({content:[new x({width:"100%",text:i1}).addStyleClass("sapUiTinyMarginBottom"),l1]});}return null;};i.operatorsItems=[];if(this.getParent().getAllowComparisonOperators()){var f1=e1(b1.getText("CALCULATION_BUILDER_COMPARISON_TITLE_SELECT"),U,K.Operator);f1&&i.operatorsItems.push(f1);}if(this.getParent().getAllowLogicalOperators()){var g1=e1(b1.getText("CALCULATION_BUILDER_LOGICAL_TITLE_SELECT"),W,K.Operator);g1&&i.operatorsItems.push(g1);}var h1=this.getParent().getOperators();if(h1.length>0){i.operatorsItems.push(e1(b1.getText("CALCULATION_BUILDER_OPERATORS_TITLE"),h1,K.CustomOperator));}};c1.prototype._createPopoverNavContainer=function(i){var k=function(j1){var k1=i1.getPage(j1);i1.to(k1);};var d1=function(){var j1=new D({type:"Error",showIcon:true}).addStyleClass("sapUiTinyMarginBegin sapUiTinyMarginEnd sapUiTinyMarginTop");this._aStrips.push(j1);return j1;}.bind(this);this._aStrips=[];var e1=[];var f1=this._createPopoverVariablesItems(this._mGroups[a1]);if(f1.length>0){e1.push(new v({title:b1.getText("CALCULATION_BUILDER_VARIABLES_TITLE"),description:b1.getText("CALCULATION_BUILDER_VARIABLES_CATEGORY_DESCRIPTION"),icon:$.VARIABLES_CATEGORY,press:k.bind(this,this.getId()+Z.PAGE_VARIABLE),type:u.Active}));}var g1=i.functionList.getItems();if(g1.length>0){e1.push(new v({title:b1.getText("CALCULATION_BUILDER_FUNCTIONS_TITLE"),type:u.Active,description:b1.getText("CALCULATION_BUILDER_FUNCTIONS_CATEGORY_DESCRIPTION"),icon:$.FUNCTIONS_CATEGORY,press:k.bind(this,this.getId()+Z.PAGE_FUNCTIONS)}));}if(i.operatorsItems.length>0){e1.unshift(new v({title:b1.getText("CALCULATION_BUILDER_OPERATORS_TITLE"),type:u.Active,description:b1.getText("CALCULATION_BUILDER_OPERATORS_CATEGORY_DESCRIPTION"),icon:$.OPERATORS_CATEGORY,press:k.bind(this,this.getId()+Z.PAGE_OPERATORS)}));}this.getGroups().forEach(function(j1){e1.push(new v({title:j1._getTitle(),type:u.Active,description:j1.getDescription(),icon:j1.getIcon(),press:k.bind(this,this.getId()+j1.getKey())}));}.bind(this));var h1=new s({id:this.getId()+Z.PAGE_MAIN,title:b1.getText("CALCULATION_BUILDER_DIALOG_TITLE"),content:[d1(),i.layout,new F({direction:Y.Column,items:[new L({items:e1})]}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop").addStyleClass("sapCalculationBuilderNavMainPage")]});h1.setFooter(this._getPageFooter(h1.getId(),i));var i1=new N({defaultTransitionName:"show",navigate:function(j1){var k1=j1.getParameters().to;k1.setFooter(this._getPageFooter(k1.getId(),i));}.bind(this),pages:[h1]});if(i.operatorsItems.length>0){i1.addPage(new s({id:this.getId()+Z.PAGE_OPERATORS,content:[d1(),new F({direction:Y.Column,items:[i.operatorsItems]}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop")],showNavButton:true,title:b1.getText("CALCULATION_BUILDER_OPERATORS_PAGE_TITLE"),navButtonPress:k.bind(this,this.getId()+Z.PAGE_MAIN)}));}if(f1.length>0){i1.addPage(new s({id:this.getId()+Z.PAGE_VARIABLE,content:[d1(),new F({direction:Y.Column,items:f1}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop")],showNavButton:true,title:b1.getText("CALCULATION_BUILDER_VARIABLES_PAGE_TITLE"),navButtonPress:k.bind(this,this.getId()+Z.PAGE_MAIN)}));}if(g1.length>0){i1.addPage(new s({id:this.getId()+Z.PAGE_FUNCTIONS,content:[d1(),new F({direction:Y.Column,items:[i.functionList]}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop")],showNavButton:true,title:b1.getText("CALCULATION_BUILDER_FUNCTIONS_PAGE_TITLE"),navButtonPress:k.bind(this,this.getId()+Z.PAGE_MAIN)}));}this.getGroups().forEach(function(j1){var k1=new s({id:this.getId()+j1.getKey(),showNavButton:true,title:j1._getTitle(),navButtonPress:k.bind(this,this.getId()+Z.PAGE_MAIN),content:d1()});var l1=j1.getCustomView();if(l1){var m1=new G();m1.setAssociation("control",l1);k1.addContent(m1);}else{k1.addContent(new F({direction:Y.Column,items:this._createPopoverVariablesItems(this._mGroups[j1.getKey()])}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop"));}i1.addPage(k1);}.bind(this));i.navContainer=i1;};c1.prototype._callFunctionFireSelection=function(k){this.getGroups().forEach(function(i){if(i.getCustomView()){i.fireSetSelection({key:k});}});};c1.prototype._clearVariableLists=function(){this._aVariableLists.forEach(function(i){var k=i.getSelectedItem();if(k){i.setSelectedItem(k,false);}});this._callFunctionFireSelection();};c1.prototype._setVariableListSelection=function(d1){for(var i=0;i<this._aVariableLists.length;i++){var e1=this._aVariableLists[i],f1=this._aVariableLists[i].getItems();for(var k=0;k<f1.length;k++){if(f1[k]._calculationBuilderKey===d1){e1.setSelectedItem(f1[k],true);return;}}}this._callFunctionFireSelection(d1);};c1.prototype._sanitizeStringLiteral=function(i){if(this.getParent()._isStringLiteral(i)){i=i.substring(1,i.length-1);}return i;};c1.prototype._clearSearchField=function(){if(this._oSearchField){this._oSearchField.setValue("");this._oSearchField.fireLiveChange();}};c1.prototype._createPopover=function(k){var d1=function(){var e1=this._oCurrentItem,f1=k.navContainer.getCurrentPage().getId(),g1=k.functionList.getSelectedItem(),h1,i1,j1;var k1=this.getParent().getAllowStringLiterals()?"":0;k.literalInput.setValue(k1);this._clearVariableLists();this._clearSearchField();if(g1){k.functionList.setSelectedItem(g1,false);}if(!e1){h1=this.getId()+Z.PAGE_MAIN;}else{if(e1._isFunction()){j1=e1.getKey();h1=this.getId()+Z.PAGE_FUNCTIONS;i1=k.functionList.getItems();for(var i=0;i<i1.length;i++){var l1=i1[i].data("functionKey");if((l1&&l1.toLowerCase())===j1.toLowerCase()){k.functionList.setSelectedItem(i1[i],true);break;}}}else if(e1._isLiteral()){var m1=this._sanitizeStringLiteral(e1.getKey());k.literalInput.setValue(m1);k.literalInput.setValueState(V.None);h1=this.getId()+Z.PAGE_MAIN;}else if(e1._isVariable()){this._setVariableListSelection(e1.getKey());var n1=e1._oVariable||e1.getVariable(),o1=(n1&&n1.getGroup())||Z.PAGE_VARIABLE;h1=this.getId()+o1;}else if(e1._isSecondaryOperator()){h1=this.getId()+Z.PAGE_OPERATORS;}else{h1=this.getId()+Z.PAGE_MAIN;}}if(h1!==f1){if(h1!==this.getId()+Z.PAGE_MAIN){k.navContainer.backToPage(this.getId()+Z.PAGE_MAIN);}k.navContainer.to(k.navContainer.getPage(h1),"show");}else{k.navContainer.getCurrentPage().setFooter(this._getPageFooter(f1,k));}var p1=this._oCurrentItem&&this._oCurrentItem._getItemError(),q1=p1&&(" "+p1.title);this._aStrips.forEach(function(r1){r1.setVisible(!!p1);r1.setText(q1?b1.getText("CALCULATION_BUILDER_INCORRECT_SYNTAX")+q1:"");});}.bind(this);this._oPopover=new R({showHeader:false,resizable:true,placement:z.PreferredBottomOrFlip,contentWidth:"400px",contentHeight:"450px",content:[k.navContainer],beforeOpen:d1,afterClose:function(){this._bDragging=false;this._clearNewButtonPositions();}.bind(this)});};c1.prototype._submitLiteralInput=function(i){var k=i.getValue();if(this.getParent()&&this.getParent().getAllowStringLiterals()&&!q.isNumeric(k)){k="\""+k+"\"";}this._updateOrCreateItem({type:K.Literal,key:k});i.setValueState(V.None);};c1.prototype._getPageFooter=function(i,k){var d1=false,e1=false,f1=false;if(this._oCurrentItem&&!this._oCurrentItem._bIsNew){e1=true;f1=this._oCurrentItem._isLiteral();}d1=k.literalInput.getValueState()===V.None&&i===this.getId()+Z.PAGE_MAIN&&f1;k.footerButtons.okButton=new f({enabled:d1,text:b1.getText("CALCULATION_BUILDER_CONFIRM_BUTTON"),press:function(g1){this._submitLiteralInput(k.literalInput);}.bind(this)});k.footerButtons.deleteButton=new f({enabled:e1,text:b1.getText("CALCULATION_BUILDER_DELETE_BUTTON"),press:this._deleteItem.bind(this)});k.footerButtons.closeButton=new f({text:b1.getText("CALCULATION_BUILDER_CLOSE_BUTTON"),press:this._instantClose.bind(this)});return new A({content:[new d(),k.footerButtons.okButton,k.footerButtons.deleteButton,k.footerButtons.closeButton]});};c1.prototype._insertFunctionItems=function(i,k){var d1=function(e1){i.push(e1);};if(k&&k.length>0){k.forEach(function(e1){d1(e1);});}else{d1("");}d1(")");};c1.prototype._updateOrCreateItem=function(k){var d1=!this._oCurrentItem||this._oCurrentItem._bIsNew,e1=this._oCurrentItem&&!this._oCurrentItem.getKey(),f1=this.getParent(),g1=k.functionObject,h1=this.getItems();var i1=function(){var h1=k.type===K.Function?g1.template:f1._convertToTemplate(g1.getItems());this._insertFunctionItems(l1,h1);}.bind(this);var j1=function(){var i=isNaN(this._iCurrentIndex)?this.getItems().length:this._iCurrentIndex,m1=this._getKeys();this._smartRender(m1.slice(0,i).concat(l1,m1.slice(i)));}.bind(this);var k1=function(){for(var i=0;i<h1.length;i++){if(h1[i]===this._oCurrentItem){return i+1;}}return null;}.bind(this);if(d1){var l1=[k.key];if(g1){i1();}j1();}else{this._oCurrentItem.setKey(k.key);if(k.type){this._oCurrentItem._sType=k.type;}if(e1&&g1){var l1=[];this._iCurrentIndex=k1();i1();j1();}}this._instantClose();this._fireChange();};c1.prototype._expandAllVariables=function(){this.getItems().forEach(function(i){if(i.isExpandable()){i._expandVariable(false);}});this._fireChange();};c1.prototype._handleDelete=function(i){if(this._isEmptySelected()){return;}this._bAreSelectedItemsDeleting=true;M.show(b1.getText("CALCULATION_BUILDER_DELETE_MESSAGE_TEXT"),{icon:M.Icon.WARNING,title:b1.getText("CALCULATION_BUILDER_DELETE_MESSAGE_TITLE"),actions:[M.Action.YES,M.Action.CANCEL],onClose:function(k){if(k===M.Action.YES){var d1=this.$().find(".sapCalculationBuilderSelected .sapCalculationBuilderItem"),e1=d1.length,f1=d1.first(),g1=sap.ui.getCore().byId(f1.attr("id"));if(g1){var h1=this._getKeys();h1.splice(g1._iIndex,e1);this._smartRender(h1);this._fireChange();}}this._bAreSelectedItemsDeleting=false;}.bind(this)});};c1.prototype._handleEnter=function(i){var k=q(i.target),d1;if(this._oItemNavigation&&!this._bReadOnly){if(k.hasClass("sapCalculationBuilderNewItem")){d1=this._getNewItem();if(d1){d1._buttonPress(i);}}else if(k.hasClass("sapCalculationBuilderItem")){d1=this._getItemById(k[0].id);if(d1){d1._buttonPress(i);}}else if(k.hasClass("sapCalculationBuilderItemExpandButton")){d1=this._getItemById(k.closest(".sapCalculationBuilderItem")[0].id);if(d1){d1._expandButtonPress(i);}}}};c1.prototype._createVariablesMap=function(){this._mGroups={};this._aVariableLists=[];this.getVariables().forEach(function(i){var k=i.getGroup()||a1;if(!this._mGroups[k]){this._mGroups[k]=[];}this._mGroups[k].push(i);}.bind(this));};c1.prototype._handleSpace=function(i){this._selectItem(i.target);};c1.prototype._handleCtrlNext=function(i){this._moveItems(_.KEY_NEXT);};c1.prototype._handleCtrlPrevious=function(i){this._moveItems(_.KEY_PREVIOUS);};c1.prototype._getVariableByKey=function(k){var d1=this.getVariables();if(!k){return null;}k=k.toLowerCase();for(var i=0;i<d1.length;i++){if(d1[i].getKey().toLowerCase()===k){return d1[i];}}return null;};c1.prototype.setTitle=function(i){var k=this._oToolbarTitle;if(k){k.setText(i);k.setVisible(!!i);}this.setProperty("title",i);};c1.prototype._getKeys=function(){return this.getItems().map(function(i){return i.getKey();});};c1.prototype._deleteItem=function(){var k=this._getKeys();k.splice(this._oCurrentItem._iIndex,1);this._smartRender(k);this._instantClose();this._fireChange();};c1.prototype._openDialog=function(i){this._oCurrentItem=i.currentItem;this._iCurrentIndex=i.index;this._oPopover.openBy(i.opener);};c1.prototype._setupDroppable=function(i){var k=this;i=i||this.$().find(".sapCalculationBuilderDroppable");i.droppable({scope:k.getId()+"-scope",tolerance:"pointer",activeClass:"sapCalculationBuilderDroppableActive",hoverClass:"sapCalculationBuilderDroppableActive",drop:function(d1,ui){if(!ui.draggable.hasClass("sapCalculationBuilderSelected")){k._selectItem(ui.draggable[0]);}k._moveItems(_.MOUSE,parseInt(q(this).attr("index"),10));k._bDragging=false;},over:function(d1,ui){k._bDragging=true;}});};c1.prototype._clearNewButtonPositions=function(){var i=this.$();i.find(".sapCalculationBuilderDelimiterNewButton").hide(200);i.find(".sapCalculationBuilderItem").animate({"left":0},300);};c1.prototype._setupNewButtonEvents=function(){var i=13,k=300;var d1=this.$().find(".sapCalculationBuilderDelimiter[data-events!='bound']"),e1=this.$().find(".sapCalculationBuilderDelimiterNewButton[data-events!='bound']"),f1=this,g1,h1;var i1=function(j1,k1){j1.prev().animate({"left":-k1},k);j1.next().animate({"left":k1},k);};e1.click(function(ev){var j1=q(this),k1=parseInt(j1.parent().attr("index"),10);j1.css("opacity",1);f1._oCurrentItem=null;f1._iCurrentIndex=k1;f1._openDialog({opener:this,index:k1});});e1.attr("data-events","bound");d1.mouseover(function(ev){var j1=q(this);if(!f1._bDragging&&!f1._oPopover.isOpen()){g1=true;h1=setTimeout(function(){if(g1){g1=false;i1(j1,i);j1.find(".sapCalculationBuilderDelimiterNewButton").show(200);}},400);}});d1.mouseout(function(ev){var j1=q(this).find(".sapCalculationBuilderDelimiterNewButton"),k1=q(this);g1=false;clearTimeout(h1);if(f1._bDragging||f1._oPopover.isOpen()){return;}if(!j1.is(':hover')){i1(k1,0);j1.hide(200);}});d1.attr("data-events","bound");};c1.prototype._setupSelectable=function(){this.$().selectable({cancel:".sapCalculationBuilderCancelSelectable",distance:5,start:function(){this._deselect();this._instantClose();}.bind(this),stop:function(){this._selectItems(this.$().find(".sapCalculationBuilderItem.ui-selected"));}.bind(this)});};c1.prototype._selectItemsTo=function(i){var k=q(i.next(".sapCalculationBuilderDelimiter")[0]),d1=k.attr("index")-1,e1=this.$(),f1,g1,h1,i1,j1;if(i.parent().hasClass("sapCalculationBuilderSelected")||this._isEmptySelected()){this._selectItem(i);return;}if(d1>this._iLastSelectedIndex){f1=this._iFirstSelectedIndex;g1=d1+1;}else{f1=d1;g1=this._iLastSelectedIndex+1;}this._deselect();i1=e1.find(".sapCalculationBuilderDelimiter[index=\""+f1+"\"]");j1=e1.find(".sapCalculationBuilderDelimiter[index=\""+g1+"\"]");h1=i1.nextUntil(j1,".sapCalculationBuilderItem");this._selectItems(h1);};c1.prototype._selectItems=function(k){for(var i=0;i<k.length;i++){this._selectItem(k[i]);}};c1.prototype._selectItem=function(i){var k=this.$().find(".sapCalculationBuilderSelected"),d1=q(i),e1=q(d1.next(".sapCalculationBuilderDelimiter")[0]),f1=k[0].children.length,g1=e1.attr("index")-1,h1=true;if(!this._oItemNavigation||!this._getItemById(d1[0].id)||this._bReadOnly){return;}if(f1===0){this._iFirstSelectedIndex=g1;this._iLastSelectedIndex=g1;}else{if(d1.parent().hasClass("sapCalculationBuilderSelected")){if(this._iFirstSelectedIndex===g1){this._iFirstSelectedIndex++;this._deselectItem(d1,false);}else if(this._iLastSelectedIndex===g1){this._iLastSelectedIndex--;this._deselectItem(d1,true);}else{this._deselect();}this._setCorrectFocus();return;}if((this._iFirstSelectedIndex-g1)===1){this._iFirstSelectedIndex=g1;h1=false;}else if((g1-this._iLastSelectedIndex)===1){this._iLastSelectedIndex=g1;h1=true;}else{this._iFirstSelectedIndex=g1;this._iLastSelectedIndex=g1;this._deselect();}}var i1=this.$();if(this._isEmptySelected()){k.detach().insertBefore(d1);k.draggable({revert:"invalid",cursor:"move",axis:"x",scope:this.getId()+"-scope",helper:function(j1){var k1=k.clone();k1.removeClass("sapCalculationBuilderSelected");k1.addClass("sapCalculationBuilderDraggingSelectedClone");return k1;},start:function(){k.addClass("sapCalculationBuilderDragging");i1.find(".sapCalculationBuilderItemContent").css("cursor","move");},stop:function(){k.removeClass("sapCalculationBuilderDragging");i1.find(".sapCalculationBuilderItemContent").css("cursor","pointer");}});}if(h1){d1.detach().appendTo(k);e1.detach().appendTo(k);}else{e1.detach().prependTo(k);d1.detach().prependTo(k);}if(d1.hasClass("sapCalculationBuilderItem")){d1.draggable("disable");d1.addClass("ui-selected");}this._setCorrectFocus();};c1.prototype._isEmptySelected=function(){var i=this.$().find(".sapCalculationBuilderSelected");if(i){return i.is(":empty");}return true;};c1.prototype._deselectItem=function(i,k){var d1=this.$().find(".sapCalculationBuilderSelected"),e1=q(i.next(".sapCalculationBuilderDelimiter")[0]);if(!i.hasClass("ui-selected")){return;}if(k){e1.detach().insertAfter(d1);i.detach().insertAfter(d1);}else{i.detach().insertBefore(d1);e1.detach().insertBefore(d1);}i.draggable("enable");i.removeClass("ui-selected");};c1.prototype._deselect=function(){var i=this.$().find(".sapCalculationBuilderSelected");if(this._isEmptySelected()){return;}this.$().find(".sapCalculationBuilderSelected .ui-selected").removeClass("ui-selected");i.children().each(function(){var k=q(this);if(k.hasClass("sapCalculationBuilderItem")){k.draggable("enable");}k.detach().insertBefore(i);});};c1.prototype._setupKeyboard=function(){var i=this.getDomRef(),k=[];this.getItems().forEach(function(d1){k.push(d1.getFocusDomRef());if(d1.isExpandable()){k.push(d1.$("expandbutton"));}});k.push(this._getNewItem().getFocusDomRef());if(!this._oItemNavigation){this._oItemNavigation=new I();this.addDelegate(this._oItemNavigation);}this._oItemNavigation.setRootDomRef(i);this._oItemNavigation.setItemDomRefs(k);this._oItemNavigation.setCycling(true);this._oItemNavigation.setPageSize(250);};c1.prototype._setCorrectFocus=function(){q(this._oItemNavigation.getFocusedDomRef()).focus();};c1.prototype._getItemById=function(i){return this.getItems().filter(function(k){return k.getId()===i;})[0];};c1.prototype._getNewItem=function(){if(!this._oNewItem){this._oNewItem=new C();this._oNewItem._bIsNew=true;this._oNewItem.setParent(this,null,true);}return this._oNewItem;};c1.prototype._instantClose=function(){var i=this._oPopover.getAggregation("_popup");if(i&&i.oPopup&&i.oPopup.close){i.oPopup.close(0);this._setCorrectFocus();}};c1.prototype._attachAriaLabelToButton=function(i,k){i.addEventDelegate({onAfterRendering:function(d1){d1.srcControl.$("content").attr("aria-label",k);}});};c1.prototype._printErrors=function(){this.getItems().forEach(function(i){var k=i._getItemError(),d1=i.$(),e1=!!k?"addClass":"removeClass";d1[e1]("sapCalculationBuilderItemErrorSyntax");});if(this.getParent().getLayoutType()===X.VisualOnly){this._showErrorIcon();}};c1.prototype._validateSyntax=function(k){var d1=function(){var C1=this.getItems()[s1],D1=C1.getKey();return!C1._isOperator()||D1==="("||D1==="+"||D1==="-"||D1.toLowerCase()==="not";}.bind(this);var e1=function(){var m1=this.getItems(),C1=m1[t1-1];return!C1._isOperator()||C1.getKey()===")";}.bind(this);var f1=function(p1){var C1=p1.getKey().toLowerCase();if(p1._isOperator()){return C1==="not"||C1==="("||C1===")"?C1:"#op#";}return p1._isFunction()?"#fun#":"#col#";};var g1=function(p1){return{index:i,item:p1,items:[],text:p1.getKey()+(p1._isFunction()?"(":"")};};var h1=function(y1){var C1=1,D1=i;i++;for(;i<m1.length;i++){var p1=m1[i],E1=p1.getKey(),F1=g1(p1);y1.items.push(F1);switch(E1){case")":C1--;break;case"(":C1++;break;case",":C1=1;break;}if(p1._isFunction()){h1(F1);y1.text+=F1.text;}else{y1.text+=E1;}if(C1===0){return y1;}}w1.push({index:D1,title:b1.getText("CALCULATION_BUILDER_CLOSING_BRACKET_ERROR_TEXT")});return y1;};var i1=function(y1){var C1=this.getParent()._getFunctionAllowParametersCount(y1.item.getKey()),D1=[],E1=[];y1.items.forEach(function(p1){if(p1.item._isComma()){D1.push(E1);E1=[];}else{E1.push(p1);}});if(E1.length>0&&E1[E1.length-1].text===")"){E1.pop();}D1.push(E1);if(D1.length!==C1){w1.push({index:y1.index,title:b1.getText(D1.length<C1?"CALCULATION_BUILDER_TOO_LITTLE_PARAMETERS":"CALCULATION_BUILDER_TOO_MANY_PARAMETERS")});}if(D1.length>0){D1.forEach(function(F1){if(F1.length>0){q.merge(w1,this._validateSyntax({from:F1[0].index,to:F1[F1.length-1].index+1}));}else{w1.push({index:y1.index,title:b1.getText("CALCULATION_BUILDER_EMPTY_PARAMETER")});}}.bind(this));}}.bind(this);var j1=0;var k1=function(){var C1=p1.getKey()==="+"||p1.getKey()==="-";if(C1){j1++;if(j1>2){w1.push({index:i,title:b1.getText("CALCULATION_BUILDER_SYNTAX_ERROR_TEXT")});}}else{j1=0;}};var l1={"#op#":["(","#col#","#fun#","not","+","-"],"(":["(","+","-","#col#","#fun#","not"],")":["#op#",")"],"#col#":["#op#",")"],"#fun#":["(","+","-","#col#","#fun#"],"not":["#col#","#fun#","not","("]};k=k||{};var m1=k.items||this.getItems(),n1,o1,p1,q1,r1,s1=k.from||0,t1=k.to||m1.length,u1=(s1===0&&t1===m1.length),v1=[],w1=[];if(m1.length>0){if(!d1()){w1.push({index:s1,title:b1.getText("CALCULATION_BUILDER_FIRST_CHAR_ERROR_TEXT")});}if(!e1()){w1.push({index:t1-1,title:b1.getText("CALCULATION_BUILDER_LAST_CHAR_ERROR_TEXT")});}}for(var i=s1;i<t1;i++){p1=m1[i];if(p1._getType()===K.Error){w1.push({index:i,title:b1.getText("CALCULATION_BUILDER_SYNTAX_ERROR_TEXT")});continue;}k1();if(!k.skipCustomValidation&&p1._isFunction()){var x1=p1._getCustomFunction(),y1=h1(g1(p1));if(x1&&!x1.getUseDefaultValidation()){var z1=new E();this.getParent().fireValidateFunction({definition:y1,customFunction:x1,result:z1});q.merge(w1,z1.getErrors());}else{i1(y1);}}if(i<t1-1){q1=m1[i+1];n1=f1(m1[i]);o1=f1(q1);r1=q1?q1.getKey().toLowerCase():"";var A1=q1._isCustomOperator()||p1._isCustomOperator();if(l1[n1].indexOf(o1)===-1&&l1[n1].indexOf(r1)===-1&&!A1){var B1={index:i+1};if(p1._isOperator()&&q1._isOperator()){B1.title=b1.getText("CALCULATION_BUILDER_BEFORE_OPERATOR_ERROR_TEXT",q1.getKey());}else if(!p1._isOperator()&&!q1._isOperator()){B1.title=b1.getText("CALCULATION_BUILDER_BETWEEN_NOT_OPERATORS_ERROR_TEXT",[p1.getKey(),q1.getKey()]);}else if(p1.getKey()===")"&&!q1._isOperator()){B1.title=b1.getText("CALCULATION_BUILDER_AFTER_CLOSING_BRACKET_ERROR_TEXT");}else if(!p1._isOperator()&&(q1.getKey()==="(")){B1.title=b1.getText("CALCULATION_BUILDER_BEFORE_OPENING_BRACKET_ERROR_TEXT");}else{B1.title=b1.getText("CALCULATION_BUILDER_CHAR_ERROR_TEXT");}w1.push(B1);}}if(p1._isFunction()){continue;}if(u1&&p1.getKey()===","){w1.push({index:i,title:b1.getText("CALCULATION_BUILDER_WRONG_PARAMETER_MARK")});}if((p1._isOperator()&&p1.getKey()==="(")||p1._isFunction()){v1.push(i);}if(p1._isOperator()&&p1.getKey()===")"){if(v1.length===0){w1.push({index:i,title:b1.getText("CALCULATION_BUILDER_OPENING_BRACKET_ERROR_TEXT")});}else{v1.pop();}}}for(i=0;i<v1.length;i++){w1.push({index:v1[i],title:b1.getText("CALCULATION_BUILDER_CLOSING_BRACKET_ERROR_TEXT")});}return w1;};c1.prototype._getType=function(k){return this.getParent()&&this.getParent()._getType(k);};c1.prototype._moveItems=function(k,d1){var e1=[],f1=this.$(),g1=this.getItems(),h1=f1.find(".sapCalculationBuilderSelected"),i1,j1,k1,l1;if(this._isEmptySelected()){return;}l1=(h1.length>1)?q(h1[0]).children():h1.children();if(k===_.KEY_PREVIOUS){j1=this._iFirstSelectedIndex-1;}else if(k===_.KEY_NEXT){j1=this._iLastSelectedIndex+2;}else if(k===_.MOUSE){j1=d1;}if(j1<0||j1===(g1.length+1)){return;}i1=this.$().find(".sapCalculationBuilderDelimiter[index=\""+j1+"\"]");for(var i=0;i<g1.length+1;i++){k1=g1[i];if(j1===i){l1.each(function(){var f1=q(this),k1;if(f1.hasClass("sapCalculationBuilderItem")){k1=sap.ui.getCore().byId(q(this)[0].id);e1.push(k1);k1._bMovingItem=true;f1.draggable("enable");}f1.css("left",0);f1.detach().insertAfter(i1).removeClass("");i1=f1;});}if(k1&&!k1.$().parent().hasClass("sapCalculationBuilderSelected")&&!k1._bMovingItem){e1.push(k1);}}h1.css("left","");f1.find(".sapCalculationBuilderDelimiter").each(function(i){q(this).attr("index",i);});this.removeAllAggregation("items",true);e1.forEach(function(k1,i){k1._bMovingItem=false;k1._iIndex=i;this.addAggregation("items",k1,true);}.bind(this));this._setupKeyboard();this._selectItems(l1.filter(function(i,el){return q(el).hasClass("sapCalculationBuilderItem");}));this._fireChange();};c1.prototype._fireAfterValidation=function(){this.getParent().fireAfterValidation();};c1.prototype._setItems=function(i){this.removeAllAggregation("items",true);(i||[]).forEach(function(k){this.addAggregation("items",this._convertFromNewItem(k),true);}.bind(this));};c1.prototype._getKeyFromCreatedItem=function(i){return typeof i==="object"?i.getKey():i;};c1.prototype._convertFromNewItem=function(i){return typeof i==="object"?i:new C({key:i});};c1.prototype._showErrorIcon=function(){var i=this.$("erroricon"),k=this.getParent(),d1=k._createErrorText(null,true);if(d1){i.show();i.attr("title",k._createErrorText(null,true));}else{i.hide();}};c1.prototype._smartRender=function(k){var d1="",e1=this.$(),f1=[],g1=this.getItems(),h1=g1.length;var i1=function(k1){k1=this._convertFromNewItem(k1);this.addAggregation("items",k1,true);k1._iIndex=i;if(e1[0]){d1+=k1._render();d1+=this._renderDelimiter(i+1);}k1.bOutput=true;f1.push(k1);}.bind(this);if(!this.getParent()._isExpressionVisible()){this._setItems(k);return;}this._bRendered=false;this._bIsCalculationBuilderRendering=true;this._deselect();for(var i=0;i<k.length;i++){var j1=g1[i],k1=k[i],l1=typeof k1==="object"&&k1.getKey?k1.getKey():k1,m1=k1._sType?k1._sType:"";if(!j1){i1(k[i]);}else if(j1.getKey()!==l1||j1._sType!==m1){j1.setKey(l1,true);j1._sType=m1;var n1=j1.$();n1[0].innerHTML=j1._innerRender();n1.attr("class",j1._getClass());n1.attr("title",j1._getTooltip());j1._setEvents();}}if(k.length<h1){for(var i=k.length;i<g1.length;i++){var n1=g1[i].$();n1.next().remove();n1.remove();this.removeAggregation("items",g1[i],true);}}if(e1[0]&&f1.length>0){e1.find(".sapCalculationBuilderDelimiter").last().after(d1);f1.forEach(function(j1){j1._afterRendering();});this._setupDroppable(e1.find(".sapCalculationBuilderDroppable").filter(function(){return parseInt(q(this).attr("index"),10)>h1;}));}this._bRendered=true;this._setupKeyboard();this._setupNewButtonEvents();this._bIsCalculationBuilderRendering=false;};c1.prototype._fireChange=function(){this.fireEvent("change");};return c1;});
