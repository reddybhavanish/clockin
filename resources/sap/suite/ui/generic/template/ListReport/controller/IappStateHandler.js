sap.ui.define(["sap/ui/base/Object","sap/ui/core/mvc/ControllerExtension","sap/ui/generic/app/navigation/service/NavError","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/base/Log","sap/base/util/deepEqual","sap/base/util/extend"],function(B,C,N,S,U,L,d,e){"use strict";var a="sap.suite.ui.generic.template.customData",b="sap.suite.ui.generic.template.extensionData",c="sap.suite.ui.generic.template.genericData";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(o){if(o){for(var p in o){o[p]=null;}}}function f(o,O){var k=Object.keys(o);if(k.length!==Object.keys(O).length){return true;}for(var i=0;i<k.length;i++){var K=k[i];var p=o[K];var P=O[K];if(p.length!==P.length){return true;}for(var j=0;j<p.length;j++){if(p[j]!==P[j]){return true;}}}return false;}function l(m,D){if(sap.ui.support){var i=L.getLevel();if(i<L.Level.INFO){L.setLevel(L.Level.INFO);}}var s;if(typeof D==="string"){s=D;}else{s="";var h="";for(var k in D){s=s+h+k+": "+D[k];h="; ";}}L.info(m,s,"sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");}function g(s,o,t){var h=t.oCommonUtils.getNavigationHandler();var j=o.getOwnerComponent().getSmartVariantManagement();var r={appStateKey:"",urlParams:{},selectionVariant:"",tableVariantId:""};var k=false;var m=null;var A=Promise.resolve();var p=false;var D=false;var q=false;var u;var v;var w=t.oComponentUtils.getSettings();var x=null;var y=null;s.oSmartFilterbar.setSuppressSelection(true);var z=(function(){var i;return function(){i=i||s.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function E(){return D;}function F(){var o1={};var p1=[];var q1=z();for(var i=0;i<q1.length;i++){var r1=q1[i];if(s.oSmartFilterbar.isVisibleInFilterBarByName(r1)){p1.push(r1);}}var s1={suppressDataSelection:!D,visibleCustomFields:p1};o1[c]=s1;if(t.oComponentUtils.isDraftEnabled()){var t1=t.oComponentUtils.getTemplatePrivateModel();s1.editStateFilter=t1.getProperty("/listReport/vDraftState");var u1=t1.getProperty("/listReport/activeObjectEnabled");s1.activeStateFilter=u1;}var v1=s.oMultipleViewsHandler.getSelectedKeyPropertyName();if(v1){var w1=s.oMultipleViewsHandler.getContentForIappState();if(w1){s1[v1]=w1.state;}}if(s.oWorklistData.bWorkListEnabled){var x1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";var y1={"searchString":x1};s1.Worklist=y1;}var z1={};o1[a]=z1;o.getCustomAppStateDataExtension(z1);var A1;var B1=true;var C1=function(D1,E1){if(!(D1 instanceof C)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!B1){throw new Error("State must always be provided synchronously");}if(E1){A1=A1||Object.create(null);var F1=D1.getMetadata().getNamespace();A1[F1]=E1;}};o.templateBaseExtension.provideExtensionAppStateData(C1);B1=false;if(A1){o1[b]=A1;}return o1;}function G(){var o1=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());var p1=new S(o1);var q1=o.getVisibleSelectionsWithDefaults();for(var i=0;i<q1.length;i++){if(!p1.getValue(q1[i])){p1.addSelectOption(q1[i],"I","EQ","");}}if(o.byId('template::PageVariant')&&o.byId('template::PageVariant').currentVariantGetModified()&&p1.getID()){p1.setID("");}if(s.oWorklistData.bWorkListEnabled){var r1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";p1.addSelectOption("Worklist.SearchField","I","EQ",r1);}var s1={selectionVariant:p1.toJSONString(),tableVariantId:(!j&&s.oSmartTable.getCurrentVariantId())||"",customData:F()};return s1;}function H(){l("fnStoreCurrentAppStateAndAdjustURL called",{bAppStateDirty:q,bDataAreShownInTable:D});if(!q){return;}q=false;try{x=h.storeInnerAppStateWithImmediateReturn(G(),true);}catch(i){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: "+i);return;}if(x instanceof N){q=true;x=null;return;}x.promise.fail(function(o1){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Error when persisting appState"+o1);});l("Result received from storeInnerAppStateWithImmediateReturn",{appStateKey:x.appStateKey,sAppStateKeyInUrl:y});if(y===x.appStateKey){x=null;}else{l("Call NavigationHandler.replaceHash",{appStateKey:x.appStateKey});h.replaceHash(x.appStateKey);}}function R(o1,p1){var q1=t.oComponentUtils.getTemplatePrivateModel();if(o1&&t.oComponentUtils.isDraftEnabled()){q1.setProperty("/listReport/vDraftState",o1.editStateFilter||"0");q1.setProperty("/listReport/activeObjectEnabled",!!o1.activeStateFilter);s.oMultipleViewsHandler.restoreActiveButtonState(o1);}var r1=o1&&o1.visibleCustomFields;if(r1&&r1.length>0){var s1=s.oSmartFilterbar.getAllFilterItems();for(var i=0;i<s1.length;i++){var t1=s1[i];var u1=t1.getName();if(r1.indexOf(u1)!==-1){t1.setVisibleInFilterBar(true);}}}D=p1&&!(o1&&o1.suppressDataSelection);if(D&&!s.oWorklistData.bWorkListEnabled){s.oSmartFilterbar.search();h1(D);}var v1=s.oMultipleViewsHandler.getSelectedKeyPropertyName();if(v1&&o1[v1]){s.oMultipleViewsHandler.restoreFromIappState(o1[v1]);}}function J(i,j){if(j){var o1=i['sap-ui-fe-variant-id'];if(o1&&o1[0]){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(o1[0]);}}else{var p1=i['sap-ui-fe-variant-id'],q1=i['sap-ui-fe-filterbar-variant-id'],r1=i['sap-ui-fe-chart-variant-id'],s1=i['sap-ui-fe-table-variant-id'];K(q1&&q1[0],r1&&r1[0],s1&&s1[0],p1&&p1[0]);}}function K(i,o1,p1,q1){if(i||q1){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(i||q1);}if(s.oSmartTable&&(p1||q1)){s.oSmartTable.attachAfterVariantInitialise(function(r1){s.oSmartTable.setCurrentVariantId(p1||q1);});s.oSmartTable.setCurrentVariantId(p1||q1);}s.oMultipleViewsHandler.setControlVariant(o1,p1,q1);}function M(i){o.restoreCustomAppStateDataExtension(i||{});}function O(i){if(!i){return;}var o1=true;var p1=function(q1){if(!(q1 instanceof C)){throw new Error("State must always be retrieved with respect to a ControllerExtension");}var r1=q1.getMetadata().getNamespace();if(!o1){throw new Error("State must always be restored synchronously");}return i[r1];};o.templateBaseExtension.restoreExtensionAppStateData(p1);o1=false;}function P(i,o1){i=i||{};if(i.hasOwnProperty(a)&&i.hasOwnProperty(c)){O(i[b]);M(i[a]);R(i[c],o1);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}M(i);}s.oSmartFilterbar.fireFilterChange();}function Q(){return A.then(function(){if(r.appStateKey){return{"sap-iapp-state":r.appStateKey};}return{};});}function T(i){var o1=t.oComponentUtils.getTemplatePrivateModel();o1.setProperty("/generic/bDataAreShownInTable",i);}function V(i,o1){l("changeIappState called",{bFilterOrSettingsChange:i,bDataAreShown:o1,bDataAreShownInTable:D,bIsTransferringUrlStateToPageState:k,bAppStateDirty:q,bIgnoreFilterChange:p});if(p){return;}T(o1);if(k){return;}if(i||o1!==D){D=o1;if(!q){q=true;if(!s.oSmartFilterbar.isDialogOpen()){if(m){H();}else{setTimeout(H,0);}}}}}function W(i){var o1=s.oSmartFilterbar.determineMandatoryFilterItems(),p1;for(var q1=0;q1<o1.length;q1++){if(o1[q1].getName().indexOf("P_DisplayCurrency")!==-1){if(i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0]&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){p1=i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;if(p1){i.oSelectionVariant.addParameter("P_DisplayCurrency",p1);}}break;}}}function X(){var o1=s.oSmartFilterbar.determineMandatoryFilterItems();var p1=s.oSmartFilterbar.getFiltersWithValues();for(var i=0;i<o1.length;i++){if(p1.indexOf(o1[i])===-1){return true;}}return false;}function Y(i,o1,p1){l("fnAdaptToAppState called",{sNavType:p1,sAppStateKeyInUrl:y,sAppStateKey:i.appStateKey,storingInformationAppStateKey:x&&x.appStateKey});s.oSmartFilterbar.setSuppressSelection(false);s.sNavType=p1;var q1=i.appStateKey||"";if(k){return;}if(y===null){y=q1;}else if(q1!==y){return;}var r1=(!q1&&o1)||{};J(r1,j);k=true;var s1=i.selectionVariant||"";var t1=(!j&&i.tableVariantId)||"";var u1=i.oSelectionVariant||"";var v1={selectionVariant:u1,urlParameters:o1,selectedQuickVariantSelectionKey:""};var w1=new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant()));var x1=JSON.parse(JSON.stringify(w1));var y1=w1.getSelectOption(a);var z1=w1.getSelectOption(c);if((r.appStateKey!==q1||r.selectionVariant!==s1||r.tableVariantId!==t1||f(r.urlParams,r1))&&p1!==sap.ui.generic.app.navigation.service.NavType.initial){if(!x||x.appStateKey!==q1){var A1=i&&i.bNavSelVarHasDefaultsOnly;if((i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1)&&(i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1)&&(i.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1)){W(i);}if(!s.oWorklistData.bWorkListEnabled){if(!A1||s.oSmartFilterbar.isCurrentVariantStandard()){v1.selectionVariant=i.oSelectionVariant;if(p1!==sap.ui.generic.app.navigation.service.NavType.iAppState){o.modifyStartupExtension(v1);n1(v1.selectionVariant,r,s1,true);}else{n1(v1.selectionVariant,r,s1,!A1);}}else{j1(w1,y1,z1,true);v1.selectionVariant=w1;o.modifyStartupExtension(v1);j1(v1.selectionVariant,y1,z1,false);if(!d(JSON.parse(JSON.stringify(v1.selectionVariant)),x1)){n1(v1.selectionVariant,r,s1,true);}}}if(t1!==r.tableVariantId){s.oSmartTable.setCurrentVariantId(t1);}i.customData=i.customData||{};if(s.oWorklistData.bWorkListEnabled){s.oWorklistData.oWorklistSavedData=i.customData[c]&&i.customData[c]["Worklist"]?i.customData[c]["Worklist"]:{};s.oWorklistHandler.restoreWorklistStateFromIappState();}P(i.customData,true);}r={appStateKey:q1,urlParams:r1,selectionVariant:s1,tableVariantId:t1};}if(p1!==sap.ui.generic.app.navigation.service.NavType.iAppState){if(p1===sap.ui.generic.app.navigation.service.NavType.initial){j1(w1,y1,z1,true);v1.selectionVariant=w1;o.modifyStartupExtension(v1);j1(v1.selectionVariant,y1,z1,false);if(!d(JSON.parse(JSON.stringify(v1.selectionVariant)),x1)){n1(v1.selectionVariant,r,s1,true);}}s.oMultipleViewsHandler.handleStartUpObject(v1);}if(m){m();m=null;}if(s.oWorklistData.bWorkListEnabled){if(p1==="initial"&&s.oSmartFilterbar.isCurrentVariantStandard()){s.oWorklistHandler.restoreWorklistStateFromIappState();}}else if(p1!==sap.ui.generic.app.navigation.service.NavType.iAppState&&!D){var B1=(p1===sap.ui.generic.app.navigation.service.NavType.xAppState||p1===sap.ui.generic.app.navigation.service.NavType.URLParams)&&!i.bNavSelVarHasDefaultsOnly;if(s.oSmartFilterbar.isCurrentVariantStandard()){D=s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardByUser;}else{D=s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();}var C1=s.oMultipleViewsHandler.getOriginalEnableAutoBinding();var D1=X();var E1=w.dataLoadSettings;var F1;if(E1){F1=E1.loadDataOnAppLaunch;}var G1=false;if(D===null||D===undefined||s.oSmartFilterbar.getLiveMode()){G1=B1||s.bLoadListAndFirstEntryOnStartup;if(!G1){if((F1===null||F1===undefined)&&(C1!==null&&C1!==undefined)){D=C1&&!D1?true:false;}else{D=e1(F1,D1);}}else{D=G1;}if(!D&&s.oSmartFilterbar.isCurrentVariantStandard()&&!s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardByUser&&s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardViaXML){s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardViaXML=false;D=false;}}T(D);if(D){s.oSmartFilterbar.search();h1(D);}}x=null;k=false;if(p1!==sap.ui.generic.app.navigation.service.NavType.iAppState){V(true,D);}}function Z(){if(!m){A=new Promise(function(o1){m=o1;});}var i=new Promise(function(o1){var p1=y;var q1=h.parseNavigation();q1.done(function(r1,s1,t1){Y(r1,s1,t1);o1();});q1.fail(function(r1,s1,t1){L.warning(r1.getErrorCode(),"app state could not be parsed - continuing with empty state","sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");Y({appStateKey:p1},s1,sap.ui.generic.app.navigation.service.NavType.initial);o1();});});return i;}function $(){p=true;var i=s.oSmartFilterbar.getFilterData();var o1,p1=s.oSmartFilterbar.getBasicSearchControl();if(p1&&p1.getValue){o1=p1.getValue();}var q1=G();i._CUSTOM=q1.customData;s.oSmartFilterbar.setFilterData(i,true);if(o1){p1.setValue(o1);}s.oSmartFilterbar.fireFilterChange();p=false;}function _(){V(true,D);}function a1(i){var o1=i.getParameter("context");var p1=s.oSmartFilterbar.getFilterData();if(p1._CUSTOM!==undefined){if(s.oWorklistData.bWorkListEnabled){var q1=p1._CUSTOM[c]["Worklist"];s.oSmartFilterbar.setSuppressSelection(false);s.oWorklistData.oSearchField.setValue(q1.searchString);s.oWorklistData.oSearchField.fireSearch();}else{P(p1._CUSTOM);}}else{var r1=F();n(r1[a]);n(r1[c]);P(r1);}if(I.indexOf(o1)<0){D=i.getParameter("executeOnSelect");V(true,D);}}function b1(){if(!j){V(true,D);}}function c1(){if(!j){V(true,D);}}function d1(i){y=i["sap-iapp-state"]||"";if(x){if(x.appStateKey!==y){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Got AppstateKey "+y+" expected "+x.appStateKey);return false;}Z();return true;}return false;}function e1(i,o1){var p1;var q1=s.oSmartFilterbar.getFiltersWithValues();switch(i){case"always":p1=!o1?true:false;break;case"never":p1=false;break;default:p1=q1.length&&!o1?true:false;}return p1;}function f1(){u=s.oSmartTable.getEnableAutoBinding();s.oSmartFilterbar.attachFiltersDialogClosed(H);}function g1(){var i;var o1=w.dataLoadSettings;if(o1){i=o1.loadDataOnAppLaunch;}var p1=s.oMultipleViewsHandler.getSelectedKeyPropertyName();var q1=p1==="tableTabData"||p1==="tableViewData"?true:false;v=q1?false:true;var r1=i===null||i===undefined?s.oMultipleViewsHandler.getEnableAutoBinding():true;u=v||r1;if(u){var s1=new sap.ui.core.CustomData({key:"executeStandardVariantOnSelect",value:true});s.oSmartFilterbar.addCustomData(s1);}}function h1(D){var i=o.getOwnerComponent().getModel("_templPriv");var o1=X();if(D&&o1){i.setProperty("/listReport/isHeaderExpanded",true);}else if(D){i.setProperty("/listReport/isHeaderExpanded",false);}else{i.setProperty("/listReport/isHeaderExpanded",true);}}function i1(i,o1,p1){var q1=new U({selectionVariant:i});s.oSmartFilterbar.setUiState(q1,{replace:o1,strictMode:p1});}function j1(i,o1,p1,q1){if(i&&(o1||p1)){if(q1){i.removeSelectOption(a);i.removeSelectOption(c);}else{i.massAddSelectOption(a,o1);i.massAddSelectOption(c,p1);}}}function k1(o1,r,p1){if(o1&&(r.selectionVariant!==p1||s.sNavType==="initial")){var q1=o1.getParameterNames().concat(o1.getSelectOptionsPropertyNames());for(var i=0;i<q1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(q1[i]);}}}function l1(i,o1,p1){if(i.getParameter(o1)&&!i.getParameter(p1)){i.addParameter(p1,i.getParameter(o1));}if(i.getSelectOption(o1)&&!i.getSelectOption(p1)){var q1=i.getSelectOption(o1);q1.forEach(function(r1){i.addSelectOption(p1,r1.Sign,r1.Option,r1.Low,r1.High);});}}function m1(i){var o1=o.getOwnerComponent().getModel().getMetaModel();var p1=o.getOwnerComponent().getEntitySet();var q1=o1.getODataEntityType(o1.getODataEntitySet(p1).entityType);q1.property.forEach(function(r1){if(r1["com.sap.vocabularies.Common.v1.EditableFieldFor"]){var s1=r1["com.sap.vocabularies.Common.v1.EditableFieldFor"].String;var t1=r1.name;l1(i,s1,t1);l1(i,t1,s1);}});}function n1(i,r,o1,p1){m1(i);if(p1){s.oSmartFilterbar.clearVariantSelection();}k1(i,r,o1);i1(i.toJSONObject(),p1,false);}s.getCurrentAppState=G;return{areDataShownInTable:E,parseUrlAndApplyAppState:Z,getUrlParameterInfo:Q,changeIappState:V,onSmartFilterBarInitialise:f1,onBeforeSFBVariantFetch:$,onAfterSFBVariantSave:_,onAfterSFBVariantLoad:a1,onAfterTableVariantSave:b1,onAfterApplyTableVariant:c1,isStateChange:d1,onSFBVariantInitialise:g1};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(s,o,t){e(this,g(s,o,t));}});});
