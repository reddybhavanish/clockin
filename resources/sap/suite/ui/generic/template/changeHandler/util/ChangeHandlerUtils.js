sap.ui.define(["sap/suite/ui/generic/template/js/AnnotationHelper","sap/suite/ui/generic/template/changeHandler/js/AnnotationHelperForDesignTime","sap/base/util/deepExtend"],function(A,a,d){"use strict";var O="sap.suite.ui.generic.template.ObjectPage.view.Details";var L="com.sap.vocabularies.UI.v1.LineItem";var D="com.sap.vocabularies.UI.v1.DataFieldForAnnotation";var b="com.sap.vocabularies.UI.v1.DataFieldForAction";var I="com.sap.vocabularies.UI.v1.DataFieldWithIntentBasedNavigation";var F="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation";var c="com.sap.vocabularies.UI.v1.FieldGroup";var e="com.sap.vocabularies.UI.v1.Identification";var S="com.sap.vocabularies.UI.v1.SelectionFields";var R="com.sap.vocabularies.UI.v1.ReferenceFacet";var C="com.sap.vocabularies.UI.v1.CollectionFacet";var f={};var m;f.isReveal=false;f.isRevert=false;f.getMetaModel=function(s,p){if(m){return m;}m={};var i=(s.source&&s.source.id)||s.parentId||(s.removedElement&&s.removedElement.id)||(s.selector&&s.selector.id);d(m,p.modifier.bySelector(i,p.appComponent).getModel().getMetaModel());return m;};f.getComponent=function(M){var o;while(M){if(M instanceof sap.ui.core.mvc.View){o=M.getController().getOwnerComponent();break;}else if(M instanceof sap.ui.core.UIComponent){o=M;break;}if(M.getParent){M=M.getParent();}else{break;}}return o;};f.getODataEntitySet=function(o){var M=o.getModel();var E=M&&o.getEntitySet&&o.getEntitySet();var m=M&&M.getMetaModel();return E&&m.getODataEntitySet(E);};f.getEntityType=function(E){var s;if(E){if(E.getEntityType){s=E.getEntityType();}else{var o=f.getComponent(E);var g=o&&o.getEntitySet();var m=E.getModel().getMetaModel();var h=g&&m&&m.getODataEntitySet(g);s=h&&h.entityType;}}return s;};f.getODataEntityType=function(M){var o;if(M){var g=f.getComponent(M);var E=g&&g.getEntitySet&&g.getEntitySet();var h=M.getModel();var i=h&&h.getMetaModel();if(i){var j=i.getODataEntitySet(E);var s=j&&j.entityType;o=i.getODataEntityType(s);if(M.getId().indexOf(O)>-1){var k=M.getMetadata&&M.getMetadata().getElementName&&M.getMetadata().getElementName();switch(k){case"sap.ui.comp.smarttable.SmartTable":case"sap.m.Table":case"sap.m.Column":var l=A.getSmartTableControl(M);var n=l&&l.getTableBindingPath();if(n){o=A.getRelevantDataForAnnotationRecord(i,n+'/',o).entityType;}break;case"sap.ui.comp.smartform.GroupElement":var p=M.getBindingContext().sDeepPath.split('/');var q=p[p.length-1];if(h.getMetaModel().getODataAssociationEnd(o,q)){o=A.getRelevantDataForAnnotationRecord(i,q+'/',o).entityType;}break;default:break;}}}}return o;};f.getSmartFormGroupInfo=function(g,h){var o,j,s;for(var i=0;i<h.length;i++){o=h[i];if(o&&o.Facets){j=f.getSmartFormGroupInfo(g,o.Facets);if(j){return j;}}else if(o&&o.Target&&o.Target.AnnotationPath&&(o.Target.AnnotationPath.indexOf(c)>=0)||(o.Target.AnnotationPath.indexOf(e)>=0)){s=(o.ID&&o.ID.String)||o.Target.AnnotationPath;if(s===g){return{aForm:h,oGroup:o};}}}};f.getCollectionFacet=function(s,g){var o;for(var i=0;i<g.length;i++){o=g[i];if(o&&o.ID&&o.ID.String===s){return o;}else if(o&&o.Facets){var h=f.getCollectionFacet(s,o.Facets);if(h){return h;}}}};f.createCollectionFacets=function(n,l){var N={"Label":{"String":l},"ID":{"String":"com.sap.vocabularies.UI.v1.CollectionFacet_"+a.getNextIdSuffix(true)},"Facets":n,"RecordType":"com.sap.vocabularies.UI.v1.CollectionFacet"};return N;};f.createNewFieldGroup=function(l){return{"Data":[{"Value":{"Path":l.Value?l.Value.Path:""},"RecordType":"com.sap.vocabularies.UI.v1.DataField"}],"RecordType":"com.sap.vocabularies.UI.v1.FieldGroupType"};};f.createFieldGroupTerm=function(E){var s="com.sap.vocabularies.UI.v1.FieldGroup#RTAGroup";var M=-1;for(var i in E){if(i.indexOf(s)>-1&&i.indexOf("RTAGroup")>-1){var g=i.substring(s.length);var h=parseInt(g,10);M=Math.max(h,M);}}M++;return s+M;};f.getSmartFilterBarControlConfiguration=function(v){var i=v.getContent()[0].getId();var s=i.substring(i.lastIndexOf("-")+1);var o=f.findSmartFilterBar(v);var g=o.getControlConfiguration().filter(function(h){return h.getKey()===s;})[0];return g;};f.findSmartFilterBar=function(E){if(!E){return;}if(E.getMetadata().getName()==="sap.ui.comp.smartfilterbar.SmartFilterBar"){return E;}else{return f.findSmartFilterBar(E.getParent());}};f.getIndexFromInstanceMetadataPath=function(o){var r=-1;var t=f.getTemplatingInfo(o);if(t&&t.path){r=parseInt(t.path.substring(t.path.lastIndexOf("/")+1),10);}return r;};f.fnIsSubsectionsPresent=function(o){return(o.RecordType===C&&o.Facets[0].RecordType===C&&o.Facets.length);};f.fnAddSubSection=function(p,g,t){var s="com.sap.vocabularies.UI.v1.FieldGroup#RTAGroup"+a.getNextIdSuffix(true);var n={"Label":{"String":"New Group"},"Target":{"AnnotationPath":"@"+s},"RecordType":R};var h=[];var i=f.getIndexFromInstanceMetadataPath(p);if(!f.fnIsSubsectionsPresent(g[i])){if(g[i].RecordType===R){h.push(g[i]);var E=f.createCollectionFacets(h,"New SubSection");}else{var E=g[i];}var N=f.createCollectionFacets([n],"New Subsection");var j=[E,N];var o=f.createCollectionFacets(j,g[i].Label.String);g.splice(i,1,o);}else{var j=[n];var o=f.createCollectionFacets(j,"New SubSection");g[i].Facets.splice(t,0,o);}return s;};f.fnMoveSubSection=function(u,U,i,g,h){var s=f.getIndexFromInstanceMetadataPath(u);var t=f.getIndexFromInstanceMetadataPath(U);var j=[];if(!f.fnIsSubsectionsPresent(h[t])){if(h[t].RecordType===R){j.push(h[t]);}else{for(var o in h[t].Facets){j.push(h[t].Facets[o]);}}if(j[0].RecordType===R){var T=f.createCollectionFacets(j,h[t].Label.String);if(h[s].Facets){var k=h[s].Facets[i];}else{var k=f.createCollectionFacets([h[s]],h[s].Label.String);}var r=[T];r.splice(g,0,k);}else{var k=h[s].Facets[i];var r=[k];for(var o in j){r.push(j[o]);}}var n=f.createCollectionFacets(r,h[t].Label.String);h.splice(t,1,n);if(!h[s].Facets||!h[s].Facets.length){h.splice(s,1);}else{h[s].Facets.splice(i,1);if(h[s].Facets&&!h[s].Facets.length){h.splice(s,1);}}}else if(h[s].RecordType===R){var l=h[s];var p=f.createCollectionFacets([l],h[s].Label.String);h[t].Facets.splice(g,0,p);h.splice(s,1);}else{if(h[s].Facets[0].RecordType===R){h[t].Facets.splice(g,0,h.splice(s,1)[0]);}else{h[t].Facets.splice(g,0,h[s].Facets.splice(i,1)[0]);if(h[s].Facets&&!h[s].Facets.length){h.splice(s,1);}}}};f.fnRemoveSubSection=function(r,g){var p=r.getParent();var i=f.getIndexFromInstanceMetadataPath(r);if(i>=0){var s=f.getIndexFromInstanceMetadataPath(p);g[s].Facets.splice(i,1);}};f.getUIHeaderFacets=function(o){var u=[];switch(o.getMetadata().getElementName()){case"sap.uxap.ObjectPageHeaderContent":u=o.getContent();break;case"sap.m.FlexBox":u=o.getItems();break;}return u;};f.getHeaderFacetIndex=function(h,g,u,j){if(h&&h.getMetadata().getElementName()==="sap.m.VBox"){if(f.getTemplatingInfo(h)){return f.getIndexFromInstanceMetadataPath(h);}else{if(h.getId().indexOf("AfterImageExtension")>-1){return 0;}if(!u){u=f.getUIHeaderFacets(h.getParent());}if(!j){for(var i=0;i<u.length;i++){if(u[i].getId()===h.getId()){j=i;break;}}}if(h.getId().indexOf("BeforeReferenceExtension")>-1){return f.getHeaderFacetIndex(u[j+1],g,u,j+1);}else if(h.getId().indexOf("AfterReferenceExtension")>-1){return f.getHeaderFacetIndex(u[j-1],g,u,j-1);}else{var o,k=g.length-1;for(var i=j;i<u.length;i++){o=u[i+1];if(o&&f.getTemplatingInfo(o)){k=f.getIndexFromInstanceMetadataPath(o)-1;break;}}return k;}}}else{return-1;}};f.getCustomDataObject=function(E){var g=E.getCustomData(),o={};if(!g){return;}for(var i=0;i<g.length;i++){o[g[i].getKey()]=g[i].getValue();}return o;};f.getGroupElements=function(E,t){var g=t.annotation;var o=f.getODataEntityType(E);var h=o&&o[g];return h['Data']||h;};f.getGroupElementRecordIndex=function(E,g){if(!E||!g){return;}var t=f.getTemplatingInfo(E);var h=t.annotationContext;var r=-1;if(h&&g&&g.length>0){for(var i=0;i<g.length;i++){if(h.RecordType&&(!g[i].RecordType||(g[i].RecordType!==h.RecordType))){continue;}if(h.Action&&h.Action.String&&(!g[i].Action||g[i].Action.String!==h.Action.String)){continue;}if(h.Action&&h.Action.Path&&(!g[i].Action||g[i].Action.Path!==h.Action.Path)){continue;}if(h.SemanticObject&&h.SemanticObject.String&&(!g[i].SemanticObject||(g[i].SemanticObject.String!==h.SemanticObject.String))){continue;}if(h.SemanticObject&&h.SemanticObject.Path&&(!g[i].SemanticObject||(g[i].SemanticObject.Path!==h.SemanticObject.Path))){continue;}if(h.Target&&h.Target.AnnotationPath&&(!g[i].Target||(g[i].Target.AnnotationPath!==h.Target.AnnotationPath))){continue;}if(h.Value&&h.Value.Path&&(!g[i].Value||(g[i].Value.Path!==h.Value.Path))){continue;}r=i;break;}}return r;};f.getLineItems=function(E){var o;var l=L;if(E.getId().indexOf(O)>-1){E=A.getSmartTableControl(E);var s=A.getLineItemQualifier(E.getCustomData());l=s?l+"#"+s:l;}o=f.getODataEntityType(E);return o&&o[l];};f.getLineItemRecordIndex=function(o,l){if(!o){return;}if(!l){l=f.getLineItems(o);}if(!l){return;}var r=-1,i,p=o.data("p13nData");if(!p||!l||l.length===0){return r;}if(!p.columnKey||p.columnKey.search("template::")===-1){for(i=0;i<l.length;i++){if(l[i].Value&&l[i].Value.Path===p.leadingProperty){return i;}}return r;}var t=p.columnKey.split("::");switch(t[1]){case"DataFieldForAction":for(i=0;i<l.length;i++){if(l[i].RecordType===b&&l[i].Action.String===t[2]){return i;}}break;case"DataFieldForAnnotation":for(i=0;i<l.length;i++){if(l[i].RecordType===D&&l[i].Target&&l[i].Target.AnnotationPath&&l[i].Target.AnnotationPath.replace("@","")===t[2]){return i;}}break;case"DataFieldWithIntentBasedNavigation":for(i=0;i<l.length;i++){if(l[i].RecordType===I&&l[i].SemanticObject.String===t[2]&&l[i].Action.String===t[3]){return i;}}break;case"DataFieldForIntentBasedNavigation":for(i=0;i<l.length;i++){if(l[i].RecordType===F&&l[i].SemanticObject.String===t[2]&&l[i].Action.String===t[3]&&l[i].Inline&&l[i].Inline.Bool==="true"){return i;}}break;default:for(i=0;i<l.length;i++){if(l[i].Value&&l[i].Value.Path===p.leadingProperty){return i;}}break;}return r;};f.getLineItemRecordIndexForButton=function(B,l){if(!l){l=f.getLineItems(B);}if(!l){return;}var o=f.getCustomDataObject(B),g=-1,E;for(var i=0;i<l.length;++i){E=l[i];if(E.RecordType===b&&E.Action&&E.Action.String===o.Action||E.RecordType===F&&E.Action&&E.Action.String===o.Action&&E.SemanticObject&&E.SemanticObject.String===o.SemanticObject){g=i;break;}}return g;};f.getRemoveElementSelector=function(r,p){var s=p.modifier.bySelector(r,p.appComponent).getContent()[1].sId;return p.modifier.getSelector(s,p.appComponent);};f.getRecordIndexForSelectionFieldFromAnnotation=function(v,g){var t=0;var E=sap.ui.getCore().byId(v.sId).getContent()[0].getHeader().getContent()[0].getContent()[0].getContent();var o=this.index>=E.length?1:0;var h=E[this.index-o];var T=f.getTemplatingInfo(f.getSmartFilterBarControlConfiguration(h));if(T&&T.annotation===S){g.some(function(j,i){if(j.PropertyPath===T.value){t=i+o;return true;}});}return t;};f.getRecordIndexForSelectionField=function(v){var t=-1,E=v.getParent().getParent().getEntityType(),m=v.getModel().getMetaModel(),o=m.getODataEntityType(E),s=o&&o[S];var T=f.getTemplatingInfo(f.getSmartFilterBarControlConfiguration(v));if(T&&T.annotation===S){s.some(function(g,i){if(g.PropertyPath===T.value){t=i;return true;}});}return t;};f.getLineItemRecordForButton=function(B){var l=f.getLineItems(B);if(!l){return;}var i=f.getLineItemRecordIndexForButton(B,l);return l[i];};f.getLineItemRecordForColumn=function(o){var l=f.getLineItems(o);if(!l){return;}var i=f.getLineItemRecordIndex(o,l);return l[i];};f.getTemplatingInfo=function(E){var t,T;if(E){T=E.data("sap-ui-custom-settings")&&E.data("sap-ui-custom-settings")["sap.ui.dt"]&&E.data("sap-ui-custom-settings")["sap.ui.dt"].annotation;if(T&&typeof(T)==="string"){t=JSON.parse(T);}}return t||T;};f.getPropertyOfColumn=function(o){var p=o.data("p13nData"),P=p&&p.leadingProperty;return P;};f.getODataPath=function(o,g){var s,t=-1,h,E=o.getElement(),m=E.getModel().getMetaModel(),j=o.getDesignTimeMetadata()&&o.getDesignTimeMetadata().getData();if(j&&typeof j.getCommonInstanceData==="function"){h=j.getCommonInstanceData(E);}if(!h){if(!g||!g.target){return;}for(var i=0;i<g.target.length;i++){if(g.target[i]==="EntityType"){t=i;break;}else if(g.target[i]==="EntitySet"){t=i;}}if(t>-1){var k=f.getEntityType(E);if(!m.getODataEntityType){return;}var l=m.getODataEntityType(k);switch(g.target[t]){case"EntityType":s=l&&l.namespace+"."+l.name;break;case"EntitySet":var n=f.getComponent(E);var p=f.getODataEntitySet(n);var q=p&&p.name;s=l&&l.namespace+"."+q;break;default:return;}}}else{s=h.target;}if(s&&g&&g.target){s+="/"+g.namespace+"."+g.annotation;}return s;};f.getEntityTypeFromAnnotationPath=function(E,s){var o;if(!E||!s){return o;}var m=E.getModel()&&E.getModel().getMetaModel();if(!m){return o;}o=f.getODataEntityType(E);if(s.search("/")>-1){o=A.getRelevantDataForAnnotationRecord(m,s,o).entityType;}return o;};f.fnAdaptTableStructures=function(t){var B=t.getBindingInfo("items");var o=t.getColumns(true);if(B&&B.template){var T=B.template;var g=T.getCells();if(g.length===o.length){var h=[];for(var i=0;i<o.length;i++){h.push(g[t.indexOfColumn(o[i])]);}B.template=null;t.unbindItems();t.removeAllColumns();T.removeAllCells();for(var i=0;i<o.length;i++){if(o[i].getVisible()){t.addColumn(o[i]);T.addCell(h[i]);}}B.template=T;t.bindItems(B,B.model);return;}}throw new Error("Unsupported Operation");};f.getPropertiesForCustomPopUp=function(o,t){if(!o||!t){return[];}var g=f.getComponent(o);var E=f.getODataEntityType(g);var p=E.property;var P=[];switch(t){case'table':o=o.getParent();p.map(function(h){if(!h["com.sap.vocabularies.UI.v1.Hidden"]||h["com.sap.vocabularies.UI.v1.Hidden"].Bool==='false'){var v=o.getUiState().getPresentationVariant().Visualizations;var s=v[0].Content;var i=h.name;var j=s.some(function(k){return k.Value===i;});if(!j){P.push(h);}}});break;case'filter':p.map(function(h){if((!h["com.sap.vocabularies.UI.v1.Hidden"]||h["com.sap.vocabularies.UI.v1.Hidden"].Bool==='false')&&(!h["sap:filterable"]||!(h["sap:filterable"]==='false'))){P.push(h);}});break;}return P;};return f;});
