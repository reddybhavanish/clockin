sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/generic/app/transaction/DraftContext","sap/m/MessageToast","sap/base/Log","sap/base/util/extend","sap/base/util/each"],function(M,D,a,L,e,b){"use strict";var Q=M.extend("sap.suite.ui.generic.template.js.QuickTemplates.QuickCreateAPI",{metadata:{library:"sap.suite.ui.generic.template",properties:{},events:{objectCreated:{parameters:{context:{type:"sap.ui.model.Context"}}},destroyed:{parameters:{collectionItemGuid:{type:"String"}}},autofillLineItems:{parameters:{numberOfLineItems:{type:"Number"}}}}}});Q.EVENT_CONSTANTS={EventChannel:"sap.fiori.cp.quickactions.EventChannel",QUICKCREATE_LINE_ITEMS_FOUND:"LineItemsFound",QUICKCREATE_VIEW_CREATED:"QuickCreateViewCreated"};var A="items",c="participants";Q.CopilotModelName="FioriCopilotODataModel";Q._Instances={};Q.getInstance=function(C){if(!C){return undefined;}if(C.copilotEntity){return Q._Instances[C.copilotEntity.getODataKey()];}else{return Q._Instances[C];}};Q.createAPI=function(C,o,d){function g(){return d.getView().getBindingContext().getObject();}function f(){return d.getQuickCreateItem();}function h(){return o;}function j(){return C;}function k(){return sap.ui.getCore().getModel(Q.CopilotModelName);}function u(i){if(this._bDestroyed){return;}var P=this.getQuickCreateItem();if(P.draftid===i){return;}P.draftid=i;P.copilotEntity.update(P,{error:function(R){L.error(R,"","QuickCreateAPI");}});}function l(){return o.getAggregation("rootControl");}function m(){return this.oRootView;}function s(i){this.oRootView=i;this.calculateViewHeight(this.oRootView,true);}function n(){if(this.oRootView&&this.oRootView.getController()&&this.oRootView.getController().bDraftEnabled!==undefined){return this.oRootView.getController().bDraftEnabled;}if(!this.oRootView||!this.oRootView.getBindingContext()){return undefined;}var i=new D(this.getQuickCreateModel());return i.hasDraft(this.oRootView.getBindingContext());}function p(){var i=this.getComponentInstance().getModel();if(!i&&this.oRootView){i=this.oRootView.getModel();}return i;}function q(){return d.isCurrentUserCreator();}function r(){if(!this.oRootView){return undefined;}return this.oRootView.getBindingContext();}function t(){var i=this.getQuickCreateRootBindingContext();if(i&&i.getObject()){return i.getObject().__metadata.type;}return undefined;}function _(i,P,R){var S=R.numberOfLineItems;if(S<=0){return;}this.fireAutofillLineItems({numberOfLineItems:S});}function v(){this._attachToModelBindingChanges();if(!this.oRootView){var V=d.oViewUtils.findFirstViewFromControlHierarchy(this.getRootControl());if(V){this.setRootView(V);}}}function w(){if(!this._bBindingChangeAttached){var i=o.getModel();if(i){var P=i.addBinding.bind(i);var R=this;i.addBinding=function(S){P(S);S.attachEvent("change",R._onDataBindingChanged);};this._bBindingChangeAttached=true;}}}function x(){return new Promise(function(i,P){var R=this.getCopilotModel();R.read("/"+R.getKey(this.getQuickCreateItem()),{success:function(S,T){if(S.modeljson){var U=this.getQuickCreateModel();this._loadingJSON=true;if(this.isDraftEnabled()){U.oData=JSON.parse(S.modeljson);}else{var V=JSON.parse(S.modeljson);U.mChangedEntities=V.mChangedEntities;U.mChangeHandles=V.mChangeHandles;U.mDeferredRequests=V.mDeferredRequests;U.oData=V.oData;}U.updateBindings();}if(i){i();}delete this._loadingJSON;}.bind(this),error:function(S){if(P){P(S);}}});}.bind(this));}function y(){if(!this._oUpdateModelJSONTimer){this._oUpdateModelJSONTimer=setTimeout(this._updateModelJSON,2000);}}function z(){if(this._loadingJSON||this._bDestroyed||!this.isCurrentUserCreator()){return;}this._oUpdateModelJSONTimer=null;var P=this.getQuickCreateItem();var R=this.getQuickCreateModel();var S="";if(this.isDraftEnabled()){var T={};var U=Object.keys(R.mChangedEntities);var V=Object.keys(R.oData);var W={};b(V,function(i,Y){if(R.mChangedEntities[Y]){W={};e(W,R.oData[Y]);e(W,R.mChangedEntities[Y]);T[Y]=W;}else{T[Y]=R.oData[Y];}});b(U,function(i,Y){if(!T[Y]){T[Y]=R.mChangedEntities[Y];}});S=JSON.stringify(T);}else{var X={};X.mChangedEntities=R.mChangedEntities;X.mChangeHandles=R.mChangeHandles;X.mDeferredRequests=R.mDeferredRequests;X.oData=R.oData;S=JSON.stringify(X);}if(S===P.modeljson){return;}P.modeljson=S;P.copilotEntity.update(P,{error:function(i){L.error(i,"","QuickCreateAPI");}});}function B(){return new Promise(function(i,P){var R=this.getQuickCreateModel();if(this.oRootView&&this.oRootView.getBindingContext()){if(this.isDraftEnabled()){R.remove(this.oRootView.getBindingContext().getPath(),{success:function(){a.show("Draft has been discarded");i();},error:function(S){P(S);}});}else{R.resetChanges();i();}}else{i();}}.bind(this));}function E(V,i){if(V){d.calculateViewHeight(V,i);}}function F(i){d.setComponentContainerHeight(i);}function G(i){if(this._bDestroyed){return;}this.fireObjectCreated({context:i});}function H(){sap.ui.getCore().getEventBus().publish(Q.EVENT_CONSTANTS.EventChannel,Q.EVENT_CONSTANTS.QUICKCREATE_VIEW_CREATED,{api:this});}function I(){if(this._bDestroyed){return;}if(this._oUpdateModelJSONTimer){clearTimeout(this._oUpdateModelJSONTimer);this._oUpdateModelJSONTimer=null;}delete Q._Instances[this._InstanceKey];if(C&&!C._bIsBeingDestroyed&&!C.bIsDestroyed){C.destroy();}this.oRootView=undefined;sap.ui.getCore().getEventBus().unsubscribe(Q.EVENT_CONSTANTS.EventChannel,Q.EVENT_CONSTANTS.QUICKCREATE_LINE_ITEMS_FOUND,this._onLineItemsFound,this);this.fireDestroyed({collectionItemGuid:this._InstanceKey});M.prototype.destroy.call(this);this._bDestroyed=true;}function J(P,i){if(this.getCollectionItem()&&this.getCollectionItem().copilotEntity&&this.getCollectionItem().copilotEntity.getParentEntity()&&this.getCollectionItem().copilotEntity.getParentEntity().copilotEntity){if(P===A){return this.getCollectionItem().copilotEntity.getParentEntity().copilotEntity.getItemsPublic(i);}else if(P===c){return this.getCollectionItem().copilotEntity.getParentEntity().copilotEntity.getParticipantsPublic();}else{return new Promise(function(R,S){if(S){S("Error: "+P+" is not a valid part of a collection.");}else{R([]);}});}}return new Promise(function(R,S){if(S){S("Error: Cannot load collection "+P+". Copilot collection entity cannot be accessed");}else{R([]);}});}function K(i){return J.call(this,A,i);}function N(){return J.call(this,c);}var O=new Q();O.COLLECTION_ITEM_TYPES={};O.COLLECTION_ITEM_TYPES.ITEM_TYPE_NOTE="NOTE";O.COLLECTION_ITEM_TYPES.ITEM_TYPE_RELOBJ="RO";O.COLLECTION_ITEM_TYPES.ITEM_TYPE_SCREENSHOT="SCRS";O.COLLECTION_ITEM_TYPES.ITEM_TYPE_IMAGE="IMG";O.COLLECTION_ITEM_TYPES.ITEM_TYPE_DOCUMENT="DOC";O.COLLECTION_ITEM_TYPES=Object.freeze(O.COLLECTION_ITEM_TYPES);e(O,{getCollectionItem:g.bind(O),getQuickCreateItem:f.bind(O),updateDraftID:u.bind(O),getRootControl:l.bind(O),isDraftEnabled:n.bind(O),isCurrentUserCreator:q.bind(O),getQuickCreateRootBindingContext:r.bind(O),getQuickCreateRootEntityType:t.bind(O),_onComponentContainerAfterRendering:v.bind(O),calculateViewHeight:E.bind(O),setComponentContainerHeight:F.bind(O),getQuickCreateModel:p.bind(O),objectCreated:G.bind(O),destroy:I.bind(O),getRootView:m.bind(O),setRootView:s.bind(O),getComponentInstance:h.bind(O),getComponentContainer:j.bind(O),_onDataBindingChanged:y.bind(O),_attachToModelBindingChanges:w.bind(O),loadQuickCreateModelFromJSON:x.bind(O),_updateModelJSON:z.bind(O),getCopilotModel:k.bind(O),discardQuickCreateDraft:B.bind(O),_onLineItemsFound:_.bind(O),fireQuickCreateViewCreated:H.bind(O),getCollectionItems:K.bind(O),getCollectionParticipants:N.bind(O)});C.addEventDelegate({onAfterRendering:O._onComponentContainerAfterRendering});O._InstanceKey=O.getCollectionItem().copilotEntity.getODataKey();if(Q._Instances[O._InstanceKey]){Q._Instances[O._InstanceKey].destroy();}delete Q._Instances[O._InstanceKey];Q._Instances[O._InstanceKey]=O;sap.ui.getCore().getEventBus().subscribe(Q.EVENT_CONSTANTS.EventChannel,Q.EVENT_CONSTANTS.QUICKCREATE_LINE_ITEMS_FOUND,O._onLineItemsFound,O);o.oQuickCreateAPI=O;return o.oQuickCreateAPI;};return Q;},true);
