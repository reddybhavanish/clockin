/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/UIComponent","sap/m/NavContainer","sap/f/FlexibleColumnLayout","sap/ui/model/base/ManagedObjectModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/odata/MessageScope","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/generic/app/ApplicationController","sap/suite/ui/generic/template/lib/Application","sap/suite/ui/generic/template/lib/BusyHelper","sap/suite/ui/generic/template/lib/DataLossHandler","sap/suite/ui/generic/template/lib/NavigationController","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/TemplateAssembler","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/ViewDependencyHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/support/lib/CommonMethods","sap/base/Log","sap/base/util/extend","sap/base/util/isPlainObject"],function(U,N,F,M,a,b,c,J,R,A,d,B,D,e,P,T,C,V,t,f,L,g,h){"use strict";A=t.observableConstructor(A);var j=sap.m.DraftIndicatorState;var r=T.getRegisterAppComponent();var o;function k(){o=o||new R({bundleName:"sap/suite/ui/generic/template/lib/i18n/i18n"}).getResourceBundle();return o.getText.apply(o,arguments);}function l(){return new P({processObservers:[]});}var m=sap.ui.getCore().getMessageManager().getMessageModel();var v=new a({path:"validation",operator:b.EQ,value1:true});function n(p,q){var s={oAppComponent:p,componentRegistry:Object.create(null),aRunningSideEffectExecutions:[],getText:k,mRouteToTemplateComponentPromise:Object.create(null),oTemplatePrivateGlobalModel:(new J()).setDefaultBindingMode("TwoWay"),aStateChangers:[],oPaginatorInfo:Object.create(null),oStatePreserversAvailablePromise:Promise.resolve(),oValidationMessageBinding:m.bindList("/",null,null,v)};s.oDataLossHandler=new D(s);s.oValidationMessageBinding.attachChange(Function.prototype);var u;var w;var x;function y(){var i=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("URLParsing");s.oTemplatePrivateGlobalModel.setProperty("/generic",{crossAppNavSupport:!!i&&i.isIntentUrl(document.URL),draftIndicatorState:j.Clear,shellServiceUnavailable:false,forceFullscreenCreate:false});p.setModel(s.oTemplatePrivateGlobalModel,"_templPrivGlobal");s.oShellServicePromise.catch(function(){s.oTemplatePrivateGlobalModel.setProperty("/generic/shellServiceUnavailable",true);});var m=sap.ui.getCore().getMessageManager().getMessageModel();p.setModel(m,"_templPrivMessage");}function z(){s.fnAddSideEffectPromise=function(h1){var i=0;for(;s.aRunningSideEffectExecutions[i];){i++;}s.aRunningSideEffectExecutions[i]=h1;var i1=function(){s.aRunningSideEffectExecutions[i]=null;};h1.then(i1,i1);};u.attachEvent("beforeSideEffectExecution",function(i){if(i.getParameter("valueChange")||i.getParameter("fieldControl")){var h1=i.getParameter("promise");setTimeout(s.oBusyHelper.setBusy.bind(null,h1),1000);s.fnAddSideEffectPromise(h1);}});var f1=p.getModel("_templPrivGlobal");var g1="/generic/draftIndicatorState";u.attachBeforeQueueItemProcess(function(i){if(i.draftSave){f1.setProperty(g1,j.Saving);}});u.attachOnQueueCompleted(function(){if(f1.getProperty(g1)===j.Saving){f1.setProperty(g1,j.Saved);}});u.attachOnQueueFailed(function(){if(f1.getProperty(g1)===j.Saving){f1.setProperty(g1,j.Clear);}});f1.setProperty("/generic/appComponentName",p.getMetadata().getComponentName());}function E(){var i={appComponent:p,oTemplateContract:s,application:new d(s),oViewDependencyHelper:new V(s)};s.oViewDependencyHelper=i.oViewDependencyHelper;s.oShellServicePromise=p.getService("ShellUIService").catch(function(){var i1=sap.ui.core.service.ServiceFactoryRegistry.get("sap.ushell.ui5service.ShellUIService");return((i1&&i1.createInstance())||Promise.reject());});s.oShellServicePromise.catch(function(){L.warning("No ShellService available");});var f1=Z().settings||Object.create(null);p.applySettings(f1);(U.prototype.init||Function.prototype).apply(p,arguments);s.appSettings=new M(p);s.oBusyHelper.setBusy(s.oShellServicePromise);x=r(i);var g1=p.getModel();s.bCreateRequestsCanonical=true;var h1=g1.messageScopeSupported();s.oBusyHelper.setBusy(h1);h1.then(function(i1){if(i1){g1.setMessageScope(c.BusinessObject);s.bCreateRequestsCanonical=false;}u=new A(g1);y();w=new e(s);z();C.enableAutomaticDraftSaving(s);if((!g1.oMetadata||!g1.oMetadata.isLoaded())||g1.oMetadata.isFailed()){g1.attachMetadataFailed(function(){w.navigateToMessagePage({title:k("ST_GENERIC_ERROR_TITLE"),text:k("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE"),icon:"sap-icon://message-error",description:k("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC")});for(var j1 in s.componentRegistry){s.componentRegistry[j1].fnViewRegisteredResolve(true);}});}if(p&&p.getMetadata()&&p.getMetadata().getManifest()){f.setAppComponent(p);}f.setApplicationStatus(f.mApplicationStatus.LOADING);f.publishEvent("elements","ViewRenderingStarted",{});});}function G(){if(s.oNavigationHost){return"";}if(s.sRoutingType==="f"){var i=new F();s.oNavigationHost=i;s.aNavigationObservers=[new P({processName:"BeginColumnNavigation",eventHandlers:{attachProcessStart:i.attachBeginColumnNavigate.bind(i),attachProcessStop:i.attachAfterBeginColumnNavigate.bind(i)}}),new P({processName:"MidColumnNavigation",eventHandlers:{attachProcessStart:i.attachMidColumnNavigate.bind(i),attachProcessStop:i.attachAfterMidColumnNavigate.bind(i)}}),new P({processName:"EndColumnNavigation",eventHandlers:{attachProcessStart:i.attachEndColumnNavigate.bind(i),attachProcessStop:i.attachAfterEndColumnNavigate.bind(i)}})];s.oNavigationObserver=new P({processObservers:s.aNavigationObservers});s.aHeaderLoadingObservers=[l(),l(),l()];}else{var f1=new N({id:p.getId()+"-appContent"});s.oNavigationHost=f1;s.oNavigationObserver=new P({processName:"Navigation",eventHandlers:{attachProcessStart:f1.attachNavigate.bind(f1),attachProcessStop:f1.attachAfterNavigate.bind(f1)}});}s.oHeaderLoadingObserver=new P({processObservers:s.aHeaderLoadingObservers||[]});s.oPagesDataLoadedObserver=new P({processObservers:[s.oHeaderLoadingObserver,s.oNavigationObserver]});s.oNavigationHost.addStyleClass(s.oApplicationProxy.getContentDensityClass());s.oBusyHelper=new B(s);s.oBusyHelper.setBusyReason("HashChange",true,true);s.oBusyHelper.getUnbusy().then(function(){s.oShellServicePromise.then(function(g1){g1.setBackNavigation(s.oApplicationProxy.onBackButtonPressed);});});return s.oNavigationHost;}function H(){if(s.oNavigationHost){s.oNavigationHost.destroy();}if(u){u.destroy();}if(w){w.destroy();}if(s.oValidationMessageBinding){s.oValidationMessageBinding.destroy();}f.setAppComponent(null);(U.prototype.exit||Function.prototype).apply(p,arguments);x();t.endApp(q);}function I(i){var f1=Object.keys(i).map(function(g1){var h1=i[g1];if(h1.pages){h1.pages=I(h1.pages);}return i[g1];});return f1;}function K(Y){if(Y._version==="1.3.0"&&Y.pages&&h(Y.pages)){Y.pages=I(Y.pages);}}function O(f1,g1){if(!f1){return;}for(var i=0;i<f1.length;i++){var h1=f1[i];if(h1.routingSpec&&h1.routingSpec.noOData){h1.entitySet=h1.routingSpec.routeName;if(g1>1){h1.navigationProperty=h1.routingSpec.routeName;}}O(h1.pages,g1+1);if(h1.embeddedComponents){for(var i1 in h1.embeddedComponents){var j1=h1.embeddedComponents[i1];if(j1.pages){j1.pages=I(j1.pages);O(j1.pages,g1+1);}}}if(h1.implementingComponent&&h1.implementingComponent.pages){h1.implementingComponent.pages=I(h1.implementingComponent.pages);O(h1.implementingComponent.pages,g1+1);}}}function Q(Y){O(Y.pages,0);}function S(i){if(i){var f1=i.entitySet;var g1=(i.component&&i.component.settings&&i.component.settings.quickVariantSelectionX&&i.component.settings.quickVariantSelectionX.variants)||{};var h1=function(g1){for(var i1 in g1){var j1=g1[i1];if(j1.entitySet){return true;}}return false;};if(h1(g1)){for(var i1 in g1){var j1=g1[i1];if(j1.entitySet===undefined){j1.entitySet=f1;}}}}}function W(Y){S(Y.pages[0]);}function X(i){if(i&&i.objectPageDynamicHeaderTitleWithVM){i.objectPageHeaderType=i.objectPageHeaderType||"Dynamic";i.objectPageVariantManagement=i.objectPageVariantManagement||"VendorLayer";}}var Y;function Z(){if(!Y){var i=p.getMetadata();Y=i.getManifestEntry("sap.ui.generic.app");if(!Y){return Object.create(null);}K(Y);Q(Y);W(Y);X(Y.settings);}return Y;}var $;function _(){if(!$){$=g({},p.getMetadata().getManifest());$["sap.ui.generic.app"]=Z();}return $;}function a1(){var i=p.getFlexibleColumnLayout();s.sRoutingType=i?"f":"m";return"sap."+s.sRoutingType+".routing.Router";}var b1=Promise.resolve();function c1(){var i=new Promise(function(f1){b1.then(function(){var g1=[];s.oNavigationControllerProxy.getActiveComponents().forEach(function(h1){var i1=s.componentRegistry[h1];var j1=i1.oComponent.getComponentContainer();var k1=j1.getParent();if(k1.getMetadata().getName()!=="sap.m.NavContainer"){throw new Error("Recreation only possible for sap.m.NavContainer");}var l1=s.oNavigationControllerProxy.createComponentInstance(s,i1.routeConfig,s.oNavigationControllerProxy.mRouteToComponentResolve[i1.route]);g1.push(l1.loaded().then(function(l1){var m1=j1.getComponentInstance().getBindingContext();k1.removePage(j1);k1.addPage(l1);k1.to(l1);j1.destroy();var n1=l1.getComponentInstance();var o1=s.componentRegistry[n1.sId];s.mRouteToTemplateComponentPromise[i1.route]=Promise.resolve(n1);if(m1){Promise.all([o1.viewRegistered,o1.reuseComponentsReady]).then(function(){o1.utils.bindComponent(m1.getPath(),true);});}return o1.oViewRenderedPromise;}));});f1(Promise.all(g1));});});b1=i.then(Function.prototype);return b1;}var d1={init:E,createContent:G,exit:H,_getRouterClassName:a1,getConfig:Z,getInternalManifest:_,getTransactionController:function(){return u.getTransactionController();},getApplicationController:function(){return u;},getNavigationController:function(){return w;}};var e1={retemplateActiveComponents:c1};if(sap.ui.getCore().getConfiguration().getDesignMode()){g(d1,e1);}var K=t.testable(K,"fnNormalizePagesMapToArray");Z=t.testable(Z,"getConfig");return d1;}return U.extend("sap.suite.ui.generic.template.lib.AppComponent",{metadata:{config:{title:"SAP UI Application Component",fullWidth:true},properties:{forceGlobalRefresh:{type:"boolean",defaultValue:true},considerAnalyticalParameters:{type:"boolean",defaultValue:false},showDraftToggle:{type:"boolean",defaultValue:false},objectPageHeaderType:{type:"string",defaultValue:"Static"},objectPageVariantManagement:{type:"string",defaultValue:"None"},flexibleColumnLayout:{type:"object",defaultValue:null},inboundParameters:{type:"object",defaultValue:null},tableColumnVerticalAlignment:{type:"string",defaultValue:"Middle"}},events:{pageDataLoaded:{}},routing:{config:{async:true,viewType:"XML",viewPath:"",clearTarget:false},routes:[],targets:[]},library:"sap.suite.ui.generic.template"},suppressDataLossPopup:function(){return false;},constructor:function(){var i=t.startApp();g(this,n(this,i));(U.prototype.constructor||Function.prototype).apply(this,arguments);}});});
