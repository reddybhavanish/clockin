sap.ui.define(["sap/ui/base/Object","sap/m/MessageToast","sap/ui/generic/app/util/ModelUtil","sap/ui/generic/app/util/ActionUtil","sap/suite/ui/generic/template/lib/MessageUtils","sap/m/MessageBox","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/base/util/extend"],function(B,M,a,A,b,c,C,t,e){"use strict";var r=Promise.reject();r.catch(Function.prototype);function g(o,d,s,f,h){function l(O,i,j,P){b.handleError(O,o,s,j,P);return(i||Function.prototype)(j);}var E;function m(i){return new Promise(function(j,k){var H=o.getOwnerComponent();var I=H.getBindingContext();var J=H.getModel();J.read(I.getPath(),{urlParameters:{"$expand":"DraftAdministrativeData"},success:function(R){if(!R.DraftAdministrativeData){if(i){return l(b.operations.editEntity,k,i);}return j({});}if(R.DraftAdministrativeData.InProcessByUser){var U=R.DraftAdministrativeData.InProcessByUserDescription||R.DraftAdministrativeData.InProcessByUser;i=i||new Error(f.getText("ST_GENERIC_DRAFT_LOCKED_BY_USER",[" ",U]));return l(b.operations.editEntity,k,i,i);}return j({draftAdministrativeData:R.DraftAdministrativeData});},error:l.bind(null,b.operations.editEntity,k)});});}function n(i,U,P){if(P.draftAdministrativeData){return Promise.resolve(P);}return new Promise(function(j,k){s.oTransactionController.editEntity(o.getView().getBindingContext(),!U).then(function(R){if(i){var V=o.getView();var H=V.getBindingContext();var I=function(){H.getModel().invalidateEntry(H);V.detachEvent("modelContextChange",I);};V.attachEvent("modelContextChange",I);}return j({context:R.context});},function(R){if(R&&R.response&&R.response.statusCode==="409"&&i&&!U){b.removeTransientMessages();return m(R).then(j,k);}else{l(b.operations.editEntity,k,R,R);}});});}E=function(U){var i=d.isDraftEnabled();var R;var j=o.getOwnerComponent();var k=j.getBindingContext();if(i&&!U){var H=s.oDraftController.getDraftContext();var P=H.hasPreserveChanges(k);if(!P){R=m().then(n.bind(null,true,true));}}R=R||n(i,U,{});if(i){s.oApplication.editingStarted(k,R);}return R;};function p(U){if(h.isBusy()){return r;}var R=E(U);h.setBusy(R);return R;}function q(i,H,j,k,S,I){var R=new Promise(function(J,K){var W=false;var L=function(){var P=a.getEntitySetFromContext(j);var Q=s.oDraftController.getDraftContext();var T=Q.isDraftRoot(P);var U=f.getText("ST_GENERIC_OBJECT_DELETED");if(!i&&T){U=f.getText(H?"ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED":"ST_GENERIC_DRAFT_WITHOUT_ACTIVE_DOCUMENT_DELETED");}if(!S){b.showSuccessMessageIfRequired(U,s);}};if(I){var N=function(P){W=true;h.getUnbusy().then(function(){var Q=function(){var O=s.oTransactionController.deleteEntity(j,null,true);O.then(function(T){L();J(T);},function(T){b.handleError(b.operations.deleteEntity,o,s,T,null);K();});h.setBusy(O);};I.handleCRUDScenario(4,Q,K,"Delete");});};}if(i&&k){s.oDraftController.getDraftForActiveEntity(j).then(function(P){s.oTransactionController.deleteEntity(P.context).then(function(){if(!S){b.showSuccessMessageIfRequired(f.getText("ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED"),s);}return J();});},function(P){b.handleError(b.operations.deleteEntity,o,s,P,null);K();});}else{var O=s.oTransactionController.deleteEntity(j,null,!I);h.setBusy(O);O.then(function(P){L();J(P);},function(P){b.handleError(b.operations.deleteEntity,o,s,P,null,{"412":N});if(!W){K();}});}});return R;}function u(i,S,j){var R=new Promise(function(k,H){var I=o.getView().getBindingContext();var J=s.oDraftController.isActiveEntity(I);var K=s.oDraftController.hasActiveEntity(I);var L;if(i){L=Promise.resolve(I);}else if(K&&!J){L=s.oApplication.getDraftSiblingPromise(I);}else{L=Promise.resolve();}L.then(function(N){var O=q(J,K,I,i,S,j);O.then(k,H);if(!J){var T=function(){return{context:N};};var P=O.then(T);s.oApplication.cancellationStarted(I,P);}},H);});return R;}function v(P,S){var R=Object.create(null);var H=new Promise(function(I,J){var O=Object.create(null);var K=function(L,i,j){R[L]={resolve:i,reject:j};};for(var k=0;k<P.length;k++){var L=P[k];O[L]=new Promise(K.bind(null,L));}s.oApplication.prepareDeletion(O,S);s.oTransactionController.deleteEntities(P).then(function(N){var Q=[];var T=sap.ui.getCore().getMessageManager().getMessageModel().getData();for(var i=0;i<T.length;i++){var U=T[i].getTarget();for(var j=0;j<P.length;j++){var V=T[i].getType()||"";if(U.indexOf(P[j])>-1&&(V!=="Information"&&V!=="Success")){Q.push(U);break;}}}return I(Q);},function(i){return J(i);});});H.then(function(j){var k=[];for(var i=0;i<P.length;i++){var I=R[P[i]];if(j.indexOf(P[i])===-1){k.push(P[i]);I.resolve();s.oApplication.markCurrentDraftAsModified();}else{I.reject();}}},Function.prototype);return H;}function w(i,j,k){if(h.isBusy()){j();return;}var H,I,J,K;var L=k?k:s.oTemplateCapabilities.oMessageButtonHelper&&s.oTemplateCapabilities.oMessageButtonHelper.getContextFilter();if(L){H=sap.ui.getCore().getMessageManager();I=function(P){var N=H.getMessageModel();var O=N.bindList("/",null,null,[L]);var Q=O.getContexts();return Q.map(function(R){var S=R.getObject();P(S);return S;});};K=Object.create(null);J=I(function(N){K[N.getId()]=N;});}s.oTransactionController.triggerSubmitChanges().then(function(R){if(H){H.removeMessages(J);}i(R.context);},function(){if(H){var N=[];var O=I(function(P){if(!K[P.getId()]){P.persistent=false;P.technical=false;N.push(P);}});if(N.length){H.removeMessages(O);H.addMessages(N);if(!k){s.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover();}}}j();});}function x(i){var j=i;var R=new Promise(function(k,H){s.oApplication.performAfterSideEffectExecution(w.bind(null,k,H,j));});h.setBusy(R);return R;}function y(i,j){if(h.isBusy()){return r;}var R=new Promise(function(k,H){var I=j?j:o.getView().getBindingContext();var W=false;var J=function(){W=true;var K=function(){var L=s.oDraftController.activateDraftEntity(I,true);s.oApplication.activationStarted(I,L);L.then(function(N){k(N);},function(N){b.handleError(b.operations.activateDraftEntity,o,s,N,null);H();});h.setBusy(L);};i.handleCRUDScenario(4,K,H,"Activate");};s.oApplication.getDraftSiblingPromise(I).then(function(S){if(S){o.getOwnerComponent().getModel().invalidateEntry(S);}var K=s.oDraftController.activateDraftEntity(I,false);if(S){var L=d.getRootExpand();var P={};if(L&&L.length){P.urlParameters={"$expand":L};}s.oDraftController.fetchHeader(S,P);}h.setBusy(K);s.oApplication.activationStarted(I,K);K.then(function(N){k(N);},function(N){if(!j){b.handleError(b.operations.activateDraftEntity,o,s,N,null,{"412":J});if(!W){H();}}});});});return R;}function z(P){return new A(P);}function D(P,S,R,j){if(h.isBusy()){j();return;}var k=P.functionImportPath;var H=P.contexts;var I=P.sourceControl;var J=P.label;var O=P.operationGrouping;var K=z({controller:o,contexts:H,applicationController:s.oApplicationController,operationGrouping:O});var L=function(W,X){if(W.pages){for(var i in W.pages){var Y=W.pages[i];if(Y.component.list!=true&&Y.entitySet===X){return true;}else{var Z=L(Y,X);if(Z){return true;}}}}return false;};var N=function(i,W){var X=i.getAppComponent().getConfig();if(W&&W.sPath){var Y=W.sPath.split("(")[0].replace("/","");return L(X.pages[0],Y);}return false;};var Q=function(i){var W,X,Y,Z;if(Array.isArray(i)&&i.length===1){W=i[0];}else{W={response:{context:i.context}};}X=W.response&&W.response.context;var $;if(X&&X.getObject()){$=d.registerContext(X);}Y=o.getOwnerComponent();Z=N(Y,X);if(Z&&X&&X!==W.actionContext&&X.getPath()!=="/undefined"){if(I){f.navigateFromListItem(X,false);}else{s.oApplication.navigateToSubContext(X,false,$.bIsDraft?2*(1+$.bIsCreate):1,$);}}if(i.length>0){var _=f.getTableBindingInfo(I);var a1=_&&_.binding;if(a1&&a1.oEntityType){f.setEnabledToolbarButtons(I);if(d.isListReportTemplate()){f.setEnabledFooterButtons(I);}}}R(i);};var T=function(){if(H&&H[0]){var i=H[0].oModel;if(i&&i.hasPendingChanges()){i.resetChanges();}}};var U=function(i){T();j(i);};var V=function(i){if(Array.isArray(i)){if(i.length===1){i=i[0].error;}else{i=null;}}var W={context:H};T();l(b.operations.callAction,null,i,W);j(i);};K.call(k,J,d.isDraftEnabled()).then(function(i){var W={};W.actionLabel=J;h.setBusy(i.executionPromise,null,W);i.executionPromise.then(Q,V);},U);}function F(P,S){var R=new Promise(function(i,j){s.oApplication.performAfterSideEffectExecution(D.bind(null,P,S,i,j));});return R;}function G(T,P){if(!T){throw new Error("Unknown Table");}var i="";var j="";var k;var H=o.getOwnerComponent();if(H.getMetadata().getName()==="sap.suite.ui.generic.template.ListReport.Component"){k=(H.getCreationEntitySet&&H.getCreationEntitySet())||(T.getEntitySet&&T.getEntitySet());}else{k=(H.getCreationEntitySet&&H.getCreationEntitySet())||H.getEntitySet();}var I,J,N,K;var V=o.getView();var L=V.getModel();var O=V.getBindingContext();if(O){j=f.getTableBindingInfo(T).path;K=L.getMetaModel();J=K.getODataEntitySet(k);I=K.getODataEntityType(J.entityType);N=K.getODataAssociationSetEnd(I,j);if(N){k=N.entitySet;}j="/"+j;i=H.getComponentContainer().getElementBinding().getPath()+j;}else{i="/"+k;}var Q=C.create(s.oDraftController,k,i,L,s.oApplication,P);s.oApplication.getBusyHelper().setBusy(Q);Q.catch(l.bind(null,b.operations.addEntry,function(R){throw R;}));return Q.then(function(R){s.oApplication.markCurrentDraftAsModified();return R;});}var l=t.testable(l,"handleError");var z=t.testable(z,"getActionUtil");return{editEntity:p,deleteEntity:u,deleteEntities:v,saveEntity:x,activateDraftEntity:y,callAction:F,addEntry:G};}return B.extend("sap.suite.ui.generic.template.lib.CRUDManager",{constructor:function(o,d,s,f,h){e(this,g(o,d,s,f,h));}});});
