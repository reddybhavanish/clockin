/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/ComponentContainer","sap/ui/core/routing/HashChanger","sap/ui/core/routing/History","sap/ui/core/library","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/routingHelper","sap/suite/ui/generic/template/lib/TemplateComponent","sap/suite/ui/generic/template/lib/testableHelper","sap/ui/fl/ControlPersonalizationAPI","sap/base/Log","sap/base/util/merge","sap/base/util/extend","sap/base/util/isEmptyObject","sap/base/util/UriParameters"],function(B,C,H,a,c,b,P,r,T,t,d,L,m,f,g,U){"use strict";var h=c.routing.HistoryDirection;var o=a.getInstance();var k=r.getCrossAppNavService();var A="sap-iapp-state--create";function l(R){var e=R.substring(R.length-5,R.length);if(e==="query"){return R.substring(0,R.length-5);}return R;}function n(e){if(e.indexOf("/")===0){return e;}return"/"+e;}function p(e){var D="";var R="";var j=Object.keys(e).sort();j.forEach(function(x){var V=e[x];if(Array.isArray(V)){var y=V.sort();for(var i=0;i<y.length;i++){var z=y[i];R=R+D+x+"="+z;D="&";}}else{R=R+D+x+"="+V;D="&";}});return R;}function q(e,i){e=e||"";var D=(e.charAt(e.length-1)==="/")?"?":"/?";return e+(i?D+i:"");}function s(e,i){var j=p(i);return q(e,j);}function u(i,R,j){var x=i.mRoutingTree[R.name];var y=R.template;var E=R.entitySet;var V=x.level;var O=-1;if(i.oFlexibleColumnLayoutHandler){O=V<3?V:0;}var z=O<0?i.oNavigationObserver:i.aNavigationObservers[O];var D=new P();var F=O<0?i.oHeaderLoadingObserver:i.aHeaderLoadingObservers[O];F.addObserver(D);var G={};var S={appComponent:i.oAppComponent,isLeaf:!R.pages||!R.pages.length,entitySet:E,navigationProperty:R.navigationProperty,componentData:{registryEntry:{oAppComponent:i.oAppComponent,componentCreateResolve:j,route:R.name,routeConfig:R,viewLevel:x.level,routingSpec:R.routingSpec,oNavigationObserver:z,oHeaderLoadingObserver:D,preprocessorsData:G}}};if(R.component.settings){f(S,R.component.settings);}var I;i.oAppComponent.runAsOwner(function(){try{var J=sap.ui.core.Component.create({name:y,settings:S,handleValidation:true,manifest:true});var K;I=new C({propagateModel:true,width:"100%",height:"100%",settings:S});K=J.then(function(M){I.setComponent(M);var x=i.mRoutingTree[R.name];x.componentId=M.getId();return I;});I.loaded=function(){return K;};}catch(e){throw new Error("Component "+y+" could not be loaded");}});return I;}function v(e,x){t.testable(u,"fnCreateComponentInstance");var y=!k||k.isInitialNavigation();var M=(sap.ushell&&sap.ushell.Container)?sap.ushell.Container.getServiceAsync("AppLifeCycle").then(function(i){var j=i.getCurrentApplication().getIntent();return Promise.all([j,sap.ushell.Container.getServiceAsync("URLParsing")]).then(function(r2){var j=r2[0];var s2=r2[1];j.appSpecificRoute="&/";var t2=s2.constructShellHash(j);return"#"+t2;});}):Promise.resolve("");var z={};var D={iHashChangeCount:0,backTarget:0,componentsDisplayed:Object.create(null)};var E=[];var F=Promise.resolve();var R=new P();var G=0;function I(){var i=x.oRouter,j=i.getTargets()._mTargets,r2=[];Object.keys(j).forEach(function(s2){var t2=j[s2],u2=t2._oOptions,v2=i.getRoute(u2.viewName),w2=v2&&v2._oConfig;if(w2&&(!w2.navigation||!w2.navigation.display)){r2.push({oConfig:w2});}});return r2;}t.testable(I,"fnGetAllPages");function J(i){var j=i||I();if(!Array.isArray(j)){j=[j];}j.forEach(function(r2){r2.oComponentContainer=u(e,r2.oConfig,function(){});});return j;}t.testable(J,"fnCreatePages");function K(){var i=x.oRouter.getViews();i.getView({viewName:"root"});return e.mRouteToTemplateComponentPromise.root;}function O(){return x.oAppComponent.getManifestEntry("sap.app").title;}function Q(i,j,r2){var s2=i&&e.componentRegistry[i];var t2=s2&&s2.methods.getUrlParameterInfo;return t2?s2.viewRegistered.then(function(){var u2=j&&n(j);return t2(u2,D.componentsDisplayed[s2.route]===1).then(function(v2){f(r2,v2);});}):Promise.resolve();}function S(i){var j=i.treeNode.componentId;var r2=i.treeNode.getPath(2,i.keys);var s2=i.appStates;return Q(j,r2,s2);}function V(i,j,r2){var s2=e.mRoutingTree[i];return Q(s2.componentId,r2,j);}function W(i,j){var r2;if(!i&&j instanceof T){var s2=j&&e.componentRegistry[j.getId()];var t2=s2&&s2.methods.getTitle;r2=t2&&t2();}else if(!i&&j&&j.title){r2=j.title;}r2=r2||O();e.oShellServicePromise.then(function(u2){u2.setTitle(r2);}).catch(function(){L.warning("No ShellService available");});}function X(i){var j=[e.oPagesDataLoadedObserver.getProcessFinished(true)];var r2=null;var s2=D.iHashChangeCount;delete _.componentsDisplayed;var t2=-1;for(var u2 in e.componentRegistry){var v2=e.componentRegistry[u2];var w2=v2.oControllerUtils&&v2.oControllerUtils.oServices.oTemplateCapabilities.oMessageButtonHelper;var x2=D.componentsDisplayed[v2.route]===1;var y2=v2.utils.getTemplatePrivateModel();y2.setProperty("/generic/isActive",x2);if(x2){j.push(v2.oViewRenderedPromise);if(v2.viewLevel>t2){t2=v2.viewLevel;r2=v2.oComponent;}}else{v2.utils.suspendBinding();}if(w2){w2.setEnabled(x2);}}var z2=e.oFlexibleColumnLayoutHandler&&e.oFlexibleColumnLayoutHandler.isAppTitlePrefered();W(z2,i||r2);Promise.all(j).then(function(){if(s2===D.iHashChangeCount&&g(z)){e.oAppComponent.firePageDataLoaded();}});}var Y=X.bind(null,null);function Z(i,j){var r2=[];for(var s2=i;s2.level>=j;s2=e.mRoutingTree[s2.parentRoute]){r2.push(s2);}return r2.reverse();}var $;var _;var a1;t.testable(function(i){_=i;E.push(D);D={backTarget:0,componentsDisplayed:Object.create(null)};},"setCurrentIdentity");function b1(){return _;}function c1(j,r2){if(Array.isArray(j)&&j.length<2){j=j[0];}if(Array.isArray(r2)&&r2.length<2){r2=r2[0];}if(Array.isArray(j)){if(Array.isArray(r2)){if(j.length===r2.length){j=j.sort();r2=r2.sort();return j.every(function(s2,i){return s2===r2[i];});}return false;}return false;}return r2===j;}function d1(i){if(!_||_.treeNode!==i.treeNode){return false;}for(var j=i.treeNode;j.level>0;j=e.mRoutingTree[j.parentRoute]){if(!j.noKey&&i.keys[j.level]!==_.keys[j.level]){return false;}}if(g(i.appStates)!==g(_.appStates)){return false;}if(g(i.appStates)){return true;}var r2=f(Object.create(null),i.appStates,_.appStates);for(var s2 in r2){if(!c1(i.appStates[s2],_.appStates[s2])){return false;}}return true;}function e1(i,j,r2){var s2=Object.create(null);for(var t2=i;t2.level>0;t2=e.mRoutingTree[t2.parentRoute]){if(!t2.noKey){s2["keys"+t2.level]=j[t2.level];}}var u2=!g(r2);var v2=i.sRouteName+(u2?"query":"");if(u2){s2["query"]=r2;}return{route:v2,parameters:s2};}function f1(i){var j=e1($.identity.treeNode,$.identity.keys,$.identity.appStates);x.oRouter.navTo(j.route,j.parameters,i);}function g1(i){if(!i||!$.identity){return;}var j=function(s2,t2,u2){u2=t2?t2.getId():u2;var v2=e.componentRegistry[u2];(v2.methods.presetDisplayMode||Function.prototype)(i,s2);};for(var r2=$.identity.treeNode;r2;r2=r2.parentRoute&&e.mRoutingTree[r2.parentRoute]){if(r2.componentId){j(D.componentsDisplayed[r2.sRouteName]===1,null,r2.componentId);}else{e.mRouteToTemplateComponentPromise[r2.sRouteName].then(j.bind(null,false));}if(r2.fCLLevel===0||r2.fCLLevel===3){break;}}}function h1(i){var j;if(i){if($||(_&&_.preset)){$={identity:i.identity,followUpNeeded:true};g1(i.displayMode);return;}if(i.identity&&d1(i.identity)){return;}j=i.mode;$=i;g1(i.displayMode);delete $.displayMode;}else{j=1;}$.followUpNeeded=j<0;e.oBusyHelper.setBusyReason("HashChange",true);$.displayMode=0;if(j<0){window.history.go(j);}else{f1(j===1);}}function i1(i,j){i.text=((i.headerTitle!==j)&&j)||"";if(a1&&a1.linkInfos.length>i.level){a1.adjustNavigationHierarchy();}}function j1(i,j){var r2=Object.create(null);if(e.oFlexibleColumnLayoutHandler){e.oFlexibleColumnLayoutHandler.adaptBreadCrumbUrlParameters(r2,i);}var s2={treeNode:i};var t2={treeNode:i,keys:_.keys.slice(0,i.level+1),appStates:r2};var u2=S(t2).then(function(){var w2=e1(i,_.keys,r2);s2.fullLink=x.oRouter.getURL(w2.route,w2.parameters);});j.push(u2);s2.navigate=function(w2,x2){if(e.oFlexibleColumnLayoutHandler&&!x2){var y2;for(var z2=E[D.backTarget];z2.backTarget>0&&!y2;z2=E[z2.backTarget]){if(z2.identity.treeNode===i){y2=z2.identity;}}e.oFlexibleColumnLayoutHandler.adaptPreferredLayout(r2,i,y2);}e.oBusyHelper.setBusy(u2.then(function(){v1(t2,false,w2);}));};var v2=i.getPath(2,t2.keys);s2.adaptBreadCrumbLink=function(w2){u2.then(function(){var B2=H.getInstance();var C2=B2.hrefForAppSpecificHash?B2.hrefForAppSpecificHash(s2.fullLink):"#/"+s2.fullLink;w2.setHref(C2);});var x2=function(){i1(i,w2.getText());};if(!s2.bLinkAttached){s2.bLinkAttached=true;var y2=w2.getBindingInfo("text")||{};y2.events={change:x2};}var z2=w2.getElementBinding();var A2=z2&&z2.getPath();if(A2===v2){x2();}else{w2.bindElement({path:v2,canonicalRequest:!e.bCreateRequestsCanonical});}};return s2;}function k1(i,j){var r2={title:j.treeNode.headerTitle||"",icon:j.treeNode.titleIconUrl||"",subtitle:j.treeNode.text,intent:i+j.fullLink};return r2;}function l1(){var j=[];var r2=[M];var s2=e.oFlexibleColumnLayoutHandler&&e.oFlexibleColumnLayoutHandler.hasNavigationMenuSelfLink(_);for(var t2=s2?_.treeNode:e.mRoutingTree[_.treeNode.parentRoute];t2;t2=e.mRoutingTree[t2.parentRoute]){var u2=j1(t2,r2);j[t2.level]=u2;}var v2=Promise.all(r2);var w2=function(){e.oShellServicePromise.then(function(x2){x2.setHierarchy([]);v2.then(function(y2){var z2=y2[0];var A2=[];for(var i=j.length-1;i>=0;i--){A2.push(k1(z2,j[i]));}x2.setHierarchy(A2);});}).catch(function(){L.warning("No ShellService available");});};a1={linkInfos:j,adjustNavigationHierarchy:w2};w2();}function m1(){return a1.linkInfos;}function n1(i){var j=_;if($&&$.identity&&!$.followUpNeeded){_=$.identity;}else{_=Object.create(null);var r2=i.getParameter("config");var s2=l(r2.name);_.treeNode=e.mRoutingTree[s2];var t2=i.getParameter("arguments");_.appStates=t2["?query"]||Object.create(null);_.keys=[""];for(var u2=_.treeNode;u2.level>0;u2=e.mRoutingTree[u2.parentRoute]){_.keys[u2.level]=u2.noKey?"":t2["keys"+u2.level];}}_.previousIdentity=j;_.componentsDisplayed=Object.create(null);_.componentsDisplayed[_.treeNode.sRouteName]=1;l1();}function o1(i,j){var r2=R.getProcessFinished(true).then(function(){var s2={identity:{treeNode:_.treeNode,keys:_.keys,appStates:f(Object.create(null),_.appStates)},mode:1};if(Array.isArray(j)&&j.length<2){j=j[0];}if(j){s2.identity.appStates[i]=j;}else{delete s2.identity.appStates[i];}h1(s2);});e.oBusyHelper.setBusy(r2);}var p1;function q1(i,j,r2,s2){if(!i||(Array.isArray(i)&&i.length===0)){R1(j);return;}var t2=Array.isArray(i)?i:[i];var u2=0,v2;var w2=new Promise(function(x2,y2){var z2=function(){if(u2==t2.length){x2(v2);}else{var A2=t2[u2];var B2=A1(v2,A2,true,true);B2.then(function(C2){u2++;v2=C2;z2();});}};z2();});e.oBusyHelper.setBusy(w2.then(function(x2){x2.appStates=Object.create(null);var y2;if(x2.treeNode.fCLLevel===0||x2.treeNode.fCLLevel===3){y2=S(x2);}else{y2=e.oFlexibleColumnLayoutHandler.getAppStatesPromiseForNavigation(_,x2);}if(!j&&s2&&s2.bIsCreate&&s2.bIsDraft&&!s2.bIsDraftModified){p1={index:E.length,path:i.getPath(),identity:x2,displayMode:H1()};}return y2.then(function(){v1(x2,j,r2);});}));}function r1(j){if(!p1||p1.path!==j.getPath()){return null;}var r2;var s2=function(y2,i){return y2!==r2.identity.keys[i];};for(var i=p1.index+1;i<E.length;i++){r2=E[i];if(r2.identity.treeNode.level<p1.identity.treeNode.level||p1.identity.keys.some(s2)){return null;}}var t2=0;for(var u2=D;u2.iHashChangeCount!==p1.index;u2=E[u2.backTarget]){if(u2.iHashChangeCount<p1.index){return null;}t2--;}var v2=E[p1.index].identity;var w2={treeNode:v2.treeNode,keys:v2.keys,appStates:Object.create(null)};var x2=h1.bind(null,{identity:w2,mode:t2,displayMode:p1.displayMode});if(v2.treeNode.fCLLevel===0||v2.treeNode.fCLLevel===3){f(w2.appStates,v2.appStates);return Promise.resolve(x2);}return e.oFlexibleColumnLayoutHandler.getSpecialDraftCancelPromise(_,v2,w2.appStates).then(function(){return x2;});}function s1(i,r2){var s2=r.determineNavigationPath(i);var t2={keys:["",s2.key],appStates:Object.create(null)};var u2=v1.bind(null,t2,true,r2);if(_.treeNode.level===1){t2.treeNode=_.treeNode;f(t2.appStates,_.appStates);return Promise.resolve(u2);}var v2=Z(_.treeNode,2);var w2=v2.map(function(j){if(j.noKey){return Promise.resolve(true);}if(!j.isDraft){return Promise.resolve(_.keys[j.level]);}var y2=j.getPath(2,_.keys);var z2=e.oApplicationProxy.getSiblingPromise(y2);return z2.then(function(i){s2=r.determineNavigationPath(i,j.navigationProperty);return s2.key;},Function.prototype);});var x2=Promise.all(w2);return x2.then(function(y2){var z2=e.mEntityTree[s2.entitySet];for(var j=0;y2[j];j++){z2=v2[j];t2.keys.push(z2.noKey?"":y2[j]);}t2.treeNode=z2;if(z2===_.treeNode){f(t2.appStates,_.appStates);return u2;}var A2=e.oFlexibleColumnLayoutHandler.getAppStatesPromiseForNavigation(_,t2);return A2.then(function(){return u2;});});}function t1(i,j){if((i&&i.treeNode)!==j.treeNode){return Promise.resolve(false);}if(e.oFlexibleColumnLayoutHandler&&!e.oFlexibleColumnLayoutHandler.areIdentitiesLayoutEquivalent(i,j)){return Promise.resolve(false);}var r2=true;var s2=i.treeNode.sRouteName;for(var t2=i.treeNode;t2.level>0;t2=e.mRoutingTree[t2.parentRoute]){var u2=t2.noKey||i.keys[t2.level]===j.keys[t2.level];if(!u2&&t2.noOData){return Promise.resolve(false);}r2=r2&&u2;if(t2.noOData){s2=t2.parentRoute;}}if(r2){return Promise.resolve(true);}var v2=e.mRoutingTree[s2];var w2=i.keys.slice(0,v2.level+1);var x2=j.keys.slice(0,v2.level+1);var y2=v2.getPath(2,w2);var z2=v2.getPath(2,x2);return e.oApplicationProxy.areTwoKnownPathesIdentical(y2,z2,v2.level===1);}function u1(i){var j=E[D.backTarget];var r2=-1;if(i.level===0||(e.oFlexibleColumnLayoutHandler&&i.fCLLevel===0)){for(;j.backTarget>0&&j.identity.treeNode.level>i.level;r2--){j=E[j.backTarget];}}return j&&{candidateHash:j,candidateCount:r2};}function v1(i,j,r2){var s2=u1(i.treeNode);var t2=t1(s2&&s2.candidateHash.identity,i);var u2=t2.then(function(v2){var w2=v2?s2.candidateCount:(0+!!j);var x2={identity:i,mode:w2,displayMode:r2};h1(x2);});e.oBusyHelper.setBusy(u2);return u2;}function w1(){if(G<2){R1();}else{var i=e.componentRegistry[_.treeNode.componentId];var j=i.utils.getTemplatePrivateModel();var r2=x1();a2({title:r2.dataLoadFailedTitle,text:r2.dataLoadFailedText,description:"",viewLevel:j.getProperty("/generic/viewLevel")});}}function x1(){return{dataLoadFailedTitle:e.getText("ST_ERROR"),dataLoadFailedText:e.getText("ST_GENERIC_ERROR_LOAD_DATA_TEXT")};}function y1(i,j,r2,s2){if(!j){return{treeNode:e.mRoutingTree.root,key:""};}var t2=r.determineNavigationPath(j);var u2=(i.level&&i.entitySet===t2.entitySet)?i:i.children.indexOf(t2.entitySet)>=0&&e.mEntityTree[t2.entitySet];if(u2){return{treeNode:u2,key:t2.key};}if(r2){var v2=e.oAppComponent.getModel();var w2=v2.getMetaModel();var x2=w2.getODataEntitySet(t2.entitySet);var y2=w2.getODataEntityType(x2.entityType);var z2;var A2=i.children.some(function(C2){u2=e.mEntityTree[C2];z2=u2.navigationProperty;if(!z2){return false;}var D2=w2.getODataAssociationEnd(y2,z2);return!!D2&&D2.multiplicity.endsWith("1");});if(A2){return{treeNode:u2,navigationProperty:z2};}}if(s2&&i.level>0){var B2=e.mRoutingTree[i.parentRoute];return y1(B2,j,r2,true);}}function z1(i,j,r2,s2){if(s2.navigationProperty){return new Promise(function(u2,v2){var w2=r2.getModel();w2.createBindingContext(s2.navigationProperty,r2,null,function(x2){var y2=x2&&z1(i,j,x2,{treeNode:s2.treeNode,key:r.determineNavigationPath(x2).key});if(y2){y2.then(u2,v2);}else{v2();}});});}var t2=j.slice(0,s2.treeNode.level);t2.push(s2.key);return Promise.resolve({treeNode:s2.treeNode,keys:t2});}function A1(i,j,r2,s2){var t2=(i&&i.treeNode)||_.treeNode;var u2=(i&&i.keys)||_.keys;var v2=y1(t2,j,r2,s2);return v2?z1(t2,u2,j,v2):Promise.reject();}function B1(i,j,r2){var s2={treeNode:i,keys:r2||_.keys.slice(0,i.level+1),appStates:j};if(i.fCLLevel===0||i.fCLLevel===3){return S(s2);}return e.oFlexibleColumnLayoutHandler.getAppStatesPromiseForNavigation(_,s2);}function C1(i){var j=A1({treeNode:e.mRoutingTree.root},i,false,true);var r2=j.then(function(s2){s2.appStates=Object.create(null);var t2;if(s2.treeNode===_.treeNode){Object.assign(s2.appStates,_.appStates);t2={identity:s2,mode:1,displayMode:1};h1(t2);return null;}var u2=B1(s2.treeNode,s2.appStates);return u2.then(v1.bind(null,s2,true,1));});e.oBusyHelper.setBusy(r2);return r2;}function D1(i){var j;var r2=0;for(j=D;j.backTarget>0&&(!j.identity||j.identity.treeNode.level>i);r2++){j=E[j.backTarget];}if(!y&&(r2===0||j.identity.treeNode.level>i)){window.history.go(-r2-1);return;}var s2=-r2||1;var t2=g2(i);var u2={treeNode:t2,keys:_.keys.slice(0,t2.level+1),appStates:Object.create(null)};var v2=B1(u2.treeNode,u2.appStates).then(function(){if(s2<0&&(u2.treeNode.fCLLevel===1||u2.treeNode.fCLLevel===2)&&j.identity.treeNode===u2.treeNode){for(;j.backTarget>0&&!e.oFlexibleColumnLayoutHandler.areIdentitiesLayoutEquivalent(j.identity,u2);s2--){j=E[j.backTarget];if(j.identity.treeNode!==u2.treeNode){break;}}}var w2={identity:u2,mode:s2,displayMode:u2.treeNode.isDraft?6:1};h1(w2);});e.oBusyHelper.setBusy(v2);}var E1;function F1(i,j,r2){var s2=e.mEntityTree[i];var t2;if(j){var u2=k.createEmptyAppState(e.oAppComponent);u2.setData(j);u2.save();t2=u2.getKey();}var v2=_?_.keys.slice(0,s2.level):[""];v2.push("-");var w2=Object.create(null);var x2=B1(s2,w2,v2);var y2=x2.then(function(){if(t2){w2[A]=t2;}var z2={treeNode:s2,keys:v2,appStates:w2};E1=r2;v1(z2,!_,4);});e.oBusyHelper.setBusy(y2);return y2;}function G1(i){var j=A1(null,i,false,false);e.oBusyHelper.setBusy(j.then(function(r2){r2.appStates=Object.create(null);f(r2.appStates,_.appStates);delete r2.appStates[A];var s2={identity:r2,mode:1};h1(s2);}));}function H1(){var i=e.componentRegistry[_.treeNode.componentId];var j=i.utils.getTemplatePrivateModel();var r2=j.getProperty("/objectPage/displayMode")||0;return r2;}function I1(i,j,r2,s2,t2){var u2=_.keys.slice(0,i.level);u2.push(j?r2:"");var v2=Object.create(null);var w2=B1(i,v2,u2);e.oBusyHelper.setBusy(w2.then(function(){var x2={treeNode:i,keys:u2,appStates:v2};v1(x2,s2,t2);}));}function J1(r2,s2,t2,u2,v2){var w2;var x2=true;for(var i=0;i<r2.children.length&&!w2;i++){var y2=r2.children[i];var z2=e.mEntityTree[y2];if(z2[r2.level?"navigationProperty":"sRouteName"]===s2){w2=z2.sRouteName;x2=!z2.noKey;}}var A2=!w2&&t2&&r2.embeddedComponents[t2];if(A2){for(var j=0;j<A2.pages.length&&!w2;j++){var B2=A2.pages[j];if(B2.navigationProperty===s2){w2=r2.sRouteName+"/"+t2+"/"+s2;x2=!(B2.routingSpec&&B2.routingSpec.noKey);}}}if(w2){var C2=e.mRoutingTree[w2];I1(C2,x2,u2,v2,H1());}}function K1(i,j,r2,s2){var t2=A1({treeNode:i},j,true,false);e.oBusyHelper.setBusy(t2.then(function(u2){u2.appStates=Object.create(null);var v2=B1(u2.treeNode,u2.appStates,u2.keys);return v2.then(v1.bind(null,u2,s2,r2));}));}function L1(){return!!$;}function M1(i){L.info("Navigate back");if(D.backTarget&&n(o.getPreviousHash()||"")!==n(D.hash)){e.oBusyHelper.setBusyReason("HashChange",true);}D.LeaveByBack=!D.forwardingInfo;if(D.LeaveByBack){D.backSteps=i;}window.history.go(-i);}function N1(j,r2,s2,t2){var u2=e.oAppComponent.getObjectPageHeaderType()==="Dynamic"&&e.oAppComponent.getObjectPageVariantManagement()==="VendorLayer";var v2;var w2=new U(window.location.href);if(w2.mParams["sap-ui-layer"]){var x2=w2.mParams["sap-ui-layer"];for(var i=0;i<x2.length;i++){if(x2[i].toUpperCase()==="VENDOR"){v2=true;break;}}}j=n(j||"");L.info("Navigate to hash: "+j);if(j===D.hash){L.info("Navigation suppressed since hash is the current hash");return;}D.targetHash=j;if(D.backTarget&&n(o.getPreviousHash()||"")===j){M1(1);return;}var y2=_?_.treeNode.level:0;if(u2&&v2){if(!t2){if(!e.oFlexibleColumnLayoutHandler){d.clearVariantParameterInURL();}else{if(y2>=s2){if(s2===1){d.clearVariantParameterInURL();}else if(s2===2){var z2;for(var A2 in e.componentRegistry){if(e.componentRegistry[A2].viewLevel===2){z2=e.componentRegistry[A2];break;}}var B2=z2.oController.byId("template::ObjectPage::ObjectPageVariant");d.clearVariantParameterInURL(B2);}}}}}e.oBusyHelper.setBusyReason("HashChange",true);D.LeaveByReplace=r2;if(r2){x.oHashChanger.replaceHash(j);}else{x.oHashChanger.setHash(j);}}function O1(i,j,r2,s2,t2,u2){var v2=j.then(function(w2){i=q(i,w2);if(t2){D.backwardingInfo={count:t2.count,index:t2.index,targetHash:n(i)};M1(t2.count);}else{N1(i,s2,r2,u2);}return i;});e.oBusyHelper.setBusy(v2);return v2;}function P1(){var i=u1(e.mRoutingTree.root);return i&&{count:-i.candidateCount,index:i.candidateHash.iHashChangeCount,routeName:"root"};}function Q1(i,j,r2){if(r2===0){return P1();}var s2=E[D.backTarget];return s2&&s2.hash&&n(s2.hash.split("?")[0])===n(j)&&{count:1,index:D.backTarget};}function R1(i){if(_.treeNode.level===0){return;}var j={treeNode:e.mRoutingTree["root"],keys:[""],appStates:Object.create(null)};var r2=e.oFlexibleColumnLayoutHandler?e.oFlexibleColumnLayoutHandler.getAppStatesPromiseForNavigation(_,j):S(j);r2.then(v1.bind(null,j,i));e.oBusyHelper.setBusy(r2);}function S1(i){var j=e.mEntityTree[i.entitySet].sRouteName;var r2=e.mRouteToTemplateComponentPromise[j];return[r2];}function T1(j,r2){var s2=D.componentsDisplayed;var t2=function(v2){var w2=e.componentRegistry[v2.getId()];(w2.methods.presetDisplayMode||Function.prototype)(r2,s2[w2.route]===1);};for(var i=0;i<j.length;i++){var u2=j[i];u2.then(t2);}}function U1(i){var j=i&&e.mEntityTree[i.entitySet];var r2=j?j.level:1;return r2;}function V1(j,r2){var s2=e.oApplicationProxy.getHierarchySectionsFromCurrentHash();var t2=j;for(var i=r2-2;i>=0;i--){t2=s2[i]+"/"+t2;}return"/"+t2;}function W1(i,j,r2,s2,t2){var u2={};var v2=e.oFlexibleColumnLayoutHandler&&e.oFlexibleColumnLayoutHandler.getFCLAppStatesPromise(i,u2);var w2=V(i,u2,j);var x2=(v2?Promise.all([v2,w2]):w2).then(p.bind(null,u2));var y2=Q1(s2,j,r2);var z2=O1(j,x2,r2,s2,y2,t2);e.oBusyHelper.setBusy(z2);return z2;}function X1(j,r2,s2,t2,u2){var v2;var w2,x2,y2;var z2=[];if(typeof j==="string"){v2=j;var A2=n(v2);if(A2==="/"){w2=0;}else{y2=A2.split("/");w2=y2.length-1;}switch(w2){case 0:x2="root";break;case 1:x2=y2[1].split("(")[0];break;default:x2="";var B2="";for(var i=0;i<w2;i++){var C2=y2[i+1];var D2=C2.indexOf("(");if(D2>0){C2=C2.substring(0,D2);}x2=x2+B2+C2;B2="/";}x2=x2.replace("---","/");}}else{var E2=r.determineNavigationPath(j,r2);w2=U1(E2);v2=E2.path;z2=S1(E2);x2=e.mEntityTree[E2.entitySet].sRouteName;}if(r2){v2=V1(v2,w2);}T1(z2,t2||0);return W1(x2,v2,w2,s2,u2);}function Y1(i,j,r2,s2,t2){return X1(i,j,r2,s2,t2);}function Z1(i,j){D.componentsDisplayed[i]=j;var r2=e.mRoutingTree[i];var s2=r2.componentId;if(s2){var t2=e.componentRegistry[s2];var u2=t2.utils.getTemplatePrivateModel();u2.setProperty("/generic/isActive",j===1);}}function $1(i){var j,r2,s2,t2,u2,v2=null,w2,x2;if(i){j=i.entitySet;r2=i.text;v2=i.icon;x2=i.description;}if(j){w2=e.oAppComponent.getModel().getMetaModel();if(w2){s2=w2.getODataEntitySet(j);t2=w2.getODataEntityType(s2.entityType);u2=t2["com.sap.vocabularies.UI.v1.HeaderInfo"];}if(u2&&u2.TypeImageUrl&&u2.TypeImageUrl.String){v2=u2.TypeImageUrl.String;}}e.oTemplatePrivateGlobalModel.setProperty("/generic/messagePage",{text:r2,icon:v2,description:x2});if(e.oFlexibleColumnLayoutHandler){e.oFlexibleColumnLayoutHandler.displayMessagePage(i,D.componentsDisplayed);}else{var y2=x.oRouter.getTargets();y2.display("messagePage");for(var z2 in D.componentsDisplayed){Z1(z2,5);}}X(i);}function _1(){if(!g(z)){var j=null;for(var i=0;!j;i++){j=z[i];}z={};$1(j);}}function a2(i){if(x.oTemplateContract.oFlexibleColumnLayoutHandler){i.viewLevel=i.viewLevel||0;z[i.viewLevel]=i;var j=Promise.all([F,x.oTemplateContract.oPagesDataLoadedObserver.getProcessFinished(true)]);j.then(_1);j.then(e.oBusyHelper.setBusyReason.bind(null,"HashChange",false));return;}$1(i);e.oBusyHelper.setBusyReason("HashChange",false);}function b2(){var i=[];var j=_.componentsDisplayed||D.componentsDisplayed;for(var r2 in e.componentRegistry){var s2=e.componentRegistry[r2];if(j[s2.route]===1){i.push(r2);}}return i;}function c2(){var i=[];for(var j in e.componentRegistry){i.push(j);}return i;}function d2(i){return _.keys.slice(0,i+1);}function e2(j){var r2="";var s2=D.hash;var t2=s2.split("/");var u2="";for(var i=0;i<=j;i++){r2=r2+u2+t2[i];u2="/";}return r2;}function f2(){return D;}function g2(i){var j=_.treeNode;for(;j.level>i;){j=e.mRoutingTree[j.parentRoute];}return j;}function h2(i,j,r2){var s2=r2.getId();var t2=e.componentRegistry[s2];var u2=d2(t2.viewLevel);var v2=t2.route;var w2=j.componentsDisplayed[v2];var x2=w2===1;var y2=function(E2){var F2=r2.onActivate(E2,x2)||Promise.resolve();return Promise.all([F2,t2.viewRegistered]).then(function(){t2.aKeys=u2;});};D.componentsDisplayed[v2]=1;if(j.isNonDraftCreate&&i==="-"){var z2=e.mRoutingTree[v2];var A2=e.mRoutingTree[z2.parentRoute];var B2=A2.getPath(2,u2);var C2=e.oAppComponent.getModel();var D2=B2?new Promise(function(E2){var F2={canonicalRequest:!e.bCreateRequestsCanonical};C2.createBindingContext(B2,null,F2,E2);}):Promise.resolve();return D2.then(function(E2){var F2=E2?z2.navigationProperty:"/"+r2.getEntitySet();var G2=_.appStates[A];var H2=G2?new Promise(function(I2){var J2=k.getAppState(e.oAppComponent,G2);J2.done(I2);J2.fail(I2.bind(null,null));}):Promise.resolve();return H2.then(function(I2){t2.nonDraftCreateContext=E1||t2.nonDraftCreateContext||b.createNonDraft(E2,F2,C2,I2&&I2.getData(),e.oApplicationProxy.mustRequireRequestsCanonical());E1=null;return y2(t2.nonDraftCreateContext.getPath());});});}delete t2.nonDraftCreateContext;return y2(i);}function i2(i,j,r2){return h2(i,j,r2).then(Y);}function j2(i,j,r2){var s2={};if(j||r2){var t2=i.level;for(var u2=0;u2<t2;u2++){s2[u2]=e.oPaginatorInfo[u2];}}e.oPaginatorInfo=s2;}function k2(i){return e.oApplicationProxy.getAlternativeContextPromise(i);}function l2(i){R.startProcess();n1(i);_.preset=true;if(e.oFlexibleColumnLayoutHandler){e.oFlexibleColumnLayoutHandler.handleBeforeRouteMatched(_);}}function m2(){R.stopProcess();if($&&$.followUpNeeded&&$.identity&&!d1($.identity)){h1();return;}e.oBusyHelper.setBusyReason("HashChange",false);var r2=_.treeNode.level;var s2=n(x.oHashChanger.getHash()||"");L.info("Route matched with hash "+s2);var t2;if(D.backwardingInfo){t2=D;t2.identity=_.previousIdentity;delete _.previousIdentity;E.push(t2);var u2=t2.iHashChangeCount+1;D={iHashChangeCount:u2,forwardingInfo:{bIsProgrammatic:true,bIsBack:true,iHashChangeCount:u2,targetHash:t2.backwardingInfo.targetHash,componentsDisplayed:t2.componentsDisplayed},backTarget:E[t2.backwardingInfo.index].backTarget,componentsDisplayed:Object.create(null)};}if(D.forwardingInfo&&D.forwardingInfo.targetHash&&D.forwardingInfo.targetHash!==s2){D.hash=s2;var v2=D.forwardingInfo.targetHash;delete D.forwardingInfo.targetHash;N1(v2,true);return;}var w2=false;for(var i=0;i<e.aStateChangers.length;i++){var x2=e.aStateChangers[i];if(x2.isStateChange(_.appStates)){w2=true;}}if(w2){$=null;D.hash=s2;return;}G++;e.oTemplatePrivateGlobalModel.setProperty("/generic/routeLevel",r2);var y2=D.forwardingInfo;delete D.forwardingInfo;if(!y2){y2={componentsDisplayed:D.componentsDisplayed,isNonDraftCreate:!_.treeNode.isDraft&&_.keys[_.treeNode.level]==="-"};var z2=D.iHashChangeCount;y2.iHashChangeCount=z2+1;var A2=o.getDirection();if($){y2.bIsProgrammatic=!!$.identity;y2.bIsBack=$.mode<0;if(y2.bIsBack){D.backSteps=0-$.mode;}y2.bIsForward=!y2.bIsBack&&(A2===h.Forwards);D.LeaveByReplace=$.mode===1;}else{y2.bIsProgrammatic=(s2===D.targetHash);y2.bIsBack=!!(D.LeaveByBack||(!y2.bIsProgrammatic&&(A2===h.Backwards)));y2.bIsForward=!y2.bIsBack&&(A2===h.Forwards);D.LeaveByReplace=y2.bIsProgrammatic&&D.LeaveByReplace;if(!y2.bIsProgrammatic&&_.previousIdentity&&_.previousIdentity.treeNode.level>0&&!_.previousIdentity.treeNode.isDraft){var B2=y2.isNonDraftCreate||_.treeNode!==_.previousIdentity.treeNode;for(var j=1;!B2&&j<_.keys.length;j++){B2=_.keys[j]!==_.previousIdentity.keys[j];}if(B2){var C2=e.componentRegistry[_.previousIdentity.treeNode.componentId];var D2=C2.oComponent.getModel("ui");if(D2.getProperty("/editable")){C2.oControllerUtils.oCommonUtils.resetChangesAndFireCancelEvent();D2.setProperty("/editable",false);delete C2.nonDraftCreateContext;}}}}if(!y2.bIsBack){G=2;}D.LeaveByBack=y2.bIsBack;t2=D;t2.identity=_.previousIdentity;delete _.previousIdentity;E.push(t2);D={iHashChangeCount:y2.iHashChangeCount,componentsDisplayed:Object.create(null)};if(t2.LeaveByReplace){D.backTarget=t2.backTarget;}else if(y2.bIsBack){var E2=t2.backTarget;for(var F2=t2.backSteps||1;F2>0;F2--){E2=E[E2].backTarget;}D.backTarget=E2;}else{D.backTarget=z2;}}$=null;D.hash=s2;var G2=function(J2){if(J2){q1(J2.context,true,J2.iDisplayMode);return;}j2(_.treeNode,y2.bIsProgrammatic,y2.bIsBack);if(e.oFlexibleColumnLayoutHandler){F=e.oFlexibleColumnLayoutHandler.handleRouteMatched(y2);}else{var K2=e.mRouteToTemplateComponentPromise[_.treeNode.sRouteName];F=K2.then(function(L2){return i2(y2.isNonDraftCreate?"-":_.treeNode.getPath(2,_.keys),y2,L2);});}e.oBusyHelper.setBusy(F);};if(y2.bIsBack){var H2=g2(1);var I2=H2&&H2.getPath(2,_.keys);e.oBusyHelper.setBusy(k2(I2).then(G2));}else{G2();}}function n2(i){if(_&&_.preset){delete _.preset;}else{n1(i);}var j=e.oStatePreserversAvailablePromise.then(m2,e.oBusyHelper.setBusyReason.bind(null,"HashChange",false));e.oBusyHelper.setBusy(j);q2();}function o2(){_={appStates:Object.create(null),keys:[]};a2({title:e.getText("ST_ERROR"),text:e.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),description:""});}function p2(){return!y;}function q2(){var i;for(var j=_.treeNode;j;j=i){var r2=j.componentId&&e.componentRegistry[j.componentId];if(r2){var s2=r2.utils.getTemplatePrivateModel();s2.setProperty("/generic/currentActiveChildContext",j.selectedPath);}i=e.mRoutingTree[j.parentRoute];if(i){i.selectedPath=j.getPath(3,_.keys);}}}if(e.sRoutingType==="f"){x.oRouter.attachBeforeRouteMatched(l2);}x.oRouter.attachRouteMatched(n2);x.oRouter.attachBypassed(o2);x.concatPathAndAppStates=s;x.navigate=N1;x.navigateBack=M1.bind(null,1);x.activateOneComponent=h2;x.afterActivation=Y;x.addUrlParameterInfoForRoute=V;x.getApplicableStateForIdentityAddedPromise=S;x.setVisibilityOfRoute=Z1;x.getActiveComponents=b2;x.getAllComponents=c2;x.getRootComponentPromise=K;x.getActivationInfo=f2;x.getCurrentKeys=d2;x.getCurrentHash=e2;x.getAppTitle=O;x.navigateByExchangingQueryParam=o1;x.navigateToSubContext=q1;x.getSwitchToSiblingPromise=s1;x.getSpecialDraftCancelPromise=r1;x.getCurrentIdentity=b1;x.navigateToIdentity=v1;x.navigateAfterActivation=C1;x.navigateUpAfterDeletion=D1;x.navigateForNonDraftCreate=F1;x.adaptUrlAfterNonDraftCreateSaved=G1;x.navigateToChild=J1;x.navigateFromNodeAccordingToContext=K1;x.isNavigating=L1;x.getLinksToUpperLayers=m1;x.setTextForTreeNode=i1;x.navigationContextNotFound=w1;x.isExternalNav=p2;x.createComponentInstance=u;return{navigateToRoot:R1,navigateToContext:Y1,navigateToMessagePage:a2,navigateBack:M1.bind(null,1)};}function w(e,i){var j={oAppComponent:i.oAppComponent,oRouter:i.oAppComponent.getRouter(),oTemplateContract:i,mRouteToComponentResolve:{}};if(j.oRouter){j.oHashChanger=j.oRouter.getHashChanger();}else{j.oHashChanger=H.getInstance();}i.oNavigationControllerProxy=j;var F=new Promise(function(R){j.fnInitializationResolve=R;});i.oBusyHelper.setBusy(F);f(e,v(i,j));f(j,e);j.oRouter._oViews._getViewWithGlobalId=function(V){V.viewName=V.name||V.viewName;for(var x in i.componentRegistry){if(i.componentRegistry[x].route===V.viewName){return i.componentRegistry[x].oComponent.getComponentContainer();}}var R=j.oRouter.getRoute(V.viewName);var y;if(R&&R._oConfig){y=u(i,R._oConfig,j.mRouteToComponentResolve[V.viewName]);}else{y=sap.ui.view({viewName:V.viewName,type:V.type,height:"100%"});}return y.loaded();};r.startupRouter(j);}var N=B.extend("sap.suite.ui.generic.template.lib.NavigationController",{metadata:{library:"sap.suite.ui.generic.template"},constructor:function(e){B.apply(this,arguments);t.testableStatic(w,"NavigationController")(this,e);}});N._sChanges="Changes";return N;});
