sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/lib/routingHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/base/Log","sap/base/util/extend","sap/base/util/deepExtend","sap/base/util/isEmptyObject"],function(B,r,t,L,e,d,a){"use strict";var c=r.getCrossAppNavService();t.testableStatic(function setCrossAppNavService(s){c=s;},"StatePreserver_setCrossAppNavService");function g(T,s){var R="";var A=Promise.resolve();var n=null;var b=false;var S=null;var f=null;var l,h;var C=Object.create(null);var o={};var j={};function I(){C.permanentEntries=Object.create(null);C.sessionEntries=Object.create(null);C.pageEntries=Object.create(null);C.allEntries=Object.create(null);}I();function k(i){I();for(var O in i){var P=d({},i[O]);C.allEntries[O]=P;var Q=P.lifecycle||Object.create(null);if(Q.permanent){C.permanentEntries[O]=P;}else if(Q.session){C.sessionEntries[O]=P;}if(Q.page||Q.pagination){C.pageEntries[O]=P;}}return C;}function m(i,P){if(P===i){return;}var O=P.next.next;P.next.next=i.next;i.next=P.next;P.next=O;}function p(i,O,P){if(a(O)){return{appStateKey:""};}var Q=JSON.stringify(O);var U=0;var V;for(V=i;V.next&&U<10;U++){if(V.next.serialize===Q){m(i,V);return{appStateKey:i.next.appStateKey};}V=V.next;}V.next=null;var W=c.createEmptyAppState(s.oComponent.getAppComponent(),!P);var X={next:i.next,serialize:Q,appStateKey:W.getKey()};W.setData(O);W.save();i.next=X;return{appStateKey:X.appStateKey};}function q(){var i=p(j,C.sessionEntries,false);var O=Object.create(null);if(i.appStateKey){O.sessionAppStateKey=i.appStateKey;}if(!a(C.permanentEntries)){O.permanentEntries=C.permanentEntries;}S=p(o,O,true);b=false;if(f===S.appStateKey){S=null;}else{T.oNavigationControllerProxy.navigateByExchangingQueryParam(s.appStateName,S.appStateKey);}}function u(){if(!b||R!==f){return;}var i=s.getCurrentState()||Object.create(null);k(i);q();}function v(){var O=T.componentRegistry[s.oComponent.getId()];var P=O.aKeys;var Q="";var U=O.route;for(var i=P.length-1;i>0;i--){var V=T.mRoutingTree[U];var W=i===1?V.entitySet:V.navigationProperty;Q="/"+W+(P[i]?"("+P[i]+")":"")+Q;U=V.parentRoute;}return Q;}function w(P,i){return A.then(function(){var O=Object.create(null);var Q=(!P||v()===P)&&l;if(Q){O[s.appStateName]=Q;}return O;});}function x(){if(!b){b=true;setTimeout(u,0);}}function y(){R=f;S=null;l=f;}function z(i,O,U){if(!O){return;}for(var P in O){var Q=O[P];if(U||Q.lifecycle.page){i[P]=Q;}}}function D(i,O){k(O);var P=Object.create(null);for(var Q in O){P[Q]=O[Q].data;}s.applyState(P,i);if(n){n();n=null;}y();q();u();}function E(i,O,P){for(var Q=i;Q.next;Q=Q.next){if(Q.next.appStateKey===P){m(i,Q);return;}}var U={next:i.next,serialize:JSON.stringify(O),appStateKey:P};i.next=U;}function F(i,O,P,Q,U,V,W,X){if(f===null){f=P;}else if(P!==f){O();return;}if(X){var Y=X.getData();E(j,Y,W);z(U,Y,true);}z(U,V,true);D(Q,U);i();}function G(i,O,P,Q,U,V){var W=V&&V.getData()||Object.create(null);E(o,W,P);if(W.sessionAppStateKey){var X=c.getAppState(s.oComponent.getAppComponent(),W.sessionAppStateKey);X.done(F.bind(null,i,O,P,Q,U,W.permanentEntries,W.sessionAppStateKey));X.fail(F.bind(null,O,O,P,Q,U,W.permanentEntries,"",null));}else{F(i,O,P,Q,U,W.permanentEntries,"",null);}}function H(i){var O=T.componentRegistry[s.oComponent.getId()];var P=O.utils.getHeaderDataAvailablePromise()||Promise.resolve();return P.then(function(){return T.oApplicationProxy.areTwoKnownPathesIdentical(h,i,O.viewLevel===1);});}function J(i,O){if(i===h){O(true);return;}if(!i||!h){O(false);return;}H(i).then(O);}function K(i,O){var P=new Promise(function(Q,U){J(i,function(V){h=i;var W=Object.create(null);z(W,C[V?"allEntries":"pageEntries"],V||O);if(f===R||!f){if(f||V){z(W,C.sessionEntries,true);z(W,C.permanentEntries,true);}D(V,W);Q();return;}if(!n){A=new Promise(function(Y){n=Y;});}var X=c.getAppState(s.oComponent.getAppComponent(),f);X.done(G.bind(null,Q,U,f,V,W));X.fail(G.bind(null,U,U,f,V,W,null));},U);});return P;}function M(i){f=i[s.appStateName]||"";if(Array.isArray(f)){f=f.sort()[0]||"";}if(S){if(S.appStateKey!==f){L.error("StatePreserver: Got AppstateKey "+f+" expected "+S.appStateKey);return false;}y();return true;}return false;}function N(){return{isStateChange:M};}return{getUrlParameterInfo:w,stateChanged:x,applyAppState:K,getAsStateChanger:N};}return B.extend("sap.suite.ui.generic.template.lib.StatePreserver",{constructor:function(T,s){e(this,g(T,s));}});});
