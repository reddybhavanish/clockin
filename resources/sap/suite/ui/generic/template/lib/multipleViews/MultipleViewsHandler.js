sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/multipleViews/MultipleTablesModeHelper","sap/suite/ui/generic/template/lib/multipleViews/SingleTableModeHelper","sap/ui/generic/app/navigation/service/SelectionVariant","sap/suite/ui/generic/template/lib/MetadataAnalyser","sap/base/Log","sap/suite/ui/generic/template/lib/testableHelper","sap/base/util/extend","sap/base/security/encodeURL","sap/ui/comp/util/DateTimeUtil","sap/base/util/isEmptyObject"],function(B,F,M,S,a,b,L,t,e,c,D,d){"use strict";function g(C,T,o){var s=Object.create(null);var f=T.oComponentUtils.getTemplatePrivateModel();var p=o.pathInTemplatePrivateModel+"/items";var P=o.pathInTemplatePrivateModel+"/selectedKey";f.setProperty(o.pathInTemplatePrivateModel,Object.create(null));f.setProperty(p,Object.create(null));var I=new(o.smartControl?S:M)(C,T,o);f.setProperty(o.pathInTemplatePrivateModel+"/mode",I.getMode());var h=T.oServices.oApplication.getBusyHelper().getBusyDelay();var m=C.getOwnerComponent().getModel();var k;var l;var n;function u(){if(l){var i=o.getSearchValue&&o.getSearchValue();var j=i?{search:i}:{};for(var $ in s){var _=s[$];var a1=_.getPath();_.numberOfUpdates++;_.updateStartFunction(_.numberOfUpdates);m.read(a1+"/$count",{urlParameters:j,filters:_.getFiltersForCount(),groupId:"updateMultipleViewsItemsCounts",success:_.updateSuccessFunction.bind(null,_.numberOfUpdates),error:_.errorFunction.bind(null,_.numberOfUpdates)});}}}function r(i,j){var $="";var _=j["parameters"];if(!j||!j.entitySetName||!j.navPropertyName||_.length<1){$="/"+i.name;return $;}var a1=o.smartFilterBar&&o.smartFilterBar.getAnalyticalParameters();if(a1&&a1.length>0){var b1=o.smartFilterBar&&o.smartFilterBar.getUiState({allFilters:false});var c1=b1?JSON.stringify(b1.getSelectionVariant()):"{}";var d1=new a(c1);var e1=[];_.forEach(function(f1){a1.forEach(function(g1){if(g1&&(g1.name===f1)){var h1=g1.name;var i1=d1.getParameter(h1);if(g1.type==='Edm.DateTime'){i1=new Date(i1);i1=D.localToUtc(i1);i1=c(g1.control.getModel().formatValue(i1,g1.type));e1.push(h1+'='+i1);}else{e1.push(h1+'='+"'"+i1+"'");}}});});$='/'+j.entitySetName+'('+e1.join(',')+')/'+j.navPropertyName;}else{$="/"+i.name;L.error("SelectionParameters","There are no parameters to resolve");return $;}return $;}function G(i){var j;var $=i.getEntitySet();var _=C.getOwnerComponent();if(o.smartFilterBar&&o.smartFilterBar.getConsiderAnalyticalParameters&&o.smartFilterBar.getConsiderAnalyticalParameters()){var a1=m.getMetaModel();var b1=a1.getODataEntitySet($);var c1=_.getAppComponent();var d1=b.getParametersByEntitySet(c1.getModel(),$);j=r(b1,d1);return j;}var e1=i.getTableBindingPath?i.getTableBindingPath():i.getChartBindingPath();j=e1?e1:"/"+$;var f1=_.getComponentContainer();var g1=f1.getElementBinding();return g1?g1.getPath()+'/'+j:j;}function q($,_){var a1=m.getMetaModel();var b1=$.getEntitySet();var c1=a1.getODataEntitySet(b1);var d1=a1.getODataEntityType(c1.entityType);var e1=[],f1;var g1=_.variantAnnotationPath;if(g1){var h1=d1[g1];if(!h1){return[];}if(!h1.SelectOptions&&h1.SelectionVariant){h1=h1.SelectionVariant;if(h1.Path){g1=h1.Path.split("@")[1];h1=g1&&d1[g1];}}if(h1.AnnotationPath){f1=h1.AnnotationPath.split("@")[1];h1=d1[f1];}for(var i in h1.SelectOptions){if(h1.SelectOptions[i].PropertyName){var i1=h1.SelectOptions[i].PropertyName.PropertyPath;for(var j in h1.SelectOptions[i].Ranges){var j1=h1.SelectOptions[i].Ranges[j].Sign;var k1=h1.SelectOptions[i].Ranges[j].Option;if(j1){k1.EnumMember=v(j1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeSignType/",""),k1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/",""));}else{k1.EnumMember=k1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");}var l1=h1.SelectOptions[i].Ranges[j].Low;var m1=h1.SelectOptions[i].Ranges[j].High;var n1=Object.keys(l1)[0];if(m1){var o1=Object.keys(m1)[0];e1.push(new F(i1,k1.EnumMember,l1[n1],m1[o1]));}else{e1.push(new F(i1,k1.EnumMember,l1[n1]));}}}}}return e1;}function v(i,j){var $;var _=new Map([["EQ","NE"],["BT","NB"],["CP","NP"],["LE","GT"],["GE","LT"],["NE","EQ"],["NB","BT"],["NP","CP"],["GT","LE"],["LT","GE"]]);if(i==="I"){$=j;}else if(i==="E"){if(_.has(j)){$=_.get(j);}else{$=j;}}return $;}function H(i){for(var j in s){var $=s[j];if($.smartControl.getEntitySet()===i){return true;}}return false;}function O(i,j){var $=i.filters.slice(0);var _=x();i.filters=A(i.filters,_,j,false);if(l){for(var a1 in s){var b1=s[a1];w($,b1,j);}}}function w(i,j,$){j.getFiltersForCount=function(){return A(i,j,$,true);};}function A(i,j,$,_){if(I.getFiltersAdaptedFromItem){i=I.getFiltersAdaptedFromItem(i,j,$,_);}return i.concat(j.selectionVariantFilters);}function x(){return s[n];}function y(i,n){return I.formatMessageStrip(i,n);}function z(){return n;}function E(n){f.setProperty(P,n||k);}function J(){return I.getContentForIappState(n);}function K(i){var j;if(!i){return"";}if(i.state==="error"){return T.oCommonUtils.getText("SEG_BUTTON_ERROR",i.text);}if(i.state===""||i.state==="busy"){var $=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});j=$.format(i.count);}return T.oCommonUtils.getText("SEG_BUTTON_TEXT",[i.text,i.state==="busyLong"?"...":j]);}function R(i){n=I.getSelectedKeyAndRestoreFromIappState(i);if(s[n]){f.setProperty(P,n);}}function N(){return s[n].templateSortOrder;}function Q(i){var j=x();var $=T.oCommonUtils.isSmartTable(j.smartControl);if(i!==2){j.smartControl[$?"rebindTable":"rebindChart"]();}if(i>1){if($){if(o.refreshModelOnTableRefresh){T.oCommonUtils.refreshModel(j.smartControl);}T.oCommonUtils.refreshSmartTable(j.smartControl);}else{}}}function U(i,j,$){var _=Array.isArray(j);var a1=T.oComponentUtils.isComponentActive();if((_&&j.length===0)||($&&d($))){return;}I.refreshOperation(i,j,$,n,_,a1,Q);}function V(){var i=x();return I.setActiveButtonState(i);}function W(){var i=x();return I.restoreActiveButtonState&&I.restoreActiveButtonState(i);}function X(i,j,$){if(I.setControlVariant){I.setControlVariant(i,j,$);}}function Y(i,j,$,_){return T.oCommonUtils.getCustomDataText(i).then(function(a1){$.text=a1;_.text=a1;return{modelEntry:$,pathToTheItem:j};});}function Z(i){f.setProperty(i.pathToTheItem,i.modelEntry);}(function(){t.testable(function(){return I;},"getImplementingHelper");t.testable(function(){return l;},"getShowCounts");t.testable(function(){return s[n];},"getCurrentViewMeta");var j=function(b1,h1,i1,j1){if(b1.numberOfUpdates!==i1){return;}var e1=p+"/"+b1.switchingKey;var f1=e({},f.getProperty(e1));if(!f1.state&&h1=="busy"){setTimeout(function(){if(f.getProperty(e1).state==="busy"){f1=e({},f.getProperty(e1));f1.state="busyLong";f.setProperty(e1,f1);}},h);}f1.state=h1;if(!h1){f1.count=j1;}f.setProperty(e1,f1);};var $=o.switchingControl.getItems();for(var i=0;i<$.length;i++){var _=$[i];var a1=_.getKey();if(i===0){k=a1;}var b1={smartControl:o.smartControl||o.getSmartControl(a1),switchingKey:a1};var c1=I.getCustomDataHost(b1.smartControl,_);var d1=T.oCommonUtils.getElementCustomData(c1);var e1=p+"/"+b1.switchingKey;var f1=Object.create(null);f1.text=d1.text;f1.count=0;f1.state="";f1.facetId=o.sectionKey;Y(c1,e1,f1,b1).then(Z);b1.templateSortOrder=d1.TemplateSortOrder;b1.getPath=G.bind(null,b1.smartControl);b1.selectionVariantFilters=q(b1.smartControl,d1);b1.numberOfUpdates=0;b1.updateStartFunction=j.bind(null,b1,"busy");b1.updateSuccessFunction=j.bind(null,b1,"");b1.errorFunction=j.bind(null,b1,"error");s[a1]=b1;}if(I.init){I.init(s,U,x);}if(o.manifestSettings.showCounts===undefined){l=I.getDefaultShowCounts();}else{l=o.manifestSettings.showCounts;}E();n=f.getProperty(P);var g1=f.bindProperty(P);g1.attachChange(function(h1){var i1=h1.getSource().getValue();if(i1===n){return;}n=i1;if(I.onSelectedKeyChanged){I.onSelectedKeyChanged(i1);}var j1=o.isDataToBeShown();var k1=I.getRefreshMode(n);if(o.adaptRefreshRequestMode){k1=o.adaptRefreshRequestMode(k1);if(j1&&k1>0){Q(k1);}else{var l1=x().smartControl;T.oCommonUtils.setEnabledToolbarButtons(l1);}}o.appStateChange();});})();return{updateCounts:u,refreshOperation:U,onRebindContentControl:O,formatMessageStrip:y,getSelectedKey:z,setSelectedKey:E,getContentForIappState:J,restoreFromIappState:R,formatItemTextForMultipleView:K,determineSortOrder:N,setActiveButtonState:V,restoreActiveButtonState:W,setControlVariant:X,hasEntitySet:H};}return B.extend("sap.suite.ui.generic.template.lib.multipleViews.MultipleViewsHandler",{constructor:function(C,T,o){e(this,g(C,T,o));}});});
