/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/comp/library','sap/ui/comp/util/DateTimeUtil','sap/m/MultiComboBox','sap/m/MultiInput','sap/m/DatePicker','sap/m/DateRangeSelection',"sap/base/Log"],function(l,D,M,a,b,c,L){"use strict";var A=l.ANALYTICAL_PARAMETER_PREFIX;var V=l.valuehelpdialog.ValueHelpRangeOperation;var d=function(){};d.prototype.convert=function(s,f,S){var C=null,r=null,o;if(s){this._bStrictMode=S;o=JSON.parse(s);if(f&&f.getFilterBarViewMetadata&&o){this._sBasicSearchName=null;this._sBasicSearchValue=null;if(f.getBasicSearchName){this._sBasicSearchName=f.getBasicSearchName();}C={};if(o.Parameters){this._addParameters(o.Parameters,f,C);}if(o.SelectOptions){this._addSelectOptions(o.SelectOptions,f,C);}r={payload:null,variantId:null};r.payload=JSON.stringify(C);if(o.SelectionVariantID){r.variantId=o.SelectionVariantID;}if(this._sBasicSearchValue){r.basicSearch=this._sBasicSearchValue;}}}return r;};d.prototype.retrieveVariantId=function(s){var v=null;var S;if(s){S=JSON.parse(s);if(S&&S.SelectionVariantID){v=S.SelectionVariantID;}}return v;};d.prototype._getParameterMetaData=function(n,f,i){if(this._bStrictMode){return this._getParameterMetaDataStrictMode(n,f);}return this._getParameterMetaDataNonStrictMode(n,f,i);};d.prototype._getFilter=function(n,f){var i,j,g,F;F=f.getFilterBarViewMetadata();if(F){for(i=0;i<F.length;i++){g=F[i];for(j=0;j<g.fields.length;j++){if(n===g.fields[j].fieldName){return g.fields[j];}}}}return null;};d.prototype._getParameter=function(n,f){var j,e;if(f.getAnalyticalParameters){e=f.getAnalyticalParameters();if(e){for(j=0;j<e.length;j++){if(n===e[j].fieldName){return e[j];}}}}return null;};d.prototype._getParameterWithInnerPrefix=function(n,f){var p=n;if(n.indexOf(A)!==0){p=A+n;}return this._getParameter(p,f);};d.prototype._getParameterMetaDataStrictMode=function(n,f){var m=this._getExactFilterParameterMatch(n,f);if(m){return m;}return null;};d.prototype._getParameterMetaDataNonStrictMode=function(o,f,i){var m,n,N,t,s=o;if(o.indexOf(A)===0){s=o.substr(A.length);}if(s.indexOf("P_")===0){n=s;N=s.substr(2);}else{n="P_"+s;N=s;}if(s!==n){t=n;}else if(s!==N){t=N;}m=this._getExactParameterMatch(s,f);if(m){return m;}m=this._getExactParameterMatch(t,f);if(m){return m;}if(!i){m=this._getFilter(o,f);if(m){return m;}}return null;};d.prototype._getExactParameterMatch=function(n,f){var p;p=this._getParameterWithInnerPrefix(n,f);if(p){return p;}return null;};d.prototype._getExactFilterParameterMatch=function(n,f){var F,p;F=this._getFilter(n,f);if(F){return F;}p=this._getParameterWithInnerPrefix(n,f);if(p){return p;}return null;};d.prototype._addParameters=function(s,f,C){var i;var n,v;var F;for(i=0;i<s.length;i++){v=s[i].PropertyValue;n=s[i].PropertyName;if(this._sBasicSearchName&&(n===this._sBasicSearchName)){this._sBasicSearchValue=v;continue;}F=this._getParameterMetaData(n,f,true);if(F){f.determineControlByName(n);this._addAccordingMetaData(C,f,F,v);}else{L.error("neither metadata nor custom information for filter '"+n+"'");}}};d.prototype._addSelectOptions=function(s,f,C){var i;var n,r;var F,o;for(i=0;i<s.length;i++){n=s[i].PropertyName;r=s[i].Ranges;if(this._sBasicSearchName&&(n===this._sBasicSearchName)){if(r&&r.length>0){this._sBasicSearchValue=r[0].Low;}continue;}f.determineControlByName(n);F=this._getParameterMetaData(n,f,false);if(F){o=F.control;this._addRangesAccordingMetaData(C,f,F,r,o);}else{L.error("neither metadata nor custom information for filter '"+n+"'");}}};d.convertOption=function(s,v){var i;switch(s){case"CP":i=V.Contains;if(v){var n=v.indexOf('*');var e=v.lastIndexOf('*');if(n>-1){if((n===0)&&(e!==(v.length-1))){i=V.EndsWith;v=v.substring(1,v.length);}else if((n!==0)&&(e===(v.length-1))){i=V.StartsWith;v=v.substring(0,v.length-1);}else{v=v.substring(1,v.length-1);}}}break;case"EQ":case"BT":case"LE":case"GE":case"GT":case"LT":i=s;break;default:L.error("Suite Option is not supported '"+s+"'");i=undefined;v=undefined;}return{op:i,v:v};};d.prototype._addRangesAccordingMetaData=function(C,f,F,r,o,n){var i,O;var e=function(t){var u=new RegExp("[0-9]{8}");if(t[0].match(u)){var S=[];var y=t[0].substring(0,4);var v=t[0].substring(4,6);var w=t[0].substring(6,9);S[0]=y;S[1]=v;S[2]=w;return S;}else{return t;}};var g=function(t){if(t.indexOf(" ")!==-1){t=t.split(" ")[0];}else if(t.indexOf("-")!==-1){t=t.split("-")[0];}else if(t.indexOf('+')!==-1){t=t.split('+')[0];}return t;};var h=function(t){var u=t.split(".")[0];var v=t.split(".")[1];if(v){v=g(v);}var P=u.split("T");var w=P[0].split("-");if(w.length===1){w=e(w);}if(P.length<2){return v?new Date(w[0],w[1]-1,w[2],v):new Date(w[0],w[1]-1,w[2]);}else{var T=P[1].split(":");return v?new Date(w[0],w[1]-1,w[2],T[0],T[1],T[2],v):new Date(w[0],w[1]-1,w[2],T[0],T[1],T[2]);}};var j=function(F,f,v,t){if(f&&f.isInUTCMode){if(f.isInUTCMode()){v=v.split('T')[0]+"T00:00:00";}else if(!f.isInUTCMode()&&(v.split("T").length===1)){v+="T00:00:00";}}if(v.indexOf('Z')!==(v.length-1)){if(f&&f.isInUTCMode&&!f.isInUTCMode()){t=D.localToUtc(new h(v)).toJSON();}else{t=new h(v).toJSON();}}else{L.error("Property '"+F.fieldName+"' was added with zulu time zone information.");}return t;};var k=function(v){var t=v;if(v&&F){if(F.filterType==="numeric"){if((F.type==="Edm.Decimal")||(F.type==="Edm.Float")||(F.type==="Edm.Double")||(F.type==="Edm.Single")){t=parseFloat(v);}else{t=parseInt(v);}}else{switch(F.type){case"Edm.DateTime":case"Edm.Time":t=j(F,f,v,t);break;case"Edm.String":if(F.isCalendarDate){t=j(F,f,v,t);}break;case"Edm.DateTimeOffset":t=v;break;case"Edm.Date":var S=v.split('T'),T=S[1];if(T){T=g(T);}t=(T)?S[0]+"T"+T:v;break;default:t=v;break;}}}return t;};var m=function(t,r){var i,I,O;for(i=0;i<r.length;i++){O=d.convertOption(r[i].Option,r[i].Low);if(O&&O.op){I={"exclude":(r[i].Sign==="E"),"operation":O.op,"keyField":t,"value1":k(O.v),"value2":k(r[i].High)};if(!C[t]){C[t]={ranges:[],items:[],value:null};}C[t].ranges.push(I);}}};var p=function(r){for(var i=0;i<r.length;i++){if(r[i].Sign==="E"){return true;}}return false;};if(r&&r.length>0){if(F.isCustomFilterField){if(!C._CUSTOM){C._CUSTOM={};}if(Array.isArray(r)&&r.length>1){C._CUSTOM[F.fieldName]=r.map(function(R){return R.Low;});}else{C._CUSTOM[F.fieldName]=r[0].Low;}return;}if(F.conditionType){for(i=0;i<r.length;i++){if(!r[i].High){r[i].High=r[i].Low;}}m(F.fieldName,r);return;}if(F.filterRestriction===sap.ui.comp.smartfilterbar.FilterType.single){if(!r[0].Low&&o&&(o instanceof b)){C[F.fieldName]=null;}else{C[F.fieldName]=k(r[0].Low);}}else if(F.filterRestriction===sap.ui.comp.smartfilterbar.FilterType.interval){if(o&&(o instanceof c)){if(r[0].Low&&r[0].High){C[F.fieldName]={low:k(r[0].Low),high:k(r[0].High)};}else if(r[0].Low&&!r[0].High){C[F.fieldName]={low:k(r[0].Low),high:k(r[0].Low)};}else if(!r[0].Low&&r[0].High){C[F.fieldName]={low:k(r[0].High),high:k(r[0].High)};}else{C[F.fieldName]={low:null,high:null};}}else{if(F.type==="Edm.Time"){m(F.fieldName,r);}else{C[F.fieldName]={low:r[0].Low===undefined?null:k(r[0].Low),high:r[0].High===undefined?null:k(r[0].High)};}}}else if(F.filterRestriction===sap.ui.comp.smartfilterbar.FilterType.multiple){C[F.fieldName]={ranges:[],items:[],value:null};var s=(F.type==="Edm.DateTimeOffset")||F.isCalendarDate||(F.type==="Edm.DateTime")||(F.type==="Edm.Time");var q=(o instanceof a)&&p(r);if(o&&!s&&((o instanceof M)||(o instanceof a))&&!q){for(i=0;i<r.length;i++){O=d.convertOption(r[i].Option,k(r[i].Low));if(O.op===V.EQ){C[F.fieldName].items.push({key:k(O.v)});}}}else{m(F.fieldName,r);}}else{m(F.fieldName,r);}L.warning("potential reduced information for filter '"+F.fieldName+"'");}else{L.warning("no Ranges-section found for filter '"+F.fieldName+"'");}};d.prototype._addAccordingMetaData=function(C,f,F,v){var h=F.type==="Edm.DateTime"?"":v;var r=[{Sign:"I",Low:v,High:h,Option:"EQ"}];this._addRangesAccordingMetaData(C,f,F,r);};return d;},true);
