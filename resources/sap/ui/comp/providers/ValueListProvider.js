/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/library','sap/ui/comp/library','sap/m/library','sap/ui/comp/odata/MetadataAnalyser','sap/ui/core/SeparatorItem','sap/m/GroupHeaderListItem','sap/m/Column','sap/m/ColumnListItem','sap/m/Text','sap/m/Token','./BaseValueListProvider','sap/ui/core/ListItem','sap/ui/model/Filter','sap/ui/model/Sorter','sap/ui/model/json/JSONModel','sap/ui/model/FilterOperator','sap/ui/comp/util/FormatUtil','sap/ui/comp/smartfilterbar/FilterProvider','sap/ui/comp/historyvalues/HistoryValuesProvider','sap/ui/comp/historyvalues/HistoryOptOutProvider','sap/ui/comp/historyvalues/Constants','sap/m/ComboBox','sap/m/MultiComboBox','sap/base/util/deepEqual','sap/ui/Device','sap/base/Log','sap/base/util/values'],function(c,l,L,M,S,G,C,d,T,e,B,f,F,g,J,h,j,k,H,m,n,o,p,q,D,r,v){"use strict";var s=l.smartfilterbar.DisplayBehaviour;var P=L.PopinDisplay;var W=L.WrappingType;var V=c.ValueState;var t={Recommendations:10,RecentlyUsed:20,Others:30};var u="list";var w=B.extend("sap.ui.comp.providers.ValueListProvider",{constructor:function(a){if(!k){k=sap.ui.require("sap/ui/comp/smartfilterbar/FilterProvider");}if(a){this.sAggregationName=a.aggregation;this.bTypeAheadEnabled=!!a.typeAheadEnabled;this.bEnableShowTableSuggestionValueHelp=a.enableShowTableSuggestionValueHelp===undefined?true:a.enableShowTableSuggestionValueHelp;this.dropdownItemKeyType=a.dropdownItemKeyType;this.sDeferredGroupId=a.deferredGroupId;this.sContext=a.context;}this._aRecommendations=[];this._oRecommendationListPromise=Promise.resolve();this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");this._groupHeaderFactory=this._groupHeaderFactory.bind(this);B.apply(this,arguments);this._onInitialise();}});w.prototype._onInitialise=function(){if(!this.bTypeAheadEnabled){this.oAfterRenderingEventDelegate={onAfterRendering:this._onMetadataInitialised};this.oControl.addEventDelegate(this.oAfterRenderingEventDelegate,this);}else if(this.oControl.attachSuggest){this._fSuggest=function(E){this.oControl=E.getSource();if(!this.bInitialised){return;}if(!this._oTemplate||!this.oControl.data("_hassuggestionTemplate")){this._createSuggestionTemplate();}var i=E.getParameter("suggestValue");this._fetchData(i);}.bind(this);this.oControl.attachSuggest(this._fSuggest);if(!this.oFilterModel){var a=this;var b=this.oControl.setParent;this.oControl.setParent=function(N,A,i){var O=this.getParent();var R=b.apply(this,arguments);N=this.getParent();var x=!(N&&(O===null));if((N!==O)&&x){a.unbindAggregation();}return R;};}this._handleSelect();}this.oControl.setModel(new J(),u);this._setupHistoryValues();this._setupRecommendations();};w.prototype._onMetadataInitialised=function(){if(this.bInitialised){if(this.oAfterRenderingEventDelegate){this.oControl.removeEventDelegate(this.oAfterRenderingEventDelegate);}if(this.oPrimaryValueListAnnotation){if(this.sAggregationName&&this.sAggregationName=="suggestionRows"){this._createSuggestionTemplate();}else{this._createDropDownTemplate();}this._fetchData();if(this._isControlDropdown()){if(this.mOutParams&&Object.keys(this.mOutParams).length>1){this._handleOutParameters();}if(this.mInParams&&Object.keys(this.mInParams).length>1){this._handleInParameters();}}}else{r.error("ValueListProvider","Missing primary ValueListAnnotation for "+(this._sFullyQualifiedFieldName||this.sFieldName));}if(this.oAfterRenderingEventDelegate){delete this.oAfterRenderingEventDelegate;}}};w.prototype._onAnnotationLoad=function(a){B.prototype._onAnnotationLoad.call(this,a);if(this._shouldHaveRecommendations()||this._shouldHaveHistory()){this._bindInnerControlSuggestions();this._setupSuggestionInteractions();}};w.prototype._isSortable=function(N){if(this.oPrimaryValueListAnnotation){for(var i=0;i<this.oPrimaryValueListAnnotation.valueListFields.length;i++){if(this.oPrimaryValueListAnnotation.valueListFields[i].name===N){return this.oPrimaryValueListAnnotation.valueListFields[i].sortable!==false;}}return false;}return false;};w.prototype._createDropDownTemplate=function(){this._oTemplate=new f({key:{path:this._resolveSuggestionBindingPath(this.sKey),type:this.dropdownItemKeyType},text:{parts:[{path:this._resolveSuggestionBindingPath(this.sKey),type:this.dropdownItemKeyType},{path:this._resolveSuggestionBindingPath(this.sDescription)}],formatter:j.getFormatterFunctionFromDisplayBehaviour(this.sDDLBDisplayBehaviour)}});if(this._oRecommendationListAnnotation){this._oTemplate.bindProperty("additionalText",{path:this._resolveSuggestionBindingPath(this._oRecommendationListAnnotation.rankProperty)});}this._oSorter=null;if(this.sDDLBDisplayBehaviour===s.idOnly||this.sDDLBDisplayBehaviour===s.idAndDescription){if(this._isSortable(this.sKey)){this._oSorter=new g(this.sKey);}}else{if(this._isSortable(this.sDescription)){this._oSorter=new g(this.sDescription);}else if((this.sDescription!==this.sKey)&&this._isSortable(this.sKey)){this._oSorter=new g(this.sKey);}}};w.prototype._createSuggestionTemplate=function(){var i=0,a=0,b=0,x=this._aHighImportanceCols||this._aRecommendationCols||this._aCols;this._oTemplate=new d();if(x){this.oControl.removeAllSuggestionColumns();a=x.length;for(i=0;i<a;i++){var y=false,z="1px",A=x[i].width;if(D.system.phone){A=undefined;if(i>=2){y=true;z=(i+1)*10+"rem";}}this.oControl.addSuggestionColumn(new C({header:new T({wrapping:true,wrappingType:W.Hyphenated,text:x[i].label}),demandPopin:y,popinDisplay:P.Inline,minScreenWidth:z,width:A}));this._oTemplate.addCell(new T({wrapping:true,text:{path:this._resolveSuggestionBindingPath(x[i].template),type:x[i].oType}}));if(A){b+=parseFloat(A.substring(0,A.length-2));}}if(b>0){this.oControl.setProperty('maxSuggestionWidth',b+a+"em",true);}}this.oControl.data("_hassuggestionTemplate",true);};w.prototype._handleRowSelect=function(a,b){var K,i,x;if(a){K=a[this.sKey];i=a[this.sDescription];}if(K||(K==="")){if(this.oControl.addToken){i=j.getFormattedExpressionFromDisplayBehaviour(this.sTokenDisplayBehaviour,K,i);x=new e();x.setKey(K);x.setText(i);x.setTooltip(i);x.data("row",a);if(b){b(x);}if(this.oControl.getValue()===""){this.oControl.setValue("");}delete this.oControl.__sValidationText;}else{this.oControl.setValue(K);this.oControl.fireChange({value:K,validated:true});}}this._calculateAndSetFilterOutputData([a]);};w.prototype._multiInputValidator=function(a){if(!this.bInitialised){return;}if(this._aValidators){var b;this._aValidators.some(function(z){b=z(a);return b;},this);if(b){return b;}}var R=a.suggestionObject,i,I=a.text;if(R){var x=this._getSuggestionsModelName(),y=R.getBindingContext(x);i=y.getObject();this._handleRowSelect(i,a.asyncCallback);}else if(I){this._validateInput(I,a.asyncCallback);}};w.prototype._validateInput=function(i,a){var b=[],x=this.oControl,y;if(this.sDisplayFormat==="UpperCase"){i=i.toUpperCase();}if(x.__sValidationText!==i){x.__sValidationText=i;if(i===this._truncateSearchText(i)){x.__bValidatingToken=true;this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){b=k.generateFilters(this.aFilterField,this.mFilterInputData);}b.push(new F(this.sKey,h.EQ,i));if(this.bSupportBasicSearch){y={"search-focus":this.sKey};}this.oODataModel.read("/"+this.sValueListEntitySetName,{filters:b,urlParameters:y,success:function(R){if(!this.oControl||!this.oControl.hasOwnProperty("__bValidatingToken")){return;}var z=R;delete this.oControl.__bValidatingToken;if(R){if(R.results&&R.results.length>=1){if(R.results.length===1){z=R.results[0];}if(this.oControl.data("__validationError")){this.oControl.data("__validationError",null);this.oControl.setValueState("None");}}else{this.oControl.setValueState("Error");this.oControl.data("__validationError",true);}if(z&&z[this.sKey]){this._handleRowSelect(z,a);}}this._afterTokenValidate();}.bind(this),error:function(){if(this.oControl.data("__validationError")){this.oControl.setValueState("None");}delete this.oControl.__bValidatingToken;this._afterTokenValidate();}.bind(this)});}}else{if(x.data("__validationError")){x.setValueState(V.Error);}}};w.prototype._validateStringSingleWithValueList=function(E){var a;if(E.getParameter("validated")){return;}a=E.getParameter("value");if(a===""||a===undefined){return;}this._validateInput(a);};w.prototype._afterTokenValidate=function(){if(this.oFilterProvider&&this.oFilterProvider._oSmartFilter&&this.oFilterProvider._oSmartFilter.bIsSearchPending&&this.oFilterProvider._oSmartFilter.search){if(this.oFilterProvider._oSmartFilter.getLiveMode&&this.oFilterProvider._oSmartFilter.getLiveMode()){return;}this.oFilterProvider._oSmartFilter.search();}};w.prototype._onSuggestionItemSelected=function(E){var R=E.getParameter("selectedRow");if(R){var a=this._getSuggestionsModelName();this._handleRowSelect(R.getBindingContext(a).getObject());}};w.prototype._setFilterOutputDataFromSelectedRow=function(R){var a,b,i;if(R){a=this._getSuggestionsModelName();b=R.getBindingContext(a);i=b.getObject();this._calculateAndSetFilterOutputData([i]);}};w.prototype._onMultiComboBoxItemSelected=function(E){if(!E.getParameter("selected")){return;}var R=E.getParameter("changedItem");this._setFilterOutputDataFromSelectedRow(R);};w.prototype._onComboBoxItemSelected=function(E){var a=E.getParameter("value"),N=E.getParameter("newValue"),b=E.getParameter("filterChangeReason");if(b&&!a&&!N){return;}var R=this.oControl.getSelectedItem();this._setFilterOutputDataFromSelectedRow(R);};w.prototype._handleSelect=function(){if(this.oControl.addValidator){this._aValidators=this.oControl._tokenizer?this.oControl._tokenizer._aTokenValidators.slice():[];this.oControl.removeAllValidators();this._fValidator=this._multiInputValidator.bind(this);this.oControl.addValidator(this._fValidator);}else if(this.oControl.attachSuggestionItemSelected){this.oControl.attachSuggestionItemSelected(this._onSuggestionItemSelected,this);if(this.sContext==="SmartFilterBar"&&this._fieldViewMetadata&&this._fieldViewMetadata.hasValueListAnnotation){this.oControl.attachChange(this._validateStringSingleWithValueList,this);}}if(this.oControl.setRowResultFunction){this.oControl.setRowResultFunction(function(a){var b,R="",i=this._getSuggestionsModelName();if(a){b=a.getBindingContext(i);}if(b&&this.sKey){R=b.getProperty(this.sKey);}return R;}.bind(this));}};w.prototype._filterDropdownRowsByInParameters=function(){var a=[];this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){this._bFiltering=true;a=k.generateFilters(this.aFilterField,this.mFilterInputData,{dateSettings:this._oDateFormatSettings});this.oControl.getBinding("items").filter(a);this._mLastFilterInputData=this.mFilterInputData;this._cleanupControlSelection();}};w.prototype.isInSmartFilterBar=function(){return!!this.oFilterModel;};w.prototype._isControlDropdown=function(a){if(!a){a=this.oControl;}return!!(a.isA("sap.m.MultiComboBox")||a.isA("sap.m.ComboBox"));};w.prototype._cleanupControlSelection=function(){if(this.isInSmartFilterBar()&&this.oControl.isA("sap.m.MultiComboBox")&&this.mFilterInputData&&Object.keys(this.mFilterInputData).length!==0){this.oFilterModel.setProperty("/"+this.sFieldName+"/items",[]);this.oControl.setSelectedKeys(null);}};w.prototype._openDropdownWhenFiltered=function(E){if(E.getParameter("reason")==="filter"){this.oControl.getBinding("items").detachChange(this._openDropdownWhenFiltered,this);this.oControl.setBusy(false);this._bFiltering=false;if(this._bOpenControlWhenFiltered){this._bOpenControlWhenFiltered=false;this._openDropdown();}}};w.prototype._openDropdown=function(){if(this.oControl.isA("sap.m.MultiComboBox")){p.prototype.open.apply(this.oControl,arguments);}else if(this.oControl.isA("sap.m.ComboBox")){o.prototype.open.apply(this.oControl,arguments);}};w.prototype._handleOutParameters=function(){if(this.oControl.isA("sap.m.MultiComboBox")){this.oControl.attachSelectionChange(this._onMultiComboBoxItemSelected,this);}else if(this.oControl.isA("sap.m.ComboBox")){this.oControl.attachChange(this._onComboBoxItemSelected,this);}};w.prototype._handleInParameters=function(){if(!this.isInSmartFilterBar()&&this.oControl.getEditable()){this.oControl.getParent().attachContextEditableChanged(function(){this._bControlIsFiltered=false;},this);}this.oControl.setBusyIndicatorDelay(50);this.oControl.open=function(){if(this._bFiltering){return;}this._calculateFilterInputData();if(q(this._mLastFilterInputData,this.mFilterInputData)&&this._bControlIsFiltered){this._openDropdown();return;}this.oControl.setBusy(true);this.oControl.getBinding("items").attachChange(this._openDropdownWhenFiltered,this);this._bOpenControlWhenFiltered=true;this._filterDropdownRowsByInParameters();this._bControlIsFiltered=true;}.bind(this);this.oControl.addEventDelegate({onmousedown:function(E){if(E.target===this.oControl.getIcon().getFocusDomRef()){this._bSkipFocusIn=true;}}.bind(this),onmouseup:function(E){if(this._bSkipFocusIn&&E.target===this.oControl.getIcon().getFocusDomRef()){this.oControl.open();}this._bSkipFocusIn=false;}.bind(this),onfocusin:function(E){if(this._bSkipFocusIn||this._bFiltering){return E;}this._bOpenControlWhenFiltered=false;setTimeout(function(){this._calculateFilterInputData();if(q(this._mLastFilterInputData,this.mFilterInputData)&&this._bControlIsFiltered){return;}this.oControl.setBusy(true);this.oControl.getBinding("items").attachChange(this._openDropdownWhenFiltered,this);this._filterDropdownRowsByInParameters();this._bControlIsFiltered=true;}.bind(this));return E;}.bind(this)});};w.prototype._fetchData=function(a){var b={},i=[],x=this._getBindingLength(),y="",z;a=a||"";if(this.bTypeAheadEnabled){if(a&&this.sDisplayFormat==="UpperCase"){a=a.toUpperCase();}if(this.bSupportBasicSearch){if(this._shouldHaveRecommendations()||this._shouldHaveHistory()){b={"search-focus":this.sKey,"search":a};}else{b.custom={"search-focus":this.sKey,"search":a};}}this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){i=k.generateFilters(this.aFilterField,this.mFilterInputData,{dateSettings:this._oDateFormatSettings});}if(!this.bSupportBasicSearch){if(this._fieldViewMetadata&&this._fieldViewMetadata.filterType==="numc"){i.push(new F(this.sKey,h.Contains,a));}else{y=this._truncateSearchText(a);if(y===a){i.push(new F(this.sKey,h.StartsWith,y));}else{this.oControl.closeSuggestions();return;}}}x=10;}b["$top"]=x;b["$skip"]=0;if(!this.sValueListEntitySetName){r.error("ValueListProvider","Empty sValueListEntitySetName for "+this.sAggregationName+" binding! (missing primaryValueListAnnotation)");}if(this.sDeferredGroupId){b["batchGroupId"]=this.sDeferredGroupId;}if(this.aSelect&&this.aSelect.length){b["$select"]=this.aSelect.toString();}if(!(this._shouldHaveRecommendations()||this._shouldHaveHistory())){if(this.bTypeAheadEnabled&&this.bEnableShowTableSuggestionValueHelp){var E={dataReceived:function(K){var N=K.getSource(),O;if(N){O=N.getLength();if(O&&O<=x){this.oControl.setShowTableSuggestionValueHelp(false);}else{this.oControl.setShowTableSuggestionValueHelp(true);}}}.bind(this)};}else if(this.bTypeAheadEnabled){this.oControl.setShowTableSuggestionValueHelp(false);}this.oControl.bindAggregation(this.sAggregationName,{path:"/"+this.sValueListEntitySetName,length:x,parameters:b,filters:i,sorter:this._oSorter,events:E,template:this._oTemplate,templateShareable:true});return;}var A=this;z=new Promise(function(K,N){if(!A.sValueListEntitySetName){K({results:[]});}A.oODataModel.read("/"+A.sValueListEntitySetName,{urlParameters:b,filters:i,sorters:A._oSorter&&[A._oSorter],success:function(O){K(O);},error:function(O){N(O);}});});var I=Promise.resolve([]);if(this._shouldHaveHistory()){I=A._oHistoryValuesProvider.getFieldData();}Promise.all([z,this._oRecommendationListPromise,I]).then(function(R){var K=[],N=[],O=[],Q=[],U=A._getSuggestionsModelName(),X=A.oControl,Y=X.getModel(U);if(!X){return;}if(Array.isArray(R[0]&&R[0].results)){N=A._addSuggestionsToGroup(R[0].results,t.Others);}if(Array.isArray(R[1]&&R[1].results)){O=A._addSuggestionsToGroup(R[1].results,t.Recommendations);}if(A._shouldHaveHistory()&&Array.isArray(R[2])){Q=A._addSuggestionsToGroup(R[2],t.RecentlyUsed);}K=K.concat(O).concat(Q).concat(N);K=A._getDistinctSuggestions(K);A._showSuggestionsMoreButton(N.length>=x);Y.setData(K);});};w.prototype._sortRecommendations=function(a,b){var R=this._oRecommendationListAnnotation.rankProperty,i=parseFloat(a[R]),x=parseFloat(b[R]);return x-i;};w.prototype._showSuggestionsMoreButton=function(b){if(!this.bTypeAheadEnabled){return;}if(this.bEnableShowTableSuggestionValueHelp){this.oControl.setShowTableSuggestionValueHelp(b);}else{this.oControl.setShowTableSuggestionValueHelp(false);}};w.prototype._addSuggestionsToGroup=function(a,i){if(!a){return[];}return a.map(function(b){var x={};x[n.getSuggestionsGroupPropertyName()]=i;return Object.assign({},b,x);});};w.prototype._groupHeaderFactory=function(a){var b=this._getGroupHeaderTitle(a.key);if(this._isControlDropdown()){return new S({key:n.getHistoryPrefix()+a.key+".key",text:b});}return new G({title:b});};w.prototype._getGroupHeaderTitle=function(a){switch(a){case t.Recommendations:return this._oResourceBundle.getText("VALUELIST_RECOMMENDATIONS_TITLE");case t.RecentlyUsed:return this._oResourceBundle.getText("VALUELIST_RECENTLY_USED_TITLE");default:return this._oResourceBundle.getText("VALUELIST_OTHERS_TITLE");}};w.prototype._getGroupHeaderSorter=function(){if(this._groupHeaderSorter){return this._groupHeaderSorter;}this._groupHeaderSorter=new g({path:n.getSuggestionsGroupPropertyName(),descending:false,group:function(a){return a.getProperty(n.getSuggestionsGroupPropertyName());}});return this._groupHeaderSorter;};w.prototype._getDistinctSuggestions=function(a){var U={},b=[];a.forEach(function(x){var i=Object.assign({},x);delete i[n.getSuggestionsGroupPropertyName()];delete i.__metadata;var K=v(i).join();if(!U[K]){b.push(x);U[K]=true;}},this);return b;};w.prototype._resolveRecommendationListAnnotationData=function(R){var a=R.fieldsToDisplay,b,x,y;this._aRecommendationCols=[];this.aRecommendationSelect=[];for(var i=0;i<a.length;i++){b=a[i];x=this._getColumnConfigFromField(b);if(b.visible){this._aRecommendationCols.push(x);this.aRecommendationSelect.push(b.name);}}if(this._aHighImportanceCols&&this._oRecommendationListAnnotation){y=this._oRecommendationListAnnotation.rankField[0];y=this._getColumnConfigFromField(y);this._aHighImportanceCols.push(y);}};w.prototype._setupRecommendations=function(){if(!this._shouldHaveRecommendations()){return;}this._resolveRecommendationListAnnotationData(this._getRecommendationListAnnotation());this._fetchRecommendations();};w.prototype._shouldHaveRecommendations=function(){return M.isRecommendationList(this._fieldViewMetadata);};w.prototype._getRecommendationListAnnotation=function(){if(!this._oRecommendationListAnnotation){var R=this._oMetadataAnalyser._getRecommendationListAnnotation(this._sFullyQualifiedFieldName);this._oRecommendationListAnnotation=this._oMetadataAnalyser._enrichRecommendationListAnnotation(R);}return this._oRecommendationListAnnotation;};w.prototype._fetchRecommendations=function(){var a=this;this._oRecommendationListPromise=new Promise(function(b,i){a.oODataModel.read("/"+a._oRecommendationListAnnotation.path,{urlParameters:{$skip:0,$top:5,$select:a.aRecommendationSelect.toString()},sorter:a._oSorter,success:function(x){var R=a._addSuggestionsToGroup(x.results,t.Recommendations),y=a._getSuggestionsModelName(),z=a.oControl.getModel(y),A=z.getData(),E=R.sort(a._sortRecommendations.bind(a));a._aRecommendations=E;if(Array.isArray(A)){E=[].concat(A).concat(E);}z.setData(E);a._showSuggestionsMoreButton(false);b(x);},error:function(x){i(x);}});});};w.prototype._createHistoryValuesProvider=function(){return new H(this.oControl,this._sFullyQualifiedFieldName);};w.prototype._createHistoryOptOutProvider=function(){return m.createOptOutSettingPage();};w.prototype._setupHistoryValues=function(){if(!this._shouldHaveHistory()){return;}this._oHistoryValuesProvider=this._createHistoryValuesProvider();this._createHistoryOptOutProvider();this._oHistoryValuesProvider.getHistoryEnabled().then(function(E){if(!E){return;}this._oHistoryValuesProvider.attachChangeListener();this._oHistoryValuesProvider.attachEvent("fieldUpdated",this._onHistoryFieldUpdated,this);this._oHistoryValuesProvider.getFieldData().then(this._onHistoryDataInitialized.bind(this));}.bind(this));};w.prototype._onHistoryDataInitialized=function(a){this._updateModelHistoryData(a);return a;};w.prototype._onHistoryFieldUpdated=function(E){var a=E.getParameter("fieldData")||[];this._updateModelHistoryData(a);if(this.oControl.isA("sap.m.Input")){setTimeout(function(){this.oControl._oSuggPopover._oPopover.close();}.bind(this));}if(this.oControl.isA("sap.m.ComboBox")){setTimeout(function(){this.oControl._oSuggestionPopover._oPopover.close();}.bind(this));}};w.prototype._updateModelHistoryData=function(a){var b=[],R=this._addSuggestionsToGroup(a,t.RecentlyUsed),i=this._getSuggestionsModelName(),x=this.oControl.getModel(i),O=x.getData();if(!Array.isArray(O)){O=[];}b=this._getDistinctSuggestions(b.concat(R).concat(O));x.setData(b);this._showSuggestionsMoreButton(false);};w.prototype._shouldHaveHistory=function(){if(!this._fieldViewMetadata||!this._sFullyQualifiedFieldName||!this.oControl){return false;}var a=window["sap-ushell-config"],b,i,E;if(a){b=a.apps;}if(b){i=b.inputFieldHistory;}if(i){E=i.enabled;}return sap.ushell&&sap.ushell.Container&&E&&!M.isPotentiallySensitive(this._fieldViewMetadata);};w.prototype._bindInnerControlSuggestions=function(){if(this.sAggregationName&&this.sAggregationName==="suggestionRows"){this._createSuggestionTemplate();}else{this._createDropDownTemplate();}var b={path:this._getSuggestionsModelName()+">/",template:this._oTemplate,templateShareable:true,length:this._getBindingLength()};b.groupHeaderFactory=this._groupHeaderFactory;b.sorter=this._getGroupHeaderSorter();if(this.sAggregationName){this.oControl.bindAggregation(this.sAggregationName,b);}};w.prototype._setupSuggestionInteractions=function(){if(this.sAggregationName==="suggestionRows"){this._setupInputSuggestionInteractions();return;}this._setupComboBoxSuggestionInteractions();};w.prototype._setupInputSuggestionInteractions=function(){var i=this.oControl;i.setFilterSuggests(true);i.setFilterFunction(function(a,I){var b=this._getSuggestionsModelName(),x=I.getBindingContext(b).getObject(),K=x[this.sKey],y=x[this.sDescription],z=j.getFormatterFunctionFromDisplayBehaviour(this.sDDLBDisplayBehaviour),A=z(K,y);a=a.replace(/\*$/,"");a=a.replace(/^\*/,"");var E=Object.keys(x).some(function(K){var O=x[K]+"";return O.toLowerCase().indexOf(a.toLowerCase())!==-1;});var N=A.toLowerCase().indexOf(a.toLowerCase())!==-1;return E||N;}.bind(this));i.attachLiveChange(function(E){var a=E.getParameter("value"),A=[t.RecentlyUsed,t.Recommendations];if(a===""){this.oControl._oSuggPopover._oPopover.close();this._showInitialSuggestions(A);}},this);i.addEventDelegate({onfocusin:function(){var a=[t.RecentlyUsed,t.Recommendations],A=[t.RecentlyUsed];if(this._isNotRecommendationItemSelected("suggestionRows",i.getValue())){this._showInitialSuggestions(a);}else if(this._shouldHaveHistory()){this._showInitialSuggestions(A);}}},this);if(i.isA("sap.m.MultiInput")||!this._shouldHaveRecommendations()){return;}i.attachSuggestionItemSelected(function(E){var a=this._getSuggestionsModelName(),b=E.getParameter("selectedRow"),I;if(b){var x=b.getBindingContext(a).getObject();I=x&&x[this.sKey];}if(this._isNotRecommendationItemSelected("suggestionRows",I)){this._setControlValueState(V.Warning);}else{this._setControlValueState(V.None);}},this);};w.prototype._setupComboBoxSuggestionInteractions=function(){var a=this.oControl;a.setShowSecondaryValues(true);a.addEventDelegate({onmousedown:function(E){var b=E.srcControl;a._isTargetControlInputField=!(this._isControlDropdown(b));a._isTargetControlIcon=b.isA("sap.ui.core.Icon");a._isMouseDown=true;},onmouseup:function(){setTimeout(function(){a._isMouseDown=false;});},onfocusin:function(){if(a._isTargetControlInputField&&(a._isMouseDown||a._isTargetControlIcon)){return;}var A=[t.RecentlyUsed,t.Recommendations],b=[t.RecentlyUsed];if(this._isNotRecommendationItemSelected("items",a.getValue())){this._showInitialSuggestions(A);}else if(this._shouldHaveHistory()){this._showInitialSuggestions(b);}}},this);if(a.isA("sap.m.MultiComboBox")||!this._shouldHaveRecommendations()){return;}a.attachChange(function(E){if(this._isNotRecommendationItemSelected("items",E.getParameter("value"))){this._setControlValueState(V.Warning);}else{this._setControlValueState(V.None);}},this);};w.prototype._isNotRecommendationItemSelected=function(a,b){return this._findSuggestionItemGroup(a,b)!==t.Recommendations;};w.prototype._findSuggestionItemGroup=function(a,b){var I=this.oControl.getBinding(a).getCurrentContexts(),x;for(var i=0;i<I.length;i++){var y=I[i].getObject(),K=y[this.sKey],z=y[this.sDescription];if(K===b||z===b){x=y;break;}}return x?x[n.getSuggestionsGroupPropertyName()]:null;};w.prototype._setControlValueState=function(a){this.oControl.setValueState(a?a:V.None);this.oControl.setValueStateText(" ");};w.prototype._showInitialSuggestions=function(a){var b=this;this.oControl.showItems(function(i,I){var x=b._getSuggestionsModelName(),O=I.getBindingContext(x).getObject()[n.getSuggestionsGroupPropertyName()];return a.indexOf(O)!==-1;});};w.prototype._getSuggestionsModelName=function(){var a;if(this._shouldHaveRecommendations()||this._shouldHaveHistory()){a=u;}return a;};w.prototype._resolveSuggestionBindingPath=function(a){var b=this._getSuggestionsModelName();if(b){a=b+">"+a;}return a;};w.prototype._getBindingLength=function(){var i=300;if(this.oODataModel&&this.oODataModel.iSizeLimit&&this.oODataModel.iSizeLimit>i){i=this.oODataModel.iSizeLimit;}return i;};w.prototype._truncateSearchText=function(a){var i=-1;if(this._sMaxLength){i=parseInt(this._sMaxLength);}else if(this._fieldViewMetadata&&this._fieldViewMetadata.maxLength){i=parseInt(this._fieldViewMetadata.maxLength);}if(i>-1&&a.length>i){a=a.substr(0,i);}return a;};w.prototype.unbindAggregation=function(){if(this.oControl){this.oControl.unbindAggregation(this.sAggregationName);}return this;};w.prototype.destroy=function(){if(this.oControl){if(this.oControl.detachSuggest&&this._fSuggest){this.oControl.detachSuggest(this._fSuggest);this._fSuggest=null;}if(this.oControl.removeValidator&&this._fValidator){this.oControl.removeValidator(this._fValidator);this._fValidator=null;}else if(this.oControl.detachSuggestionItemSelected){this.oControl.detachSuggestionItemSelected(this._onSuggestionItemSelected,this);}if(this.oControl.detachChange){this.oControl.detachChange(this._validateStringSingleWithValueList,this);}this.oControl.unbindAggregation(this.sAggregationName);this.oControl.data("_hassuggestionTemplate",false);delete this.oControl.__sValidationText;delete this.oControl.__bValidatingToken;}if(this._oHistoryValuesProvider){this._oHistoryValuesProvider.destroy();this._oHistoryValuesProvider=null;}B.prototype.destroy.apply(this,arguments);if(this.oJsonModel){this.oJsonModel.destroy();this.oJsonModel=null;}if(this._oTemplate){this._oTemplate.destroy();}this._oTemplate=null;this.sAggregationName=null;this.bTypeAheadEnabled=null;this._oSorter=null;};return w;});
