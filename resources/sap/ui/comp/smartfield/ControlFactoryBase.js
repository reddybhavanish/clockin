/*
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/library","sap/ui/comp/library","sap/ui/model/BindingMode","sap/ui/comp/util/FormatUtil","sap/ui/comp/providers/ValueHelpProvider","sap/ui/comp/providers/ValueListProvider","sap/ui/comp/smartfield/BindingUtil","sap/ui/comp/odata/MetadataAnalyser","sap/m/HBox","sap/base/Log","sap/base/strings/capitalize"],function(B,c,l,a,F,V,b,d,M,H,L,e){"use strict";var C=l.smartfield.ControlContextType;var f=c.ValueState;var g=B.extend("sap.ui.comp.smartfield.ControlFactoryBase",{constructor:function(m,p){B.apply(this,arguments);this.sName="ControlFactoryBase";this._oModel=m;this._oParent=p;this._oBinding=new d();this._aProviders=[];this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");}});g.prototype.createControl=function(h){var m,o;m=this._getCreator(h);if(m){o=this[m]();this._addAriaLabelledBy(o);if(o&&o.onCreate){this[o.onCreate](o.control,o.params);}}return o;};g.prototype._addAriaLabelledBy=function(o){var t;if((this._oParent.getControlContext()===C.None)||(this._oParent.getControlContext()===C.Form)||(this._oParent.getControlContext()===C.SmartFormGrid)){if(o){t=o.control;if(t instanceof H){if(t.getItems().length>0){t=t.getItems()[0];}}}if(t&&t.addAriaLabelledBy&&this._oParent.getAriaLabelledBy().length>0){t.removeAllAriaLabelledBy();this._oParent.getAriaLabelledBy().forEach(function(A){t.addAriaLabelledBy(A);});}}};g.prototype.addValidations=function(o,m){var s,E,t=this;s=function(S,h){var i,j,k=h.getSource();if(k){if(k.setValueState){k.setValueState(S);}j=h.getParameter("exception");if(j){i=j.message;}if(!i){i=h.getParameter("message");}if(k.setValueStateText){k.setValueStateText(i);}}if(m){t._oParent[m](S===f.Error);}};E=function(h){s(f.Error,h);};o.attachFormatError(E);o.attachParseError(E);o.attachValidationError(E);o.attachValidationSuccess(function(h){s(f.None,h);});};g.prototype._getDisplayBehaviourConfiguration=function(D){var s=null;var o=this._oParent.getConfiguration();if(o){s=o.getDisplayBehaviour();}if(!s&&this._oMetaData&&this._oMetaData.entityType){s=this._oHelper.oAnnotation.getTextArrangement(this._oMetaData.property.property,this._oMetaData.entityType);}if(!s){s=this._oParent.data(D);}return s;};g.prototype._getPreventInitialDataFetchInVHDialog=function(E){var o=this._oParent.getConfiguration();if(o&&!o.isPropertyInitial("preventInitialDataFetchInValueHelpDialog")){return o.getPreventInitialDataFetchInValueHelpDialog();}if(M.isValueList(E)&&E["com.sap.vocabularies.Common.v1.ValueList"]&&E["com.sap.vocabularies.Common.v1.ValueList"].FetchValues){return E["com.sap.vocabularies.Common.v1.ValueList"].FetchValues.Int!=="1";}return false;};g.prototype._formatDisplayBehaviour=function(D,k,s){var h=this._getDisplayBehaviourConfiguration(D);if(D==="defaultCheckBoxDisplayBehaviour"){return this._getFormattedExpressionFromDisplayBehaviour(h,k);}if(D==="defaultComboBoxReadOnlyDisplayBehaviour"&&!h){h="descriptionAndId";}return F.getFormattedExpressionFromDisplayBehaviour(h||"idOnly",k,s);};g.prototype._getFormattedExpressionFromDisplayBehaviour=function(D,v){var k="";switch(D){case"OnOff":k=v?"SMARTFIELD_CB_ON":"SMARTFIELD_CB_OFF";break;case"TrueFalse":k=v?"SMARTFIELD_CB_TRUE":"SMARTFIELD_CB_FALSE";break;default:k=v?"SMARTFIELD_CB_YES":"SMARTFIELD_CB_NO";break;}return this._oRb.getText(k);};g.prototype.shouldCreateValueHelpForControl=function(o){if(!o){return false;}var p=this._oParent;return p&&((p.getMode()==="edit")||(o.getMetadata().getName()==="sap.ui.comp.smartfield.DisplayComboBox"));};g.prototype.getDropdownItemKeyType=function(){};g.prototype.getValueStateBindingInfoForRecommendationStateAnnotation=function(){};g.prototype.createValueHelp=function(s){var E=s.edmProperty,v=s.valueHelp;if(v.annotation&&(E["sap:value-list"]||E["com.sap.vocabularies.Common.v1.ValueList"])){var D=v.displayBehaviour||this._getDisplayBehaviourConfiguration("defaultDropDownDisplayBehaviour"),o=this._oParent.data("dateFormatSettings"),p=this._getPreventInitialDataFetchInVHDialog(E);if(typeof o==="string"){try{o=JSON.parse(o);}catch(h){}}var A,i;if(typeof v.annotation==="string"){i=v.annotation;}else if(v&&typeof v.annotation==="object"){A=v.analyser.getValueListAnnotationForFunctionImport({"":v.annotation},E.name).primaryValueListAnnotation;}var j=s.control,m=s.model,O=s.onValueListChange;if(!v.noDialog){if(j.setFilterSuggests){j.setFilterSuggests(false);}var k=new V({fieldName:E.name,control:j,model:m,dateFormatSettings:o,displayBehaviour:D,loadAnnotation:true,fullyQualifiedFieldName:i,metadataAnalyser:v.analyser,annotation:A,title:v.dialogtitle,preventInitialDataFetchInValueHelpDialog:p,supportMultiSelect:!!v.supportMultiSelect,supportRanges:!!v.supportRanges,takeOverInputValue:true,type:v.type,maxLength:E.maxLength});if(O){k.attachValueListChanged(O);}this._aProviders.push(k);if(j.setShowValueHelp){j.setShowValueHelp(true);}}if(!v.noTypeAhead||!j.isA("sap.m.Input")){var n=new b({control:j,model:m,dateFormatSettings:o,displayBehaviour:D,fieldViewMetadata:E,loadAnnotation:true,fullyQualifiedFieldName:i,metadataAnalyser:v.analyser,annotation:A,aggregation:v.aggregation,typeAheadEnabled:!v.noTypeAhead,dropdownItemKeyType:this.getDropdownItemKeyType(j),maxLength:E.maxLength});if(!v.noTypeAhead){if(j.setShowSuggestion){j.setShowSuggestion(true);}}if(O){n.attachValueListChanged(O);}this._aProviders.push(n);}}};g.prototype.getAttribute=function(n){var i=this._oParent.getBindingInfo(n);if(i){return this._oBinding.toBindingPath(i);}return this._oParent["get"+n.substring(0,1).toUpperCase()+n.substring(1)]();};g.prototype.getCustomDataConfiguration=function(){var o=this._oParent.data("configdata");return o&&o.configdata?o.configdata:null;};g.prototype.createAttributes=function(A,t,n,E){var h=this,m={};for(var p in n){if(n.hasOwnProperty(p)){var o=this._oParent.getBindingInfo(p);if(o){m[p]=this._oBinding.toBinding(o);}else if((p==="valueState")&&this._oParent.isPropertyInitial("valueState")){o=this.getValueStateBindingInfoForRecommendationStateAnnotation();if(o){m[p]=o;}else{m[p]=this._oParent["get"+e(p)]();}}else{m[p]=this._oParent["get"+e(p)]();}}}if(A){m[A]={model:this._oMetaData.model,path:this._oMetaData.path,type:t?this._oTypes.getType(t):null,mode:this._oParent.getBindingMode("value")};var i=this.getCustomDataConfiguration();if(i&&i.currency){m[A].mode=a.OneWay;}}if(E){m[E.event]=function(j){try{var P=j.getParameters();var k={value:P[E.parameter],newValue:P[E.parameter]};h._oParent.fireChange(k);}catch(q){L.warning(q);}};}return m;};g.prototype.mapBindings=function(A,N){var n,i;for(n in N){i=this._oParent.getBindingInfo(n);if(i){A[N[n]]=this._oBinding.toBinding(i);}else{A[N[n]]=this._oParent["get"+n.substring(0,1).toUpperCase()+n.substring(1)]();}}};g.prototype.getFormatSettings=function(s){var m=null,h,o,i;if(s){m=this._oParent.data(s);if(!m){h=this._oParent.getCustomData();if(h){i=h.length;while(i--){o=h[i];if(o.getKey()===s){m=o.getValue();break;}}}}if(m&&typeof(m)==="string"){try{m=JSON.parse(m);}catch(j){return null;}}}return m;};g.prototype.destroyValueHelp=function(){this._aProviders.forEach(function(p){p.destroy();});this._aProviders=[];};g.prototype.destroy=function(){this.destroyValueHelp();if(this._oBinding){this._oBinding.destroy();}this._oBinding=null;this._oParent=null;this._oModel=null;this._oRb=null;};return g;},true);
