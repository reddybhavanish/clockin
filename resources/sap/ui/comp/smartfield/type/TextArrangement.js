/*
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/Core","sap/ui/model/CompositeType","sap/ui/comp/util/FormatUtil","sap/ui/model/ParseException","sap/ui/model/ValidateException","sap/base/util/isPlainObject","sap/base/assert"],function(c,C,F,P,V,i,a){"use strict";var T=C.extend("sap.ui.comp.smartfield.type.TextArrangement",{constructor:function(o,b,s){this.getPrimaryType().call(this,o,b);C.call(this,o,b);this.init(o,b,s);a(s.keyField!==undefined,"Missing value for the keyField. - "+this.getName());a(s.descriptionField!==undefined,"Missing value for the descriptionField. - "+this.getName());},metadata:{"abstract":true}});T.prototype.init=function(o,b,s){this.sName="TextArrangement";this.bParseWithValues=true;this.async=true;var d={textArrangement:"idOnly"};var D={onBeforeValidateValue:function(){}};this.oSettings=Object.assign(D,s);this.oFormatOptions=Object.assign(d,o);this.fnParser=this.getValidator({textArrangement:this.oFormatOptions.textArrangement,prefix:"parse"});this.fnValidator=this.getValidator({textArrangement:this.oFormatOptions.textArrangement,prefix:"validate"});this.sDescription=undefined;};T.prototype.parseValue=function(v,s,b){var t=this.oFormatOptions.textArrangement;if(v===""||(t==="idOnly")){return this.parseIDOnly(v,s);}return this.fnParser(v,s,b,this.oFormatOptions,this.oSettings);};T.prototype.parseIDOnly=function(v,s){v=this.getPrimaryType().prototype.parseValue.call(this,v,s);return[v,undefined];};T.prototype.parseIDAndDescription=function(v,s,b,o){var r=/.*\s\(.*\)/i;if(r.test(v)){var d=/\s\(/gi;if(v.match(d).length>1){throw new P(this.getResourceBundleText("SMARTFIELD_NOT_FOUND"));}var e=T.splitIDAndDescription(v,{separator:d,textArrangement:o.textArrangement});v=e[0];this.sDescription=e[1];}else{this.sDescription=undefined;}return this.parseIDOnly(v,s);};T.prototype.parseDescriptionOnly=function(v,s,b,o,S){return new Promise(function(r,R){function h(D){var I,k=S.keyField,e=S.descriptionField;var g=f(v,{key:e,value:k,data:D});var j=g.length;if(j===1){I=this.getPrimaryType().prototype.parseValue.call(this,g[0],s);this.sDescription=v;r([I,undefined]);return;}if(j===0){g=f(v,{key:k,value:e,data:D});j=g.length;}if(j===0){R(new V(this.getResourceBundleText("SMARTFIELD_NOT_FOUND")));return;}if(j>1){R(new V(this.getResourceBundleText("SMARTFIELD_DUPLICATE_VALUES")));return;}I=this.getPrimaryType().prototype.parseValue.call(this,v,s);this.sDescription=g[0];r([I,undefined]);}function d(){R(new V());}var O={filterFields:this.getFilterFields(),success:h.bind(this),error:d};this.onBeforeValidateValue(v,O);}.bind(this));};T.prototype.validateValue=function(v){this.validateIDOnly(v);var I=v[0];if(I===null){return;}if(this.oFormatOptions.textArrangement==="descriptionOnly"){this.validateDescriptionOnly(v,this.oSettings);return;}return new Promise(function(r,R){function h(d){var s=Object.assign({},this.oSettings,{data:d,reject:R});var e=this.fnValidator(v,s);if(e){r(v);}}function b(){R(new V());}var o={filterFields:this.getFilterFields(),success:h.bind(this),error:b};this.onBeforeValidateValue(I,o);}.bind(this));};T.prototype.validateIDOnly=function(v){this.getPrimaryType().prototype.validateValue.call(this,v[0]);};T.prototype.validateIDAndDescription=function(v,s){var d=f(v[0],{key:s.keyField,value:s.descriptionField,data:s.data});var r=s.reject;if(d.length===0){r(new V(this.getResourceBundleText("SMARTFIELD_NOT_FOUND")));return false;}if(d.length>1){r(new V(this.getResourceBundleText("SMARTFIELD_DUPLICATE_VALUES")));return false;}var D=d[0];if((this.sDescription!==undefined)&&(D!==this.sDescription)){r(new V(this.getResourceBundleText("SMARTFIELD_NOT_FOUND")));return false;}this.sDescription=D;return true;};T.prototype.validateDescriptionOnly=function(v,s){};T.prototype.formatValue=function(v,t){var k=this.getPrimaryType().prototype.formatValue.call(this,v[0],t);if(k===""){return k;}var d=v[1];if(i(d)){d="";}return F.getFormattedExpressionFromDisplayBehaviour(this.oFormatOptions.textArrangement,k,d);};T.prototype.destroy=function(){this.oFormatOptions=null;this.oSettings=null;this.fnParser=null;this.fnValidator=null;this.sDescription="";};T.prototype.getName=function(){return"sap.ui.comp.smartfield.type.TextArrangement";};T.prototype.onBeforeValidateValue=function(v,s){this.oSettings.onBeforeValidateValue(v,s);};T.prototype.getResourceBundleText=function(k,p){return c.getLibraryResourceBundle("sap.ui.comp").getText(k,p);};T.prototype.getPrimaryType=function(){};T.prototype.getValidator=function(s){switch(s.textArrangement){case"idAndDescription":case"descriptionAndId":return this[s.prefix+"IDAndDescription"];case"descriptionOnly":return this[s.prefix+"DescriptionOnly"];default:return this[s.prefix+"IDOnly"];}};T.prototype.getFilterFields=function(v){return["keyField","descriptionField"];};function f(k,s){var v=[];s.data.forEach(function(d,I,D){if(d[s.key]===k){v.push(d[s.value]);}});return v;}T.splitIDAndDescription=function(v,s){var b=s.separator.exec(v),I=b["index"];switch(s.textArrangement){case"idAndDescription":return[v.slice(0,I),v.slice(I+2,-1)];case"descriptionAndId":return[v.slice(I+2,-1),v.slice(0,I)];default:return["",""];}};return T;});
