/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/library','sap/m/library','./library','sap/ui/core/Core','sap/base/Log','sap/base/util/uid','sap/ui/core/Item','sap/ui/core/syncStyleClass','sap/ui/model/json/JSONModel','sap/m/Button','sap/m/CheckBox','sap/m/Dialog','sap/m/Input','sap/m/Label','sap/m/Select','sap/m/Text','sap/m/VBox','sap/ui/VersionInfo'],function(c,l,a,C,L,u,I,s,J,B,b,D,d,e,S,T,V,f){'use strict';var g=l.ButtonType;var h=c.ValueState;var F=a.FileType;var E=a.EdmType;var j=null;var r=C.getLibraryResourceBundle('sap.ui.export',true);var k='sap.ui.export.ExportUtils';f.load().then(function(v){var M=/[0-9]+\.[0-9]+\.[0-9]+/.exec(v.version);j=M?M[0]:null;});function m(o,R){var n={fileName:'Standard',fileType:[{key:'xlsx'}],selectedFileType:'xlsx',splitCells:false,includeFilterSettings:false,addDateTime:false};var p=Object.assign({},n,o||{});for(var i=0;i<p.fileType.length;i++){var q;if(!p.fileType[i].text){p.fileType[i].text=R.getText(p.fileType[i].key.toUpperCase()+'_FILETYPE');}if(p.fileType[i].key===p.selectedFileType){q=p.fileType[i].key;}}if(!q){p.selectedFileType=p.fileType[0].key;}return p;}var U={_INTERCEPTSERVICE:'sap/ushell/cloudServices/interceptor/InterceptService',interceptUrl:function(i){var n=sap.ui.require(U._INTERCEPTSERVICE);if(n){var o=n.getInstance();if(o&&o.interceptUrl){i=o.interceptUrl(i);}}return i;},getExportSettingsViaDialog:function(i,o,n){return new Promise(function(R,p){var q;r.then(function(t){var v=new J();v.setData(m(i,t));var w=u();q=new D({id:w,title:t.getText('EXPORT_SETTINGS_TITLE'),horizontalScrolling:false,verticalScrolling:false,content:[new V({renderType:'Bare',width:'100%',items:[new e({text:t.getText('FILE_NAME'),labelFor:w+'-fileName'}),new d({id:w+'-fileName',value:'{/fileName}',liveChange:function(x){var y=x.getSource();var z=x.getParameter('value');var A=/[\\/:|?"*<>]/;var G=C.byId(w+'-export');var H=A.test(z);if(H){y.setValueState(h.Error);y.setValueStateText(t.getText('FILENAME_ERROR'));}else if(z.length>100){y.setValueState(h.Warning);y.setValueStateText(t.getText('FILENAME_WARNING'));}else{y.setValueState(h.None);y.setValueStateText(null);}G.setEnabled(!H);}}).addStyleClass('sapUiTinyMarginBottom'),new e({text:t.getText('SELECT_FORMAT'),labelFor:w+'-fileType',visible:false}),new S({id:w+'-fileType',width:'100%',selectedKey:'{/selectedFileType}',visible:false,items:{path:'/fileType',template:new I({key:'{key}',text:'{text}'})}}),new b({id:w+'-splitCells',selected:'{/splitCells}',text:t.getText('SPLIT_CELLS')}),new b({id:w+'-includeFilterSettings',selected:'{/includeFilterSettings}',text:t.getText('INCLUDE_FILTER_SETTINGS')}),new b({id:w+'-addDateTime',selected:'{/addDateTime}',text:t.getText('ADD_DATE_TIME'),visible:false})]}).addStyleClass('sapUiExportSettingsLabel')],endButton:new B({id:w+'-cancel',text:t.getText('CANCEL_BUTTON'),press:function(){q.close();}}),beginButton:new B({id:w+'-export',text:t.getText('EXPORT_BUTTON'),type:g.Emphasized,press:function(){if(q){q._bSuccess=true;q.close();R(v.getData());}}}),afterClose:function(){if(!q._bSuccess){p(null);}q.destroy();q=null;}});q.addStyleClass('sapUiContentPadding sapUiExportSettings');q.setModel(v);if(o){s('sapUiSizeCompact',o,q);}q.open();if(n){n(q);}});});},_getReadableFilterValue:function(o){switch(o.op||o.name){case'==':return'='+o.right.value;case'>':case'<':case'!=':case'<=':case'>=':return o.op+o.right.value;case'between':return o.args[1].value+'...'+o.args[2].value;case'contains':return'*'+o.args[1].value+'*';case'endswith':return'*'+o.args[1].value;case'startswith':return o.args[1].value+'*';default:throw Error('getReadableFilter');}},_parseFilter:function(o){switch(o.type){case'Logical':return U._parseLogical(o);case'Binary':return U._parseBinary(o);case'Unary':return U._parseUnary(o);case'Call':return U._parseCall(o);default:throw Error('Filter type '+o.type+' not supported');}},_parseLogical:function(o){if(o.op=='&&'&&o.left.type==='Binary'&&o.right.type==='Binary'&&o.left.op==='>='&&o.right.op==='<='&&o.left.left.path===o.right.left.path){return U._parseCall({args:[{path:o.left.left.path,type:'Reference'},{type:'Literal',value:o.left.right.value},{type:'Literal',value:o.right.right.value}],name:'between',type:'Call'});}return U._parseFilter(o.left).concat(U._parseFilter(o.right));},_parseBinary:function(o){if(!o.left||o.left.type!='Reference'||!o.right||o.right.type!='Literal'){return[];}return[{key:o.left.path,value:U._getReadableFilterValue(o)}];},_parseUnary:function(o){var i;if(!o.arg){return[];}i=U._parseFilter(o.arg);i[0].value='!'+i[0].value;return i;},_parseCall:function(o){if(!o.args||o.args.length<2){return[];}return[{key:o.args[0].path,value:U._getReadableFilterValue(o)}];},parseFilterConfiguration:function(o,i){return new Promise(function(R,n){r.then(function(p){var q,t;q={name:p.getText('FILTER_HEADER'),items:[]};if(!o||!(o.isA('sap.ui.model.ListBinding')||o.isA('sap.ui.model.TreeBinding'))){L.error('A ListBinding is required for parsing the filter settings');n();return null;}var v=o.getFilterInfo();if(v){q.items=U._parseFilter(v);}if(typeof i==='function'){q.items.forEach(function(w){t=i(w.key);w.key=t&&typeof t==='string'?t:w.key;});}R(q);});});},getAvailableCloudExportTargets:function(){var i=U.getCloudExportService();return i.then(function(n){return n&&n.getSupportedTargets?n.getSupportedTargets():[];}).catch(function(){return[];});},getCloudExportService:function(){return sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getServiceAsync?sap.ushell.Container.getServiceAsync('ProductivityIntegration'):Promise.reject();},saveAsFile:function(o,i){var n,p,q;if(!(o instanceof Blob)){return;}n=document.createElementNS('http://www.w3.org/1999/xhtml','a');p='download'in n;if(p){q=function(t,v){n.download=v;n.href=URL.createObjectURL(t);n.dispatchEvent(new MouseEvent('click'));};}if(typeof q==='undefined'){q=function(t){var v=new FileReader();v.onloadend=function(){var w,x;x=v.result.replace(/^data:[^;]*;/,'data:attachment/file;');w=window.open(x,'_blank');if(!w){window.location.href=x;}};v.readAsDataURL(t);};}if(typeof navigator!=='undefined'&&navigator.msSaveOrOpenBlob){q=function(t,v){window.navigator.msSaveOrOpenBlob(t,v);};}q(o,i);},validateSettings:function(i){var n;U._validateDataSource(i.dataSource);i.fileType=F[i.fileType]?i.fileType:F.XLSX;n='.'+i.fileType.toLowerCase();i.fileName=i.fileName||'export'+n;if(!i.fileName.endsWith(n)){i.fileName+=n;L.warning(k+': fileName was missing the proper file extension - extension has been added');}if(typeof i.showProgress!=='boolean'){i.showProgress=true;}U._validateWorkbook(i.workbook);if(typeof i.worker!=='boolean'){i.worker=true;}},_validateDataSource:function(i){var n;if(!i||typeof i!=='object'){throw new Error(k+': dataSource has not been specified');}i.type=i.type||'odata';if(i.type==='array'&&!Array.isArray(i.data)){L.warning(k+': Defined type does not match the provided data');}if(i.type==='odata'&&(typeof i.dataUrl!=='string'||i.dataUrl.length===0)){throw new Error(k+': Unable to export data. No dataUrl provided.');}if(typeof i.useBatch!=='boolean'){i.useBatch=false;L.info(k+': Parameter useBatch not provided. Applying default value "false"');}else if(i.useBatch===true){if(typeof i.serviceUrl!=='string'||i.serviceUrl.length===0){i.useBatch=false;L.warning(k+': serviceUrl is required for OData batch requests');}if(typeof i.serviceUrl!=='object'){i.useBatch=false;L.warning(k+': headers is required for OData batch requests.');}}n=i.sizeLimit;if(!n||isNaN(n)){var M=5000,o=200;n=i.count?Math.round(i.count/(o*5))*o:o;n=Math.min(M,Math.max(n,o));i.sizeLimit=n;L.info(k+': Parameter sizeLimit not provided. sizeLimit is set to '+n);}},_validateWorkbook:function(w){if(!(w instanceof Object)||!Array.isArray(w.columns)){throw new Error(k+'column configuration is not provided. Export is not possible');}w.columns=w.columns.filter(function(o,i,A){var W;if(!(o instanceof Object)){L.error(k+': Column '+i+' skipped due to invalid configuration');return false;}if(typeof o.property!=='string'&&!Array.isArray(o.property)){L.error(k+': Column '+i+' skipped due to missing mandatory property');return false;}o.label=o.label||(o.property instanceof Array?o.property[0]:o.property);W=o.width;if(typeof W==='string'){var n;n=W.toLowerCase();W=parseFloat(n);if(n.indexOf('em')>0){W=W*2;}else if(n.indexOf('px')>0){W=W/8;}}if(isNaN(W)||W<1){W=10;}o.width=Math.round(W);if(typeof o.type==='string'){if(!E[o.type]){L.warning(k+': Unsupported column type '+o.type+' on column '+i+'. Default type "String" is applied.');o.type=E.String;}else if(o.type===E.Currency&&!o.unitProperty){L.warning(k+': Missing unitProperty for type Currency on column '+i+'. Type is reverted to "String".');o.type=E.String;}else if(o.type===E.Enumeration&&(!o.valueMap||typeof o.valueMap!=='object')){L.warning(k+': Invalid valueMap for type Enumeration on column '+i+'. Type is reverted to "String".');o.type=E.String;}}U._validateString(o,'textAlign');if(o.textAlign){var t=(o.textAlign+'').toLowerCase();if(['begin','end'].indexOf(t)>-1){var p=['left','right'];t=(C.getConfiguration().getRTL()?p.reverse():p)[['begin','end'].indexOf(t)];}if(t!==''&&['left','right','center'].indexOf(t)==-1){L.warning(k+': Incorrect column alignment value '+t+' on column '+i+'. Default alignment is used.');t='';}o.textAlign=t;}['delimiter','displayUnit','wrap'].forEach(function(P){U._validateProperty(o,P,'boolean');});['inputFormat','unit','unitProperty','template','trueValue','falseValue'].forEach(function(P){U._validateString(o,P);});if(o.type===E.Boolean&&(o.trueValue===null||o.falseValue===null)){L.warning(k+': The properties trueValue and falseValue have to be assigned correctly on column '+i+'. Values will be discarded.');o.trueValue=null;o.falseValue=null;}var q=o.scale;if(o.type==='number'&&isNaN(q)&&q!=='variable'){L.warning(k+'scale parameter for numerical column configuration is missing.');}if(typeof q==='string'){q=parseInt(q);}if(isNaN(q)){q=null;}o.scale=q;if(o.valueMap&&typeof o.valueMap!=='object'){L.warning(k+': Invalid value for property "valueMap" on column '+i+'. Value will be discarded.');o.valueMap=null;}return true;});U._validateWorkbookContext(w.context);U._validateString(w,'hierarchyLevel');},_validateWorkbookContext:function(o){if(!(o instanceof Object)){return;}U._validateString(o,'application','SAP UI5');U._validateString(o,'version',j);U._validateString(o,'title');U._validateString(o,'modifiedBy');U._validateString(o,'sheetName','SAPUI5 Spreadsheet Export',31);U._validateString(o,'metaSheetName','Metadata',31);if(o.metainfo){if(!Array.isArray(o.metainfo)){L.warning(k+': Invalid value for property "metainfo". Value will be discarded.');o.metainfo=null;}else{o.metainfo.filter(function(G,i){if(typeof G.name!=='string'||G.name.length===0){L.warning(k+': Invalid name for metainfo group at index '+i+'. Entry will be discarded.');return false;}return true;});}}},_validateString:function(o,p,i,M){var v;U._validateProperty(o,p,'string',i);v=o[p];if(typeof v==='string'&&M&&v.length>M){L.warning(k+': The value of '+p+' exceeds the max length of '+M+' and will be truncated.');v=v.slice(0,M);}o[p]=v;},_validateProperty:function(o,p,t,i){var v=o[p];if(v!=null&&typeof v!==t){L.warning(k+': Invalid value for property "'+p+'. Value will be discarded.');v=null;}o[p]=v==null&&i?i:v;}};return U;},true);
