/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/StorageUtils","sap/ui/fl/Change","sap/ui/fl/Layer","sap/ui/fl/Variant","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Cache","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/write/_internal/Storage","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ui/thirdparty/jquery","sap/base/util/includes","sap/base/util/merge","sap/base/Log","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState"],function(D,S,C,L,V,U,a,b,A,c,J,d,e,M,q,i,m,f,g){"use strict";var h=function(k){this._mComponent=k;this._mChanges=D.createEmptyDependencyMap();this._bChangesMapCreated=false;this._mChangesInitial=m({},this._mChanges);this._mVariantsChanges={};if(!this._mComponent||!this._mComponent.name){f.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.");}this._aDirtyChanges=[];this._oMessagebundle=undefined;this._mChangesEntries={};this._bHasChangesOverMaxLayer=false;this.HIGHER_LAYER_CHANGES_EXIST="higher_layer_changes_exist";};function r(v,o){return v.controlChanges.some(function(k,l){if(k.fileName===o.getDefinition().fileName){v.controlChanges.splice(l,1,o);return true;}});}function j(F,o){var k;if(o instanceof C){k=o;this._mChangesEntries[k.getFileName()]=k;}else{if(!this._mChangesEntries[o.fileName]){this._mChangesEntries[o.fileName]=new C(o);}k=this._mChangesEntries[o.fileName];k.setState(C.states.PERSISTED);var v=k.getVariantReference();if(v){var l=g.getVariant({vReference:v,reference:this._mComponent.name});if(l){r(l,k);}}}return k;}h.prototype.getComponentName=function(){return this._mComponent.name;};h.prototype.getCacheKey=function(o){return b.getCacheKey(this._mComponent,o);};h.prototype._preconditionsFulfilled=function(I,o){var k=o instanceof C?o.getDefinition():o;if(!k.fileName){f.warning("A change without fileName is detected and excluded from component: "+this._mComponent.name);return false;}function l(){if(I){return(k.fileType==="change")||(k.fileType==="variant");}return(k.fileType==="change")&&(k.changeType!=="defaultVariant");}function n(){if(I){if((k.fileType==="variant")||(k.changeType==="defaultVariant")){return k.selector&&k.selector.persistencyKey;}}return true;}function p(){if((k.fileType==="ctrl_variant")||(k.fileType==="ctrl_variant_change")||(k.fileType==="ctrl_variant_management_change")){return k.variantManagementReference||k.variantReference||(k.selector&&k.selector.id);}}if(l()&&n()||p()){return true;}return false;};h.prototype.getChangesForComponent=function(p,I){return b.getChangesFillingCache(this._mComponent,p,I).then(function(p,w){var o=m({},w);var k=p&&p.component&&U.getAppComponentForControl(p.component);var H=S.isStorageResponseFilled(o.changes);if(!H){return[];}var l=o.changes.changes;if(!this._oMessagebundle&&o.messagebundle&&k){if(!k.getModel("i18nFlexVendor")){if(l.some(function(y){return y.layer===L.VENDOR;})){this._oMessagebundle=o.messagebundle;var n=new e(this._oMessagebundle);k.setModel(n,"i18nFlexVendor");}}}var s=p&&p.currentLayer;var F=!(p&&p.ignoreMaxLayerParameter);var t=function(){return true;};if(s){t=this._filterChangeForCurrentLayer.bind(this,s);l=l.filter(t);}else if(a.isLayerFilteringRequired()&&F){t=this._filterChangeForMaxLayer.bind(this);l=l.filter(t);}else if(this._bHasChangesOverMaxLayer&&!F){this._bHasChangesOverMaxLayer=false;return this.HIGHER_LAYER_CHANGES_EXIST;}var u=o.changes&&p&&p.includeCtrlVariants;var v=this._getAllCtrlVariantChanges(o,u,t);l=l.concat(v);var x=p&&p.includeVariants;return this._checkAndGetChangeInstances(l,x,o);}.bind(this,p));};h.prototype._checkAndGetChangeInstances=function(k,I,o){return k.filter(this._preconditionsFulfilled.bind(this,I)).map(j.bind(this,o));};h.prototype._filterChangeForMaxLayer=function(o){if(a.isOverMaxLayer(this._getLayerFromChangeOrChangeContent(o))){if(!this._bHasChangesOverMaxLayer){this._bHasChangesOverMaxLayer=true;}return false;}return true;};h.prototype._filterChangeForCurrentLayer=function(l,o){return l===this._getLayerFromChangeOrChangeContent(o);};h.prototype._getLayerFromChangeOrChangeContent=function(o){var s;if(o instanceof V||o instanceof C){s=o.getLayer();}else{s=o.layer;}return s;};h.prototype._getAllCtrlVariantChanges=function(o,I,F){if(!I){return g.loadInitialChanges({reference:this._mComponent.name});}return["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"].reduce(function(R,v){if(o.changes[v]){return R.concat(o.changes[v]);}return R;},[]).filter(F);};h.prototype.getSmartVariantManagementChangeMap=function(){return this._mVariantsChanges;};h.prototype.getChangesForVariant=function(s,k,p){if(this._mVariantsChanges[k]){return Promise.resolve(this._mVariantsChanges[k]);}var l=function(o){var t=false;var u=o._oDefinition.selector;q.each(u,function(v,w){if(v===s&&w===k){t=true;}});return t;};var n=function(o,t){f.error("key : "+o+" and text : "+t.value);};return this.getChangesForComponent(p).then(function(o){return o.filter(l);}).then(function(o){if(!this._mVariantsChanges[k]){this._mVariantsChanges[k]={};}var I;o.forEach(function(t){I=t.getId();if(t.isValid()){if(this._mVariantsChanges[k][I]&&t.isVariant()){f.error("Id collision - two or more variant files having the same id detected: "+I);q.each(t.getDefinition().texts,n);f.error("already exists in variant : ");q.each(this._mVariantsChanges[k][I].getDefinition().texts,n);}this._mVariantsChanges[k][I]=t;}}.bind(this));return this._mVariantsChanges[k];}.bind(this));};h.prototype.addChangeForVariant=function(s,k,p){var F;var I;var l;var o;var n;if(!p){return undefined;}if(!p.type){f.error("sap.ui.fl.Persistence.addChange : type is not defined");}var t=q.type(p.content);if(t!=='object'&&t!=='array'){f.error("mParameters.content is not of expected type object or array, but is: "+t,"sap.ui.fl.Persistence#addChange");}l={};if(typeof(p.texts)==="object"){q.each(p.texts,function(u,w){l[u]={value:w,type:"XFLD"};});}var v={creation:this._mComponent.appVersion,from:this._mComponent.appVersion};if(this._mComponent.appVersion&&p.developerMode){v.to=this._mComponent.appVersion;}I={changeType:p.type,service:p.ODataService,texts:l,content:p.content,reference:this._mComponent.name,isVariant:p.isVariant,packageName:p.packageName,isUserDependent:p.isUserDependent,validAppVersions:v};I.selector={};I.selector[s]=k;F=C.createInitialFileContent(I);if(p.id){F.fileName=p.id;}o=new C(F);n=o.getId();if(!this._mVariantsChanges[k]){this._mVariantsChanges[k]={};}this._mVariantsChanges[k][n]=o;return o.getId();};h.prototype.saveAllChangesForVariant=function(s){var p=[];q.each(this._mVariantsChanges[s],function(k,o){var l=o.getId();switch(o.getPendingAction()){case"NEW":var n=c.write({flexObjects:[o.getDefinition()],layer:o.getLayer(),transport:o.getRequest(),isLegacyVariant:o.isVariant()}).then(function(v){if(v&&v.response&&v.response[0]){o.setResponse(v.response[0]);}else{o.setState(C.states.PERSISTED);}b.addChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},o.getDefinition());return v;}.bind(this));p.push(n);break;case"UPDATE":var u=c.update({flexObject:o.getDefinition(),layer:o.getLayer(),transport:o.getRequest()}).then(function(v){if(v&&v.response){o.setResponse(v.response);}else{o.setState(C.states.PERSISTED);}b.updateChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},o.getDefinition());return v;}.bind(this));p.push(u);break;case"DELETE":var t=c.remove({flexObject:o.getDefinition(),layer:o.getLayer(),transport:o.getRequest()}).then(function(v){var o=this._mVariantsChanges[s][l];if(o.getPendingAction()==="DELETE"){delete this._mVariantsChanges[s][l];}b.deleteChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},o.getDefinition());return v;}.bind(this));p.push(t);break;default:break;}}.bind(this));return Promise.all(p);};h.prototype.loadChangesMapForComponent=function(o){return this.getChangesForComponent({component:o}).then(k.bind(this));function k(l){M.start("fl.createDependencyMap","Measurement of creating initial dependency map");this._mChanges=D.createEmptyDependencyMap();l.forEach(this._addChangeAndUpdateDependencies.bind(this,o));this._mChangesInitial=m({},this._mChanges);M.end("fl.createDependencyMap","Measurement of creating initial dependency map");this._bChangesMapCreated=true;return this.getChangesMapForComponent.bind(this);}};h.prototype.checkForOpenDependenciesForControl=function(s,o){return D.checkForOpenDependenciesForControl(this._mChanges,J.getControlIdBySelector(s,o),o);};h.prototype.copyDependenciesFromInitialChangesMap=function(o,k,l){var I=m({},this._mChangesInitial.mDependencies);var n=I[o.getId()];if(n){var N=[];n.dependencies.forEach(function(t){if(k(t)){this._mChanges.mDependentChangesOnMe[t]=this._mChanges.mDependentChangesOnMe[t]||[];this._mChanges.mDependentChangesOnMe[t].push(o.getId());N.push(t);}}.bind(this));var s;var p=[];n.controlsDependencies.forEach(function(t){if(!J.bySelector(t,l)){s=J.getControlIdBySelector(t,l);p.push(t);this._mChanges.mControlsWithDependencies[s]=this._mChanges.mControlsWithDependencies[s]||[];if(!i(this._mChanges.mControlsWithDependencies[s],o.getId())){this._mChanges.mControlsWithDependencies[s].push(o.getId());}}}.bind(this));n.dependencies=N;n.controlsDependencies=p;if(N.length||p.length){this._mChanges.mDependencies[o.getId()]=n;}}return this._mChanges;};h.prototype._addChangeAndUpdateDependencies=function(o,k){k.setInitialApplyState();D.addChangeAndUpdateDependencies(k,o,this._mChanges);};h.prototype._addRunTimeCreatedChangeAndUpdateDependencies=function(o,k){D.addRuntimeChangeAndUpdateDependencies(k,o,this._mChanges,this._mChangesInitial);};h.prototype.getChangesMapForComponent=function(){return this._mChanges;};h.prototype.isChangeMapCreated=function(){return this._bChangesMapCreated;};function _(p,o){var k=p.modifier;var l=p.appComponent;var s=o.getSelector();if(!s||!p){return false;}if(s.viewSelector){var n=k.getControlIdBySelector(s.viewSelector,l);return n===p.viewId;}var t=s.id;if(t){var v;if(o.getSelector().idIsLocal){if(l){v=l.getLocalId(p.viewId);}}else{v=p.viewId;}var I=0;var u;do{I=t.indexOf("--",I);u=t.slice(0,I);I++;}while(u!==v&&I>0);return u===v;}return false;}h.prototype.getChangesForView=function(p){return this.getChangesForComponent(p).then(function(k){return k.filter(_.bind(this,p));}.bind(this));};h.prototype.getChangesForExtensionPoint=function(p){var k=function(o){var n=o.getSelector().name;if(n!==p.name){return false;}return _(p,o);};if(!p.name){f.warning("Missing name from extension point info!");return Promise.resolve([]);}return this.getChangesForComponent().then(function(l){return l.filter(k);});};h.prototype.addChange=function(v,o){var k=this.addDirtyChange(v);this._addRunTimeCreatedChangeAndUpdateDependencies(o,k);this._addPropagationListener(o);return k;};h.prototype.addDirtyChange=function(v){var n;if(v instanceof C||v instanceof V){n=v;}else{n=new C(v);}if(this._aDirtyChanges.indexOf(n)===-1){this._aDirtyChanges.push(n);}return n;};h.prototype._addPropagationListener=function(o){var k=U.getAppComponentForControl(o);if(k instanceof d){var l=function(P){return!P._bIsSapUiFlFlexControllerApplyChangesOnControl;};var n=k.getPropagationListeners().every(l);if(n){var p=k.getManifestObject();var v=U.getAppVersionFromManifest(p);var F=sap.ui.require("sap/ui/fl/FlexControllerFactory");var s=F.create(this.getComponentName(),v);var P=A.applyAllChangesForControl.bind(A,this.getChangesMapForComponent.bind(this),k,s);P._bIsSapUiFlFlexControllerApplyChangesOnControl=true;k.addPropagationListener(P);}}};h.prototype.saveDirtyChanges=function(s,k,l){var n=k||this._aDirtyChanges;var o=n.slice(0);var R=this._getRequests(n);var p=this._getPendingActions(n);if(p.length===1&&R.length===1&&p[0]==="NEW"){var t=R[0];var P=this._prepareDirtyChanges(n);return c.write({layer:P[0].layer,flexObjects:P,transport:t,isLegacyVariant:false,draft:l}).then(function(u){this._massUpdateCacheAndDirtyState(o,s);return u;}.bind(this));}return this.saveSequenceOfDirtyChanges(o,s,l);};h.prototype.saveSequenceOfDirtyChanges=function(k,s,l){return k.reduce(function(p,o){return p.then(this._performSingleSaveAction(o,l)).then(this._updateCacheAndDirtyState.bind(this,o,s));}.bind(this),Promise.resolve());};h.prototype._performSingleSaveAction=function(o,k){return function(){if(o.getPendingAction()==="NEW"){return c.write({layer:o.getLayer(),flexObjects:[o.getDefinition()],transport:o.getRequest(),isLegacyVariant:o.isVariant(),draft:k});}if(o.getPendingAction()==="DELETE"){return c.remove({flexObject:o.getDefinition(),layer:o.getLayer(),transport:o.getRequest()});}};};h.prototype._updateCacheAndDirtyState=function(o,s){if(!s){if(U.isChangeRelatedToVariants(o)){g.updateVariantsState({reference:this._mComponent.name,changeToBeAddedOrDeleted:o});}else if(o.getPendingAction()==="NEW"){b.addChange(this._mComponent,o.getDefinition());}else if(o.getPendingAction()==="DELETE"){b.deleteChange(this._mComponent,o.getDefinition());}}this._aDirtyChanges=this._aDirtyChanges.filter(function(E){return o.getId()!==E.getId();});};h.prototype._massUpdateCacheAndDirtyState=function(k,s){k.forEach(function(o){this._updateCacheAndDirtyState(o,s);},this);};h.prototype._getRequests=function(k){var R=[];k.forEach(function(o){var s=o.getRequest();if(R.indexOf(s)===-1){R.push(s);}});return R;};h.prototype._getPendingActions=function(k){var p=[];k.forEach(function(o){var P=o.getPendingAction();if(p.indexOf(P)===-1){p.push(P);}});return p;};h.prototype._prepareDirtyChanges=function(k){var l=[];k.forEach(function(o){l.push(o.getDefinition());});return l;};h.prototype.getDirtyChanges=function(){return this._aDirtyChanges;};h.prototype.deleteChange=function(o,R){var n=this._aDirtyChanges.indexOf(o);if(n>-1){if(o.getPendingAction()==="DELETE"){return;}this._aDirtyChanges.splice(n,1);this._deleteChangeInMap(o,R);return;}o.markForDeletion();this.addDirtyChange(o);this._deleteChangeInMap(o,R);};h.prototype._deleteChangeInMap=function(o,R){var s=o.getId();D.removeChangeFromMap(this._mChanges,s);D.removeChangeFromDependencies(R?this._mChangesInitial:this._mChanges,s);};h.prototype.transportAllUIChanges=function(R,s,l,k){return this.getChangesForComponent({currentLayer:l,includeCtrlVariants:true}).then(function(n){return c.publish({transportDialogSettings:{rootControl:R,styleClass:s},layer:l,reference:this.getComponentName(),appVersion:this._mComponent.appVersion,localChanges:n,appVariantDescriptors:k});}.bind(this));};h.prototype._getChangesFromMapByNames=function(n){return this._mChanges.aChanges.filter(function(o){return n.indexOf(o.getFileName())!==-1;});};h.prototype.resetChanges=function(l,G,s,k){var n=s&&s.length>0;var o=k&&k.length>0;if(!G&&!n&&!o){f.error("Of the generator, selector IDs and change types parameters at least one has to filled");return Promise.reject("Of the generator, selector IDs and change types parameters at least one has to filled");}return this.getChangesForComponent({currentLayer:l,includeCtrlVariants:true}).then(function(p){var P={reference:this.getComponentName(),appVersion:this._mComponent.appVersion,layer:l,changes:p};if(G){P.generator=G;}if(n){P.selectorIds=s;}if(o){P.changeTypes=k;}return c.reset(P);}.bind(this)).then(function(R){var p=[];if(s||k){var N=[];if(R&&R.response&&R.response.length>0){R.response.forEach(function(t){N.push(t.name);});}b.removeChanges(this._mComponent,N);p=this._getChangesFromMapByNames(N);}return p;}.bind(this));};h.prototype.getResetAndPublishInfo=function(p){return c.getFlexInfo(p);};return h;},true);
