/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObjectObserver","sap/ui/core/util/reflection/JsControlTreeModifier"],function(M,J){"use strict";var E=function(){this._bEnabledObserver=sap.ui.getCore().getConfiguration().getDesignMode();this._mObservers={};this._aExtensionPointsByParent=[];this._mExtensionPointsByViewId={};this._aApplyExtensionPointPromises=[];};E._instance=undefined;E.getInstance=function(){if(!E._instance){E._instance=new E();}return E._instance;};E.prototype._observeIndex=function(e){var p=e.object.getId();var a;this._aExtensionPointsByParent[p].forEach(function(o){a=o.aggregationName;if(a===e.name){var c=J.getAggregation(e.object,a).map(function(C){return C.getId();});if(e.mutation==="insert"){if(c.indexOf(e.child.getId())<o.index){o.index++;}}else if(o.aggregation.indexOf(e.child.getId())<o.index){o.index--;}o.aggregation=c;}});};E.prototype._startObserver=function(p,a){if(this._bEnabledObserver){var P=p.getId();if(!this._mObservers[P]){var o=new M(this._observeIndex.bind(this));o.observe(p,{aggregations:[a]});this._mObservers[P]={observer:o,aggregations:[a]};}else{var i=this._mObservers[P].observer.isObserved(p,{aggregations:[a]});if(!i){this._mObservers[P].aggregations.push(a);this._mObservers[P].observer.observe(p,{aggregations:this._mObservers[P].aggregations});}}}};E.prototype.registerExtensionPoints=function(e){var p=e.targetControl;var v=e.view.getId();var a=e.aggregationName;this._startObserver(p,a);var A=J.getAggregation(p,a);var c=[].concat(A||[]).map(function(C){return C.getId();});var P=p.getId();if(!this._aExtensionPointsByParent[P]){this._aExtensionPointsByParent[P]=[];}if(!this._mExtensionPointsByViewId[v]){this._mExtensionPointsByViewId[v]={};}e.aggregation=c;this._aExtensionPointsByParent[P].push(e);this._mExtensionPointsByViewId[v][e.name]=e;};E.prototype.getExtensionPointInfo=function(e,v){return this._mExtensionPointsByViewId[v.getId()]&&this._mExtensionPointsByViewId[v.getId()][e];};E.prototype.getExtensionPointInfoByParentId=function(p){return this._aExtensionPointsByParent[p]||[];};E.prototype.addApplyExtensionPointPromise=function(p){return this._aApplyExtensionPointPromises.push(p);};E.prototype.getApplyExtensionPointsPromise=function(){return Promise.all(this._aApplyExtensionPointPromises);};E.prototype.exit=function(){Object.keys(this._mObservers).forEach(function(p){this._mObservers[p].observer.disconnect();this._mObservers[p].observer.destroy();}.bind(this));this._mObservers={};this._aExtensionPointsByParent=[];this._mExtensionPointsByViewId={};this._aApplyExtensionPointPromises=[];E._instance=undefined;};return E;},true);
