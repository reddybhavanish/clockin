/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/BusyIndicator","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Change","sap/ui/fl/changeHandler/Base","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/base/util/merge","sap/base/util/includes","sap/base/util/ObjectPath","sap/ui/fl/apply/_internal/flexState/FlexState","sap/base/util/isEmptyObject","sap/ui/fl/apply/_internal/flexState/controlVariants/Switcher","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/base/Log"],function(J,a,B,L,U,b,C,c,R,d,m,i,O,F,e,S,V,f,g){"use strict";function _(E,p){return k(function(P,v){var M=v.model;var o=v.vmReference;var q=false;var t=P.key;var u=P.key;return Promise.resolve().then(function(){if(O.get([o,"currentVariant"],M.oData)&&M.oData[o].currentVariant!==M.oData[o].originalCurrentVariant){u=M.oData[o].originalCurrentVariant;q=true;return M.updateCurrentVariant(o,t,M.oAppComponent,true);}}).then(function(){if(O.get([o,"modified"],M.oData)===true){var w=V.getVariantChanges({reference:M.sFlexReference,vmReference:o,vReference:u,changeInstance:true});return h({changes:w,vmReference:o,vReference:u,revert:!q,model:M}).then(function(){M.oData[o].originalCurrentVariant=t;M.oData[o].modified=false;M.checkUpdate(true);});}});}.bind(null,E.getParameters(),p),p.model,p.vmReference);}function h(p){var v=p.model._getDirtyChangesFromVariantChanges(p.changes);return Promise.resolve().then(function(){if(p.revert){return R.revertMultipleChanges(v,{appComponent:p.model.oAppComponent,modifier:a,flexController:p.model.oFlexController});}}).then(function(){v.forEach(function(o){V.removeChangeFromVariant({reference:p.model.sFlexReference,change:o,vmReference:p.vmReference,vReference:p.vReference});p.model.oFlexController.deleteChange(o,p.model.oAppComponent);});});}function j(M,v,o){if(o||M.oData[v]){M.oData[v].variantBusy=o;}M.checkUpdate();}function k(o,M,v){M._oVariantSwitchPromise=M._oVariantSwitchPromise.catch(function(){}).then(j.bind(null,M,v,true)).then(o).then(j.bind(null,M,v,false)).catch(function(E){j(M,v,false);throw E;});M.oFlexController.setVariantSwitchPromise(M._oVariantSwitchPromise);return M._oVariantSwitchPromise;}function r(p){return S.switchVariant(p).then(function(){delete this.oData[p.vmReference];}.bind(this)).catch(function(E){g.warning(E.message);});}function s(p){return S.switchVariant(p).then(function(){this.oData[p.vmReference].originalCurrentVariant=p.newVReference;this.oData[p.vmReference].currentVariant=p.newVReference;if(this.oData[p.vmReference].updateVariantInURL){d.updateVariantInURL({vmReference:p.vmReference,newVReference:p.newVReference,model:this});}this.checkUpdate();}.bind(this));}function l(v,o,D){if((v.layer===b.getCurrentLayer(!D))&&(v.key!==o)){return true;}return false;}var n=J.extend("sap.ui.fl.variants.VariantModel",{constructor:function(D,o,A,p){this.pSequentialImportCompleted=Promise.resolve();J.apply(this,arguments);this.bObserve=p;if(!o){o=sap.ui.requireSync("sap/ui/fl/FlexControllerFactory").createForControl(A);}this.oFlexController=o;this.oChangePersistence=this.oFlexController._oChangePersistence;this.sFlexReference=this.oChangePersistence.getComponentName();this.oAppComponent=A;this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");this._oVariantSwitchPromise=Promise.resolve();if(e(D)){try{D=V.fillVariantModel({reference:this.sFlexReference});}catch(E){g.error("Variants Map was not found: "+E.message);}}if(D&&typeof D==="object"){Object.keys(D).forEach(function(K){D[K].variants.forEach(function(v){if(!D[K].currentVariant&&(v.key===D[K].defaultVariant)){D[K].currentVariant=v.key;}v.originalTitle=v.title;v.originalFavorite=v.favorite;v.originalExecuteOnSelect=v.executeOnSelect;v.originalVisible=v.visible;});D[K].originalCurrentVariant=D[K].currentVariant;D[K].originalDefaultVariant=D[K].defaultVariant;});this.setData(D);}d.initialize({model:this});}});n.prototype.updateCurrentVariant=function(v,N,A,I){var p={vmReference:v,currentVReference:this.oData[v].originalCurrentVariant,newVReference:N,flexController:this.oFlexController,appComponent:A||this.oAppComponent,modifier:a,reference:this.sFlexReference};if(I){return s.call(this,p);}return k(s.bind(this,p),this,v);};n.prototype.getCurrentVariantReference=function(v){return this.oData[v].currentVariant;};n.prototype.getVariantManagementReference=function(v){var o="";var I=-1;Object.keys(this.oData).some(function(K){return this.oData[K].variants.some(function(p,q){if(p.key===v){o=K;I=q;return true;}});}.bind(this));return{variantManagementReference:o,variantIndex:I};};n.prototype.getVariant=function(v,o){return V.getVariant({reference:this.sFlexReference,vmReference:o||this.getVariantManagementReference(v).variantManagementReference,vReference:v});};n.prototype.getVariantProperty=function(v,p){return this.getVariant(v).content.content[p];};n.prototype.addChange=function(o){var v=o.getVariantReference();var p=this.getVariantManagementReference(v).variantManagementReference;this.oData[p].modified=!!this.oData[p].variantsEditable;this.checkUpdate(true);return V.addChangeToVariant({reference:this.sFlexReference,change:o,vmReference:p,vReference:v});};n.prototype.removeChange=function(o){var v=o.getVariantReference();var p=this.getVariantManagementReference(v).variantManagementReference;return V.removeChangeFromVariant({reference:this.sFlexReference,change:o,vmReference:p,vReference:v});};n.prototype._getVariantTitleCount=function(N,v){var D=this.getData();return D[v].variants.reduce(function(o,p){if(N.toLowerCase()===p.title.toLowerCase()&&p.visible){o++;}return o;},0);};n.prototype._duplicateVariant=function(p){var N=p.newVariantReference;var o=p.sourceVariantReference;var v=p.variantManagementReference;var q=this.getVariant(o);var t=V.getVariantChanges({vmReference:v,vReference:o,changeInstance:true,reference:this.sFlexReference}).map(function(y){return y.getDefinition();});var D={content:{},controlChanges:t,variantChanges:{}};var u=b.compareAgainstCurrentLayer(q.content.layer,!this._bDesignTimeMode?L.USER:"");Object.keys(q.content).forEach(function(K){if(K==="fileName"){D.content[K]=N;}else if(K==="variantReference"){if(u===0){D.content[K]=q.content["variantReference"];}else if(u===-1){D.content[K]=o;}}else if(K==="content"){D.content[K]=JSON.parse(JSON.stringify(q.content[K]));D.content.content.title=p.title;}else{D.content[K]=q.content[K];}});D.content["layer"]=p.layer;t=D.controlChanges.slice();var w={};var x;D.controlChanges=t.reduce(function(y,z){if(b.compareAgainstCurrentLayer(z.layer,!this._bDesignTimeMode?L.USER:"")===0){w=m({},z);w.variantReference=D.content.fileName;if(!w.support){w.support={};}w.support.sourceChangeFileName=z.fileName;w.packageName="$TMP";x=C.createInitialFileContent(w);y.push(new C(x));}return y;}.bind(this),[]);return D;};n.prototype.copyVariant=function(p){var D=this._duplicateVariant(p);var v={key:D.content.fileName,layer:p.layer,title:D.content.content.title,originalTitle:D.content.content.title,originalExecuteOnSelect:D.content.content.executeOnSelect,favorite:true,originalFavorite:true,rename:true,change:true,remove:true,visible:true,originalVisible:true};var o=f.createVariant({appVersion:this.oFlexController.getAppVersion(),model:this,variantSpecificData:D});var q=[];[o].concat(o.getControlChanges()).forEach(function(t){q.push(this.oChangePersistence.addDirtyChange(t));}.bind(this));var I=V.addVariantToVariantManagement({variantData:m({},o.getDefinitionWithChanges(),{content:{content:{visible:v.visible,favorite:v.favorite}}}),reference:this.sFlexReference,vmReference:p.variantManagementReference});this.oData[p.variantManagementReference].variants.splice(I,0,v);return this.updateCurrentVariant(p.variantManagementReference,o.getId(),p.appComponent,true).then(function(){return q;});};n.prototype.removeVariant=function(p){var o=this.oChangePersistence.getDirtyChanges().filter(function(q){return(q.getVariantReference&&q.getVariantReference()===p.variant.getId())||q.getId()===p.variant.getId();});return this.updateCurrentVariant(p.variantManagementReference,p.sourceVariantReference,p.component).then(function(){var I=V.removeVariantFromVariantManagement({reference:this.sFlexReference,variant:p.variant,vmReference:p.variantManagementReference});this.oData[p.variantManagementReference].variants.splice(I,1);this.checkUpdate();o.forEach(function(q){this.oChangePersistence.deleteChange(q);}.bind(this));}.bind(this));};n.prototype.collectModelChanges=function(v,o){var D=this.getData()[v];var M=D.variants;var p=[];var P={};M.forEach(function(q){if(q.originalTitle!==q.title){P={variantReference:q.key,changeType:"setTitle",title:q.title,originalTitle:q.originalTitle,layer:o};p.push(P);}if(q.originalFavorite!==q.favorite){P={variantReference:q.key,changeType:"setFavorite",favorite:q.favorite,originalFavorite:q.originalFavorite,layer:o};p.push(P);}if(q.originalExecuteOnSelect!==q.executeOnSelect){P={variantReference:q.key,changeType:"setExecuteOnSelect",executeOnSelect:q.executeOnSelect,originalExecuteOnSelect:q.originalExecuteOnSelect,layer:o};p.push(P);}if(!q.visible&&q.originalVisible){P={variantReference:q.key,changeType:"setVisible",visible:false,layer:o};p.push(P);}});if(D.originalDefaultVariant!==D.defaultVariant){P={variantManagementReference:v,changeType:"setDefault",defaultVariant:D.defaultVariant,originalDefaultVariant:D.originalDefaultVariant,layer:o};p.push(P);}return p;};n.prototype.manageVariants=function(v,o,p,q){return new Promise(function(t){v.attachEventOnce("manage",{resolve:t,variantManagementReference:o,layer:p},this.fnManageClickRta,this);v.openManagementDialog(true,q);}.bind(this));};n.prototype.setVariantProperties=function(v,p,A){var o=-1;var q;var t=null;var D=this.getData();if(p.variantReference){o=this.getVariantManagementReference(p.variantReference).variantIndex;q=D[v].variants[o];}var N={};var u={};switch(p.changeType){case"setTitle":u.title=p.title;q.title=p.title;q.originalTitle=q.title;break;case"setFavorite":u.favorite=p.favorite;q.favorite=p.favorite;q.originalFavorite=q.favorite;break;case"setExecuteOnSelect":u.executeOnSelect=p.executeOnSelect;if(q){q.executeOnSelect=p.executeOnSelect;q.originalExecuteOnSelect=q.executeOnSelect;}break;case"setVisible":u.visible=p.visible;u.createdByReset=false;q.visible=p.visible;q.originalVisible=q.visible;break;case"setDefault":u.defaultVariant=p.defaultVariant;D[v].defaultVariant=p.defaultVariant;D[v].originalDefaultVariant=D[v].defaultVariant;var H=d.getStoredHashParams({model:this});if(H){if(D[v].defaultVariant!==D[v].currentVariant&&H.indexOf(D[v].currentVariant)===-1){d.update({parameters:H.concat(D[v].currentVariant),updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this});}else if(D[v].defaultVariant===D[v].currentVariant&&H.indexOf(D[v].currentVariant)>-1){H.splice(H.indexOf(D[v].currentVariant),1);d.update({parameters:H,updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this});}}if(!A&&D[v].currentVariant!==p.defaultVariant){this.updateCurrentVariant(v,p.defaultVariant,p.appComponent);}break;default:break;}var w=V.getContent(this.sFlexReference);if(o>-1){var x=V.setVariantData({variantData:u,vmReference:v,previousIndex:o,reference:this.sFlexReference});D[v].variants.splice(o,1);D[v].variants.splice(x,0,q);}else if(w[v]){w[v].defaultVariant=p.defaultVariant;}var y={vmReference:v,add:A,reference:this.sFlexReference};if(A===true){N.changeType=p.changeType;N.layer=p.layer;if(p.changeType==="setDefault"){N.fileType="ctrl_variant_management_change";N.selector=a.getSelector(v,p.appComponent);}else{if(p.changeType==="setTitle"){c.setTextInChange(N,"title",p.title,"XFLD");}N.fileType="ctrl_variant_change";N.selector=a.getSelector(p.variantReference,p.appComponent);}t=this.oFlexController.createBaseChange(N,p.appComponent);t.setContent(u);y.changeContent=t.getDefinition();V.updateChangesForVariantManagementInMap(y);this.oChangePersistence.addDirtyChange(t);}else if(p.change){y.changeContent=p.change.getDefinition();V.updateChangesForVariantManagementInMap(y);this.oChangePersistence.deleteChange(p.change);}this.setData(D);this.checkUpdate(true);return t;};n.prototype._ensureStandardVariantExists=function(v){var D=this.getData();if(!D[v]){D[v]={currentVariant:v,originalCurrentVariant:v,defaultVariant:v,originalDefaultVariant:v,variants:[{key:v,title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),originalTitle:this._oResourceBundle.getText("STANDARD_VARIANT_ORIGINAL_TITLE"),favorite:true,originalFavorite:true,executeOnSelect:false,originalExecuteOnSelect:false,visible:true,originalVisible:true,author:f.DEFAULT_AUTHOR}]};this.setData(D);var o={};o[v]={defaultVariant:v,variantManagementChanges:{},variants:[{content:{fileName:v,fileType:"ctrl_variant",variantManagementReference:v,variantReference:"",support:{user:f.DEFAULT_AUTHOR},content:{title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),favorite:true,visible:true,executeOnSelect:false}},controlChanges:[],variantChanges:{}}]};try{var p=V.getContent(this.sFlexReference);m(p,o);}catch(E){g.error("Variants Map was not found: "+E.message);}}};n.prototype.setModelPropertiesForControl=function(v,D,o){this.oData[v].modified=false;this.oData[v].showFavorites=true;var p=this._bDesignTimeMode;if(p!==D){this._bDesignTimeMode=D;if(D){d.clearAllVariantURLParameters({model:this});}else if(p){d.update({parameters:d.getStoredHashParams({model:this}),updateURL:true,updateHashEntry:false,model:this});}}if(!(typeof this.fnManageClick==="function"&&typeof this.fnManageClickRta==="function")){this._initializeManageVariantsEvents();}o.detachManage(this.fnManageClick,this);if(D){this.oData[v].variantsEditable=false;this.oData[v].variants.forEach(function(q){q.rename=true;q.change=true;q.remove=l(q,v,D);});}else if(this.oData[v]._isEditable){o.attachManage({variantManagementReference:v},this.fnManageClick,this);this.oData[v].variantsEditable=true;this.oData[v].variants.forEach(function(q){q.remove=l(q,v,D);if(q.layer===b.getCurrentLayer(true)){q.rename=true;q.change=true;}else{q.rename=false;q.change=false;}});}else{this.oData[v].variantsEditable=false;this.oData[v].variants.forEach(function(q){q.remove=false;q.rename=false;q.change=false;});}};n.prototype._initializeManageVariantsEvents=function(){this.fnManageClickRta=function(E,D){var o=this.collectModelChanges(D.variantManagementReference,D.layer);D.resolve(o);};this.fnManageClick=function(E,D){if(!this.oFlexController||!V.getContent(this.sFlexReference)){return;}var o=this.collectModelChanges(D.variantManagementReference,b.getCurrentLayer(true));o.forEach(function(p){p.appComponent=this.oAppComponent;this.setVariantProperties(D.variantManagementReference,p,true);}.bind(this));this.oChangePersistence.saveDirtyChanges();};};n.prototype._handleSave=function(E){var v=E.getSource();var A=U.getAppComponentForControl(v);var o=this.getLocalId(v.getId(),A);return k(function(p,A,P){var q=P.def;var t=P.execute;var u=this.getCurrentVariantReference(p);var w=V.getVariantChanges({reference:this.sFlexReference,vmReference:p,vReference:u,changeInstance:true});if(P["overwrite"]){return this.oFlexController.saveSequenceOfDirtyChanges(this._getDirtyChangesFromVariantChanges(w)).then(function(y){this.checkDirtyStateForControlModels([p]);return y;}.bind(this));}var N=U.createDefaultFileName();var x={variantManagementReference:p,appComponent:A,layer:b.getCurrentLayer(true),title:P["name"],sourceVariantReference:u,newVariantReference:N};return this.copyVariant(x).then(function(y){if(q){var z={changeType:"setDefault",defaultVariant:N,originalDefaultVariant:this.oData[p].defaultVariant,appComponent:A,layer:b.getCurrentLayer(true),variantManagementReference:p};var D=this.setVariantProperties(p,z,true);y.push(D);}if(t){var G={changeType:"setExecuteOnSelect",executeOnSelect:true,variantReference:N,appComponent:A,layer:b.getCurrentLayer(true),variantManagementReference:p};var H=this.setVariantProperties(p,G,true);y.push(H);}this.oData[p].modified=false;this.checkUpdate(true);return h({changes:w,vmReference:p,vReference:u,model:this}).then(this.oFlexController.saveSequenceOfDirtyChanges.bind(this.oFlexController,y));}.bind(this));}.bind(this,o,A,E.getParameters()),this,o);};n.prototype.getLocalId=function(I,A){return a.getSelector(I,A).id;};n.prototype.getVariantManagementReferenceForControl=function(v){var o=v.getId();var A=U.getAppComponentForControl(v);return(A&&A.getLocalId(o))||o;};n.prototype.switchToDefaultForVariantManagement=function(v){if(this.oData[v].currentVariant!==this.oData[v].defaultVariant){B.show(200);this.updateCurrentVariant(v,this.oData[v].defaultVariant).then(function(){B.hide();});}};n.prototype.switchToDefaultForVariant=function(v){Object.keys(this.oData).forEach(function(o){if(!v||this.oData[o].currentVariant===v){this.switchToDefaultForVariantManagement(o);}}.bind(this));};n.prototype.registerToModel=function(v){var o=this.getVariantManagementReferenceForControl(v);this._ensureStandardVariantExists(o);this.oData[o]._isEditable=v.getEditable();v.attachEvent("select",{vmReference:o,model:this},_);v.attachSave(this._handleSave,this);this.setModelPropertiesForControl(o,false,v);var u=v.getUpdateVariantInURL();this.oData[o].updateVariantInURL=u;d.registerControl({vmReference:o,updateURL:!!u,model:this});d.handleModelContextChange({model:this,vmControl:v});if(this.oData[o].initPromise){this.oData[o].initPromise.resolveFunction();delete this.oData[o].initPromise;}this.oData[o].init=true;};n.prototype.waitForVMControlInit=function(v){if(this.oData[v].init){return Promise.resolve();}this.oData[v].initPromise={};this.oData[v].initPromise.promise=new Promise(function(o){this.oData[v].initPromise.resolveFunction=o;}.bind(this));return this.oData[v].initPromise.promise;};n.prototype._getDirtyChangesFromVariantChanges=function(o){var p=o.map(function(q){return q.getDefinition().fileName;});return this.oChangePersistence.getDirtyChanges().filter(function(q){return i(p,q.getId());});};n.prototype.checkDirtyStateForControlModels=function(v){v.forEach(function(o){var p=this.oData[o];if(p.modified===true){var q=this.getCurrentVariantReference(o);var t=V.getVariantChanges({reference:this.sFlexReference,vmReference:o,vReference:q,changeInstance:true});var D=this._getDirtyChangesFromVariantChanges(t);if(D.length===0){p.modified=false;}}}.bind(this));this.checkUpdate(true);};n.prototype.getCurrentControlVariantIds=function(){return Object.keys(this.oData||{}).reduce(function(o,v){return o.concat([this.oData[v].currentVariant]);}.bind(this),[]);};n.prototype.resetMap=function(){var v=Object.keys(this.oData);v.forEach(function(o){var p={vmReference:o,currentVReference:this.oData[o].currentVariant||this.oData[o].defaultVariant,newVReference:true,appComponent:this.oAppComponent,flexController:this.oFlexController,modifier:a,reference:this.sFlexReference};return k(r.bind(this,p),this,o);}.bind(this));return this._oVariantSwitchPromise.then(function(){V.resetContent(this.sFlexReference);d.initialize({model:this});d.update({parameters:[],updateHashEntry:true,model:this});}.bind(this));};return n;},true);
