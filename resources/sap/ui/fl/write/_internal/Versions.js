/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Storage","sap/ui/fl/Utils"],function(C,S,U){"use strict";var _={};function a(p){var o=C.getChangePersistenceForComponent(p.nonNormalizedReference,p.appVersion);var d=o.getDirtyChanges().concat();d.forEach(function(e){o.deleteChange(e,true);});return d.length>0;}function b(v){return v.some(function(o){return o.versionNumber===0;});}function c(v,o){if(b(v)){v.shift();}v.splice(0,0,o);return v;}var V={};V.initialize=function(p){var r=p.reference;var l=p.layer;if(_[r]&&_[r][l]){return Promise.resolve(_[r][l]);}return S.versions.load(p).then(function(v){_[r]=_[r]||{};_[r][l]=v;return _[r][l];});};V.getVersions=function(p){var r=p.reference;var l=p.layer;if(!_[r]||!_[r][l]){throw Error("Versions for reference '"+r+"' and layer '"+l+"' were not initialized.");}return _[r][l];};V.clearInstances=function(){_={};};V.ensureDraftVersionExists=function(p){var r=U.normalizeReference(p.reference);var v=_[r][p.layer];if(!b(v)){_[r][p.layer].splice(0,0,{versionNumber:0});}};V.activateDraft=function(p){var v=V.getVersions(p);var d=b(v);var o=C.getChangePersistenceForComponent(p.nonNormalizedReference,p.appVersion);var D=o.getDirtyChanges().length>0;var s;if(D){s=o.saveDirtyChanges(false,undefined,true);}else{s=Promise.resolve();}if(!d&&!D){return Promise.reject("No draft exists");}return s.then(S.versions.activate.bind(undefined,p)).then(function(e){return c(v,e);});};V.discardDraft=function(p){var v=V.getVersions(p);if(b(v)){return S.versions.discardDraft(p).then(function(){v.shift();a(p);return true;});}var d=a(p);return Promise.resolve(d);};return V;});
