/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Core","sap/ui/core/Control","sap/ui/integration/util/Manifest","sap/ui/integration/util/ServiceManager","sap/base/Log","sap/ui/integration/util/DataProviderFactory","sap/ui/integration/cards/BaseContent","sap/m/HBox","sap/m/VBox","sap/ui/core/Icon","sap/m/Text","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/base/util/LoaderExtensions","sap/f/CardRenderer","sap/f/library","sap/ui/integration/library","sap/ui/core/InvisibleText","sap/ui/integration/util/Destinations","sap/ui/integration/util/LoadingProvider","sap/ui/integration/util/HeaderFactory","sap/ui/integration/util/ContentFactory","sap/ui/integration/formatters/IconFormatter"],function(q,C,a,b,S,L,D,B,H,V,I,T,J,R,c,d,l,e,f,g,h,i,j,k){"use strict";var M={TYPE:"/sap.card/type",DATA:"/sap.card/data",HEADER:"/sap.card/header",HEADER_POSITION:"/sap.card/headerPosition",CONTENT:"/sap.card/content",SERVICES:"/sap.ui5/services",APP_TYPE:"/sap.app/type",PARAMS:"/sap.card/configuration/parameters",DESTINATIONS:"/sap.card/configuration/destinations"};var m=l.cards.HeaderPosition;var n=e.CardDataMode;var o=a.extend("sap.ui.integration.widgets.Card",{metadata:{library:"sap.ui.integration",interfaces:["sap.f.ICard"],properties:{manifest:{type:"any",defaultValue:""},parameters:{type:"object",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"auto"},dataMode:{type:"sap.ui.integration.CardDataMode",group:"Behavior",defaultValue:n.Active},baseUrl:{type:"sap.ui.core.URI",defaultValue:null},manifestChanges:{type:"object[]"}},aggregations:{_header:{type:"sap.f.cards.IHeader",multiple:false,visibility:"hidden"},_content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},events:{action:{allowPreventDefault:true,parameters:{actionSource:{type:"sap.ui.core.Control"},manifestParameters:{type:"object"},parameters:{type:"object"},type:{type:"sap.ui.integration.CardActionType"}}},manifestReady:{parameters:{}}},associations:{hostConfigurationId:{},host:{}}},renderer:d});o.prototype.init=function(){this._ariaText=new f({id:this.getId()+"-ariaText"});this._oRb=C.getLibraryResourceBundle("sap.f");this.setModel(new J(),"parameters");this._busyStates=new Map();};o.prototype._initReadyState=function(){this._aReadyPromises=[];this._awaitEvent("_headerReady");this._awaitEvent("_contentReady");this._awaitEvent("_cardReady");Promise.all(this._aReadyPromises).then(function(){this._bReady=true;this.fireEvent("_ready");}.bind(this));};o.prototype._clearReadyState=function(){this._bReady=false;this._aReadyPromises=[];};o.prototype.onBeforeRendering=function(){var s=this.getHostConfigurationId();if(this.getDataMode()!==n.Active){return;}if(s){this.addStyleClass(s.replace(/-/g,"_"));}if(this._bApplyManifest){this._bApplyManifest=false;var v=this.getManifest();this._clearReadyState();this._initReadyState();if(!v){this.destroyManifest();}else{this.createManifest(v,this.getBaseUrl());}}};o.prototype.setManifest=function(v){this.setProperty("manifest",v);this._bApplyManifest=true;return this;};o.prototype.setManifestChanges=function(v){this.setProperty("manifestChanges",v);this._bApplyManifest=true;return this;};o.prototype.setParameters=function(v){this.setProperty("parameters",v);this._bApplyManifest=true;return this;};o.prototype.setHost=function(v){this.setAssociation("host",v);if(this._oDestinations){this._oDestinations.setHost(this.getHostInstance());}return this;};o.prototype.createManifest=function(v,s){var O={};this._isManifestReady=false;if(typeof v==="string"){O.manifestUrl=v;v=null;}if(this._oCardManifest){this._oCardManifest.destroy();}this._oCardManifest=new b("sap.card",v,s,this.getManifestChanges());this._oCardManifest.load(O).then(function(){this._isManifestReady=true;this.fireManifestReady();this._applyManifest();}.bind(this)).catch(this._applyManifest.bind(this));};o.prototype._applyManifest=function(){var p=this.getParameters(),r=this._oCardManifest;this._registerManifestModulePath();if(r&&r.getResourceBundle()){this._enhanceI18nModel(r.getResourceBundle());}r.processParameters(p);this._applyManifestSettings();};o.prototype._loadDefaultTranslations=function(){var r=C.getLibraryResourceBundle("sap.ui.integration");this._enhanceI18nModel(r);};o.prototype._enhanceI18nModel=function(r){var p=this.getModel("i18n");if(p){p.enhance(r);return;}p=new R({bundle:r});this.setModel(p,"i18n");};o.prototype._awaitEvent=function(E){this._aReadyPromises.push(new Promise(function(r){this.attachEventOnce(E,function(){r();});}.bind(this)));};o.prototype.isReady=function(){return this._bReady;};o.prototype.refresh=function(){if(this.getDataMode()===n.Active){this._clearReadyState();this._initReadyState();this.destroyManifest();this._bApplyManifest=true;this.invalidate();}};o.prototype.exit=function(){this.destroyManifest();this._busyStates=null;this._oRb=null;if(this._ariaText){this._ariaText.destroy();this._ariaText=null;}};o.prototype.destroyManifest=function(){if(this._oCardManifest){this._oCardManifest.destroy();this._oCardManifest=null;}if(this._oServiceManager){this._oServiceManager.destroy();this._oServiceManager=null;}if(this._oDataProviderFactory){this._oDataProviderFactory.destroy();this._oDataProviderFactory=null;this._oDataProvider=null;}if(this._oLoadingProvider){this._oLoadingProvider.destroy();this._oLoadingProvider=null;}if(this._oTemporaryContent){this._oTemporaryContent.destroy();this._oTemporaryContent=null;}if(this._oDestinations){this._oDestinations.destroy();this._oDestinations=null;}if(this._oIconFormatter){this._oIconFormatter.destroy();this._oIconFormatter=null;}this.destroyAggregation("_header");this.destroyAggregation("_content");this._aReadyPromises=null;this._busyStates.clear();};o.prototype._registerManifestModulePath=function(){if(!this._oCardManifest){return;}this._sAppId=this._oCardManifest.get("/sap.app/id");if(this._sAppId){c.registerResourcePath(this._sAppId.replace(/\./g,"/"),this._oCardManifest.getUrl());}else{L.error("Card sap.app/id entry in the manifest is mandatory");}};o.prototype.getManifest=function(){var v=this.getProperty("manifest");if(v&&typeof v==="object"){return q.extend(true,{},v);}return v;};o.prototype.getParameters=function(){var v=this.getProperty("parameters");if(v&&typeof v==="object"){return q.extend(true,{},v);}return v;};o.prototype.getCombinedParameters=function(){if(!this._isManifestReady){L.error("The manifest is not ready. Consider using the 'manifestReady' event.","sap.ui.integration.widgets.Card");return null;}var p=this._oCardManifest.getProcessedParameters(this.getProperty("parameters")),r={},K;for(K in p){r[K]=p[K].value;}return r;};o.prototype.getManifestEntry=function(p){if(!this._isManifestReady){L.error("The manifest is not ready. Consider using the 'manifestReady' event.","sap.ui.integration.widgets.Card");return null;}return this._oCardManifest.get(p);};o.prototype.getManifestWithMergedChanges=function(){if(!this._oCardManifest||!this._oCardManifest._oManifest){L.error("The manifest is not ready. Consider using the 'manifestReady' event.","sap.ui.integration.widgets.Card");return{};}return q.extend(true,{},this._oCardManifest._oManifest.getRawJson());};o.prototype.resolveDestination=function(K){return this._oDestinations.getUrl(K);};o.prototype._applyManifestSettings=function(){var A=this._oCardManifest.get(M.APP_TYPE);if(A&&A!=="card"){L.error("sap.app/type entry in manifest is not 'card'");}if(this._oDataProviderFactory){this._oDataProviderFactory.destroy();}this._oDestinations=new g(this.getHostInstance(),this._oCardManifest.get(M.DESTINATIONS));this._oIconFormatter=new k(this._oDestinations);this._oDataProviderFactory=new D(this._oDestinations);this._oLoadingProvider=new h();this._applyServiceManifestSettings();this._applyDataManifestSettings();this._applyHeaderManifestSettings();this._applyContentManifestSettings();};o.prototype._applyDataManifestSettings=function(){var p=this._oCardManifest.get(M.DATA);if(!p){this.fireEvent("_cardReady");return;}if(this._oDataProvider){this._oDataProvider.destroy();}this._oDataProvider=this._oDataProviderFactory.create(p,this._oServiceManager);this._oLoadingProvider.createLoadingState(this._oDataProvider);if(this._oDataProvider){this.setModel(new J());this._oDataProvider.attachDataChanged(function(E){this.getModel().setData(E.getParameter("data"));if(this._createContentPromise){this._createContentPromise.then(function(r){r.onDataChanged();});}}.bind(this));this._oDataProvider.attachError(function(E){this._handleError("Data service unavailable. "+E.getParameter("message"));}.bind(this));this._oDataProvider.triggerDataUpdate().then(function(){this.fireEvent("_cardReady");this._handleCardLoading();}.bind(this));}};o.prototype._handleCardLoading=function(){var p=this.getCardContent();if(p&&!p.hasStyleClass("sapFCardErrorContent")&&p._oLoadingPlaceholder){var r=p.getAggregation("_content");if(r){r.removeStyleClass("sapFCardContentHidden");}p._oLoadingPlaceholder.destroy();}if(this._oLoadingProvider){this._oLoadingProvider.removeHeaderPlaceholder(this.getCardHeader());}this._oLoadingProvider.setLoading(false);};o.prototype._applyServiceManifestSettings=function(){var s=this._oCardManifest.get(M.SERVICES);if(!s){return;}if(!this._oServiceManager){this._oServiceManager=new S(s,this);}};o.prototype.getCardHeader=function(){return this.getAggregation("_header");};o.prototype.getCardHeaderPosition=function(){if(!this._oCardManifest){return"Top";}return this._oCardManifest.get(M.HEADER_POSITION)||m.Top;};o.prototype.getCardContent=function(){return this.getAggregation("_content");};o.prototype._applyHeaderManifestSettings=function(){var p=this.createHeader();if(!p){this.fireEvent("_headerReady");return;}this.destroyAggregation("_header");this.setAggregation("_header",p);if(p.isReady()){this.fireEvent("_headerReady");}else{p.attachEvent("_ready",function(){this.fireEvent("_headerReady");}.bind(this));}};o.prototype.getHostInstance=function(){var s=this.getHost();if(!s){return null;}return C.byId(s);};o.prototype._applyContentManifestSettings=function(){var s=this._oCardManifest.get(M.TYPE),p=this.getContentManifest(),A=s+" "+this._oRb.getText("ARIA_ROLEDESCRIPTION_CARD");this._ariaText.setText(A);if(!p){this.fireEvent("_contentReady");return;}this._setTemporaryContent(s,p);this._createContentPromise=this.createContent({cardType:s,contentManifest:p,serviceManager:this._oServiceManager,dataProviderFactory:this._oDataProviderFactory,iconFormatter:this._oIconFormatter,appId:this._sAppId}).then(function(r){this._setCardContent(r);return r;}.bind(this));this._createContentPromise.catch(function(E){if(E){this._handleError(E);}}.bind(this));};o.prototype.createHeader=function(){var p=this._oCardManifest.get(M.HEADER),r=new i(this);return r.create(p);};o.prototype.getContentManifest=function(){var s=this._oCardManifest.get(M.TYPE),p=s&&s.toLowerCase()==="component",r=this._oCardManifest.get(M.CONTENT),t=!!r;if(t&&!s){L.error("Card type property is mandatory!");return null;}if(!t&&!p){return null;}if(!r&&p){r=this._oCardManifest.getJson();}return r;};o.prototype.createContent=function(p){var r=new j(this);p.cardManifest=this._oCardManifest;return r.create(p);};o.prototype.onAfterRendering=function(){var s;if(this._oCardManifest&&this._oCardManifest.get(M.TYPE)){s=this._oCardManifest.get(M.TYPE).toLowerCase();}if(s==="analytical"){this.$().addClass("sapFCardAnalytical");}};o.prototype._setCardContent=function(p){p.attachEvent("_error",function(E){this._handleError(E.getParameter("logMessage"),E.getParameter("displayMessage"));}.bind(this));var P=this.getAggregation("_content");if(P&&P!==this._oTemporaryContent){P.destroy();}this.setAggregation("_content",p);if(p.isReady()){this.fireEvent("_contentReady");}else{p.attachEvent("_ready",function(){this.fireEvent("_contentReady");}.bind(this));}};o.prototype._setTemporaryContent=function(s,p){var t=this._getTemporaryContent(s,p),P=this.getAggregation("_content");if(P&&P!==t){P.destroy();}this.setAggregation("_content",t);};o.prototype._handleError=function(s,p){L.error(s);this.fireEvent("_error",{message:s});var r="Unable to load the data.",E=p||r,P=this.getAggregation("_content");var t=new H({justifyContent:"Center",alignItems:"Center",items:[new I({src:"sap-icon://message-error",size:"1rem"}).addStyleClass("sapUiTinyMargin"),new T({text:E})]}).addStyleClass("sapFCardErrorContent");if(P&&!P.hasStyleClass("sapFCardErrorContent")){P.destroy();this.fireEvent("_contentReady");}t.addEventDelegate({onAfterRendering:function(){if(!this._oCardManifest){return;}var u=this._oCardManifest.get(M.TYPE)+"Content",v=this._oCardManifest.get(M.CONTENT),w=B.getMinHeight(u,v,t);if(this.getHeight()==="auto"){t.$().css({"min-height":w});}}},this);this.setAggregation("_content",t);};o.prototype._getTemporaryContent=function(s,p){if(!this._oTemporaryContent&&this._oLoadingProvider){this._oTemporaryContent=this._oLoadingProvider.createContentPlaceholder(p,s);this._oTemporaryContent.addEventDelegate({onAfterRendering:function(){if(!this._oCardManifest){return;}var t=this._oCardManifest.get(M.TYPE)+"Content",r=this._oCardManifest.get(M.CONTENT),u=B.getMinHeight(t,r,this._oTemporaryContent);if(this.getHeight()==="auto"){this._oTemporaryContent.$().css({"min-height":u});}}},this);}return this._oTemporaryContent;};o.prototype.setDataMode=function(s){if(this._oDataProviderFactory&&s===n.Inactive){this._oDataProviderFactory.destroy();this._oDataProviderFactory=null;}this.setProperty("dataMode",s,true);if(this.getProperty("dataMode")===n.Active){this.refresh();}return this;};o.prototype.loadDesigntime=function(){if(!this._oCardManifest){return Promise.reject("Manifest not yet available");}var A=this._oCardManifest.get("/sap.app/id");if(!A){return Promise.reject("App id not maintained");}var s=A.replace(/\./g,"/");return new Promise(function(r,p){var t=s+"/"+(this._oCardManifest.get("/sap.card/designtime")||"designtime/Card.designtime");if(t){sap.ui.require([t,"sap/base/util/deepClone"],function(u,v){r({designtime:u,manifest:v(this._oCardManifest._oManifest.getRawJson(),30)});}.bind(this),function(){p({error:t+" not found"});});}else{p();}}.bind(this));};o.prototype.isLoading=function(){return this._oLoadingProvider?this._oLoadingProvider.getLoadingState():false;};o.prototype.getFocusDomRef=function(){return this.getCardHeader()?this.getCardHeader().getDomRef():this.getDomRef();};return o;});
