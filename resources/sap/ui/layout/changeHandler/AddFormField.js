/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/ui/fl/changeHandler/ChangeHandlerMediator","sap/base/Log","sap/base/util/merge","sap/base/util/ObjectPath"],function(B,C,L,m,O){"use strict";function g(f){return O.get("content.createFunction",f);}function c(o,f){var h=o.content;if(h){return o.content.newFieldSelector&&(o.content.newFieldIndex!==undefined)&&o.content.bindingPath&&o.content.oDataServiceVersion&&!!g(f);}return false;}function a(f){return f+"-field";}function b(D,o){var f=m({},D);f.fieldSelector.id=a(f.fieldSelector.id);return o.createControlForProperty(f).then(function(s){var n=D.modifier.getId(s.control);D.labelFor=n;return o.createLabel(D).then(function(l){return{label:l,control:s.control,valueHelp:s.valueHelp};});});}function d(D,p){var f=m({aggregationName:"formElements",payload:D.payload},p);var o;return new Promise(function(r){sap.ui.require([D.name],r);}).then(function(h){o=h;}).then(function(){if(o.createLayout){return o.createLayout(f);}}).then(function(l){if(O.get("control",l)){l.layoutControl=true;return l;}return b(f,o);});}function e(o,p){var f=m({},p);f.fieldSelector.id=a(f.fieldSelector.id);return C.getChangeHandlerSettings({"scenario":"addODataFieldWithLabel","oDataServiceVersion":o.content&&o.content.oDataServiceVersion}).then(function(h){if(c(o,h)){var i=g(h);return i(f.modifier,f);}else{L.error("Change does not contain sufficient information to be applied or ChangeHandlerMediator could not be retrieved: ["+o.layer+"]"+o.namespace+"/"+o.fileName+"."+o.fileType);}});}var A={};A.applyChange=function(o,f,p){var h=o.getDefinition();var v=p.view;var i=h.content.newFieldIndex;var j=p.appComponent;var k=h.content;var F=k.newFieldSelector;var s=k.bindingPath;var l={appComponent:p.appComponent,view:p.view,fieldSelector:F,bindingPath:s,modifier:p.modifier,element:f};if(p.modifier.bySelector(F,j)){return B.markAsNotApplicable("Control to be created already exists:"+F);}var r={newFieldSelector:F};var D=p.modifier.getFlexDelegate(f);var w=D?d(D,l):e(h,l);return w.then(function(I){var n;if(!I.layoutControl){n=p.modifier.createControl("sap.ui.layout.form.FormElement",j,v,F);p.modifier.insertAggregation(n,"label",I.label,0,v);p.modifier.insertAggregation(n,"fields",I.control,0,v);}else{n=I.control;}var P=o.getDependentControl("parentFormContainer",p);p.modifier.insertAggregation(P,"formElements",n,i,v);if(I.valueHelp){p.modifier.insertAggregation(P,"dependents",I.valueHelp,0,v);var V=p.modifier.getSelector(p.modifier.getId(I.valueHelp),j);r.valueHelpSelector=V;}o.setRevertData(r);return true;});};A.completeChangeContent=function(o,s,p){var f=p.appComponent;var h=o.getDefinition();if(!h.content){h.content={};}if(s.parentId){o.addDependentControl(s.parentId,"parentFormContainer",p);}else{throw new Error("oSpecificChangeInfo.parentId attribute required");}if(s.bindingPath){h.content.bindingPath=s.bindingPath;}else{throw new Error("oSpecificChangeInfo.bindingPath attribute required");}if(s.newControlId){h.content.newFieldSelector=p.modifier.getSelector(s.newControlId,f);}else{throw new Error("oSpecificChangeInfo.newControlId attribute required");}if(s.index===undefined){throw new Error("oSpecificChangeInfo.targetIndex attribute required");}else{h.content.newFieldIndex=s.index;}if(s.oDataServiceVersion){h.content.oDataServiceVersion=s.oDataServiceVersion;}};A.revertChange=function(o,f,p){var h=p.appComponent;var v=p.view;var M=p.modifier;var F=o.getRevertData().newFieldSelector;var V=o.getRevertData().valueHelpSelector;var i=M.bySelector(F,h,v);var P=o.getDependentControl("parentFormContainer",p);M.removeAggregation(P,"formElements",i);M.destroy(i);if(V){var j=M.bySelector(V,h,v);M.removeAggregation(P,"dependents",j);M.destroy(j);}o.resetRevertData();return true;};return A;},true);
