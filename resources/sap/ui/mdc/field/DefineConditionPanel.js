/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/XMLComposite','sap/ui/model/Filter','sap/ui/model/type/String','sap/ui/base/ManagedObjectObserver','sap/m/FlexItemData','sap/base/util/merge','sap/base/util/deepEqual','sap/ui/mdc/library','sap/ui/mdc/condition/Condition','sap/ui/mdc/condition/FilterOperatorUtil','sap/ui/mdc/condition/Operator','sap/ui/mdc/util/BaseType','sap/ui/mdc/util/ConditionValidated','sap/ui/mdc/Field'],function(X,F,S,M,a,m,d,l,C,b,O,B,c,e){"use strict";var E=l.EditMode;var f=l.FieldDisplay;var o=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");sap.ui.getCore().attachLocalizationChanged(function(){o=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");});var D=X.extend("sap.ui.mdc.field.DefineConditionPanel",{metadata:{properties:{conditions:{type:"object[]",group:"Data",defaultValue:[],byValue:true},formatOptions:{type:"object",defaultValue:{}}},events:{}},fragment:"sap.ui.mdc.field.DefineConditionPanel",init:function(){sap.ui.getCore().getMessageManager().registerObject(this,true);this._oObserver=new M(_.bind(this));this._oObserver.observe(this,{properties:["conditions","formatOptions"]});var v=this.byId("defineCondition");this._oObserver.observe(v,{aggregations:["content"]});},exit:function(){sap.ui.getCore().getMessageManager().unregisterObject(this,true);this._oObserver.disconnect();this._oObserver=undefined;if(this._oDefaultType){this._oDefaultType.destroy();delete this._oDefaultType;}},onBeforeRendering:function(){if(!this.oOperatorModel){this.oOperatorModel=new sap.ui.model.json.JSONModel();this.setModel(this.oOperatorModel,"om");}p.call(this);if(this.getConditions().length===0){this.updateDefineConditions();this._updateButtonVisibility();}},_updateButtonVisibility:function(v){var V=this.byId("defineCondition");if(!V){return;}var R=V.getContent();var w=this.getFormatOptions();var x=w.maxConditions;for(var i=0;i<R.length;i++){var y=R[i];var H=y.getContent()[2];var z=H.getItems()[1];z.setVisible((i===R.length-1)&&(x==-1||i<x-1));}},removeCondition:function(i){var v=i.oSource;var w=v.getBindingContext("$this").getObject();var x=this.getConditions();var I=b.indexOfCondition(w,x);this._bUpdateConditionsInternal=true;x.splice(I,1);this.setProperty("conditions",x,true);this.updateDefineConditions();this._updateButtonVisibility();this.invalidate();},addCondition:function(i){var v=i.oSource;var w=v.getBindingContext("$this").getObject();var x=this.getConditions();var I=b.indexOfCondition(w,x);var y=this.getFormatOptions();var z=y.maxConditions;if(z==-1||x.length<z){this._bUpdateConditionsInternal=true;this.addDummyCondition(I+1);}},addDummyCondition:function(i){var v=n.call(this);var w=v.indexOf("EQ")>=0?"EQ":v[0];var x=C.createCondition(w,[null],undefined,undefined,c.NotValidated);b.updateConditionValues(x);b.checkConditionsEmpty(x,v);var y=this.getConditions();if(i!==undefined){y.splice(i,0,x);}else{y.push(x);}this.setProperty("conditions",y,true);this._updateButtonVisibility();},updateDefineConditions:function(){var i=this.getConditions().filter(function(v){return v.validated!==c.Validated;});u.call(this,i,true,false);if(i.length===0){this._bUpdateConditionsInternal=true;this.addDummyCondition();}},valueCtrlFactory:function(i,v){var w=v.oModel;var P=v.sPath;var x=parseInt(P.split("/")[P.split("/").length-1]);P=P.slice(0,P.lastIndexOf("/"));P=P.slice(0,P.lastIndexOf("/"));var y=w.getProperty(P);var z=b.getOperator(y.operator);var A=q.call(this);if(!z){return;}var V=k.call(this,A,z,"$this>",x);V.addStyleClass("sapUiSmallPaddingBegin");V.setLayoutData(new a({shrinkFactor:0,growFactor:1}));if(V.attachChange){V.attachChange(this.onChange.bind(this));V.onpaste=this.onPaste.bind(this);}var G=this.getConditions();u.call(this,G,true,false);return V;},onChange:function(i){var v=n.call(this);var w=this.getConditions();b.checkConditionsEmpty(w,v);b.updateConditionsValues(w,v);this.setProperty("conditions",w,true);},onSelectChange:function(i){var v=i.getSource();var K=v.getValue();var w=v._sOldKey;var x=b.getOperator(K);var y=w&&b.getOperator(w);if(y&&!d(x.valueTypes[0],y.valueTypes[0])&&x.valueTypes[0]!==O.ValueType.Static){var z=v.getBindingContext("$this").getObject();var A=this.getConditions();var I=b.indexOfCondition(z,A);if(I>=0){z=A[I];if(z.values.length>0&&z.values[0]!==null){z.values[0]=null;}if(z.values.length>1&&z.values[1]!==null){z.values[1]=null;}this._bUpdateConditionsInternal=true;this.setProperty("conditions",A,true);}}delete v._sOldKey;},onPaste:function(v){var w,x=v.srcControl;if(window.clipboardData){w=window.clipboardData.getData("Text");}else{w=v.originalEvent.clipboardData.getData('text/plain');}var y=w.split(/\r\n|\r|\n/g);if(y&&y.length>1){setTimeout(function(){var z=n.call(this);var T=q.call(this);var A=s.call(this,T);var L=y.length;var G=this.getConditions();for(var i=0;i<L;i++){if(y[i]){var V=y[i];var H=V.split(/\t/g);var I;if(H.length==2&&H[0]&&H[1]){I=b.getOperator("BT");}else{H=[V.trim()];I=b.getDefaultOperator(A);}V=I?I.format(C.createCondition(I.name,H)):H[0];if(I){var J=I.getCondition(V,T,f.Value,true);if(J){J.validated=c.NotValidated;b.checkConditionsEmpty(J,z);G.push(J);}}}}this.setProperty("conditions",G,true);if(x.setDOMValue){x.setDOMValue("");}}.bind(this),0);}}});function _(i){if(i.name==="content"&&i.mutation==="insert"){g.call(this,i.child);}if(i.name==="value"){j.call(this,i.object,i.current,i.old);}if(i.name==="formatOptions"){var v=this.getConditions();if(v.length>0){h.call(this);this.setConditions([]);this.setConditions(v);}var w=i.current&&i.current.operators;var x=i.old&&i.old.operators;if(!d(w,x)){p.call(this);}var T=i.current&&i.current.valueType&&i.current.valueType.getMetadata().getName();var y=i.old&&i.old.valueType&&i.old.valueType.getMetadata().getName();if(T!==y&&v.length>0){u.call(this,v,true,true);}}if(i.name==="conditions"){if(this._bUpdateConditionsInternal){this._bUpdateConditionsInternal=false;return;}if(this._sConditionsTimer){clearTimeout(this._sConditionsTimer);this._sConditionsTimer=null;}this._sConditionsTimer=setTimeout(function(){this._sConditionsTimer=null;this.updateDefineConditions();this._updateButtonVisibility();}.bind(this),0);}}function g(G){var i=G.getContent();var v=i[0];var H=i[1];var L=H.getBinding("items");L.suspend();this._oObserver.observe(v,{properties:["value"]});}function h(){var v=this.byId("defineCondition");var G=v.getContent();for(var i=0;i<G.length;i++){var w=G[i];var x=w.getContent();var H=x[1];var L=H.getBinding("items");L.resume();}}function j(i,K,v){var G=i.getParent();var w=G.getContent();var H=w[1];var L=H.getBinding("items");i._sOldKey=v;if(!K){var x=i.getBindingContext("$this").getObject();var y=this.getConditions();var I=b.indexOfCondition(x,y);if(I>=0){x=y[I];x.operator=v;this._bUpdateConditionsInternal=true;this.setProperty("conditions",y,true);}}this.onChange();L.checkUpdate(true);}function k(i,v,P,w){if(v.valueTypes[w]&&[O.ValueType.Self,O.ValueType.Static].indexOf(v.valueTypes[w])===-1){i=v._createLocalType(v.valueTypes[w]);}if(v.createControl){return v.createControl(i,v,P,w);}var x=false;if(v.valueTypes[w]===O.ValueType.Static){x=true;i=r.call(this);}var T=x?B.String:s.call(this,i);var N;var y;var z;var A;switch(T){case B.Boolean:if(i.oConstraints&&i.oConstraints.hasOwnProperty("nullable")&&i.oConstraints.nullable===false){y=sap.ui.require(i.getMetadata().getName().replace(/\./g,"/"));z=m({},i.oFormatOptions);A=m(i.oConstraints,{nullable:true});N=new y(z,A);}else{N=i;}break;case B.Numeric:if(i.oFormatOptions&&i.oFormatOptions.hasOwnProperty("emptyString")&&i.oFormatOptions.emptyString===null){N=i;}else{y=sap.ui.require(i.getMetadata().getName().replace(/\./g,"/"));z=m(i.oFormatOptions,{emptyString:null});N=new y(z,i.oConstraints);}break;case B.Date:case B.Time:case B.DateTime:N=i;break;default:N=i;break;}var G=new e({delegate:t.call(this),value:{path:P,type:N,mode:'TwoWay',targetType:'raw'},editMode:x?E.Display:E.Editable,width:"100%"});return G;}function n(){var i=this.getFormatOptions();var v=i&&i.operators;if(!v||v.length===0){v=b.getOperatorsForType(B.String);}return v;}function p(){if(!this.oOperatorModel){return;}var T=q.call(this);var v=n.call(this);var I=o.getText("valuehelp.INCLUDE");var w=o.getText("valuehelp.EXCLUDE");var x=[];for(var i=0;i<v.length;i++){var y=v[i];var z=b.getOperator(y);if(!z||(z.showInSuggest!==undefined&&z.showInSuggest==false)){continue;}var A=z.textKey||"operators."+z.name+".longText";var G=z.getTypeText(A,T.getName().toLowerCase());if(G===A){G=z.longText;}var H=z.additionalInfo;if(H===undefined){if(H!==""&&z.formatRange){H=z.formatRange(z._getRange(undefined,T),T);}else{H=z.exclude?w:I;}}x.push({key:z.name,additionalText:G,info:H});}this.oOperatorModel.setData(x);}function q(){var i=this.getFormatOptions();var T=i&&i.valueType;if(!T){T=r.call(this);}return T;}function r(){if(!this._oDefaultType){this._oDefaultType=new S();}return this._oDefaultType;}function s(T){var i=T.getMetadata().getName();var v=T.oFormatOptions;var w=T.oConstraints;var x=this.getFormatOptions().delegate;var P=this.getFormatOptions().payload;var y=x?x.getBaseType(P,i,v,w):B.String;if(y===B.Unit){y=B.Numeric;}return y;}function t(){var i=this.getFormatOptions();var N=i.delegateName||"sap/ui/mdc/field/FieldBaseDelegate";var P=i.payload;return{name:N,payload:P};}function u(v,U,T){var w=q.call(this);var x=[];var i=0;for(i=0;i<v.length;i++){var y=v[i];var z=b.getOperator(y.operator);if(z&&z.valueTypes[0]===O.ValueType.Static&&(y.values.length===0||T)){if(z.getStaticText){var A=z.getStaticText(w);if(y.values.length>0){y.values[0]=A;}else{y.values.push(A);}x.push(i);}}}if(x.length>0){this._bUpdateConditionsInternal=true;this.setProperty("conditions",v,true);if(U){var V=this.byId("defineCondition");var G=V.getContent();for(i=0;i<x.length;i++){var H=G[x[i]];var I=H.getContent();var J=I[1];var L=J.getBinding("items");L.checkUpdate(true);}}}}return D;});
