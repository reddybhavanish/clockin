/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/mdc/field/FieldValueHelpContentWrapperBase','sap/ui/model/ChangeReason','sap/ui/model/Filter','sap/ui/model/FormatException','sap/ui/model/ParseException','sap/ui/model/FilterType','sap/ui/base/ManagedObjectObserver','sap/base/strings/capitalize','sap/m/library','sap/base/util/deepEqual','sap/base/Log'],function(F,C,a,b,P,c,M,d,l,e,L){"use strict";var f=l.ListMode;var S=l.Sticky;var g;var h=F.extend("sap.ui.mdc.field.FieldValueHelpMTableWrapper",{metadata:{library:"sap.ui.mdc",aggregations:{table:{type:"sap.m.Table",multiple:false}},defaultAggregation:"table"}});h._init=function(){g=undefined;};h.prototype.init=function(){F.prototype.init.apply(this,arguments);this._oObserver=new M(n.bind(this));this._oObserver.observe(this,{properties:["selectedItems"],aggregations:["table"]});this._oTablePromise=new Promise(function(R){this._oTablePromiseResolve=R;}.bind(this));this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oPromises={};};h.prototype.exit=function(){F.prototype.exit.apply(this,arguments);if(this._oScrollContainer){this._oScrollContainer.destroy();delete this._oScrollContainer;}this._oObserver.disconnect();this._oObserver=undefined;delete this._oTablePromise;delete this._oTablePromiseResolve;};h.prototype.invalidate=function(O){if(O){var T=this.getTable();if(T&&O===T){if(O.bOutput&&!this._bIsBeingDestroyed){var i=this.getParent();if(i){i.invalidate(this);}}return;}}F.prototype.invalidate.apply(this,arguments);};h.prototype.initialize=function(i){if(i||this._oScrollContainer){return this;}if(!g&&!this._bScrollContainerRequested){g=sap.ui.require("sap/m/ScrollContainer");if(!g){sap.ui.require(["sap/m/ScrollContainer"],_.bind(this));this._bScrollContainerRequested=true;}}if(g&&!this._bScrollContainerRequested){this._oScrollContainer=new g(this.getId()+"-SC",{height:"100%",width:"100%",vertical:true});this._oScrollContainer._oWrapper=this;this._oScrollContainer.getContent=function(){var j=[];var T=this._oWrapper&&this._oWrapper.getTable();if(T){j.push(T);}return j;};}return this;};function _(i){g=i;this._bScrollContainerRequested=false;if(!this._bIsBeingDestroyed){this.initialize();this.fireDataUpdate({contentChange:true});}}h.prototype.getDialogContent=function(){return this._oScrollContainer;};h.prototype.getSuggestionContent=function(){return this.getTable();};h.prototype.fieldHelpOpen=function(i){F.prototype.fieldHelpOpen.apply(this,arguments);var T=this.getTable();if(T){q.call(this,T,i);v.call(this);if(i){var j=T.getSelectedItem();if(j&&j.getDomRef()){j.getDomRef().scrollIntoView();}}}return this;};h.prototype.navigate=function(i){var T=this.getTable();if(!y(T)){this._bNavigate=true;this._iStep=i;return;}if(this._getMaxConditions()!==1){T.focus();this.fireNavigate();return;}var j=T.getSelectedItem();var I=T.getItems();var z=I.length;var A=0;if(j){A=T.indexOfItem(j);A=A+i;}else if(i>=0){A=i-1;}else{A=z+i;}if(A<0){A=0;}else if(A>=z-1){A=z-1;}var B=I[A];if(B&&B!==j){B.setSelected(true);var V=w.call(this,B);if(B.getDomRef()){B.getDomRef().scrollIntoView();}this._bNoTableUpdate=true;this.setSelectedItems([{key:V.key,description:V.description,inParameters:V.inParameters,outParameters:V.outParameters}]);this._bNoTableUpdate=false;this.fireNavigate({key:V.key,description:V.description,inParameters:V.inParameters,outParameters:V.outParameters});}};h.prototype.getTextForKey=function(K,I,O){if(K===null||K===undefined){return null;}var T=this.getTable();if(y(T)){var R={key:K,description:""};var j=T.getItems();var z;var A;var B=false;if(I){z=[];for(var D in I){z.push(D);}}if(O){A=[];for(var E in O){A.push(E);}}for(var i=0;i<j.length;i++){var G=j[i];var V=w.call(this,G,z,A);if(V.key===K&&(!V.inParameters||!I||e(I,V.inParameters))&&(!V.outParameters||!O||e(O,V.outParameters))){R.description=V.description;R.inParameters=V.inParameters;R.outParameters=V.outParameters;B=true;break;}}if(B){return R;}}return k.call(this,this._getKeyPath,K,"description",I,O,true);};h.prototype.getKeyForText=function(T,I){if(!T){return null;}var j=this.getTable();if(y(j)){var R={key:undefined,description:T};var z=j.getItems();var A;var B=false;if(I){A=[];for(var D in I){A.push(D);}}for(var i=0;i<z.length;i++){var E=z[i];var V=w.call(this,E,A);if(V.description===T&&(!V.inParameters||!I||e(I,V.inParameters))){R.key=V.key;R.inParameters=V.inParameters;R.outParameters=V.outParameters;B=true;break;}}if(B){return R;}}return k.call(this,this._getDescriptionPath,T,"key",I,undefined,false);};function k(i,V,R,I,O,U){var j=i.call(this);if(this._oPromises[j]&&this._oPromises[j][V]){return this._oPromises[j][V];}if(!this._oPromises[j]){this._oPromises[j]={};}this._oPromises[j][V]=new Promise(function(z,A){this._oTablePromise.then(function(T){var B=j;j=i.call(this);if(!j){A(new Error("missing FieldPath"));}if(j!==B){if(!this._oPromises[j]){this._oPromises[j]={};}this._oPromises[j][V]=this._oPromises[B][V];delete this._oPromises[B][V];}var D=this.getListBinding();var E=D.getModel();var G=D.getPath();var H=new a(j,"EQ",V);var J=D.getContext();var K=[];if(I){for(var N in I){K.push(new a(N,"EQ",I[N]));}}if(O){for(var Q in O){if(!I||!I.hasOwnProperty(Q)||I[Q]!==O[Q]){K.push(new a(Q,"EQ",O[Q]));}}}if(K.length>0){K.push(H);H=new a({filters:K,and:true});}try{var W=E.bindList(G,J);var X=function(){var Z=W.getContexts();if(Z.length===1){var $=x.call(this,Z[0]);var a1={key:$.key,description:$.description,inParameters:$.inParameters,outParameters:$.outParameters};z(a1);}else if(V===""&&Z.length===0){z(null);}else{var b1;var c1;var d1=false;if(Z.length>1){b1=this._oResourceBundle.getText("valuehelp.VALUE_NOT_UNIQUE",[V]);d1=true;}else{b1=this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[V]);}if(U){c1=new b(b1);}else{c1=new P(b1);}c1._bNotUnique=d1;A(c1);}W.destroy();delete this._oPromises[j][V];};if(W.isA("sap.ui.model.json.JSONListBinding")){W.filter(H,c.Application);X.call(this);}else{W.attachEventOnce("dataReceived",X.bind(this));W.initialize();W.filter(H,c.Application);W.getContexts(0,2);}}catch(Y){A(Y);}}.bind(this));}.bind(this));return this._oPromises[j][V];}h.prototype.getListBinding=function(){var T=this.getTable();var i;if(T){i=T.getBinding("items");}return i;};h.prototype.getAsyncKeyText=function(){return true;};h.prototype.applyFilters=function(i,j){var z=this.getListBinding();if(!z){this._oTablePromise.then(function(T){if(!this._bIsBeingDestroyed){this.applyFilters(i,j);}}.bind(this));return;}var D=this._getDelegate();var U=true;var A=z.getFilterInfo();if(!i){i=[];}if(i.length===0&&!A){U=false;}if(D.delegate&&D.delegate.isSearchSupported(D.payload,z)){if(!z.isSuspended()&&U){z.suspend();}D.delegate.executeSearch(D.payload,z,j);L.info("ValueHelp-Search: "+j);}if(U){z.filter(i,c.Application);L.info("ValueHelp-Filter: "+m.call(this,i));}if(z.isSuspended()){z.resume();}};h.prototype.isSuspended=function(){var i=this.getListBinding();if(!i){return true;}return i.isSuspended();};function m(i){var R;if(!i){return"";}if(Array.isArray(i)){R="";i.forEach(function(i,I,j){R+=m.call(this,i);if(j.length-1!=I){R+=" or ";}},this);return"("+R+")";}else if(i._bMultiFilter){R="";var A=i.bAnd;i.aFilters.forEach(function(i,I,j){R+=m.call(this,i);if(j.length-1!=I){R+=A?" and ":" or ";}},this);return"("+R+")";}else{R=i.sPath+" "+i.sOperator+" '"+i.oValue1+"'";if(i.sOperator==="BT"){R+="...'"+i.oValue2+"'";}return R;}}h.prototype.clone=function(i,j){var T=this.getTable();if(T){T.detachEvent("itemPress",r,this);T.detachEvent("selectionChange",s,this);T.detachEvent("updateFinished",u,this);}var z=F.prototype.clone.apply(this,arguments);if(T){T.attachEvent("itemPress",r,this);T.attachEvent("selectionChange",s,this);T.attachEvent("updateFinished",u,this);}return z;};function n(i){if(i.name==="table"){o.call(this,i.mutation,i.child);}if(i.name==="selectedItems"){v.call(this);}}function o(i,T){if(i==="remove"){T.detachEvent("itemPress",r,this);T.detachEvent("selectionChange",s,this);T.detachEvent("updateFinished",u,this);T.detachEvent("modelContextChange",p,this);T=undefined;this._oTablePromise=new Promise(function(R){this._oTablePromiseResolve=R;}.bind(this));}else{T.setMode(f.SingleSelectMaster);T.setRememberSelections(false);T.attachEvent("itemPress",r,this);T.attachEvent("selectionChange",s,this);T.attachEvent("updateFinished",u,this);q.call(this,T,this._bSuggestion);v.call(this);if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);}if(this.getListBinding()){this._oTablePromiseResolve(T);}else{T.attachEvent("modelContextChange",p,this);}}this.fireDataUpdate({contentChange:true});}function p(E){if(this.getListBinding()){var T=E.getSource();this._oTablePromiseResolve(T);T.detachEvent("modelContextChange",p,this);}}function q(T,i){if(T&&this.getParent()){if(i){if(this._sTableWidth){T.setWidth(this._sTableWidth);}if(this._getMaxConditions()===1){T.setMode(f.SingleSelectMaster);}else{T.setMode(f.MultiSelect);}}else{if(T.getWidth()!=="100%"){this._sTableWidth=T.getWidth();T.setWidth("100%");}if(this._getMaxConditions()===1){T.setMode(f.SingleSelectLeft);}else{T.setMode(f.MultiSelect);}}var j=T.getSticky();if(!j||j.length===0){T.setSticky([S.ColumnHeaders]);}}}function r(E){var i=E.getParameter("listItem");if(!this._bSuggestion||this._getMaxConditions()!==1){i.setSelected(!i.getSelected());}t.call(this,true);}function s(E){if(!this._bSuggestion||this._getMaxConditions()!==1){t.call(this,false);}}function t(I){var z=[];var T=this.getTable();if(T){var A=this.getSelectedItems();var B=T.getItems();var i=0;var D;var V;if(A.length>0){for(i=0;i<B.length;i++){D=B[i];V=w.call(this,D);if(!V){throw new Error("Key of item cannot be determined"+this);}for(var j=A.length-1;j>=0;j--){var E=A[j];if(E.key===V.key&&(!V.inParameters||!E.inParameters||e(E.inParameters,V.inParameters))&&(!V.outParameters||!E.outParameters||e(E.outParameters,V.outParameters))){A.splice(j,1);break;}}}}if(A.length>0){z=A;}A=T.getSelectedItems();for(i=0;i<A.length;i++){D=A[i];V=w.call(this,D);if(!V){throw new Error("Key of item cannot be determined"+this);}z.push({key:V.key,description:V.description,inParameters:V.inParameters,outParameters:V.outParameters});}}this._bNoTableUpdate=true;this.setSelectedItems(z);this._bNoTableUpdate=false;this.fireSelectionChange({selectedItems:z,itemPress:I});}function u(E){if(!this.getParent()){return;}v.call(this);if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);}if(E.getParameter("reason")!==d(C.Filter)){this.fireDataUpdate({contentChange:false});}}function v(){if(this._bNoTableUpdate){return;}var T=this.getTable();if(y(T)){var z=this.getSelectedItems();var I=T.getItems();var U=false;for(var j=0;j<I.length;j++){var A=I[j];var B=false;if(z.length>0){var V=w.call(this,A);for(var i=0;i<z.length;i++){var D=z[i];if(V.key===D.key&&(!V.inParameters||!D.inParameters||e(D.inParameters,V.inParameters))&&(!V.outParameters||!D.outParameters||e(D.outParameters,V.outParameters))){B=true;if(V.description!==D.description){D.description=V.description;U=true;}break;}}}if(A.getSelected()!==B){A.setSelected(B);}}}if(U){this._bNoTableUpdate=true;this.setSelectedItems(z);this._bNoTableUpdate=false;}}function w(i,I,O){var V;var B=i.getBindingContext();if(B){V=x.call(this,B,I,O);}if(!V){var K=this._getKeyPath();var j;var D;if(!K&&i.getCells){var z=i.getCells();if(z.length>0&&z[0].getText){j=z[0].getText();}if(z.length>1&&z[1].getText){D=z[1].getText();}if(j!==undefined){V={key:j,description:D};}}}if(!V){throw new Error("Key could not be determined from item "+this);}return V;}function x(B,I,O){var K=this._getKeyPath();var D=this._getDescriptionPath();var j=B.getObject();var z;var A;if(!I){I=this._getInParameters();}if(!O){O=this._getOutParameters();}var E=I.length>0?{}:null;var G=O.length>0?{}:null;var H;if(j){if(K&&j.hasOwnProperty(K)){z=j[K];}if(D&&j.hasOwnProperty(D)){A=j[D];}var i=0;for(i=0;i<I.length;i++){H=I[i];if(j.hasOwnProperty(H)){E[H]=j[H];}}for(i=0;i<O.length;i++){H=O[i];if(j.hasOwnProperty(H)){G[H]=j[H];}else{L.error("FieldValueHelpMTableWrapper","cannot find out-parameter '"+H+"' in item data!");}}}if(z===null||z===undefined){return false;}return{key:z,description:A,inParameters:E,outParameters:G};}function y(T){if(!T){return false;}var B=T.getBinding("items");if(B&&(B.isSuspended()||B.getLength()===0)){return false;}return true;}return h;});
