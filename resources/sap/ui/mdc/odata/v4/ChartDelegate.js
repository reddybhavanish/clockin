/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/mdc/library","sap/ui/mdc/ChartDelegate","sap/ui/base/SyncPromise","./ODataMetaModelUtil","sap/base/util/merge"],function(M,B,S,a,m){"use strict";var A="@Org.OData.Aggregation.V1";function f(H){this.name=H[0];this.label=H[1]instanceof Object?H[1]["$Path"]:H[1]||this.name;this.textProperty=H[2];this.type=a.getType(H[3]);if(H[4]||H[5]){var c=H[4],F=H[5];if(F){switch(F){case"year":this.timeUnit="fiscalyear";break;case"yearPeriod":this.timeUnit="fiscalyearperiod";break;default:this.timeUnit=undefined;break;}}if(c&&!this.timeUnit){switch(c){case"yearMonth":this.timeUnit="yearmonth";break;case"date":this.timeUnit="yearmonthday";break;case"yearQuarter":this.timeUnit="yearquarter";break;case"yearWeek":this.timeUnit="yearweek";break;default:this.timeUnit=undefined;break;}}}this.criticality=H[6];return this;}function h(R){var g=R[0],b=R[1];var H={},p={},I;p.inChart=g||b||false;if(p.inChart){p.chartItems=[];if(g){H.kind=M.ChartItemType.Dimension;H.role=M.ChartItemRoleType.category;I=m({},H);p.chartItems.push(I);}if(b){H.kind=M.ChartItemType.Measure;H.role=M.ChartItemRoleType.axis1;H.contextDefiningProperties=R[4]||[];var s=R[2]||[],d=R[3];for(var i=0;i<s.length;i++){I=m({},H);I.aggregationMethod=s[i]instanceof Object?s[i]["$Path"]:s[i];I.default=I.aggregationMethod==d instanceof Object?d[i]["$Path"]:d[i];p.chartItems.push(I);}}}var o=this.getModel();return Promise.all([o.requestObject("@sapui.name",this),o.requestObject("@com.sap.vocabularies.Common.v1.Label",this),o.requestObject("@com.sap.vocabularies.Common.v1.Text/$Path",this),o.requestObject("$Type",this),a.fetchCalendarTag(o,this),a.fetchFiscalTag(o,this),a.fetchCriticality(o,this)]).then(f.bind(p));}function r(e,p,o,b){var k,P,c=[],I=[],s,d=[],g,j,K={};var l=a.getAllCustomAggregates(b);for(var n in l){I.push(m({},l[n],{propertyPath:n,kind:M.ChartItemType.Measure,role:M.ChartItemRoleType.axis1,sortable:l[n].sortable,filterable:l[n].filterable}));}var t=a.getAllAggregatableProperties(b);for(var q in t){k=t[q].propertyPath;K[k]=K[k]||{};K[k][t[q].aggregationMethod]={name:t[q].name,label:t[q].label};}var u=a.getSortRestrictionsInfo(b["@Org.OData.Capabilities.V1.SortRestrictions"]),F=a.getFilterRestrictionsInfo(b["@Org.OData.Capabilities.V1.FilterRestrictions"]);function v(P){d.push(P);a.addSortInfoForProperty(P,u);a.addFilterInfoForProperty(P,F);if(P.inChart){for(var i=0;i<P.chartItems.length;i++){var w=P.chartItems[i];w.propertyPath=P.name;w.type=P.type;w.timeUnit=P.timeUnit;w.criticality=P.criticality;if(w.kind==M.ChartItemType.Measure){var x=w.aggregationMethod instanceof Object?w.aggregationMethod["$Path"]:w.aggregationMethod;if(K[w.propertyPath]&&K[w.propertyPath][x]){w.name=K[w.propertyPath][w.aggregationMethod].name;w.label=K[w.propertyPath][w.aggregationMethod].label;}else{w.name=x+w.propertyPath;w.label=P.label+" ("+x+")";}w.customAggregate=false;w.sortable=true;w.sortDirection="both";w.filterable=true;}else{w.name=P.name;w.textProperty=P.textProperty;w.label=P.label;w.sortable=P.sortable;w.sortDirection=P.sortDirection;w.filterable=P.filterable;w.allowedExpressions=P.allowedExpressions;}I.push(w);}}}for(k in e){if(k[0]!=="$"){P=e[k];if(P&&P.$kind&&(P.$kind=="Property")){s=p+k+A;c.push(Promise.all([o.requestObject(s+".Groupable"),o.requestObject(s+".Aggregatable"),o.requestObject(s+".SupportedAggregationMethods"),o.requestObject(s+".RecommendedAggregationMethod"),o.requestObject(s+".ContextDefiningProperties")]).then(h.bind(o.getMetaContext(p+k))).then(v));}}}return Promise.all(c).then(function(){return[j,g,d,I];});}var C=Object.assign({},B);C.MetadataProperty={kind:"Measure",role:"axis1",contextDefiningProperties:[],className:"sap.ui.mcd.chart.MeasureItem",aggregationMethod:"sum","default":true,custom:false,name:"sumSalesAmount",propertyPath:"SalesAmount",label:"Total Sales Amount",textProperty:"",sortable:true,sortDirection:"both",filterable:true,allowedExpressions:[]};C.fetchProperties=function(c){return this.retrieveAllMetadata(c).then(function(o){return o.properties;});};C.retrieveAggregationItem=function(s,o){var b;var c={className:"",settings:{key:o.name,label:o.label||o.name,type:o.type}};switch(o.kind){case M.ChartItemType.Dimension:c.className="sap.ui.mdc.chart.DimensionItem";b={textProperty:o.textProperty,timeUnit:o.timeUnit,displayText:true,criticality:o.criticality};break;case M.ChartItemType.Measure:c.className="sap.ui.mdc.chart.MeasureItem";b={propertyPath:o.propertyPath,aggregationMethod:o.aggregationMethod};break;}c.settings=Object.assign(c.settings,b);return c;};C.getModel=function(c){var v=c.getDelegate().model,o=c.getModel(v);if(o){return S.resolve(o);}return new S(function(b,d){function e(){var o=c.getModel(v);if(o){c.detachModelContextChange(e,c);return b(o);}}c.attachModelContextChange(e,c);});};C.retrieveAllMetadata=function(c){var o=this.getModel(c);function b(d){var D=c.getDelegate(),p="/"+D.payload.collectionName,e=d&&d.getMetaModel();if(p.endsWith("/")){throw new Error("The leading path for metadata calculation is the entity set not the path");}var s=p,t=p+"/";function g(R){var j={sortable:R[0],filterable:R[1],attributes:R[2],properties:R[3]};return j;}var i=[e.requestObject(t),e.requestObject(s)];return Promise.all(i).then(function(T){var E=T[0];var j=[a.fetchAllAnnotations(e,t),a.fetchAllAnnotations(e,s)];return Promise.all(j).then(function(k){var l=Object.assign(k[0],k[1]);return r(E,t,e,l);});}).then(g);}return o.then(b);};return C;});
