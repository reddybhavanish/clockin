/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/mdc/library',"sap/ui/fl/Utils","sap/ui/mdc/FilterBarDelegate",'sap/base/util/ObjectPath','sap/base/util/merge','sap/ui/mdc/odata/v4/FieldBaseDelegate','sap/ui/mdc/condition/FilterOperatorUtil',"sap/ui/model/FilterOperator","sap/ui/model/Filter",'sap/ui/mdc/util/IdentifierUtil'],function(m,F,a,O,b,c,d,M,e,I){"use strict";var f=m.FieldDisplay;var g=Object.assign({},a);var D={"Edm.Boolean":"Bool","Edm.Byte":"Int","Edm.DateTime":"Date","Edm.DateTimeOffset":"DateTimeOffset","Edm.Decimal":"Decimal","Edm.Double":"Float","Edm.Float":"Float","Edm.Guid":"Guid","Edm.Int16":"Int","Edm.Int32":"Int","Edm.Int64":"Int","Edm.SByte":"Int","Edm.Single":"Float","Edm.String":"String","Edm.Time":"TimeOfDay"};var h={};g._fetchPropertiesByMetadata=function(o,p){var i,j,C,k,l;if(p){var n=p.modifier;i=n.getProperty(o,"delegate");j=i.payload.modelName===null?undefined:i.payload.modelName;C=i.payload.collectionName;k=p.appComponent.getModel(j);}else{i=o.getProperty("delegate");j=i.payload.modelName===null?undefined:i.payload.modelName;C=i.payload.collectionName;k=o.getModel(j);}l=o.getId?o.getId():o.id;var q={getDelegate:function(){return{payload:{modelName:j,collectionName:C}};},getModel:function(s){return k;},getId:function(){return l;}};return this.fetchProperties(q);};g._isMultiValue=function(s){var i=true;switch(s){case"SearchExpression":case"SingleRange":case"SingleValue":i=false;break;default:break;}return i;};g._ensureSingleRangeEQOperators=function(){var o;if(!d.getOperator("SINGLE_RANGE_EQ")){o=b({},d.getOperator("EQ"));o.name="SINGLE_RANGE_EQ";o.getModelFilter=function(C,s){return new e({filters:[new e(s,M.GE,C.values[0]),new e(s,M.LE,C.values[0])],and:true});};d.addOperator(o);}if(!d.getOperator("SINGLE_RANGE_EQ")){o=b({},d.getOperator("EQ"));o.name="SINGLE_RANGE_EQ";o.getModelFilter=function(C,s){return new e({filters:[new e(s,M.GE,C.values[0]),new e(s,M.LE,C.values[0])],and:true});};d.addOperator(o);}};g._ensureMultiRangeBTEXOperator=function(){if(!d.getOperator("MULTI_RANGE_BTEX")){var o=b({},d.getOperator("BT"));o.name="MULTI_RANGE_BTEX";o.getModelFilter=function(C,s){return new e({filters:[new e(s,M.GT,C.values[0]),new e(s,M.LT,C.values[1])],and:true});};d.addOperator(o);}};g._getFilterOperators=function(s){var o=null,i=null;switch(s){case"SingleValue":case"MultiValue":o="EQ";break;case"SingleRange":o="SINGLE_RANGE_EQ,SINGLE_RANGE_EQ,LE,GE";this._ensureSingleRangeEQOperators();break;case"MultiRange":o="EQ,LE,LT,GE,GT,BT,MULTI_RANGE_BTEX";this._ensureMultiRangeBTEXOperator();break;case"SearchExpression":o="StartsWith,EndsWith,Contains";break;case"MultiRangeOrSearchExpression":o="StartsWith,EndsWith,Contains,EQ,LE,LT,GE,GT,BT,MULTI_RANGE_BTEX";this._ensureMultiRangeBTEXOperator();break;default:break;}if(o){i=o.split(',');}return i;};g._createFilterField=function(p,o,P){var i=P.modifier;var n=p.path||p.name;var s={};if(o.getId){s.id=o.getId();}else{s.id=o.id;}var S=i.getControlIdBySelector(s,P.appComponent);var j=S+"--filter--"+I.replace(n);return i.createControl("sap.ui.mdc.FilterField",P.appComponent,P.view,j,{dataType:p.type,conditions:"{$filters>/conditions/"+n+'}',required:p.required,label:p.label,maxConditions:p.maxConditions,delegate:{name:"sap/ui/mdc/odata/v4/FieldBaseDelegate",payload:{}}},true).then(function(k){if(p.fieldHelp){var l=p.fieldHelp;if(!P.viewId){l=F.getViewForControl(o).createId(p.fieldHelp);}else{l=P.viewId+"--"+p.fieldHelp;}i.setAssociation(k,"fieldHelp",l);}if(p.filterOperators){if(o.getId){i.setProperty(k,"operators",p.filterOperators);}else{i.setProperty(k,"operators",p.filterOperators.join(','));}}if(p.tooltip){i.setProperty(k,"tooltip",p.tooltip);}if(p.constraints){i.setProperty(k,"dataTypeConstraints",p.constraints);}if(p.formatOptions){i.setProperty(k,"dataTypeFormatOptions",p.formatOptions);}if(p.display){i.setProperty(k,"display",p.display);}return k;});};g._createFilter=function(p,o,P){return this._fetchPropertiesByMetadata(o,P).then(function(i){var j=i.find(function(k){return(I.getPropertyKey(k)===p);});if(!j){return null;}return Promise.resolve(this._createFilterField(j,o,P));}.bind(this));};g.beforeAddFilterFlex=function(p,o,P){return Promise.resolve(this._createFilter(p,o,P));};g.afterRemoveFilterFlex=function(o,i,p){return Promise.resolve(true);};g._getFieldGroupsByFilterFacetsAnnotation=function(o,E){};g._getDataType=function(p){var t=O.get(p.type||"");if(!t){throw new Error("DataType '"+p.type+"' cannot be determined");}return new t(p.formatOptions,p.constraints);};g._fetchPropertyInfo=function(o,E,n,i,k){var p={};var j=o.getObject(E+"/"+"@com.sap.vocabularies.UI.v1.TextArrangement");var H=false;if(o.getObject(E+"/"+k+"@com.sap.vocabularies.UI.v1.HiddenFilter")){H=true;}var l=false;if(o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.IsDigitSequence")){l=true;}var q=null;var r=o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.FilterDefaultValue");if(r){var v=r["$"+D[i.$Type]];switch(i.$Type){case"Edm.DateTimeOffset":q=v;break;default:q=v;}}var L=o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.Label")||k;var t=o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.QuickInfo")||null;var C={};if(i.$MaxLength||i.$Precision||i.$Scale||l){if(i.$MaxLength){C.maxLength=i.$MaxLength;}if(i.$Precision){C.precision=i.$Precision;}if(i.$Scale){C.scale=i.$Scale;}if(l){C.isDigitSequence=l;}}else{C=null;}var s,T=o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.Text");if(T){var u=o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement")||j;if(u){if(u.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"){s=f.Description;}else if(u.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextLast"){s=f.ValueDescription;}else{s=f.DescriptionValue;}}else{s=f.DescriptionValue;}}var P={name:k,label:L,tooltip:t,type:c.getDataTypeClass(p,i.$Type),hiddenFilter:H};if(s){P.display=s;}if(i.$Type==="Edm.DateTimeOffset"){if(!C){C={};}C.V4=true;}if(C){P.constraints=C;}P.baseType=g._getDataType(P);if(q){P.defaultFilterConditions=[{fieldPath:k,operator:"EQ",values:[q]}];}if(n){P.path=n+"/"+k;}return P;};g._fetchEntitySet=function(o,E,v,n){return Promise.all([o.requestObject(E+"/"),o.requestObject(E+"@")]).then(function(r){var i=r[0];var j=r[1]||{};if(!i){return Promise.resolve([]);}var k,p,l=[],P=[],N=[],R=[],s=[],A={},q={};var t=o.getObject(E);if(t&&t.$NavigationPropertyBinding){q=t.$NavigationPropertyBinding;}var u=j["@Org.OData.Capabilities.V1.FilterRestrictions"];if(u){if(u.NonFilterableProperties){N=u.NonFilterableProperties.map(function(B){return B.$PropertyPath;});}if(u.RequiredProperties){R=u.RequiredProperties.map(function(B){return B.$PropertyPath;});}if(u.FilterExpressionRestrictions){u.FilterExpressionRestrictions.forEach(function(B){A[B.Property.$PropertyPath]=B.AllowedExpressions;});}}u=o.getObject(E+"/"+"@com.sap.vocabularies.UI.v1.SelectionFields");if(u){s=u.map(function(B){return B.$PropertyPath;});}var w=o.getObject(E+"/@sapui.name");var G=w;var x=o.getObject(E+"@com.sap.vocabularies.Common.v1.Label");if(!x){x=G;}for(var K in i){k=i[K];if(k){if(k.$kind==="Property"){if(N.indexOf(K)>=0){continue;}if(o.getObject(E+"/"+K+"@com.sap.vocabularies.UI.v1.Hidden")){continue;}p=g._fetchPropertyInfo(o,E,n,k,K);if(p){p.group=G;p.groupLabel=x;p.required=R.indexOf(K)>=0;p.visible=s.indexOf(K)>=0;if(A[K]){var y=g._getFilterOperators(A[K]);if(y){p.filterOperators=y;}}p.maxConditions=g._isMultiValue(A[K])?-1:1;l.push(p);}}else if((k.$kind==="NavigationProperty")&&(!k.$isCollection)&&(v.indexOf(w)===-1)){v.push(w);var z=q[K];if(z){P.push(g._fetchEntitySet(o,'/'+z,v,K));}}}}return Promise.all(P).then(function(B){B.forEach(function(C){l=l.concat(C);});return l;});});};g._setModel=function(){var s=this.getDelegate().payload.modelName;s=s===null?undefined:s;var o=this.getModel(s);if(o){this.detachModelContextChange(g._setModel,this);g._fModelProvided(o);}};g._waitForMetaModel=function(o,p){return new Promise(function(r,i){var s=p===null?undefined:p;var j=o.getModel(s);if(j){r(j);}if(!o.attachModelContextChange){i();}g._fModelProvided=r;o.attachModelContextChange(g._setModel,o);});};g.fetchProperties=function(o){var s=o.getDelegate().payload.modelName;var E=o.getDelegate().payload.collectionName;return new Promise(function(r,i){var j;var C=o.getId()+'->'+E;if(h[C]){r(h[C]);return;}this._waitForMetaModel(o,s).then(function(k){if(!k||!E){i("model or entity set name not available");return;}j=k.getMetaModel();if(!j){i("metadata model not available");}else{var v=[];g._fetchEntitySet(j,'/'+E,v).then(function(p){h[C]=p;r(p);});}},function(){i("model not obtained");});}.bind(this));};g.cleanup=function(o){var s=o.getId()+"->";Object.keys(h).forEach(function(k){if(k.indexOf(s)===0){delete h[k];}});};return g;});
