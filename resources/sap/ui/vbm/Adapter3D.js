/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Element","sap/ui/base/ManagedObjectObserver","sap/ui/unified/Menu","sap/ui/unified/MenuItem","sap/m/ResponsivePopover","sap/ui/vbm/Viewport","./adapter3d/ObjectFactory","./adapter3d/VBIJSONParser","./adapter3d/SceneBuilder","./adapter3d/Utilities","sap/m/HBox","sap/m/VBox","sap/m/Link","sap/m/Button","sap/m/Text","sap/m/Image","./adapter3d/thirdparty/three"],function(q,l,E,O,M,c,P,V,d,e,S,U,H,f,L,B,T,I,h){"use strict";var t="sap.ui.vbm.adapter3d.Adapter3D";var j=q.sap.log;var k=U.toBoolean;var n=U.applyColor;var o=U.makeDataUri;var r;var A=E.extend("sap.ui.vbm.Adapter3D",{metadata:{library:"sap.ui.vbm",associations:{viewport:{type:"sap.ui.vbm.Viewport"}},events:{submit:{parameters:{data:{type:"string"}}}}}});var s=A.getMetadata().getParent().getClass().prototype;A.prototype.init=function(){if(s.init){s.init.call(this);}this._viewport=null;this._context={resources:new Map(),dataTypes:[],data:{},windows:[],scenes:[],actions:[],voQueues:{toAdd:new Map(),toUpdate:new Map(),toRemove:new Map()},sceneQueues:{toAdd:[],toUpdate:[],toRemove:[]},windowQueues:{toAdd:[],toUpdate:[],toRemove:[]},setupView:undefined};this._update=Promise.resolve();this._parser=null;this._sceneBuilder=null;this._lastHoverInstance=null;this._hoverTimeOutId=null;this._clickTimerId=null;this._mouseDown=false;this._lastXY={x:0,y:0};this._viewportObserver=new O(this._observeChanges.bind(this));this._detail={popover:undefined,anchor:undefined,pending:undefined};};A.prototype.exit=function(){if(this._clickTimerId){q.sap.clearDelayedCall(this._clickTimerId);this._clickTimerId=null;}if(this._hoverTimeOutId){clearTimeout(this._hoverTimeOutId);this._hoverTimeOutId=null;}this._disconnectViewport();this._viewportObserver.disconnect();this._viewportObserver=null;if(this._sceneBuilder){this._sceneBuilder.destroy();this._sceneBuilder=null;}if(this._parser){this._parser.destroy();this._parser=null;}this._context=null;if(s.exit){s.exit.call(this);}};A.prototype.setViewport=function(v){this.setAssociation("viewport",v,true);this._configureViewport();return this;};A.prototype._configureViewport=function(){var a=sap.ui.getCore().byId(this.getViewport())||null;if(a!==this._viewport){this._disconnectViewport();this._viewport=a;this._connectViewport();}return this;};A.prototype._connectViewport=function(){if(this._viewport){this._viewportObserver.observe(this._viewport,{destroy:true});this._viewport.addEventDelegate(r,this);}return this;};A.prototype._disconnectViewport=function(){if(this._viewport){this._viewport.removeEventDelegate(r);r.onBeforeRendering.call(this);this._viewportObserver.unobserve(this._viewport,{destroy:true});this._viewport=null;}return this;};A.prototype._observeChanges=function(a){if(a.type==='destroy'&&a.object===this._viewport){this._disconnectViewport();}};A.prototype.load=function(a){var b=this;b._configureViewport();if(!b._viewport){return Promise.reject();}var p=null;if(!b._parser){b._parser=new e(b._context);}if(!b._sceneBuilder){b._sceneBuilder=new S(b._context,b._viewport);}if(typeof a==="string"){try{p=JSON.parse(a);}catch(g){j.error("sap.ui.vbm.Adapter: attempt to load invalid JSON string.");return Promise.resolve();}}else if(typeof a==="object"){p=a;}if(!(p&&p.SAPVB)){j.error("sap.ui.vbm.Adapter3D: attempt to load null.");return Promise.resolve();}b._update=b._update.then(function(){b._parser.loadVBIJSON(p);return b._sceneBuilder.synchronize();}).then(function(){b._processAutomation(p);b._processDetailWindow();b._context.voQueues.toAdd.clear();b._context.voQueues.toUpdate.clear();b._context.voQueues.toRemove.clear();b._context.sceneQueues.toAdd.splice(0);b._context.sceneQueues.toUpdate.splice(0);b._context.sceneQueues.toRemove.splice(0);b._context.windowQueues.toAdd.splice(0);b._context.windowQueues.toUpdate.splice(0);b._context.windowQueues.toRemove.splice(0);if(b._lastHoverInstance&&!b._lastHoverInstance.object3D){b._lastHoverInstance=null;}b._viewport._resetBBox();b._viewport._updateCamera();});return b._update;};A.prototype._processDetailWindow=function(p){var a=sap.ui.vbm.findInArray(this._context.windowQueues.toAdd,function(a){return a.type==="callout";});var b=a&&sap.ui.vbm.findInArray(this._context.scenes,function(b){return b.id===a.refScene;});if(a&&b){this._closeDetailWindow();var g=this._createDetailWindow(a);this._fillDetailWindow(g,b);this._openDetailWindow(g,a);}};A.prototype._closeDetailWindow=function(){if(this._detail.popover){this._detail.popover.close();this._detail.popover.destroy();this._detail.popover=undefined;}if(this._detail.anchor){this._detail.anchor.style.visibility="hidden";}};A.prototype._createDetailWindow=function(a){var b;if(a.caption!==""){var g=new sap.m.Text({width:"100%",textAlign:sap.ui.core.TextAlign.Center,text:a.caption,tooltip:a.caption});b=new sap.m.Bar({contentLeft:[g]});}var p=new sap.m.ResponsivePopover({placement:sap.m.PlacementType.Auto,showCloseButton:true,verticalScrolling:true,contentWidth:a.width+"px"});p.addStyleClass("sapUiVbmDetailWindow");if(b){p.setCustomHeader(b);}return p;};A.prototype._getAnchor=function(x,y){if(!this._detail.anchor){var a=document.createElement("div");a.classList.add("sapUiVbmDetailWindowAnchor");this._viewport.getDomRef().appendChild(a);this._detail.anchor=a;}this._detail.anchor.style.left=x+"px";this._detail.anchor.style.top=y+"px";return this._detail.anchor;};A.prototype._openDetailWindow=function(p,a){var b=a.pos.split(";");var g=new h.Vector3(parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2]));if(!this._viewport.getDomRef()){if(this._detail.pending){this._detail.pending.popover.destroy();}this._detail.pending={world:g,popover:p};}else{var i=this._viewport.getDomRef().getBoundingClientRect();var m=this._viewport.worldToScreen(U.vbToThreeJs(g));m.x=U.clamp(m.x,5,i.width-5);m.y=U.clamp(m.y,5,i.height-5);p.openBy(this._getAnchor(m.x,m.y));p.attachAfterClose(function(){this._closeDetailWindow();}.bind(this));this._detail.popover=p;}};A.prototype._openDetailPending=function(){if(this._detail.pending&&this._viewport.getDomRef()){var a=this._viewport.worldToScreen(U.vbToThreeJs(this._detail.pending.world));this._detail.pending.popover.openBy(this._getAnchor(a.x,a.y));this._detail.popover=this._detail.pending.popover;this._detail.pending=undefined;}};A.prototype._fillDetailWindow=function(p,m){var x=function(a){var b;switch(a){case"1":b=sap.m.FlexJustifyContent.Start;break;case"2":b=sap.m.FlexJustifyContent.Center;break;case"4":b=sap.m.FlexJustifyContent.End;break;default:b=sap.m.FlexJustifyContent.Inherit;break;}return b;};var y=function(i){var a;switch(i.type){case"{00100000-2013-1000-1100-50059A6A47FA}":a=new T({text:i.vo.text,tooltip:i.vo.tooltip});a.addStyleClass("sapUiVbmDetailWindowBase sapUiVbmDetailWindowCaption");if(i.vo.level==="3"){a.addStyleClass("sapUiVbmDetailWindowCaption3");}break;case"{00100000-2013-1000-3700-AD84DDBBB31B}":a=new T({text:i.vo.text,tooltip:i.vo.tooltip});a.addStyleClass("sapUiVbmDetailwindowBase");break;case"{00100000-2013-1000-2400-D305F7942B98}":a=new L({text:i.vo.text,tooltip:i.vo.tooltip,href:i.vo.autoexecute?i.vo.reference:""});a.addStyleClass("sapUiVbmDetailWindowBase");break;case"{00100000-2013-1000-1200-855B919BB0E9}":a=new B({text:i.vo.text,tooltip:i.vo.tooltip});break;case"{00100000-2013-1000-2200-6B060A330B2C}":if(i.vo.image&&i.vo.image!==""){a=new I({src:o(this._context.resources.get(i.vo.image)),tooltip:i.vo.tooltip});}break;default:j.error("sap.ui.vbm.Adapter3D: attempt to create unknown element of detail window: "+i.type);}return a;};var z=m.voGroups.map(function(a){return a.vos.map(function(v){return{type:a.type,vo:v};});}).reduce(function(a,b){return a.concat(b);}).sort(function(a,b){return parseInt(a.vo.top,10)-parseInt(b.vo.top,10);}).reduce(function(g,a){var b=a.vo.top?a.vo.top:"0";g[b]=g[b]||[];g[b].push(a);return g;},{});var C=new f();for(var D in z){if(z.hasOwnProperty(D)){var F=new H({width:Math.max.apply(null,z[D].map(function(i){return parseInt(i.vo.right,10);}))+"px"});var G=0;z[D].sort(function(a,b){return parseInt(a.vo.left,10)-parseInt(b.vo.left,10);}).map(function(i){var a=[];if((parseInt(i.vo.left,10)-G)>1){a.push(new H({width:(parseInt(i.vo.left,10)-G)+"px"}));}var b=new H({width:(parseInt(i.vo.right,10)-parseInt(i.vo.left,10))+"px",justifyContent:x(i.vo.align)});G=parseInt(i.vo.right,10);b.addItem(y.bind(this)(i));a.push(b);return a;},this).reduce(function(a,b){return a.concat(b);}).forEach(F.addItem,F);C.addItem(F);}}p.addContent(C);};A.prototype._processAutomation=function(a){var b=this;var g=function(m,p,F,G,C){var J=new c({text:p.text,enabled:p.disabled==="X"?false:true,startsSection:C,select:b._menuItemSelectionHandler.bind(b,p.id,F.instance,G,F.object)});if(p.MenuItem){var K=new M();C=false;[].concat(p.MenuItem).forEach(function(N){if(N.hasOwnProperty("Separator")){C=true;}else{g(K,N,F,G,C);C=false;}});J.setSubmenu(K);}m.addItem(J);};if(a&&a.SAPVB&&a.SAPVB.Automation&&a.SAPVB.Automation.Call&&a.SAPVB.Automation.Call){if(a.SAPVB.Automation.Call.handler&&a.SAPVB.Automation.Call.handler==="CONTEXTMENUHANDLER"){var x=[].concat(a.SAPVB.Automation.Call.Param).filter(function(p){return p.name==="x";});var y=[].concat(a.SAPVB.Automation.Call.Param).filter(function(p){return p.name==="y";});var i;if(x.length>0&&y.length>0){i=x[0]["#"]+" "+y[0]["#"];}if(a.SAPVB&&a.SAPVB.Menus&&a.SAPVB.Menus.Set){var v=[].concat(a.SAPVB.Menus.Set).filter(function(m){return m.Menu.id===a.SAPVB.Automation.Call.refID;});if(v.length>0){var z=new M();var C=false;[].concat(v[0].Menu.MenuItem).forEach(function(m){if(m.hasOwnProperty("Separator")){C=true;}else{g(z,m,a.SAPVB.Automation.Call,v[0].Menu.action,C);C=false;}});var D=sap.ui.core.Popup.Dock;z.open(false,this._viewport,D.BeginTop,D.BeginTop,this._viewport,i,"fit fit");}}}}return this;};A.prototype._menuItemSelectionHandler=function(i,a,b,v){var p={version:"2.0","xmlns:VB":"VB",Action:{id:i,instance:a,name:b,object:v}};this.fireSubmit({data:JSON.stringify(p)});};A.prototype._genericEventHandler=function(a,b){var i=b.instance;var g=i?i.voGroup.id:b.voGroupId;var m=sap.ui.vbm.findInArray(this._context.actions,function(y){return y.refVO===g&&y.refEvent===a;});if(m){var p=[];var v={version:"2.0","xmlns:VB":"VB",Action:{id:m.id,name:m.name,object:m.refVO,instance:i&&i.id?i.voGroup.datasource+"."+i.id:"",Params:{Param:p}}};if(m.name==="KEY_PRESS"){if(b.keyCode==72){this._viewport.applyCameraHome(false);}if(b.key=="Shift"||b.code==16||b.key=="Control"||b.code==17||b.key=="Alt"||b.code==18||b.key=="Meta"||b.code==91){return this;}else{p.push({"name":"code","#":b.keyCode},{"name":"shift","#":b.shiftKey},{"name":"ctrl","#":b.ctrlKey},{"name":"alt","#":b.altKey},{"name":"meta","#":b.metaKey});}}else if(b&&b.cursor){p.push({name:"x","#":b.cursor.x},{name:"y","#":b.cursor.y});}if(m.AddActionProperty){var x=[];[].concat(m.AddActionProperty).forEach(function(y){switch(y.name){case"pos":if(b.hitPoint){var z=U.threeJsToVb(b.hitPoint);x.push({name:y.name,"#":z.x.toFixed(5)+";"+z.y.toFixed(5)+";"+z.z.toFixed(5)});}break;case"zoom":var C=this._viewport._getCameraState();var D=this._sceneBuilder._getZoomFactor(C.position,C.target);x.push({name:y.name,"#":D.toFixed(5)});break;default:break;}},this);if(x.length>0){v.Action.AddActionProperties={AddActionProperty:x};}}if(i&&a==="Click"&&b.selectionChanges){v.Data={Merge:{N:[{name:i.voGroup.datasource,E:b.selectionChanges.selected.map(function(i){return{K:i?i.id:"","VB:s":"true"};}).concat(b.selectionChanges.deselected.map(function(i){return{K:i?i.id:"","VB:s":"false"};}))}]}};}this.fireSubmit({data:JSON.stringify(v)});}};A.prototype._propagateClick=function(a){this._genericEventHandler("Click",a);};A.prototype._propagateDoubleClick=function(a){this._genericEventHandler("DoubleClick",a);};A.prototype._propagateContextMenu=function(a){this._genericEventHandler("ContextMenu",a);};A.prototype._propagateKeyPress=function(a){this._genericEventHandler("KeyPress",a);};A.prototype._propogateHoverChange=function(a){this._genericEventHandler("HoverChange",a);};A.prototype._handleClick=function(a){var i=a.instance;j.info("click","x: "+a.cursor.x+", y: "+a.cursor.y+", instance: "+(i?i.id:"")+", tooltip: "+(i?i.tooltip:""),t);this._extendEventWithSelection(a);if(a.selectionChanges){this._applySelectionChangesToScene3D(a.selectionChanges.selected,a.selectionChanges.deselected);}this._propagateClick(a);};A.prototype._handleDoubleClick=function(a){var i=a.instance;j.info("double click","x: "+a.cursor.x+", y: "+a.cursor.y+", instance: "+(i?i.id:"")+", tooltip: "+(i?i.tooltip:""),t);this._propagateDoubleClick(a);};A.prototype._handleContextMenu=function(a){var i=a.instance;if(!i){a.voGroupId="Scene";}j.info("context menu","x: "+a.cursor.x+", y: "+a.cursor.y+", instance: "+(i?i.id:"")+", tooltip: "+(i?i.tooltip:""),t);this._propagateContextMenu(a);};A.prototype._handleHover=function(a){var b;var i=a.instance;j.trace("hover","x: "+a.cursor.x+", y: "+a.cursor.y+", instance: "+(i?i.id:"")+", tooltip: "+(i?i.tooltip:""),t);if(i){b=i.tooltip;if(!b){b=i.text;}}var g=this._viewport.getDomRef();if(g){if(b){g.setAttribute("title",b);}else{g.removeAttribute("title");}}if(this._lastHoverInstance!==a.instance){clearTimeout(this._hoverTimeOutId);var m=function(){this._propogateHoverChange(a);this._hoverTimeOutId=undefined;}.bind(this);this._hoverTimeOutId=setTimeout(m,500);}this._applyHoverChangesToScene3D(i);};A.prototype._handleKeyPress=function(a){j.info("keypress",a.key,t);this._propagateKeyPress(a);};A.prototype._getXY=function(a){var b=this._viewport.getDomRef().getBoundingClientRect();return{x:(a.pageX||a.originalEvent.pageX)-window.pageXOffset-b.left,y:(a.pageY||a.originalEvent.pageY)-window.pageYOffset-b.top};};A.prototype._hitTest=function(a){var b=this._viewport.getScene();var g=this._viewport.getCamera();var p=a.cursor||this._getXY(a);var i=this._viewport.getDomRef().getBoundingClientRect();var m=new h.Vector2(p.x/i.width*2-1,-p.y/i.height*2+1);var v=new h.Raycaster();v.linePrecision=0;v.setFromCamera(m,g);var x=v.intersectObjects(b.children,true);if(x&&x.length>0){var y=x[0];return{info:y,point:y.point,instance:y.object&&y.object._sapInstance};}else if(this._context.scene){x=this._viewport._mapPlaneIntersect(v);if(x&&x.length>0){return{info:x[0],point:x[0].point};}}return undefined;};A.prototype._extendEventWithInstanceAndCursor=function(a){a.cursor=this._getXY(a);var b=this._hitTest(a);if(b){a.instance=b.instance;a.hitPoint=b.point;}return this;};var u=3;r={onkeydown:function(a){if(!a.originalEvent.repeat){this._handleKeyPress(a);}},oncontextmenu:function(a){j.info("oncontextmenu","",t);this._extendEventWithInstanceAndCursor(a);if(this._skipClick){this._skipClick=false;this._handleHover(a);return;}this._handleContextMenu(a);},onmousedown:function(a){if(this._hoverTimeOutId){clearTimeout(this._hoverTimeOutId);this._hoverTimeOutId=null;}this._mouseDown=true;this._extendEventWithInstanceAndCursor(a);j.info("mousedown","x: "+a.cursor.x+", y: "+a.cursor.y,t);this._lastXY.x=a.cursor.x;this._lastXY.y=a.cursor.y;},onmouseup:function(a){this._mouseDown=false;},onhover:function(a){this._extendEventWithInstanceAndCursor(a);j.trace("hover","x: "+a.cursor.x+", y: "+a.cursor.y,t);if(this._mouseDown){if(Math.abs(this._lastXY.x-a.cursor.x)>u||Math.abs(this._lastXY.y-a.cursor.y)>u){this._skipClick=true;}return;}this._handleHover(a);},onmouseout:function(a){this._extendEventWithInstanceAndCursor(a);delete a.instance;this._handleHover(a);},onBeforeRendering:function(a){if(this._onhoverProxy){this._viewport.$().off(sap.ui.Device.browser.msie||sap.ui.Device.browser.edge?"pointermove":"mousemove",this._onhoverProxy);}if(this._onpointerdownProxy){this._viewport.$().off("pointerdown",this._onpointerdownProxy);}if(this._onpointerupProxy){this._viewport.$().off("pointerup",this._onpointerupProxy);}},onAfterRendering:function(a){if(!this._onhoverProxy){this._onhoverProxy=r.onhover.bind(this);}this._viewport.$().on(sap.ui.Device.browser.msie||sap.ui.Device.browser.edge?"pointermove":"mousemove",this._onhoverProxy);if(sap.ui.Device.browser.msie||sap.ui.Device.browser.edge){if(!this._onpointerdownProxy){this._onpointerdownProxy=r.onmousedown.bind(this);}this._viewport.$().on("pointerdown",this._onpointerdownProxy);if(!this._onpointerupProxy){this._onpointerupProxy=r.onmouseup.bind(this);}this._viewport.$().on("pointerup",this._onpointerupProxy);}if(this._detail.anchor){this._viewport.getDomRef().appendChild(this._detail.anchor);}this._openDetailPending();}};r[sap.ui.Device.browser.msie||sap.ui.Device.browser.edge?"onclick":"ontap"]=function(a){j.info("onclick","",t);this._extendEventWithInstanceAndCursor(a);if(this._skipClick){this._skipClick=false;this._handleHover(a);return;}if(this._clickTimerId){q.sap.clearDelayedCall(this._clickTimerId);this._clickTimerId=null;this._handleDoubleClick(a);}else{this._clickTimerId=q.sap.delayedCall(200,this,function(){this._clickTimerId=null;this._handleClick(a);});}};var w=sap.ui.Device.os.macintosh?"metaKey":"ctrlKey";A.prototype._extendEventWithSelection=function(a){var i=a.instance;if(i){if(a.originalEvent.type==="click"){if(!(a[w]&&a.shiftKey)){var b;var g;if(a[w]){b="toggle";g=false;}else if(a.shiftKey){b="select";g=false;}else{b="select";g=true;}a.selectionChanges=this._changeSelection(i,b,g);}}else{a.selectionChanges=this._changeSelection(i,"toggle",false);}}return this;};A.prototype._changeSelection=function(i,a,b){var g=[];var m=[];var p=i.voGroup;var v=k(i["VB:s"]);var x;if(a==="select"){if(p.maxSel!=="0"){if(v){if(b){x=p.selected.indexOf(i);m=p.selected.splice(x+1).concat(p.selected.splice(0,x));}}else{if(b||p.maxSel==="1"){m=p.selected.splice(0);}p.selected.push(i);g=[i];}}}else if(a==="toggle"){if(v){if(p.minSel==="0"||p.selected.length>1){x=p.selected.indexOf(i);m=p.selected.splice(x,1);}}else if(p.maxSel!=="0"){if(p.maxSel==="1"){m=p.selected.splice(0);}p.selected.push(i);g=[i];}}g.forEach(function(i){i["VB:s"]="true";});m.forEach(function(i){i["VB:s"]="false";});return{selected:g,deselected:m};};A.prototype._applySelectionChangesToScene3D=function(a,b){a.concat(b).forEach(function(i){n(i,this._lastHoverInstance===i);},this);return this;};A.prototype._applyHoverChangesToScene3D=function(i){if(this._lastHoverInstance!==i){if(this._lastHoverInstance){n(this._lastHoverInstance,false);}this._lastHoverInstance=i;if(this._lastHoverInstance){n(this._lastHoverInstance,true);}}return this;};return A;});
