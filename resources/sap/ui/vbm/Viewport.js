/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/core/Control","jquery.sap.global","sap/ui/core/ResizeHandler","./adapter3d/thirdparty/three","./adapter3d/thirdparty/OrbitControls","./adapter3d/Utilities","./library"],function(C,q,R,T,O,U,l){"use strict";var t="sap.ui.vbm.Viewport";var a=q.sap.log;var V=C.extend("sap.ui.vbm.Viewport",{metadata:{library:"sap.ui.vbm",properties:{width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},cameraHistoryLength:{type:"int",defaultValue:0},cameraHistoryPos:{type:"int"}},events:{cameraChange:{parameters:{historyPos:{type:"int"},historyLength:{type:"int"}}}}}});var E=0.000001;var F=0.6;var M=50000.0;var b=85.0;var c=V.getMetadata().getParent().getClass().prototype;V.prototype.init=function(){if(c.init){c.init.call(this);}this._resizeListenerId=null;this._renderLoopRequestId=0;this._renderLoopFunction=this._renderLoop.bind(this);this._renderer=new T.WebGLRenderer({antialias:true});this._renderer.setPixelRatio(window.devicePixelRatio);this._renderer.shadowMap.enabled=true;this._renderer.domElement.tabIndex=-1;this._renderer.domElement.id=this.getId()+"-canvas";this._scene=new T.Scene();this._root=new T.Group();this._root.scale.set(-1,1,1);this._root.rotateX(T.Math.degToRad(90));this._scene.add(this._root);this._mapPlane=new T.Mesh(new T.PlaneGeometry(M,M,1,1),new T.MeshBasicMaterial({color:0x207bad,side:T.DoubleSide,visible:false}));this._mapPlane.name="MapPlane";this._mapPlane.visible=false;this._root.add(this._mapPlane);this._scene.background=new T.Color('white');var g=new T.AmbientLight(0x202020,1);this._scene.add(g);var h=new T.DirectionalLight(0x333333,1);h.position.set(0,0,-1);this._scene.add(h);var i=new T.DirectionalLight(0x51515b,1);i.position.set(-2,-1.1,2.5);this._scene.add(i);var j=new T.DirectionalLight(0x5b5b5b,2);j.position.set(2,1.5,0.5);this._scene.add(j);this._light=new T.DirectionalLight(0xEEEEEE,1);this._lightPos=new T.Vector3(0,0,0);this._scene.add(this._light);this._camera=new T.PerspectiveCamera(30,window.innerWidth/window.innerHeight,0.1,2000);this._scene.add(this._camera);this._camera.position.set(0,30,30);this._camera.lookAt(new T.Vector3(0,0,0));this._cameraHome;this._flyToRequestId;this._resetTimerId;this._cameraHistory=[];this._cameraChangeEvent={};this._bbox=new T.Box3();this._cameraController=new O(this._camera,this._renderer.domElement);this._cameraController.addEventListener("end",this._cameraEnd.bind(this));this._cameraController.addEventListener("change",this._cameraUpdate.bind(this));this._cameraController.update();};V.prototype.exit=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();this._scene=null;this._camera=null;this._renderer=null;if(c.exit){c.exit.call(this);}};V.prototype.getRoot=function(){return this._root;};V.prototype.getScene=function(){return this._scene;};V.prototype.getCamera=function(){return this._camera;};V.prototype.getCameraHistoryLength=function(){return this._cameraHistory.length;};V.prototype.setCameraHistoryLength=function(){a.error("cameraHistoryLength is read only property",t);return this;};V.prototype.setCameraHistoryPos=function(p){if(this._cameraHistory.length>0&&p>=0&&p<this._cameraHistory.length){if(p!==this.getCameraHistoryPos()){this.setProperty("cameraHistoryPos",p,true);delete this._cameraHistory[p].tag;this._fireCameraChange();this._flyTo(this._cameraController.saveState(),this._cameraHistory[p],F);}}return this;};V.prototype.applyCameraHome=function(g){if(this._cameraHome){this._applyCamera(this._cameraHome,g);}};V.prototype.worldToScreen=function(p){var g=this.getDomRef();if(!g){return undefined;}var h=g.getBoundingClientRect();var i=this.getCamera();var m=new T.Matrix4().multiplyMatrices(i.projectionMatrix,new T.Matrix4().getInverse(i.matrixWorld));var s=p.clone().applyMatrix4(m);var x=Math.floor((+s.x*0.5+0.5)*h.width+0.5);var y=Math.floor((-s.y*0.5+0.5)*h.height+0.5);return new T.Vector2(x,y);};V.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();};V.prototype.onAfterRendering=function(){var g=this.getDomRef();g.appendChild(this._renderer.domElement);this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:g.clientWidth,height:g.clientHeight}});this._startRenderLoop();};V.prototype._handleResize=function(g){if(!this._camera||!this._renderer){return false;}var w=g.size.width;var h=g.size.height;if(this._camera){this._camera.aspect=w/h;this._camera.updateProjectionMatrix();}this._renderer.setSize(w,h,false);};V.prototype._startRenderLoop=function(){if(!this._renderLoopRequestId){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);}return this;};V.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=0;}return this;};V.prototype._renderLoop=function(){this._cameraController.update();this._camera.getWorldDirection(this._lightPos);this._lightPos.negate();this._light.position.copy(this._lightPos);this._renderer.render(this._scene,this._camera);this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);};function e(g,s,h,i){return s+h*((g=g/i-1)*g*g+1);}function f(g){var h=Math.min((Date.now()-g.when)/1000,g.length);var i=g.tempTarget;i.x=e(h,g.from.target.x,g.to.target.x-g.from.target.x,g.length);i.y=e(h,g.from.target.y,g.to.target.y-g.from.target.y,g.length);i.z=e(h,g.from.target.z,g.to.target.z-g.from.target.z,g.length);var j=e(h,g.distanceFrom,g.distanceTo-g.distanceFrom,g.length);var k=e(h,0,g.angle,g.length);var p=g.tempPos.copy(g.dir).applyAxisAngle(g.axis,k).multiplyScalar(j).add(i);this._cameraController.reset({position:p,target:i,zoom:1.0});if(h<g.length){this._flyToRequestId=window.requestAnimationFrame(f.bind(this,g));}else{this._flyToRequestId=undefined;}}V.prototype._flyTo=function(g,h,i){var j=h.position.clone().sub(h.target);var k=g.position.clone().sub(g.target);var m=j.length();var n=k.length();var o=Math.acos(U.clamp(k.dot(j)/(m*n),-1,1));var p={to:h,from:g,when:Date.now(),length:i,angle:o,axis:k.clone().cross(j).normalize(),distanceTo:m,distanceFrom:n,dir:k.normalize(),tempPos:new T.Vector3(),tempTarget:new T.Vector3()};if(this._flyToRequestId){window.cancelAnimationFrame(this._flyToRequestId);}this._flyToRequestId=window.requestAnimationFrame(f.bind(this,p));};V.prototype._cameraEnd=function(g){var s=this._cameraController.saveState();var p=this.getCameraHistoryPos();var h=p>=0?this._cameraHistory[p]:undefined;if(h==undefined||s.target.distanceToSquared(h.target)>E||s.position.distanceToSquared(h.position)>E){this._pushCameraChange(s);}};function r(){if(this._cameraHistory.length>0){delete this._cameraHistory[this._cameraHistory.length-1].tag;}this._resetTimerId=undefined;}V.prototype._cameraUpdate=function(g){if(g.tag){if(this._resetTimerId){window.clearTimeout(this._resetTimerId);}this._resetTimerId=window.setTimeout(r.bind(this),500);var s=this._cameraController.saveState();var p=this.getCameraHistoryPos();s.tag=g.tag;var h=p>=0?this._cameraHistory[p]:{};if(s.tag&&s.tag===h.tag){this._cameraHistory[p]=s;}else{this._pushCameraChange(s);}}this._updateCamera();this._updateController();};V.prototype._fireCameraChange=function(){this._cameraChangeEvent.historyPos=this.getCameraHistoryPos();this._cameraChangeEvent.historyLength=this._cameraHistory.length;this.fireCameraChange(this._cameraChangeEvent);};V.prototype._pushCameraChange=function(s){var p=this.getCameraHistoryPos();this._cameraHistory.splice(p>=0?p+1:0,this._cameraHistory.length);this._cameraHistory.push(s);this.setProperty("cameraHistoryPos",this._cameraHistory.length-1,true);this._fireCameraChange();};V.prototype._setCameraHome=function(s){this._cameraHome=s;};V.prototype._applyCamera=function(s,g){var h=this._cameraController.saveState();if(s.target.distanceToSquared(h.target)>E||s.position.distanceToSquared(h.position)>E){this._pushCameraChange(s);if(g){this._flyTo(this._cameraController.saveState(),s,F);}else{this._cameraController.reset(s);}}};V.prototype._getCameraState=function(){return this._cameraController.saveState();};V.prototype._mapPlaneIntersect=function(g){this._mapPlane.visible=true;var o=g.intersectObjects([this._mapPlane],false);this._mapPlane.visible=false;return o;};function d(o,g){var i,p=new T.Vector3(),h=o.geometry;o.updateMatrixWorld(false);if(o.visible&&h){if(h.isGeometry){var v=h.vertices;for(i=0;i<v.length;++i){p.copy(v[i]);p.applyMatrix4(o.matrixWorld);g.expandByPoint(p);}}else if(h.isBufferGeometry){var j=h.attributes.position;if(j){for(i=0;i<j.count;++i){p.fromBufferAttribute(j,i).applyMatrix4(o.matrixWorld);g.expandByPoint(p);}}}}var k=o.children;for(i=0;i<k.length;++i){d(k[i],g);}}V.prototype._resetBBox=function(){this._bbox.makeEmpty();};V.prototype._getBBox=function(){if(this._bbox.isEmpty()){d(this.getScene(),this._bbox);}return this._bbox;};V.prototype._updateCamera=function(){var g=this._getBBox();var s=new T.Sphere();g.getBoundingSphere(s);if(s.radius===0){s.radius=1;}this._camera.updateMatrixWorld(false);s.center.applyMatrix4(this._camera.matrixWorldInverse);var n=U.clamp(-s.center.z-s.radius,s.radius*0.001,-s.center.z-s.radius);var h=n+s.radius*2,i=false;if(Math.abs(this._camera.near-n)>=this._camera.near*0.03){this._camera.near=n;i=true;}if(Math.abs(this._camera.far-h)>=this._camera.far*0.03){this._camera.far=h;i=true;}if(i){this._camera.updateProjectionMatrix();}};V.prototype._updateController=function(){var g=this._cameraController.target.clone().sub(this._camera.position).normalize();var n=new T.Vector3(0,this._camera.position.y>0?1:-1,0);var p=new T.Plane(n),h=new T.Vector3();var i=new T.Ray(this._camera.position,g);if(i.intersectPlane(p,h)){if(T.Math.radToDeg(this._camera.position.clone().sub(h).angleTo(n))<b){this._cameraController.target.copy(h);}}};return V;});
