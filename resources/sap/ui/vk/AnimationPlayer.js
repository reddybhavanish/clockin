/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Element","./Core","./AnimationMath","./AnimationTrackType","./AnimationTrackValueType","./thirdparty/GlMatrixUtils"],function(E,v,A,a,b,g){"use strict";var c=E.extend("sap.ui.vk.AnimationPlayer",{metadata:{associations:{viewStateManager:{type:"sap.ui.vk.ViewStateManagerBase",multiple:false}},events:{viewActivated:{type:"sap.ui.vk.View"},timeChanged:{time:{type:"float"},currentPlayback:{type:"sap.ui.vk.AnimationPlayback"}},stateChanged:{playing:{type:"boolean"},stopped:{type:"boolean"},endOfAnimation:{type:"boolean"}}}}});c.prototype._getViewStateManager=function(){var d=this.getViewStateManager();return d?sap.ui.getCore().byId(d):undefined;};c.prototype.init=function(){this._step=this._step.bind(this);this._playbackCollection=null;this._currentPlayback=null;this._time=0;this._nodeChanges=new Map();v.getEventBus().subscribe("sap.ui.vk","readyForAnimation",this._onViewApplied,this);v.getEventBus().subscribe("sap.ui.vk","sequenceChanged",this._onSequenceChanged,this);v.getEventBus().subscribe("sap.ui.vk","playbacksChanged",this._resetSequenceBoundaryProperties,this);v.getEventBus().subscribe("sap.ui.vk","trackChanged",this._resetSequenceBoundaryProperties,this);v.getEventBus().subscribe("sap.ui.vk","nodeAnimationRemoved",this._onNodeAnimationRemoved,this);};c.prototype.exit=function(){this._playbackCollection=null;this._currentPlayback=null;v.getEventBus().unsubscribe("sap.ui.vk","readyForAnimation",this._onViewApplied,this);v.getEventBus().unsubscribe("sap.ui.vk","sequenceChanged",this._onSequenceChanged,this);v.getEventBus().unsubscribe("sap.ui.vk","playbacksChanged",this._resetSequenceBoundaryProperties,this);v.getEventBus().unsubscribe("sap.ui.vk","trackChanged",this._resetSequenceBoundaryProperties,this);v.getEventBus().unsubscribe("sap.ui.vk","nodeAnimationRemoved",this._onNodeAnimationRemoved,this);};c.prototype._onViewApplied=function(d,e,f){if(f.source.getId()!=this.getViewStateManager()){return;}var h=f.view;var i=f.ignoreAnimationPosition;this.activateView(h,i);};c.prototype._onSequenceChanged=function(d,e,f){if(this._currentPlayback){var h=this._getViewStateManager();var s=this._currentPlayback.getSequence();if(h&&s){if(s.getId()===f.sequenceId){h.setJoints(s.getJoint(),s);}}}var t=this._time;this._setSequenceBoundaryProperties(true);this._time=t;this.setTime(this._time,null,true);};c.prototype._resetSequenceBoundaryProperties=function(d,e,f){var t=this._time;this._setSequenceBoundaryProperties(true);this._time=t;this.setTime(this._time,null,true);};c.prototype._onNodeAnimationRemoved=function(d,e,f){if(this._currentPlayback){var h=this._getViewStateManager();var s=this._currentPlayback.getSequence();if(h&&s){if(s.getId()===f.sequenceId){h.setJoints(s.getJoint(),s);f.nodeRefs.forEach(function(n){if(f.property){h.resetNodeProperty(n,f.property);}else{h.resetNodeProperty(n);h.resetNodeProperty(n,a.Opacity);}});}}}var t=this._time;this._setSequenceBoundaryProperties(true);this._time=t;this.setTime(this._time,null,true);};c.prototype.getAnimatedProperty=function(n,p){var r={};var d=this._getViewStateManager();if(!d){return null;}if(p!==a.Opacity){var w=d.getTransformationWorld(n);if(p===a.Rotate){r.world=w.quaternion;}else if(p===a.Translate){r.world=w.translation;}else{r.world=w.scale;}}var e=this._nodeChanges.get(n);if(!e||e[p]===undefined){r.offsetToPrevious=null;r.offsetToRest=null;if(p===a.Opacity){r.absolute=d.getOpacity(n);r.totalOpacity=d.getTotalOpacity(n);}else{var t=d.getTransformation(n);if(p===a.Rotate){r.absolute=t.quaternion;}else if(p===a.Translate){r.absolute=t.translation;}else{r.absolute=t.scale;}}return r;}if(p===a.Opacity){var o=e[p];r.offsetToRest=o;r.offsetToPrevious=e.offsetToPrevious[p];r.opacity=e.absolute.opacity;r.totalOpacity=e["totalOpacity"];return r;}var f=e[p];r.offset=f;if(p===a.Rotate){r.absolute=e.absolute.quaternion;}else if(p===a.Translate){r.absolute=e.absolute.translate;}else{r.absolute=e.absolute.scale;}r.offsetToPrevious=e.offsetToPrevious[p];r.offsetToRest=e[p];return r;};c.prototype.setTime=function(t,p,d){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){this._currentPlayback=undefined;this._time=0;}else{if(p!=null){t=this._getAbsoluteTime(t,p);}var e=this._getViewStateManager();this._time=t;if(t>=0&&t<=this.getTotalDuration()){var f=this._currentPlayback;var n;if(p!=null){n=this._playbackCollection.getPlayback(p);}else{n=this._findPlaybackByAbsoluteTime(t);}this._currentPlayback=n;if(e&&this._currentPlayback&&f!==this._currentPlayback){var s=this._currentPlayback.getSequence();if(s){e.setJoints(s.getJoint(),s);}}else if(!this._currentPlayback||!this._currentPlayback.getSequence()){e.setJoints(undefined);}}else if(e){e.setJoints(undefined);}if(e){var h={nodeRefs:[],positions:[]};var i=false;if(this._currentPlayback){i=this._currentPlayback.getReversed();}this._collectNodeChanges();this._nodeChanges.forEach(function(j,k){var l=e.addToRestTransformation(k,j.rtranslate,j.rrotate,j.rscale,j.originalRotationType);if(l){h.nodeRefs.push(k);h.positions.push(l);j.absolute={};j.absolute.translate=l.translation;j.absolute.scale=l.scale;j.absolute.quaternion=l.quaternion;}if(j[a.Opacity]!==undefined){var r=e.getRestOpacity(k);if(r===0){var s=this._currentPlayback.getSequence();if(s._convertedFromAbsolute){r=1;}}if(i){var m=e._getEndPropertyInLastSequence(k,a.Opacity);if(m){r/=m;}}e.setOpacity(k,j[a.Opacity]*r);k.userData.animatedOpacity=true;j.absolute={};j.absolute.opacity=j[a.Opacity]*r;j.totalOpacity=e.getTotalOpacity(k);}},this);e.setTransformation(h.nodeRefs,h.positions);e._setJointNodeMatrix();}}if(!d){this.fireTimeChanged({time:this._time,currentPlayback:this._currentPlayback});}return this;};c.prototype.getTime=function(){return this._time;};c.prototype.getCurrentPlayback=function(){return this._currentPlayback;};c.prototype.getCurrentPlaybackTime=function(){var t=this._time;var p=this._playbackCollection.getPlaybacks();if(!Array.isArray(p)||!this.getCurrentPlayback()){return-1;}var i=0;while(p[i]!=this.getCurrentPlayback()){t-=p[i].getDuration();i++;}return t;};c.prototype.getStartTime=function(p){if(!this._playbackCollection){return undefined;}if(typeof p==="number"){p=this._playbackCollection.getPlayback(p);}return p?p.getStartTime():undefined;};c.prototype.getTotalDuration=function(){if(!this._playbackCollection){return 0;}var t=0;this._playbackCollection.getPlaybacks().forEach(function(p){t+=p.getDuration();});return t;};c.prototype._step=function(t){if(!this._lastFrameTimestamp){this._lastFrameTimestamp=t;}var p=t-this._lastFrameTimestamp;this._lastFrameTimestamp=t;var n=this.getTime()+p/1000;var r=n>=0&&n<=this.getTotalDuration();if(n>this.getTotalDuration()){n=this.getTotalDuration();}this.setTime(n);if(r){this._frameId=window.requestAnimationFrame(this._step);}else{this.stop();}};c.prototype._interpolate=function(d,e,t,f){var r={};var q;if(!e.before&&!e.after){return undefined;}else if(!e.before){if(d===b.Euler){r[b.Euler]=[0.0,0.0,0.0];r.value=[0.0,0.0,0.0,1.0];}else if(d===b.AngleAxis){r[b.AngleAxis]=[1.0,0.0,0.0,0.0];r.value=[0.0,0.0,0.0,1.0];}else if(d===b.Quaternion){r.value=[0.0,0.0,0.0,1.0];}else if(f===a.Translate){r.value=[0.0,0.0,0.0];}else if(f===a.Scale){r.value=[1.0,1.0,1.0];}else{r.value=1;}return r;}else if(!e.after){if(d===b.Euler){r[b.Euler]=e.before.value;q=A.neutralEulerToGlMatrixQuat(e.before.value);r.value=A.glMatrixQuatToNeutral(q);}else if(d===b.AngleAxis){r[b.AngleAxis]=e.before.value;q=A.neutralAngleAxisToGlMatrixQuat(e.before.value);r.value=A.glMatrixQuatToNeutral(q);}else if(d===b.Quaternion){q=A.neutralQuatToGlMatrixQuat(e.before.value);r.value=A.glMatrixQuatToNeutral(q);}else{r.value=e.before.value;}return r;}var k=0;if(e.before.time!==e.after.time){k=(e.time-e.before.time)/(e.after.time-e.before.time);}return A.interpolate(d,e.before,e.after,k,t);};c.getBoundaryKey=function(t,i){var d=t.getKeysCount();if(!d){return null;}var e;if(i){e=t.getKey(0);}else{e=t.getKey(d-1);}var f=t.getKeysType();var q,r={};if(f===b.Euler){r[f]=e.value;q=A.neutralEulerToGlMatrixQuat(e.value);r.value=A.glMatrixQuatToNeutral(q);r.time=e.time;}else if(f===b.Quaternion){q=A.neutralQuatToGlMatrixQuat(e.value);r.value=A.glMatrixQuatToNeutral(q);r.time=e.time;}else if(f!==b.AngleAxis){r.value=e.value;r.time=e.time;}else{var h;var k=0;if(i){h=e;if(d>1){h=t.getKey(1);}k=0;}else{h=e;if(d>1){e=t.getKey(d-2);k=1;}}r=A.interpolate(f,e,h,k,t);r.time=i?e.time:h.time;}return r;};c.prototype._getKeyFramesBracket=function(t,d){var k=d.getKeysCount();if(!k){return null;}var r={time:t,before:undefined,after:undefined};for(var i=0;i<k;i++){var e=d.getKey(i);if(e.time===t){r.before=r.after=e;}else if(e.time>t){r.before=(i===0?undefined:d.getKey(i-1));r.after=e;break;}}if(!r.before&&!r.after&&k>0){r.before=d.getKey(k-1);}if(k>1&&(!r.after||!r.before)&&(d.isCycleForward()||d.isCycleBackward())){var f=d.getKey(0).time;var h=d.getKey(k-1).time-f;var j=Math.floor((t-f)/h);var l=t-h*j;return this._getKeyFramesBracket(l,d);}return r;};c.prototype._collectNodeChangesFromSequenceBoundaryKeys=function(n,s,i){var d=s.getNodeAnimation();if(!d){return;}var e=this._getViewStateManager();var f=this._currentPlayback.getSequence();var h=function(k,p,l){if(!k||!p||l===undefined||l===null){return;}var m=n.get(k);if(m&&m.hasOwnProperty(p)){return;}if(!m){m={};n.set(k,m);}if(!m.offsetToPrevious){m.offsetToPrevious={};}if(p===a.Opacity){m[p]=l;if(!m.offsetToPrevious[p]){var o=e.getOpacity(k);var r=e.getRestOpacity(k);if(!r&&s._convertedFromAbsolute){r=1;}if(r>0&&(o!==undefined||o!==null)){if(f){var q=e._getEndPropertyInPreviousSequence(k,p,f);if(q){o/=q;}}m.offsetToPrevious[p]=o/r;}else{m.offsetToPrevious[p]=1;}}}else{m[p]=l.slice();var t=e.getRelativeTransformation(k);if(p===a.Scale){if(!m.offsetToPrevious[p]){m.offsetToPrevious[p]=t.scale.slice();if(f){var u=e._getEndPropertyInPreviousSequence(k,p,f);if(u){m.offsetToPrevious[p][0]/=u[0];m.offsetToPrevious[p][1]/=u[1];m.offsetToPrevious[p][2]/=u[2];}}}}if(p===a.Translate){if(!m.offsetToPrevious[p]){m.offsetToPrevious[p]=t.translation.slice();if(f){var w=e._getEndPropertyInPreviousSequence(k,p,f);if(w){m.offsetToPrevious[p][0]-=w[0];m.offsetToPrevious[p][1]-=w[1];m.offsetToPrevious[p][2]-=w[2];}}}}else if(!m.offsetToPrevious[p]){m.offsetToPrevious[p]=[0,0,0];}}};var j;if(i){j=s._getNodeEndPropertiesMap();}else{j=s._getNodeStartPropertiesMap();}if(!j){return;}j.forEach(function(k,l){for(var p in k){if(f._isNodePropertyDefined(l,p)){continue;}h(l,p,k[p]);}},this);};c.prototype._collectNodeChangesFromPlaybackBoundaryKeys=function(n,p,i){var s=p.getSequence();if(!s){return;}this._collectNodeChangesFromSequenceBoundaryKeys(n,s,i);};c.prototype._collectSequenceNodeChanges=function(t,n,s,i){var d=s.getNodeAnimation();if(!d){return;}var e=this._getViewStateManager();var f=function(h,p,r,j){if(!h||!p||!r||r.value===undefined||r.value===null){return;}var k=n.get(h);if(!k){k={};n.set(h,k);}if(!k.animationProperties){k.animationProperties={};}k.animationProperties[p]=true;if(j){k.originalRotationType=j;}if(!k.offsetToPrevious){k.offsetToPrevious={};}var o=e._getEndPropertyInPreviousSequence(h,p,s);if(p===a.Opacity){k[p]=r.value;k.offsetToPrevious[p]=r.value;if(o){k[p]*=o;}}else{k[p]=r.value.slice();k.offsetToPrevious[p]=r.value.slice();if(o){if(p===a.Translate){k[p][0]+=o[0];k[p][1]+=o[1];k[p][2]+=o[2];}else if(p===a.Scale){k[p][0]*=o[0];k[p][1]*=o[1];k[p][2]*=o[2];}}}if(j===b.Euler||j===b.AngleAxis){k[j]=r[j].slice();k.offsetToPrevious[p]=r[j].slice();if(j===b.Euler&&o){var l=A.neutralQuatToGlMatrixQuat(o);var m=A.neutralQuatToGlMatrixQuat(k[p]);var q=g.quat.multiply(g.quat.create(),m,l);k[p]=A.glMatrixQuatToNeutral(q);}}};d.forEach(function(h){var k;for(var j in a){var l=a[j];var m=h[l];if(m&&m.getKeysCount()&&(!i||(i&&m.isInfinite()))){k=this._getKeyFramesBracket(t,m);if(!k){return;}var o=m.getKeysType();var r=this._interpolate(o,k,m,l);if(l===a.Rotate){f(h.nodeRef,l,r,o);}else{f(h.nodeRef,l,r);}}}},this);};c.prototype._collectPlaybackNodeChanges=function(d,n,p){var s=p.getSequence();if(!s){return;}var t=d-p.getStartTime();if(t<0){return;}var e=s.getDuration()*p.getTimeScale()*p.getRepeats();var f=(t-p.getPreDelay())/p.getTimeScale();var h=0.0001;if(f>0&&f%s.getDuration()===0){f=s.getDuration();}else if(f>s.getDuration()+h){f=f%s.getDuration();}else if(f>s.getDuration()){f=s.getDuration();}f=p.getReversed()?p.getSequence().getDuration()-f:f;if(t<p.getPreDelay()){}else if(t>p.getPreDelay()+e+h){this._collectSequenceNodeChanges(f,n,p.getSequence(),true);}else{this._collectSequenceNodeChanges(f,n,p.getSequence(),false);}};c.prototype._collectNodeChanges=function(){this._nodeChanges.clear();if(!this._currentPlayback){return;}var p=this._playbackCollection.getPlaybacks();var d=this.getTime();var i;var e=0;for(i=0;i<p.length;i++){if(this._currentPlayback&&this._currentPlayback!==p[i]){continue;}this._collectPlaybackNodeChanges(d,this._nodeChanges,p[i]);e=i;}if(!this._currentPlayback.getReversed()){for(i=e-1;i>=0;i--){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,p[i],true);}for(i=e+1;i<p.length;i++){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,p[i],false);}}else{for(i=e+1;i<p.length;i++){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,p[i],false);}for(i=e-1;i>=0;i--){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,p[i],true);}}};c.prototype._setSequenceBoundaryProperties=function(f){if(!this._playbackCollection){return;}var p=this._playbackCollection.getPlaybacks();var n=false;if(p&&p.length&&p[0].getReversed()){n=true;this._playbackCollection.setPlaybacksReversed(false,true);}var i;var t=0;var d,s;if(f){for(i=0;i<p.length;i++){d=p[i];if(!d){continue;}s=d.getSequence();if(s){s._clearNodesBoundaryProperties();}}}for(i=0;i<p.length;i++){d=p[i];if(!d){continue;}var e=this._getViewStateManager();s=d.getSequence();if(e&&s){if(!f&&s._hasCompleteNodesBoundaryProperties()){continue;}t=d.getPreDelay();this.setTime(t,i,true);s._setCurrentNodesPropertiesAsBoundary(e,false,f);t+=s.getDuration();this.setTime(t,i,true);s._setCurrentNodesPropertiesAsBoundary(e,true,f);}}if(n){this._playbackCollection.setPlaybacksReversed(true,true);}};c.prototype.play=function(){this._lastFrameTimestamp=undefined;this._frameId=window.requestAnimationFrame(this._step);v.getEventBus().publish("sap.ui.vk","animationPlayStateChanged",{source:this,view:this._playbackCollection,playing:true,stopped:false,endOfAnimation:false});this.fireStateChanged({playing:true,stopped:false});return this;};c.prototype.stop=function(){if(this._frameId){window.cancelAnimationFrame(this._frameId);this._frameId=undefined;}this._lastFrameTimestamp=undefined;this.fireStateChanged({playing:false,stopped:true,endOfAnimation:this.getTime()>=this.getTotalDuration()});v.getEventBus().publish("sap.ui.vk","animationPlayStateChanged",{source:this,view:this._playbackCollection,playing:false,stopped:true,endOfAnimation:this.getTime()>=this.getTotalDuration()});return this;};c.prototype.activateView=function(d,p){this.stop();var e=this._getViewStateManager();var f=d.getPlaybacks();if(f&&f.length>0){for(var i=0;i<f.length;i++){var h=f[i];var s=h.getSequence();if(s){e._convertTracksToRelative(s,h.getReversed());}}}if(!p){this._playbackCollection=d;}else{this._playbackCollection=undefined;}this._setSequenceBoundaryProperties();this._currentPlayback=undefined;this.setTime(0);if(p){this._playbackCollection=d;}this.fireViewActivated({view:d});return this;};c.prototype._getAbsoluteTime=function(t,p){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){return-1;}var d=this._playbackCollection.getPlaybacks();if(p<0||p>=d.length){return-1;}var e=this._playbackCollection.getPlayback(p);if(!e||e.getDuration()<t||t<0){return-1;}var f=t;var i=0;while(i<p){var h=d[i].getDuration();f+=h;i++;}return f;};c.prototype._findPlaybackByAbsoluteTime=function(t){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){return undefined;}var p=this._playbackCollection.getPlaybacks();var l=-1;var d=-1;p.forEach(function(f,h){if(f.getStartTime()>d){l=h;d=f.getStartTime();}});var i=0;while(i<p.length){var e=p[i].getDuration();var s=p[i].getStartTime();if((i!==l&&t>=s&&t<(s+e))||(i===l&&t>=s&&t<=(s+e))){return p[i];}i++;}return undefined;};return c;});
