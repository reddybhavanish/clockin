/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../NodeHierarchy","sap/ui/base/ObjectPool","./BaseNodeProxy","./NodeProxy","./LayerProxy","../Messages","../DvlException","./checkResult","./getJSONObject","../getResourceBundle"],function(q,N,O,B,a,L,M,D,c,g,b){"use strict";var l=q.sap.log;var s={modeDictionary:{equals:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_EQUAL:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_EQUAL_CASE_INSENSITIVE;},contains:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_SUBSTRING:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_SUBSTRING_CASE_INSENSITIVE;},startsWith:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_STARTS_WITH:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_STARTS_WITH_CASE_INSENSITIVE;}}};var d=N.extend("sap.ui.vk.dvl.NodeHierarchy",{metadata:{},_baseNodeProxyPool:new O(B),constructor:function(e){N.call(this);this._graphicsCore=e.getGraphicsCore();this._scene=e;this._dvlSceneRef=this._scene.getSceneRef();this._dvl=this._graphicsCore._getDvl();this._nodeProxies=[];this._layerProxies=[];}});d.prototype.destroy=function(){this._layerProxies.slice().forEach(this.destroyLayerProxy,this);this._nodeProxies.slice().forEach(this.destroyNodeProxy,this);this._dvl=null;this._dvlSceneRef=null;this._scene=null;this._graphicsCore=null;N.prototype.destroy.call(this);};d.prototype.getGraphicsCore=function(){return this._graphicsCore;};d.prototype.getScene=function(){return this._scene;};d.prototype.getSceneRef=function(){return this._dvlSceneRef;};d.prototype.enumerateChildren=function(n,e,f,p){if(typeof n==="function"){p=f;f=e;e=n;n=undefined;}var h;if(n){if(f||(g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_CLOSED)===0){h=g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN)).ChildNodes;}else{h=[];}}else{h=g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN)).ChildNodes;}if(p){h.forEach(e);}else{var i=this._baseNodeProxyPool.borrowObject();try{h.forEach(function(n){i.init(this,n);e(i);i.reset();}.bind(this));}finally{this._baseNodeProxyPool.returnObject(i);}}return this;};d.prototype.enumerateAncestors=function(n,e,p){var f=g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_PARENTS)).ParentNodes;if(p){f.forEach(e);}else{var h=this._baseNodeProxyPool.borrowObject();try{f.forEach(function(n){h.init(this,n);e(h);h.reset();}.bind(this));}finally{this._baseNodeProxyPool.returnObject(h);}}return this;};d.prototype.createNodeProxy=function(n){var e=new a(this,n);this._nodeProxies.push(e);return e;};d.prototype.destroyNodeProxy=function(n){var i=this._nodeProxies.indexOf(n);if(i>=0){this._nodeProxies.splice(i,1)[0].destroy();}return this;};d.prototype.getChildren=function(n,e){if(typeof n==="boolean"){e=n;n=undefined;}if(n){if(e||(g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_CLOSED)===0){return g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN)).ChildNodes;}else{return[];}}else{return g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN)).ChildNodes;}};d.prototype.getAncestors=function(n){return g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_PARENTS)).ParentNodes;};d.prototype.findNodesByName=function(e){var f=sap.ve.dvl.DVLFINDNODETYPE.DVLFINDNODETYPE_NODE_NAME,h=[],j,k;if(e===undefined||e===null||q.isEmptyObject(e)){j=s.modeDictionary.contains(false);k=[""];}else{if(e.value===undefined||e.value===null||e.value===""){q.sap.log.error(b().getText(M.VIT6.summary),M.VIT6.code,"sap.ui.vk.dvl.NodeHierarchy");return[];}var p=e.hasOwnProperty("predicate")?e.predicate:"equals";if(p===undefined||p===null||p===""){q.sap.log.error(b().getText(M.VIT7.summary),M.VIT7.code,"sap.ui.vk.dvl.NodeHierarchy");return[];}else if(["equals","contains","startsWith"].indexOf(p)===-1){q.sap.log.error(b().getText(M.VIT8.summary),M.VIT8.code,"sap.ui.vk.dvl.NodeHierarchy");return[];}j=s.modeDictionary[p](e.caseSensitive);k=(typeof e.value==="string")?[e.value]:e.value;}for(var i=0;i<k.length;i++){h=h.concat(g(this._dvl.Scene.FindNodes(this._dvlSceneRef,f,j,k[i])).nodes);}return q.sap.unique(h);};d.prototype.createLayerProxy=function(e){var f=new L(this,e);this._layerProxies.push(f);return f;};d.prototype.destroyLayerProxy=function(e){var i=this._layerProxies.indexOf(e);if(i>=0){this._layerProxies.splice(i,1)[0].destroy();}return this;};d.prototype.getLayers=function(){return g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_LAYERS)).Layers;};d.prototype.getHotspotNodeIds=function(){var h=g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_HOTSPOTS).ChildNodes);return h.length>0?h:this._getLegacyHotspotNodeIds();};d.prototype._getLegacyHotspotNodeIds=function(){var e=this.getLayers(),h=[];for(var i=0;i<e.length;i++){var f=this.createLayerProxy(e[i]),j=f.getName();if(j.toLowerCase()==="hotspots"){h=f.getNodes();this.destroyLayerProxy(f);break;}this.destroyLayerProxy(f);}return h;};d.prototype.createNode=function(p,n,i){var e=this._dvl.Scene.CreateNode(this._dvlSceneRef,p,n,i);this.fireNodeCreated({nodeRef:e,nodeId:e});this.fireChanged();return e;};d.prototype.createNodeCopy=function(n,p,e,i){var f=this._dvl.Scene.CreateNodeCopy(this._dvlSceneRef,n,p,sap.ve.dvl.DVLCREATENODECOPYFLAG.COPY_CHILDREN,e,i);this.fireNodeCreated({nodeRef:f,nodeId:f});this.fireChanged();return f;};d.prototype.removeNode=function(n){var f=[].concat(n);f.forEach(function(n){this.fireNodeRemoving({nodeRef:n,nodeId:n});try{c(this._dvl.Scene.DeleteNode(this._dvlSceneRef,n));}catch(e){var m="Failed to delete node with ID = "+n+".";if(e instanceof D){m+=" Error code: "+e.code+". Message: "+e.message+".";}l.error(m);}}.bind(this));this.fireChanged();return this;};return d;});
