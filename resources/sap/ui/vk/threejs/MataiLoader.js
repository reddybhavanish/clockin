/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/ui/base/ManagedObject","../getResourceBundle","./SceneBuilder","../helpers/WorkerScriptLoader"],function(L,M,g,S,W){"use strict";var P={FinishedTree:g().getText("SCENE_CONTEXT_FINISHED_TREE"),LoadingGeometries:g().getText("SCENE_CONTEXT_LOADING_GEOMETRIES"),LoadingTextures:g().getText("SCENE_CONTEXT_LOADING_TEXTURES"),LoadingModelViews:g().getText("SCENE_CONTEXT_LOADING_MODEL_VIEWS")};var a=M.extend("sap.ui.vk.threejs.MataiLoader",{metadata:{events:{contentChangesProgress:{parameters:{source:"any",phase:"string",percent:"float"}}}}});function u(s){var p=s._progress;var c=40+60*(p.totalCount?p.count/p.totalCount:1);s._loader.fireContentChangesProgress({source:s._countentResource.getSource(),phase:p.phase,percentage:Math.min(c,100)});}var b=(function(){var p;return function(){return p||(p=new Promise(function(r,c){var w=W.loadScript("sap/ui/vk/threejs/MataiLoaderWorker.js",["sap/ui/vk/threejs/thirdparty/matai.js"]);w.onmessage=function(e){var f=e.data;if(f.ready){r(w);}else{var s=S.getById(f.sceneBuilderId);s[f.method].apply(s,f.args);switch(f.method){case"setScene":var i=f.args[0];s._progress={phase:P.FinishedTree,totalCount:i.meshCount+i.imageCount+i.modelViewCount,count:0};u(s);break;case"setGeometry":if(s._progress){s._progress.phase=P.LoadingGeometries;s._progress.count++;u(s);}break;case"createImage":if(s._progress){s._progress.phase=P.LoadingTextures;s._progress.count++;u(s);}break;case"createThumbnail":if(s._progress){s._progress.phase=P.LoadingModelViews;s._progress.count++;u(s);}break;default:break;}}};w.onerror=function(e){c(e);};var d=W.absoluteUri("sap/ui/vk/threejs/thirdparty").toString()+"/";w.postMessage({method:"createRuntime",scriptDirectory:d});}));};})();function l(c,d,e,p,f,r,h){b().then(function(w){w.onerror=function(i){L.error("Error in WebWorker",i);h(g().getText("LOADER_ERRORREADINGFILE"));};var s=new S(p,f,r,h,c);s._loader=c;w.postMessage({method:"loadSceneFromArrayBuffer",sceneBuilderId:s.getId(),buffer:d,fileName:e,sourceLocation:"remote"},[d]);},function(i){h(i);});}a.prototype.load=function(p,c){var t=this;return new Promise(function(r,d){if(typeof c.getSource()==="string"){var f=c.getSource();fetch(f).then(function(e){if(e.ok){return e.arrayBuffer();}throw(new Error(e.statusText));}).then(function(e){l(t,e,f,p,c,r,d);}).catch(function(e){d(e);});}else if(c.getSource()instanceof File){var h=new FileReader();h.onload=function(e){l(t,e.target.result,c.getSource().name,p,c,r,d);};h.onerror=function(e){d(e);};h.readAsArrayBuffer(c.getSource());}});};return a;});
