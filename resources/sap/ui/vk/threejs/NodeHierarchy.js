/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../NodeHierarchy","sap/ui/base/ObjectPool","./BaseNodeProxy","./NodeProxy","../Messages","../getResourceBundle","../NodeContentType","sap/base/util/uid"],function(q,N,O,B,a,M,g,b,u){"use strict";var s={equals:function(d,e){return d===e;},contains:function(d,e){return d.indexOf(e)!==-1;},startsWith:function(d,e){return d.indexOf(e)===0;}};var c=N.extend("sap.ui.vk.threejs.NodeHierarchy",{metadata:{},_baseNodeProxyPool:new O(B),constructor:function(d){N.call(this);this._scene=d;this._nodeProxies=[];}});c.prototype.destroy=function(){this._nodeProxies.slice().forEach(this.destroyNodeProxy,this);this._scene=null;N.prototype.destroy.call(this);};c.prototype.getScene=function(){return this._scene;};c.prototype.getSceneRef=function(){return this._scene.getSceneRef();};c.prototype.enumerateChildren=function(n,d,e,p){if(typeof n==="function"){p=e;e=d;d=n;n=undefined;}var f=this.getChildren(n,e);if(p){f.forEach(d);}else{var h=this._baseNodeProxyPool.borrowObject();try{f.forEach(function(n){h.init(this,n);d(h);h.reset();}.bind(this));}finally{this._baseNodeProxyPool.returnObject(h);}}return this;};c.prototype.enumerateAncestors=function(n,d,p){var e=this.getAncestors(n);if(p){e.forEach(d);}else{var f=this._baseNodeProxyPool.borrowObject();try{e.forEach(function(n){f.init(this,n);d(f);f.reset();}.bind(this));}finally{this._baseNodeProxyPool.returnObject(f);}}return this;};c.prototype.createNodeProxy=function(n){var d=new a(this,n);this._nodeProxies.push(d);return d;};c.prototype.destroyNodeProxy=function(n){var i=this._nodeProxies.indexOf(n);if(i>=0){this._nodeProxies.splice(i,1)[0].destroy();}return this;};c.prototype.getChildren=function(n,d){if(typeof n==="boolean"){d=n;n=undefined;}if(!n){n=this._scene.getSceneRef();}var e=[];if(d||!n.userData.closed){n.children.forEach(function(f){if(!f.private&&(f.geometry===undefined||f.layers!==n.layers)){e.push(f);}});}return e;};c.prototype.getAncestors=function(n){var d=[];n.traverseAncestors(function(p){d.unshift(p);});if(d.length>0&&d[0]===this._scene.getSceneRef()){d.shift();}return d;};c.prototype.findNodesByName=function(d){var r=[];if(d===undefined||d===null||d===""||q.isEmptyObject(d)){this._scene.getSceneRef().children.forEach(function(h){h.traverse(function(o){if(!o.private&&(o.geometry===undefined||o.layers!==o.parent.layers)){r.push(o);}});});}else{var e=s[d.predicate||"equals"];if(e===undefined){q.sap.log.error(g().getText(M.VIT8.summary),M.VIT8.code,"sap.ui.vk.threejs.NodeHierarchy");}else if(!Array.isArray(d.value)&&typeof d.value!=="string"){q.sap.log.error(g().getText(M.VIT6.summary),M.VIT6.code,"sap.ui.vk.threejs.NodeHierarchy");}else{var f=Array.isArray(d.value)?d.value:[d.value];if(!d.caseSensitive){for(var i in f){f[i]=f[i].toLowerCase();}}this._scene.getSceneRef().children.forEach(function(h){h.traverse(function(o){if(!o.private&&(o.geometry===undefined||o.layers!==o.parent.layers)){var n=o.name||"";if(!d.caseSensitive){n=n.toLowerCase();}for(var i in f){if(e(n,f[i])){r.push(o);break;}}}});});}}return r;};c.prototype.createLayerProxy=function(l){return null;};c.prototype.destroyLayerProxy=function(l){return this;};c.prototype.getLayers=function(){return[];};c.prototype.getHotspotNodeIds=function(){return null;};c.prototype.attachChanged=function(d,f,l){return this.attachEvent("changed",d,f,l);};c.prototype.detachChanged=function(d,f,l){return this.detachEvent("changed",d,f,l);};c.prototype.fireChanged=function(p,d,e){return this.fireEvent("changed",p,d,e);};c.prototype.attachNodeCreated=function(d,f,l){return this.attachEvent("nodeCreated",d,f,l);};c.prototype.detachNodeCreated=function(d,f,l){return this.detachEvent("nodeCreated",d,f,l);};c.prototype.fireNodeCreated=function(p,d,e){return this.fireEvent("nodeCreated",p,d,e);};c.prototype.attachNodeRemoving=function(d,f,l){return this.attachEvent("nodeRemoving",d,f,l);};c.prototype.detachNodeRemoving=function(d,f,l){return this.detachEvent("nodeRemoving",d,f,l);};c.prototype.fireNodeRemoving=function(p,d,e){return this.fireEvent("nodeRemoving",p,d,e);};c.prototype.attachNodeReplaced=function(d,f,l){return this.attachEvent("nodeReplaced",d,f,l);};c.prototype.detachNodeReplaced=function(d,f,l){return this.detachEvent("nodeReplaced",d,f,l);};c.prototype.fireNodeReplaced=function(p,d,e){return this.fireEvent("nodeReplaced",p,d,e);};c.prototype.attachNodeUpdated=function(d,f,l){return this.attachEvent("nodeUpdated",d,f,l);};c.prototype.detachNodeUpdated=function(d,f,l){return this.detachEvent("nodeUpdated",d,f,l);};c.prototype.fireNodeUpdated=function(p,d,e){return this.fireEvent("nodeUpdated",p,d,e);};c.prototype.createNode=function(p,n,i,d,e){var f=this.getScene().getSceneBuilder();var o=null;if(f){e=e||{};e.name=e.name||n;e.sid=e.sid||u();o=f.createNode(e);if(!p){p=o.parent;}}else{if(!p){p=this._scene.getSceneRef();}o=new THREE.Group();o.name=n;p.add(o);}var h=p.children.indexOf(i);if(h>=0){p.children.splice(h,0,p.children.pop());}if(d){o._vkSetNodeContentType(d);}else{o._vkSetNodeContentType(b.Regular);}if(e&&f){switch(o._vkGetNodeContentType()){case b.Annotation:e.node=o;e.nodeId=o._vkPersistentId();f.createAnnotation(e);break;default:}}this.fireNodeCreated({nodeRef:o,nodeId:o});this.fireChanged();return o;};c.prototype.getNodeContentType=function(n){if(n==null){return b.Regular;}var d=n._vkGetNodeContentType();if(!d){d=b.Regular;}return d;};c.prototype.createNodeCopy=function(n,p,d,i){if(!p){p=this._scene.getSceneRef();}var e=p.children.indexOf(i);var f=n.clone(true);f.name=d;p.add(f);if(e>=0){p.children.splice(e,0,p.children.pop());}this.fireNodeCreated({nodeRef:f,nodeId:f});this.fireChanged();return f;};c.prototype.removeNode=function(n){var d=[].concat(n);d.forEach(function(n){if(n&&n.parent){this.fireNodeRemoving({nodeRef:n,nodeId:n});n.parent.remove(n);}}.bind(this));var e=this.getScene().getSceneBuilder();if(e){e.removeNode(n);}this.fireChanged();return this;};return c;});
