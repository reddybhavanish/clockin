/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./thirdparty/three","sap/base/Log","./BBoxSubdivider","./UsageCounter","../totara/TotaraUtils","./OrthographicCamera","./PerspectiveCamera","./DetailView","./AnimationHelper","./Thrustline","../View","./Billboard","./Callout","../BillboardCoordinateSpace","../BillboardTextEncoding","../BillboardStyle","../BillboardBorderLineStyle","../BillboardHorizontalAlignment","../LeaderLineMarkStyle","../DetailViewType","../DetailViewShape","../AnimationPlayback","../AnimationRotateType","../RenderMode","./Material","../ObjectType","../getResourceBundle","./MarchingCubes","../NodeContentType","./ThreeExtensions","../thirdparty/ie-polyfills","sap/base/util/uid"],function(q,t,L,B,U,T,O,P,D,A,a,V,b,C,c,d,f,g,h,n,o,p,r,s,R,M,u,v,w,N,x,y,z){"use strict";var S=function(e,i,j,k){this._id=S._nextId++;S._add(this);this._callouts=new Map();this._cameras=new Map();this._images=new Map();this._imageIdsAndTileWidths=new Map();this._imageTextures=new Map();this._geometries=new Map();this._meshNodes=new Map();this._meshSubmeshes=new Map();this._geometryMeshes=new Map();this._materialMeshes=new Map();this._materialClones=new Map();this._joints=[];this._annotations=new Map();if(e){this._rootNode=e;this._nodes=new Map();this._tracks=new Map();this._trackIdSequenceNodeMap=new Map();this._viewGroups=new Map();this._views=new Map();}else{this._rootNode=null;this._nodes=null;this._tracks=null;this._trackIdSequenceNodeMap=null;this._viewGroups=null;this._views=null;}this._currentSceneId=null;this._sceneIdTreeNodesMap=new Map();this._sceneIdRootNodeMap=new Map();this._sceneIdViewGroupMap=new Map();this._sceneIdViewMap=new Map();this._animationHelper=new A(this);if(i){this._countentResource=i;var l=i.getNodeProxy();var m=l.getNodeHierarchy();this._vkScene=m.getScene();var l1=i.getSource();if(l1&&l1.name){this._sceneIdTreeNodesMap.set(l1.name,this._nodes);this._sceneIdRootNodeMap.set(l1.name,e);this._sceneIdViewGroupMap.set(l1.name,this._viewGroups);this._sceneIdViewMap.set(l1.name,this._views);this._currentSceneId=l1.name;}if(this._rootNode){if(!this._rootNode.userData){this._rootNode.userData={};}this._rootNode.userData.skipIt=!i.name;}}this._viewThumbnails=new Map();this._thrustlines=new Map();this._animations=new Map();this._animationTracks=new Map();this._jointNodesMap=new Map();this._jointParentsMap=new Map();this._resolve=j;this._reject=k;};S._nextId=1;S._map=new Map();S.prototype.getId=function(){return this._id;};S.getById=function(i){return this._map.get(i);};S._add=function(e){S._map.set(e.getId(),e);return this;};var E=[R.Default,R.Default,R.Default,R.LineIllustration,R.SolidOutline,R.ShadedIllustration];S.prototype.setScene=function(i){if(i.result!==1){var e={status:i.result};switch(i.result){case-1:e.errorText=v().getText("LOADER_FILENOTFOUND");break;case-2:e.errorText=v().getText("LOADER_WRONGFILEFORMAT");break;case-3:e.errorText=v().getText("LOADER_WRONGPASSWORD");break;case-4:e.errorText=v().getText("LOADER_ERRORREADINGFILE");break;case-5:e.errorText=v().getText("LOADER_FILECONTENT");break;default:e.errorText=v().getText("LOADER_UNKNOWNERROR");}this._reject(e);}else{this._vkScene.setSceneBuilder(this);var j=this._cameras.get(i.cameraId);this._resolve({node:this._parentNode,camera:j,backgroundTopColor:i.backgroundTopColor,backgroundBottomColor:i.backgroundBottomColor,upAxis:i.upAxis,annotations:this._annotations,contentResource:this._contentResource,builder:this});}};S.prototype.setRootNode=function(e,i,j,k){this._rootNode=e;this._nodes=new Map();this._nodes.set(i,e);if(!this._rootNode.userData){this._rootNode.userData={};}this._tracks=new Map();this._trackIdSequenceNodeMap=new Map();this._sequenceIdToPlaybacks=new Map();this._viewGroups=new Map();this._views=new Map();if(j){this._sceneIdTreeNodesMap.set(j,this._nodes);this._sceneIdRootNodeMap.set(j,e);this._sceneIdViewGroupMap.set(j,this._viewGroups);this._sceneIdViewMap.set(j,this._views);this._currentSceneId=j;}if(k){this._vkScene=k;}return this;};S.prototype._resetCurrentScene=function(e){if(e&&e!==this._currentSceneId){var i=this._sceneIdTreeNodesMap.get(e);if(i){this._nodes=i;}else{this._nodes=null;}var j=this._sceneIdRootNodeMap.get(e);if(j){this._rootNode=j;}else{this._rootNode=null;}this._currentSceneId=e;}};S.prototype.getNode=function(e,i){if(i){this._resetCurrentScene(i);if(this._nodes){return this._nodes.get(e);}}else{var j=this._sceneIdTreeNodesMap.values();var k=j.next();while(!k.done){var l=k.value.get(e);if(l){return l;}k=j.next();}}return null;};S.prototype.hasMesh=function(m){return this._meshSubmeshes.has(m);};S.prototype.hasImage=function(i){return this._images.has(i);};S.prototype.setNodePersistentId=function(e,i,j){if(!e.userData.treeNode){e.userData.treeNode={};}var k=null;if(e.userData.treeNode.sid){k=e.userData.treeNode.sid;delete(e.userData.treeNode.sid);}this._resetCurrentScene(j);e.userData.treeNode.sid=i;if(this._nodes){if(k){this._nodes.delete(k);}this._nodes.set(i,e);return true;}return false;};S.prototype.setAnnotationPersistentId=function(e,i,j){this._resetCurrentScene(j);if(this._annotations){var k=this._annotations.get(e.id);if(k){this._annotations.delete(e.id);k.annotation.id=i;this._annotations.set(i,k);return true;}}return false;};var F=function(e){var m=new THREE.Matrix4();if(e.length===3){m.setPosition(new THREE.Vector3().fromArray(e));}else if(e.length===12){m.set(e[0],e[3],e[6],e[9],e[1],e[4],e[7],e[10],e[2],e[5],e[8],e[11],0.0,0.0,0.0,1.0);}else if(e.length===16){m.set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]);}else{throw"Invalid matrix format";}return m;};var G={r:0.0235,g:0.0235,b:0.0235};var H={r:0.0602,g:0.0602,b:0.0602};S.prototype._createTemporaryMaterial=function(m){var e=new M();var i=e.getMaterialRef();i.userData.defaultHighlightingEmissive=G;i.userData.defaultHighlightingSpecular=H;i.userData.materialUsed=0;i.userData.materialId=m;i.userData.toBeUpdated=true;this._vkScene.setMaterial(m,e);return i;};S.prototype._getMaterialRef=function(m){var e=this._vkScene.getMaterial(m);return e?e.getMaterialRef():null;};S.prototype.checkMaterialExists=function(m,e){if(this._getMaterialRef(m)===null){if(e){this._createTemporaryMaterial(m);}return false;}return true;};S.prototype._attachMaterialClone=function(m,e){T.pushElementIntoMapArray(this._materialClones,m,e);};S.prototype._addDynamicObject=function(e,i,j){var k=this._rootNode.userData;if(!k._vkDynamicObjects){k._vkDynamicObjects=[];}if(k._vkDynamicObjects.indexOf(e)<0){k._vkDynamicObjects.push(e);}e._vkUpdate=i;if(j){e.userData.is2D=true;}};S.prototype.createNode=function(e,j){this._resetCurrentScene(j);var k=new THREE.Group();this._nodes.set(e.sid,k);var i;var l=this._jointNodesMap.get(e.sid);if(l&&l.length){for(i=0;i<l.length;i++){l[i].node=k;}}var m=this._jointParentsMap.get(e.sid);if(m&&m.length){for(i=0;i<m.length;i++){m[i].parent=k;}}var l1=this._nodes.get(e.parentId);(l1||this._rootNode).add(k);var m1=k.userData;m1.treeNode=e;if(e.closed){m1.closed=true;}if(e.selectable===false){m1.selectable=false;}if(e.visualisable===false){m1.skipIt=true;}if(e.metadata){m1.metadata=e.metadata;}if(e.veids){m1.veids=e.veids;}if(e.sid){m1.nodeId=e.sid;}if(e.name){k.name=e.name;}if(e.visible!==undefined){k.layers.mask=e.visible?(1|0):0;}if(l1&&l1.name&&k.name&&k.name===l1.name+" offset geometry"){k.layers=l1.layers;}else{var n1=l1;while(n1){if(n1.userData.closed){k.layers=n1.layers;break;}n1=n1.parent;}}if(j){var o1=l1;while(o1){if((o1.layers.mask&1)===0){k.layers.mask&=~1;break;}o1=o1.parent;}}if(e.renderOrder){k.renderOrder=e.renderOrder;}m1.opacity=e.opacity;if(e.transform){k.applyMatrix(F(e.transform));if(!isFinite(k.quaternion.x)||!isFinite(k.quaternion.y)||!isFinite(k.quaternion.z)||!isFinite(k.quaternion.w)){k.quaternion.set(0,0,0,1);}}k.updateMatrixWorld(true);if(e.transformType){m1.transformType=e.transformType;switch(e.transformType){case"ORTHO2D":m1.originalTransform={p:k.position.clone(),q:k.quaternion.clone(),s:k.scale.clone()};this._addDynamicObject(k,b.prototype._ortho2DUpdate,true);break;case"BILLBOARD_VIEW":this._addDynamicObject(k,b.prototype._billboardViewUpdate,false);break;case"LOCK_TOVIEWPORT":this._addDynamicObject(k,b.prototype._lockToViewportUpdate,true);break;default:break;}}if(e.materialId){m1.materialId=e.materialId;}if(e.meshId){this.setMeshNode(e.sid,e.meshId);}if(k.parent.userData.objectType===u.Hotspot){m1.objectType=u.Hotspot;}else if(k.parent.userData.objectType===u.PMI){m1.objectType=u.PMI;}else if(e.contentType==="HOTSPOT"){m1.objectType=u.Hotspot;}else if(e.contentType==="PMI"){m1.objectType=u.PMI;}if(e.contentType==="REFERENCE"){k._vkSetNodeContentType(N.Reference);}else if(e.contentType==="ANNOTATION"){k._vkSetNodeContentType(N.Annotation);}return k;};S.prototype.removeNode=function(e){this._nodes.delete(e._vkPersistentId());this._annotations.forEach(function(i){if(i.node===e){this._annotations.delete(i.annotation.id);}}.bind(this));};function I(e,m,l){var i;if(e.isPolyline){var j=new THREE.LineBasicMaterial({color:0xff0000,linewidth:1});if(m){j.color.copy(m.color);}i=new THREE.LineSegments(e,j);}else{i=new THREE.Mesh(e,m);}if(e.isPositionQuantized){Q(i,l.boundingBox);}U.increaseGeometryUsed(e);return i;}S.prototype.getChildNodeIds=function(e,j,k){this._resetCurrentScene(j);var l=this._nodes.get(e);var m=[];if(!l){return m;}if(l&&l.children){for(var i=0;i<l.children.length;i++){var l1=l.children[i];if(l1.userData.treeNode&&l1.userData.treeNode.sid){m.push(l1.userData.treeNode.sid);}else if(k&&l1.userData.submeshInfo&&l1.userData.submeshInfo.id){m.push(l1.userData.submeshInfo.id);}}}return m;};function J(l){for(var i=0;i<l.length;i++){if(l[i].type==="box"&&l[i].data){return l[i];}}return null;}function K(l){if(Array.isArray(l)){for(var i=0;i<l.length;i++){if(l[i].type===undefined||l[i].type==="mesh"||l[i].type==="line"){return l[i];}}}return null;}function Q(m,e){if(e&&e.length===6){m.position.set((e[3]+e[0])*0.5,(e[4]+e[1])*0.5,(e[5]+e[2])*0.5);m.scale.set(Math.max(e[3]-e[0],Number.EPSILON),Math.max(e[4]-e[1],Number.EPSILON),Math.max(e[5]-e[2],Number.EPSILON));}}S.prototype.insertSubmesh=function(e){var m=this._getMaterialRef(e.materialId)||this._createTemporaryMaterial(e.materialId);var i,j;if(e.lods){var l=K(e.lods);if(!l){return false;}j=this._geometries.get(l.id);if(j){i=I(j,m,l);if(j.userData&&j.userData.noNormal&&e.materialId){this.updateMaterialForGeometryWithoutNormal(e.materialId);}}else{var k;var l1=J(e.lods);if(l1&&l1.data){var m1=T.base64ToUint8Array(l1.data);var n1=B.unpackSubDividedBoundingBox(m1);k=w.march(n1);}i=new THREE.Mesh(k?k:new THREE.BoxBufferGeometry(1,1,1),m);var o1=l.boundingBox;if(o1&&o1.length===6){var p1=new THREE.Matrix4();p1.scale(new THREE.Vector3(Math.max(o1[3]-o1[0],Number.EPSILON),Math.max(o1[4]-o1[1],Number.EPSILON),Math.max(o1[5]-o1[2],Number.EPSILON)));p1.setPosition(new THREE.Vector3((o1[3]+o1[0])*0.5,(o1[4]+o1[1])*0.5,(o1[5]+o1[2])*0.5));i.geometry.applyMatrix(p1);}i.userData.geometryId=l.id;i.userData.lodInfo=l;T.pushElementIntoMapArray(this._geometryMeshes,l.id,e.meshId);}}else{return false;}if(e.transform){i.applyMatrix(F(e.transform));}i.userData.submeshId=e.id;i.userData.initialMaterialId=e.materialId;i.userData.meshId=e.meshId;i.userData.materialId=e.materialId;i.userData.submeshInfo=e;T.pushElementIntoMapArray(this._materialMeshes,e.materialId,e.meshId);T.pushElementIntoMapArray(this._meshSubmeshes,e.meshId,i);var q1=this._meshNodes.get(e.meshId);if(q1){q1.forEach(function(r1){var s1=i.clone();s1.layers=r1.layers;if(r1.userData.materialId){s1.material=this._getMaterialRef(r1.userData.materialId)||i.material;}r1.add(s1);X(r1,e.materialId,this._materialClones);}.bind(this));}return true;};function W(e,j,k,m){for(var i=0;i<e.length;i++){var l=e[i];if(j&&l.userData.geometryId===j&&l.geometry!==k){if(l.type==="Mesh"&&!k.isPolyline){l.geometry=k;if(k.isPositionQuantized){Q(l,l.userData.lodInfo.boundingBox);}U.increaseGeometryUsed(k);}else{var l1=I(k,l.material,l.userData.lodInfo);l1.userData=l.userData;l1.layers=l.layers;l1.parent=l.parent;e[i]=l1;l.parent=null;}}}}S.prototype._setSubmeshMaterial=function(e,m,i){U.increaseMaterialUsed(m);e.material=m;e.userData.materialId=i;delete e.userData.originalMaterial;e._vkUpdateMaterialOpacity();if(e.material!==m){T.pushElementIntoMapArray(this._materialClones,i,e.material);}};S.prototype._updateMaterial=function(e,m,i){e.children.forEach(function(j){if(j.material&&j.userData.materialId===m){this._setSubmeshMaterial(j,i,m);}}.bind(this));};function X(e,m,i){e.children.forEach(function(j){if(j.material&&(!m||m===j.material.userData.materialId)){var k=j.material;j._vkUpdateMaterialOpacity();if(j.material!==k){T.pushElementIntoMapArray(i,j.material.userData.materialId,j.material);}}});}function Y(e,l){var m=new Float32Array(e.length);var p0=new THREE.Vector3();var p1=new THREE.Vector3();var p2=new THREE.Vector3();var l1=new THREE.Vector3();var i,m1;for(i=0,m1=l.length;i<m1;i+=3){var pi=[l[i]*3,l[i+1]*3,l[i+2]*3];p0.fromArray(e,pi[0]);p1.fromArray(e,pi[1]).sub(p0);p2.fromArray(e,pi[2]).sub(p0);l1.crossVectors(p1,p2).normalize();for(var j=0;j<3;j++){var k=pi[j];m[k]+=l1.x;m[k+1]+=l1.y;m[k+2]+=l1.z;}}for(i=0,m1=m.length;i<m1;i+=3){l1.fromArray(m,i).normalize().toArray(m,i);}return m;}S.prototype.setGeometry=function(e){var i=new THREE.BufferGeometry();var j=e.data;var k=new THREE.BufferAttribute(new Uint16Array(j.indices),1);var l=new THREE.BufferAttribute(new Float32Array(j.points),3);i.setIndex(k);i.setAttribute("position",l);if(!e.isPolyline){if(!j.normals||j.normals.length!==l.array){j.normals=Y(l.array,k.array);}var m=new THREE.BufferAttribute(new Float32Array(j.normals),3);i.setAttribute("normal",m);if(j.uvs&&j.uvs.length*3===j.points.length*2){i.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(e.data.uvs),2));}}else{i.isPolyline=true;}i.computeBoundingBox();i.computeBoundingSphere();i.isPositionQuantized=e.isPositionQuantized;i.userData.geometryId=e.id;i.userData.geometryUsed=0;this._geometries.set(e.id,i);var l1=this._geometryMeshes.get(e.id);if(l1){for(var mi=0;mi<l1.length;mi++){var n1=l1[mi];var o1=this._meshNodes.get(n1);if(o1){for(var ni=0;ni<o1.length;ni++){W(o1[ni].children,e.id,i);}}var q1=this._meshSubmeshes.get(n1);if(q1){W(q1,e.id,i);}}}if(this._fireSceneUpdated){this._fireSceneUpdated();}return this;};S.prototype.setMeshNode=function(e,m){var i=this._nodes.get(e);if(i){T.pushElementIntoMapArray(this._meshNodes,m,i);var j=this._meshSubmeshes.get(m);if(j){j.forEach(function(k){var l=k.clone();l.layers=i.layers;if(i.userData.materialId){l.material=this._getMaterialRef(i.userData.materialId)||k.material;}i.add(l);}.bind(this));X(i,null,this._materialClones);}}};S.prototype.progress=function(e){L.log("reading progress:",e);};S.prototype.loadingFinished=function(i){if(this._fireLoadingFinished){this._fireLoadingFinished(i);}};S.prototype.getGeometry=function(e){return this._geometries.get(e);};var Z={rect:f.RectangularShape,circle:f.CircularShape,none:f.None,textGlow:f.TextGlow};var $={none:g.None,solid:g.Solid,dash:g.Dash,dot:g.Dot,dashdot:g.DashDot,dashdotdot:g.DashDotDot};var _={left:h.Left,center:h.Center,right:h.Right};var a1={none:n.None,point:n.Point,arrow:n.Arrow};var b1=new THREE.Color();S.prototype.createAnnotation=function(e,i){this._resetCurrentScene(i);var j=this._nodes.get(e.nodeId);if(!j){L.warning("Annotation node not found",e);return;}var k=e.type;if(k===undefined){this.createLegacyAnnotation(e,j);return;}if(k==="html"){e.id=e.id||z();var l=[];if(e.leaderLines){e.leaderLines.forEach(function(t1){if(t1.start&&t1.start.sid){l.push(this._nodes.get(t1.start.sid));}},this);}this._annotations.set(e.id,{annotation:e,node:this._nodes.get(e.nodeId),attachment:(e.attachment&&e.attachment.sid)?this._nodes.get(e.attachment.sid):null,targetNodes:l});return;}var m=e.label||{};var l1=e.text||{};var m1=m.colour||[1,1,1,1];var n1=m.borderColour||[0,0,0,1];var o1={node:j,renderOrder:j.renderOrder||0,style:Z[m.shape]||f.RectangularShape,width:m.width||64,height:m.height||64,backgroundColor:b1.fromArray(m1).getStyle(),backgroundOpacity:m1[3],borderColor:b1.fromArray(n1).getStyle(),borderOpacity:n1[3],borderWidth:m.borderColour?(m.borderWidth||0):0,borderLineStyle:$[m.borderLineStyle]||g.Solid,horizontalAlignment:_[l1.align]};if(l1.html){o1.encoding=d.HtmlText;o1.text=l1.html;}else{o1.encoding=d.PlainText;o1.text=l1.text;o1.font=l1.fontFace||"Arial";o1.fontSize=Math.abs(l1.fontSize)||16;o1.fontWeight=Math.min(l1.fontWeight,900);o1.fontItalic=l1.fontItalic;o1.textColor=b1.fromArray(l1.colour||[0,0,0]).getStyle();}if(k==="text"){var p1=j.position;o1.position=new THREE.Vector3(p1.x*2,p1.y*2,p1.z);var q1=new b(o1);q1.setText(o1.text);this._addDynamicObject(j,q1._update.bind(q1),true);}else if(k==="note"){var r1=e.attachment||{};o1.position=new THREE.Vector3().fromArray(r1.position||[0,0,0]);o1.anchorNode=this._nodes.get(r1.sid)||this._rootNode;o1.depthTest=false;var s1=new C(o1);s1.setText(o1.text);this._callouts.set(e.id,s1);this._addDynamicObject(j,s1._update.bind(s1),false);}else{L.warning("Unsupported annotation type",e);}};var c1=[f.RectangularShape,f.CircularShape,f.None,f.TextGlow];var d1=[c.Viewport,c.Screen,c.World];var e1=[g.None,g.Solid,g.Dash,g.Dot,g.DashDot,g.DashDotDot];var f1=[n.None,n.Point,n.Arrow];var g1=[h.Left,h.Center,h.Right];function h1(e){var i=e.toString(16);if(e.length>=3){i=(((e[0]*255)<<16)|((e[1]*255)<<8)|(e[2]*255)).toString(16);}return"#"+"000000".substring(i.length)+i;}function i1(e){if(!e){return false;}for(var i=0,l=e.length;i<l;i++){if(!isFinite(e[i])){return false;}}return true;}S.prototype.createLegacyAnnotation=function(e,i){var j=e.position;if(!i1(j)){L.warning("Incorrect annotation position",e);return;}e.coordinateSpace|=0;var k=e.backgroundOpacity;if(!k){k=e.backgroundColour?e.backgroundColour[3]:0;}var l=e.borderOpacity;if(!l){l=e.borderColour?e.borderColour[3]:0;}var m={node:i,coordinateSpace:d1[e.coordinateSpace],style:c1[e.shape||0],width:e.width,height:e.height,backgroundColor:e.backgroundColour?h1(e.backgroundColour):"#fff",backgroundOpacity:k,borderColor:e.borderColour?h1(e.borderColour):"#000",borderOpacity:l,borderWidth:e.borderWidth,borderLineStyle:e1[e.borderLineStyle]};if(e.encoding!==undefined){m.encoding=e.encoding?d.HtmlText:d.PlainText;m.font=e.font;m.fontSize=e.fontSize;m.fontWeight=Math.min(e.fontWeight,900);m.fontItalic=e.fontItalic;m.textColor=h1(e.textColor);m.link=e.link;m.horizontalAlignment=g1[e.textHorizontalAlignment];m.position=new THREE.Vector3().fromArray(j);}else if(e.fontFace){m.encoding=d.PlainText;m.font=e.fontFace;m.fontSize=Math.abs(e.fontSize);m.fontWeight=Math.min(e.fontWeight,900);m.textColor=h1(e.textColour);}else{m.encoding=d.HtmlText;}if(e.coordinateSpace<2){if(!m.positions){m.position=new THREE.Vector3(j[0]*2-1,j[1]*-2+1,j[2]);}m.renderOrder=(e.order|0)+1000;var l1=new b(m);l1.setText(e.text);this._addDynamicObject(i,l1._update.bind(l1),true);}else{m.anchorNode=this._nodes.get(e.sid)||this._rootNode;if(!m.postion){m.position=new THREE.Vector3().fromArray(j);}m.depthTest=false;m.renderOrder=e.order|0;if(e.alwaysOnTop){m.renderOrder=1;}var m1=new C(m);m1.setText(e.text);this._callouts.set(e.id,m1);this._addDynamicObject(i,m1._update.bind(m1),false);}};S.prototype.createImageNote=function(e,i){this._resetCurrentScene(i);var j=this._nodes.get(e.nodeId);if(!j){L.warning("Image annotation node not found",e);return;}if(e.type==="image"){var l=e.label||{};var m=this._getMaterialRef(l.materialId);if(!m){L.warning("Image annotation material not found",e);return;}var k=new b({node:j,renderOrder:j.renderOrder||0,coordinateSpace:c.Screen,position:new THREE.Vector3(j.position.x,j.position.y,0),width:(l.width||200)*j.scale.x*0.5,height:(l.height||200)*j.scale.y*0.5});j.position.setScalar(0);j.scale.setScalar(1);k.setMaterial(m);this._addDynamicObject(j,k._update.bind(k),true);}else{this.createLegacyImageNote(e,j);}};S.prototype.createLegacyImageNote=function(e,i){var j=new THREE.Vector3().fromArray(e.position);var k=e.width;var l=e.height;if(!e.properlyAligned){j.x+=e.width*0.5;j.y+=e.height*0.5;j.applyMatrix4(i.matrix);k=e.width*0.5*i.matrix.elements[0];l=e.height*0.5*i.matrix.elements[5];}var m=new b({node:i,coordinateSpace:c.Screen,renderOrder:(e.order|0)+1000,position:j,width:k,height:l});var l1=this._getMaterialRef(e.labelMaterialId);m.setMaterial(l1);this._addDynamicObject(i,m._update.bind(m),true);};S.prototype.insertLeaderLine=function(e,j){this._resetCurrentScene(j);var k=this._callouts.get(e.annotationId);if(k){var m=this._getMaterialRef(e.materialId);if(!m){L.warning("Leader line material not found",e);return;}var l1=[];var m1=e.points;for(var i=0,l=m1.length;i<l;i++){l1.push(new THREE.Vector3().fromArray(m1[i]));}var n1;if(e.start){var o1=e.start||{};var p1=e.end||{};var q1=e.extension||{};n1=this._nodes.get(e.start.sid)||this._rootNode;k.addLeaderLine(l1,n1,m,a1[o1.style]||n.None,a1[p1.style]||n.None,o1.size,q1.length||0);}else{n1=this._nodes.get(e.startPointSid)||this._rootNode;k.addLeaderLine(l1,n1,m,f1[e.startPointHeadStyle],f1[e.endPointHeadStyle],e.pointHeadConstant,e.extensionLength);}}};S.prototype._findDetailViewNodes=function(e){var i=[];if(e){e.forEach(function(j){var k=this._nodes.get(j);if(k){i.push(k);}else{L.warning("Unknown detailView node reference",j);}}.bind(this));}return i;};S.prototype.createDetailView=function(i,e){this._resetCurrentScene(e);var j=this._nodes.get(i.nodeId);if(!j){L.warning("Detail view node not found",i);return;}var l=i.label;if(!l){this.createLegacyDetailView(i,j);return;}var k=i.attachment;var m={name:i.name,camera:l.camera?this.createCamera(l.camera):null,type:i.cutaway?o.Cutaway:o.DetailView,borderWidth:l.borderWidth||0,backgroundColor:b1.fromArray(l.colour||[1,1,1]).getStyle(),borderColor:b1.fromArray(l.borderColour||[1,1,1]).getStyle(),origin:new THREE.Vector2(j.position.x*2-1+j.scale.x,j.position.y*-2+1-j.scale.x),size:new THREE.Vector2(j.scale.x,j.scale.y),attachmentPoint:new THREE.Vector3().fromArray(k.position||[0,0,0]),veId:i.veid,visibleNodes:this._findDetailViewNodes(i.visibleNodes),targetNodes:this._findDetailViewNodes(i.targetNodes)};if(l.shape==="rect"){m.shape=!l.leaderStyle||l.leaderStyle==="none"?p.Box:p.BoxLine;}else{m.shape={none:p.Circle,line:p.CircleLine,pointer:p.CirclePointer,arrow:p.CircleArrow,bubbles:p.CircleBubbles}[l.leaderStyle]||p.Circle;}var l1=new D(m);if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[];}this._rootNode.userData._vkDetailViews.push({detailView:l1,node:j,renderOrder:i.renderOrder||j.renderOrder||0});};S.prototype.createLegacyDetailView=function(i,e){if(!i.properlyAligned){if(!i.shape){i.shape=i.leaderStyle?p.BoxLine:p.Box;}else{i.shape=[p.Circle,p.CircleLine,p.CirclePointer,p.CircleArrow,p.CircleBubbles][i.leaderStyle||0];}i.type=i.cutaway?o.Cutaway:o.DetailView;i.camera=i.camera?this.createCamera(i.camera):null;i.origin=new THREE.Vector2(e.position.x*2-1+e.scale.x,e.position.y*-2+1-e.scale.x);i.size=new THREE.Vector2(e.scale.x,e.scale.y);i.renderOrder=e.renderOrder;}else{i.type=[o.DetailView,o.Cutaway][i.type];i.shape=[p.Box,p.Circle,p.CircleLine,p.CirclePointer,p.CircleArrow,p.CircleBubbles,p.BoxLine,p.BoxNoOutline,p.SolidPointer,p.SolidArrow][i.shape];i.camera=this._cameras.get(i.cameraId);i.origin=new THREE.Vector2().fromArray(i.origin);i.size=new THREE.Vector2().fromArray(i.size);}var j=new D({name:i.name,camera:i.camera,type:i.type,shape:i.shape,borderWidth:i.borderWidth||0,backgroundColor:i.backgroundColour?h1(i.backgroundColour):"#fff",borderColor:i.borderColour?h1(i.borderColour):"#000",origin:i.origin,size:i.size,attachmentPoint:new THREE.Vector3().fromArray(i.attachment),metadata:i.metadata,veId:i.veid,visibleNodes:this._findDetailViewNodes(i.visibleNodes),targetNodes:this._findDetailViewNodes(i.targetNodes)});if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[];}this._rootNode.userData._vkDetailViews.push({detailView:j,node:e,renderOrder:i.renderOrder||0});};S.prototype.insertThrustline=function(i){var e=this._nodes.get(i.thrustlineId);if(e&&!this._thrustlines.get(i.thrustlineId)){var j=new a({node:e,principleAxis:new THREE.Vector3().fromArray(i.principleAxis),material:this._getMaterialRef(i.materialId)});var k=[];var l=0;var m=0;var l1=0;for(var ii=0;ii<i.itemCount;ii++){var n1={};n1.target=this._nodes.get(i.targets[ii]);n1.majorAxisIndex=i.itemMajorAxisesIndices[ii];var bi;n1.basisAxises=[];l1=l+i.itemBasisAxisesCounts[ii];for(bi=l;bi<l1;bi++){var p1={};p1.x=i.itemBasisAxisesCoordinates[bi*3];p1.y=i.itemBasisAxisesCoordinates[bi*3+1];p1.z=i.itemBasisAxisesCoordinates[bi*3+2];n1.basisAxises.push(p1);}l=l1;n1.dimension={};n1.dimension.x=i.itemDimensionsCoordinates[ii*3];n1.dimension.y=i.itemDimensionsCoordinates[ii*3+1];n1.dimension.z=i.itemDimensionsCoordinates[ii*3+2];n1.center={};n1.center.x=i.itemCentersCoordinates[ii*3];n1.center.y=i.itemCentersCoordinates[ii*3+1];n1.center.z=i.itemCentersCoordinates[ii*3+2];n1.boundPoints=[];l1=m+i.itemBoundPointsCounts[ii];for(bi=m;bi<l1;bi++){var q1={};q1.x=i.itemBoundPointsCoordinates[bi*3];q1.y=i.itemBoundPointsCoordinates[bi*3+1];q1.z=i.itemBoundPointsCoordinates[bi*3+2];n1.boundPoints.push(q1);}m=l1;k.push(n1);}j.setItems(k);var r1=0;var s1=[];for(var si=0;si<i.segmentCount;si++){var u1={};u1.startItemIndex=i.segmentsStartItemIndices[si];u1.endItemIndex=i.segmentsEndItemIndices[si];u1.startBoundIndex=i.segmentsStartBoundIndices[si];u1.endBoundIndex=i.segmentsEndBoundIndices[si];u1.ratios=[];l1=r1+i.segmentRatioCounts[si];for(var ri=0;ri<l1;ri++){var w1={};w1.x=i.segmentRatiosCoordinates[ri*2];w1.y=i.segmentRatiosCoordinates[ri*2+1];u1.ratios.push(w1);}r1=l1;s1.push(u1);}j.setSegments(s1);this._thrustlines.set(i.thrustlineId,j);this._addDynamicObject(e,j._update.bind(j),false);}};S.prototype.updateViewsForReplacedNodes=function(e){var i=new Map();e.forEach(function(l){var m=this._nodes.get(l.sid);if(m){i.set(l.sid,m);}},this);function j(l,i){var e=l.getNodeInfos();e.forEach(function(m){var l1=m.target;if(l1&&l1.userData&&l1.userData.treeNode&&l1.userData.treeNode.sid){var m1=i.get(l1.userData.treeNode.sid);if(m1){m.target=m1;m1.updateMatrixWorld();}}});}function k(l,i){var m;var l1=l.getPlaybacks();for(var pi=0;pi<l1.length;pi++){var n1=l1[pi];var o1=n1.getSequence();if(o1){var p1=false;var q1=o1.getNodeAnimation();for(var ni=0;ni<q1.length;ni++){var s1=q1[ni];var t1=s1.nodeRef;if(t1&&t1.userData&&t1.userData.treeNode&&t1.userData.treeNode.sid){m=i.get(t1.userData.treeNode.sid);if(m){o1.removeNodeAnimation(t1,null,true);for(var u1 in s1){if(u1==="nodeRef"){continue;}o1.setNodeAnimation(m,u1,s1[u1],true);}p1=true;}}}var v1=o1.getJoint();for(var ji=0;v1&&ji<v1.length;ji++){var x1=v1[ji];if(x1.parentSid){m=i.get(x1.parentSid);if(m){x1.parent=m;p1=true;}}if(x1.nodeSid){m=i.get(x1.nodeSid);if(m){x1.node=m;p1=true;}}}if(p1){o1._fireSequenceChanged();}}}e.forEach(function(m1){var r1=m1.target;if(r1&&r1.userData&&r1.userData.treeNode&&r1.userData.treeNode.sid){var m=i.get(r1.userData.treeNode.sid);if(m){m1.target=m;m.updateMatrixWorld();}}});}this._views.forEach(function(l,m){j(l,i);k(l,i);});};S.prototype._decrementResourceCounters=function(e){e.traverse(function(i){if(i.isMesh){U.decreaseMaterialUsed(i.material);U.decreaseGeometryUsed(i.geometry);}});};S.prototype.decrementResourceCountersForDeletedTreeNode=function(e,i){this._resetCurrentScene(i);var j=this;e=[].concat(e);e.forEach(function(k){var l=j._nodes.get(k);if(l){j._decrementResourceCounters(l);j._nodes.delete(k);}});return this;};S.prototype.remove=function(e,j){this._resetCurrentScene(j);var k=this;e=[].concat(e);e.forEach(function(l){var m=k._nodes.get(l);if(m){k._decrementResourceCounters(m);if(m.parent){m.parent.remove(m);}k._nodes.delete(l);for(var i=0;i<m.children.length;i++){var l1=m.children[i];if(l1.userData&&l1.userData.treeNode&&l1.userData.treeNode.sid){k.remove(l1.userData.treeNode.sid,j);}}}});return this;};S.prototype.resourcesCleanUp=function(){var e=this._geometries;e.forEach(function(i){var j=i.userData.geometryUsed;if(j<=0){i.dispose();}});return this;};S.prototype.createCamera=function(e,i){this._resetCurrentScene(i);var j=e.near||1;var k=e.far||200000;var l;if(e.ortho){l=new THREE.OrthographicCamera(-1,1,1,-1,j,k);l.zoom=e.zoom||-1;}else{l=new THREE.PerspectiveCamera(THREE.Math.radToDeg(e.fov),1,j,k);}if(e.origin){l.position.fromArray(e.origin);}if(e.up){l.up.fromArray(e.up);if(e.notUseDirectionVector){l.up.sub(l.position);}l.up.normalize();}if(e.target){var m=new THREE.Vector3().fromArray(e.target);if(!e.notUseDirectionVector){m.add(l.position);}l.lookAt(m);}this._rootNode.userData.camera=l;var l1=null;if(l.isOrthographicCamera){l1=new O();}else if(l.isPerspectiveCamera){l1=new P();}l1.setCameraRef(l);l1.setUsingDefaultClipPlanes(true);var m1=e.id;if(m1){this._cameras.set(m1,l1);}this._rootNode.userData.camera=l1;return l1;};S.prototype.insertCamera=function(e,i,j){this._resetCurrentScene(j);var k=this._nodes.get(e);var l=this._cameras.get(i);if(k&&l){(k||this._rootNode).add(l.parent?l.clone():l);}return this;};S.prototype.getCamera=function(e){return this._cameras.get(e);};S.prototype.updateMaterialForGeometryWithoutNormal=function(m){var e=this._getMaterialRef(m);if(e&&e.emissive){e.emissive.copy(e.color);e.side=THREE.DoubleSide;}return this;};S.prototype.createMaterial=function(m){var e=[];var i=m.id;var j=this._getMaterialRef(i);if(m.lineWidth>0){if(!j||!j.isLineBasicMaterial){j=new THREE.LineBasicMaterial();var k=new M(true);k.setMaterialRef(j);this._vkScene.setMaterial(i,k);}j.color=new THREE.Color(m.lineColour[0],m.lineColour[1],m.lineColour[2]);j.linewidth=m.lineWidth;j.userData.lineStyle={width:m.lineWidth,haloWidth:m.lineHaloWidth||0,endCapStyle:m.lineEndRound?1:0,dashPattern:m.lineDashPattern||[],dashPatternScale:m.lineDashPatternScale,widthCoordinateSpace:m.lineWidthCoordinateSpace};j.userData.materialInfo=m;j.userData.materialId=i;return e;}if(!j){j=this._createTemporaryMaterial(i);}delete j.userData.toBeUpdated;j.userData.materialInfo=m;if(m.diffuseColour){j.color.fromArray(m.diffuseColour);}if(m.specularColour){j.specular.fromArray(m.specularColour);}var l=true;if(m.emissiveColour){j.emissive.fromArray(m.emissiveColour);if(j.emissive.r!==0||j.emissive.g!==0||j.emissive.b!==0){l=false;j.depthFunc=THREE.LessDepth;}}if(l&&m.ambientColour){j.emissive.fromArray(m.ambientColour);j.emissive.multiplyScalar(0.2);}if(j.opacity!==undefined){j.opacity=m.opacity;j.transparent=m.opacity<0.99;if(j.transparent){j.side=THREE.DoubleSide;}}var l1=j.glossiness?j.glossiness:0;var m1=j.specularLevel?j.specularLevel:0;j.shininess=l1*2+m1*3;j.userData.defaultHighlightingEmissive=G;j.userData.defaultHighlightingSpecular=H;e=this.updateTextureMaps(i);if(e.length>0){j.userData.imageIdsToLoad=new Set();for(var ti=0;ti<e.length;ti++){var o1=e[ti];T.pushElementIntoMapArray(this._imageTextures,o1.imageId,{textureType:o1.textureType,materialId:i});j.userData.imageIdsToLoad.add(o1.imageId);}}var p1=this._materialMeshes.get(i);if(p1){for(var mi=0;mi<p1.length;mi++){var r1=p1[mi];var s1=this._meshNodes.get(r1);if(s1){for(var ni=0;ni<s1.length;ni++){this._updateMaterial(s1[ni],i,j);}}}}return e;};S.prototype.getMaterial=function(m){return this._getMaterialRef(m);};var j1=function(i){var j="";try{var k=0x8000;var l=0;var m=i.length;var l1;while(l<m){l1=i.slice(l,Math.min(l+k,m));j+=String.fromCharCode.apply(null,l1);l+=k;}}catch(e){j="";}return j;};S.prototype.createImage=function(e){var j=new DataView(e.binaryData.buffer);var k=true;if(j.getUint8(0,true)===parseInt("0xFF",16)&&j.getUint8(1,true)===parseInt("0xD8",16)){k=false;}var l=j1(e.binaryData);var m="data:image/"+(k?"png":"jpeg")+";base64,"+btoa(l);this._images.set(e.id,m);var l1=this._imageTextures.get(e.id);if(l1){this._imageTextures.delete(e.id);for(var i=0;i<l1.length;i++){var m1=l1[i];this.updateTextureMap(m1.materialId,m1.textureType);}}return this;};var k1=new THREE.TextureLoader();S.TextureType={Diffuse:0,Bump:1,Opacity:2,Reflection:3,Refraction:4,Specular:5,Ambient:6,Emissive:7,SpecularLevel:8,Glosiness:9,AmbientOcclusion:10,Decal:11};S.prototype.updateTextureMaps=function(m){var e=[];var i=this._getMaterialRef(m);if(!i){return e;}var j=i.userData.materialInfo;if(!j){return e;}if(j.textureDiffuse){var k=this.updateTextureMap(m,S.TextureType.Diffuse);if(k.imageId){e.push(k);}}if(j.textureBump){var l=this.updateTextureMap(m,S.TextureType.Bump);if(l.imageId){e.push(l);}}if(j.textureOpacity){var l1=this.updateTextureMap(m,S.TextureType.Opacity);if(l1.imageId){e.push(l1);}}if(j.textureEmissive){var m1=this.updateTextureMap(m,S.TextureType.Emissive);if(m1.imageId){e.push(m1);}}if(j.textureAmbientOcclusion){var n1=this.updateTextureMap(m,S.TextureType.AmbientOcclusion);if(n1.imageId){e.push(n1);}}if(j.textureReflection){var o1=this.updateTextureMap(m,S.TextureType.Reflection);if(o1.imageId){e.push(o1);}}return e;};S.prototype.updateTextureMap=function(e,i){var j={textureType:i,imageId:null};var k=this._getMaterialRef(e);if(!k){return j;}var l=k.userData.materialInfo;if(!l){return j;}var l1=null;switch(i){case S.TextureType.Diffuse:l1=l.textureDiffuse;break;case S.TextureType.Bump:l1=l.textureBump;break;case S.TextureType.Opacity:l1=l.textureOpacity;break;case S.TextureType.Reflection:l1=l.textureReflection;break;case S.TextureType.Emissive:l1=l.textureEmissive;break;case S.TextureType.AmbientOcclusion:l1=l.textureAmbientOcclusion;break;default:break;}if(!l1){return j;}var m1=l1[0]||l1;var n1=this._images.get(m1.imageId);if(!n1){j.imageId=m1.imageId;return j;}if(k.userData.imageIdsToLoad){k.userData.imageIdsToLoad.delete(m1.imageId);if(k.userData.imageIdsToLoad.size===0){delete k.userData.imageIdsToLoad;}}var o1=k1.load(n1,this._fireSceneUpdated);o1.wrapS=m1.uvHorizontalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;o1.wrapT=m1.uvVerticalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;o1.magFilter=m1.filterMode===1?THREE.NearestFilter:THREE.LinearFilter;o1.minFilter=m1.filterMode===1?THREE.NearestFilter:THREE.LinearMipMapLinearFilter;o1.anisotropy=4;var p1=m1.influence!==undefined?m1.influence:0;var q1=m1.uvHorizontalScale!==undefined?m1.uvHorizontalScale:1;var r1=m1.uvVerticalScale!==undefined?m1.uvVerticalScale:1;var s1=m1.uvHorizontalOffset!==undefined?m1.uvHorizontalOffset:0;var t1=m1.uvVerticalOffset!==undefined?m1.uvVerticalOffset:0;o1.repeat.set(q1,r1);o1.center.set(-s1,-t1);o1.offset.set(s1,t1);o1.rotation=-m1.uvRotationAngle;function u1(m){switch(i){case S.TextureType.Diffuse:m.map=o1;m.transparent|=n1.startsWith("data:image/png");break;case S.TextureType.Bump:m.bumpMap=o1;m.bumpScale=p1;break;case S.TextureType.Opacity:m.alphaMap=o1;break;case S.TextureType.Reflection:o1.mapping=THREE.SphericalReflectionMapping;m.envMap=o1;m.combine=THREE.AddOperation;m.reflectivity=p1;break;case S.TextureType.Emissive:m.emissiveMap=o1;m.emissive.setRGB(1,1,1);break;case S.TextureType.AmbientOcclusion:m.aoMap=o1;break;default:}m.needsUpdate=true;}u1(k);var v1=this._materialClones.get(e);if(v1){v1.forEach(function(m){u1(m);});}return j;};S.prototype.insertPlayback=function(e,i,j){this._resetCurrentScene(j);var k=this._vkScene.findSequence(e.sequenceId);var l=new r(e.id,{sequence:k,timeScale:e.speed?1.0/e.speed:1,preDelay:e.preDelay?e.preDelay:0,postDelay:e.postDelay?e.postDelay:0,repeats:e.repeat?Math.abs(e.repeat):0,reversed:e.reversed?true:false,startTime:e.start?e.start:0});var m=this._views.get(i);if(m){m.addPlayback(l);}if(!k){T.pushElementIntoMapArray(this._sequenceIdToPlaybacks,e.sequenceId,l);}return this;};S.prototype.insertSequence=function(i,e){var j=this._vkScene.findSequence(i.id);if(j){return this;}var k;if(i.endTime){if(i.startTime){k=i.endTime-i.startTime;}else{k=i.endTime;}}else{k=1.0;}j=this._vkScene.createSequence(i.id,{name:i.name,duration:k});if(Array.isArray(i.joints)){i.joints.forEach(function(n1){var o1=this._joints[n1];if(o1){j.setJoint(o1,true);}}.bind(this));}if(i.nodes&&i.nodes.length>0){for(var l=0;l<i.nodes.length;l++){var m=i.nodes[l];if(m.empty){m.type=m.binding;var l1=this._nodes.get(m.sid);this._animationHelper.insertEmptyTrack(m,j,l1,this._vkScene);continue;}T.pushElementIntoMapArray(this._trackIdSequenceNodeMap,m.trackId,{sequenceId:i.id,targetId:m.sid,type:m.binding,pivot:m.pivot,isAbsoluteValue:m.isAbsoluteValue});}}var m1=this._sequenceIdToPlaybacks.get(i.id);if(m1){m1.forEach(function(n1){n1.setSequence(j);});}return this;};S.prototype.insertTracks=function(e){this._animationHelper.insertTracks(e,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);return this;};S.prototype.insertJoints=function(j,e){this._resetCurrentScene(e);this._joints=[];j.forEach(function(i){var k=this._nodes.get(i.childSid);var l=this._nodes.get(i.parentSid);var m={id:i.id,node:k,parent:l,translation:new Float32Array(i.t?i.t:[0,0,0]),quaternion:new Float32Array(i.q?i.q:[0,0,0,1]),scale:new Float32Array(i.s?i.s:[1,1,1])};if(!k){var l1=this._jointNodesMap.get(i.childSid);if(!l1){l1=[];}l1.push(m);this._jointNodesMap.set(i.childSid,l1);}if(!l){var m1=this._jointParentsMap.get(i.parentSid);if(!m1){m1=[];}m1.push(m);this._jointParentsMap.set(i.parentSid,m1);}this._joints.push(m);}.bind(this));return this;};S.prototype.finalizeAnimation=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}e.userData.tracks=this._tracks;}return this;};S.prototype.finalizePlaybacks=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}}else{return this;}if(!e.userData.animationNodeOriginalData){e.userData.animationNodeOriginalData=new Map();}var i;var j=this._viewGroups.entries();var k=j.next();while(!k.done){i=k.value[1];k=j.next();var l=[];for(var m=0;m<i.getViews().length;m++){if(i.getViews()[m].id){var l1=this._views.get(i.getViews()[m].id);if(l1){l.push(l1);}}}}return this;};S.prototype.finalizeViewGroups=function(e){this._resetCurrentScene(e);var i=this._viewGroups.entries();var j=i.next();while(!j.done){var k=j.value[1];var l=j.value[0];if(!k||!k.views||!k.views.length){j=i.next();continue;}k.removeViews();for(var m=0;m<k.views.length;m++){var l1=k.views[m].id;var m1=this._views.get(l1);if(m1&&m1.userData.viewInfo.thumbnailId&&!m1.thumbnailData){var n1=this._images.get(m1.userData.viewInfo.thumbnailId);if(n1){m1.thumbnailData=n1;}}if(m1){m1.viewGroupId=l;k.addView(m1);}}j=i.next();}return this;};S.prototype.insertViewGroup=function(i,e){this._resetCurrentScene(e);var j=this._viewGroups.get(i.id);if(!j){j=this._vkScene.createViewGroup({viewGroupId:i.id,name:i.name,description:i.description});this._viewGroups.set(i.id,j);}else{j.setViewGroupId(i.id);j.setName(i.name);j.setDescription(i.description);}j.type=i.type;j.metadata=i.metadata;j.veids=i.veids;j.views=i.views;j.sceneId=i.sceneId;return this;};S.prototype.getViewGroup=function(e,i){this._resetCurrentScene(i);var j=this._viewGroups.get(e);var k=[];if(j&&j.views){for(var l=0;l<j.views.length;l++){var m=j.views[l].id;var l1=this._views.get(m);if(l1){k.push(l1);}}}return k;};S.prototype.insertView=function(e,i){this._resetCurrentScene(i);if(e.description){var j=new RegExp("^<[^>]*?>");if(j.test(e.description)){var k=new RegExp("(^(<[^>]*?>\s*)+)|((<[^>]*?>\s*)+$)","g");var l=e.description.replace(k,"");if(!l){e.description=l;}}}var m=this._vkScene.createView({viewId:e.viewId,name:e.name,description:e.description?"<pre style=\"white-space: pre-wrap;\">"+e.description+"</pre>":e.description,aspectRatio:e.safeAreaAspectRatio});m.userData={};m.userData.viewInfo=e;if(e.thumbnailId){var l1=this._images.get(e.thumbnailId);if(l1){m.thumbnailData=l1;}else{this._viewThumbnails.set(e.thumbnailId,m);}}if(e.animatedThumbnailId){var m1=this._images.get(e.animatedThumbnailId);if(m1){m.animatedThumbnailData=m1;m.tileWidth=this._imageIdsAndTileWidths.get(e.animatedThumbnailId);}}if(e.cameraId){m.setCamera(this._cameras.get(e.cameraId));}m.type=e.type;m.flyToTime=e.flyToTime;m.preDelay=e.preDelay;m.postDelay=e.postDelay;m.navigationMode=e.navigationMode;m.topColor=e.topColor;m.bottomColor=e.bottomColor;m.renderMode=E[e.renderMethod];m.dimension=e.dimension;m.query=e.query;m.metadata=e.metadata;m.veids=e.veids;m.viewGroupId=e.viewGroupId;m.id=e.viewId;this._views.set(e.viewId,m);if(m.viewGroupId){var n1=this._viewGroups.get(m.viewGroupId);if(n1){n1.addView(m);}}return this;};S.prototype.setModelViewVisibilitySet=function(i){var e=this._views.get(i.viewId);var j=[];i.visibleNodes.forEach(function(k){var l=this._nodes.get(k);if(l){j.push({target:l,visible:true});}else{L.warning("Unknown modelView visible node reference",k);}}.bind(this));e.updateNodeInfos(j);};S.prototype.recordHighlightedNodeInView=function(e,i,j,k){this._resetCurrentScene(k);var l=this._views.get(j);if(!l){return this;}var m=this._nodes.get(i);if(!m){return this;}l.addHighlightedNodes(e,m);return this;};S.prototype.insertHighlightStyle=function(i){var e=this._vkScene.getHighlight(i.id);if(e){return this;}this._vkScene.createHighlight(i.id,i);return this;};S.prototype.insertModelViewHighlight=function(i){var e=this._views.get(i.viewId);if(e){var j=[];i.highlightNodes.forEach(function(l1){var m1=this._nodes.get(l1);if(m1){j.push(m1);}else{}}.bind(this));var k={duration:i.duration,cycles:i.cycles};if(!i.id){i.id=THREE.Math.generateUUID().toLowerCase();}var l=new THREE.Color(i.color1).toArray();var m=new THREE.Color(i.color2).toArray();l[3]=((i.color1>>>24)&255)/255;m[3]=((i.color2>>>24)&255)/255;k.colours=[l,m];k.opacities=[i.opacity1,i.opacity2];this._vkScene.createHighlight(i.id,k);e.addHighlightedNodes(i.id,j);}};S.prototype.createThumbnail=function(i){var e=this._viewThumbnails.get(i.imageId);if(e){e.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,i.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:e});}}};S.prototype.highlightStyleExists=function(i){var e=this._vkScene.getHighlight(i);return e!==undefined;};S.prototype.getView=function(e,i){this._resetCurrentScene(i);return this._views.get(e);};S.prototype.getSequence=function(e){return this._vkScene.findSequence(e);};S.prototype.setViewCamera=function(e,i,j){this._resetCurrentScene(j);var k=this._cameras.get(e);var l=this._views.get(i);if(k&&l){l.setCamera(k);}return this;};S.prototype.setViewNodeInfos=function(e,i,j){this._resetCurrentScene(j);var k=this._views.get(i);k.setNodeInfos(e);return this;};S.prototype.setViewThumbnail=function(i,e,j,k){this._resetCurrentScene(j);var l=this._views.get(e);var m=this._images.get(i);if(l&&m){if(l.userData!==undefined){if(l.userData.viewInfo.thumbnailId===i){l.thumbnailData=m;}else if(l.userData.viewInfo.animatedThumbnailId===i){l.animatedThumbnailData=m;l.tileWidth=k;}}}return this;};S.prototype.cleanup=function(){this._rootNode=null;if(this._vkScene){this._vkScene.clearMaterials();}this._callouts.clear();this._cameras.clear();this._images.clear();this._imageIdsAndTileWidths.clear();this._imageTextures.clear();this._geometries.clear();this._meshNodes.clear();this._meshSubmeshes.clear();this._geometryMeshes.clear();this._materialMeshes.clear();this._materialClones.clear();this._currentSceneId=null;if(this._nodes){this._nodes.clear();}if(this._tracks){this._tracks.clear();}if(this._trackIdSequenceNodeMap){this._trackIdSequenceNodeMap.clear();}if(this._viewGroups){this._viewGroups.clear();}if(this._views){this._views.clear();}this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._sceneIdViewGroupMap.clear();this._sceneIdViewMap.clear();S._map.delete(this._id);};S.prototype.insertAnimationGroup=function(i){var e=this._vkScene.findSequence(i.animationGroupRef.toString());if(!e){var j;if(i.endTime){j=i.endTime-i.startTime;if(!i.startTime){i.startTime=0;}}e=this._vkScene.createSequence(i.animationGroupRef.toString(),{name:i.name,duration:j});if(!e.userData){e.userData={};}e.userData.animations=[];}if(i.modelViewRef){var m=this._views.get(i.modelViewRef);if(m){var k=this._vkScene.findSequence(i.animationGroupRef.toString());var l=new r({sequence:k,timeScale:i.playbackSpeed?1.0/i.playbackSpeed:1,preDelay:i.playbackPreDelay?i.playbackPreDelay:0,postDelay:i.playbackPostDelay?i.playbackPostDelay:0,repeat:i.playbackRepeat?Math.abs(i.playbackRepeat):0,reversed:i.playbackReversed?true:false,startTime:0});m.addPlayback(l);}}};S.prototype.insertAnimation=function(i){var e=this._animations.get(i.animationRef);if(!e){e={};e.type=i.animationType;e.targetRefs=[];e.targetPivots=[];e.sequenceId=i.animationGroupRef.toString();e.trackIds=new Set();e.tracks=[];this._animations.set(i.animationRef,e);}if(i.animationGroupRef){var j=this._vkScene.findSequence(i.animationGroupRef.toString());if(!j.userData.animations.includes(i.animationRef)){j.userData.animations.push(i.animationRef);}}};S.prototype.insertAnimationTarget=function(i){var e=this._animations.get(i.animationRef);if(e){if(!e.targetRefs.includes(i.targetRef)){e.targetRefs.push(i.targetRef);e.targetPivots.push({x:i.targetPivotX,y:i.targetPivotY,z:i.targetPivotZ});}}};S.prototype.insertAnimationTrack=function(i){var e=this._animationTracks.get(i.animationTrackRef);var j=i.animationRef;if(!e){delete i.animationRef;e=i;this._animationTracks.set(i.animationTrackRef,e);}if(!j){return;}var k=this._animations.get(j);if(!k||!k.sequenceId){return;}if(k.trackIds.has(e.animationTrackRef)){return;}k.trackIds.add(e.animationTrackRef);for(var l=0;k.targetRefs&&l<k.targetRefs.length;l++){var m=k.targetRefs[l];var l1=k.targetPivots[l];var m1=this._nodes.get(m);if(!m1){continue;}var n1;if(l1.x!==0||l1.y!==0||l1.z!==0){n1=[l1.x,l1.y,l1.z];}var o1=["OPACITY","COLOUR","TRANSLATE","SCALE","ROTATE"][e.type]||"";T.pushElementIntoMapArray(this._trackIdSequenceNodeMap,i.animationTrackRef,{sequenceId:k.sequenceId,targetId:m,type:o1,pivot:n1,isAbsoluteValue:true});var p1={};p1.times=Array.prototype.slice.call(e.times);p1.values=Array.prototype.slice.call(e.values);p1.id=i.animationTrackRef;p1.cyclicInfo={};p1.cyclicInfo.cyclicStart=e.cyclicStart;p1.cyclicInfo.cyclicEnd=e.cyclicEnd;var ki;if(k.type===0){if(e.dataType===0){if(e.values.length!==e.keyCount||e.times.length!==e.keyCount){continue;}if(e.type===3){p1.values=[];for(ki=0;ki<e.keyCount;ki++){p1.values.push(e.values[ki]);p1.values.push(e.values[ki]);p1.values.push(e.values[ki]);}}}else if(e.dataType===1||e.dataType===3){if(e.values.length!==3*e.keyCount||e.times.length!==e.keyCount){continue;}}else if(e.dataType===4||e.dataType===5||e.dataType===6){if(e.values.length!==4*e.keyCount||e.times.length!==e.keyCount){continue;}if(e.dataType===4){p1.rotateType=s.AngleAxis;}else if(e.dataType===6){p1.rotateType=s.Euler;}else{p1.rotateType=s.Quaternion;for(var vi=3;vi<p1.values.length;vi=vi+4){p1.values[vi]=-p1.values[vi];}}}}k.tracks.push(p1);}};S.prototype.setAnimationTracks=function(e){var i=this._animations.get(e);if(i){this._animationHelper.insertTracks(i.tracks,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);}};S.prototype.setAnimationPlaybacks=function(i){var e=this._viewGroups.get(i.viewGroupId);this._animationHelper.setInitialNodePositionsFromSubsequentViews(e.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromPreviousViews(e.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromCurrenetViews(e.getViews(),this._vkScene);this._animationHelper.setPlaybackStartTimes(e.getViews(),this._vkScene);this._animationHelper.buildViewsInitialState(e.getViews(),this._vkScene);};return S;});
