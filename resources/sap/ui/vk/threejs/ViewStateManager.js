/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["../Core","../ContentConnector","../ViewStateManagerBase","./thirdparty/three","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","./Scene","../ObjectType","../RotationType","./NodesTransitionHelper","./OutlineRenderer","./HighlightPlayer","../HighlightDisplayState","../Highlight","../AnimationTrackType","../AnimationTrackValueType","../AnimationMath"],function(a,C,V,t,b,d,e,f,S,O,R,N,g,H,h,m,A,n,o){"use strict";var p;var u=V.extend("sap.ui.vk.threejs.ViewStateManager",{metadata:{}});var w=u.getMetadata().getParent().getClass().prototype;u.prototype.init=function(){if(w.init){w.init.call(this);}this._channel=0;this._layers=new THREE.Layers();this._layers.set(this._channel);this._nodeHierarchy=null;this._nodeStates=new Map();this._selectedNodes=new Set();this._outlineRenderer=new g(1.0);this._outlinedNodes=new Set();this.setOutlineColor("rgba(255, 0, 255, 1.0)");this.setOutlineWidth(1.0);this._visibilityTracker=new p();this._showSelectionBoundingBox=true;this._boundingBoxesScene=new THREE.Scene();this._selectionColor=new THREE.Color(0xC0C000);this.setHighlightColor("rgba(255, 0, 0, 1.0)");this._joints=[];this._customPositionedNodes=new Set();this._nodesTransitionHelper=new N();this._nodesTransitionHelper.setViewStateManager(this);this._highlightPlayer=new H();this._transitionHighlightPlayer=new H();a.getEventBus().subscribe("sap.ui.vk","activateView",this._onViewActivated,this);};u.prototype.exit=function(){a.getEventBus().unsubscribe("sap.ui.vk","activateView",this._onViewActivated,this);};u.prototype._setContent=function(c){var s=null;if(c&&c instanceof S){s=c;}this._setScene(s);if(s){var i=s.getInitialView();if(i){this._currentView=i;this._resetNodesMaterialAndOpacityByCurrenView(this._currentView);}}};u.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};u.prototype._onBeforeClearContentConnector=function(){this._setScene(null);};u.prototype._handleContentReplaced=function(c){var i=c.getParameter("newContent");this._setContent(i);};u.prototype._setScene=function(s){this._boundingBoxesScene=new THREE.Scene();this._setNodeHierarchy(s?s.getDefaultNodeHierarchy():null);if(s){s.setViewStateManager(this);}this._scene=s;return this;};u.prototype._setNodeHierarchy=function(c){var i=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy=null;this._nodeStates.clear();this._selectedNodes.clear();this._outlinedNodes.clear();this._visibilityTracker.clear();}if(c){this._nodeHierarchy=c;this._nodeHierarchy.attachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.attachNodeUpdated(this._handleNodeUpdated,this);this._nodeHierarchy.attachNodeRemoving(this._handleNodeRemoving,this);this._initialState={visible:[],hidden:[]};var j=this;var k=c.findNodesByName();k.forEach(function(l){(l.layers.test(j._layers)?j._initialState.visible:j._initialState.hidden).push(l);});this.fireVisibilityChanged({visible:this._initialState.visible,hidden:this._initialState.hidden});}if(c!==i){this.fireNodeHierarchyReplaced({oldNodeHierarchy:i,newNodeHierarchy:c});}return this;};u.prototype._getJointByChildNode=function(c){var j;if(this._jointCollection){for(var i=0;i<this._jointCollection.length;i++){if(this._jointCollection[i].node===c){j=this._jointCollection[i];break;}}}return j;};u.prototype._handleNodeReplaced=function(c){var r=c.getParameter("ReplacedNodeRef");var i=c.getParameter("ReplacementNodeRef");if(this.getSelectionState(r)){this.setSelectionState(i,true);this.setSelectionState(r,false);}};u.prototype._handleNodeUpdated=function(c){var i=c.getParameter("nodeRef");if(this.getSelectionState(i)){this.setSelectionState(i,false);this.setSelectionState(i,true);}};u.prototype._handleNodeRemoving=function(c){var j=c.getParameter("nodeRef");if(this._jointCollection){for(var i=0;i<this._jointCollection.length;i++){if(this._jointCollection[i].node===j){this._jointCollection[i].node=null;break;}if(this._jointCollection[i].parent===j){this._jointCollection[i].parent=null;break;}}}if(this.getSelectionState(j)){this.setSelectionState(j,false,true,true);}};u.prototype._renderOutline=function(r,s,i){var c=e(this._outlineColorABGR);var j=new THREE.Color(c.red/255.0,c.green/255.0,c.blue/255.0);this._outlineRenderer.render(r,s,i,Array.from(this._outlinedNodes),j,this._jointCollection);};u.prototype.getNodeHierarchy=function(){return this._nodeHierarchy;};u.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null;};u.prototype.getCurrentView=function(){var v=sap.ui.getCore().byId(this.getViewManager());if(!v){return null;}var c=v.getActiveView();return c;};u.prototype.resetNodeProperty=function(c,i){var j=this.getCurrentView();if(!j){return;}var k=j.getNodeInfos();if(k){var l=[];l.push(c);if(this._jointCollection&&this._jointCollection.length>0){for(var q=0;q<this._jointCollection.length;q++){var r=this._jointCollection[q];if(!r.node||!r.parent){continue;}var s=r.parent;if(s!==c){break;}l.push(r.node);}}k.forEach(function(v){if(!l.includes(v.target)){return;}if(!i||i!==A.Opacity){var x={nodeRefs:[],positions:[]};var y;var z;var D;if(v.transform){var E=new THREE.Vector3();var F=new THREE.Quaternion();var G=new THREE.Vector3();var I=B(v.transform);I.decompose(E,F,G);y=E.toArray();z=F.toArray();D=G.toArray();}else if(v[A.Scale]&&v[A.Rotate]&&v[A.Translate]){y=v[A.Translate].slice();z=v[A.Rotate].slice();D=v[A.Scale].slice();}if(y){x.nodeRefs.push(v.target);x.positions.push({translation:y,quaternion:z,scale:D});this.setTransformation(x.nodeRefs,x.positions);}}else{c._vkSetOpacity(v.opacity,this._jointCollection);var J={changed:c,opacity:k.opacity};this.fireOpacityChanged(J);}}.bind(this));}};u.prototype.getVisibilityComplete=function(){var c=this.getNodeHierarchy(),i=c.findNodesByName(),v=[],j=[];i.forEach(function(k){var l=c.createNodeProxy(k);var q=l.getVeId();c.destroyNodeProxy(l);if(q){if(this.getVisibilityState(k)){v.push(q);}else{j.push(q);}}},this);return{visible:v,hidden:j};};u.prototype.resetVisibility=function(){this.setVisibilityState(this._initialState.visible,true,false);this.setVisibilityState(this._initialState.hidden,false,false);this._visibilityTracker.clear();};u.prototype.getVisibilityState=function(c){var l=this._layers;if(Array.isArray(c)){return c.map(function(i){return i?i.layers.test(l):false;});}return c?c.layers.test(l):false;};u.prototype.setVisibilityState=function(c,v,r){if(!Array.isArray(c)){c=[c];}var i=Array.isArray(v);var j=[];var k=c;if(r){k=[];c.forEach(function(D,E){var F=this._collectNodesRecursively(D);k=k.concat(F);var G=j.length;j.length=G+F.length;j.fill(i?v[E]:v,G);},this);}else if(!i){j.length=k.length;j.fill(v);}else{j=v;}var l=[];var q=new Set();var s=this._layers,x=this._channel;var y=k.filter(function(D,E){if(q.has(D)){return false;}q.add(D);var y=D?D.layers.test(s)!=j[E]:false;if(y){l.push(j[E]);}return y;},this);if(y.length>0){var z={visible:[],hidden:[]};y.forEach(function(D,E){if(l[E]){D.layers.enable(x);z.visible.push(D);}else{D.layers.disable(x);z.hidden.push(D);}},this);if(this.getShouldTrackVisibilityChanges()){y.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker);}this.fireVisibilityChanged(z);}return this;};u.prototype.enumerateSelection=function(c){this._selectedNodes.forEach(c);return this;};u.prototype.enumerateOutlinedNodes=function(c){this._outlinedNodes.forEach(c);return this;};u.prototype.getSelectionState=function(c){var s=this._selectedNodes;function i(j){return s.has(j);}return Array.isArray(c)?c.map(i):i(c);};u.prototype._isAChild=function(c,i){var j=c.parent;while(j){if(i.has(j)){return true;}j=j.parent;}return false;};u.prototype._AddBoundingBox=function(c){if(c.userData.boundingBox===undefined){c.userData.boundingBox=new THREE.Box3();c._vkCalculateObjectOrientedBoundingBox();}if(!c.userData.boundingBox.isEmpty()&&this._boundingBoxesScene&&c.userData.boxHelper===undefined){var i=new THREE.Box3Helper(c.userData.boundingBox,0xffff00);i.material.color=this._selectionColor;this._boundingBoxesScene.add(i);i.parent=c;c.userData.boxHelper=i;}};u.prototype._RemoveBoundingBox=function(c){if(c.userData.boundingBox!==undefined){delete c.userData.boundingBox;}if(c.userData.boxHelper!==undefined){this._boundingBoxesScene.remove(c.userData.boxHelper);delete c.userData.boxHelper;}};u.prototype._updateBoundingBoxesIfNeeded=function(){var c=new Set();this._selectedNodes.forEach(function(i){var j=i.parent;while(j){if(this._selectedNodes.has(j)){c.add(j);}j=j.parent;}}.bind(this));c.forEach(function(i){i._vkCalculateObjectOrientedBoundingBox();});};u.prototype._updateBoundingBoxes=function(){this._selectedNodes.forEach(function(c){if(c.userData.boundingBox){c._vkCalculateObjectOrientedBoundingBox();}});};u.prototype.setShowSelectionBoundingBox=function(v){this._showSelectionBoundingBox=v;if(this._showSelectionBoundingBox){this._selectedNodes.forEach(function(c){this._AddBoundingBox(c);}.bind(this));}else{this._selectedNodes.forEach(function(c){this._RemoveBoundingBox(c);}.bind(this));}this.fireSelectionChanged({selected:this._selectedNodes,unselected:[]});};u.prototype.getShowSelectionBoundingBox=function(){return this._showSelectionBoundingBox;};u.prototype._isAncestorSelected=function(c){c=c.parent;while(c){if(this._selectedNodes.has(c)){return true;}c=c.parent;}return false;};u.prototype._updateHighlightColor=function(c,j){var s=j||this._selectedNodes.has(c);c.userData.highlightColor=s?this._highlightColorABGR:undefined;c._vkUpdateMaterialColor();var k=c.children;for(var i=0,l=k.length;i<l;i++){var q=k[i].userData;if(q&&q.objectType===O.Hotspot){continue;}this._updateHighlightColor(k[i],s);}};u.prototype.setSelectionState=function(c,s,r,i){if(!Array.isArray(c)){c=[c];}c=(r||this.getRecursiveSelection()?this._collectNodesRecursively(c):c).filter(function(v,k,l){return l.indexOf(v)===k;});if(this.getRecursiveSelection()&&!s){c=this._nodeHierarchy._appendAncestors(c);}var j=c.filter(function(k){return this._selectedNodes.has(k)!==s;},this);if(j.length>0){j.forEach(function(k){if(k){this._selectedNodes[s?"add":"delete"](k);if(this._showSelectionBoundingBox){this[s?"_AddBoundingBox":"_RemoveBoundingBox"](k);}}},this);j.forEach(function(k){if(k){this._updateHighlightColor(k,s||this._isAncestorSelected(k));}},this);if(!i){this.fireSelectionChanged({selected:s?j:[],unselected:s?[]:j});}}return this;};u.prototype.setSelectionStates=function(s,c,r,i){if(!Array.isArray(s)){s=[s];}if(!Array.isArray(c)){c=[c];}s=(r||this.getRecursiveSelection()?this._collectNodesRecursively(s):s);c=(r||this.getRecursiveSelection()?this._collectNodesRecursively(c):c);if(this.getRecursiveSelection()){c=this._nodeHierarchy._appendAncestors(c,s);}var j=s.filter(function(l){return this._selectedNodes.has(l)===false;},this);var k=c.filter(function(l){return this._selectedNodes.has(l)===true;},this);if(j.length>0||k.length>0){j.forEach(function(l){this._selectedNodes.add(l);this._updateHighlightColor(l,true);if(this._showSelectionBoundingBox){this._AddBoundingBox(l);}},this);k.forEach(function(l){this._selectedNodes.delete(l);if(this._showSelectionBoundingBox){this._RemoveBoundingBox(l);}},this);k.forEach(function(l){this._updateHighlightColor(l,this._isAncestorSelected(l));},this);if(!i){this.fireSelectionChanged({selected:j,unselected:k});}}return this;};u.prototype.setOutlineColor=function(c){switch(typeof c){case"number":this._outlineColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._outlineColorABGR=f(b(c));}break;default:return this;}this.fireOutlineColorChanged({outlineColor:d(e(this._outlineColorABGR)),outlineColorABGR:this._outlineColorABGR});return this;};u.prototype.getOutlineColor=function(i){return i?this._outlineColorABGR:d(e(this._outlineColorABGR));};u.prototype.getOutliningState=function(c){var i=this._outlinedNodes;function j(k){return i.has(k);}return Array.isArray(c)?c.map(j):j(c);};u.prototype.setOutliningStates=function(c,i,r,j){if(!Array.isArray(c)){c=[c];}if(!Array.isArray(i)){i=[i];}c=(r||this.getRecursiveOutlining()?this._collectNodesRecursively(c):c);i=(r||this.getRecursiveOutlining()?this._collectNodesRecursively(i):i);if(this.getRecursiveOutlining()){i=this._nodeHierarchy._appendAncestors(i,c);}var k=c.filter(function(q){return this._outlinedNodes.has(q)===false;},this);var l=i.filter(function(q){return this._outlinedNodes.has(q)===true;},this);if(k.length>0||l.length>0){k.forEach(function(q){this._outlinedNodes.add(q);},this);l.forEach(function(q){this._outlinedNodes.delete(q);},this);if(!j){this.fireOutliningChanged({outlined:k,unoutlined:l});}}return this;};u.prototype.setOutlineWidth=function(c){this._outlineWidth=c;this._outlineRenderer.setOutlineWidth(c);this.fireOutlineWidthChanged({width:c});return this;};u.prototype.getOutlineWidth=function(){return this._outlineWidth;};u.prototype._collectNodesRecursively=function(c){var r=[],i=this;if(!Array.isArray(c)){c=[c];}c.forEach(function collectChildNodes(j){r.push(j);i._nodeHierarchy.enumerateChildren(j,collectChildNodes,false,true);});return r;};u.prototype._getOpacity=function(c){return c.userData.opacity!==undefined?c.userData.opacity:null;};u.prototype.getOpacity=function(c){if(Array.isArray(c)){return c.map(this._getOpacity,this);}else{return this._getOpacity(c);}};u.prototype.setOpacity=function(c,i,r){if(!Array.isArray(c)){c=[c];}var j=Array.isArray(i);if(i==null){i=undefined;}else if(j){i.forEach(function(y,z){if(y==null){i[z]=undefined;}});}var k=[];var l=c;if(!j){k.length=l.length;k.fill(i);}else{k=i;}var q=[];var s=new Set();var v=l.filter(function(y,z){if(s.has(y)){return false;}s.add(y);var v=y?y.userData.opacity!==k[z]:false;if(v){q.push(k[z]);}return v;},this);if(v.length>0){v.forEach(function(y,z){y._vkSetOpacity(q[z],this._jointCollection);},this);var x={changed:v,opacity:j?q:q[0]};this.fireOpacityChanged(x);}return this;};u.prototype._getTintColorABGR=function(c){return c.userData.tintColor!==undefined?c.userData.tintColor:null;};u.prototype._getTintColor=function(c){return c.userData.tintColor!==undefined?d(e(c.userData.tintColor)):null;};u.prototype.getTintColor=function(c,i){var j=i?"_getTintColorABGR":"_getTintColor";if(Array.isArray(c)){return c.map(this[j],this);}else{return this[j](c);}};u.prototype.setTintColor=function(c,i,r){if(!Array.isArray(c)){c=[c];}var j=function(D){var E=null;switch(typeof D){case"number":E=D;break;case"string":if(sap.ui.core.CSSColor.isValid(D)){E=f(b(D));}break;default:E=undefined;break;}return E;};var k=Array.isArray(i);var l=[];var q=c;if(r){q=[];c.forEach(function(D,E){var F=this._collectNodesRecursively(D);q=q.concat(F);var G=l.length;l.length=G+F.length;l.fill(k?i[E]:i,G);},this);}else if(!k){l.length=q.length;l.fill(i);}else{l=i;}var s=[];var v=new Set();var x=q.filter(function(D,E){if(v.has(D)){return false;}v.add(D);var x=D?D.userData.tintColor!==j(l[E]):false;if(x){s.push(l[E]);}return x;},this);if(x.length>0){var y=[];x.forEach(function(D,E){var F=j(s[E]);D._vkSetTintColor(F);y.push(F);},this);var z={changed:x,tintColor:k?s:s[0],tintColorABGR:k?y:y[0]};this.fireTintColorChanged(z);}return this;};u.prototype.setHighlightColor=function(c){switch(typeof c){case"number":this._highlightColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._highlightColorABGR=f(b(c));}break;default:return this;}if(this._selectedNodes.size>0){this._selectedNodes.forEach(function(i){this._updateHighlightColor(i,true);},this);}this.fireHighlightColorChanged({highlightColor:d(e(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this;};u.prototype.getHighlightColor=function(i){return i?this._highlightColorABGR:d(e(this._highlightColorABGR));};u.prototype.getRestTransformationUsingJoint=function(c){var j=this._getJointByChildNode(c);if(j&&j.translation&&j.scale&&j.quaternion){return j;}else{return this.getRestTransformation(c);}};u.prototype.getRelativeTransformation=function(c){var i=false;var j=this.getCurrentView();if(j){var k=j.getPlayback(0);if(k&&k.getReversed()){i=true;}}var l=function(q){var s=this.getRestTransformation(q,i);var v=[q.position.x-s.translation[0],q.position.y-s.translation[1],q.position.z-s.translation[2]];var x=new THREE.Quaternion(s.quaternion[0],s.quaternion[1],s.quaternion[2],s.quaternion[3]);var y=new THREE.Matrix4().makeRotationFromQuaternion(x);var z=new THREE.Matrix4().getInverse(y);var M=new THREE.Matrix4();var D=new THREE.Matrix4();M.makeRotationFromQuaternion(q.quaternion);D.multiplyMatrices(M,z);var E=new THREE.Quaternion().setFromRotationMatrix(D);var F=E.toArray();var G=[q.scale.x/s.scale[0],q.scale.y/s.scale[1],q.scale.z/s.scale[2]];return{translation:v,quaternion:F,scale:G};}.bind(this);if(!Array.isArray(c)){return l(c);}var r=[];c.forEach(function(q){r.push(l(q));});return r;};u.prototype.getTransformationWorld=function(c){var i=function(j){var k=new THREE.Vector3();var s=new THREE.Vector3();var q=new THREE.Quaternion();j.updateMatrixWorld();j.matrixWorld.decompose(k,q,s);return{translation:k.toArray(),quaternion:q.toArray(),scale:s.toArray()};};if(!Array.isArray(c)){return i(c);}var r=[];c.forEach(function(j){r.push(i(j));});return r;};u.prototype.getTransformation=function(c){var i=function(j){return{translation:this.getTranslation(j),quaternion:this.getRotation(j,R.Quaternion),scale:this.getScale(j)};}.bind(this);if(!Array.isArray(c)){return i(c);}var r=[];c.forEach(function(j){r.push(i(j));});return r;};u.prototype.getTranslation=function(c){var i=function(j){return j.position.toArray();};if(!Array.isArray(c)){return i(c);}var r=[];c.forEach(function(j){r.push(i(j));});return r;};u.prototype.getScale=function(c){var i=function(j){return j.scale.toArray();};if(!Array.isArray(c)){return i(c);}var r=[];c.forEach(function(j){r.push(i(j));});return r;};u.prototype._convertQuaternionToAngleAxis=function(q){if(q.w>1){q.normalize();}if(q.w>0.9999&&q.x<0.0001&&q.y<0.0001&&q.z<0.0001){q.w=1;q.x=0;q.y=0;q.z=0;}var c=2*Math.acos(q.w);var x;var y;var z;var s=Math.sqrt(1-q.w*q.w);if(s<0.0001){x=1;y=0;z=0;}else{x=q.x/s;y=q.y/s;z=q.z/s;}return[x,y,z,c];};u.prototype.getRotation=function(c,r){var i=function(k){var q=k.quaternion;var j;switch(r){case R.AngleAxis:j=this._convertQuaternionToAngleAxis(q);break;case R.Euler:var l=new THREE.Euler();l.setFromQuaternion(q);j=l.toArray();break;default:j=q.toArray();}return j;};if(!Array.isArray(c)){return i(c);}var j=[];c.forEach(function(k){j.push(i(k));});return j;};u.prototype.setTransformation=function(c,i){var j=Array.isArray(c);if(!Array.isArray(c)){c=[c];}var k={changed:[],transformation:[]};var l=function(q){return{position:q.position.toArray(),quaternion:q.quaternion.toArray(),scale:q.scale.toArray()};};if(!i){c.forEach(function(q){if(q.userData.position&&q.userData.quaternion&&q.userData.scale){q.position=q.userData.position;q.quaternion=q.userData.quaternion;q.scale=q.userData.scale;q.updateMatrix();delete q.userData.position;delete q.userData.quaternion;delete q.userData.scale;}this._customPositionedNodes.delete(q);k.changed.push(q);k.transformation.push(l(q));},this);}else{if(!Array.isArray(i)){i=[i];}c.forEach(function(q,r){var s=q.userData;if(!s){return;}if(!s.position){s.position=q.position.clone();}if(!s.quaternion){s.quaternion=q.quaternion.clone();}if(!s.scale){s.scale=q.scale.clone();}var v=i[r];if(v.transform){var x=B(v.transform);x.decompose(q.position,q.quaternion,q.scale);}else{q.position.fromArray(v.translation);q.scale.fromArray(v.scale);if(v.quaternion){q.quaternion.fromArray(v.quaternion);}else if(v.angleAxis){var y=new THREE.Vector3(v.angleAxis[0],v.angleAxis[1],v.angleAxis[2]);q.quaternion.setFromAxisAngle(y,v.angleAxis[3]);}else if(v.euler){var z=new THREE.Euler();z.fromArray(v.euler[0],v.euler[1],v.euler[2],v.euler[3]);q.quaternion.setFromEuler(z);}}q.updateMatrix();this._customPositionedNodes.add(q);k.changed.push(q);k.transformation.push(l(q));},this);}if(!j){k.changed=k.changed[0];k.transformation=k.transformation[0];}this.fireTransformationChanged(k);return this;};u.prototype.getJoints=function(){return this._jointCollection;};u.prototype.setJoints=function(j,s){this._jointCollection=[];this._sequenceAssociatedWithJoints=null;if(!j){return this;}var c=new Set();var i=new Map();j.forEach(function(l){if(!l.node||!l.parent){return;}c.add(l.node);i.set(l.node,l);});while(c.size>0){var k=c.values().next().value;c.delete(k);var l=i.get(k);var q=[l];var r=[];var v=l.parent;while(v){l=i.get(v);if(l!==undefined){if(c.delete(v)){q.push(l);}if(r.length>0){l.nodesToUpdate=l.nodesToUpdate||[];while(r.length>0){var x=r.pop();if(l.nodesToUpdate.indexOf(x)>=0){break;}l.nodesToUpdate.push(x);}}r.length=0;v=l.parent;}else{r.push(v);v=v.parent;}}while(q.length>0){this._jointCollection.push(q.pop());}}if(this._jointCollection&&this._jointCollection.length>0){this._sequenceAssociatedWithJoints=s;this._jointCollection.forEach(function(l){if(!l.node||!l.parent){return;}l.translation=null;l.scale=null;l.quaternion=null;if(l.node.userData){l.node.userData.offsetTranslation=null;l.node.userData.offsetQuaternion=null;l.node.userData.offsetScale=null;l.node.userData.originalRotationType=null;}});this._jointCollection.forEach(function(l){this._updateJointNode(l,this._sequenceAssociatedWithJoints);}.bind(this));}return this;};u.prototype._updateJointNode=function(j,s){if(!j.node||!j.parent){return;}if(j.translation&&j.quaternion&&j.scale){return;}var c=new Map();if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(j){if(!j.node||!j.parent){return;}c.set(j.node,j);});}var i=false;var k=this.getCurrentView();if(k){var l=k.getPlayback(0);if(l&&l.getReversed()){i=true;}}var q,r,v,x,y;var z=j.node;var D=new THREE.Matrix4();while(z){y=this.getRestTransformation(z,i);if(!y){z=z.parent;continue;}q=new THREE.Vector3(y.translation[0],y.translation[1],y.translation[2]);r=new THREE.Vector3(y.scale[0],y.scale[1],y.scale[2]);v=new THREE.Quaternion(y.quaternion[0],y.quaternion[1],y.quaternion[2],y.quaternion[3]);if(s){var E=this._getEndPropertyInPreviousSequence(z,A.Translate,s);if(E){q.x+=E[0];q.y+=E[1];q.z+=E[2];}var F=this._getEndPropertyInPreviousSequence(z,A.Scale,s);if(F){r.x*=F[0];r.y*=F[1];r.z*=F[2];}var G=this._getEndPropertyInPreviousSequence(z,A.Rotate,s);if(G){var I=new THREE.Quaternion(G[0],G[1],G[2],G[3]);v=I.multiply(v);}}x=new THREE.Matrix4().compose(q,v,r);D.premultiply(x);z=z.parent;}var J=j.parent;var P=new THREE.Matrix4();while(J){var K=c.get(J);if(K){if(!K.translation){this._updateJointNode(K);}q=new THREE.Vector3(K.translation[0],K.translation[1],K.translation[2]);r=new THREE.Vector3(K.scale[0],K.scale[1],K.scale[2]);v=new THREE.Quaternion(K.quaternion[0],K.quaternion[1],K.quaternion[2],K.quaternion[3]);J=K.parent;}else{y=this.getRestTransformation(J,i);if(!y){J=J.parent;continue;}q=new THREE.Vector3(y.translation[0],y.translation[1],y.translation[2]);r=new THREE.Vector3(y.scale[0],y.scale[1],y.scale[2]);v=new THREE.Quaternion(y.quaternion[0],y.quaternion[1],y.quaternion[2],y.quaternion[3]);J=J.parent;}x=new THREE.Matrix4().compose(q,v,r);P.premultiply(x);}var L=P.getInverse(P).multiply(D);L.decompose(q,v,r);j.translation=q.toArray();j.quaternion=v.toArray();j.scale=r.toArray();};u.prototype._updateMaterialInNode=function(c){var j=c.target;for(var i=0,l=j.children.length;i<l;i++){var k=j.children[i];if(k.userData.animatedColor){k._vkUpdateMaterialColor();}}var q=c.materialId;if(j.userData.materialId!==q){j.userData.materialId=q;this._scene._setNodeMaterial(j,q);}};function B(c){return new THREE.Matrix4().set(c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7],c[8],c[9],c[10],c[11],0,0,0,1);}u.prototype._resetNodesStatusByCurrenView=function(v,s,c){var i=this.getNodeHierarchy();if(i){var j;if(v){j=v.getPlaybacks();}var k=v.getNodeInfos();if(k){this._nodesTransitionHelper.clear();var l={nodeRefs:[],positions:[]};var q=new THREE.Vector3();var r=new THREE.Quaternion();var x=new THREE.Vector3();k.forEach(function(D){if(D.target===null){return;}function E(I,J,K){for(var L=0;L<I.elements.length;L++){if(Math.abs(I.elements[L]-J.elements[L])>K){return false;}}return true;}if(D.transform){var F=B(D.transform);if(!E(F,D.target.matrix,1e-6)){if((!j||!j.length)&&c){var G=i.createNodeProxy(D.target);this._nodesTransitionHelper.setNodeForDisplay(G,F);}else{F.decompose(q,r,x);l.nodeRefs.push(D.target);l.positions.push({translation:q.toArray(),quaternion:r.toArray(),scale:x.toArray()});}}}else if(D[A.Scale]&&D[A.Rotate]&&D[A.Translate]){l.nodeRefs.push(D.target);l.positions.push({translation:D[A.Translate].slice(),quaternion:D[A.Rotate].slice(),scale:D[A.Scale].slice()});}}.bind(this));if(v.userData&&v.userData.nodeStartDataByAnimation){v.userData.nodeStartDataByAnimation.forEach(function(D,E){if(D[A.Translate]&&D[A.Rotate]&&D[A.Scale]){l.nodeRefs.push(E);l.positions.push({translation:D[A.Translate].slice(),quaternion:D[A.Rotate].slice(),scale:D[A.Scale].slice()});}},this);}if(l.nodeRefs.length){this.setTransformation(l.nodeRefs,l.positions);}if(s){var y=[];var z=[];k.forEach(function(D){(D.visible?y:z).push(D.target);});this.setVisibilityState(i.getChildren()[0].children,false,true);this.setVisibilityState(y,true,false);this.setVisibilityState(z,false,false);this._startViewChangeNodeTransition();}}}};u.prototype._startViewChangeNodeTransition=function(){this._nodesTransitionHelper.startDisplay(500);var c=true;this._nodesTransitionHelper.attachEventOnce("displayed",function(){c=false;});var i=function(){if(c){this._nodesTransitionHelper.displayNodesMoving();window.requestAnimationFrame(i);}}.bind(this);window.requestAnimationFrame(i);};u.prototype._resetNodesMaterialAndOpacityByCurrenView=function(v){if(!v){return;}var c=v.getNodeInfos();if(c){c.forEach(function(j){if(!j.target){return;}this._updateMaterialInNode(j);}.bind(this));c.forEach(function(j){if(!j.target||!j.target.userData){return;}j.target.userData.opacity=j.opacity;});var i=this._scene.getSceneRef();i._vkSetOpacity(undefined,this._jointCollection);}this._selectedNodes.forEach(function(j){this._updateHighlightColor(j);}.bind(this));};u.prototype._onViewActivated=function(c,i,j){var v=this.getViewManager();if(!v||j.source.getId()!==v){return;}this.activateView(j.view,false,j.playViewGroup,j.notAnimateCameraChange);};u.prototype.activateView=function(v,i,c,j){this.fireViewStateApplying({view:v});this.setJoints(undefined);this._customPositionedNodes.clear();this._resetNodesMaterialAndOpacityByCurrenView(v);this._resetTransitionHighlight(v);this._resetNodesStatusByCurrenView(v,true,true);this._highlightPlayer.reset(v,this._scene);this.fireViewStateApplied({view:v,ignoreAnimationPosition:i,notAnimateCameraChange:j,playViewGroup:c});a.getEventBus().publish("sap.ui.vk","viewStateApplied",{source:this,view:v,ignoreAnimationPosition:i,notAnimateCameraChange:j,playViewGroup:c});return this;};u.prototype.setHighlightDisplayState=function(s){if(s===h.playing){this._highlightPlayer.start((new Date()).getTime());}else if(s===h.stopped){this._highlightPlayer.stop();}else if(s===h.pausing){this._highlightPlayer.pause((new Date()).getTime());}this.fireHighlightColorChanged({highlightColor:d(e(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this;};u.prototype._startHighlight=function(){this._highlightPlayer.start((new Date()).getTime());return this;};u.prototype._playHighlight=function(){return this._highlightPlayer.play((new Date()).getTime());};u.prototype._resetTransitionHighlight=function(v){this._transitionHighlightPlayer.reset();this._transitionHighlightPlayer.fadeInNodes=[];this._transitionHighlightPlayer.fadeOutNodes=[];this._transitionHighlightPlayer.setViewStateManager(this);var c=v.getNodeInfos();if(!c){return;}var j=function(r,s,x){if(!r||!r.length){return;}for(var i=0;i<r.length;i++){var y=r[i];if(y.type==="Mesh"&&(!x||(x&&!x.includes(y)))){s.push(y);}j(y.children,s,x);}};var k=[];var l=[];var q=this;c.forEach(function(i){var r=i.target;var s=r.layers.test(q._layers);if(s&&!i.visible){k.push(r);}if(!s&&i.visible){l.push(r);}});j(l,this._transitionHighlightPlayer.fadeInNodes);j(k,this._transitionHighlightPlayer.fadeOutNodes,this._transitionHighlightPlayer.fadeInNodes);};u.prototype._startTransitionHighlight=function(c){var i=this._transitionHighlightPlayer.fadeInNodes;var j=this._transitionHighlightPlayer.fadeOutNodes;if(i&&i.length){var k=new m("FadeIn",{duration:c/500.0,opacities:[0.0,1.0],cycles:1});this._transitionHighlightPlayer.addHighlights(k,i);}if(j&&j.length){var l=new m("FadeOut",{duration:c/500.0,opacities:[1.0,0.0],cycles:1,fadeOut:true});this._transitionHighlightPlayer.addHighlights(l,j);}if((i&&i.length)||(j&&j.length)){this._transitionHighlightPlayer.start((new Date()).getTime());this._transitionHighlightPlayer.play((new Date()).getTime());return c;}else{return 0;}return 0;};u.prototype._playTransitionHighlight=function(){return this._transitionHighlightPlayer.play((new Date()).getTime());};u.prototype.updateRestTransformation=function(c){var i=this.getCurrentView();if(!i){return this;}var j=i.getNodeInfos();if(j){j.forEach(function(k){if(k.target!==c){return;}c.updateMatrix();var l=c.matrix.elements;var q=[l[0],l[4],l[8],l[12],l[1],l[5],l[9],l[13],l[2],l[6],l[10],l[14]];k.transform=q;});}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.parent===c||k.node===c){k.translation=null;k.scale=null;k.quaternion=null;if(k.node.userData){k.node.userData.offsetTranslation=null;k.node.userData.offsetQuaternion=null;k.node.userData.offsetScale=null;k.node.userData.originalRotationType=null;}}});this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.parent===c){this._updateJointNode(k,this._sequenceAssociatedWithJoints);this.restoreRestTransformation(k.node);}}.bind(this));this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.node===c){this._updateJointNode(k,this._sequenceAssociatedWithJoints);}},this);}return this;};u.prototype.restoreRestTransformation=function(c){var i=this.getCurrentView();if(!i){return this;}var j=i.getNodeInfos();if(j){j.forEach(function(l){if(l.target!==c){return;}if(l.transform){var q=B(l.transform);q.decompose(c.position,c.quaternion,c.scale);}else if(l[A.Scale]&&l[A.Rotate]&&l[A.Translate]){c.position.set(l[A.Translate][0],l[A.Translate][1],l[A.Translate][2]);c.quaternion.set(l[A.Rotate][0],l[A.Rotate][1],l[A.Rotate][2],l[A.Rotate][3]);c.scale.set(l[A.Scale][0],l[A.Scale][1],l[A.Scale][2]);}c.updateMatrix();});}var k={changed:[c],transformation:[{position:c.position.toArray(),quaternion:c.quaternion.toArray(),scale:c.scale.toArray()}]};this.fireTransformationChanged(k);return this;};u.prototype.setRestTransformation=function(c,i,q,s){var j=this.getCurrentView();if(!j){return this;}var k=j.getNodeInfos();if(k){k.forEach(function(l){if(l.target!==c){return;}if(!i||!q||!s){if(l.transform){var r=new THREE.Vector3();var v=new THREE.Quaternion();var x=new THREE.Vector3();var y=B(l.transform);y.decompose(r,v,x);if(!i){i=[r.x,r.y,r.z];}if(!s){s=[x.x,x.y,x.z];}if(!q){q=[v.x,v.y,v.z,v.w];}}else if(l[A.Scale]&&l[A.Rotate]&&l[A.Translate]){if(!i){i=l[A.Translate].slice();}if(!s){s=l[A.Scale].slice();}if(!q){q=l[A.Rotate].slice();}}}var z=new THREE.Vector3(i[0],i[1],i[2]);var D=new THREE.Quaternion(q[0],q[1],q[2],q[3]);var E=new THREE.Vector3(s[0],s[1],s[2]);var F=new THREE.Matrix4();F.compose(z,D,E);var G=F.elements;l.transform=[G[0],G[4],G[8],G[12],G[1],G[5],G[9],G[13],G[2],G[6],G[10],G[14]];});}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(l){if(!l.node||!l.parent){return;}if(l.parent===c||l.node===c){l.translation=null;l.scale=null;l.quaternion=null;if(l.node.userData){l.node.userData.offsetTranslation=null;l.node.userData.offsetQuaternion=null;l.node.userData.offsetScale=null;l.node.userData.originalRotationType=null;}}});this._jointCollection.forEach(function(l){if(!l.node||!l.parent){return;}if(l.parent===c){this._updateJointNode(l,this._sequenceAssociatedWithJoints);this.restoreRestTransformation(l.node);}},this);this._jointCollection.forEach(function(l){if(!l.node||!l.parent){return;}if(l.node===c){this._updateJointNode(l,this._sequenceAssociatedWithJoints);}},this);}return this;};u.prototype.getRestOpacity=function(c){var j;var k=this.getCurrentView();if(k){j=k.getNodeInfos();}var r=1;if(j&&j.length){for(var i=0;i<j.length;i++){var l=j[i];if(l.target!==c){continue;}if(l.opacity!==undefined&&l.opacity!==null){r=l.opacity;}break;}}return r;};u.prototype.setRestOpacity=function(c,i){var j;var k=this.getCurrentView();if(k){j=k.getNodeInfos();}if(j){j.forEach(function(l){if(l.target!==c){return;}l.opacity=i;});}return this;};u.prototype.restoreRestOpacity=function(c){var i;var j=this.getCurrentView();if(j){i=j.getNodeInfos();}if(i){i.forEach(function(k){if(k.target!==c){return;}var l=1;if(k.opacity!==undefined){l=k.opacity;}this.setOpacity(c,l);}.bind(this));}return this;};u.prototype.updateRestOpacity=function(c){var i;var j=this.getCurrentView();if(j){i=j.getNodeInfos();}if(i){i.forEach(function(k){if(k.target!==c){return;}if(c.userData&&c.userData.opacity!==undefined&&c.userData.opacity!==null){k.opacity=c.userData.opacity;}else{delete k.opacity;}});}return this;};u.prototype.getRestTransformationWorld=function(c){var j;var k=this.getCurrentView();if(k){j=k.getNodeInfos();}var r;if(j){var l=new THREE.Matrix4();while(c){for(var i=0;i<j.length;i++){var q=j[i];if(q.target!==c){continue;}var s;if(q.transform){s=B(q.transform);}else if(q[A.Scale]&&q[A.Rotate]&&q[A.Translate]){var v=new THREE.Vector3(q[A.Translate][0],q[A.Translate][1],q[A.Translate][2]);var x=new THREE.Quaternion(q[A.Rotate][0],q[A.Rotate][1],q[A.Rotate][2],q[A.Rotate][3]);var y=new THREE.Vector3(q[A.Scale][0],q[A.Scale][1],q[A.Scale][2]);s=new THREE.Matrix4().compose(v,x,y);}if(s){l.premultiply(s);}break;}c=c.parent;}var z=new THREE.Vector3();var D=new THREE.Quaternion();var E=new THREE.Vector3();l.decompose(z,D,E);r={};r.translation=z.toArray();r.quaternion=D.toArray();r.scale=E.toArray();}if(!r){r=this.getTransformationWorld(c);}return r;};u.prototype.getRestTransformation=function(c,i){var j;var k=this.getCurrentView();if(k){j=k.getNodeInfos();}var r;if(j){j.forEach(function(l){if(l.target!==c){return;}if(l.transform){var q=l.transform;var s=new THREE.Vector3();var v=new THREE.Quaternion();var x=new THREE.Vector3();var y=B(l.transform);y.decompose(s,v,x);if(i){var z=this._getEndPropertyInLastSequence(c,A.Translate);if(z){s.x-=z[0];s.y-=z[1];s.z-=z[2];}var D=this._getEndPropertyInLastSequence(c,A.Scale);if(D){x.x/=D[0];x.y/=D[1];x.z/=D[2];}var E=this._getEndPropertyInLastSequence(c,A.Rotate);if(E){var F=new THREE.Quaternion(E[0],E[1],E[2],E[3]);v=F.inverse().normalize().multiply(v);}y.compose(s,v,x);var G=y.elements;q=[G[0],G[4],G[8],G[12],G[1],G[5],G[9],G[13],G[2],G[6],G[10],G[14]];}r={};r.translation=s.toArray();r.quaternion=v.toArray();r.scale=x.toArray();r.transformRowWise=q;r.transformColumnWise=[q[0],q[4],q[8],q[1],q[5],q[9],q[2],q[6],q[10],q[3],q[7],q[11]];}else if(l[A.Scale]&&l[A.Rotate]&&l[A.Translate]){r={};r.translation=l[A.Translate].slice();r.quaternion=l[A.Rotate].slice();r.scale=l[A.Scale].slice();}}.bind(this));}if(!r&&c){r={};r.translation=c.userData.position?c.userData.position.toArray():c.position.toArray();r.quaternion=c.userData.quaternion?c.userData.quaternion.toArray():c.quaternion.toArray();r.scale=c.userData.scale?c.userData.scale.toArray():c.scale.toArray();r.matrix=c.matrix.clone();}return r;};u.prototype._addToTransformation=function(c,j,q,s,k){var r={};var i;if(j){r.translation=[];for(i=0;i<3;i++){r.translation.push(j[i]+c.translation[i]);}}else{r.translation=c.translation;}if(s){r.scale=[];for(i=0;i<3;i++){r.scale.push(s[i]*c.scale[i]);}}else{r.scale=c.scale;}if(q){var l=new THREE.Quaternion(q[0],q[1],q[2],q[3]);var v=new THREE.Matrix4().makeRotationFromQuaternion(l);var x=new THREE.Quaternion(c.quaternion[0],c.quaternion[1],c.quaternion[2],c.quaternion[3]);var y=new THREE.Matrix4().makeRotationFromQuaternion(x);y.premultiply(v);x.setFromRotationMatrix(y);r.quaternion=[x.x,x.y,x.z,x.w];}else{r.quaternion=c.quaternion;}return r;};u.prototype.addToRestTransformation=function(c,i,q,s,j){var k=false;var l=this.getCurrentView();if(l){var r=l.getPlayback(0);if(r&&r.getReversed()){k=true;}}var v=this.getRestTransformation(c,k);if(!c.userData){c.userData={};}if(i){c.userData.offsetTranslation=i;}else{c.userData.offsetTranslation=null;}if(s){c.userData.offsetScale=s;}else{c.userData.offsetScale=null;}if(q){c.userData.offsetQuaternion=q;c.userData.originalRotationType=j;}else{c.userData.offsetQuaternion=null;c.userData.originalRotationType=null;}return this._addToTransformation(v,i,q,s,j);};u.prototype._setJointNodeMatrix=function(){if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(j){if(!j.node||!j.parent){return;}var c=j.node;if(c.userData.skipUpdateJointNode){return;}var i={};i.translation=j.translation.slice();i.scale=j.scale.slice();i.quaternion=j.quaternion.slice();var k=this._addToTransformation(i,c.userData.offsetTranslation,c.userData.offsetQuaternion,c.userData.offsetScale,c.userData.originalRotationType);c.position.fromArray(k.translation);c.scale.fromArray(k.scale);c.quaternion.fromArray(k.quaternion);c.updateMatrix();var l=c.quaternion.clone();var q=new THREE.Matrix4();if(j.parent){j.parent.updateMatrixWorld();q=j.parent.matrixWorld.clone();c.matrixWorld.multiplyMatrices(j.parent.matrixWorld,c.matrix);}else{c.matrixWorld.copy(c.matrix);}var r=new THREE.Matrix4();if(c.parent){r=c.parent.matrixWorld.clone();c.matrix.getInverse(c.parent.matrixWorld).multiply(c.matrixWorld);}else{c.matrix.copy(c.matrixWorld);}c.matrix.decompose(c.position,c.quaternion,c.scale);var s=[c.scale.x,c.scale.y,c.scale.z];this._adjustQuaternionAndScale(q,r,l,c.quaternion,k.scale,s);c.scale.x=s[0];c.scale.y=s[1];c.scale.z=s[2];if(j.nodesToUpdate){j.nodesToUpdate.forEach(function(v){if(v.matrixAutoUpdate){v.updateMatrix();}v.matrixWorld.multiplyMatrices(v.parent.matrixWorld,v.matrix);});}}.bind(this));}};u.prototype._getEndPropertyInLastSequence=function(c,i){var j;var l=this.getCurrentView();if(!l){return j;}var q=l.getPlaybacks();if(!q||!q.length){return j;}for(var k=q.length-1;k>=0;k--){var r=q[k];var s=r.getSequence();if(s._convertedFromAbsolute){return j;}if(s){j=s.getNodeBoundaryProperty(c,i,true);if(j){break;}}}return j;};u.prototype._getEndPropertyInPreviousSequence=function(c,k,s){var l;if(s&&s._convertedFromAbsolute){return l;}var q=this.getCurrentView();if(!q){return l;}var r=q.getPlaybacks();for(var i=1;i<r.length;i++){var v=r[i];var x=v.getSequence();if(x!==s){continue;}for(var j=i-1;j>=0;j--){var y=r[j];var z=y.getSequence();if(z){l=z.getNodeBoundaryProperty(c,k,true);if(l){break;}}}}return l;};u.prototype._convertTracksToRelative=function(s,c){if((c&&s._convertionDoneForReversed)||(!c&&s._convertionDone)){return this;}s._convertedFromAbsolute=false;var k=this.getCurrentView();if(!k){return this;}var l=s.getNodeAnimation();if(!l||!l.length){return this;}var v=k.getNodeInfos();if(v){v.forEach(function(x){var y;for(var i=0;i<l.length;i++){if(x.target===l[i].nodeRef){y=l[i];break;}}if(!y){return;}var z=[0,0,0];var D=[1,1,1];var E=new THREE.Quaternion();var F=new THREE.Vector3();var G=new THREE.Vector3();if(x.transform){var I=B(x.transform);I.decompose(F,E,G);z=F.toArray();D=G.toArray();}else if(x[A.Scale]&&x[A.Rotate]&&x[A.Translate]){z=x[A.Translate].slice();E=new THREE.Quaternion(x[A.Rotate][0],x[A.Rotate][1],x[A.Rotate][2],x[A.Rotate][3]);D=x[A.Scale].slice();}else{x.target.matrix.decompose(F,E,G);z=F.toArray();D=G.toArray();}var j,J,K,L;var M=y[A.Translate];if(M&&M.getIsAbsoluteValue()){J=M.getKeysCount();for(j=0;j<J;j++){K=M.getKey(j);L=[K.value[0]-z[0],K.value[1]-z[1],K.value[2]-z[2]];M.updateKey(j,L,true);}M.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}var P=y[A.Scale];if(P&&P.getIsAbsoluteValue()){J=P.getKeysCount();for(j=0;j<J;j++){K=P.getKey(j);L=[K.value[0]/D[0],K.value[1]/D[1],K.value[2]/D[2]];P.updateKey(j,L,true);}P.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}var Q=y[A.Opacity];if(Q&&Q.getIsAbsoluteValue()){var T=this.getRestOpacity(x.target);if(!T){T=1.0;}J=Q.getKeysCount();for(j=0;j<J;j++){K=Q.getKey(j);L=K.value/T;Q.updateKey(j,L,true);}Q.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}var U=function(d1){var e1=0;var f1=2*Math.PI;if(d1>0){while(d1>f1-0.0001){e1+=f1;d1-=f1;}}else if(d1<0){while(d1<-f1+0.0001){e1-=f1;d1+=f1;}}return e1;};var W=y[A.Rotate];if(W&&W.getIsAbsoluteValue()){var X;var Y=new THREE.Matrix4().makeRotationFromQuaternion(E);var Z=new THREE.Matrix4().getInverse(Y);var $=new THREE.Matrix4();var _=new THREE.Matrix4();J=W.getKeysCount();var a1=W.getKeysType();for(j=0;j<J;j++){K=W.getKey(j);if(a1===n.Quaternion){X=new THREE.Quaternion(K.value[0],K.value[1],K.value[2],K.value[3]);$.makeRotationFromQuaternion(X);_.multiplyMatrices($,Z);X.setFromRotationMatrix(_);L=X.toArray();W.updateKey(j,L,true);}else if(a1===n.Euler){var q=o.neutralEulerToGlMatrixQuat(K.value);var r=o.glMatrixQuatToNeutral(q);X=new THREE.Quaternion(r[0],r[1],r[2],r[3]);$=new THREE.Matrix4().makeRotationFromQuaternion(X);_.multiplyMatrices($,Z);X.setFromRotationMatrix(_);var b1=o.neutralQuatToNeutralEuler(X,K.value[3]);L=[b1[0]+U(K.value[0]),b1[1]+U(K.value[1]),b1[2]+U(K.value[2]),K.value[3]];W.updateKey(j,L,true);}else if(j===0){var c1=new THREE.Vector3(K.value[0],K.value[1],K.value[2]);$.makeRotationAxis(c1,K.value[3]);_.multiplyMatrices($,Z);X=new THREE.Quaternion().setFromRotationMatrix(_);L=this._convertQuaternionToAngleAxis(X);W.updateKey(j,L,true);break;}}W.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}}.bind(this));}if(!c){s._convertionDone=true;s._convertionDoneForReversed=false;}else{s._convertionDone=false;s._convertionDoneForReversed=true;}return this;};u.prototype._getTrackKeys=function(c){var k=[];var i=c.getKeysCount();for(var j=0;j<i;j++){var l=c.getKey(j);var v;if(Array.isArray(l.value)){v=l.value.slice();}else{v=l.value;}k.push({time:l.time,value:v});}return k;};u.prototype._setJointNodeOffsets=function(c,i){var j=this._getJointByChildNode(c);if(j){var k=new THREE.Matrix4();if(c.parent){k=c.parent.matrixWorld.clone();}var l=new THREE.Matrix4();c.updateMatrixWorld();var q=new THREE.Matrix4();if(j.parent){j.parent.updateMatrixWorld();q=j.parent.matrixWorld.clone();l.getInverse(j.parent.matrixWorld).multiply(c.matrixWorld);}else{l.copy(c.matrixWorld);}var r=new THREE.Vector3();var s=new THREE.Vector3();var v=new THREE.Quaternion();l.decompose(r,v,s);if(i===A.Translate){var x=r.toArray();c.userData.offsetTranslation=[x[0]-j.translation[0],x[1]-j.translation[1],x[2]-j.translation[2]];}else if(i===A.Scale){var y=s.toArray();this._adjustQuaternionAndScale(k,q,c.quaternion,v,c.scale.toArray(),y);c.userData.offsetScale=[y[0]/j.scale[0],y[1]/j.scale[1],y[2]/j.scale[2]];}else{this._adjustQuaternionAndScale(k,q,c.quaternion,v,c.scale.toArray(),s.toArray());var z=new THREE.Quaternion(j.quaternion[0],j.quaternion[1],j.quaternion[2],j.quaternion[3]);var D=new THREE.Matrix4().makeRotationFromQuaternion(z);var E=new THREE.Matrix4().getInverse(D);var M=new THREE.Matrix4().makeRotationFromQuaternion(v);var F=new THREE.Matrix4().multiplyMatrices(M,E);var G=new THREE.Quaternion().setFromRotationMatrix(F);c.userData.offsetQuaternion=G.toArray();}}return this;};u.prototype.setTranslationKey=function(c,i,s){var r;var j=false;var k=this.getCurrentView();if(k){var l=k.getPlayback(0);if(l&&l.getReversed()){j=true;}}var q=new THREE.Vector3();c.matrix.decompose(q,new THREE.Quaternion(),new THREE.Vector3());var v=this._getJointByChildNode(c);if(v){r=v.translation.slice();c.updateMatrixWorld();var x=new THREE.Matrix4();if(v.parent){v.parent.updateMatrixWorld();x.getInverse(v.parent.matrixWorld).multiply(c.matrixWorld);}else{x.matrix.copy(c.matrixWorld);}x.decompose(q,new THREE.Quaternion(),new THREE.Vector3());}else{var y=this.getRestTransformation(c,j);r=y.translation;}var z=q.toArray();var D=[z[0]-r[0],z[1]-r[1],z[2]-r[2]];var E=this._getEndPropertyInPreviousSequence(c,A.Translate,s);if(E){D[0]-=E[0];D[1]-=E[1];D[2]-=E[2];}var F=s.getNodeAnimation(c,A.Translate);var G;if(!F){F=this._scene.createTrack(null,{trackValueType:n.Vector3,isAbsoluteValue:false});s.setNodeAnimation(c,A.Translate,F,true);}else{G=this._getTrackKeys(F);}F.insertKey(i,D);var I=this._getTrackKeys(F);return{KeyValue:D,absoluteValue:z,offset:E,PreviousTrack:G,CurrentTrack:I};};u.prototype._adjustQuaternionAndScale=function(c,j,q,k,s,l){function r(v,Q,T,U){var W=Math.abs(v.dot(Q));var X=Math.abs(v.dot(T));var Y=Math.abs(v.dot(U));if(W>=X&&W>=Y){return 0;}else if(X>=W&&X>=Y){return 1;}else{return 2;}}if(s[0]>0&&s[1]>0&&s[2]>0){return;}var x=c.clone().multiply(new THREE.Matrix4().makeRotationFromQuaternion(q));var y=new THREE.Matrix4().makeRotationFromQuaternion(k);var z=j.clone().multiply(y);var D=new THREE.Vector3();var E=new THREE.Vector3();var F=new THREE.Vector3();x.extractBasis(D,E,F);var G=[D,E,F];var I=new THREE.Vector3();var J=new THREE.Vector3();var K=new THREE.Vector3();z.extractBasis(I,J,K);var L=[1,1,1];for(var i=0;i<3;i++){var M=r(G[i],I,J,K);if(s[i]*l[M]<0){L[M]=-1;l[M]=-l[M];}}y.scale(new THREE.Vector3(L[0],L[1],L[2]));var P=new THREE.Quaternion().setFromRotationMatrix(y);k.x=P.x;k.y=P.y;k.z=P.z;k.w=P.w;};u.prototype.setScaleKey=function(c,i,s){var r;var j=false;var k=this.getCurrentView();if(k){var l=k.getPlayback(0);if(l&&l.getReversed()){j=true;}}var q=c.scale.toArray();var v=c.quaternion.clone();var x=this._getJointByChildNode(c);if(x){var y=new THREE.Matrix4();if(c.parent){y=c.parent.matrixWorld.clone();}r=x.scale.slice();c.updateMatrixWorld();var z=new THREE.Matrix4();var D=new THREE.Matrix4();if(x.parent){x.parent.updateMatrixWorld();D=x.parent.matrixWorld.clone();z.getInverse(x.parent.matrixWorld).multiply(c.matrixWorld);}else{z.copy(c.matrixWorld);}var E=new THREE.Quaternion();var F=new THREE.Vector3();z.decompose(new THREE.Vector3(),E,F);var G=F.toArray();this._adjustQuaternionAndScale(y,D,v,E,q,G);q=G;}else{var I=this.getRestTransformation(c,j);r=I.scale;}var J=[q[0]/r[0],q[1]/r[1],q[2]/r[2]];var K=this._getEndPropertyInPreviousSequence(c,A.Scale,s);if(K){J[0]/=K[0];J[1]/=K[1];J[2]/=K[2];}var L=s.getNodeAnimation(c,A.Scale);var M;if(!L){L=this._scene.createTrack(null,{trackValueType:n.Vector3,isAbsoluteValue:false});s.setNodeAnimation(c,A.Scale,L,true);}else{M=this._getTrackKeys(L);}L.insertKey(i,J);var P=this._getTrackKeys(L);return{KeyValue:J,absoluteValue:q,offset:K,PreviousTrack:M,CurrentTrack:P};};u.prototype.setRotationKey=function(c,i,j,s){var k=36;var v=[j[0],j[1],j[2],k];var l=s.getNodeAnimation(c,A.Rotate);if(l&&l.getKeysType()!==n.Euler){return null;}var q;if(!l){l=this._scene.createTrack(null,{trackValueType:n.Euler,isAbsoluteValue:false});s.setNodeAnimation(c,A.Rotate,l,true);}else{q=this._getTrackKeys(l);}l.insertKey(i,v);var r=this._getTrackKeys(l);var x=new THREE.Quaternion();var y=new THREE.Euler(j[0],j[1],j[2]);x.setFromEuler(y);var z=this._getEndPropertyInPreviousSequence(c,A.Rotate,s);if(z){var D=new THREE.Quaternion(z[0],z[1],z[2],z[3]);x.multiply(D);}var E=new THREE.Quaternion();var F=this._getJointByChildNode(c);if(F){E.fromArray(F.quaternion);}else{var G=false;var I=this.getCurrentView();if(I){var J=I.getPlayback(0);if(J&&J.getReversed()){G=true;}}var K=this.getRestTransformation(c,G);E.fromArray(K.quaternion);}x.multiply(E);return{KeyValue:v,absoluteValue:x.toArray(),offset:z,PreviousTrack:q,CurrentTrack:r};};u.prototype.getTotalOpacity=function(c){return c._vkGetTotalOpacity(this._jointCollection);};u.prototype.setTotalOpacity=function(c,i){var j=1;var k=this._getJointByChildNode(c);if(k&&k.parent){j=k.parent._vkGetTotalOpacity(this._jointCollection);}else if(c.parent){j=c.parent._vkGetTotalOpacity(this._jointCollection);}if(!c.userData){c.userData={};}var l=this.getOpacity(c);if(j!==0.0){l=i/j;}else{i=0.0;}c._vkSetOpacity(l,this._jointCollection);var q={changed:c,opacity:l};this.fireOpacityChanged(q);return{opacity:l,totalOpacity:i};};u.prototype.setOpacityKey=function(c,i,s){var v=1;if(c.userData&&c.userData.opacity!==undefined&&c.userData.opacity!==null){v=c.userData.opacity;}var r=this.getRestOpacity(c);if(!r&&s._convertedFromAbsolute){r=1;}v/=r;var j=this._getEndPropertyInPreviousSequence(c,A.Opacity,s);if(j){v/=j;}var k=s.getNodeAnimation(c,A.Opacity);var l;if(!k){k=this._scene.createTrack(null,{trackValueType:n.Opacity});s.setNodeAnimation(c,A.Opacity,k,true);}else{l=this._getTrackKeys(k);}k.insertKey(i,v);var q=this._getTrackKeys(k);return{KeyValue:v,totalOpacity:this.getTotalOpacity(c),PreviousTrack:l,CurrentTrack:q};};p=function(){this._visibilityChanges=new Set();};p.prototype.getInfo=function(c){var i=[];this._visibilityChanges.forEach(function(j){var k=c.createNodeProxy(j);var v=k.getVeId();c.destroyNodeProxy(k);if(v){i.push(v);}else{i.push(c.getScene().nodeRefToPersistentId(j));}});return i;};p.prototype.clear=function(){this._visibilityChanges.clear();};p.prototype.trackNodeRef=function(c){if(this._visibilityChanges.has(c)){this._visibilityChanges.delete(c);}else{this._visibilityChanges.add(c);}};C.injectMethodsIntoClass(u);return u;});
