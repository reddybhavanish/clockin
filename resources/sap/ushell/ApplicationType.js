// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/URI","sap/base/Log","sap/ushell/utils","sap/ushell/URLTemplateProcessor","sap/ushell/_ApplicationType/utils","sap/ushell/_ApplicationType/systemAlias","sap/ushell/_ApplicationType/wdaResolution","sap/ushell/_ApplicationType/guiResolution","sap/ushell/services/_ClientSideTargetResolution/ParameterMapping","sap/ushell/Config"],function(U,L,u,a,A,s,w,g,p,C){"use strict";function b(z,B,E){var I=z.inbound;var R=I&&I.resolutionResult;if(!(!I||!R||!(R["sap.wda"]))){return w.constructFullWDAResolutionResult(z,B,E);}if(!(!I||!R)){return w.constructWDAResolutionResult(z,B,E);}}function c(z,B,E){var D=new U(B),I=z.inbound,F=I&&I.resolutionResult,G=jQuery.extend(true,{},z.mappedIntentParamsPlusSimpleDefaults),S,H;if(G["sap-system"]){S=G["sap-system"][0];delete G["sap-system"];}if(G["sap-system-src"]){H=G["sap-system-src"][0];delete G["sap-system-src"];}return new Promise(function(R,J){s.spliceSapSystemIntoURI(D,F.systemAlias,S,H,"WCF",F.systemAliasSemantics||s.SYSTEM_ALIAS_SEMANTICS.applied,E).done(function(K){var P=A.getURLParsing().paramsToString(G),N=A.appendParametersToUrl(P,K.toString());var O={url:N,text:F.text||"",additionalInformation:F.additionalInformation||"",applicationType:"WCF",fullWidth:true};R(O);}).fail(function(K){J(K);});});}function d(z,B,E){var I=z.inbound,D,S,F,G,R={};["applicationType","additionalInformation","applicationDependencies"].forEach(function(P){if(I.resolutionResult.hasOwnProperty(P)){R[P]=I.resolutionResult[P];}});R.url=B;if(R.applicationDependencies&&typeof R.url==="undefined"){R.url="";}if(typeof R.url==="undefined"){return Promise.reject("Cannot resolve intent: url was not specified in matched inbound");}G=jQuery.extend(true,{},z.mappedIntentParamsPlusSimpleDefaults);R.reservedParameters={};var H={"sap-ui-fl-max-layer":true,"sap-ui-fl-control-variant-id":true,"sap-ui-fl-version":true};Object.keys(H).forEach(function(N){var V=G[N];if(V){delete G[N];R.reservedParameters[N]=V;}});z.mappedDefaultedParamNames=z.mappedDefaultedParamNames.filter(function(J){return!H[J];});if(z.mappedDefaultedParamNames.length>0){G["sap-ushell-defaultedParameterNames"]=[JSON.stringify(z.mappedDefaultedParamNames)];}S=G["sap-system"]&&G["sap-system"][0];F=G["sap-system-src"]&&G["sap-system-src"][0];R["sap-system"]=S;if(typeof F==="string"){R["sap-system-src"]=F;}z.effectiveParameters=G;D=A.getURLParsing().paramsToString(G);if(D){R.url=R.url+((R.url.indexOf("?")<0)?"?":"&")+D;}if(typeof I.resolutionResult.ui5ComponentName!=="undefined"){R.ui5ComponentName=I.resolutionResult.ui5ComponentName;}R.text=I.title;return Promise.resolve(R);}function e(){var H=new U().fragment();var z=H.lastIndexOf("&/");if(z>0){return H.substr(z+1);}}function f(z){var B=z.targetNavigationMode;if(B===undefined||B===""){B="inplace";}return B;}function h(){var z=sap.ushell.Container.getService("UserInfo");var B=z.getUser();var D=sap.ui.getCore().getConfiguration();var E=u.getUi5Version();var F=B.getContentDensity();var T=B.getTheme();if(T.indexOf("sap_")!==0){var G=sap.ushell.User.prototype.constants.themeFormat.THEME_NAME_PLUS_URL;T=B.getTheme(G);}var H;var I;if(D){I=D.getLanguage&&D.getLanguage();H=D.getSAPLogonLanguage&&D.getSAPLogonLanguage();}var J=window.location.protocol+"//"+window.location.host+"/comsapuitheming.runtime/themeroot/v1";var K=0;if(C.last("/core/shell/sessionTimeoutIntervalInMinutes")>0){K=C.last("/core/shell/sessionTimeoutIntervalInMinutes");}return{language:I,logonLanguage:H,theme:T,themeServiceRoot:J,isDebugMode:!!window["sap-ui-debug"],ui5Version:E,contentDensity:F,sapPlugins:j(),innerAppState:i(),sessionTimeout:K};}function i(){var H=window.hasher&&window.hasher.getHash(),K="",P;if(H&&H.length>0&&H.indexOf("sap-iapp-state=")>0){P=/(?:sap-iapp-state=)([^&/\\]+)/.exec(H);if(P&&P.length===2){K=P[1];}}return K;}function j(){var S=sap.ushell.Container.getService("PluginManager");if(S){return S._getNamesOfPluginsWithAgents();}else{return"";}}function k(z,B,E){var I=z.inbound;var T=I.templateContext;var R={innerAppRoute:e()||z.parsedIntent.appSpecificRoute,targetNavMode:f(z),defaultParameterNames:z.mappedDefaultedParamNames,startupParameter:z.mappedIntentParamsPlusSimpleDefaults,env:h()};var D=a.expand(T.payload,T.site,R,T.siteAppSection,"startupParameter");var F={applicationType:"URL",text:I.title,appCapabilities:l(T.payload.capabilities||{},T.siteAppSection),url:D,extendedInfo:o(z,D)};return q(D).then(function(G){F.url=G;return F;},function(){return F;});}function l(T,S){var z=u.clone(T);z.navigationMode=m(T.navigationMode,S);return z;}function m(T,S){var z=n(T);var B=u.getMember(S,"sap|integration.navMode");switch(B){case"inplace":return"embedded";case"explace":if(z==="embedded"){return"newWindowThenEmbedded";}if(["newWindowThenEmbedded","newWindow"].indexOf(z)>=0){return z;}L.error("App-defined navigation mode was ignored","Application requests to be opened in a new window but no expected navigation mode was defined on the template","sap.ushell.ApplicationType");default:return z;}}function n(z){var I;switch(z){case"inplace":I="embedded";break;case"explace":I="newWindow";break;default:I=z||"newWindow";}return I;}function o(z){var I={};I.appParams={};if(z.mappedIntentParamsPlusSimpleDefaults){I.appParams=JSON.parse(JSON.stringify(z.mappedIntentParamsPlusSimpleDefaults));}return I;}function q(z){return new Promise(function(R,B){var D=new U(z);var P=D.query(true);sap.ushell.Container.getService("ShellNavigation").compactParams(P,["sap-language","sap-theme","sap-ui-app-id","transaction"],undefined,true).done(function(E){if(!E.hasOwnProperty("sap-intent-param")){R(z);return;}D.query(E);var F=D.toString();R(F);}).fail(function(E){B(E);});});}function r(z,B,E){var I=z.inbound,D=I&&I.resolutionResult,R={};var F=new U(B);var G=jQuery.extend(true,{},z.mappedIntentParamsPlusSimpleDefaults);if(z.inbound&&z.inbound.action==="launchURL"&&z.inbound.semanticObject==="Shell"){delete G["sap-external-url"];}var S=G["sap-system"]&&G["sap-system"][0];var H=G["sap-system-src"]&&G["sap-system-src"][0];R["sap-system"]=S;delete G["sap-system"];if(typeof H==="string"){R["sap-system-src"]=H;delete G["sap-system-src"];}return(new Promise(function(J,K){if(A.absoluteUrlDefinedByUser(F,D.systemAlias,D.systemAliasSemantics)){J(B);}else{s.spliceSapSystemIntoURI(F,D.systemAlias,S,H,"URL",D.systemAliasSemantics||s.SYSTEM_ALIAS_SEMANTICS.applied,E).fail(K).done(function(N){var O=N.toString();J(O);});}})).then(function(J){var P=A.getURLParsing().paramsToString(G);var K=C.last("/core/navigation/flpURLDetectionPattern");var N=new RegExp(K);return N.test(J)?A.appendParametersToIntentURL(G,J):A.appendParametersToUrl(P,J);},Promise.reject.bind(Promise)).then(function(J){["additionalInformation","applicationDependencies"].forEach(function(P){if(I.resolutionResult.hasOwnProperty(P)){R[P]=I.resolutionResult[P];}});R.url=J;R.text=I.title;R.applicationType="URL";return Promise.resolve(R);},Promise.reject.bind(Promise));}var t={URL:{type:"URL",defaultFullWidthSetting:true,generateResolutionResult:function(z){var B=z.inbound.hasOwnProperty("templateContext");return B?k.apply(null,arguments):r.apply(null,arguments);},easyAccessMenu:{intent:"Shell-startURL",resolver:null,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:false,systemSelectionPriority:1}},WDA:{type:"WDA",defaultFullWidthSetting:true,generateResolutionResult:b,easyAccessMenu:{intent:"Shell-startWDA",resolver:w.resolveEasyAccessMenuIntentWDA,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:true,systemSelectionPriority:2}},TR:{type:"TR",defaultFullWidthSetting:true,generateResolutionResult:g.generateTRResolutionResult,easyAccessMenu:{intent:"Shell-startGUI",resolver:g.resolveEasyAccessMenuIntentWebgui,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:true,systemSelectionPriority:3}},NWBC:{type:"NWBC",defaultFullWidthSetting:true},WCF:{type:"WCF",generateResolutionResult:c,defaultFullWidthSetting:true},SAPUI5:{type:"SAPUI5",generateResolutionResult:d,defaultFullWidthSetting:false}};function v(){return Object.keys(t).map(function(z){return t[z];}).filter(function(z){return typeof z.easyAccessMenu==="object";});}function x(){var E={};v().forEach(function(z){E[z.easyAccessMenu.intent]=z.easyAccessMenu.resolver;});return function(z,R){if(E[z]&&(!R||R!=="SAPUI5")){return E[z];}return null;};}function y(z){if(!t[z]){return false;}return t[z].defaultFullWidthSetting;}Object.defineProperty(t,"enum",{value:Object.keys(t).reduce(function(z,B){if(t[B].type){z[B]=t[B].type;}return z;},{})});var M={getEasyAccessMenuResolver:x(),getEasyAccessMenuDefinitions:v,getDefaultFullWidthSetting:y};Object.keys(M).forEach(function(z){Object.defineProperty(t,z,{value:M[z]});});return t;},true);
