// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/library","sap/ui/model/json/JSONModel","sap/ushell/Config","sap/ushell/utils/clone","sap/ui/core/MessageType"],function(u,J,C,c,M){"use strict";var V=u.VisualizationLoadState;var m,p,r={},v=new J({sizeBehavior:C.last("/core/home/sizeBehavior")}),_=C.on("/core/home/sizeBehavior").do(function(s){v.setProperty("/sizeBehavior",s);});function a(o){var P=o.getBindingContext().getPath().split("/"),i=P.pop();P.pop();return{visualizationIndex:i,sectionIndex:P.pop()};}function b(o){var g=o.getBindingContext();var i=g.getProperty(g.getPath())&&g.getProperty(g.getPath()).inboundPermanentKey;var t=o.getTarget&&o.getTarget();return i||!t||t[0]!=="#";}function d(t){var T=c(t);if(T.subTitle){T.subtitle=T.subTitle;delete T.subTitle;}if(T.iconUrl){T.icon=T.iconUrl;delete T.iconUrl;}if(T.tileType!=="STATIC"&&T.tileType!=="DYNAMIC"&&!T.info){T.info="["+r.i18n.getText("Title.CustomTile")+"]";}return T;}function e(g){var R=m.getModel("roles");var A=R.getProperty("/availableVisualizations");return(A.indexOf(g.getVisualizationId())>-1);}function f(g){var R=m.getModel("roles");var A=R.getProperty("/allVisualizations");return(A.indexOf(g.getVisualizationId())>-1);}return{init:function(o){m=o;p=o.getView().byId("page");p.setModel(o.getModel());p.setModel(v,"viewSettings");r.i18n=o.getResourceBundle();var E=o.getModel().getProperty("/edit");p.toggleStyleClass("sapUshellPageComposing",!!E);},exit:function(){_.off();},visualizationFactory:function(i,B,F){if(!m.oVisualizationLoadingService){throw new Error("Visualization Service was not loaded yet!");}var t=B.getProperty(),o=m.oVisualizationLoadingService.instantiateVisualization({vizId:t.vizId,previewMode:true,localLoad:true,tileType:(t.tileType==="DYNAMIC"?"sap.ushell.ui.tile.DynamicTile":"sap.ushell.ui.tile.StaticTile"),properties:d(t)}),G={Press:"Press",Remove:"Remove"};if(!F){o.setBindingContext(B);o.bindProperty("state","state");}o._getInnerControlPromise().then(function(){var I=o.getInnerControl().getContent?o.getInnerControl().getContent()[0]:o.getInnerControl();I.attachPress(function(E){switch(E.getParameter("action")){case G.Remove:var g=a(o);m.deleteVisualizationInSection(g.visualizationIndex,g.sectionIndex);break;case G.Press:default:o.fireEvent("press");break;}});I.bindProperty("sizeBehavior","viewSettings>/sizeBehavior");I.setScope((m.getModel().getProperty("/edit")&&!F)?"Actions":"Display");});o.attachPress(function(E){var g=E.getSource(),P=m.getView().byId("pagePreviewDialog");if(p.getProperty("edit")||(P&&P.isOpen())){m._openTileInfoPopover(g,g.getBindingContext());}});return o;},previewVisualizationFactory:function(i,B){return this.visualizationFactory(i,B,true);},collectMessages:function(){var E=[],w=[];p.getSections().forEach(function(s,S){var o=s.byId("title-edit");if(s.getTitle()===""){o.setValueState("Warning");o.setValueStateText(r.i18n.getText("Message.InvalidSectionTitle"));w.push({type:M.Warning,title:r.i18n.getText("Title.NoSectionTitle",S+1),description:r.i18n.getText("Message.NoSectionTitle",S+1)});}else{o.setValueState("None");}s.getVisualizations().forEach(function(g,i){if(!f(g)){E.push({type:M.Error,title:r.i18n.getText("Title.UnsufficientRoles"),subtitle:r.i18n.getText("Title.VisualizationIsNotVisible"),description:r.i18n.getText("Message.LoadTileError",[(i+1)+".",s.getTitle()])});g.setState(V.InsufficentRoles);}else if(!e(g)){w.push({type:M.Information,title:r.i18n.getText("Message.VisualizationNotAvailableInContext"),subtitle:r.i18n.getText("Message.VisualizationNotAvailableInContext"),description:r.i18n.getText("Message.VisualizationOutOfContextError",g.getTitle()||g.getCatalogTile()&&g.getCatalogTile().getTitle()||g.getVisualizationId())});g.setState(V.OutOfRoleContext);}else if(!b(g)){w.push({type:M.Warning,title:r.i18n.getText("Message.NavigationTargetError"),subtitle:r.i18n.getText("Title.VisualizationNotNavigateable"),description:r.i18n.getText("Message.NavTargetResolutionError",g.getTitle()||g.getCatalogTile()&&g.getCatalogTile().getTitle()||g.getVisualizationId())});g.setState(V.NoNavTarget);}else if(g.getState()===V.OutOfRoleContext){g.setState(V.Loaded);}});});return{errors:E,warnings:w};},addSection:function(E){var s=E?E.getParameter("index"):0;m.addSectionAt(s);},deleteSection:function(E){var s=E.getSource(),t=s.getTitle(),g=t?r.i18n.getText("Message.Section.Delete",t):r.i18n.getText("Message.Section.DeleteNoTitle");sap.ui.require(["sap/m/MessageBox"],function(h){function i(A){if(A===h.Action.DELETE){m.deleteSection(p.indexOfSection(s));}}sap.ushell.Container.getService("Message").confirm(g,i,r.i18n.getText("Button.Delete"),[h.Action.DELETE,h.Action.CANCEL]);});},moveSection:function(i){var D=i.getParameter("draggedControl"),o=i.getParameter("droppedControl"),I=i.getParameter("dropPosition"),g=p.indexOfSection(D),h=p.indexOfSection(o);if(I==="After"){if(h<g){h++;}}else if(h>g){h--;}m.moveSection(g,h);},moveVisualization:function(D){var o=D.getParameter("draggedControl"),g=D.getParameter("droppedControl"),i=D.getParameter("dropPosition");if(g.isA("sap.ushell.ui.launchpad.Section")){var h=a(o),s=p.indexOfSection(g),B=o.getBindingContext();m.addVisualizationToSection(B.getModel().getProperty(B.getPath()),[s],0);m.deleteVisualizationInSection(h.visualizationIndex,h.sectionIndex);return;}var j=a(g),k=j.visualizationIndex,l=j.sectionIndex;if(o.isA("sap.m.ListItemBase")){var n=D.getParameter("dragSession").getComplexData("callback");if(i==="After"){k++;}n(k,l);return;}var q=a(o),t=q.visualizationIndex,w=q.sectionIndex;if(w===l){if(i==="After"){if(k<t){k++;}}else if(k>t){k--;}}else if(i==="After"){k++;}m.moveVisualizationInSection(t,k,w,l);},addVisualization:function(D){var o=D.getParameter("draggedControl"),g=D.getParameter("droppedControl"),i=g.getVisualizations().length,h=p.indexOfSection(g);if(o.isA("sap.m.ListItemBase")){D.getParameter("dragSession").getComplexData("callback")(i,h);return;}var j=a(o),k=j.visualizationIndex,l=j.sectionIndex;m.moveVisualizationInSection(k,i,l,h);}};});
