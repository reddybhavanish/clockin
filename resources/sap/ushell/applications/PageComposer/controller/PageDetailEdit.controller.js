// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/MessagePopover","sap/m/MessageItem","./BaseController","./Page","./TileSelector","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/MessageToast","sap/base/Log","./ConfirmChangesDialog.controller"],function(M,a,B,P,T,F,J,b,c,L,C){"use strict";function _(e){e.setData({page:{},edit:false,dirtyPage:false,errors:[],warnings:[],messages:[],headerExpanded:true,catalogsExpanded:true});}var m=new J();var d=B.extend("sap.ushell.applications.PageComposer.controller.PageDetailEdit",{_setDirtyFlag:function(v){sap.ushell.Container.setDirtyFlag(v);m.setProperty("/dirtyPage",v);},onInit:function(){var l=this.getView().byId("layoutContent"),t=this.getView().byId("toggleCatalogsButton"),r=this.getRouter();r.getRoute("edit").attachPatternMatched(this._onPageMatched,this);this.setModel(m);this.Page.init(this);this.getView().addEventDelegate({onBeforeHide:this.onRouteLeave.bind(this)});l.attachBreakpointChanged(function(e){t.setVisible(e.getParameters().currentBreakpoint!=="S");});},onExit:function(){B.prototype.onExit.apply(this,arguments);this.Page.exit();},Page:P,TileSelector:new T(),oMessagePopover:new M("layoutMessagePopover",{items:{path:"/messages",template:new a({type:"{type}",title:"{title}",activeTitle:"{active}",description:"{description}",subtitle:"{subTitle}",counter:"{counter}"})},beforeOpen:function(){this.addStyleClass("sapUshellMessagePopoverNoResize");}}).setModel(m),handleMessagePopoverPress:function(e){this.oMessagePopover.toggle(e.getSource());},onUpdateSideContentVisibility:function(){m.setProperty("/catalogsExpanded",!m.getProperty("/catalogsExpanded"));},_handlePageSaveError:function(s,e){if(s.statusCode==="412"||s.statusCode==="400"){this._showConfirmChangesDialog(s,e);}else{this.showMessageBoxError(s.message,false);}this._setDirtyFlag(true);},onSave:function(){var r=this.getResourceBundle(),s=function(f){if(f===b.Action.OK){this._setDirtyFlag(false);this.getView().setBusy(true);this.savePageAndUpdateModel(m.getProperty("/page")).then(function(){c.show(r.getText("Message.SavedChanges"),{closeOnBrowserNavigation:false});this._setDirtyFlag(false);}.bind(this)).catch(function(S){this.getPageRepository().getPageWithoutStoringETag(m.getProperty("/page/id")).then(function(g){this._handlePageSaveError(S,g.modifiedByFullname||g.modifiedBy);}.bind(this)).catch(function(){this._handlePageSaveError(S);}.bind(this));}.bind(this)).finally(function(){this.getView().setBusy(false);}.bind(this));}}.bind(this);if(!m.getProperty("/page/title")){this.showMessageBoxError(r.getText("Message.EmptyTitle"));m.setProperty("/headerExpanded",true);return;}if(!window.navigator.onLine){this.showMessageBoxError(r.getText("Message.NoInternetConnection"));return;}if(m.getProperty("/errors").length>0){var t=r.getText("Title.TilesHaveErrors"),e=r.getText("Message.TilesHaveErrors");sap.ushell.Container.getService("Message").confirm(e,s,t);return;}s(b.Action.OK);},_showConfirmChangesDialog:function(s,e){if(!this.byId("confirmChangesDialog")){F.load({name:"sap.ushell.applications.PageComposer.view.ConfirmChangesDialog",controller:new C(this.getView(),this.getResourceBundle())}).then(function(D){if(s.statusCode==="412"){var o=sap.ui.getCore().byId("confirmChangesModifiedByText");o.setVisible(true);}var f=e||this.getModel().getProperty("/page/modifiedByFullname");this.getModel().setProperty("/simpleError",{message:s.message,statusCode:s.statusCode,modifiedBy:f});this.getView().addDependent(D);D.open();}.bind(this));}else{this.byId("confirmChangesDialog").open();}},onCancel:function(){this.navigateBack();},onOpenTileInfo:function(e){var E=e.getSource();this._openTileInfoPopover(E,E.getBindingContext());},showContextSelector:function(o){sap.ui.require(["sap/ushell/applications/PageComposer/controller/ContextSelector.controller"],function(e){var p=this.getModel().getProperty("/page/id");this.getPageRepository().getRoles(p).then(function(r){if(!this.oContextSelectorController){this.oContextSelectorController=new e(this.getRootView(),this.getResourceBundle());}var s=this.getModel("roles").getProperty("/selected");this.oContextSelectorController.openSelector(r,s,o).catch(function(f){this.oContextSelectorController.destroy();this.handleBackendError(f);}.bind(this));}.bind(this)).catch(function(E){this.showMessageBoxError(E,false);}.bind(this));}.bind(this));},onOpenContextSelector:function(){this.showContextSelector(function(s){this._resetRolesModel(s);this.collectPageMessages();this.TileSelector.refreshRoleContext();}.bind(this));},_formatLength:function(o){return(o?o.length:undefined);},_updatePageWithMetadata:function(e){if(e&&e.transportId){m.setProperty("/page/transportId",e.transportId);this._setDirtyFlag(true);}},_loadAndInitPage:function(p){return this._loadPage(p).then(function(o){this._pageEditAllowed(o).then(function(e){if(!e){return;}m.setProperty("/page",o);m.setProperty("/edit",true);this.checkShowEditDialog(o,this._updatePageWithMetadata.bind(this),this.navigateBack.bind(this));this.Page.init(this);if(!m.getProperty("/page/sections").length){this.Page.addSection();}else{this._setDirtyFlag(false);}}.bind(this));}.bind(this));},_onPageMatched:function(e){var A=e.getParameter("arguments");var p=decodeURIComponent(A.pageId);this.getView().setBusy(true);_(m);this._loadAndInitPage(p).then(function(){return this.getPageRepository().getRoles(p);}.bind(this)).then(function(r){var R=r.map(function(o){return o.id;});this._resetRolesModel({available:R});this.TileSelector.init(this);this.TileSelector.initTiles();this.TileSelector.setAddTileHandler(this.addVisualizationToSection.bind(this));this.collectPageMessages();}.bind(this)).catch(function(){this.navigateToErrorPage(p);}.bind(this)).finally(function(){this.getView().setBusy(false);}.bind(this));},_pageEditAllowed:function(p){var e=!this.checkMasterLanguageMismatch(p);return Promise.resolve(e);},savePageAndUpdateModel:function(p){return this.getPageRepository().updatePage(p).then(function(r){m.setProperty("/page",r);});},collectPageMessages:function(){var o=this.Page.collectMessages(),e=o.errors,w=o.warnings,f=e.concat(w);m.setProperty("/errors",e);m.setProperty("/warnings",w);m.setProperty("/messages",f);},onSectionTitleChange:function(){this._setDirtyFlag(true);this.collectPageMessages();},addSectionAt:function(s){var S=this.getModel().getProperty("/page/sections");if(!S){L.warning("The Model is not ready yet.");return;}if((!s&&s!==0)||s>S.length){s=S.length;}S.splice(s,0,{title:"",viz:[]});this.getModel().setProperty("/page/sections",S);var p=this.getView().byId("page");if(s===S.length-1){var D={onAfterRendering:function(){setTimeout(function(){p.getSections()[s].byId("title-edit").focus();},0);p.removeEventDelegate(D);}};p.addEventDelegate(D);}else{p.getSections()[s].byId("title-edit").focus();}this.collectPageMessages();this._setDirtyFlag(true);},deleteSection:function(s){if((!s&&s!==0)||s<0){return;}var S=this.getModel().getProperty("/page/sections");if(s<S.length){S.splice(s,1);this.getModel().setProperty("/page/sections",S);c.show(this.getResourceBundle().getText("Message.SectionDeleted"));var p=this.getView().byId("page"),e=p.getSections();if(S.length){e=p.getDomRef().getElementsByClassName("sapUshellPageSection");e[s!==0?s-1:s].focus();}else{var D={onAfterRendering:function(){p.focus();p.removeEventDelegate(D);}};p.addEventDelegate(D);}this.collectPageMessages();this._setDirtyFlag(true);}},moveSection:function(o,n){if(!o&&o!==0||!n&&n!==0){return;}var s=m.getProperty("/page/sections"),S=s.splice(o,1)[0];s.splice(n,0,S);m.setProperty("/page/sections",s);this.collectPageMessages();this._setDirtyFlag(true);},addVisualizationToSection:function(v,s,e){if(!v||!s.length){return;}s.forEach(function(S){var V=m.getProperty("/page/sections/"+S+"/viz");if(!V){L.warning("The Model is not ready yet.");return;}if(typeof e==="undefined"){e=V.length;}V.splice(e,0,v);m.setProperty("/page/sections/"+S+"/viz",V);this.collectPageMessages();this._setDirtyFlag(true);}.bind(this));},deleteVisualizationInSection:function(v,s){var p="/page/sections/"+s+"/viz",V=m.getProperty(p);V.splice(v,1);m.setProperty(p,V);c.show(this.getResourceBundle().getText("Message.VisualizationDeleted"));this.collectPageMessages();this._setDirtyFlag(true);},moveVisualizationInSection:function(o,n,e,f){if(!o&&o!==0||!n&&n!==0||!e&&e!==0||!f&&f!==0){return;}var O="/page/sections/"+e+"/viz",N="/page/sections/"+f+"/viz",g=m.getProperty(O),h=m.getProperty(N),i=g.splice(o,1);h.splice(n,0,i[0]);m.setProperty(O,g);m.setProperty(N,h);this.collectPageMessages();this._setDirtyFlag(true);},openEditPageHeaderDialog:function(){sap.ui.require(["sap/ushell/applications/PageComposer/controller/EditPageHeaderDialog.controller"],function(E){if(!this.oEditPageHeaderDialogController){this.oEditPageHeaderDialogController=new E(this.getRootView());}this.oEditPageHeaderDialogController.attachConfirm(this.editPageHeaderConfirm.bind(this));this.oEditPageHeaderDialogController.load().then(function(){this.oEditPageHeaderDialogController.open();this.oEditPageHeaderDialogController.getModel().setProperty("/id",m.getProperty("/page/id"));this.oEditPageHeaderDialogController.getModel().setProperty("/title",m.getProperty("/page/title"));this.oEditPageHeaderDialogController.getModel().setProperty("/description",m.getProperty("/page/description"));this.oEditPageHeaderDialogController.initialTitleValidation();}.bind(this));}.bind(this));},editPageHeaderConfirm:function(r){if(m.getProperty("/page/title")!==r.title){m.setProperty("/page/title",r.title);}if(m.getProperty("/page/description")!==r.description){m.setProperty("/page/description",r.description||"");}this._setDirtyFlag(true);},_checkPageHasErrors:function(p){if(p.code!==""){var e=this.formatAssignmentDetailsMessage(p.code);this.showMessageBoxWarning(p.message,e,true);return true;}return false;}});return d;});
