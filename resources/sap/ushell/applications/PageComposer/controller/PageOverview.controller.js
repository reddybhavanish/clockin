// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["./BaseController","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(B,M,J,F,a){"use strict";return B.extend("sap.ushell.applications.PageComposer.controller.Main",{aPropertiesToFilterCustomerCreated:["id","title","description","createdByFullname","modifiedByFullname","BusinessRoleId","BusinessRole"],aPropertiesToFilterSapDelivered:["id","title","description"],oDialogFactory:null,sCurrentTableId:"customerCreatedTable",aPropertiesToFilter:[],aSearchFilter:[],mViewSettingsFilters:[],onInit:function(){this.setModel(new J({busy:false,pages:[],transportSupported:this.getOwnerComponent().isTransportSupported()}));this.getRouter().getRoute("overview").attachPatternMatched(this._onPageOverviewMatched,this);this.setModel(this._createInitialButtonStateModel(),"buttonStates");this.aPropertiesToFilter=this.aPropertiesToFilterCustomerCreated;},onItemPress:function(e){var p=this.getPageInTable(e.getParameter("listItem"));this._navigateToDetail(p.id);},_onPageOverviewMatched:function(){this._refreshModel();},_navigateToEdit:function(p){this.getRouter().navTo("edit",{pageId:encodeURIComponent(p)});},_navigateToDetail:function(p){this.getRouter().navTo("view",{pageId:encodeURIComponent(p)});},onSelectionChange:function(e){this._setDeleteAndCopyButtonEnabled(true);},onTabChange:function(e){var s=this.byId("iconTabBar").getProperty("selectedKey");if(s==="iconTabBarSapDelivered"){this.getOwnerComponent().setMetaModelDataSapDelivered();this.sCurrentTableId="sapDeliveredTable";this.aPropertiesToFilter=this.aPropertiesToFilterSapDelivered;}else{this.getOwnerComponent().setMetaModelData();this.sCurrentTableId="customerCreatedTable";this.aPropertiesToFilter=this.aPropertiesToFilterCustomerCreated;}},onEdit:function(e){var p=this.getPageInTable(e.getSource());this._navigateToEdit(p.id);},onAdd:function(){var r=this.getResourceBundle();this.showCreateDialog(function(p){sap.ushell.Container.getServiceAsync("PageReferencing").then(function(P){return P.createReferencePage(p);}).then(function(R){return this.getPageRepository().createPage(R);}.bind(this)).then(function(){this._navigateToDetail(p.id);M.show(r.getText("Message.PageCreated"),{closeOnBrowserNavigation:false});}.bind(this)).catch(this.handleBackendError.bind(this));}.bind(this));},_deletePage:function(e){var r=this.getResourceBundle(),d=e.getSource().getParent(),t=e.transportId||"",T=this.byId(this.sCurrentTableId),i=T.getSelectedItems().map(function(b){return b.getBindingContext().getObject();}),s=r.getText("Message.SuccessDeletePage"),D=i.map(function(I){return this.getPageRepository().deletePage(I.id,t);}.bind(this));return Promise.all(D).then(function(){return this._refreshModel();}.bind(this)).then(function(){T.removeSelections();this._setDeleteAndCopyButtonEnabled(false);T.fireSelectionChange();M.show(s,{closeOnBrowserNavigation:false});d.close();}.bind(this)).catch(this.handleBackendError.bind(this));},onDelete:function(){var t=this.byId(this.sCurrentTableId),s=t.getSelectedItem();if(!s){return;}this.checkShowDeleteDialog(s.getBindingContext().getObject(),this._deletePage.bind(this));},getPageInTable:function(s){return s.getBindingContext(this.sCurrentTableId==="customerCreatedTable"?undefined:"PageRepository").getObject();},onCopy:function(){var t=this.byId(this.sCurrentTableId),s=t.getSelectedItem(),r=this.getResourceBundle();if(!s){return;}var p=this.getPageInTable(s);this.showCopyDialog(p,function(b){this.pageInfo=b;sap.ushell.Container.getServiceAsync("PageReferencing").then(function(P){return P.createReferencePage(b);}).then(function(R){return this.getPageRepository().copyPage(R);}.bind(this)).then(function(){return this._refreshModel();}.bind(this)).then(function(){this._navigateToDetail(this.pageInfo.targetId);M.show(r.getText("Message.PageCreated"),{closeOnBrowserNavigation:false});}.bind(this)).catch(this.handleBackendError.bind(this));}.bind(this));},onSearch:function(e){var t=this.byId(this.sCurrentTableId),b=t.getBinding("items"),r=this.getResourceBundle(),s=e.getSource().getValue(),f=this.aPropertiesToFilter.map(function(p){return new F({path:p,operator:a.Contains,value1:s});});this.aSearchFilter[this.sCurrentTableId]=new F({filters:f,and:false});this._applyCombinedFilters();if(b.getLength()===0){if(s){t.setNoDataText(r.getText("Message.NoPagesFound"));}else{t.setNoDataText(r.getText("Message.NoPages"));}}},_refreshModel:function(){this.getModel().setProperty("/busy",true);return this._loadAvailablePages().then(function(p){this.getModel().setSizeLimit(p.pages.length);this.getModel().setProperty("/pages",p.pages);this.getModel().setProperty("/busy",false);}.bind(this),function(e){this.getModel().setProperty("/busy",false);this.showMessageBoxError(e);}.bind(this));},onTableUpdate:function(){var t=this.byId(this.sCurrentTableId);if(t.getSelectedItems().length===0){t.removeSelections(true);this._setDeleteAndCopyButtonEnabled(false);}},_loadAvailablePages:function(){return this.getPageRepository().getPages().then(function(p){return{pages:p};});},_createInitialButtonStateModel:function(){return new J({isDeleteAndCopyEnabledCustomerCreated:false,isDeleteAndCopyEnabledSapDelivered:false});},_setDeleteAndCopyButtonEnabled:function(e){this.getView().getModel("buttonStates").setProperty(this.sCurrentTableId==="customerCreatedTable"?"/isDeleteAndCopyEnabledCustomerCreated":"/isDeleteAndCopyEnabledSapDelivered",e);},onErrorMessageClicked:function(e){var s=e.getSource().getBindingContext().getObject(),E=s.message,b=this.formatAssignmentDetailsMessage(s.code);this.showMessageBoxWarning(E,b,false);},_removeDuplicates:function(p,P){var k={},K=[];p.forEach(function(o){var n=o[P];if(!k[n]){k[n]=true;K.push({key:n});}});return K;},showViewSettingsCustomerCreatedDialog:function(t){if(this._oViewSettingsCustomerCreatedDialog){this._oViewSettingsCustomerCreatedDialog.open(t);return;}sap.ui.require(["sap/ui/core/Fragment","sap/ui/Device","sap/ushell/applications/PageComposer/controller/ViewSettingsCustomerCreatedDialog.controller"],function(b,D,V){b.load({name:"sap.ushell.applications.PageComposer.view.ViewSettingsCustomerCreatedDialog",type:"XML",controller:new V(this)}).then(function(f){this._oViewSettingsCustomerCreatedDialog=f;if(D.system.desktop){f.addStyleClass("sapUiSizeCompact");}var p=this.getModel().getProperty("/pages");f.setModel(new J({assignmentCodeStatus:this._removeDuplicates(p,"assignmentCodeStatus"),assignmentState:this._removeDuplicates(p,"assignmentState"),devclass:this._removeDuplicates(p,"devclass",true),transportId:this._removeDuplicates(p,"transportId",true),createdByFullname:this._removeDuplicates(p,"createdByFullname"),modifiedByFullname:this._removeDuplicates(p,"modifiedByFullname")}),"uniqueValues");if(!this.getModel().getData().transportSupported){f.removeFilterItem("CustomerCreatedPackageFilter");f.removeFilterItem("CustomerCreatedWorkbenchRequestFilter");f.removeSortItem("CustomerCreatedPackageSort");f.removeSortItem("CustomerCreatedWorkbenchRequestSort");f.removeGroupItem("CustomerCreatedPackageGroup");f.removeGroupItem("CustomerCreatedWorkbenchRequestGroup");}this.getView().addDependent(f);f.open(t);}.bind(this));}.bind(this));},showViewSettingsSapDeliveredDialog:function(t){if(this._oViewSettingsSapDeliveredDialog){this._oViewSettingsSapDeliveredDialog.open(t);return;}sap.ui.require(["sap/ui/core/Fragment","sap/ui/Device","sap/ushell/applications/PageComposer/controller/ViewSettingsSapDeliveredDialog.controller"],function(b,D,V){b.load({name:"sap.ushell.applications.PageComposer.view.ViewSettingsSapDeliveredDialog",type:"XML",controller:new V(this)}).then(function(f){this._oViewSettingsSapDeliveredDialog=f;var p=this.getModel().getProperty("/pages");f.setModel(new J({id:this._removeDuplicates(p,"id"),title:this._removeDuplicates(p,"title",true),description:this._removeDuplicates(p,"description",true)}),"uniqueValues");if(!this.getModel().getData().transportSupported){f.removeFilterItem("SapDeliveredPackageFilter");f.removeFilterItem("SapDeliveredWorkbenchRequestFilter");f.removeSortItem("SapDeliveredPackageSort");f.removeSortItem("SapDeliveredWorkbenchRequestSort");f.removeGroupItem("SapDeliveredPackageGroup");f.removeGroupItem("SapDeliveredWorkbenchRequestGroup");}this.getView().addDependent(f);f.open(t);}.bind(this));}.bind(this));},_applyCombinedFilters:function(){var f=this.mViewSettingsFilters[this.sCurrentTableId]||{},b=this.byId(this.sCurrentTableId).getBinding("items");var c=[];var p=[];for(var d in f){p.push(new F({filters:f[d],and:false}));}c=c.concat(p);if(this.aSearchFilter[this.sCurrentTableId]){c=c.concat(this.aSearchFilter[this.sCurrentTableId]);}if(c.length===0){b.filter(new F({path:"id",operator:a.Contains,value1:""}));}else{b.filter(new F({filters:c,and:true}));}}});});
