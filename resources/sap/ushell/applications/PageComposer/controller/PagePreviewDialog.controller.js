// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ushell/Config"],function(C,F,J,a,b){"use strict";var _,c,d="";function e(){var A,o=new a({path:"vizId",caseSensitive:true,test:function(v){return!A||A.indexOf(v)>=0;}}),p=_&&_.getContent()[0];if(p){var r=_.getModel("roleContext").getProperty("/selectedRoles")||[];A=c.getController().getPageRepository().getVizIds(r);p.getSections().forEach(function(s){s.getBinding("visualizations").filter(o);});}}function f(r,s){if(_){var m=_.getModel("roleContext");s=s||m.getProperty("/selectedRoles")||[];r=r||m.getProperty("/allRoles")||[];var A=!s.length||s.length===r.length,S=A?d:s.length||"";m.setData({allRoles:r,selectedRoles:s,selectedCountText:S});if(r.length){e();}}}var P=C.extend("sap.ushell.applications.PageComposer.controller.PagePreviewDialog.controller",{load:function(p){return _?Promise.resolve(_):F.load({id:p,name:"sap.ushell.applications.PageComposer.view.PagePreviewDialog",controller:this});},open:function(p){c=p;var s=p.getModel().getProperty("/page/id");d=p.getController().getResourceBundle().getText("Message.AllRolesSelected");this.load(p.getId()).then(function(D){_=D;_._oParentView=c;p.addDependent(D);D.setModel(new J({sizeBehavior:b.last("/core/home/sizeBehavior")}),"viewSettings");var o=p.getModel("roles"),g=o&&o.getData()||{},S=g.selectedCountText||d,h=g.selected||[],r=new J({allRoles:[],selectedRoles:h,selectedCountText:S});D.setModel(r,"roleContext");D.open();p.getController().getPageRepository().getRoles(s).then(function(R){f(R,null);});});},close:function(){if(_){_.close();}},onAfterClose:function(){if(_){_.destroy();_=null;}if(this.oContextSelectorController){this.oContextSelectorController.destroy();this.oContextSelectorController=null;}},onRolesSelected:function(s){f(null,s.selected);},onOpenContextSelector:function(){sap.ui.require(["sap/ushell/applications/PageComposer/controller/ContextSelector.controller"],function(g){if(!this.oContextSelectorController){var p=c.getController();this.oContextSelectorController=new g(p.getRootView(),p.getResourceBundle());}var m=_.getModel("roleContext"),s=m.getProperty("/selectedRoles"),A=m.getProperty("/allRoles");this.oContextSelectorController.openSelector(A,s,this.onRolesSelected);}.bind(this));}});return new P();});
