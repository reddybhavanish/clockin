// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/Button","sap/m/library","sap/m/List","sap/m/ResponsivePopover","sap/m/StandardListItem","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/model/Sorter","sap/ushell/utils/clone","sap/ushell/services/Container"],function(B,m,L,R,S,F,a,J,b,c){"use strict";var d=m.ButtonType;var P=m.PlacementType;var e=m.ListMode;var f=m.ListSeparators;return function(){var p,o,t,l,C,i,A,M,r,g={},h,s,j,k;function _(){return i.getSelectedKey()==="catalogs"?C:l;}function n(){A.setEnabled(!!_().getSelectedItems().length);}this.init=function(I){p=I.getView();o=p.byId("tileSelector");t=p.byId("tileSelectorToolbar");l=p.byId("tileSelectorList");C=p.byId("catalogTilesList");i=p.byId("contextSwitch");A=p.byId("tileSelectorAddButton");g.i18n=I.getResourceBundle();l.setBusy(true);M=new J({searchText:"",descending:false,vizReferenceHierarchySet:undefined});M.setSizeLimit(Infinity);o.setModel(M);r=p.getModel("roles");s=new L({mode:e.MultiSelect,showSeparators:f.None,includeItemInSelection:true,selectionChange:function(){j.getBeginButton().setEnabled(!!s.getSelectedItem());},items:{path:"/page/sections",template:new S({title:"{title}"})},noDataText:g.i18n.getText("Message.NoSections")}).setModel(p.getModel());A.setEnabled(false);l.attachSelectionChange(n);C.attachSelectionChange(n);i.attachSelect(n);};function q(){var I={};I.parameters={expand:"vizReferences"};I.path="/vizReferenceHierarchySet";I.sorter=x(M.getProperty("/descending"));I.factory=function(K,N){switch(N.getProperty("type")){default:case"catalog":return p.byId("tileSelectorGroupHeader").clone();case"visualization":return p.byId("tileSelectorCustomListItem").clone().bindObject(N.getPath()+"/vizReferences");}};return I;}function u(I){if(I&&I.length){var K=q();C.setModel(p.getModel("PageRepository"));C.bindItems(K);var N=(I||[]).map(function(O){return new F("catalogId",a.EQ,O);});C.getBinding("items").filter(N);}else{C.unbindItems();}}function v(I){u(I);i.setSelectedKey("catalogs");n();}this.initTiles=function(V){i.setSelectedKey("roles");var I=q();A.setEnabled(false);if(typeof V!=="undefined"){M.setProperty("/vizReferenceHierarchySet",V);l.setModel(undefined);delete I.parameters;}else{M.setProperty("/vizReferenceHierarchySet",undefined);l.setModel(p.getModel("PageRepository"));}l.bindItems(I);l.getBinding("items").filter(w());l.setBusy(false);};this.refreshRoleContext=function(){l.getBinding("items").filter(w());};this.onSearchTiles=function(){l.getBinding("items").filter(w());};this.onAddTiles=function(I){var K=s.getItems(),N=I.getSource().getBindingContext();if(N){var O=N.getPath();h=_().getItems().filter(function(Q){return(Q.getBindingContextPath()===O);})[0];}else{h=undefined;}if(K.length===1){K[0].setSelected(true);H();}else{D(I);}};this.onAddCatalogs=function(){sap.ui.require(["sap/ushell/applications/PageComposer/controller/CatalogSelector.controller"],function(I){I.selectCatalogs(p,v);});};this.onSortCatalogsToggle=function(){y();};this.setAddTileHandler=function(I){k=function(K,N,O){var Q=c(K);Q.catalogTileId=Q.id;Q.vizId=Q.catalogTileId;delete Q.id;I(Q,N,O);};};this.onDragStart=function(I){var K=I.getParameter("target").getBindingContext().getProperty();if(K.type==="catalog"){I.preventDefault();return;}I.getParameter("dragSession").setComplexData("callback",function(N,O){k(K,[O],N);});};function w(){var I=[];var K=M.getProperty("/searchText");if(!M.getProperty("/vizReferenceHierarchySet")){var N=r.getProperty("/selected")||[];N.forEach(function(O){I.push(new F("roleId",a.EQ,O));});}if(K){I.push(new F([new F("title",a.Contains,K),new F("vizReferences/title",a.Contains,K),new F("vizReferences/subTitle",a.Contains,K)],false));}return I;}function x(I){return[new b("title",I),new b("vizReferences/title",false)];}function y(I){var K=((typeof I!=="undefined")?I:!M.getProperty("/descending"));var N=C.getBinding("items");var O=x(K);l.getBinding("items").sort(O);if(N){N.sort(O);}M.setProperty("/descending",K);}function z(){var I=_();if(I.indexOfItem(h)>-1){return[h.getBindingContext().getProperty()];}var K=I.getModel();return I.getSelectedContextPaths().map(function(N){return K.getContext(N).getProperty();});}function D(I){if(!j||j.bIsDestroyed){G();}s.removeSelections(true);j.getBeginButton().setEnabled(false);j.getEndButton().setEnabled(true);if(!h&&E(A)){j.openBy(t.getAggregation("_overflowButton"));}else{j.openBy(I.getSource());}}function E(I){return(I.hasStyleClass("sapMOTAPButtonNoIcon")||I.hasStyleClass("sapMOTAPButtonWithIcon"));}function G(){j=new R({placement:P.Auto,title:g.i18n.getText("Tooltip.AddToSections"),beginButton:new B({type:d.Emphasized,text:g.i18n.getText("Button.Add"),press:function(){this.setEnabled(false);j.close();H();}}),endButton:new B({text:g.i18n.getText("Button.Cancel"),press:function(){this.setEnabled(false);j.close();}}),content:s,initialFocus:s}).attachAfterClose(function(){h=undefined;}).addStyleClass("sapContrastPlus");o.addDependent(j);}function H(){if(typeof k!=="function"){return;}var I=s.getSelectedItems().map(function(N){return s.indexOfItem(N);});var K=z();K.forEach(function(N){k(N,I);});if(h){h.setSelected(false);h=undefined;}else{_().removeSelections(true);}n();}};});
