// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/applicationIntegration/elements/model","sap/ushell/components/applicationIntegration/Storage","sap/ushell/components/applicationIntegration/application/BlueBoxHandler","sap/ushell/ui5service/ShellUIService","sap/ushell/components/applicationIntegration/application/Application","sap/ushell/components/applicationIntegration/relatedServices/RelatedServices","sap/ushell/components/applicationIntegration/relatedShellElements/RelatedShellElements","sap/ushell/components/applicationIntegration/configuration/AppMeta","sap/ushell/services/AppConfiguration","sap/ushell/utils","sap/ui/Device","sap/ushell/Config","sap/ushell/ui5service/AppIsolationService","sap/ushell/ApplicationType","sap/ushell/components/applicationIntegration/DelegationBootstrap","sap/base/util/UriParameters","sap/ui/thirdparty/jquery","sap/base/Log"],function(E,S,B,a,A,R,b,c,d,u,D,C,f,g,h,U,q,L){"use strict";function i(){var v,j=["URL"],r,s,k,I={},o,l=false,m={},n={home:{embedded:"embedded-home",headerless:"headerless-home",merged:"blank-home",blank:"blank-home"},app:{minimal:"minimal",app:"app",standalone:"standalone",embedded:"embedded",headerless:"headerless",merged:"merged",home:"home",blank:"blank",lean:"lean"}},p,G=[],t={},w=false;this.shellElements=function(){return b;};this.service=function(){return R;};this.isCurrentApp=function(e){return(m.appId===e);};this.isAppWithSimilarShellHashInCache=function(e,F){var x=S.get(e);if(x){if(x.shellHash===F){return true;}return false;}return false;};this.isAppInCache=function(e){return!!S.get(e);};this.normalizeAppId=function(e){var x="-component",y=e.endsWith(x);if(y){return e.substring(0,e.length-x.length);}return e;};this.onComponentCreated=function(e,x,y){var z=y.component,F=this.normalizeAppId(z.getId());if(this.isAppInCache(F)){S.get(F).app=z;this.active(F);}else{m.app=z;if(z.active){z.active();}}};this.onGetMe=function(e,x,y){y.AppLifeCycle=this;};this.store=function(e){var x=S.get(e);if(x){A.store(x.app);R.store(x.service);c.store(x.meta);}};this.destroy=function(e,F){var x=S.get(e),y;function z(){A.destroy(F);b.destroy(F);c.destroy(F);}this.removeControl(e);if(x){y=B.getStateFul(F.getUrl());if(y&&B.isStatefulContainerSupported(y)){var H=B.getHandler();H.destroy(y,e);}else{x.container.destroy();B.deleteStateFul(F.getUrl());}S.remove(e);}else{var P=F&&F.sendBeforeAppCloseEvent&&F.sendBeforeAppCloseEvent();if(P===undefined){z();}else{P.then(function(){z();},function(J){z();q.sap.log.error("FLP got a failed response from the iframe for the 'sap.ushell.services.CrossApplicationNavigation.beforeAppCloseEvent' message sent",J,"sap.ushell.components.applicationIntegration.AppLifeCycle.js");});}}};this.restore=function(e){var x=S.get(e);if(x){A.restore(x.app);R.restore(x.service);c.restore(x.meta);}};this.active=function(e){var x=S.get(e);if(x){A.active(x.app);}};this.handleExitStateful=function(F,e){var x,H=B.getHandler();if(S.get(F)){x=B.getStorageKey(e);if(x&&B.isKeepAliveSupported(e)){return H.store(e,x);}return Promise.resolve();}return H.destroy(e);};this.handleExitApplication=function(F,e,x){var y;if(F&&e){if(e.getUrl()&&B.isStatefulContainerSupported(B.getStateFul(e.getUrl()))){this.handleExitStateful(F,e);}else if(S.get(F)){this.store(F);sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",e);}else if((e.getIsStateful&&e.getIsStateful())||(e.getApplicationType&&this.applicationIsStatefulType(e.getApplicationType()))){if(x){e.postMessageRequest("sap.gui.triggerCloseSessionImmediately");}}else{y=j.indexOf(e.getApplicationType)>=0;if(this.isAppOfTypeCached(F,y)===false){this.destroy(F,e);}}if(F.indexOf("Shell-appfinder-component")>0){sap.ui.getCore().getEventBus().publish("sap.ushell","appFinderAfterNavigate");}}};this.onAfterNavigate=function(F,e,T,x){var y=T.indexOf("Shell-appfinder-component")>0||T.indexOf("Shell-home-component")>0;this.handleExitApplication(F,e,y);if(T){if(S.get(T)){this.restore(T);}else{}}};this.storeApp=function(e,x,T,F){if(!this.isAppInCache(e)){S.set(e,{service:R.create(),shellHash:F,appId:e,stt:"loading",appRelatedElements:b.getAppRelatedElement(),container:x,meta:d.getMetadata(T),app:undefined});I[F]=e;B.setStorageKey(x,e);return true;}return false;};this.restoreApp=function(e){if(this.isAppInCache(e)){m=S.get(e);if(B.getStorageKey(m.container)){B.setStorageKey(m.container,e);}}};this.isAppOfTypeCached=function(e,x){if(!l&&e.indexOf(r)!==-1){return true;}if(!l&&e.indexOf("Shell-appfinder")!==-1){return true;}if(new U(window.location.href).get("sap-keep-alive")=="true"&&x){return true;}return false;};i.prototype._getURLParsing=function(){if(!this._oURLParsing){this._oURLParsing=sap.ushell.Container.getService("URLParsing");}return this._oURLParsing;};this.calculateAppType=function(T){if(T.applicationType==="URL"&&T.additionalInformation&&T.additionalInformation.startsWith("SAPUI5.Component=")){return"SAPUI5";}return T.applicationType;};this.getStatefulCapabilities=function(T){if(T.appCapabilities&&T.appCapabilities&&T.appCapabilities.statefulContainer){return T.appCapabilities.statefulContainer;}return undefined;};this.isNotifyInnerAppRouteChangeEnabled=function(T){if(T.appCapabilities&&T.appCapabilities.notifyInnerAppRouteChange){return true;}return false;};this.isStatefulCapabilityEnabled=function(T){var e=this.getStatefulCapabilities(T);if(e&&(e.enabled===true||e===true)){return true;}return false;};this.isGUICapabilityEnabled=function(T){var e=this.getStatefulCapabilities(T);if(e&&e.protocol==="GUI"){return true;}return false;};this.isFLPCapabilityEnabled=function(T){return!this.isGUICapabilityEnabled(T)&&this.isStatefulCapabilityEnabled(T);};this.isGUIStatefulCapabilityEnabled=function(T){return this.isGUICapabilityEnabled(T)&&this.isStatefulCapabilityEnabled(T);};this.openApp=function(e,T,x,F){var y,z,H=j.indexOf(T.applicationType)>=0,J,K;var M="application"+e;y=B.getStateFul(T.url);if(y&&B.isStatefulContainerSupported(y)){if(this.isAppOfTypeCached(M,H)||this.isCachedEnabledAsAppParameter(x,T)){if(!this.isAppInCache(M)){this.storeApp(M,y,T,F);}this.restoreApp(M);}else{m={appId:M,stt:"loading",container:y,meta:d.getMetadata(T),app:undefined};}}else if(this.isAppOfTypeCached(M,H)||this.isCachedEnabledAsAppParameter(x,T)){if(!this.isAppInCache(M)){y=this.createApplicationContainer(e,T);this.storeApp(M,y,T,F);B.set(T.url,y);}this.restoreApp(M);}else if(this.applicationIsStatefulType(T.applicationType)||B.isCapByTarget(T,"isGUIStateful")){y=this.getStatefulContainer(T.applicationType);if(!y){y=this.createApplicationContainer(e,T);this.setStatefulContainer(T.applicationType,y);y.setIsStateful(true);}m={appId:M,stt:"loading",container:y,meta:d.getMetadata(T),app:undefined};}else{if(y){z=x.semanticObject+"-"+x.action;this.removeApplication(z);}else if(T.applicationType==="URL"){z=x.semanticObject+"-"+x.action;J=B.getById("application-"+z);if(J&&B.isStatefulContainerSupported(J)){K=J.getUrl();B.removeCapabilities(J);this.destroy("application-"+z,J);B.deleteStateFul(K);}}y=this.createApplicationContainer(e,T);B.set(T.url,y);if(B.isCapUT(y,"isFLP")){B.setCapabilities(y,[{service:"sap.ushell.services.appLifeCycle",action:"create"},{service:"sap.ushell.services.appLifeCycle",action:"destroy"}]);}m={appId:M,stt:"loading",container:y,meta:d.getMetadata(T),app:undefined};}};this.getAppMeta=function(){return c;};this.evict=function(e){var x,y=e.value,z=e.key;this.removeControl(z);if(y.container.getUrl&&y.container.getUrl()){x=B.getStateFul(y.container.getUrl());}if(x){var H=B.getHandler();H.destroy(x,z);}else{y.container.destroy();}};this.init=function(e,x,y,z,F,H,J){var K=this,M;if(D.system.phone){M=10;if(J&&J.limit&&J.limit.phone){M=J.limit.phone;}}else if(D.system.tablet){M=10;if(J&&J.limit&&J.limit.tablet){M=J.limit.tablet;}}else if(D.system.desktop){M=15;if(J&&J.limit&&J.limit.desktop){M=J.limit.desktop;}}else{M=10;}h.init(this.registerShellCommunicationHandler,this.postMessageToIframeApp);h.bootstrap();s=new a({scopeObject:F.ownerComponent,scopeType:"component"});o=new f({scopeObject:F.ownerComponent,scopeType:"component"});k=e;v=x;r=y;c.init(r);l=z;B.init({oShellUIService:s,oAppIsolationService:o},J,this);S.init(M,function(O){this.evict(O);}.bind(this));this.registerShellCommunicationHandler({"sap.ushell.services.appLifeCycle":{oRequestCalls:{"create":{isActiveOnly:true,distributionType:["URL"],fnResponseHandler:function(P){P.then(function(O){L.info("sap.ushell.services.appLifeCycle.create:"+O);}).catch(function(O){L.error("Error: sap.ushell.services.appLifeCycle.create:"+O);});}},"destroy":{isActiveOnly:true,distributionType:["URL"],fnResponseHandler:function(P){P.then(function(O){L.info("sap.ushell.services.appLifeCycle.destroy:"+O);}).catch(function(O){L.error("Error: sap.ushell.services.appLifeCycle.destroy:"+O);});}},"store":{isActiveOnly:true,distributionType:["URL"],fnResponseHandler:function(P){P.then(function(O){L.info("sap.ushell.services.appLifeCycle.store:"+O);}).catch(function(O){L.error("Error: sap.ushell.services.appLifeCycle.store:"+O);});}},"restore":{isActiveOnly:true,distributionType:["URL"],fnResponseHandler:function(P){P.then(function(O){L.info("sap.ushell.services.appLifeCycle.restore:"+O);}).catch(function(O){L.error("Error: sap.ushell.services.appLifeCycle.restore:"+O);});}}},oServiceCalls:{"subscribe":{executeServiceCallFn:function(O){B.mapCapabilities(O.oContainer,O.oMessageData.body);return new q.Deferred().resolve({}).promise();}},"setup":{executeServiceCallFn:function(O){return new q.Deferred().resolve().promise();}}}}});this.registerShellCommunicationHandler({"sap.ushell.eventDelegation":{oRequestCalls:{"registerEventHandler":{isActiveOnly:false,distributionType:["URL"]}},oServiceCalls:{"registerEventHandler":{executeServiceCallFn:function(O){var P=N(O);return new q.Deferred().resolve(P).promise();}}}}});function N(O){var P=O.oMessageData.body.eventSerObj;return K.registerEventHandler(P);}sap.ui.getCore().getEventBus().subscribe("sap.ushell","appComponentLoaded",this.onComponentCreated,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell","getAppLifeCycle",this.onGetMe,this);b.init(this.getElementsModel(),H);};this.addControl=function(e){v.addCenterViewPort(e);};this.removeControl=function(e){var x=B.getById(e),y=B.isStatefulContainerSupported(x);if(!y){v.removeCenterViewPort(e,true);}};this.removeApplication=function(e){var x=this.getControl(e);if(x){this.removeControl(x.getId());x.destroy();}};this.getControl=function(e){return v&&(v.getViewPortControl("centerViewPort","application-"+e)||v.getViewPortControl("centerViewPort","applicationShellPage-"+e));};this.getViewPortContainer=function(){return v;};this.navTo=function(e){v.navTo("centerViewPort",e,"show");};this.getCurrentApplication=function(){return m;};this.setApplicationFullWidth=function(e){var x=this.getCurrentApplication();if(x.container){x.container.toggleStyleClass("sapUShellApplicationContainerLimitedWidth",!e);}};this.createComponent=function(e,P){this.shellElements().setDangling(true);return A.createComponent(e,P);};this.getAppContainer=function(e,x,y,z,F){x.shellUIService=s.getInterface();x.appIsolationService=o.getInterface();x.targetNavigationMode=y?"explace":"inplace";this.openApp(e,x,z,F);if(G.length>0){m.container.registerShellCommunicationHandler(G);}if(t.UI5APP){m.container.setIframeHandlers(t.UI5APP);}return m.container;};this.getShellUIService=function(){return s;};this.getAppIsolationService=function(){return o;};this.initShellUIService=function(e){s._attachHierarchyChanged(c.onHierarchyChange.bind(this));s._attachTitleChanged(c.onTitleChange.bind(this));s._attachRelatedAppsChanged(c.onRelatedAppsChange.bind(this));s._attachBackNavigationChanged(e.fnOnBackNavigationChange.bind(this));};this.parseStatefulContainerConfiguration=function(e){var x={};if(e){var y={"GUI":true};Object.keys(e).filter(function(z){return e[z]===true&&y[z];}).map(function(z){var F=z;if(F==="GUI"){F="TR";}return F;}).forEach(function(z){x[z]=null;});}p=x;};this.setStatefulApplicationContainer=function(e){p=e;};this.getStatefulApplicationContainer=function(){return p;};this.applicationIsStatefulType=function(e){return p.hasOwnProperty(e);};this.getStatefulContainer=function(e){return p[e];};this.setStatefulContainer=function(e,x){p[e]=x;};this.statefulContainerForTypeExists=function(e){return!!this.getStatefulContainer(e);};this.getAllApplicationContainers=function(){return Object.keys(p).map(function(K){return p[K];}).filter(function(e){return!!e;});};this.getElementsModel=function(){return E;};this.activeContainer=function(x){var y=this.getAllApplicationContainers();y.forEach(function(e){L.info("Deactivating container "+e.getId());e.setActive(false);});B.forEach(function(z){if(z&&z!==x){try{L.info("Deactivating container "+z.getId());z.setActive(false);}catch(e){}}});if(x){L.info("Activating container "+x.getId());x.setActive(true);}};this.showApplicationContainer=function(e){this.navTo(e.getId());e.toggleStyleClass("hidden",false);L.info("New application context opened successfully in an existing transaction UI session.");};this.reuseStateFulContainerAndRestore=function(e,T,H,F,x){var y=this,z=I[F];if(B.getStorageKey(e)){B.setStorageKey(e,z);}return H.restore(e,z,x).then(function(){y.showApplicationContainer(e);},function(J){L.error(J&&J.message||J);});};this.reuseStateFulContainer=function(e,x,T,H,F,y){var z=this;I[F]=T;if(B.getStorageKey(e)){B.setStorageKey(e,T);}this.initAppMetaParams();return H.create(e,x,T,y).then(function(){z.showApplicationContainer(e);},function(J){L.error(J&&J.message||J);});};this.initAppMetaParams=function(){if(!this.getAppMeta().getIsHierarchyChanged()){s.setHierarchy();}if(!this.getAppMeta().getIsTitleChanged()){s.setTitle();}if(!this.getAppMeta().getIsRelatedAppsChanged()){s.setRelatedApps();}if(!w){s.setBackNavigation();}};this.reuseApplicationContainer=function(e,x,y){var z=this;return e.setNewApplicationContext(x,y).then(function(){z.navTo(e.getId());e.toggleStyleClass("hidden",false);L.info("New application context opened successfully in an existing transaction UI session.");},function(F){L.error(F&&F.message||F);});};this.createApplicationContainer=function(e,x){return A.createApplicationContainer(e,x);};this.publishNavigationStateEvents=function(e,x,O){var y,z=e.getId?e.getId():"",F=this;var H=d.getMetadata(),J=H.icon,T=H.title;e.addEventDelegate({onAfterRendering:O});y=e.exit;e.exit=function(){if(y){y.apply(this,arguments);}F.getAppMeta()._applyContentDensityByPriority();setTimeout(function(){var K=q.extend(true,{},x);delete K.componentHandle;K.appId=z;K.usageIcon=J;K.usageTitle=T;sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",K);L.info("app was closed");},0);var P=F._publicEventDataFromResolutionResult(x);sap.ushell.renderers.fiori2.utils.publishExternalEvent("appClosed",P);};};this._publicEventDataFromResolutionResult=function(e){var P={};if(!e){return e;}["applicationType","ui5ComponentName","url","additionalInformation","text"].forEach(function(x){P[x]=e[x];});Object.freeze(P);return P;};this.isCachedEnabledAsAppParameter=function(e,T){if(e&&e.params&&e.params["sap-keep-alive"]){if(e.params["sap-keep-alive"]=="true"){return true;}}if(T&&T.url){if(new U(T.url).get("sap-keep-alive")=="true"){return true;}}return false;};this.getInMemoryInstance=function(e,F){var x="application-"+e,y=S.get(x);if(y){if(y.shellHash===F){return{isInstanceSupported:true,appId:y.appId,container:y.container};}return{isInstanceSupported:false,appId:y.appId,container:y.container};}return{isInstanceSupported:false,appId:undefined,container:undefined};};this.handleOpenStateful=function(e,x,T,y,z,F){var H=B.getHandler();if(S.get(T)&&e===false){this.reuseStateFulContainerAndRestore(y,T,H,F,z);}else{this.reuseStateFulContainer(y,z.url,T,H,F,z);if(x){if(!this.isAppInCache(T)){this.storeApp(T,y,z,F);}}}};this.leave=function(e,x){var y=B.isStatefulContainerSupported(e);if(y){return this.handleExitStateful(x,e);}return Promise.resolve();};this.open=function(e,x,y,T,W,F,M){var z,H=this.statefulContainerForTypeExists(T.applicationType),J,K=j.indexOf(T.applicationType)>=0,N="application-"+e,O,P=this.isAppOfTypeCached(N,K)||this.isCachedEnabledAsAppParameter(y,T),Q,V=false,X,Y;Q=this.calculateAppType(T);X=g.getDefaultFullWidthSetting(Q);z=B.getStateFul(T.url);J=B.isStatefulContainerSupported(z);if(!J){if(m||N!==m.appId){z=undefined;}O=S.get("application"+x);if(O){z=O.container;if(!J&&P&&z!==undefined){Y=true;}}}if(J){if(!z){z=W(e,M,y,T,x,T.fullWidth||M.fullWidth||X,F);this.restoreApp(z.getId());this.navTo(z.getId());V=true;}}else if(!H&&z&&!P){this.destroy(z.getId(),z);z=W(e,M,y,T,x,T.fullWidth||M.fullWidth||X,F);}else if(!z){z=W(e,M,y,T,x,T.fullWidth||M.fullWidth||X,F);}if(!H&&!J){if(Y===true){sap.ui.getCore().getEventBus().publish("launchpad","appOpening",T);}this.restoreApp(z.getId());this.navTo(z.getId());if(Y===true){sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",T);}}v.switchState("Center");u.setPerformanceMark("FLP -- centerViewPort");this.activeContainer(z);if(J){this.handleOpenStateful(V,P,"application"+x,z,T,F);}else if(H){this.reuseApplicationContainer(z,T.applicationType,T.url);}return Promise.resolve();};this.handleControl=function(e,x,y,T,W,F){var z=this,M=d.getMetadata(T),H=v.getCurrentCenterPage?v.getCurrentCenterPage():undefined,J=sap.ui.getCore().byId(H);var P=z.leave(J,H).then(function(){z.open(e,x,y,T,W,F,M);},function(K){L.error(K&&K.message||K);});return P;};this.switchViewState=function(e,x,y){var z=e,F;if(n[e]&&n[e][k]){z=n[e][k];}var H=C.last("/core/shell/model/currentState/stateName")==="home";if(!H&&(!m.appId||!S.get(m.appId))){E.destroyManageQueue();}F=S.get("application"+y);if(F){b.restore(F);}else{b.assignNew(e);}E.switchState(z,x,y);this.shellElements().setDangling(false);this.shellElements().processDangling();if(e==="searchResults"){this.getElementsModel().setProperty("/lastSearchScreen","");if(!window.hasher.getHash().indexOf("Action-search")===0){var J=sap.ui.getCore().getModel("searchModel");window.hasher.setHash("Action-search&/searchTerm="+J.getProperty("/uiFilter/searchTerms")+"&dataSource="+JSON.stringify(J.getProperty("/uiFilter/dataSource").getJson()));}}};this.registerShellCommunicationHandler=function(e){A.registerShellCommunicationHandler(e);};this.registerIframeCommunicationHandler=function(H,T){t[T]=H;};this.postMessageToIframeApp=function(e,x,M,W){var y,z=A.getActiveAppContainer(),F=[];if(B.hasIFrame(z)&&(B.isCapabilitySupported(z,e,x)||A.isAppTypeSupported(z,e,x))){F.push(A.postMessageToIframeApp(z,e,x,M,W));}if(!A.isActiveOnly(e,x)){B.forEach(function(O){if(B.hasIFrame(O)){if(B.isCapabilitySupported(O,e,x)||A.isAppTypeSupported(O,e,x)){F.push(A.postMessageToIframeApp(O,e,x,M,W));}}});}y=A.getResponseHandler(e,x);var H=Promise.all(F);if(y){y(H);}return H;};this.postMessageToIframeAppAccordingToPolicy=function(e,x,M,W,P){var y,z=A.getActiveAppContainer(),F=[];if(B.hasIFrame(z)&&A.isAppTypeSupportedByPolicy(z,P)){F.push(A.postMessageToIframeApp(z,e,x,M,W));}if(!P.isActiveOnly){B.forEach(function(O){if(B.hasIFrame(O)){if(B.isCapabilitySupported(O,e,x)||A.isAppTypeSupported(O,e,x)){F.push(A.postMessageToIframeApp(O,e,x,M,W));}}});}y=A.getResponseHandler(e,x);var H=Promise.all(F);if(y){y(H);}return H;};this.registerTunnels=function(T){h.registerTunnels(T,this.registerShellCommunicationHandler);};this.registerEvents=function(e){h.registerEvents(e,this.registerShellCommunicationHandler);};this.setBackNavigationChanged=function(e){w=e;};this.getBackNavigationChanged=function(){return w;};}return new i();},true);
