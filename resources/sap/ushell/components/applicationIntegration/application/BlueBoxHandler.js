// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/applicationIntegration/application/Application","sap/ushell/components/container/ApplicationContainer","sap/ushell/EventHub","sap/ui/thirdparty/URI","sap/ushell/components/applicationIntegration/application/PostMessageAPI","sap/ui/thirdparty/jquery"],function(A,a,E,U,P,q){"use strict";function B(){var c,m={},t=this,b,C={"isStateful":{handler:function(d,e){if(d&&(d.enabled===true||d===true)){return true;}return false;}},"isGUI":{handler:function(d,e){if(d&&d.protocol==="GUI"){return true;}return false;}},"isGUIStateful":{handler:function(d,e){return t.isCapUT(e,"isGUI")&&t.isCapUT(e,"isStateful");}},"isFLP":{handler:function(d,e){return!t.isCapUT(e,"isGUI")&&t.isCapUT(e,"isStateful");}}},o={},s={},S={},h={"DEFAULT":{storageIdentifier:function(u){return this._stripURL(u);},setup:function(T,d){},isContentLoaded:function(i){return false;},create:function(i,u,d){return A.postMessageToIframeApp(i,"sap.ushell.services.appLifeCycle","create",{sCacheId:d,sUrl:u,sHash:window.hasher.getHash()});},destroy:function(i){return A.postMessageToIframeApp(i,"sap.ushell.services.appLifeCycle","destroy",{});},store:function(i,d){},restore:function(i,d){}},"URL":{setup:function(T,d){},create:function(i,u,d,T){var p;u=a.prototype._adjustURLForIsolationOpeningWithoutURLTemplate(u);sap.ui.getCore().getEventBus().publish("launchpad","appOpening",T);p=A.postMessageToIframeApp(i,"sap.ushell.services.appLifeCycle","create",{sCacheId:d,sUrl:u,sHash:window.hasher.getHash()},true);p.then(function(){o[i].currentAppTarget=T;sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",T);});return p;},destroy:function(i,d){var p;p=A.postMessageToIframeApp(i,"sap.ushell.services.appLifeCycle","destroy",{sCacheId:d},true);p.then(function(){sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",o[i].currentAppTarget);o[i].currentAppTarget=undefined;});return p;},store:function(i,d){var p;p=A.postMessageToIframeApp(i,"sap.ushell.services.appLifeCycle","store",{sCacheId:d},true);p.then(function(){sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",o[i].currentAppTarget);o[i].currentAppTarget=undefined;});return p;},restore:function(i,d,T){var p;sap.ui.getCore().getEventBus().publish("launchpad","appOpening",T);p=A.postMessageToIframeApp(i,"sap.ushell.services.appLifeCycle","restore",{sCacheId:d,sHash:window.hasher.getHash()},true);p.then(function(){o[i].currentAppTarget=T;sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",T);});return p;}}};this.subscribePluginAgents=function(d,f){Object.keys(d).map(function(k){if(!m[k]){m[k]=[];}m[k].push(f);});};this._managePluginAgents=function(d){var t=this;var H=function(e,i,f,p){var g={"loading":{sInterface:"agentLoading"},"started":{sInterface:"agentStart"},"exit":{sInterface:"agentExit"}},I=g[f.status];if(I){if(i[I.sInterface]){i[I.sInterface](e,p,f);}}};d.forEach(function(M){var i=M.pluginComp.componentHandle.getInstance();Object.keys(o).map(function(e){Object.keys(M.agents).map(function(p){if(o[e].PlugIns&&o[e].PlugIns[p]){var f=o[e].PlugIns[p];H(o[e].BlueBox,i,f,p);}});});t.subscribePluginAgents(M.agents,function(e,p,f){H(e,i,f,p);});});};this.startPluginAgentsLifeCycle=function(){var t=this;sap.ushell.Container.getServiceAsync("PluginManager").then(function(p){p.registerAgentLifeCycleManager(t._managePluginAgents.bind(t));});};this.init=function(d,i,e){var t=this;c={};A.init(this);b=e;E.once("StepDone").do(function(){t.startPluginAgentsLifeCycle();});E.once("pluginConfiguration").do(function(f){var s={};Object.keys(f).forEach(function(k){if(f[k].config&&f[k].config["sap-component-agents"]){s=q.extend(true,s,f[k].config["sap-component-agents"]);}});t.setStartupPlugins(s);});if(i){S=q.extend(true,S,i.supportedTypes);}P.registerShellCommunicationHandler({"sap.ushell.appRuntime":{oServiceCalls:{"startupPlugins":{executeServiceCallFn:function(f){return new q.Deferred().resolve(s).promise();}},"shellCheck":{executeServiceCallFn:function(f){return new q.Deferred().resolve({InShell:true}).promise();}}}},"sap.ushell.services.pluginManager":{oServiceCalls:{"status":{executeServiceCallFn:function(f){var g=f.oMessageData.body,l;if(f.oContainer&&o[f.oContainer]&&g&&g.name&&o[f.oContainer].PlugIns[g.name]){o[f.oContainer].PlugIns[g.name].status=g.status;l=m[g.name];if(l){l.map(function(j){j(f.oContainer,g.name,g);});}return new q.Deferred().resolve(o[f.oContainer].PlugIns).promise();}return new q.Deferred().resolve({}).promise();}}}}});};this.setStartupPlugins=function(d){s=JSON.parse(JSON.stringify(d));Object.keys(s).forEach(function(k){s[k].status="unknown";});};this.getPluginAgentStatus=function(d,e){return JSON.parse(JSON.stringify(o[d].PlugIns[e]));};this.isStatefulContainerSupported=function(d){var i=this.isCapabilitySupported(d,"sap.ushell.services.appLifeCycle","create")&&this.isCapabilitySupported(d,"sap.ushell.services.appLifeCycle","destroy");return i;};this.isKeepAliveSupported=function(d){var i=this.isCapabilitySupported(d,"sap.ushell.services.appLifeCycle","store")&&this.isCapabilitySupported(d,"sap.ushell.services.appLifeCycle","restore");return i;};this.mapCapabilities=function(d,e){this.setCapabilities(d,e);};this.getCapabilities=function(d){return o[d].oCapMap;};this.isCapabilitySupported=function(d,e,i){if(o[d]&&o[d].oCapMap&&o[d].oCapMap[e]){return!!o[d].oCapMap[e][i];}return false;};this.setCapabilities=function(d,e){var f;if(!o[d]){this.InitBlueBoxBD(d);}if(!o[d].oCapMap){o[d].oCapMap={};}f=o[d].oCapMap;Object.keys(e).forEach(function(k){var g=e[k],i;if(!f[g.service]){f[g.service]={};}i=f[g.service];i[g.action]=true;});if(!d.getIsStateful()&&this.isStatefulContainerSupported(d)){d.setIsStateful(true);}};this.removeCapabilities=function(d){if(o[d]){o[d].oCapMap={};d.setIsStateful(false);}};this.hasIFrame=function(d){if(d&&d._getIFrame){return true;}return false;};this.getStorageKey=function(d){return o[d].sStorageKey;};this.InitBlueBoxBD=function(d){o[d]={BlueBox:d,PlugIns:JSON.parse(JSON.stringify(s))};};this.setAppCapabilities=function(d,T){if(!o[d]){this.InitBlueBoxBD(d);}o[d].currentAppTarget=T;o[d].appCapabilities=T.appCapabilities;};this.forEach=function(d){var k;for(k in o){if(o.hasOwnProperty(k)){d(o[k].BlueBox);}}};this.isCapByTarget=function(T,d){if(T.appCapabilities===undefined){return false;}if(C[d]&&T&&T.appCapabilities){return C[d].handler(T.appCapabilities);}return T.appCapabilities[d]||false;};this.isCapUT=function(d,e){var f=o[d];if(f===undefined||f.appCapabilities===undefined){return false;}if(C[e]&&f){return C[e].handler(f.appCapabilities,d);}return f.appCapabilities[e]||false;};this.setStorageKey=function(d,e){if(!o[d]){this.InitBlueBoxBD(d);}o[d].sStorageKey=e;};this.getStorageKey=function(d){if(!o[d]){return undefined;}return o[d].sStorageKey;};this.getHandler=function(){return q.extend(true,h.DEFAULT,h["URL"]);};this._stripURL=function(u){var H;if(u==="../"){return u;}H=new U(u).hostname();if(!H||H===""){return u;}};this.deleteStateFul=function(u){var d=this._stripURL(u);return this.delete(d);};this.getStateFul=function(u){var d=this._stripURL(u);return this.get(d);};this.destroyApp=function(d){b.postMessageToIframeApp("sap.ushell.services.appLifeCycle","destroy",{appId:d});};this.openApp=function(d){b.postMessageToIframeApp("sap.ushell.services.appLifeCycle","create",{appId:d,sHash:window.hasher.getHash()});};this.storeApp=function(d){b.postMessageToIframeApp("sap.ushell.services.appLifeCycle","store",{appId:d,sHash:window.hasher.getHash()});};this.restoreApp=function(d){b.postMessageToIframeApp("sap.ushell.services.appLifeCycle","restore",{appId:d,sHash:window.hasher.getHash()});};this.delete=function(u){if(c[u]){delete c[u];}};this.get=function(u){return c[u];};this.getById=function(i){for(var k in c){if(c.hasOwnProperty(k)){var e=c[k];if(e.sId===i){return e;}}}};this.set=function(u,i){var d=this._stripURL(u);c[d]=i;};}return new B();},true);
