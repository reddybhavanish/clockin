// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/m/library","sap/m/Popover","sap/ui/core/InvisibleText","sap/ui/core/UIComponent","sap/ui/thirdparty/jquery","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/utils"],function(L,m,P,I,U,q,E,r,u){"use strict";var a=m.PlacementType;function g(){return sap.ui.getCore().byId("NotificationsCountButton");}return U.extend("sap.ushell.components.shell.Notifications.Component",{metadata:{version:"1.78.0",library:"sap.ushell.components.shell.Notifications",dependencies:{libs:["sap.m"]}},createContent:function(){this._aTimeouts=[];this.oRenderer=sap.ushell.Container.getRenderer("fiori2");this.oNotificationsService=sap.ushell.Container.getService("Notifications");sap.ui.getCore().getEventBus().subscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);if(this.oNotificationsService.isEnabled()===true){this.oRenderer.shellCtrl.getModel().setProperty("/enableNotifications",true);this.oNotificationsService.init();if(this.oRenderer.getShellConfig().enableNotificationsUI===true){this.oRenderer.shellCtrl.getModel().setProperty("/enableNotificationsUI",true);this.oNotificationsService.registerDependencyNotificationsUpdateCallback(this._updateCount.bind(this),true);}}var n=g();n.applySettings({visible:"{/enableNotifications}",selected:false,enabled:true});n.addEventDelegate({onAfterRendering:function(){var c=this.getFloatingNumber();var b=this.getFloatingNumberMaxValue();if(c>b){this.$().attr("aria-label",r.i18n.getText("NotificationToggleButton.NewNotifications.MaxExceeded",b));}else if(c>0){this.$().attr("aria-label",r.i18n.getText("NotificationToggleButton.NewNotifications",c));}else{this.$().attr("aria-label",r.i18n.getText("NotificationToggleButton.NoNewNotifications"));}}.bind(n)});if(this.oRenderer.oShellModel.getModel().getProperty("/enableNotificationsUI")===true){this.oRenderer.addHeaderEndItem(["NotificationsCountButton"],false,["home","app","minimal"],true);}E.on("showNotifications").do(this._toggleNotifications.bind(this));},_handleAlerts:function(c,e,n){(n||[]).forEach(this.handleNotification.bind(this));},handleNotification:function(n){var A=this.oRenderer.addRightFloatingContainerItem({press:function(){this.oPopover.close();if(window.hasher.getHash()!==n.NavigationTargetObject+"-"+n.NavigationTargetAction){u.toExternalWithParameters(n.NavigationTargetObject,n.NavigationTargetAction,n.NavigationTargetParams);}this.oNotificationsService.markRead(n.Id);},datetime:r.i18n.getText("notification_arrival_time_now"),title:n.SensitiveText?n.SensitiveText:n.Text,description:n.SubTitle,unread:n.IsRead,priority:"High",hideShowMoreButton:true},true,true);this.oRenderer.showRightFloatingContainer(true);var t=setTimeout(function(){this.oRenderer.removeRightFloatingContainerItem(A.getId(),true);}.bind(this),3500);this._aTimeouts.push(t);},_updateCount:function(){var M=this.oRenderer.oShellModel.getModel();this.oNotificationsService.getUnseenNotificationsCount().done(function(n){M.setProperty("/notificationsCount",parseInt(n,10));}).fail(function(d){L.error("Notifications - call to notificationsService.getCount failed: ",d);});},_getPopover:function(){if(!this.oPopover){var n=sap.ui.view("notificationsView",{viewName:"sap.ushell.components.shell.Notifications.Notifications",type:"XML",viewData:{}});var N=n.byId("notificationIconTabBar");N.enhanceAccessibilityState=function(o,A){if(o.isA("sap.m.IconTabHeader")){A.role="";A.label=r.i18n.getText("Notifications.Popover.IconTabBar.Header.AriaLabel");}return A;};this.oPopover=new P("shellNotificationsPopover",{showHeader:false,placement:a.Bottom,showArrow:true,content:n,beforeClose:function(e){e.getSource().getContent()[0].invalidate();this._resetCount();}.bind(this)});this.oPopover._oAriaLabelledByText=new I(this.oPopover.getId()+"-labelledBy",{text:r.i18n.getText("NotificationToggleButton.NoNewNotifications")}).toStatic();this.oPopover.addDependent(this.oPopover._oAriaLabelledByText);this.oPopover.addAriaLabelledBy(this.oPopover._oAriaLabelledByText);this.oPopover.addStyleClass("sapUshellNotificationsPopup");this.oPopover.addStyleClass("sapUiSizeCompact");this.oPopover.addStyleClass("sapContrastPlus");}return this.oPopover;},_toggleNotifications:function(s){var p=this._getPopover();var S=g();if(!S.$().width()){S=sap.ui.getCore().byId("endItemsOverflowBtn");}if(p.isOpen()){p.close();}else if(s!==false){this._resetCount();p.setContentWidth(q("body").width()>=600?"31.1rem":undefined);p.openBy(S);}},_resetCount:function(){sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().setProperty("/notificationsCount",0);sap.ushell.Container.getService("Notifications").notificationsSeen();},exit:function(){sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);if(this.oNotificationsService.isEnabled()===true){this.oNotificationsService.destroy();}this.oNotificationsService=null;this.oRenderer=null;if(this.oPopover){this.oPopover.destroy();this.oPopover=null;}this._aTimeouts.forEach(window.clearTimeout);}});});
