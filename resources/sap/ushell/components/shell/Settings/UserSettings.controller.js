// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/UriParameters","sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/Device","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/utils"],function(L,U,C,F,J,D,E,r,u){"use strict";return C.extend("sap.ushell.components.shell.Settings.UserSettings",{onInit:function(){this.getView().byId("userSettingEntryList").addEventDelegate({onAfterRendering:this._listAfterRendering.bind(this)});this.getView().byId("userSettingsDialog").addEventDelegate({onkeydown:this._keyDown.bind(this)});},_afterClose:function(){if(window.document.activeElement&&window.document.activeElement.tagName==="BODY"){window.document.getElementById("meAreaHeaderButton").focus();}},_keyDown:function(e){if(e.keyCode===27){this._handleCancelButtonPress();}},_listAfterRendering:function(){var m=this.getView().byId("userSettingEntryList");var e=m.getItems();for(var i=0;i<e.length;i++){var p=e[i].getBindingContextPath();this._setEntryValueResult(p);}if(!D.system.phone){var f=m.getItems()[0];if(f){m.setSelectedItem(f);this._toDetail(f);f.getDomRef().focus();}}},_setEntryValueResult:function(e){var m=this.getView().getModel(),v=m.getProperty(e+"/valueArgument"),V=m.getProperty(e+"/valueResult");if(typeof v==="function"){m.setProperty(e+"/valueResult",r.i18n.getText("genericLoading"));v().then(function(a){if(a&&a.value!==undefined){m.setProperty(e+"/visible",!!a.value);}var d;if(typeof(a)==="object"){d=a.displayText||"";}else{d=a||"";}m.setProperty(e+"/valueResult",d);},function(){m.setProperty(e+"/valueResult",r.i18n.getText("loadingErrorMessage"));});}else if(V===null||V===undefined){m.setProperty(e+"/valueResult",v||"");}},_navBackButtonPressHandler:function(){var s=this.getView().byId("settingsApp");s.backDetail();this._updateHeaderButtonVisibility(true);},_navToggleButtonPressHandler:function(){var s=this.getView().byId("settingsApp"),i=s.isMasterShown();if(i){s.hideMaster();}else{s.showMaster();}this._updateHeaderButtonVisibility(!i);},_updateHeaderButtonVisibility:function(i){var n;if(D.system.phone){n=this.getView().byId("userSettingsNavBackButton");n.setVisible(!i);}else if(D.system.tablet){n=this.getView().byId("userSettingsMenuButton");n.setVisible(true);n.setPressed(i);n.setTooltip(r.i18n.getText(i?"ToggleButtonHide":"ToggleButtonShow"));}},_itemPress:function(e){this._toDetail(e.getSource().getSelectedItem());},_toDetail:function(s){var m=this.getView().getModel(),e=s.getBindingContextPath(),d=m.getProperty(e+"/contentResult");if(D.system.phone){s.setSelected(false);}if(d){this._navToDetail(d,e);}else{var o=m.getProperty(e);this._createEntryContent(o).then(function(n){m.setProperty(e+"/contentResult",n);this._navToDetail(n,e);}.bind(this));}},_createEntryContent:function(e){var t=this;var c=this._addContentWrapper(e);if(typeof e.contentFunc==="function"){e.contentFunc().then(function(o){if(o instanceof sap.ui.core.Control){c.then(function(p){p.addContent(o);p.setBusy(false);});}else{c.then(t._addErrorContentToWrapper.bind(null,r.i18n.getText("loadingErrorMessage")));}},function(a){L.error("Can not load content for "+e.title+" entry",a);c.then(t._addErrorContentToWrapper.bind(null,r.i18n.getText("loadingErrorMessage")));});}else{c.then(this._addErrorContentToWrapper.bind(null,r.i18n.getText("userSettings.noContent")));}return c.then(function(p){return p.getId();});},_addContentWrapper:function(e){var t=this;return F.load({name:"sap.ushell.components.shell.Settings.ContentWrapper"}).then(function(p){var m=new J({title:e.title,showHeader:!e.provideEmptyWrapper});p.setModel(m,"entryInfo");t.getView().byId("settingsApp").addDetailPage(p);return p;});},_addErrorContentToWrapper:function(m,p){F.load({name:"sap.ushell.components.shell.Settings.ErrorContent"}).then(function(e){p.setBusy(false);p.getModel("entryInfo").setProperty("/errorMessage",m);p.addContent(e);});},_navToDetail:function(i,e){var s=this.getView().byId("settingsApp");s.toDetail(i);if(s.getMode()==="ShowHideMode"){s.hideMaster();this._updateHeaderButtonVisibility(false);}this._emitEntryOpened(e);},_emitEntryOpened:function(e){var a=E.last("UserSettingsOpened")||{},o=this.getView().getModel().getProperty(e),i=o.id;if(!i){i=u._getUid();this.getView().getModel().setProperty(e+"/id",i);}a[i]=true;E.emit("UserSettingsOpened",a);},_refreshBrowser:function(a){var n=u.getLocationHref().replace(location.hash,""),N=this._getAdjustedQueryString(a);if(N){n=n.replace(location.search,"?"+N);}document.location=n;},_getAdjustedQueryString:function(a){if(a&&a.length>0){var o=U.fromQuery(window.location.search);var n=Array.from(o.keys()).reduce(function(R,p){R[p]=o.getAll(p);return R;},{});a.forEach(function(p){var P=Object.keys(p)[0];if(P){n[P]=p[P];}});return u.urlParametersToString(n);}return null;},_handleSaveButtonPress:function(){var t=this,d=this.getView().byId("userSettingsDialog"),e=this.getView().getModel().getProperty("/entries"),o=E.last("UserSettingsOpened")||{},s;if(Object.keys(o).length===0){this._handleSettingsDialogClose();this._showSuccessMessageToast();return;}d.setBusy(true);s=e.reduce(function(R,a){if(o[a.id]){R.push(this._executeEntrySave(a));}return R;}.bind(this),[]);Promise.all(s).then(function(R){var f=R.filter(function(h){return h.hasOwnProperty("error");});d.setBusy(false);if(f.length>0){var a=r.i18n.getText(f.length===1?"savingEntryError":"savingEntriesError")+"\n";var b="";f.forEach(function(h){a+=h.entry+"\n";b+="Entry: "+h.entry+" - Error message: "+h.error+"\n";});t._showErrorMessageBox(a);L.error("Failed to save the following entries",b);}else{t._handleSettingsDialogClose();t._showSuccessMessageToast();E.emit("UserSettingsOpened",null);var c=false;var g=[];R.forEach(function(h){if(h.refresh){c=true;}if(h.urlParams&&h.urlParams.length>0){g=g.concat(h.urlParams);}});if(c){t._refreshBrowser(g);}}});},_executeEntrySave:function(e){var o=e.onSave(),R;function a(p){var c={};if(p&&p.refresh===true){c.refresh=true;}if(p&&p.urlParams){c.urlParams=p.urlParams;}return c;}function b(s){return{entry:e.title,error:s};}if(o.promise){L.warning("jQuery.promise is used to save "+e.title+" settings entry.\n"+"The using of jQuery.promise for onSave is deprecated. Please use the native promise instead.");R=new Promise(function(c){o.done(function(p){c(a(p));}).fail(function(s){c(b(s));});});}else{R=o.then(a,b);}return R;},_showSuccessMessageToast:function(){sap.ui.require(["sap/m/MessageToast"],function(M){var m=r.i18n.getText("savedChanges");M.show(m,{width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"});});},_showErrorMessageBox:function(e){sap.ui.require(["sap/m/MessageBox"],function(M){M.show(e,{icon:M.Icon.ERROR,title:r.i18n.getText("error"),actions:[M.Action.OK]});});},_handleCancelButtonPress:function(){var e=this.getView().getModel().getProperty("/entries");var i=E.last("UserSettingsOpened")||{};if(i){e.forEach(function(o){if(i[o.id]&&o.onCancel){o.onCancel();}});}E.emit("UserSettingsOpened",null);this._handleSettingsDialogClose();},_handleSettingsDialogClose:function(){sap.ushell.Container.getUser().resetChangedProperties();if(D.system.phone){this.getView().byId("settingsApp").toMaster("settingsView--userSettingMaster");}this.getView().byId("userSettingsDialog").close();}});});
