// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/performance/Measurement","sap/base/util/UriParameters","sap/base/Log","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/model/json/JSONModel"],function(C,M,U,L,a,b,J){"use strict";return C.extend("sap.ushell.components.shell.Settings.userLanguageRegion.LanguageRegionSelector",{onInit:function(){this.userInfoService=sap.ushell.Container.getService("UserInfo");this.oUser=sap.ushell.Container.getUser();var l=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var o=b.getInstance(l);var d=o.getDatePattern("medium"),t=o.getTimePattern("medium"),T=(t.indexOf("H")===-1)?"12h":"24h";var i=sap.ushell.Container.getRenderer("fiori2").getShellConfig().enableSetLanguage||false;var I=this.oUser.isLanguagePersonalized();var m=new J({languageList:null,selectedLanguage:this.oUser.getLanguage(),selectedLanguageText:this.oUser.getLanguageText(),selectedDatePattern:d,selectedTimeFormat:T,isSettingsLoaded:true,isLanguagePersonalized:I,isEnableSetLanguage:i});if(i){this.getView().setBusy(true);this._loadLanguagesList().then(function(c){if(c&&c.length>1){m.setProperty("/languageList",c);var h=c.some(function(e){return e.key==="default";});if(!I&&h){m.setProperty("/selectedLanguage","default");}}this.oView.setModel(m);this.getView().setBusy(false);}.bind(this));}else{this.oView.setModel(m);}},_loadLanguagesList:function(){M.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");return new Promise(function(r){M.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");this.userInfoService.getLanguageList().done(function(d){M.end("FLP:LanguageRegionSelector._getLanguagesList");r(d);}).fail(function(e){M.end("FLP:LanguageRegionSelector._getLanguagesList");L.error("Failed to load language list.",e,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");r(null);});}.bind(this));},onCancel:function(){var m=this.getView().getModel(),o=m.getData(),l=o.languageList,i=o.isEnableSetLanguage;if(i&&l){var u=this.oUser.getLanguage();var s=o.isLanguagePersonalized?u:"default";m.setProperty("/selectedLanguage",s);this._updateTextFields(u);}},onSave:function(){var u=this.oUser,m=this.getView().getModel().getData(),s=m.selectedLanguage,o=u.getLanguage(),l=s!==(m.isLanguagePersonalized?o:"default");if(m.isEnableSetLanguage&&m.languageList&&l){return new Promise(function(r,c){u.setLanguage(s);this.userInfoService.updateUserPreferences(u).done(function(){u.resetChangedProperty("language");var R={refresh:true};var d=U.fromQuery(window.location.search).get("sap-language");if(d&&s!=="default"){R.urlParams=[{"sap-language":s}];}this._removeLanguageFromUserContextCookie();r(R);}.bind(this)).fail(function(e){u.setLanguage(o);u.resetChangedProperty("language");this._updateTextFields(o);L.error("Failed to save language",e,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");c(e);}.bind(this));}.bind(this));}return Promise.resolve();},_removeLanguageFromUserContextCookie:function(){var u=document.cookie.split(";").find(function(d){return d.indexOf("sap-usercontext")!==-1;});if(!u){return;}var c=u.replace("sap-usercontext=","").split("&");c=c.filter(function(v){return v.indexOf("sap-language")===-1;});document.cookie="sap-usercontext="+c.join("&")+";path=/";},_handleSelectChange:function(e){var s=e.getParameters().selectedItem.getKey();this._updateTextFields(s);},_updateTextFields:function(l){var m=this.getView().getModel(),o=new a(l),c=b.getInstance(o),d=c.getDatePattern("medium"),t=c.getTimePattern("medium"),T=(t.indexOf("H")===-1)?"12h":"24h";m.setProperty("/selectedDatePattern",d);m.setProperty("/selectedTimeFormat",T);}});});
