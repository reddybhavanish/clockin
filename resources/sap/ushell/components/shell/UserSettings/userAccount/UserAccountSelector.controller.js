// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/ui/launchpad/AccessibilityCustomData","sap/base/Log","sap/ui/thirdparty/jquery","sap/ushell/resources","sap/m/Switch","sap/ui/model/json/JSONModel","sap/ui/core/theming/Parameters","sap/ui/Device"],function(A,L,q,r,S,J,P,D){"use strict";sap.ui.controller("sap.ushell.components.shell.UserSettings.userAccount.UserAccountSelector",{onInit:function(){var s=sap.ushell.Container.getRenderer("fiori2").getShellController();var o=s.getView();this.oShellConfig=(o.getViewData()?o.getViewData().config:{})||{};this.imgConsentEnabled=this.oShellConfig.enableUserImgConsent?this.oShellConfig.enableUserImgConsent:false;if(this.imgConsentEnabled){try{this.userInfoService=sap.ushell.Container.getService("UserInfo");this.oUser=this.userInfoService.getUser();}catch(e){L.error("Getting UserInfo service failed.");this.oUser=sap.ushell.Container.getUser();}this.currentUserImgConsent=this.oUser.getImageConsent();this.origUserImgConsent=this.currentUserImgConsent;this.addImgConsentEnableSwitch(this.currentUserImgConsent);}},getContent:function(){var d=q.Deferred();var R=r.getTranslationModel();this.getView().setModel(R,"i18n");this.getView().setModel(this.getConfigurationModel(),"config");d.resolve(this.getView());return d.promise();},getValue:function(){var d=q.Deferred();d.resolve(sap.ushell.Container.getUser().getFullName());return d.promise();},onCancel:function(){if(this.imgConsentEnabled){this.currentUserImgConsent=this.oUser.getImageConsent();this.oUserEnableImgConsentSwitch.setState(this.currentUserImgConsent);}},onSave:function(){var R=q.Deferred(),w,u,p=[];if(this.imgConsentEnabled){u=this.onSaveUserImgConsent();p.push(u);}w=q.when.apply(null,p);w.done(function(){R.resolve();});return R.promise();},onSaveUserImgConsent:function(){var d=q.Deferred();var u;if(this.oUser.getImageConsent()!==this.currentUserImgConsent){if(this.currentUserImgConsent!==undefined){this.oUser.setImageConsent(this.currentUserImgConsent);u=this.userInfoService.updateUserPreferences(this.oUser);u.done(function(){this.oUser.resetChangedProperty("isImageConsent");this.origUserImgConsent=this.currentUserImgConsent;d.resolve();}.bind(this));u.fail(function(e){this.oUser.setImageConsent(this.origUserImgConsent);this.oUser.resetChangedProperty("isImageConsent");this.currentUserImgConsent=this.origUserImgConsent;L.error(e);d.reject(e);}.bind(this));}else{d.reject(this.currentUserImgConsent+"is undefined");}}else{d.resolve();}return d.promise();},getConfigurationModel:function(){var c=new J({});var u=sap.ushell.Container.getUser();c.setData({isRTL:sap.ui.getCore().getConfiguration().getRTL(),sapUiContentIconColor:P.get("sapUiContentIconColor"),isStatusEnable:this.originalEnableStatus?this.originalEnableStatus:false,flexAlignItems:D.system.phone?"Stretch":"Center",textAlign:D.system.phone?"Left":"Right",textDirection:D.system.phone?"Column":"Row",labelWidth:D.system.phone?"auto":"12rem",name:u.getFullName(),mail:u.getEmail(),server:window.location.host,imgConsentEnabled:this.imgConsentEnabled,isImageConsent:this.currentUserImgConsent});return c;},_getUserSettingsPersonalizer:function(){if(this.oUserPersonalizer===undefined){this.oUserPersonalizer=this._createUserPersonalizer();}return this.oUserPersonalizer;},_createUserPersonalizer:function(){var p=sap.ushell.Container.getService("Personalization"),c,s={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:true},o=p.getPersonalizer(s,c);return o;},addImgConsentEnableSwitch:function(e){var u=sap.ui.getCore().byId("UserAccountSelector--userImgConsentEnableFlexBox");this.oUserEnableImgConsentSwitch=new S({state:e,change:this.setCurrentUserImgConsent.bind(this)});this.oUserEnableImgConsentSwitch.addCustomData(new A({key:"aria-labelledBy",value:"UserAccountSelector--sapUshellUserImageConsentSwitchLabel",writeToDom:true}));if(!u){L.error("UserAccountSelector: addImgConsentEnableSwitch was called before the renderer");return;}u.addItem(this.oUserEnableImgConsentSwitch);},setCurrentUserImgConsent:function(e){this.currentUserImgConsent=e.mParameters.state;},termsOfUserPress:function(){var t=sap.ui.getCore().byId("UserAccountSelector--termsOfUseTextFlexBox");var a=sap.ui.getCore().byId("UserAccountSelector--termsOfUseLink");var i=t.getVisible();if(i){t.setVisible(false);a.setText(r.i18n.getText("userImageConsentDialogShowTermsOfUse"));}else{a.setText(r.i18n.getText("userImageConsentDialogHideTermsOfUse"));t.setVisible(true);}}});});
