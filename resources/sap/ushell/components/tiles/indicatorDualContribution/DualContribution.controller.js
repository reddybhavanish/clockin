// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/tiles/indicatorTileUtils/cache","sap/m/library","sap/ui/thirdparty/jquery","sap/base/Log"],function(c,m,q,L){"use strict";var V=m.ValueColor;var S=m.Size;var D=m.DeviationIndicator;var a=m.LoadState;sap.ui.controller("tiles.indicatorDualContribution.DualContribution",{getTile:function(){return this.oDualContributionView.oGenericTile;},_updateTileModel:function(n){var b=this.getTile().getModel().getData();q.extend(b,n);this.getTile().getModel().setData(b);this.getTile().getModel().updateBindings();},setTitle:function(){var t=this;var b=sap.ushell.components.tiles.indicatorTileUtils.util.getTileTitleSubtitle(this.oChip);this._updateTileModel({header:b.title||sap.ushell.components.tiles.indicatorTileUtils.util.getChipTitle(t.oConfig),subheader:b.subTitle||sap.ushell.components.tiles.indicatorTileUtils.util.getChipSubTitle(t.oConfig)});},formSelectStatement:function(o){var t=Object.keys(o);var f="";for(var i=0;i<t.length;i++){if((o[t[i]]!==undefined)&&(o.fullyFormedMeasure)){f+=","+o[t[i]];}}return f;},logError:function(e){this.oDualContributionView.oGenericTile.setState(a.Failed);this.oDualContributionView.oGenericTile.setState(a.Failed);sap.ushell.components.tiles.indicatorTileUtils.util.logError(e);},setThresholdValues:function(){var t=this;try{var T={};T.fullyFormedMeasure=this.DEFINITION_DATA.EVALUATION.COLUMN_NAME;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE==="MEASURE"){switch(this.DEFINITION_DATA.EVALUATION.GOAL_TYPE){case"MI":T.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");T.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;case"MA":T.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");T.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;case"RA":T.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");T.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");T.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;}}else{T.criticalHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","FIXED");T.criticalLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","FIXED");T.warningHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","FIXED");T.warningLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","FIXED");T.targetValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","FIXED");T.trendValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","FIXED");}return T;}catch(e){t.logError(e);}},getTrendIndicator:function(t,v){var b=this;t=Number(t);try{var d=D.None;if(t>v){d=D.Down;}else if(t<v){d=D.Up;}return d;}catch(e){b.logError(e);}},_processDataForComparisonChart:function(d,b,f){var s=this.oConfig.TILE_PROPERTIES.semanticMeasure;var g=[];var t;for(var i=0;i<d.results.length;i++){var h=d.results[i];var j={};try{j.title=h[f].toString();}catch(e){j.title="";}j.value=Number(h[b]);var k=Number(h[b]);if(this.oConfig.EVALUATION.SCALING===-2){k*=100;}t=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(k,this.oConfig.EVALUATION.SCALING,this.oConfig.EVALUATION.DECIMAL_PRECISION);j.displayValue=t.toString();if(typeof s==="undefined"){j.color="Neutral";}else if(this.oConfig.EVALUATION.GOAL_TYPE==="MA"){if(j.value>h[s]){j.color="Good";}else{j.color="Error";}}else if(this.oConfig.EVALUATION.GOAL_TYPE==="MI"){if(j.value<h[s]){j.color="Good";}else{j.color="Error";}}else{j.color="Neutral";}g.push(j);}return g;},fetchKpiValue:function(s,E){var t=this;try{var u=this.oConfig.EVALUATION.ODATA_URL,b=this.oConfig.EVALUATION.ODATA_ENTITYSET,d;if(this.oConfig.TILE_PROPERTIES.semanticMeasure){d=this.oConfig.EVALUATION.COLUMN_NAME+","+this.oConfig.TILE_PROPERTIES.semanticMeasure;}else{d=this.oConfig.EVALUATION.COLUMN_NAME;}var f=this.oConfig.TILE_PROPERTIES.dimension;var g=this.oConfig.EVALUATION_VALUES;var h=c.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(!h){var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);var o={};o["0"]=d+",asc";o["1"]=d+",desc";o["2"]=f+",asc";o["3"]=f+",desc";var i=o[this.oConfig.TILE_PROPERTIES.sortOrder||"0"].split(",");var j=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oChip.url.addSystemToServiceUrl(u),b,d,f,v,3);if(this.oConfig.TILE_PROPERTIES.semanticMeasure){j.uri+="&$top=3&$orderby="+i[0]+" "+i[2];}else{j.uri+="&$top=3&$orderby="+i[0]+" "+i[1];}this.comparisionChartODataRef=j.model.read(j.uri,null,null,true,function(g){if(j.unit[0]){t._updateTileModel({unitContribution:g.results[0][j.unit[0].name]});t.writeData.unitContribution=j.unit[0];t.writeData.unitContribution.name=j.unit[0].name;}if(g&&g.results&&g.results.length){f=sap.ushell.components.tiles.indicatorTileUtils.util.findTextPropertyForDimension(t.oChip.url.addSystemToServiceUrl(u),b,f);t.writeData.dimension=f;t.oConfig.TILE_PROPERTIES.FINALVALUE=g;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,d.split(",")[0],f);t.writeData.data=g;c.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,t.writeData);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else if(g.results.length===0){t.oConfig.TILE_PROPERTIES.FINALVALUE=g;t.writeData.data=g;c.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,t.writeData);}else{E.call(t,"no Response from QueryServiceUri");}},function(r){if(r&&r.response){L.error(r.message+" : "+r.request.requestUri);E.call(t,r);}});var k=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(t.DEFINITION_DATA.EVALUATION_FILTERS,t.DEFINITION_DATA.ADDITIONAL_FILTERS);var Q=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oChip.url.addSystemToServiceUrl(u),b,d,null,k);if(Q){t.QUERY_SERVICE_MODEL=Q.model;t.queryUriForKpiValue=Q.uri;t.numericODataReadRef=t.QUERY_SERVICE_MODEL.read(Q.uri,null,null,true,function(g){if(g&&g.results&&g.results.length){if(Q.unit){t._updateTileModel({unitNumeric:g.results[0][Q.unit.name]});t.writeData.unitNumeric=Q.unit;t.writeData.unitNumeric.name=Q.unit.name;}t.writeData.numericData=g;var n="";var l=g.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];var p=t.getTrendIndicator(t.setThresholdValues().trendValue,l);if(t.oConfig.EVALUATION.SCALING===-2){l*=100;t.getView().oNumericContent.setFormatterValue(false);}t.DEFINITION_DATA.value=l;n=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(l),t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION);if(t.oConfig.EVALUATION.SCALING===-2){t._updateTileModel({scale:"%"});}t._updateTileModel({value:n.toString(),valueColor:t.DEFINITION_DATA.TILE_PROPERTIES.semanticColorContribution,indicator:p});s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE,l);}else{E.call(t,"no Response from QueryServiceUri");}});}}else{var T=t.setThresholdValues();var l;if(h.unitContribution){t._updateTileModel({unitContribution:h.data.results[0][h.unitContribution.name]});}if(h.unitNumeric){t._updateTileModel({unitNumeric:h.numericData.results[0][h.unitNumeric.name]});}if(h.data&&h.data.results&&h.data.results.length){f=h.dimension;t.oConfig.TILE_PROPERTIES.FINALVALUE=h.data;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,d.split(",")[0],f);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else if(g.results.length===0){t.oConfig.TILE_PROPERTIES.FINALVALUE=h.data;}else{E.call(t,"no Response from QueryServiceUri");}if(h.numericData&&h.numericData.results&&h.numericData.results.length){l=h.numericData.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];if(t.oConfig.EVALUATION.SCALING===-2){l*=100;t.getView().oNumericContent.setFormatterValue(false);}var n=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(l),t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION);if(t.oConfig.EVALUATION.SCALING===-2){t._updateTileModel({scale:"%"});}var p=t.getTrendIndicator(T.trendValue,l);t._updateTileModel({value:n.toString(),indicator:p,valueColor:t.DEFINITION_DATA.TILE_PROPERTIES.semanticColorContribution});s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE,l);}else{E.call(t,"no Response from QueryServiceUri");}}}catch(e){E.call(t,e);}},flowWithoutDesignTimeCall:function(){var t=this;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);if(this.oChip.visible.isVisible()&&!this.firstTimeVisible){this.firstTimeVisible=true;this.fetchKpiValue(function(k,b){this.CALCULATED_KPI_VALUE=k;if(t.oConfig.TILE_PROPERTIES.frameType==="TwoByOne"){t.oDualContributionView.oGenericTile.setFrameType("TwoByOne");t.oDualContributionView.oGenericTile.removeAllTileContent();t.oDualContributionView.oGenericTile.addTileContent(t.oDualContributionView.oNumericTile);t.oDualContributionView.oGenericTile.addTileContent(t.oDualContributionView.oComparisonTile);}else{t.oDualContributionView.oGenericTile.setFrameType("OneByOne");t.oDualContributionView.oGenericTile.removeAllTileContent();t.oDualContributionView.oGenericTile.addTileContent(t.oDualContributionView.oComparisonTile);}var d=this.CALCULATED_KPI_VALUE;var e=this.DEFINITION_DATA.TILE_PROPERTIES.semanticColorContribution;for(var i=0;i<this.CALCULATED_KPI_VALUE.length;i++){d[i].color=e;}this._updateTileModel({data:d});var T=t.setThresholdValues();var n=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system);t.oDualContributionView.oGenericTile.$().wrap("<a href ='"+n+"'/>");this.oDualContributionView.oGenericTile.setState(a.Loaded);var s="";if(e==="Error"){s="sb.error";}if(e==="Neutral"){s="sb.neutral";}if(e==="Critical"){s="sb.critical";}if(e==="Good"){s="sb.good";}T=t.setThresholdValues();var f,g,h,v,j,l,o,p,r;if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[0]){f=this.CALCULATED_KPI_VALUE[0].title;v=this.CALCULATED_KPI_VALUE[0].value;o=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[0].color);}if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[1]){g=this.CALCULATED_KPI_VALUE[1].title;j=this.CALCULATED_KPI_VALUE[1].value;p=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[1].color);}if(this.CALCULATED_KPI_VALUE&&this.CALCULATED_KPI_VALUE[2]){h=this.CALCULATED_KPI_VALUE[2].title;l=this.CALCULATED_KPI_VALUE[2].value;r=sap.ushell.components.tiles.indicatorTileUtils.util.getSemanticColorName(this.CALCULATED_KPI_VALUE[2].color);}var u={status:s,actual:b,target:T.targetValue,cH:T.criticalHighValue,wH:T.warningHighValue,wL:T.warningLowValue,cL:T.criticalLowValue};var w={m1:f,v1:v,c1:o,m2:g,v2:j,c2:p,m3:h,v3:l,c3:r};var C=t.oDualContributionView.oGenericTile.getTileContent()[0].getContent();var x=t.oDualContributionView.oGenericTile.getTileContent()[1].getContent();sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(C,"NT",u);sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(x,"CONT",w);},this.logError);}},flowWithDesignTimeCall:function(){var t=this;try{var b=c.getEvaluationById(this.oConfig.EVALUATION.ID);if(b){t.oConfig.EVALUATION_FILTERS=b.EVALUATION_FILTERS;t.flowWithoutDesignTimeCall();}else{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(this.oConfig,function(f){t.oConfig.EVALUATION_FILTERS=f;c.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall();});}}catch(e){this.logError(e);}},refreshHandler:function(C){if(!C.firstTimeVisible){if(Number(this.oChip.configuration.getParameterValueAsString("isSufficient"))){C.flowWithoutDesignTimeCall();}else{C.flowWithDesignTimeCall();}}},visibleHandler:function(i){if(!i){this.firstTimeVisible=false;sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef);}if(i){this.refreshHandler(this);}},onInit:function(){var t=this;t.writeData={};this.firstTimeVisible=false;this.oDualContributionView=this.getView();this.oChip=this.oDualContributionView.getViewData().chip;if(this.oChip.visible){this.oChip.visible.attachVisible(this.visibleHandler.bind(this));}this.system=this.oChip.url.getApplicationSystem();this.oDualContributionView.oGenericTile.setState(a.Loading);try{sap.ushell.components.tiles.indicatorTileUtils.util.getParsedChip(this.oChip.configuration.getParameterValueAsString("tileConfiguration"),this.oChip.preview.isEnabled(),function(b){t.oConfig=b;if(t.oChip.preview){t.oChip.preview.setTargetUrl(sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system));}if(t.oChip.preview.isEnabled()){t.setTitle();t._updateTileModel({value:8888,size:S.Auto,frameType:"TwoByOne",state:a.Loading,valueColor:V.Error,indicator:D.None,title:"US Profit Margin",footer:"Current Quarter",description:"Maximum deviation",data:[{title:"Americas",value:10,color:"Neutral",displayValue:""},{title:"EMEA",value:50,color:"Neutral",displayValue:""},{title:"APAC",value:-20,color:"Neutral",displayValue:""}]});t.oDualContributionView.oGenericTile.setState(a.Loaded);}else{t.setTitle();t.oDualContributionView.oGenericTile.attachPress(function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(t.comparisionChartODataRef);c.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,null);window.location.hash=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system);});if(Number(t.oChip.configuration.getParameterValueAsString("isSufficient"))){c.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall();}else{t.flowWithDesignTimeCall();}}});}catch(e){this.logError(e);}},onExit:function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef);}});},true);
