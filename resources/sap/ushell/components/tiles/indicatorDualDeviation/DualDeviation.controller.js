// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/model/json/JSONModel","sap/ushell/components/tiles/indicatorTileUtils/cache","sap/m/library","sap/ui/thirdparty/jquery"],function(J,c,m,q){"use strict";var D=m.DeviationIndicator;var V=m.ValueColor;var L=m.LoadState;sap.ui.controller("tiles.indicatorDualDeviation.DualDeviation",{logError:function(e){this.oDualDeviationView.oGenericTile.setState(L.Failed);this.oDualDeviationView.oGenericTile.setState(L.Failed);sap.ushell.components.tiles.indicatorTileUtils.util.logError(e);},getThresholdsObjAndColor:function(t){try{var T={};T.arrObj=[];T.returnColor=V.Neutral;var i=this.DEFINITION_DATA.EVALUATION.GOAL_TYPE;var w,a,b,d;if(i==="MI"){b=Number(t.criticalHighValue)||0;d=Number(t.warningHighValue)||0;if(b&&d){b=window.parseFloat(b);d=window.parseFloat(d);T.arrObj.push({value:b,color:V.Error});T.arrObj.push({value:d,color:V.Critical});if(this.CALCULATED_KPI_VALUE<d){T.returnColor=V.Good;}else if(this.CALCULATED_KPI_VALUE<=b){T.returnColor=V.Critical;}else{T.returnColor=V.Error;}}}else if(i==="MA"){a=Number(t.criticalLowValue)||0;w=Number(t.warningLowValue)||0;if(a&&w){a=window.parseFloat(a);w=window.parseFloat(w);T.arrObj.push({value:a,color:V.Error});T.arrObj.push({value:w,color:V.Critical});if(this.CALCULATED_KPI_VALUE<a){T.returnColor=V.Error;}else if(this.CALCULATED_KPI_VALUE<=w){T.returnColor=V.Critical;}else{T.returnColor=V.Good;}}}else{b=Number(t.criticalHighValue)||0;d=Number(t.warningHighValue)||0;a=Number(t.criticalLowValue)||0;w=Number(t.warningLowValue)||0;if(w&&d&&a&&a){b=window.parseFloat(b);d=window.parseFloat(d);w=window.parseFloat(w);a=window.parseFloat(a);T.arrObj.push({value:b,color:V.Error});T.arrObj.push({value:d,color:V.Critical});T.arrObj.push({value:w,color:V.Critical});T.arrObj.push({value:a,color:V.Error});if(this.CALCULATED_KPI_VALUE<a||this.CALCULATED_KPI_VALUE>b){T.returnColor=V.Error;}else if((this.CALCULATED_KPI_VALUE>=a&&this.CALCULATED_KPI_VALUE<=w)||(this.CALCULATED_KPI_VALUE>=d&&this.CALCULATED_KPI_VALUE<=b)){T.returnColor=V.Critical;}else{T.returnColor=V.Good;}}}return T;}catch(e){this.logError(e);}},getTrendIndicator:function(t,v){var a=this;t=Number(t);try{var b=D.None;if(t>v){b=D.Down;}else if(t<v){b=D.Up;}return b;}catch(e){a.logError(e);}},getTile:function(){return this.oDualDeviationView.oGenericTile;},_updateTileModel:function(n){var a=this.getTile().getModel().getData();q.extend(a,n);this.getTile().getModel().setData(a);},formSelectStatement:function(o){var t=Object.keys(o);var f="";for(var i=0;i<t.length;i++){if((o[t[i]]!==undefined)&&(o.fullyFormedMeasure)){f+=","+o[t[i]];}}return f;},setThresholdValues:function(){var t=this;var T={};T.fullyFormedMeasure=this.DEFINITION_DATA.EVALUATION.COLUMN_NAME;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE==="MEASURE"){switch(this.DEFINITION_DATA.EVALUATION.GOAL_TYPE){case"MI":T.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");T.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;case"MA":T.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");T.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;case"RA":T.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");T.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");T.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;}}else{T.criticalHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","FIXED");T.criticalLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","FIXED");T.warningHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","FIXED");T.warningLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","FIXED");T.targetValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","FIXED");T.trendValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","FIXED");}return T;},fetchKpiValue:function(s,E){var t=this;var k=0;try{var u=this.DEFINITION_DATA.EVALUATION.ODATA_URL;var a=this.DEFINITION_DATA.EVALUATION.ODATA_ENTITYSET;var T=this.setThresholdValues();var M=T.fullyFormedMeasure;var b=c.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(!b){var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.DEFINITION_DATA.EVALUATION_FILTERS,this.DEFINITION_DATA.ADDITIONAL_FILTERS);var Q=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oTileApi.url.addSystemToServiceUrl(u),a,M,null,v);if(Q){this.QUERY_SERVICE_MODEL=Q.model;this.queryUriForKpiValue=Q.uri;try{this.queryServiceUriODataReadRef=this.QUERY_SERVICE_MODEL.read(Q.uri,null,null,true,function(g){t.writeData={};if(g&&g.results&&g.results.length){k=g.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];if(Q.unit[0]){t._updateTileModel({unit:g.results[0][Q.unit[0].name]});t.writeData.unit=Q.unit[0];t.writeData.unit.name=Q.unit[0].name;}t.writeData.numericData=g;var S="",f;var d=k;if(t.oConfig.EVALUATION.SCALING===-2){d*=100;t.getView().oNumericContent.setFormatterValue(false);}S=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(d),t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION);f=t.getTrendIndicator(T.trendValue,d);if(t.oConfig.EVALUATION.SCALING===-2){t._updateTileModel({scale:"%"});}t._updateTileModel({value:S.toString(),indicator:f,valueColor:t.getThresholdsObjAndColor(T).returnColor});t.writeData.data=g;c.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,t.writeData);if(t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE==="MEASURE"){T.criticalHighValue=g.results[0][T.sCriticalHigh];T.criticalLowValue=g.results[0][T.sCriticalLow];T.warningHighValue=g.results[0][T.sWarningHigh];T.warningLowValue=g.results[0][T.sWarningLow];T.targetValue=g.results[0][T.sTarget];T.trendValue=g.results[0][T.sTrend];}s.call(t,k,T);}else{E.call(t,"no Response from QueryServiceUri");}},function(g){if(g&&g.response){E.call(t,g.message);}});}catch(e){t.logError("Error in Query Service URI");}}}else if(b.data&&b.data.results&&b.data.results.length){var d,S,f;T=t.setThresholdValues();d=b.data.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];if(t.oConfig.EVALUATION.SCALING===-2){d*=100;t.getView().oNumericContent.setFormatterValue(true);}if(t.oConfig.EVALUATION.SCALING===-2){t._updateTileModel({scale:"%"});}S=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(d),t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION);f=t.getTrendIndicator(T.trendValue,d);if(b.unit){t._updateTileModel({unit:b.data.results[0][b.unit.name]});}t._updateTileModel({indicator:f,value:S.toString()});if(t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE==="MEASURE"){T.criticalHighValue=b.data.results[0][T.sCriticalHigh];T.criticalLowValue=b.data.results[0][T.sCriticalLow];T.warningHighValue=b.data.results[0][T.sWarningHigh];T.warningLowValue=b.data.results[0][T.sWarningLow];T.targetValue=b.data.results[0][T.sTarget];T.trendValue=b.data.results[0][T.sTrend];}s.call(t,b.data.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME],T);}else{E.call(t,"no Response from QueryServiceUri");}}catch(e){E.call(t,e);}},flowWithoutDesignTimeCall:function(){var t=this;var f,a;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);if(this.oTileApi.visible.isVisible()&&!this.firstTimeVisible){this.firstTimeVisible=true;this.fetchKpiValue(function(k,b){var d=Number(k);if(this.oConfig.EVALUATION.SCALING===-2){d*=100;}f=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(d),this.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION);this.CALCULATED_KPI_VALUE=Number(k);var e={};var g=this.getThresholdsObjAndColor(b);var h={value:Number(k),color:g.returnColor};e.valueColor=h.color;e.actualValueLabel=f.toString();e.actual=h;var i=this.DEFINITION_DATA.EVALUATION_VALUES,j;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE==="MEASURE"){j=Number(b.targetValue);if(this.oConfig.EVALUATION.SCALING===-2){j*=100;}a=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(j,this.oConfig.EVALUATION.SCALING,this.oConfig.EVALUATION.DECIMAL_PRECISION);e.targetValue=Number(b.targetValue);e.targetValueLabel=a.toString();}else{for(var l=0;l<i.length;l++){if(i[l].TYPE==="TA"){j=Number(i[l].FIXED);if(this.oConfig.EVALUATION.SCALING===-2){j*=100;}a=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(j);e.targetValue=Number(i[l].FIXED);e.targetValueLabel=a.toString();}}}this._updateTileModel(e);var n=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system);t.oDualDeviationView.oGenericTile.$().wrap("<a href ='"+n+"'/>");this.oDualDeviationView.oGenericTile.setState(L.Loaded);var s="";if(e.valueColor==="Error"){s="sb.error";}if(e.valueColor==="Neutral"){s="sb.neutral";}if(e.valueColor==="Critical"){s="sb.critical";}if(e.valueColor==="Good"){s="sb.good";}var v={status:s,actual:d,target:b.targetValue,cH:b.criticalHighValue,wH:b.warningHighValue,wL:b.warningLowValue,cL:b.criticalLowValue};var o=v;var C=t.oDualDeviationView.oGenericTile.getTileContent()[0].getContent();var p=t.oDualDeviationView.oGenericTile.getTileContent()[1].getContent();sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(C,"NT",v);sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(p,"DT",o);},this.logError);}},flowWithDesignTimeCall:function(){var t=this;try{var a=c.getEvaluationById(this.oConfig.EVALUATION.ID);if(a){t.oConfig.EVALUATION_FILTERS=a.EVALUATION_FILTERS;t.flowWithoutDesignTimeCall();}else{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(this.oConfig,function(f){t.oConfig.EVALUATION_FILTERS=f;c.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall();});}}catch(e){this.logError(e);}},refreshHandler:function(C){if(!C.firstTimeVisible){if(Number(this.oTileApi.configuration.getParameterValueAsString("isSufficient"))){C.flowWithoutDesignTimeCall();}else{C.flowWithDesignTimeCall();}}},visibleHandler:function(i){if(!i){this.firstTimeVisible=false;sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.queryServiceUriODataReadRef);}if(i){this.refreshHandler(this);}},setTextInTile:function(){var t=this;var a=sap.ushell.components.tiles.indicatorTileUtils.util.getTileTitleSubtitle(this.oTileApi);this._updateTileModel({header:a.title||sap.ushell.components.tiles.indicatorTileUtils.util.getChipTitle(t.oConfig),subheader:a.subTitle||sap.ushell.components.tiles.indicatorTileUtils.util.getChipSubTitle(t.oConfig)});},onInit:function(){var t=this;this.firstTimeVisible=false;this.oDualDeviationView=this.getView();this.oViewData=this.oDualDeviationView.getViewData();this.oTileApi=this.oViewData.chip;if(this.oTileApi.visible){this.oTileApi.visible.attachVisible(this.visibleHandler.bind(this));}this.system=this.oTileApi.url.getApplicationSystem();this.oDualDeviationView.oGenericTile.setState(L.Loading);try{sap.ushell.components.tiles.indicatorTileUtils.util.getParsedChip(t.oTileApi.configuration.getParameterValueAsString("tileConfiguration"),t.oTileApi.preview.isEnabled(),function(a){t.oConfig=a;t.setTextInTile();if(t.oTileApi.preview){t.oTileApi.preview.setTargetUrl(sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system));}if(t.oTileApi.preview.isEnabled()){t._updateTileModel({valueColor:"Good",value:100,frameType:"TwoByOne",unit:"USD",actual:{value:120,color:V.Good},targetValue:100,thresholds:[{value:0,color:V.Error},{value:50,color:V.Critical},{value:150,color:V.Critical},{value:200,color:V.Error}],showActualValue:true,showTargetValue:true});t.oDualDeviationView.oGenericTile.setState(L.Loaded);}else{t.oDualDeviationView.oGenericTile.attachPress(function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(t.queryServiceUriODataReadRef);c.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,null);window.location.hash=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system);});if(Number(t.oTileApi.configuration.getParameterValueAsString("isSufficient"))){c.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall();}else{t.flowWithDesignTimeCall();}}});}catch(e){this.logError(e);}},_setLocalModelToTile:function(){if(!this.getTile().getModel()){this.getTile().setModel(new J({}));}},onExit:function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.queryServiceUriODataReadRef);}});return{};},true);
