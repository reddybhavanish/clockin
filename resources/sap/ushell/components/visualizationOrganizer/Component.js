// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/library","sap/ui/core/UIComponent","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/base/Log","sap/ushell/resources"],function(m,U,F,c,J,L,r){"use strict";var B=m.ButtonType;return U.extend("sap.ushell.components.visualizationOrganizer.Component",{metadata:{version:"1.78.0",library:"sap.ushell",dependencies:{libs:["sap.m"]}},init:function(){U.prototype.init.apply(this,arguments);this.mVizIdInPages=new Map();this.stVizIdInSection=new Set();},requestData:function(){return sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(C){return C.getAllPages();}).then(function(M){this._fillVizIdMaps(M);}.bind(this));},_fillVizIdMaps:function(p){this.mVizIdInPages=new Map();p.forEach(function(P){Object.keys(P.payload.sections).forEach(function(i){Object.keys(P.payload.sections[i].viz).forEach(function(I){var v=P.payload.sections[i].viz[I].vizId;if(this.mVizIdInPages.has(v)){this.mVizIdInPages.get(v).add(P.identification.id);}else{this.mVizIdInPages.set(v,new Set([P.identification.id]));}}.bind(this));}.bind(this));}.bind(this));},isVizIdPresent:function(v,s){if(s){return this.stVizIdInSection.has(v);}var a=this.mVizIdInPages.get(v);return!!(a&&a.size);},formatPinButtonIcon:function(v,s){return(this.isVizIdPresent(decodeURIComponent(v),s)?"sap-icon://accept":"sap-icon://add");},formatPinButtonType:function(v,s){return(this.isVizIdPresent(decodeURIComponent(v),s)?B.Emphasized:B.Default);},formatPinButtonTooltip:function(v,s){var i=this.isVizIdPresent(decodeURIComponent(v),!!s),t,S;if(s){S=s.sectionTitle;if(i){t="VisualizationOrganizer.Button.Tooltip.RemoveFromSection";}else{t="VisualizationOrganizer.Button.Tooltip.AddToSection";}}else if(i){t="EasyAccessMenu_PinButton_Toggled_Tooltip";}else{t="EasyAccessMenu_PinButton_UnToggled_Tooltip";}return r.i18n.getText(t,S);},onTilePinButtonClick:function(e,s){var S=e.getSource(),t=S.getBindingContext().getProperty();if(s){return this._applyOrganizationChangeToSection(S,t,s);}return this.toggle(S,t);},open:function(o,v){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover");if(!p){p=sap.ui.xmlfragment("sap.ushell.components.visualizationOrganizer.VisualizationOrganizerPopover",this);p.setModel(new J({pages:[],searchTerm:""}));p.setModel(r.i18nModel,"i18n");}this.oOpenBy=o;this.sVisualizationId=decodeURIComponent(v.id);this.sVisualizationTitle=v.title;this.fnOrganizeVisualizations=this._organizeVisualizations.bind(this);this.fnResetPopup=this._resetPopup.bind(this);p.attachBeforeClose(this.fnOrganizeVisualizations);p.attachAfterClose(this.fnResetPopup);return Promise.all([sap.ushell.Container.getServiceAsync("Menu"),sap.ushell.Container.getServiceAsync("CommonDataModel")]).then(function(R){return Promise.all([R[0].getSpacesPagesHierarchy(),R[1].getAllPages()]);}).then(function(R){var P=this.mVizIdInPages.get(this.sVisualizationId),s=R[0].spaces,a=R[1],b={};a.forEach(function(f){b[f.identification.id]=f.identification.title;});var d=[];s.forEach(function(f){f.pages.forEach(function(g){var h=b[g.id];if(!h){return;}d.push({id:g.id,title:b[g.id],space:f.title,selected:P&&P.has(g.id)});});});var e=p.getModel();e.setProperty("/pages",d);e.setProperty("/pinnedPages",P);p.openBy(o);}.bind(this));},close:function(){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover");if(p){p.close();}},toggle:function(o,v){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover");if(p&&p.isOpen()&&p._oOpenBy&&p._oOpenBy.getId()===o.getId()){this.close();return Promise.resolve();}return this.open(o,v);},_applyOrganizationChangeToSection:function(o,v,s){var V=decodeURIComponent(v.id),d=v.title,p=s.pageID,S=s.sectionID,P=sap.ushell.Container.getService("Pages"),e,M;if(this.stVizIdInSection.has(V)){M=r.i18n.getText("VisualizationOrganizer.MessageToastSectionContextRemove",[d||V,s.sectionTitle,s.pageTitle]);e=P.findVisualization(p,S,V).then(function(f){if(f.length===0){return Promise.resolve();}var g=f[0],i=P.getPageIndex(p),h=g.sectionIndex,j;var k=g.vizIndexes.sort(function(a,b){return b-a;});k.forEach(function(a){if(!j){j=P.deleteVisualization(i,h,a);}else{j=j.then(function(){return P.deleteVisualization(i,h,a);});}});return j;}).then(function(){this.stVizIdInSection.delete(V);}.bind(this));}else{M=r.i18n.getText("VisualizationOrganizer.MessageToastSectionContextAdd",[d||V,s.sectionTitle,s.pageTitle]);e=P.addVisualization(p,S,V).then(function(){this.stVizIdInSection.add(V);}.bind(this));}return e.then(function(){o.getBinding("icon").refresh(true);o.getBinding("type").refresh(true);o.getBinding("tooltip").refresh(true);sap.ui.require(["sap/m/MessageToast"],function(a){a.show(M,{offset:"0 -50"});});});},_organizeVisualizations:function(e){var p=e.getSource(),P=p.getContent()[1],o=p.getModel(),s=o.getProperty("/pinnedPages")||new Set(),a=[],d=[];P.getBinding("items").filter(null);var i=P.getItems().filter(function(I){return I.isA("sap.m.StandardListItem");});i.forEach(function(I){var b=I.getBindingContext().getProperty("id");if(I.getSelected()&&!s.has(b)){a.push(I);}else if(!I.getSelected()&&s.has(b)){d.push(I);}});return this._applyOrganizationChange({addToItems:a,deleteFromItems:d});},_applyOrganizationChange:function(v){var C=(v.addToItems.length+v.deleteFromItems.length);if(!C){return Promise.resolve();}var V=this.sVisualizationId;var s=new Set();var p;var o=sap.ushell.Container.getServiceAsync("Pages").then(function(P){p=P;});function d(e){var f;var S=e.sort(function(a,b){return b.sectionIndex-a.sectionIndex;});S.forEach(function(g){var h=g.vizIndexes.sort(function(a,b){return b-a;});h.forEach(function(a){if(!f){f=p.deleteVisualization(p.getPageIndex(g.pageId),g.sectionIndex,a);}else{f=f.then(function(){return p.deleteVisualization(p.getPageIndex(g.pageId),g.sectionIndex,a);});}});});return f||Promise.resolve();}v.deleteFromItems.forEach(function(R){var P=R.getBindingContext().getProperty("id");if(!s.has(P)){s.add(P);o=o.then(function(){return p.findVisualization(P,null,V).then(d);});}this.mVizIdInPages.get(V).delete(P);}.bind(this));v.addToItems.forEach(function(a){var P=a.getBindingContext().getProperty("id");o=o.then(function(){return p.addVisualization(P,null,V);});if(this.mVizIdInPages.has(V)){this.mVizIdInPages.get(V).add(P);}else{this.mVizIdInPages.set(V,new Set([P]));}}.bind(this));o.then(function(){if(this.oOpenBy){this.oOpenBy.getBinding("icon").refresh(true);this.oOpenBy.getBinding("type").refresh(true);this.oOpenBy.getBinding("tooltip").refresh(true);}sap.ui.require(["sap/m/MessageToast"],function(M){M.show(r.i18n.getText("VisualizationOrganizer.MessageToast",[C]));});}.bind(this));return o;},_resetPopup:function(e){var p=e.getSource(),s=p.getContent()[0],P=p.getContent()[1];p.detachBeforeClose(this.fnOrganizeVisualizations);p.detachAfterClose(this.fnResetPopup);s.setValue("");P.removeSelections();delete this.fnOrganizeVisualizations;delete this.fnResetPopup;delete this.sVisualizationId;delete this.sVisualizationTitle;},pagePressed:function(e){var s=e.getSource();s.setSelected(!s.getSelected());},_onSearch:function(e){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover"),P=p.getContent()[1],b=P.getBinding("items"),s=e.getSource().getValue();b.filter(new F({filters:[new F({path:"title",operator:c.Contains,value1:s}),new F({path:"space",operator:c.Contains,value1:s})],and:false}));if(b.getLength()===0){P.setNoDataText(r.i18n.getText(s?"VisualizationOrganizer.PagesList.NoResultsText":"VisualizationOrganizer.PagesList.NoDataText"));}},loadSectionContext:function(C){this.stVizIdInSection.clear();if(!C||!C.pageID||!C.sectionID){return Promise.resolve(null);}return sap.ushell.Container.getServiceAsync("Pages").then(function(p){var P=decodeURIComponent(C.pageID),s=decodeURIComponent(C.sectionID);return p.loadPage(P).then(function(a){var o=p.getModel().getProperty(a),S,b;for(var i=0;i<o.sections.length;i++){if(o.sections[i].id===s){S=o.sections[i];break;}}if(!S){return Promise.resolve(null);}S.visualizations.forEach(function(v){this.stVizIdInSection.add(v.vizId);}.bind(this));b={pageID:P,sectionID:s,pageTitle:o.title,sectionTitle:S.title};return Promise.resolve(b);}.bind(this)).catch(function(){L.warning(P+" cannot be loaded. Please, check the id of the page.");return Promise.resolve(null);});}.bind(this));},exit:function(){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover");if(p){p.destroy();}}});});
