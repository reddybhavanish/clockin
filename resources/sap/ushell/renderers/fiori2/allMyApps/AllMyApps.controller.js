// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/library","sap/ushell/renderers/fiori2/allMyApps/AllMyAppsManager","sap/ushell/Config","sap/ui/Device","sap/ui/performance/Measurement","sap/ui/events/KeyCodes","sap/ui/thirdparty/jquery","sap/ui/model/json/JSONModel","sap/ushell/resources","sap/ushell/utils/WindowUtils"],function(l,A,C,D,M,K,q,J,r,W){"use strict";var s=false;var a=function(v){this.init(v);};var b=l.AllMyAppsState;var c=l.AppTitleState;sap.ui.controller("sap.ushell.renderers.fiori2.allMyApps.AllMyApps",{iNumberOfProviders:0,onInit:function(){this.bFirstLoadOfAllMyApps=true;var o=new J();o.setSizeLimit(10000);o.setProperty("/AppsData",[]);this.getView().setModel(o,"allMyAppsModel");sap.ui.getCore().getEventBus().subscribe("launchpad","allMyAppsFirstCatalogLoaded",this.updateMasterFocusAndDetailsContext,this);sap.ui.getCore().getEventBus().subscribe("launchpad","allMyAppsFirstCatalogLoaded",this.onDetailLoad,this);sap.ui.getCore().getEventBus().subscribe("launchpad","allMyAppsMasterLoaded",this.onMasterLoad,this);sap.ui.getCore().getEventBus().subscribe("launchpad","allMyAppsNoCatalogsLoaded",this.onNoCatalogsLoaded,this);},onExit:function(){sap.ui.getCore().getEventBus().unsubscribe("launchpad","allMyAppsFirstCatalogLoaded",this.updateMasterFocusAndDetailsContext);sap.ui.getCore().getEventBus().unsubscribe("launchpad","allMyAppsFirstCatalogLoaded",this.onDetailLoad,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","allMyAppsMasterLoaded",this.onMasterLoad,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","allMyAppsNoCatalogsLoaded",this.onNoCatalogsLoaded,this);},onAfterRendering:function(){var t=this,v=this.getView(),o=v.getModel("allMyAppsModel"),S=v.oSplitApp;if(!this.bAfterInitialLoading){S.toMaster("allMyAppsMasterBusyIndicator","show");if(!D.system.phone){S.toDetail("allMyAppsDetailBusyIndicator","show");}}if(this.bFirstLoadOfAllMyApps){o.setProperty("/AppsData",[]);}else{var m=o.getProperty("/AppsData");o.setProperty("/AppsData",m);}setTimeout(function(){t._getAllMyAppsManager().loadAppsData(o,t._getPopoverObject(),t.bFirstLoadOfAllMyApps);s=t._isSingleDataSource();t.switchToInitialState();t.bFirstLoadOfAllMyApps=false;},0);},switchToInitialState:function(){var v=this.getView(),S;if(this._isSingleDataSource()){C.emit("/core/shell/model/allMyAppsMasterLevel",b.FirstLevelSpread);v.oDataSourceList.bindItems("allMyAppsModel>/AppsData/0/groups",v.oDataSourceListTemplate);}else{C.emit("/core/shell/model/allMyAppsMasterLevel",b.FirstLevel);v.oDataSourceList.bindItems("allMyAppsModel>/AppsData",v.oDataSourceListTemplate);}if(D.system.phone){S=this.getView().oSplitApp;S.toMaster("sapUshellAllMyAppsMasterPage","show");}v.oDataSourceList.rerender();this.updateMasterFocusAndDetailsContext(undefined,undefined,{bFirstCatalogLoadedEvent:true});this._getPopoverHeaderLabel().setText(r.i18n.getText("allMyApps_headerTitle"));this.updateHeaderButtonsState();},handleSwitchToMasterAreaOnPhone:function(){var S=this.getView().oSplitApp,d=this._getDataSourcesSelectedPath(),p=d.split("/");S.toMaster("sapUshellAllMyAppsMasterPage","show");if(this._isSingleDataSource()){C.emit("/core/shell/model/allMyAppsMasterLevel",b.FirstLevelSpread);}else if(p.length===3){C.emit("/core/shell/model/allMyAppsMasterLevel",b.FirstLevel);}else{C.emit("/core/shell/model/allMyAppsMasterLevel",b.SecondLevel);}this.updateHeaderButtonsState();},handleMasterListItemPress:function(o){var d=this._getClickedDataSourceItemPath(o),v=this.getView(),e=v.getModel("allMyAppsModel"),f=e.getProperty(d+"/type"),g=C.last("/core/shell/model/allMyAppsMasterLevel"),i=(f===sap.ushell.Container.getService("AllMyApps").getProviderTypeEnum().CATALOG),B;this.lastPressedMasterItem=o.getParameter("listItem");if(i||(g===b.FirstLevelSpread)||(g===b.SecondLevel)){B=this.handleMasterListItemPress_toDetails(o);}else{B=this.handleMasterListItemPress_toSecondLevel(o);}v.oCustomLabel.setBindingContext(B,"allMyAppsModel");v.oCustomPanel.setBindingContext(B,"allMyAppsModel");if(v.oCustomLink){v.oCustomLink.setBindingContext(B,"allMyAppsModel");}},handleMasterListItemPress_toSecondLevel:function(o){var d=this._getClickedDataSourceItemPath(o),v=this.getView(),e=v.getModel("allMyAppsModel"),f=e.getProperty(d+"/type"),g=e.getProperty(d+"/title"),S=this.getView().oSplitApp,B,h;if(!D.system.phone){S.toDetail("sapUshellAllMyAppsDetailsPage");}v.oDataSourceList.bindItems("allMyAppsModel>"+d+"/groups",v.oDataSourceListTemplate);C.emit("/core/shell/model/allMyAppsMasterLevel",b.SecondLevel);B=this._setBindingContext(d+"/groups/0",v.oItemsContainer);v.oDataSourceList.rerender();v.oDataSourceList.setSelectedItem(v.oDataSourceList.getItems()[0]);h=v.oDataSourceList.getSelectedItem();if(h){h.focus();}if(f===sap.ushell.Container.getService("AllMyApps").getProviderTypeEnum().HOME){this._getPopoverHeaderLabel().setText(r.i18n.getText("allMyApps_homeEntryTitle"));}else if(f===sap.ushell.Container.getService("AllMyApps").getProviderTypeEnum().EXTERNAL){this._getPopoverHeaderLabel().setText(g);}this._getDetailsHeaderLabel().setText(e.getProperty(d+"/groups/0/title"));this.updateHeaderButtonsState();return B;},handleMasterListItemPress_toDetails:function(o){var d=this._getClickedDataSourceItemPath(o),v=this.getView(),e=v.getModel("allMyAppsModel"),S=v.oSplitApp,B=this._setBindingContext(d,v.oItemsContainer);this._getDetailsHeaderLabel().setText(e.getProperty(d+"/title"));if(D.system.phone){S.toDetail("sapUshellAllMyAppsDetailsPage");C.emit("/core/shell/model/allMyAppsMasterLevel",b.Details);}this.updateHeaderButtonsState();return B;},onMasterLoad:function(){var v=this.getView(),S=v.oSplitApp,B=this._getPopoverHeaderBackButton();this.bAfterInitialLoading=true;if(S.getCurrentMasterPage()===v.oMasterBusyIndicator){S.toMaster("sapUshellAllMyAppsMasterPage","show");}B.focus();s=this._isSingleDataSource();this.updateMasterFocusAndDetailsContext(undefined,undefined,{bFirstCatalogLoadedEvent:false});},onDetailLoad:function(){var v=this.getView(),S=v.oSplitApp;this.bAfterInitialLoading=true;if(!D.system.phone){S.toDetail("sapUshellAllMyAppsDetailsPage","show");}},onNoCatalogsLoaded:function(){var v=this.getView(),S=v.oSplitApp;if((!D.system.phone)&&(!s)){S.toDetail("sapUshellAllMyAppsEmptyDetailsPage","show");}else if((!D.system.phone)&&s){S.toDetail("sapUshellAllMyAppsDetailsPage");}},updateMasterFocusAndDetailsContext:function(d,e,o){var v=this.getView(),f=v.getModel("allMyAppsModel"),F=this._getInitialFirstLevelSelectionIndex(),B,g,S;if(s===true){B=f.createBindingContext("/AppsData/0/groups/0");g=f.getProperty(B.sPath);}else{B=f.createBindingContext("/AppsData/"+F);g=f.getProperty(B.sPath);}v.oItemsContainer.setBindingContext(B,"allMyAppsModel");v.oCustomLabel.setBindingContext(B,"allMyAppsModel");v.oCustomPanel.setBindingContext(B,"allMyAppsModel");if(v.oCustomLink){v.oCustomLink.setBindingContext(B,"allMyAppsModel");}if(g!==undefined){this._getDetailsHeaderLabel().setText(g.title);}if(o.bFirstCatalogLoadedEvent===true){v.oDataSourceList.rerender();}if(o.bFirstCatalogLoadedEvent===false&&F===0){this.onNoCatalogsLoaded();}v.oDataSourceList.setSelectedItem(v.oDataSourceList.getItems()[F]);S=v.oDataSourceList.getSelectedItem();if(S){S.focus();}if(o.bFirstCatalogLoadedEvent){M.end("FLP:ShellAppTitle.onClick");M.end("FLP:ShellNavMenu.footerClick");}},handleGroupPress:function(e){var v=this.getView(),d=v.oCustomLink?v.oCustomLink.getBindingContext("allMyAppsModel").getObject():{};if(d.handlePress){d.handlePress(e,d);}},updateHeaderButtonsState:function(){this._getShellAppTitleToggleListButton().setVisible(this.getToggleListButtonVisible());this._getPopoverHeaderBackButton().setVisible(this.getBackButtonVisible());},getToggleListButtonVisible:function(){var o=this.getCurrentState(),i=D.media.getCurrentRange(D.media.RANGESETS.SAP_STANDARD).name==="Phone",v=(i||D.system.phone)&&(o===b.Details);return v;},getBackButtonVisible:function(){var S=C.last("/core/shellHeader/ShellAppTitleState");if(S!==c.AllMyAppsOnly){return true;}var o=this.getCurrentState();return o===b.SecondLevel||o===b.Details;},onAppItemClick:function(o){var d=this.getView().getModel("allMyAppsModel"),e=o.getBindingContext("allMyAppsModel").sPath,u=d.getProperty(e+"/url");if(u){if(u[0]==="#"){hasher.setHash(u);setTimeout(function(){this.getView().getParent().close();}.bind(this),50);}else{W.openURL(u,"_blank");}}},getCurrentState:function(){return C.last("/core/shell/model/allMyAppsMasterLevel");},_isSingleDataSource:function(){var o=sap.ushell.Container.getService("AllMyApps");if(o.isCatalogAppsEnabled()){return false;}if(!o.isExternalProviderAppsEnabled()&&o.isHomePageAppsEnabled()){return true;}if(o.isExternalProviderAppsEnabled()&&Object.keys(o.getDataProviders()).length===1&&!o.isHomePageAppsEnabled()){return true;}return false;},_getInitialFirstLevelSelectionIndex:function(){var v=this.getView(),o=v.getModel("allMyAppsModel"),d=o.getProperty("/AppsData"),i,t;for(i=0;i<d.length;i++){t=d[i];if(t.type===sap.ushell.Container.getService("AllMyApps").getProviderTypeEnum().CATALOG){return i;}}return 0;},_getPopoverHeaderBackButton:function(){if(!this._oPopoverHeaderBackButton){this._oPopoverHeaderBackButton=this._getPopoverHeaderContent(0);}return this._oPopoverHeaderBackButton;},_getShellAppTitleToggleListButton:function(){if(!this._oShellAppTitleToggleListButton){this._oShellAppTitleToggleListButton=this._getPopoverHeaderContent(1);}return this._oShellAppTitleToggleListButton;},_getPopoverHeaderContent:function(i){var o,h,d;o=this._getPopoverObject().getCustomHeader();h=o.getContentLeft();d=h[i];return d;},_getPopoverHeaderLabel:function(){var o,d;o=this._getPopoverObject().getCustomHeader();d=o.getContentMiddle();return d[0];},_getPopoverObject:function(){return this.getView().getParent();},_getDetailsHeaderLabel:function(){return this.getView().oDetailsHeaderLabel;},_setBindingContext:function(B,o){var d=this.getView().getModel("allMyAppsModel"),e=d.createBindingContext(B);o.setBindingContext(e,"allMyAppsModel");return e;},_getClickedDataSourceItemPath:function(o){var d=o.getParameter("listItem");return d.getBindingContext("allMyAppsModel").sPath;},_getAllMyAppsManager:function(){return A;},_getDataSourcesSelectedPath:function(){return this.lastPressedMasterItem.getBindingContextPath();},initKeyBoardNavigationHandling:function(){if(this.keyboardNavigation){this.keyboardNavigation.destroy();}this.keyboardNavigation=new a(this.getView());}});a.prototype.init=function(v){this.keyCodes=K;v.oDataSourceList.addEventDelegate({onsaptabnext:function(e){var d=q(".sapUshellAllMyAppsListItem");this.jqDetailAreaElement=v.oItemsContainer.$();this.jqDetailAreaElement.on("keydown.keyboardNavigation",this.keydownHandler.bind(this));this._setItemFocus(e,d[0]);}.bind(this)});v.oItemsContainer.addEventDelegate({onsaptabprevious:function(){var o=q(".sapUshellAllMyAppsListItem[tabindex=\"0\"]")[0];q(o).attr("tabindex",-1);},onsaptabnext:function(){var d=q(".sapUshellAllMyAppsCustomPanel"),o=q(".sapUshellAllMyAppsListItem[tabindex=\"0\"]")[0];if(d.length===0){q(o).attr("tabindex",-1);}}});v.oCustomPanel.addEventDelegate({onsaptabnext:function(e){var o=q(".sapUshellAllMyAppsListItem[tabindex=\"0\"]")[0];q(o).attr("tabindex",-1);}});};a.prototype.keydownHandler=function(e){switch(e.keyCode){case this.keyCodes.ARROW_UP:this.arrowKeyHandler(e,-2);break;case this.keyCodes.ARROW_DOWN:this.arrowKeyHandler(e,2);break;case this.keyCodes.ARROW_LEFT:this.arrowKeyHandler(e,-1);break;case this.keyCodes.ARROW_RIGHT:this.arrowKeyHandler(e,1);break;default:break;}};a.prototype.arrowKeyHandler=function(e,d){var f=q(".sapUshellAllMyAppsListItem").toArray(),o=q(".sapUshellAllMyAppsListItem[tabindex=\"0\"]")[0],i=f.indexOf(o),E=f[i+d];if(E){q(o).attr("tabindex",-1);this._setItemFocus(e,E);}};a.prototype._setItemFocus=function(e,E){if(E){e.preventDefault();e.stopImmediatePropagation();q(E).attr("tabindex",0);E.focus();}};a.prototype.destroy=function(){if(this.jqDetailAreaElement){this.jqDetailAreaElement.off(".keyboardNavigation");}delete this.jqDetailAreaElement;};});
