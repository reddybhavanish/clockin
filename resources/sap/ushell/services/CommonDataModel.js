// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_CommonDataModel/PersonalizationProcessor","sap/base/util/ObjectPath","sap/ui/thirdparty/jquery","sap/base/util/isPlainObject","sap/ushell/services/_CommonDataModel/SiteConverter","sap/base/util/isEmptyObject","sap/base/util/deepClone","sap/base/util/Version","sap/ushell/Config","sap/base/util/includes","sap/base/util/values"],function(P,O,q,a,S,b,d,V,C,c,e){"use strict";var f="sap.ushell.services.CommonDataModel",g={"STATIC_LAUNCHER":"sap.ushell.StaticAppLauncher","DYNAMIC_LAUNCHER":"sap.ushell.DynamicAppLauncher","CARD":"sap.ushell.Card"};function h(A,o,p,s){var i=new q.Deferred();this._oAdapter=A;this._oPersonalizationProcessor=new P();this._oSiteDeferred=i;this._oOriginalSite={};this._oPersonalizedSite={};this._oContentProviderIndex={};this._oSiteConverter=new S();this._oPersonalizationDeltas={};this._oGetSitePromise=A.getSite().then(this._loadAndApplyPersonalization.bind(this)).fail(i.reject);}h.prototype._loadAndApplyPersonalization=function(s){this._oOriginalSite=q.extend(true,{},s);var o=new V(s._version);if(o.compareTo("3.1.0")<0){this._oAdapter.getPersonalization(o).then(function(p){if(p){this._oPersonalizationDeltas=d(p);}else{this._oPersonalizationDeltas={version:"3.0.0",_version:"3.0.0"};}this._triggerMixinPersonalisationInSite(s,p);}.bind(this)).fail(this._oSiteDeferred.reject);}else{this._oPersonalizedPages={};this._oOriginalSite=this._ensureStandardVizTypesPresent(this._oOriginalSite);this._oSiteDeferred.resolve(this._oOriginalSite);}};h.prototype._loadAndApplyPagePersonalization=function(p){var s=p.identification.id;var o=new Promise(function(r,i){this._oAdapter.getPersonalization(this._oOriginalSite._version).done(function(j){if(Object.keys(j).length){var v=new V(j._version);if(v.compareTo("3.1.0")<0){j={classicHomePage:j,_version:"3.1.0"};}}this._oPersonalizationDeltas=j;r(j);}.bind(this)).fail(i);}.bind(this));return o.then(function(i){var j=i[s]||{};var k=this._oSiteConverter.convertTo("3.0.0",d(p));return this._triggerMixinPersonalisationInSite(k,j);}.bind(this)).then(function(i){this._oPersonalizedPages[s]=this._oSiteConverter.convertTo("3.1.0",d(i));return this._oPersonalizedPages[s];}.bind(this));};h.prototype._triggerMixinPersonalisationInSite=function(s,p){return new Promise(function(r,i){this._oPersonalizationProcessor.mixinPersonalization(s,p).done(function(o){this._oPersonalizedSite=this._ensureCompleteSite(o);this._oPersonalizedSite=this._ensureGroupsOrder(this._oPersonalizedSite);this._oPersonalizedSite=this._ensureStandardVizTypesPresent(this._oPersonalizedSite);this._oSiteDeferred.resolve(this._oPersonalizedSite);r(this._oPersonalizedSite);}.bind(this)).fail(function(m){this._oSiteDeferred.reject(m);i();}.bind(this));}.bind(this));};h.prototype.getHomepageGroups=function(){var D=new q.Deferred();this._oSiteDeferred.then(function(s){var G=(s&&s.site&&s.site.payload&&s.site.payload.groupsOrder)?s.site.payload.groupsOrder:[];D.resolve(G);});return D.promise();};h.prototype.getGroups=function(){var D=new q.Deferred();this._oSiteDeferred.then(function(s){var G=[];Object.keys(s.groups).forEach(function(k){G.push(s.groups[k]);});D.resolve(G);});return D.promise();};h.prototype.getGroup=function(i){var D=new q.Deferred();this._oSiteDeferred.then(function(s){var G=s.groups[i];if(G){D.resolve(G);}else{D.reject("Group "+i+" not found");}});return D.promise();};h.prototype.getSite=function(){return this._oSiteDeferred.promise();};h.prototype.getPage=function(p){return new Promise(function(r,i){var E=C.last("/core/shell/enablePersonalization");this._oGetSitePromise.done(function(){this._getPageFromAdapter(p).then(function(o){if(E){this._loadAndApplyPagePersonalization(o).then(r).catch(function(){i("Personalization Processor: Cannot mixin the personalization.");});}else{r(o);}}.bind(this)).catch(function(){i("CommonDataModel Service: Cannot get page "+p);});}.bind(this)).fail(i);}.bind(this));};h.prototype._getPageFromAdapter=function(p){if(!this._oAdapter.getPage){return Promise.resolve(this._oOriginalSite.pages[p]);}return this._oAdapter.getPage(p).then(function(o){this._oOriginalSite.pages[p]=o;return o;}.bind(this));};h.prototype.getPages=function(p){return new Promise(function(r,i){var E=C.last("/core/shell/enablePersonalization");this._oGetSitePromise.done(function(){this._getPagesFromAdapter(p).then(function(o){var j=Promise.resolve(e(o));if(E){j=Promise.all(Object.keys(o).map(function(s){return this._loadAndApplyPagePersonalization(o[s]).catch(function(){i("Personalization Processor: Cannot mixin the personalization.");});}.bind(this)));}j.then(function(k){var F=k.filter(function(m){return!!m;});r(F);});}.bind(this)).catch(function(){i("CommonDataModel Service: Cannot get pages");});}.bind(this)).fail(i);}.bind(this));};h.prototype._getPagesFromAdapter=function(p){if(!this._oAdapter.getPages){var o={};for(var s in this._oOriginalSite.pages){if(c(p,this._oOriginalSite.pages[s].identification.id)){o[s]=this._oOriginalSite.pages[s];}}return Promise.resolve(o);}return this._oAdapter.getPages(p).then(function(i){Object.keys(i).forEach(function(s){this._oOriginalSite.pages[s]=i[s];}.bind(this));return i;}.bind(this));};h.prototype.getAllPages=function(){return sap.ushell.Container.getServiceAsync("Menu").then(function(m){return m.getSpacesPagesHierarchy();}).then(function(H){var p=[];H.spaces.forEach(function(s){s.pages.forEach(function(o){if(p.indexOf(o.id)===-1){p.push(o.id);}});});return this.getPages(p);}.bind(this));};h.prototype.getApplications=function(){return new Promise(function(r,i){this._oSiteDeferred.then(function(s){var A=s.applications;if(A){r(A);}else{i("CDM applications not found.");}}).fail(i);}.bind(this));};h.prototype.getVizTypes=function(){return new Promise(function(r,i){this._oSiteDeferred.then(function(s){var v=s.vizTypes;if(v){r(v);}else{i("CDM vizTypes not found.");}}).fail(i);}.bind(this));};h.prototype.getVisualizations=function(){return new Promise(function(r,i){this._oSiteDeferred.then(function(s){var v=s.visualizations;if(v){r(v);}else{i("CDM visualizations not found.");}}).fail(i);}.bind(this));};h.prototype.getGroupFromOriginalSite=function(G){var D=new q.Deferred();if(typeof G==="string"&&this._oOriginalSite&&this._oOriginalSite.groups&&this._oOriginalSite.groups[G]){D.resolve(q.extend(true,{},this._oOriginalSite.groups[G]));}else{D.reject("Group does not exist in original site.");}return D.promise();};h.prototype.getOriginalPage=function(p){return this._oOriginalSite.pages[p];};h.prototype.save=function(p){var D=new q.Deferred(),o,i;if(this._oOriginalSite._version==="3.1.0"){if(!p){return D.reject("No page id was provided").promise();}i=this._oSiteConverter.convertTo("3.0.0",this._oOriginalSite.pages[p]);o=this._oSiteConverter.convertTo("3.0.0",this._oPersonalizedPages[p]);}else{i=this._oOriginalSite;o=this._oPersonalizedSite;}this._oPersonalizationProcessor.extractPersonalization(o,i).done(function(E){if(!b(E)){if(this._oPersonalizationDeltas.version===undefined||this._oPersonalizationDeltas._version===undefined){this._oPersonalizationDeltas.version=this._oOriginalSite._version;this._oPersonalizationDeltas._version=this._oOriginalSite._version;}if(p){this._oPersonalizationDeltas[p]=E;}else{this._oPersonalizationDeltas=E;}this._setPersonalization(this._oPersonalizationDeltas).then(D.resolve).catch(D.reject);}else{D.resolve();}}.bind(this)).fail(function(){D.reject("Personalization Processor: Cannot extract personalization.");});return D.promise();};h.prototype._setPersonalization=function(i,p){if(this._oPendingPersonalizationDeferred){if(!this._oNextPersonalizationQuery){this._oNextPersonalizationQuery={fnNextCall:null,aPromiseResolvers:[]};}return new Promise(function(r,j){this._oNextPersonalizationQuery.fnNextCall=this._setPersonalization.bind(this,i,p);this._oNextPersonalizationQuery.aPromiseResolvers.push({resolve:r,reject:j});}.bind(this));}this._oPendingPersonalizationDeferred=this._oAdapter.setPersonalization(i,p);return new Promise(function(r,j){this._oPendingPersonalizationDeferred.then(r).fail(j).always(function(){delete this._oPendingPersonalizationDeferred;if(this._oNextPersonalizationQuery){var n=this._oNextPersonalizationQuery.fnNextCall();this._cleanupPersonalizationQueuePromises(n,this._oNextPersonalizationQuery.aPromiseResolvers);delete this._oNextPersonalizationQuery;}}.bind(this));}.bind(this));};h.prototype._cleanupPersonalizationQueuePromises=function(n,i){i.forEach(function(p){n.then(p.resolve).catch(p.reject);});};function l(){var p=sap.ushell.Container.getService("PluginManager");return p.loadPlugins("ContentProvider");}h.prototype._getUnreferencedCatalogApplications=function(E){var u={};var A=Object.keys(E.applications).map(function(s){return E.applications[s]["sap.app"].id;}).reduce(function(i,s){i[s]=true;return i;},{});var o=E.catalogs;Object.keys(o).forEach(function(s){var i=o[s].payload.appDescriptors;i.map(function(j){return j.id;}).filter(function(j){return!A[j];}).forEach(function(B){if(!u.hasOwnProperty(s)){u[s]={};}u[s][B]=true;});});return u;};h.prototype._formatUnreferencedApplications=function(s,u){return"One or more apps from "+s+" content provider are not listed among the applications section "+"of the extended site and will be discarded - "+Object.keys(u).map(function(i){var B=Object.keys(u[i]).map(function(U){return"'"+U+"'";});return"From catalog '"+i+"': "+B.join(", ");}).join("; ");};h.prototype._removeUnreferencedApplications=function(E,u){Object.keys(E.catalogs).forEach(function(s){var o=E.catalogs[s].payload;var A=o.appDescriptors;o.appDescriptors=A.filter(function(i){return u[s]&&!u[s][i.id];});});};h.prototype.getExtensionSites=function(){var t=this;var D=new q.Deferred();l().done(function(){var i=Object.keys(t._oContentProviderIndex),T=i.length;if(T===0){D.resolve([]);return;}var G=i.map(function(s,I){var o=t._oContentProviderIndex[s];var j;try{j=o.getSite();if(!j||typeof j.then!=="function"){throw"getSite does not return a Promise";}}catch(E){j=Promise.reject("call to getSite failed: "+E);}return j.then(function(s,k){var m=q.extend(true,{},k);var u=t._getUnreferencedCatalogApplications(k);if(Object.keys(u).length>0){var n=t._formatUnreferencedApplications(s,u);q.sap.log.error(n,null,f);t._removeUnreferencedApplications(m,u);}var L={providerId:s,success:true,site:m};D.notify(L);return L;}.bind(null,s),function(s,k){return{providerId:s,success:false,error:k};}.bind(null,s));});Promise.all(G).then(function(L){D.resolve(L);});});return D.promise();};h.prototype.registerContentProvider=function(i,s){if(this._oContentProviderIndex[i]){q.sap.log.error("a content provider with ID '"+i+"' is already registered",null,f);return;}this._oContentProviderIndex[i]=s;q.sap.log.debug("ContentProvider '"+i+"' was registered",null,f);};h.prototype._ensureCompleteSite=function(p){if(p.groups){var G=p.groups;Object.keys(G).forEach(function(k){if(!G[k]){delete G[k];}else{if(!G[k].payload){G[k].payload={};}if(!G[k].payload.links){G[k].payload.links=[];}if(!G[k].payload.tiles){G[k].payload.tiles=[];}if(!G[k].payload.groups){G[k].payload.groups=[];}}});}return p;};h.prototype._ensureGroupsOrder=function(s){var G=O.get("site.payload.groupsOrder",s),o=s.groups,j,i=0;if(!G){return s;}while(i<G.length){j=G[i];if(!o[j]){G.splice(i,1);}else{i++;}}return s;};h.prototype.getPlugins=(function(){var D,E,p;E=function(s,o){var i,n=Object.keys(o).length;if(n===0){return{};}if(!o.hasOwnProperty("Shell-plugin")){q.sap.log.error("Cannot find inbound with id 'Shell-plugin' for plugin '"+s+"'","plugin startup configuration cannot be determined correctly",f);return{};}if(n>1){q.sap.log.warning("Multiple inbounds are defined for plugin '"+s+"'","plugin startup configuration will be determined using "+"the signature of 'Shell-plugin' inbound.",f);}i=O.get("signature.parameters",o["Shell-plugin"])||{};return Object.keys(i).reduce(function(r,N){var j=O.get(N+".defaultValue.value",i);if(typeof j==="string"){r[N]=j;}return r;},{});};D=function(o){Object.keys(o).filter(function(s){return typeof o[s]==="object";}).forEach(function(s){o[s]=D(o[s]);});return Object.freeze(o);};return function(o){if(o!==undefined){p=o;}if(p){return q.when(p);}p={};return this.getSite().then(function(s){var A=s.applications||{};Object.keys(A).filter(function(i){return O.get("type",this[i]["sap.flp"])==="plugin";},A).forEach(function(i){var j,k,m=this[i],n={};if(!a(m["sap.platform.runtime"])){q.sap.log.error("Cannot find 'sap.platform.runtime' section for plugin '"+i+"'","plugin might not be started correctly","sap.ushell.services.CommonDataModel");}else if(!a(m["sap.platform.runtime"].componentProperties)){q.sap.log.error("Cannot find 'sap.platform.runtime/componentProperties' "+"section for plugin '"+i+"'","plugin might not be started correctly","sap.ushell.services.CommonDataModel");}else{n=m["sap.platform.runtime"].componentProperties;}p[i]={url:n.url,component:m["sap.ui5"].componentName};var r=O.get("crossNavigation.inbounds",m["sap.app"])||{};k=E(i,r);j=q.extend(n.config||{},k);if(j){p[i].config=j;}if(n.asyncHints){p[i].asyncHints=n.asyncHints;}var t=O.get("deviceTypes",m["sap.ui"]);if(t){p[i].deviceTypes=t;}},A);return D(p);},function(v){return v;});};})();h.prototype._ensureStandardVizTypesPresent=function(s){if(!(s._version&&s._version.startsWith("3."))){return s;}if(!s.vizTypes){s.vizTypes={};}if(!s.vizTypes[g.STATIC_LAUNCHER]){s.vizTypes[g.STATIC_LAUNCHER]=q.sap.loadResource("sap/ushell/components/tiles/cdm/applauncher/manifest.json");}if(!s.vizTypes[g.DYNAMIC_LAUNCHER]){s.vizTypes[g.DYNAMIC_LAUNCHER]=q.sap.loadResource("sap/ushell/components/tiles/cdm/applauncherdynamic/manifest.json");}if(!s.vizTypes[g.CARD]){s.vizTypes[g.CARD]=q.sap.loadResource("sap/ushell/services/_CommonDataModel/vizTypeDefaults/cardManifest.json");}return s;};h.prototype.getMenuEntries=function(m){return new Promise(function(r,i){this._oSiteDeferred.then(function(s){var M=O.get("menus."+m+".payload.menuEntries",s);r(d(M)||[]);});}.bind(this));};h.hasNoAdapter=false;return h;},true);
