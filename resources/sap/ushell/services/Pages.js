// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ushell/utils/RestrictedJSONModel","sap/base/util/deepClone","sap/ushell/resources","sap/ushell/utils","sap/ushell/Config","sap/ushell/adapters/cdm/v3/utilsCdm","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils"],function(L,R,d,r,u,C,a,b){"use strict";var P=function(){this.COMPONENT_NAME="sap/ushell/services/Pages";this._oCdmServicePromise=sap.ushell.Container.getServiceAsync("CommonDataModel");if(!C.last("/core/spaces/vizInstantiation/enabled")){this._oVisualizationLoadingServicePromise=sap.ushell.Container.getServiceAsync("VisualizationLoading");}else{this._oVisualizationLoadingServicePromise=Promise.resolve();}this._oPagesModel=new R({pages:[]});};P.prototype._generateId=function(p){var i=[];var o=this.getModel().getProperty(this.getPagePath(p));o.sections.forEach(function(s){i.push(s.id);s.visualizations.forEach(function(v){i.push(v.id);});});return u.generateUniqueId(i);};P.prototype.getModel=function(){return this._oPagesModel;};P.prototype.getPageIndex=function(p){var c=this._oPagesModel.getProperty("/pages");for(var i=0;i<c.length;++i){if(c[i].id===p){return i;}}return undefined;};P.prototype.getPagePath=function(p){var i=this.getPageIndex(p);if(typeof i==="undefined"){return"";}return"/pages/"+i;};P.prototype.loadPage=function(p){var s=this.getPagePath(p);if(s){return Promise.resolve(s);}return Promise.all([this._oCdmServicePromise,this._oVisualizationLoadingServicePromise]).catch(function(e){L.error("Pages - loadPage: Couldn't resolve CDM Service or Visualization Loading Service.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(S){var c=S[0];var v=S[1];var e=[c.getPage(p),c.getVisualizations(),c.getApplications(),c.getVizTypes()];if(v){e.push(v.loadVisualizationData());}return Promise.all(e).then(function(f){var o=f[0];var V=f[1];var A=f[2];var g=f[3];return this._getModelForPage(o,V,A,g);}.bind(this)).then(function(m){var i=this._oPagesModel.getProperty("/pages/").length;var n="/pages/"+i;this._oPagesModel._setProperty(n,m);return n;}.bind(this)).catch(function(E){L.error("Pages - loadPage: Failed to gather site data.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this));}.bind(this));};P.prototype.findVisualization=function(p,s,v){return this._oCdmServicePromise.catch(function(e){L.error("Pages - findVisualization: Personalization cannot be saved: CDM Service cannot be retrieved.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(c){return Promise.all([this.loadPage(p),c.getVisualizations(),c.getApplications()]).then(function(e){var f=e[0];var g=this.getModel().getProperty(f+"/sections")||[];return g.reduce(function(h,i,j){if(s&&i.id!==s){return h;}var V=i.visualizations.reduce(function(k,l,m){if(l.vizId===v){k.push(m);}return k;},[]);if(V.length){h.push({pageId:p,sectionIndex:j,vizIndexes:V});}return h;},[]);}.bind(this)).catch(function(e){L.error("Pages - findVisualization: Couldn't load page, get visualizations or applications.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this));}.bind(this));};P.prototype.moveVisualization=function(p,s,S,t,T){if(s===t&&S===T){return Promise.resolve();}this.setPersonalizationActive(true);var o=this._oPagesModel.getProperty("/pages/"+p);var c=o.id;var e=o.sections[s];var f=o.sections[t];var g=e.id;var h=f.id;var m=e.visualizations[S];var M=m.id;e.visualizations.splice(S,1);if(T===-1){T=f.visualizations.length;}else if(s===t&&S<T){T--;}f.visualizations.splice(T,0,m);if(e.default&&!e.visualizations.length){o.sections.splice(s,1);}this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(i){return i.getPage(c);}).catch(function(E){L.error("Pages - moveVisualization: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(i){var j=i.payload.sections[g];var k=j.layout.vizOrder;var l=j.viz;var n=i.payload.sections[h];var q=n.layout.vizOrder;var v=n.viz;var w=d(l[M]);k.splice(k.indexOf(M),1);q.splice(T,0,M);if(g!==h){delete l[M];v[M]=w;}if(j.default&&!Object.keys(l).length){delete i.payload.sections[g];i.payload.layout.sectionOrder.splice(s,1);}return this.savePersonalization(c);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype.deleteVisualization=function(p,s,S){var o=this._oPagesModel.getProperty("/pages/"+p);var c=o.sections[s];if(c.default&&c.visualizations.length<2){return this.deleteSection(p,s);}this.setPersonalizationActive(true);var e=c.visualizations;var f=e[S];e.splice(S,1);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(g){return g.getPage(o.id);}).catch(function(E){L.error("Pages - deleteVisualization: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(g){var h=g.payload.sections[c.id].layout.vizOrder;var v=g.payload.sections[c.id].viz;Object.keys(v).forEach(function(V){if(v[V].vizId===f.vizId){delete v[V];h.splice(S,1);}});return this.savePersonalization(g.identification.id);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype._getSectionIndex=function(p,s){var S=this.getModel().getProperty(p+"/sections")||[],i=0;for(;i<S.length;i+=1){if(S[i].id===s){return i;}}};P.prototype._getVisualizationData=function(p,v,V,A,o,c,U){var e=A||{vizId:v};var s={applications:o,visualizations:V,vizTypes:c};var f=b.getVizData(s,e,U);if(!f.id){f.id=this._generateId(p);}return f;};P.prototype.addVisualization=function(p,s,v){return this._oCdmServicePromise.catch(function(e){L.error("Pages - addVisualization: Personalization cannot be saved: CDM Service cannot be retrieved.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(c){return Promise.all([this.loadPage(p),c.getVisualizations(),c.getApplications(),c.getVizTypes(),sap.ushell.Container.getServiceAsync("URLParsing")]).catch(function(e){L.error("Pages - addVisualization: Personalization cannot be saved: Failed to load page, get visualizations or get applications.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(e){var f=e[0],U=e[4],S=this._getSectionIndex(f,s),g=this.getModel().getProperty(f+"/sections")||[],V=this._getVisualizationData(p,v,e[1],null,e[2],e[3],U);var D;for(var i=0;i<g.length;i++){if(g[i].default){D=i;}}if(S!==undefined||D!==undefined){this.setPersonalizationActive(true);var h=S!==undefined?S:D||0,j=f+"/sections/"+h+"/visualizations";this.getModel().getProperty(j).push(V);this.getModel().refresh();return c.getPage(p).catch(function(E){L.error("Pages - addVisualization: Personalization cannot be saved: Failed to get page.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(o){var l=o.payload.sections[s||o.payload.layout.sectionOrder[0]];l.layout.vizOrder.push(V.id);l.viz[V.id]={id:V.id,vizId:v};return this.savePersonalization(p);}.bind(this));}var k=parseInt(f.split("/")[2],10);return this.addSection(k,0,{title:r.i18n.getText("DefaultSection.Title"),default:true,visualizations:[V]});}.bind(this));}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.prototype.moveSection=function(p,s,t){if(s===t){return Promise.resolve();}this.setPersonalizationActive(true);var c=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections");var m=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s);var M=m.id;S.splice(s,1);if(s<t){t--;}S.splice(t,0,m);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(o){return o.getPage(c);}).catch(function(e){L.error("Pages - moveSection: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(o){var e=o.payload.layout.sectionOrder;e.splice(e.indexOf(M),1);e.splice(t,0,M);return this.savePersonalization(c);}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.prototype.addSection=function(p,s,S){this.setPersonalizationActive(true);var o=S||{},c=this._oPagesModel.getProperty("/pages/"+p+"/sections"),e=this._oPagesModel.getProperty("/pages/"+p+"/id");var n={id:o.id!==undefined?o.id:this._generateId(e),title:o.title!==undefined?o.title:"",visible:o.visible!==undefined?o.visible:true,preset:o.preset!==undefined?o.preset:false,locked:o.locked!==undefined?o.locked:false,default:o.default!==undefined?o.default:false,visualizations:o.visualizations!==undefined?o.visualizations:[]};c.splice(s,0,n);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(f){return f.getPage(e);}).catch(function(E){L.error("Pages - addSection: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(f){var g={id:n.id,title:n.title,visible:n.visible,preset:n.preset,locked:n.locked,default:n.default,layout:{vizOrder:[]},viz:{}};if(n.visualizations){var i=0,v;for(;i<n.visualizations.length;i++){v=n.visualizations[i];g.layout.vizOrder.push(v.id);if(v.isBookmark){g.viz[v.id]=b.getVizRef(v);}else{g.viz[v.id]={id:v.id,vizId:v.vizId};}}}f.payload.layout.sectionOrder.splice(s,0,n.id);f.payload.sections[n.id]=g;return this.savePersonalization(e);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype.deleteSection=function(p,s){this.setPersonalizationActive(true);var c=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections");var e=S[s].id;S.splice(s,1);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(o){return o.getPage(c);}).catch(function(E){L.error("Pages - deleteSection: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(o){delete o.payload.sections[e];o.payload.layout.sectionOrder.splice(s,1);return this.savePersonalization(c);}.bind(this)).catch(function(E){this.setPersonalizationActive(false);return Promise.reject(E);}.bind(this));};P.prototype.setSectionVisibility=function(p,s,v){this.setPersonalizationActive(true);var c=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s+"/id");var o=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s);if(o.visible===v){return Promise.resolve();}o.visible=v;this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(e){return e.getPage(c);}).catch(function(e){L.error("Pages - setSectionVisibility: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(e){e.payload.sections[S].visible=v;return this.savePersonalization(c);}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.prototype.renameSection=function(p,s,n){this.setPersonalizationActive(true);var o=this._oPagesModel.getProperty("/pages/"+p);var S=o.sections[s];S.title=n;this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(c){return c.getPage(o.id);}).catch(function(e){L.error("Pages - renameSection: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(c){c.payload.sections[S.id].title=n;return this.savePersonalization(c.identification.id);}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.prototype.resetSection=function(p,s){this.setPersonalizationActive(true);var c=this._oPagesModel.getProperty("/pages/"+p+"/id");var S=this._oPagesModel.getProperty("/pages/"+p+"/sections/"+s+"/id");return this._oCdmServicePromise.then(function(o){return Promise.all([o.getVisualizations(),o.getApplications(),o.getPage(c),o.getOriginalPage(c),o.getVizTypes()]);}).catch(function(e){L.error("Pages - resetSection: Personalization cannot be saved: Failed to gather data from CDM Service.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(e){var v=e[0];var A=e[1];var o=e[2];var O=e[3];var V=e[4];return Promise.all([this._getModelForPage(O,v,A,V),o,O]);}.bind(this)).then(function(e){var o=e[0];var f=e[1];var O=e[2];var g=d(o.sections.find(function(j){return j.id===S;}),20);var h=g.visualizations.map(function(v){return v.id;});var i=this._oPagesModel.getProperty("/pages/"+p);i.sections.forEach(function(j){if(g.id!==j.id){j.visualizations.forEach(function(v){if(h.indexOf(v.id)!==-1){var n=this._generateId(c);var V=d(f.payload.sections[j.id].viz[v.id]);delete f.payload.sections[j.id].viz[v.id];var k=f.payload.sections[j.id].layout.vizOrder.indexOf(V.id);V.id=n;f.payload.sections[j.id].viz[n]=V;f.payload.sections[j.id].layout.vizOrder[k]=n;v.id=n;}}.bind(this));}}.bind(this));this._oPagesModel._setProperty("/pages/"+p+"/sections/"+s,g);f.payload.sections[g.id]=O.payload.sections[g.id];return this.savePersonalization(f.identification.id);}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.prototype.resetPage=function(p){this.setPersonalizationActive(true);var s=this._oPagesModel.getProperty("/pages/"+p+"/id");return this._oCdmServicePromise.then(function(c){return Promise.all([c.getVisualizations(),c.getApplications(),c.getPage(s),c.getOriginalPage(s),c.getVizTypes()]);}).catch(function(e){L.error("Pages - resetPage: Personalization cannot be saved: Failed to gather data from CDM Service.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(c){var v=c[0];var A=c[1];var o=c[2];var O=c[3];var V=c[4];return Promise.all([this._getModelForPage(O,v,A,V),o,O]);}.bind(this)).then(function(c){var o=c[0];var e=c[1];var O=c[2];this._oPagesModel._setProperty("/pages/"+p,o);e.payload=d(O.payload);return this.savePersonalization(e.identification.id);}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.prototype.setPersonalizationActive=function(s){if(!this._bDirtyState&&s===true){this._bDirtyState=true;this._oCopiedModelData=d(this._oPagesModel.getProperty("/"),20);}else if(this._bDirtyState&&s===false){this._oPagesModel._setData(this._oCopiedModelData);this._bDirtyState=false;}};P.prototype.savePersonalization=function(p){return this._oCdmServicePromise.then(function(c){return c.save(p);}).then(function(){this._bDirtyState=false;}.bind(this)).catch(function(e){L.error("Pages - savePersonalization: Personalization cannot be saved: CDM Service cannot be retrieved or the save process encountered an error.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this));};P.prototype._getModelForPage=function(p,v,c,e){return Promise.all([sap.ushell.Container.getServiceAsync("ClientSideTargetResolution"),sap.ushell.Container.getServiceAsync("URLParsing")]).catch(function(E){return Promise.reject(E);}).then(function(f){var o=f[0];var U=f[1];var g={id:p.identification.id||"",title:p.identification.title||"",description:"",sections:[]};var E=C.last("/core/catalog/enableHideGroups");return Promise.all(p.payload.layout.sectionOrder.map(function(s){var h=p.payload.sections[s];var S={id:h.id||"",title:h.default?r.i18n.getText("DefaultSection.Title"):h.title||"",visualizations:[],visible:!E||(h.visible!==undefined?h.visible:true),locked:h.locked!==undefined?h.locked:false,preset:h.preset!==undefined?h.preset:true,default:h.default!==undefined?h.default:false};g.sections.push(S);return Promise.all(h.layout.vizOrder.map(function(i){var V=h.viz[i],j=V.vizId,k=this._getVisualizationData(p.identification.id,j,v,V,c,e,U);S.visualizations.push(k);return this._isIntentSupported(k,o).then(function(I){if(!I){var l=S.visualizations.findIndex(function(m){return m.id===k.id;});S.visualizations.splice(l,1);L.warning("The visualization "+k.vizId+" is filtered out, because it does not have a supported intent.");}});}.bind(this)));}.bind(this))).then(function(){return g;});}.bind(this));};P.prototype._isIntentSupported=function(v,c){if(v.target===undefined){return Promise.resolve(false);}if(v.target.type==="URL"){return Promise.resolve(true);}return new Promise(function(e,f){c.isIntentSupported([v.targetURL]).then(function(s){e(s[v.targetURL].supported);}).fail(function(){e(false);});});};P.prototype.addBookmarkToPage=function(p,c){if(!p){return Promise.reject("Pages - addBookmarkToPage: Adding bookmark tile failed: No page id is provided.");}this.setPersonalizationActive(true);return this._oCdmServicePromise.then(function(o){return Promise.all([this.loadPage(p),sap.ushell.Container.getServiceAsync("URLParsing"),o.getVizTypes()]);}.bind(this)).catch(function(e){L.error("Pages - addBookmarkToPage: Personalization cannot be saved: Could not load page.",e,this.COMPONENT_NAME);return Promise.reject(e);}.bind(this)).then(function(e){var f=e[0];var U=e[1];var v=e[2];var V={id:this._generateId(p),title:c.title,subTitle:c.subtitle,icon:c.icon,info:c.info,target:a.toTargetFromHash(c.url,U),indicatorDataSource:{path:c.serviceUrl,refresh:c.serviceRefreshInterval},isBookmark:true};var o=this._getVisualizationData(p,undefined,{},V,{},v,U);var i=parseInt(/pages\/(\d+)/.exec(f)[1],10);var g=this._oPagesModel.getProperty(f);var D=g.sections.find(function(s){return s.default;});if(!D){return this.addSection(i,0,{title:r.i18n.getText("DefaultSection.Title"),default:true,visualizations:[o]});}D.visualizations.push(o);this._oPagesModel.refresh();return this._oCdmServicePromise.then(function(h){return h.getPage(p);}).catch(function(E){L.error("Pages - addBookmarkToPage: Personalization cannot be saved: CDM Service or Page cannot be retrieved.",E,this.COMPONENT_NAME);return Promise.reject(E);}.bind(this)).then(function(h){var s=h.payload.sections[D.id];s.layout.vizOrder.push(V.id);s.viz[V.id]=V;return this.savePersonalization(p);}.bind(this));}.bind(this)).catch(function(e){this.setPersonalizationActive(false);return Promise.reject(e);}.bind(this));};P.hasNoAdapter=true;return P;},true);
