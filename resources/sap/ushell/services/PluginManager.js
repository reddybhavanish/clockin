// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_PluginManager/Extensions","sap/base/Log","sap/ushell/EventHub","sap/ui/thirdparty/jquery","sap/base/util/UriParameters","sap/ushell/utils"],function(g,L,E,q,U,u){"use strict";var S="sap.ushell.services.PluginManager",a="sap-ushell-plugin-type",b="RendererExtensions",c="sap.ushell.components.shell.defaults",s=[b,"UserDefaults","UserImage","ContentProvider","AppWarmup"];function P(C,p,o){var t=this,d=[],f=false,l;this._oPluginCollection={};this._oCategoryLoadingProgress={};this._mInitializedComponentPromise={};this._sPluginAgentsNames="";this._oConfig=(o&&o.config)||{};if(this._oConfig.isBlueBox===undefined){this._oConfig.isBlueBox=false;}s.forEach(function(e){t._oPluginCollection[e]={};t._oCategoryLoadingProgress[e]=new q.Deferred();});this._handlePluginCreation=function(e,h,i){var t=this,j=(t._oPluginCollection[e])[h];try{if(j.hasOwnProperty("component")){if(t._mInitializedComponentPromise.hasOwnProperty(j.component)){t._mInitializedComponentPromise[j.component].then(function(){t._instantiateComponent(j,i);},function(){t._instantiateComponent(j,i);});}else{t._mInitializedComponentPromise[j.component]=t._instantiateComponent(j,i);}}else{q.sap.log.error("Invalid plugin configuration. The plugin "+h+" must contain a <component> key",S);}}catch(k){q.sap.log.error("Error while loading bootstrap plugin: "+j.component||"",S);if(i){i.reject(k);}}};this._getFileNameForXhrAuth=function(){return"Component-preload.js";};this._handleXhrAuthentication=function(A,e){var x;if(A&&["true",true,"X"].indexOf(A["sap-ushell-xhr-authentication"])>-1){if(!e){q.sap.log.error(["Illegal state: configuration parameter 'sap-ushell-xhr-authentication-timeout' set, but no component URL specified.","XHR authentication request will not be sent. Please check the target mapping definitions for plug-ins","and the application index."].join(" "),undefined,S);return q.when();}if(A.hasOwnProperty("sap-ushell-xhr-authentication-timeout")){x=parseInt(A["sap-ushell-xhr-authentication-timeout"],10);if(isNaN(x)){q.sap.log.error(["Invalid value for configuration parameter 'sap-ushell-xhr-authentication-timeout' for plug-in component with URL '",e,"': '",A["sap-ushell-xhr-authentication-timeout"],"' is not a number. Timeout will be ignored."].join(""),undefined,S);}else{sap.ushell.Container.setXhrLogonTimeout(e,x);}}return q.ajax(e+"/"+this._getFileNameForXhrAuth());}return q.when();};this._instantiateComponent=function(e,h){var D=new q.Deferred(),i=JSON.parse(JSON.stringify(e)),A={ui5ComponentName:i.component,url:i.url,getExtensions:g};function j(m){return function(n){m=m||"Cannot create UI5 plugin component: (componentId/appdescrId :"+A.ui5ComponentName+")\n"+n+" properties "+JSON.stringify(A)+"\n This indicates a plugin misconfiguration, see e.g. Note 2316443.";n=n||"";q.sap.log.error(m,n.stack,S);if(h){h.reject.apply(this,arguments);}D.reject.apply(this,arguments);};}function k(){sap.ushell.Container.getService("Ui5ComponentLoader").createComponent(A).done(function(m){if(e.config&&e.config["sap-component-agents"]){d.push({componentName:e.component,url:e.url,agents:e.config["sap-component-agents"],pluginComp:m});}if(h){h.resolve(m);}D.resolve.apply(this,arguments);}).fail(j());}i.name=i.component;delete i.component;A.applicationDependencies=i;if(i.config){A.applicationConfiguration=i.config;delete i.config;}A.loadDefaultDependencies=false;this._handleXhrAuthentication(A.applicationConfiguration,i.url).done(k).fail(j("XHR logon for FLP plugin failed"));return D.promise();};this.getSupportedPluginCategories=function(){return JSON.parse(JSON.stringify(s));};this.getRegisteredPlugins=function(){return JSON.parse(JSON.stringify(this._oPluginCollection));};this.registerPlugins=function(h){var t=this,i,j,k,m=[],n,r;if(!h){return;}u.addTime("PluginManager.registerPlugins");if(this._oConfig.isBlueBox===true){n=new U(window.location.href).get("sap-plugins");if(n&&n.length>0){n=","+n+",";}else{n=undefined;}}else{E.emit("pluginConfiguration",h);}Object.keys(h).sort().forEach(function(v){i=h[v]||{};j=i.config||{};k=j[a]||"";if(i.enabled===false){return;}if(!t._isFormFactorSupported(i)){L.info("Plugin '"+v+"' filtered from result: form factor not supported");return;}if(t._oConfig.isBlueBox===true){if(i.config&&i.config["sap-plugin-agent"]===true){r=(i.config["sap-plugin-agent-id"]||v);if(!t.isPluginAgentSupported(r)){if(n){if(n.indexOf(","+r+",")<0){return;}}else{return;}}}}if(i.enabled===undefined){i.enabled=true;}if(i.hasOwnProperty("module")){q.sap.log.error("Plugin "+v+" cannot get registered, because the module mechanism for plugins is not valid anymore. Plugins need to be defined as SAPUI5 components.",S);q.sap.require(i.module);return;}if(j&&j.hasOwnProperty(a)){if(s&&Array.prototype.indexOf.call(s,k)!==-1){if(m.indexOf(k)===-1){m.push(k);}t._oPluginCollection[k][v]=JSON.parse(JSON.stringify(i));}else{q.sap.log.warning("Plugin "+v+" will not be inserted into the plugin collection of the PluginManager, because of unsupported category "+k,S);}}else{t._oPluginCollection[b][v]=JSON.parse(JSON.stringify(i));if(m.indexOf(b)===-1){m.push(b);}}});try{if(t._oConfig.isBlueBox!==true){t._buildNamesOfPluginsWithAgents();}}catch(e){q.sap.log.error("failed to build plugin agents names list",(e.message||e.toString()),"sap.ushell.services.PluginManager");}m.forEach(function(v){if(t._oCategoryLoadingProgress.hasOwnProperty(v)&&t._oCategoryLoadingProgress[v].state()==="resolved"){t.loadPlugins(v);}});};this._isFormFactorSupported=function(e){var D=e.deviceTypes,h=u.getFormFactor();if(D&&D[h]===false){return false;}return true;};this.getPluginLoadingPromise=function(e){if(this._oCategoryLoadingProgress.hasOwnProperty(e)){return this._oCategoryLoadingProgress[e].promise();}};this.registerAgentLifeCycleManager=function(i){l=i;if(f){l(d);}};this.loadPlugins=function(e){var t=this,h,i,j;u.setPerformanceMark("FLP -- PluginManager.startLoadPlugins");u.addTime("PluginManager.startLoadPlugins["+e+"]");if(s&&Array.prototype.indexOf.call(s,e)!==-1){if(t._oCategoryLoadingProgress[e].pluginLoadingTriggered===undefined){t._oCategoryLoadingProgress[e].pluginLoadingTriggered=true;}if(Object.keys(t._oPluginCollection[e]).length>0){h=[];j=Object.keys(t._oPluginCollection[e]);if(new U(window.location.href).get("sap-ushell-xx-pluginmode")==="discard"&&e==="RendererExtensions"){j=j.filter(function(I){return(t._oPluginCollection[e][I].component===c);});}j.forEach(function(k){var m=t._oPluginCollection[e][k];if(!m.loaded){m.loaded=true;i=new q.Deferred();h.push(i.promise());t._handlePluginCreation(e,k,i);}});q.when.apply(undefined,h).done(function(){u.addTime("PluginManager.endLoadPlugins["+e+"]");u.setPerformanceMark("FLP -- PluginManager.endLoadPlugins");if(l){l(d);}f=true;t._oCategoryLoadingProgress[e].resolve();}).fail(t._oCategoryLoadingProgress[e].reject.bind());}else{t._oCategoryLoadingProgress[e].resolve();}}else{q.sap.log.error("Plugins with category "+e+" cannot be loaded by the PluginManager",S);t._oCategoryLoadingProgress[e].reject("Plugins with category "+e+" cannot be loaded by the PluginManager");}return t._oCategoryLoadingProgress[e].promise();};this._buildNamesOfPluginsWithAgents=function(){var t=this,n="",e;Object.keys(t._oPluginCollection).forEach(function(h){Object.keys(t._oPluginCollection[h]).forEach(function(i){e=t._oPluginCollection[h][i];if(e&&e.enabled&&e.enabled===true){if(e.config&&e.config["sap-plugin-agent"]===true){n+=(e.config["sap-plugin-agent-id"]||i)+",";}}});});if(n.endsWith(",")){n=n.slice(0,-1);}this._sPluginAgentsNames=n;};this._getNamesOfPluginsWithAgents=function(){return this._sPluginAgentsNames;};}P.hasNoAdapter=true;return P;},true);
