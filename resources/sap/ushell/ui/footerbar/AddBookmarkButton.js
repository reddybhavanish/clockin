// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/Button","sap/m/Dialog","sap/ui/layout/form/SimpleForm","sap/ushell/resources","sap/base/util/isEmptyObject","sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/model/json/JSONModel","sap/ui/core/library","sap/m/library","sap/ui/layout/library","sap/ui/Device","sap/ushell/Config","./AddBookmarkButtonRenderer"],function(B,D,S,r,i,q,L,J,c,m,l,a,C){"use strict";var b=m.ButtonType;var V=c.ValueState;var d=l.form.SimpleFormLayout;var e=c.mvc.ViewType;var A=B.extend("sap.ushell.ui.footerbar.AddBookmarkButton",{metadata:{library:"sap.ushell",properties:{beforePressHandler:{type:"any",group:"Misc",defaultValue:null},afterPressHandler:{type:"any",group:"Misc",defaultValue:null},title:{type:"string",group:"Misc",defaultValue:null},subtitle:{type:"string",group:"Misc",defaultValue:null},info:{type:"string",group:"Misc",defaultValue:null},tileIcon:{type:"string",group:"Misc",defaultValue:null},numberUnit:{type:"string",group:"Misc",defaultValue:null},keywords:{type:"string",group:"Misc",defaultValue:null},customUrl:{type:"any",group:"Misc",defaultValue:null},serviceUrl:{type:"any",group:"Misc",defaultValue:null},serviceRefreshInterval:{type:"string",group:"Misc",defaultValue:null},showGroupSelection:{type:"boolean",group:"Misc",defaultValue:true},showPageSelection:{type:"boolean",group:"Misc",defaultValue:true},appData:{type:"object",group:"Misc",defaultValue:null}}}});A.prototype.init=function(){this.setIcon("sap-icon://add-favorite");this.setText(r.i18n.getText("addToHomePageBtn"));this.setEnabled();this.bSpaceEnabled=C.last("/core/spaces/enabled");this.oModel=new J({showGroupSelection:true,showPageSelection:true,title:"",subtitle:"",numberValue:"",info:"",icon:"",numberUnit:"",keywords:""});var t=this;this.attachPress(function(){if(t.getBeforePressHandler()){t.getBeforePressHandler()();}t.showAddBookmarkDialog(function(){if(t.getAfterPressHandler()){t.getAfterPressHandler()();}});});if(B.prototype.init){B.prototype.init.apply(this,arguments);}};A.prototype.exit=function(){if(this.oDialog){this.oDialog.destroy();}if(this.oModel){this.oModel.destroy();}if(B.prototype.exit){B.prototype.exit.apply(this,arguments);}};A.prototype.setBookmarkTileView=function(v){this.bookmarkTileView=v;};A.prototype.getBookmarkTileView=function(){return this.bookmarkTileView;};A.prototype.showAddBookmarkDialog=function(f){this.oResourceBundle=r.i18n;this.appData=this.getAppData()||{};var t=this;var I;var s;this.cb=f;I=i(this.appData);var v={appData:this.appData,serviceUrl:I?this.getServiceUrl():this.appData.serviceUrl,customUrl:I?this.getCustomUrl():this.appData.customUrl,numberUnit:I?this.getNumberUnit():this.appData.numberUnit,serviceRefreshInterval:I?this.getServiceRefreshInterval():this.appData.serviceRefreshInterval,keywords:I?this.getKeywords():this.appData.keywords};if(this.bSpaceEnabled){s=sap.ui.view({type:e.XML,viewName:"sap.ushell.ui.bookmark.SaveOnPage",viewData:v});s.getController().byId("bookmarkTitleInput").attachLiveChange(function(){this.setValueState(V.NONE);});}else{s=sap.ui.view({type:e.JS,viewName:"sap.ushell.ui.footerbar.SaveAsTile",viewData:v});s.getTitleInput().attachLiveChange(function(){this.setValueState(V.NONE);});}if(i(this.appData)){s.setModel(this.oModel);}t.setBookmarkTileView(s);this.oSimpleForm=new S({id:"bookmarkFormId",layout:d.ResponsiveGridLayout,content:[s],editable:true}).addStyleClass("sapUshellAddBookmarkForm");t._openDialog(this.oSimpleForm);};A.prototype._openDialog=function(o){var f=new B("bookmarkOkBtn",{text:this.oResourceBundle.getText("okBtn"),type:b.Emphasized,press:this._handleOkButtonPress.bind(this)}),g=new B("bookmarkCancelBtn",{text:this.oResourceBundle.getText("cancelBtn"),press:function(){this.oDialog.close();this._restoreDialogEditableValuesToDefault();this.cb();}.bind(this)});this.oDialog=new D({id:"bookmarkDialog",title:this.oResourceBundle.getText("addToHomePageBtn"),contentWidth:"25rem",content:o,beginButton:f,endButton:g,stretch:a.system.phone,horizontalScrolling:false,afterClose:function(){this.oDialog.destroy();delete(this.oDialog);}.bind(this)}).addStyleClass("sapContrastPlus");this.oDialog.open();return this.oDialog;};A.prototype.setTitle=function(t){this.setProperty("title",t,true);this.oModel.setProperty("/title",t);};A.prototype.setSubtitle=function(s){this.setProperty("subtitle",s,true);this.oModel.setProperty("/subtitle",s);};A.prototype.setInfo=function(I){this.setProperty("info",I,true);this.oModel.setProperty("/info",I);};A.prototype.setTileIcon=function(I){this.setProperty("tileIcon",I,true);this.oModel.setProperty("/icon",I);};A.prototype.setShowGroupSelection=function(s){this.setProperty("showGroupSelection",s,true);this.oModel.setProperty("/showGroupSelection",s);};A.prototype.setNumberUnit=function(n){this.setProperty("numberUnit",n,true);this.oModel.setProperty("/numberUnit",n);};A.prototype.setKeywords=function(k){this.setProperty("keywords",k,true);this.oModel.setProperty("/keywords",k);};A.prototype._restoreDialogEditableValuesToDefault=function(){if(this.oModel){this.oModel.setProperty("/title",this.getTitle());this.oModel.setProperty("/subtitle",this.getSubtitle());this.oModel.setProperty("/info",this.getInfo());}};A.prototype._handleOkButtonPress=function(){var t,R,f=this.getBookmarkTileView(),o=this.bSpaceEnabled?f.getController().getBookmarkTileData():f.getBookmarkTileData();if(!o.title||o.title.length<1){t=this.bSpaceEnabled?f.getController().byId("bookmarkTitleInput"):f.getTitleInput();if(t){t.setValueState(V.Error);t.setValueStateText(r.i18n.getText("bookmarkTitleInputError"));return;}}if(this.bSpaceEnabled){var g=o.pages;delete o.pages;var h=[];g.forEach(function(p){h.push(new Promise(function(n,u){sap.ushell.Container.getService("Bookmark").addBookmarkToPage(o,p).then(n,u);}));});var j=0;var s=h.map(function(n){return n.then(function(){j++;},function(){});});Promise.all(s).then(function(n){if(sap.ushell.Container){if(j===1){sap.ushell.Container.getService("Message").info(r.i18n.getText("tile_created_msg"));}else if(j>1){sap.ushell.Container.getService("Message").info(r.i18n.getText("tiles_created_msg"));}else{sap.ushell.Container.getService("Message").info(r.i18n.getText("no_tile_created_msg"));}if(j!==n.length){L.error("Failed to add one or more bookmarks","","sap.ushell.ui.footerbar.AddBookmarkButton");}}this._restoreDialogEditableValuesToDefault();}.bind(this)).catch(function(M){L.error("Failed to add one or more bookmarks",M,"sap.ushell.ui.footerbar.AddBookmarkButton");});}else{delete o.group;var k=o.group?o.group.object:"";R=sap.ushell.Container.getService("Bookmark").addBookmark(o,k);R.done(function(){q.proxy(this._restoreDialogEditableValuesToDefault(),this);if(sap.ushell.Container){sap.ushell.Container.getService("Message").info(r.i18n.getText("tile_created_msg"));}}.bind(this));R.fail(function(M){L.error("Failed to add bookmark",M,"sap.ushell.ui.footerbar.AddBookmarkButton");if(sap.ushell.Container){sap.ushell.Container.getService("Message").error(r.i18n.getText("fail_to_add_tile_msg"));}});}this.oDialog.close();this.cb();};A.prototype.setEnabled=function(E){var s="",p=true,o;if(sap.ushell.renderers&&sap.ushell.renderers.fiori2){o=sap.ushell.renderers.fiori2.RendererExtensions.getConfiguration();if(o.appState){s=o.appState;}if(o.enablePersonalization!==undefined){p=o.enablePersonalization;}}if(s==="headerless"||s==="standalone"||s==="embedded"||s==="merged"||!p){E=false;}if(!sap.ushell.Container){if(this.getEnabled()){L.warning("Disabling 'Save as Tile' button: unified shell container not initialized",null,"sap.ushell.ui.footerbar.AddBookmarkButton");}E=false;}B.prototype.setEnabled.call(this,E);if(!E){this.addStyleClass("sapUshellAddBookmarkButton");}};return A;});
