// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/library","sap/m/Button","sap/m/Dialog","sap/m/Bar","sap/m/Text","sap/m/List","sap/ushell/resources","sap/ushell/ui/launchpad/AccessibilityCustomData","sap/ushell/ui/launchpad/ActionItem","sap/m/DisplayListItem","sap/ui/layout/VerticalLayout","sap/m/ObjectIdentifier","sap/ushell/EventHub","sap/ushell/Config","sap/ui/model/json/JSONModel","sap/ushell/ui/utils","sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/Device","sap/ui/core/IconPool","./UserPreferencesButtonRenderer"],function(m,B,D,a,T,L,r,A,b,c,V,O,E,C,J,u,q,d,f,I){"use strict";var g=m.ButtonType;var U=b.extend("sap.ushell.ui.footerbar.UserPreferencesButton",{metadata:{library:"sap.ushell"}});U.prototype.init=function(){if(b.prototype.init){b.prototype.init.apply(this,arguments);}this.setIcon("sap-icon://person-placeholder");this.translationBundle=r.i18n;this.setText(this.translationBundle.getText("userSettings"));this.setTooltip(this.translationBundle.getText("settings_tooltip"));this.attachPress(this.showUserPreferencesDialog);this.oModel=C.createModel("/core/userPreferences",J);this.setModel(this.oModel);};U.prototype.createDialog=function(){var t=this;this.saveButton=this._createSaveButton();this.cancelButton=this._createCancelButton();this.oDialog=new D({id:"userPreferencesDialog",title:"{/dialogTitle}",contentWidth:"29.6rem",content:null,contentHeight:"17rem",buttons:[this.saveButton,this.cancelButton],afterClose:function(){this._destroyDialog();this.oUser.resetChangedProperties();}.bind(t),stretch:f.system.phone}).addStyleClass("sapUshellUserPreferencesDialog").addStyleClass("sapContrastPlus");this._addDialogBackButton();this.oDialog.setModel(this.getModel());this.oDialog.addCustomData(new A({key:"aria-label",value:t.translationBundle.getText("Settings_Dialog_Main_label"),writeToDom:true}));this.oDialog.addContent(this._getOriginalDialogContent());};U.prototype._getOriginalDialogContent=function(){if(!this.oInitialContent){var o,e;o=this._getUserDetailsControl();e=this._getEntryListControl();this.oInitialContent=new V("userPreferencesLayout",{content:[o,e],width:"100%"});}return this.oInitialContent;};U.prototype._getEntryListControl=function(){var e=this._getUserPrefEntriesTemplate(),x=this.getModel()&&this.getModel().getProperty("/enableHelp"),t=this,i,s=this.oUser.getFullName(),o,h=new L("userPrefEnteryList",{items:{path:"/entries",template:e}});h.addCustomData(new A({key:"aria-label",value:t.translationBundle.getText("Settings_EntryList_label")+s,writeToDom:true}));o=h.onAfterRendering;h.onAfterRendering=function(){var j=this.getItems(),k;o.apply(this,arguments);for(i=0;i<j.length;i++){k=j[i].getBindingContext().getPath();if(!t.getModel().getProperty(k+"/valueResult")){t._setEntryValueResult(k);}if(x){t._addXRayHelpId(k,j[i]);}}};return h;};U.prototype._addXRayHelpId=function(e,l){var h=this.getModel().getProperty(e+"/entryHelpID");if(h){l.addStyleClass("help-id-"+h);}};U.prototype._setEntryValueResult=function(e){var t=this,i=this.getModel().getProperty(e+"/editable"),v=this.getModel().getProperty(e+"/valueArgument");if(typeof v==="function"){this.getModel().setProperty(e+"/valueResult",this.translationBundle.getText("genericLoading"));this.getModel().setProperty(e+"/editable",false);var o=v();o.done(function(h){t.getModel().setProperty(e+"/editable",i);t.getModel().setProperty(e+"/visible",typeof(h)==="object"?!!h.value:true);t.getModel().setProperty(e+"/valueResult",typeof(h)==="object"?h.displayText:h);});o.fail(function(){t.getModel().setProperty(e+"/valueResult",t.translationBundle.getText("loadingErrorMessage"));});}else if(v){this.getModel().setProperty(e+"/valueResult",v);this.getModel().setProperty(e+"/editable",i);}else{this.getModel().setProperty(e+"/valueResult",this.translationBundle.getText("loadingErrorMessage"));}};U.prototype._emitEntryOpened=function(e){var o=E.last("UserSettingsOpened")||{},p=e.split("/").pop();o[p]=true;E.emit("UserSettingsOpened",o);};U.prototype._getUserPrefEntriesTemplate=function(){var t=this,i,p=function(e){var o={};o=q.extend(true,{},{},e);sap.ui.require(["sap/m/FlexBox","sap/m/FlexAlignItems","sap/m/FlexJustifyContent","sap/m/BusyIndicator"],function(F,h,j,k){var l=true,n,s,v=o.getSource().getLabel(),w=o.getSource().getBindingContext().getPath();t.getModel().setProperty("/activeEntryPath",w);t._setDetailedEntryModeMode(true,w,v,w);t.oDialog.removeAllContent();s=t.getModel().getProperty(w+"/contentResult");if(s){n=sap.ui.getCore().byId(s);t.oDialog.addContent(n);t._emitEntryOpened(w);}else{var x=null,y,S=true,z=false,G=t.getModel().getProperty(w+"/contentFunc");if(typeof G==="function"){t._emitEntryOpened(w);y=G();y.done(function(H){S=false;if(z===true){t.oDialog.removeAllContent();x.destroy();}if(H instanceof sap.ui.core.Control){t.getModel().setProperty(w+"/contentResult",H.getId());t.oDialog.addContent(H);}else{l=false;}});y.fail(function(){S=false;if(z===true){t.oDialog.removeAllContent();x.destroy();}l=false;});y.always(function(){if(l===false){var H=new F("userPrefErrorFlexBox",{height:"5rem",alignItems:h.Center,justifyContent:j.Center,items:[new T("userPrefErrorText",{text:t.translationBundle.getText("loadingErrorMessage")})]});t.getModel().setProperty(w+"/contentResult",H.getId());t.oDialog.addContent(H);}});if(S===true){x=new k("userPrefLoadingBusyIndicator",{size:"2rem"});t.oDialog.addContent(x);z=true;}}}});};i=new c({label:"{title}",value:"{valueResult}",tooltip:{path:"valueResult",formatter:function(v){return typeof(v)==="string"?v:"";}},type:{path:"editable",formatter:function(e){return(e===true)?"Navigation":"Inactive";}},visible:{path:"visible",formatter:function(v){return(v!==undefined)?v:true;}},press:p,customData:new A({key:"aria-label",value:{parts:[{path:"title"},{path:"valueResult"}],formatter:function(s,v){v=v||"";return s+" "+v;}},writeToDom:true})});return i;};U.prototype._getUserDetailsControl=function(){return new O({title:this.oUser.getFullName(),text:this.oUser.getEmail()}).addStyleClass("sapUshellUserPrefUserIdentifier");};U.prototype._createCancelButton=function(){var t=this;return new B({id:"cancelButton",text:{parts:["/entries"],formatter:function(e){if(!e){return"";}var h=e.some(function(o){return o.editable;});return h>0?t.translationBundle.getText("cancelBtn"):t.translationBundle.getText("close");}},press:t._dialogCancelButtonHandler.bind(t),visible:true});};U.prototype._createSaveButton=function(){var t=this;return new B({id:"saveButton",text:this.translationBundle.getText("saveBtn"),type:g.Emphasized,press:t._dialogSaveButtonHandler.bind(t),visible:{parts:["/entries"],formatter:function(e){if(!e){return false;}return e.some(function(o){return o.editable;});}}});};U.prototype._setDetailedEntryModeMode=function(i,e,h,j){this.getModel().setProperty("/isDetailedEntryMode",!!i);this.getModel().setProperty("/dialogTitle",h);};U.prototype.showUserPreferencesDialog=function(){this.oUser=sap.ushell.Container.getUser();this.createDialog();this.oDialog.open();};U.prototype._dialogBackButtonHandler=function(){var t=this;t.getModel().setProperty("/isDetailedEntryMode",false);t.getModel().setProperty("/dialogTitle",t.translationBundle.getText("userSettings"));t.oDialog.removeAllContent();t.oDialog.addContent(t._getOriginalDialogContent());t._setEntryValueResult(t.getModel().getProperty("/activeEntryPath"));t.getModel().setProperty("/activeEntryPath",null);};U.prototype._destroyDialog=function(){this.oHeadBar.destroy();this.oInitialContent.destroy();this.oInitialContent=null;this._modelCleanUpToInitial();this._entriesCleanUp();this.oDialog.destroy();this.saveButton.destroy();this.cancelButton.destroy();};U.prototype._entriesCleanUp=function(){var i,e=this.getModel().getProperty("/entries"),s,o;for(i=0;i<e.length;i++){s=e[i].contentResult;delete e[i].contentResult;if(s){o=sap.ui.getCore().byId(s);o.destroy();o=null;}e[i].valueResult=null;}this.getModel().setProperty("/entries",e);};U.prototype._modelCleanUpToInitial=function(){this.getModel().setProperty("/isDetailedEntryMode",false);this.getModel().setProperty("/dialogTitle",this.translationBundle.getText("userSettings"));};U.prototype._dialogSaveButtonHandler=function(){var t=this,i,e=this.getModel().getProperty("/entries"),s=u.saveUserPreferenceEntries(e);i=this.getModel().getProperty("/isDetailedEntryMode");if(i){this.getModel().setProperty("/activeEntryPath",null);}s.done(function(){t._showSaveMessageToast();});s.fail(function(h){sap.ui.require(["sap/m/MessageBox"],function(M){var j,k="";if(h.length===1){j=t.translationBundle.getText("savingEntryError")+" ";}else{j=t.translationBundle.getText("savingEntriesError")+"\n";}h.forEach(function(l){j+=l.entry+"\n";k+="Entry: "+l.entry+" - Error message: "+l.message+"\n";});M.show(j,{icon:M.Icon.ERROR,title:t.translationBundle.getText("Error"),actions:[M.Action.OK]});d.error("Failed to save the following entries",k,"sap.ushell.ui.footerbar.UserPreferencesButton");});});this.oDialog.close();this._destroyDialog();};U.prototype._dialogCancelButtonHandler=function(){var i,e=this.getModel().getProperty("/entries");for(i=0;i<e.length;i++){if(e[i]&&e[i].onCancel){e[i].onCancel();}}this.oDialog.close();this._destroyDialog();};U.prototype._addDialogBackButton=function(){var t=this,o=new B("userPrefBackBtn",{visible:"{/isDetailedEntryMode}",icon:I.getIconURI("nav-back"),press:t._dialogBackButtonHandler.bind(t),tooltip:this.translationBundle.getText("feedbackGoBackBtn_tooltip")}),e=new T("userPrefTitle",{text:"{/dialogTitle}"});this.oHeadBar=new a({contentLeft:[o],contentMiddle:[e]});this.oDialog.setCustomHeader(this.oHeadBar);};U.prototype._showSaveMessageToast=function(){var t=this;sap.ui.require(["sap/m/MessageToast"],function(M){var e=t.translationBundle.getText("savedChanges");M.show(e,{duration:3000,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"});});};return U;});
