// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/ObjectPath","sap/ui/model/odata/v2/ODataModel","sap/ushell/resources"],function(O,a,r){"use strict";function g(){var s=(window["sap-ushell-config"].services&&window["sap-ushell-config"].services.PagePersistence)||{};return(O.get("config.serviceUrl",s.adapter)||"").replace(/\/?$/,"/");}var o=new a({serviceUrl:g(),headers:{"sap-language":sap.ushell.Container.getUser().getLanguage(),"sap-client":sap.ushell.Container.getLogonSystem().getClient()},defaultCountMode:"None",skipMetadataAnnotationParsing:true,useBatch:false});var m=new Promise(function(b,c){o.attachMetadataLoaded(b);o.attachMetadataFailed(c);});var P=function(){this.S_COMPONENT_NAME="sap.ushell_abap.adapters.abap.PagePersistenceAdapter";};P.prototype.getODataModel=function(){return o;};P.prototype.getMetadataPromise=function(){return m;};P.prototype.getPage=function(p){return this._readPage(p).then(this._convertODataToReferencePage).catch(this._rejectWithError.bind(this));};P.prototype.getPages=function(p){return this._readPages(p).then(function(b){return b.results.map(this._convertODataToReferencePage);}.bind(this)).catch(this._rejectWithError.bind(this));};P.prototype._readPage=function(p){return this.getMetadataPromise().then(function(){return new Promise(function(b,c){this.getODataModel().read("/pageSet('"+encodeURIComponent(p)+"')",{urlParameters:{"$expand":"sections/viz"},success:b,error:c});}.bind(this));}.bind(this));};P.prototype._readPages=function(p){return this.getMetadataPromise().then(function(){return new Promise(function(b,c){sap.ui.require(["sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(F,d){var e=[],f;for(var i=0;i<p.length;i++){f=new F({path:"id",operator:d.EQ,value1:p[i],and:false});e.push(f);}this.getODataModel().read("/pageSet",{urlParameters:{"$expand":"sections/viz"},filters:e,success:b,error:c});}.bind(this));}.bind(this));}.bind(this));};P.prototype._convertODataToReferencePage=function(p){return{id:p.id,title:p.title,description:p.description,createdBy:p.createdBy,createdByFullname:p.createdByFullname||p.createdBy,modifiedBy:p.modifiedBy,modifiedByFullname:p.modifiedByFullname||p.modifiedBy,sections:p.sections.results.map(function(s){return{id:s.id,sectionIndex:s.sectionIndex,title:s.title,viz:s.viz.results.map(function(v){return{catalogTileId:v.catalogTileId,id:v.id,itemIndex:v.itemIndex,targetMappingId:v.targetMappingId,vizId:v.catalogTileId,inboundPermanentKey:v.targetMappingId};}).sort(function(f,b){return f.itemIndex-b.itemIndex;})};}).sort(function(f,s){return f.sectionIndex-s.sectionIndex;})};};P.prototype._rejectWithError=function(e){var E={component:this.S_COMPONENT_NAME,description:r.i18n.getText("PagePersistenceAdapter.CannotLoadPage"),detail:e};return Promise.reject(E);};return P;},true);
