// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/bootstrap/common/common.boot.path","sap/ushell/bootstrap/common/common.load.xhrlogon","sap/ushell/utils","./abap.bootstrap.utils","./abap.request.server.config","./abap.request.startup","./abap.request.pageset","./abap.request.catalog","./abap.xhr.handler","./abap.theme.handler","sap/ushell/EventHub","sap/ushell/services/Container","sap/ui/Device","sap/ui2/srvc/utils"],function(b,x,u,a,r,s,p,c,X,t,E){"use strict";var B={};sap.ushell_abap=sap.ushell_abap||{};sap.ushell_abap.bootstrap=sap.ushell_abap.bootstrap||{};sap.ushell_abap.getShellType=function(){return u.hasNativeNavigationCapability()?"NWBC":"FLP";};sap.ushell_abap.bootstrap.addPostParametersToNavTargetResultUrl=function(P,U){if(P){U+=(U.indexOf("?")<0)?"?":"&";U+=P;}return U;};sap.ushell_abap.bootstrap.adjustNavTargetResult=function(R){if(R){var U=R.url,e,L={applicationType:R.applicationType,additionalInformation:R.applicationData},M,N,O,P;if(R.text){L.text=R.text;}if((R.applicationType==="URL"||R.applicationType==="SAPUI5")){N=/^SAPUI5\.Component=(.*)/.exec(R.applicationData);M=N&&N[1];if(M||R.applicationDependencies){if(M){L.ui5ComponentName=M;}if(R.applicationDependencies){try{O=JSON.parse(R.applicationDependencies);P=O.self;if(!L.ui5ComponentName&&P.name){L.ui5ComponentName=P.name;L.additionalInformation="SAPUI5.Component="+L.ui5ComponentName;}if(P&&P.url&&typeof P.url==="string"){var Q=sap.ui.require("sap/ui/thirdparty/URI");e=U&&new Q(U);if(e){if(P.url.toUpperCase().indexOf(e.path().toUpperCase())!==0){sap.ui2.srvc.log.debug("Component URL defined in target mapping "+"does not match the URL retrieved from application index. "+"The URL of the application index is used for further processing.","Target mapping URL: "+R.url+"\nApplication index URL: "+P.url,"sap.ushell_abap.bootstrap.abap");}e.path(P.url);U=e.toString();jQuery.sap.log.debug("ResolveLink result's component url has been replaced with the url specified "+"in Application Dependencies, which includes cache buster token");}else{U=P.url;}}L.applicationDependencies=O;}catch(T){sap.ui2.srvc.log.error("Parsing of applicationDependencies attribute in resolveLink result failed for SAPUI5 component '"+M+"'",T,"sap.ushell_abap.bootstrap.abap");}}U=sap.ui2.srvc.addCacheBusterTokenUsingUshellConfig(U);}}L.url=U;return L;}};var d=new RegExp("^(#)?([A-Za-z0-9_]+)-([A-Za-z0-9_]+)"),S,o;function i(e){function L(e){if(!e){return false;}return(e.indexOf("Shell-runStandaloneApp")===0)||(e.indexOf("Shell-home")===0)||(e.indexOf("Launchpad-openFLPPage")===0)||(e.indexOf("Shell-appfinder")===0)||(e.indexOf("Shell-catalog")===0)||(e.indexOf("shell-catalog")===0)||(e.indexOf("Action-search")===0);}function M(){return window["sap-ushell_abap-bootstrap-abap-noInitialTarget"]!==undefined;}var N=e.match(d);var O=N&&N[2];var P=N&&N[3];var Q=e&&!L(e)&&!M()&&O&&P;return Q;}function g(){var e,L=a.getLocationHref(),M=L.indexOf("#");if(M<0){return"";}e=decodeURI(L.slice(M+1));return e;}function f(){var e=g(),L=e.indexOf("&/");return L<0?e:e.slice(0,L);}function h(e){var M=e.match(d);return M?{semanticObject:M[2],action:M[3]}:undefined;}function j(e){if(!e||e==="#"){return true;}return(e.indexOf("Shell-home")===0)||(e.indexOf("Launchpad-openFLPPage")===0)||(e.indexOf("Shell-appfinder")===0)||(e.indexOf("Shell-catalog")===0)||(e.indexOf("shell-catalog")===0);}function k(O){if(O===undefined){return undefined;}try{return JSON.parse(JSON.stringify(O));}catch(e){sap.ui2.srvc.log.error("Could not clone object",null,"sap.ushell_abap.bootstrap");return undefined;}}function l(T){return T.indexOf("sap_")===0;}function m(e,L){var M=sap.ui.getCore(),N=M.getConfiguration(),O=N.getFormatSettings();u.addTime("setSapui5Settings");jQuery.sap.log.debug("setSapui5Settings()",JSON.stringify(e),"sap.ushell_abap.bootstrap.abap");if(e.language){N.setLanguage(e.language,e.ABAPLanguage);}if(e.legacyDateFormat){O.setLegacyDateFormat(e.legacyDateFormat);}if(e.legacyDateCalendarCustomizing){O.setLegacyDateCalendarCustomizing(e.legacyDateCalendarCustomizing);}if(e.legacyNumberFormat){O.setLegacyNumberFormat(e.legacyNumberFormat);}if(e.legacyTimeFormat){O.setLegacyTimeFormat(e.legacyTimeFormat);}if(typeof L==="object"){O.addCustomCurrencies(L);}}sap.ui2.srvc.testPublishAt(sap.ushell_abap.bootstrap);function n(e){jQuery.sap.getObject("sap-ushell-config.services.Container.adapter.config",0).bootTheme=k(e);}sap.ui2.srvc.testPublishAt(sap.ushell_abap.bootstrap);function q(e){if(!e){sap.ui2.srvc.log.error("extractSystemThemeRoot: mandatory parameter oStartupServiceResult not supplied");}if(e.themeRoot){return e.themeRoot;}if(e.client){sap.ui2.srvc.log.warning("Theme root was not contained in startup service result. A fallback to /sap/public/bc/themes/~client-<client number> is used",null,"sap.ushell_abap.bootstrap");return"/sap/public/bc/themes/~client-"+e.client;}sap.ui2.srvc.log.error("extractSystemThemeRoot: Could not determine system theme root");}sap.ui2.srvc.testPublishAt(sap.ushell_abap.bootstrap);function v(e){var P,T;if(e&&e.userProfile){P=e.userProfile.filter(function(L){return L.id==="THEME";});T=P.length?P[0]:{};if(T.value){return T.value;}}if(e&&e.theme){return e.theme;}return"";}sap.ui2.srvc.testPublishAt(sap.ushell_abap.bootstrap);function w(T,S){if(T&&l(T)){return"";}return S;}sap.ui2.srvc.testPublishAt(sap.ushell_abap.bootstrap);function y(e,S){var T;T=v(e);return{theme:T,root:w(T,S)};}sap.ui2.srvc.testPublishAt(sap.ushell_abap.bootstrap);function z(S){var T,e;T=a.getUrlParameterValue("sap-theme");if(T){if(T.indexOf("@")>0){e=T.split("@",2);return{theme:e[0],root:e[1]};}return{theme:T,root:w(T,S)};}return undefined;}function A(){var U=sap.ui2.srvc.getParameterMap()["sap-theme"]&&sap.ui2.srvc.getParameterMap()["sap-theme"][0];if(U){return U;}return undefined;}function C(e){var T=e;var L=e.indexOf("@");if(L>=0){var M=T.slice(L+1);return t.isThemeRootSafe(M);}return true;}function D(o,S){var U,e={},L,M=A();u.addTime("applyTheme");if(M&&C(M)){U=z(S);L=U;sap.ui2.srvc.log.debug("theme: URL theme = '"+L.theme+"' theme root = '"+L.root+"'",null,"sap.ushell_abap.bootstrap");if(L.root){sap.ui.getCore().setThemeRoot(L.theme,L.root.replace(/\/?$/,"/UI5/"));}}else if(o){L=o;sap.ui2.srvc.log.debug("theme: startup service theme = '"+L.theme+"' theme root = '"+L.root+"'",null,"sap.ushell_abap.bootstrap");if(L.root){sap.ui.getCore().applyTheme(L.theme,L.root+"/UI5/");}else{sap.ui.getCore().applyTheme(L.theme);}}else{e.theme=jQuery.sap.getObject("sap-ui-config.theme");if(e.theme){e.root=jQuery.sap.getObject("sap-ui-config.themeRoots."+e.theme||"");if(!e.root){e.root=w(e.theme,S);}L={theme:e.theme,root:e.root};sap.ui2.srvc.log.debug("theme: html file theme = '"+L.theme+"' theme root = '"+L.root+"'",null,"sap.ushell_abap.bootstrap");}else{L={theme:"",root:""};sap.ui2.srvc.log.error("Could not determine theme",null,"sap.ushell_abap.bootstrap");}}n(L);return L;}function F(e){var P=sap.ui2.srvc.getParameterMap(),R=a.getUrlParameterValue("sap-locale",P),U={},L;L=jQuery.sap.getObject("sap-ushell-config.services.SupportTicket.config",0);if(L.enabled!==false){L.enabled=(e.isEmbReportingActive===true);}L=jQuery.sap.getObject("sap-ushell-config.services.ClientSideTargetResolution.adapter.config.services",0);L.targetMappings=e.services&&e.services.targetMappings;L=jQuery.sap.getObject("sap-ushell-config.services.LaunchPage.adapter.config.services",0);L.targetMappings=e.services&&e.services.targetMappings;L.launchPage=e.services&&e.services.pbFioriHome;L=jQuery.sap.getObject("sap-ushell-config.services.VisualizationDataProvider.adapter",0);L.module="sap.ushell_abap.adapters.abap.LaunchPageAdapter";L=jQuery.sap.getObject("sap-ushell-config.services.VisualizationDataProvider.adapter.config.services",0);L.targetMappings=e.services&&e.services.targetMappings;L.launchPage=e.services&&e.services.pbFioriHome;L=jQuery.sap.getObject("sap-ushell-config.services.PageBuilding.adapter.config.services",0);L.pageBuilding=e.services&&e.services.pbFioriHome;L=jQuery.sap.getObject("sap-ushell-config.services.Personalization.adapter.config.services",0);L.personalization=e.services&&e.services.personalization;L=jQuery.sap.getObject("sap-ushell-config.services.Personalization.config",0);L.seed=e.seed;if(!R){U={language:e.languageBcp47||e.language,ABAPLanguage:e.language,legacyDateFormat:e.dateFormat,legacyDateCalendarCustomizing:e.tislcal,legacyNumberFormat:e.numberFormat===""?" ":e.numberFormat,legacyTimeFormat:e.timeFormat};}D(o,S);m(U,e.currencyFormats);}function G(e,N){var L=f(),M=g(),R=h(L),O=[R],P={},Q={},T;var U=jQuery.sap.getObject("sap-ushell-config.services.AppState.config",0);var V=jQuery.sap.getObject("sap-ushell-config.services.ClientSideTargetResolution.adapter.config",0);function W(Z,M){var $=M.match(Z);var _=[];if(!$){return;}_=($[2]).toString().split("=");Q[_[0]]=_[1];}function Y(Z,$,Q,_,a1){if($&&$[a1]&&Q&&Q[_]){Z[Q[_]]=$[a1];}}if(i(L)){W(/(\?|&)(sap-xapp-state=[A-Z0-9]+)/,L);W(/(\?|&)(sap-intent-param=[A-Z0-9]+)/,L);W(/(\?|&)(sap-system=[A-Z0-9]+)/,L);W(/(\?|&|[/])(sap-iapp-state=[A-Z0-9]+)/,M);if(jQuery.sap.getObject("sap-ushell-config.ushell.spaces.enabled")){c.requestAllCatalogs(e,N);}T=s.requestDirectStart(e,N,R,Q);U.initialAppStatesPromise=T.then(function(Z){Y(P,Z,Q,"sap-intent-param","iparState");Y(P,Z,Q,"sap-iapp-state","iappState");Y(P,Z,Q,"sap-xapp-state","xappState");U.initialAppStates=P;return Promise.resolve(P);});V.initialSegmentPromise=T.then(function(Z){if(Z.targetMappings){return Promise.resolve([O,Z.targetMappings,Z.systemAliases,Z.urlTemplates]);}return Promise.resolve(null);});}else{U.initialAppStatesPromise=Promise.resolve({});V.initialSegmentPromise=Promise.resolve(null);}}function H(){var P=new Promise(function(e,L){var R,O;O=function(){jQuery.sap.log.info("Direct application start: resolving component waitFor promise after shell renderer created event fired.");e();sap.ushell.Container.detachRendererCreatedEvent(O);};E.once("ShellNavigationInitialized").do(function(){R=sap.ushell.Container.getRenderer();if(R){jQuery.sap.log.info("Direct application start: resolving component waitFor promise immediately (shell renderer already created).");e();}else{sap.ushell.Container.attachRendererCreatedEvent(O);}});});return P;}function I(M){var U=a.getUrlParameterValue("sap-ushell-reload"),e;if(U){if(U==="X"||U==="true"){e=true;}else{e=false;}}if(e!==undefined){jQuery.sap.getObject("services.ShellNavigation.config",0,M).reload=e;}}function J(e,L,M){var N=f();F(e);L.forEach(function(O){a.mergeConfig(window["sap-ushell-config"],O,true);});I(window["sap-ushell-config"]);sap.ushell.bootstrap("abap",{abap:"sap.ushell_abap.adapters.abap",hana:"sap.ushell_abap.adapters.hana"}).done(function(){var O=x.FrameLogonManager.getInstance();sap.ushell.Container.oFrameLogonManager=O;}).always(function(){if(i(N)){var R,O;window["sap-ushell-async-libs-promise-directstart"]=new Promise(function(P,Q){R=P;O=Q;});window["sap-ushell-async-libs-promise-directstart"].catch(function(P){});sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(P){P.resolveHashFragment("#"+f()).done(function(Q){var T=sap.ui.require("sap/ushell/services/AppConfiguration");T.setCurrentApplication(Q);if(Q&&Q.ui5ComponentName){sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(U){U.createComponent(Q,h(N),H()).done(function(V){R({resolvedHashFragment:V,dependenciesLoaded:true});}).fail(function(V){O(V);});});}else{R({resolvedHashFragment:Q,dependenciesLoaded:false});}}).fail(function(Q){O(Q);});});}M();});}function K(U){var N=false,e,R;if(window["sap-ushell_abap-bootstrap-abap-noOData"]){N=true;}X.initXhrLogon(window["sap-ushell-config"]);e=s.requestStartupConfig().then(function(L){var M=f();jQuery.sap.getObject("sap-ushell-config.services.Container.adapter",0).config=L;var O=jQuery.sap.getObject("sap-ushell-config.services.LaunchPage.adapter.config",0);var P=jQuery.sap.getObject("sap-ushell-config.services.ClientSideTargetResolution.adapter.config",0);if(jQuery.sap.getObject("sap-ushell-config.ushell.spaces.enabled")){jQuery.sap.setObject("sap-ushell-config.services.VisualizationDataProvider.adapter.config",O);jQuery.sap.setObject("sap-ushell-config.services.NavigationDataProvider.adapter.config",P);}G(L,N);S=q(L);o=y(L,S);if(!A()&&o){jQuery.sap.log.debug("theme: load theme from startup service via window",null,"sap.ushell_abap.bootstrap");}if(j(M)){if(jQuery.sap.getObject("sap-ushell-config.ushell.spaces.enabled")){c.requestAllCatalogs(L,N,"/UI2/FakePageId");}else{p.requestPageSet(L,N);}O.compactTMPromise=s.requestCompactTM(L,N);}P.navTargetDataPromise=s.requestFullTM(L,N);return Promise.resolve(L);},function(M){jQuery.sap.log.error("start_up request failed: "+M,null,"sap.ushell_abap.bootstrap");return Promise.resolve({});});R=r().then(function(L){return Promise.resolve(L);},function(M){jQuery.sap.log.error("Could not load server configuration: "+M,null,"sap.ushell_abap.bootstrap.abap");return Promise.resolve([]);});Promise.all([e,R,U]).then(function(P){J.apply(null,P);});}B.start=K;B.bootstrap=J;B._getShellHash=f;B._getFullShellHash=g;B._createWaitForRendererCreatedPromise=H;return B;});
