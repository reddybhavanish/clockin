//Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/base/Log","sap/ui/core/library","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(U,J,L,c,F,a){"use strict";var V=c.ValueState;var M={off:"OFF",manual:"MANUAL",auto:"AUTOMATIC"};return U.extend("sap.ushell_abap.transport.Component",{metadata:{manifest:"json",events:{change:{parameters:{valid:{type:"Boolean"},required:{type:"Boolean"}}}}},init:function(){U.prototype.init.apply(this,arguments);var t=this.getModel("Transport");this._initModels();this._oMetadataPromise=new Promise(function(r,b){if(t.isMetadataLoadingFailed()){b("Metadata failed to load.");}t.attachMetadataFailed(b);t.metadataLoaded().then(r);});this._oMetadataPromise.then(this._initialize.bind(this)).catch(L.error);},_initModels:function(){this.setModel(new J({mode:null}),"Mode");this.setModel(new J({transportId:null,required:true,valueState:V.None,value:"",transports:[]}),"TransportInformation");},_saveMode:function(){var p;if(this.getModel("Mode").getProperty("/mode")!==null){p=Promise.resolve(this.getModel("Mode").getProperty("/mode"));}else{p=this._getMode().then(function(r){return r&&r.mode&&r.mode?r.mode.transportMode:M.off;}).catch(function(){return M.off;});}return p.then(this._setMode.bind(this));},_setMode:function(m){this.getModel("Mode").setProperty("/mode",m);if(m===M.auto){this.getModel("TransportInformation").setProperty("/required",true);}else{this.getModel("TransportInformation").setProperty("/required",false);}},_getMode:function(){return new Promise(function(r,b){this.getModel("Transport").callFunction("/mode",{method:"POST",success:r,error:b});}.bind(this));},_getTransports:function(o){return new Promise(function(r,b){this.getModel("Transport").read("/transportSet",{success:r,error:b,filters:[new F("objectId",a.EQ,o.toUpperCase())]});}.bind(this));},_setTransportData:function(r,s){function b(d,e){for(var i=0;i<d.length;i++){if(d[i].getCode()==="/UI2/PAGE/055"){e.setProperty("/required",false);}else{e.setProperty("/required",true);}}}var m=this.getModel("Transport").getMessages({sDeepPath:"/transportSet"});this.getModel("TransportInformation").setProperty("/transports",r.results);if(!s){return;}else{if(m.length!==0&&this.getModel("Mode").getProperty("/mode")===M.auto){b(m,this.getModel("TransportInformation"));}else if(m.length===0&&this.getModel("Mode").getProperty("/mode")===M.auto){this.getModel("TransportInformation").setProperty("/required",true);}else if(m.length===0&&this.getModel("Mode").getProperty("/mode")===M.manual){this.getModel("TransportInformation").setProperty("/required",true);}else if(m.length!==0&&this.getModel("Mode").getProperty("/mode")===M.manual){b(m,this.getModel("TransportInformation"));}this.getRootControl().getController().validate();}},_initialize:function(){return this._saveMode();},reset:function(){this.getModel("TransportInformation").setProperty("/transportId",null);this.getModel("TransportInformation").setProperty("/value","");this.getModel("TransportInformation").setProperty("/required",true);this.getModel("TransportInformation").setProperty("/valueState",V.None);return Promise.resolve();},decorateResultWithTransportInformation:function(s){var t=this.getModel("TransportInformation").getProperty("/transportId");if(!s){s={};}if(t){s.transportId=t;}return s;},showTransport:function(s){this.getRootControl().setBusy(true);this.fireChange({valid:false,empty:true,required:true});return Promise.all([this._getTransports(s?s.id:""),this._oMetadataPromise,this._saveMode()]).then(function(r){this._setTransportData(r[0],s);var S=this.getModel("Mode").getProperty("/mode")!==M.off;this.fireChange({valid:!this.getModel("TransportInformation").getProperty("/required"),empty:true,required:!!this.getModel("TransportInformation").getProperty("/required")});return S;}.bind(this)).catch(function(e){L.error(e);return false;}).finally(function(){this.getRootControl().setBusy(false);}.bind(this));},showLockedMessage:function(){return Promise.resolve(false);}});});
